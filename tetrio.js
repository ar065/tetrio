window.TETRIO_ENV = {"version":"6.3.0","countdown":false,"novault":false,"supporter_specialthanks_goal":200,"xp_multiplier":1,"catalog":{"supporter":{"price":5,"price_bulk":4,"price_gift":4,"price_gift_bulk":4,"bulk_after":3,"normal_price":5,"normal_price_bulk":4,"normal_price_gift":4,"normal_price_gift_bulk":4,"normal_bulk_after":3}},"mode":"production","commit":{"id":"a047f021","time":1663084106000},"serverCycle":"NAr73J0Df","build":{"id":"d5ARXmEtv","time":1663674928229}};
window.TETRIO_SE_SHEET = {"allclear":[0,2800.2721088435374],"applause":[4000,7401.0204081632655],"boardappear":[13000,1598.9795918367342],"btb_1":[16000,1000],"btb_2":[18000,1000],"btb_3":[20000,1000],"btb_break":[22000,1000],"clearbtb":[24000,1799.7278911564613],"clearline":[27000,1100.0453514739233],"clearquad":[30000,2001.1791383219943],"clearspin":[34000,2599.569160997731],"clutch":[38000,340.9070294784584],"combo_1_power":[40000,997.9365079365082],"combo_1":[42000,992.7891156462607],"combo_10_power":[44000,1000],"combo_10":[46000,1000],"combo_11_power":[48000,1000],"combo_11":[50000,1000],"combo_12_power":[52000,1000],"combo_12":[54000,1000],"combo_13_power":[56000,1000],"combo_13":[58000,1000],"combo_14_power":[60000,1000],"combo_14":[62000,1000],"combo_15_power":[64000,1000],"combo_15":[66000,1000],"combo_16_power":[68000,2000],"combo_16":[71000,1000],"combo_2_power":[73000,1000.0453514739291],"combo_2":[76000,1000],"combo_3_power":[78000,1000],"combo_3":[80000,1000],"combo_4_power":[82000,1000.1133786848015],"combo_4":[85000,1000],"combo_5_power":[87000,999.8866213151985],"combo_5":[89000,1000],"combo_6_power":[91000,1000],"combo_6":[93000,1000],"combo_7_power":[95000,1000],"combo_7":[97000,999.9773242630425],"combo_8_power":[99000,1000],"combo_8":[101000,1000.0226757369575],"combo_9_power":[104000,1000],"combo_9":[106000,1000],"combobreak":[108000,900.362811791382],"countdown1":[110000,1000],"countdown2":[112000,1000],"countdown3":[114000,1000],"countdown4":[116000,1000],"countdown5":[118000,1000],"counter":[120000,1000],"cutin_superlobby":[122000,7036.031746031739],"damage_alert":[131000,1500],"damage_large":[134000,1199.9999999999886],"damage_medium":[137000,1000],"damage_small":[139000,800.0000000000114],"death":[141000,599.9999999999943],"detonate1":[143000,100.45351473922892],"detonate2":[145000,199.31972789115093],"detonated":[147000,2701.020408163259],"elim":[151000,500],"exchange":[153000,700.4081632653083],"failure":[155000,3099.7959183673347],"finessefault":[160000,699.9999999999886],"finish":[162000,2697.278911564638],"fire":[166000,9906.757369614525],"floor":[177000,501.08843537415737],"gameover":[179000,3500],"garbage_in_large":[184000,1199.9999999999886],"garbage_in_medium":[187000,1199.9999999999886],"garbage_in_small":[190000,699.9999999999886],"garbage_out_large":[192000,1000],"garbage_out_medium":[194000,1000],"garbage_out_small":[196000,1000.0680272108866],"garbagerise":[199000,1199.1383219954628],"garbagesmash":[202000,2100.408163265314],"go":[206000,2900.226757369609],"harddrop":[210000,399.6825396825443],"hit":[212000,300.13605442175617],"hold":[214000,399.79591836734585],"hyperalert":[216000,1699.659863945584],"i":[219000,1000],"impact":[221000,1199.9999999999886],"j":[224000,1000],"l":[226000,1000],"level1":[228000,5000],"level10":[234000,5000],"level100":[240000,5000],"level500":[246000,5000],"levelup":[252000,1400.6349206349284],"losestock":[255000,1500.0226757369433],"maintenance":[258000,1099.591836734703],"matchintro":[261000,16500],"menuback":[279000,599.9319727891361],"menuclick":[281000,1099.9773242630226],"menuconfirm":[284000,2699.9999999999886],"menuhit1":[288000,1200.0680272108752],"menuhit2":[291000,1200.4081632653083],"menuhit3":[294000,1199.501133786839],"menuhover":[297000,200.1814058957052],"menutap":[299000,99.65986394558968],"mission_free":[301000,3399.9999999999773],"mission_league":[306000,11199.818594104328],"mission_versus":[319000,4899.999999999977],"mission":[325000,5999.773242630397],"mmstart":[332000,2500.3628117913763],"move":[336000,199.8639455782154],"no":[338000,188.1859410430593],"notify":[340000,200.4081632653083],"o":[342000,1000],"offset":[344000,399.99999999997726],"pause_continue":[346000,993.061224489793],"pause_exit":[348000,5000],"pause_retry":[354000,994.3083900226952],"pause_start":[356000,998.8662131519277],"personalbest":[358000,3498.8662131519277],"purchase_start":[363000,819.3877551020137],"ranklower":[365000,3300.0000000000114],"rankraise":[370000,9200.02267573699],"ratinglower":[381000,2699.9999999999886],"ratingraise":[385000,2199.9999999999886],"ribbon_off":[389000,587.5736961451139],"ribbon_on":[391000,714.8299319728153],"ribbon_tap":[393000,758.6621315192588],"ribbon":[395000,241.24716553285452],"rotate":[397000,199.68253968255567],"rsg_go":[399000,2900.090702947864],"rsg":[403000,899.7505668934309],"s":[405000,1000],"scoreslide_in":[407000,499.90929705217013],"scoreslide_out":[409000,899.863945578204],"shatter":[411000,3000],"showscore":[415000,4599.95464852608],"sidehit":[421000,297.80045351475337],"social_close_minor":[423000,193.99092970519405],"social_close":[425000,387.95918367344484],"social_dm":[427000,183.94557823131663],"social_invite":[429000,2110.4081632653333],"social_notify_major":[433000,535.0566893424116],"social_notify_minor":[435000,308.6167800453268],"social_offline":[437000,1000.3854875283196],"social_online":[440000,958.2766439909278],"social_open_minor":[442000,218.23129251703222],"social_open":[444000,436.4625850340076],"softdrop":[446000,99.90929705213603],"spin":[448000,2000.0907029478299],"spinend":[452000,799.5691609977484],"staffsilence":[454000,272.1541950113533],"staffspam":[456000,168.82086167800026],"staffwarning":[458000,469.54648526076426],"supporter":[460000,4090.2947845805215],"t":[466000,1000],"target":[468000,299.97732426301127],"thunder1":[470000,3300.0000000000114],"thunder2":[475000,4600.000000000023],"thunder3":[481000,3000],"thunder4":[485000,3000],"thunder5":[489000,5000],"thunder6":[495000,5000],"timer1":[501000,498.73015873015447],"timer2":[503000,399.2970521541679],"topout":[505000,4600.136054421796],"userjoin":[511000,699.591836734669],"userleave":[513000,299.59183673474854],"victory":[515000,7499.750566893454],"warning":[524000,1200.158730158705],"warp":[527000,10531.29251700682],"worldrecord":[539000,3701.4965986394373],"z":[544000,1000]};

(function(a,b){"object"==typeof exports&&"undefined"!=typeof module?b(exports):"function"==typeof define&&define.amd?define(["exports"],b):(a=a||self,b(a.msgpackr={}))})(this,function(a){'use strict';var b=Math.floor;function c(){try{if(!K.trusted&&!R){let a=E.sharedLength||0;a<E.length&&(E.length=a)}let a=e();if(G&&(// bundled strings to skip past
J=G.postBundlePosition),J==D)E.restoreStructures&&d(),E=null,C=null,H&&(H=null);else if(J>D)// over read
throw new Error("Unexpected end of MessagePack data");else if(!R)throw new Error("Data read, but end of buffer not reached "+JSON.stringify(a).slice(0,100));// else more to read, but we are reading sequentially, so don't clear source yet
return a}catch(a){throw E.restoreStructures&&d(),r(),(a instanceof RangeError||a.message.startsWith("Unexpected end of buffer")||J>D)&&(a.incomplete=!0),a}}function d(){for(let a in E.restoreStructures)E[a]=E.restoreStructures[a];E.restoreStructures=null}function e(){let a=C[J++];if(160>a){if(!(128>a)){if(!(144>a)){a-=144;let b=Array(a);for(let c=0;c<a;c++)b[c]=e();return b}if(a-=128,K.mapsAsObjects){let b={};for(let c=0;c<a;c++)b[p()]=e();return b}else{let b=new Map;for(let c=0;c<a;c++)b.set(e(),e());return b}}else if(64>a)return a;else{let b=E[63&a]||K.getStructures&&g()[63&a];return b?(b.read||(b.read=f(b,63&a)),b.read()):a}}else if(192>a){// fixstr
let b=a-160;if(M>=J)return F.slice(J-L,(J+=b)-L);if(0==M&&140>D){// for small blocks, avoiding the overhead of the extract call is helpful
let a=16>b?l(b):k(b);if(null!=a)return a}return W(b)}else{let b;switch(a){case 192:return null;case 193:return G?(b=e(),0<b?G[1].slice(G.position1,G.position1+=b):G[0].slice(G.position0,G.position0-=b)):Q;// "never-used", return special object to denote that
case 194:return!1;case 195:return!0;case 196:if(b=C[J++],void 0===b)throw new Error("Unexpected end of buffer");return n(b);case 197:return b=I.getUint16(J),J+=2,n(b);case 198:return b=I.getUint32(J),J+=4,n(b);case 199:// ext 8
return o(C[J++]);case 200:return b=I.getUint16(J),J+=2,o(b);case 201:return b=I.getUint32(J),J+=4,o(b);case 202:if(b=I.getFloat32(J),2<K.useFloat32){// this does rounding of numbers that were encoded in 32-bit float to nearest significant decimal digit that could be preserved
let a=da[(127&C[J])<<1|C[J+1]>>7];return J+=4,(a*b+(0<b?.5:-.5)>>0)/a}return J+=4,b;case 203:return b=I.getFloat64(J),J+=8,b;// uint handlers
case 204:return C[J++];case 205:return b=I.getUint16(J),J+=2,b;case 206:return b=I.getUint32(J),J+=4,b;case 207:return K.int64AsNumber?(b=4294967296*I.getUint32(J),b+=I.getUint32(J+4)):b=I.getBigUint64(J),J+=8,b;// int handlers
case 208:return I.getInt8(J++);case 209:return b=I.getInt16(J),J+=2,b;case 210:return b=I.getInt32(J),J+=4,b;case 211:return K.int64AsNumber?(b=4294967296*I.getInt32(J),b+=I.getUint32(J+4)):b=I.getBigInt64(J),J+=8,b;case 212:if(b=C[J++],114==b)return aa(63&C[J++]);else{let a=N[b];if(a)return a.read?(J++,a.read(e())):a.noBuffer?(J++,a()):a(C.subarray(J,++J));throw new Error("Unknown extension "+b)}case 213:return b=C[J],114==b?(J++,aa(63&C[J++],C[J++])):o(2);case 214:// fixext 4
return o(4);case 215:// fixext 8
return o(8);case 216:// fixext 16
return o(16);case 217:return b=C[J++],M>=J?F.slice(J-L,(J+=b)-L):X(b);case 218:return b=I.getUint16(J),J+=2,M>=J?F.slice(J-L,(J+=b)-L):Y(b);case 219:return b=I.getUint32(J),J+=4,M>=J?F.slice(J-L,(J+=b)-L):Z(b);case 220:return b=I.getUint16(J),J+=2,i(b);case 221:return b=I.getUint32(J),J+=4,i(b);case 222:return b=I.getUint16(J),J+=2,j(b);case 223:return b=I.getUint32(J),J+=4,j(b);default:// negative int
if(224<=a)return a-256;if(void 0===a){let a=new Error("Unexpected end of MessagePack data");throw a.incomplete=!0,a}throw new Error("Unknown MessagePack token "+a);}}}function f(a,b){function c(){// This initial function is quick to instantiate, but runs slower. After several iterations pay the cost to build the faster function
if(c.count++>S){let c=a.read=new Function("r","return function(){return {"+a.map(a=>U.test(a)?a+":r()":"["+JSON.stringify(a)+"]:r()").join(",")+"}}")(e);return 0===a.highByte&&(a.read=V(b,a.read)),c();// second byte is already read, if there is one so immediately read object
}let d={};for(let b,c=0,f=a.length;c<f;c++)b=a[c],d[b]=e();return d}return c.count=0,0===a.highByte?V(b,c):c}function g(){let a=q(()=>(C=null,K.getStructures()));return E=K._mergeStructures(a,E)}function h(a){let b;if(16>a&&(b=l(a)))return b;if(64<a&&B)return B.decode(C.subarray(J,J+=a));const c=J+a,d=[];for(b="";J<c;){const a=C[J++];if(0==(128&a))d.push(a);else if(192==(224&a)){// 2 bytes
const b=63&C[J++];d.push((31&a)<<6|b)}else if(224==(240&a)){// 3 bytes
const b=63&C[J++],c=63&C[J++];d.push((31&a)<<12|b<<6|c)}else if(240==(248&a)){// 4 bytes
const b=63&C[J++],c=63&C[J++],e=63&C[J++];let f=(7&a)<<18|b<<12|c<<6|e;65535<f&&(f-=65536,d.push(55296|1023&f>>>10),f=56320|1023&f),d.push(f)}else d.push(a);4096<=d.length&&(b+=$.apply(String,d),d.length=0)}return 0<d.length&&(b+=$.apply(String,d)),b}function i(a){let b=Array(a);for(let c=0;c<a;c++)b[c]=e();return b}function j(a){if(K.mapsAsObjects){let b={};for(let c=0;c<a;c++)b[p()]=e();return b}else{let b=new Map;for(let c=0;c<a;c++)b.set(e(),e());return b}}function k(a){let b=J,c=Array(a);for(let d=0;d<a;d++){const a=C[J++];if(0<(128&a))return void(J=b);c[d]=a}return $.apply(String,c)}function l(p){if(4>p){if(!(2>p)){let d=C[J++],a=C[J++];if(0<(128&d)||0<(128&a))return void(J-=2);if(3>p)return $(d,a);let b=C[J++];return 0<(128&b)?void(J-=3):$(d,a,b)}if(0===p)return"";else{let b=C[J++];return 1<(128&b)?void(J-=1):$(b)}}else{let q=C[J++],a=C[J++],b=C[J++],c=C[J++];if(0<(128&q)||0<(128&a)||0<(128&b)||0<(128&c))return void(J-=4);if(6>p){if(4===p)return $(q,a,b,c);else{let d=C[J++];return 0<(128&d)?void(J-=5):$(q,a,b,c,d)}}else if(8>p){let d=C[J++],e=C[J++];if(0<(128&d)||0<(128&e))return void(J-=6);if(7>p)return $(q,a,b,c,d,e);let f=C[J++];return 0<(128&f)?void(J-=7):$(q,a,b,c,d,e,f)}else{let d=C[J++],e=C[J++],f=C[J++],g=C[J++];if(0<(128&d)||0<(128&e)||0<(128&f)||0<(128&g))return void(J-=8);if(10>p){if(8===p)return $(q,a,b,c,d,e,f,g);else{let h=C[J++];return 0<(128&h)?void(J-=9):$(q,a,b,c,d,e,f,g,h)}}else if(12>p){let h=C[J++],i=C[J++];if(0<(128&h)||0<(128&i))return void(J-=10);if(11>p)return $(q,a,b,c,d,e,f,g,h,i);let j=C[J++];return 0<(128&j)?void(J-=11):$(q,a,b,c,d,e,f,g,h,i,j)}else{let h=C[J++],i=C[J++],j=C[J++],k=C[J++];if(0<(128&h)||0<(128&i)||0<(128&j)||0<(128&k))return void(J-=12);if(!(14>p)){let l=C[J++],m=C[J++];if(0<(128&l)||0<(128&m))return void(J-=14);if(15>p)return $(q,a,b,c,d,e,f,g,h,i,j,k,l,m);let n=C[J++];return 0<(128&n)?void(J-=15):$(q,a,b,c,d,e,f,g,h,i,j,k,l,m,n)}if(12===p)return $(q,a,b,c,d,e,f,g,h,i,j,k);else{let l=C[J++];return 0<(128&l)?void(J-=13):$(q,a,b,c,d,e,f,g,h,i,j,k,l)}}}}}function m(){let a,b=C[J++];if(192>b)// fixstr
a=b-160;else switch(b){case 217:a=C[J++];break;case 218:a=I.getUint16(J),J+=2;break;case 219:a=I.getUint32(J),J+=4;break;default:throw new Error("Expected string");}return h(a)}function n(a){return K.copyBuffers?// specifically use the copying slice (not the node one)
Uint8Array.prototype.slice.call(C,J,J+=a):C.subarray(J,J+=a)}function o(a){let b=C[J++];if(N[b])return N[b](C.subarray(J,J+=a));throw new Error("Unknown extension type "+b)}function p(){let a=C[J++];if(160<=a&&192>a){if(a-=160,M>=J)// if it has been extracted, must use it (and faster anyway)
return F.slice(J-L,(J+=a)-L);if(!(0==M&&180>D))return W(a)}else return J--,e();let b,c=4095&(a<<5^(1<a?I.getUint16(J):0<a?C[J]:0)),d=_[c],f=J,g=J+a-3,h=0;if(d&&d.bytes==a){for(;f<g;){if(b=I.getUint32(f),b!=d[h++]){f=1879048192;break}f+=4}for(g+=3;f<g;)if(b=C[f++],b!=d[h++]){f=1879048192;break}if(f===g)return J=f,d.string;g-=3,f=J}for(d=[],_[c]=d,d.bytes=a;f<g;)b=I.getUint32(f),d.push(b),f+=4;for(g+=3;f<g;)b=C[f++],d.push(b);// for small blocks, avoiding the overhead of the extract call is helpful
let j=16>a?l(a):k(a);return null==j?d.string=W(a):d.string=j}// the registration of the record definition extension (as "r")
// notepack defines extension 0 to mean undefined, so use that as the default here
// registration of bulk record definition?
// currentExtensions[0x52] = () =>
function q(a){let b=D,c=J,d=L,e=M,f=F,g=H,h=G,i=new Uint8Array(C.slice(0,D)),j=E,k=E.slice(0,E.length),l=K,m=R,n=a();return D=b,J=c,L=d,M=e,F=f,H=g,G=h,C=i,R=m,E=j,E.splice(0,E.length,...k),K=l,I=new DataView(C.buffer,C.byteOffset,C.byteLength),n}function r(){C=null,H=null,E=null}function s(a){N[a.type]=a.unpack?a.unpack:a}function t(a,b,c){let d=a.byteLength;if(256>d+1){var{target:e,position:f}=c(4+d);e[f++]=199,e[f++]=d+1}else if(65536>d+1){var{target:e,position:f}=c(5+d);e[f++]=200,e[f++]=d+1>>8,e[f++]=255&d+1}else{var{target:e,position:f,targetView:g}=c(7+d);// plus one for the type byte
e[f++]=201,g.setUint32(f,d+1),f+=4}// "t" for typed array
e[f++]=116,e[f++]=b,e.set(new Uint8Array(a.buffer,a.byteOffset,a.byteLength),f)}function u(a,b){let c=a.byteLength;var d,e;if(256>c){var{target:d,position:e}=b(c+2);d[e++]=196,d[e++]=c}else if(65536>c){var{target:d,position:e}=b(c+3);d[e++]=197,d[e++]=c>>8,d[e++]=255&c}else{var{target:d,position:e,targetView:f}=b(c+5);d[e++]=198,f.setUint32(e,c),e+=4}d.set(a,e)}function v(a,b,c,d){let e=a.length;return 1===e?b[c++]=212:2===e?b[c++]=213:4===e?b[c++]=214:8===e?b[c++]=215:16===e?b[c++]=216:256>e?(b[c++]=199,b[c++]=e):65536>e?(b[c++]=200,b[c++]=e>>8,b[c++]=255&e):(b[c++]=201,b[c++]=e>>24,b[c++]=255&e>>16,b[c++]=255&e>>8,b[c++]=255&e),b[c++]=d,b.set(a,c),c+=e,c}function w(a,b){// insert the ids that need to be referenced for structured clones
let c,d=6*b.length,e=a.length-d;for(b.sort((c,a)=>c.offset>a.offset?1:-1);c=b.pop();){let b=c.offset,f=c.id;a.copyWithin(b+d,b,e),d-=6;let g=b+d;// 'i'
a[g++]=214,a[g++]=105,a[g++]=f>>24,a[g++]=255&f>>16,a[g++]=255&f>>8,a[g++]=255&f,e=b}return a}function x(a,b){if(0<xa.length){ua.setUint32(xa.position+a,wa-xa.position-a);let c=xa;xa=null,b(c[0]),b(c[1])}}function y(a){if(a.Class){if(!a.pack&&!a.write)throw new Error("Extension has no pack or write function");if(a.pack&&!a.type)throw new Error("Extension has no type (numeric code to identify the extension)");na.unshift(a.Class),ma.unshift(a)}s(a)}function*z(a,b){const c=new za(b);for(const d of a)yield c.pack(d)}async function*A(a,b){const c=new za(b);for await(const d of a)yield c.pack(d)}/**
	 * Given an Iterable/Iterator input which yields buffers, returns an IterableIterator which yields sync decoded objects
	 * Or, given an Async Iterable/Iterator which yields promises resolving in buffers, returns an AsyncIterableIterator.
	 * @param {Iterable|Iterator|AsyncIterable|AsyncIterableIterator} bufferIterator
	 * @param {object} [options] - unpackr options
	 * @returns {IterableIterator|Promise.<AsyncIterableIterator}
	 */var B;try{B=new TextDecoder}catch(a){}var C,D,E,F,G,H,I,J=0,K={},L=0,M=0,N=[],O={useRecords:!1,mapsAsObjects:!0};class P{}const Q=new P;Q.name="MessagePack 0xC1";var R=!1,S=2;try{new Function("")}catch(a){// if eval variants are not supported, do not create inline object readers ever
S=1/0}class T{constructor(a){a&&(!1===a.useRecords&&a.mapsAsObjects===void 0&&(a.mapsAsObjects=!0),a.sequential&&!1!==a.trusted&&(a.trusted=!0,!a.structures&&!1!=a.useRecords&&(a.structures=[],!a.maxSharedStructures&&(a.maxSharedStructures=0))),a.structures?a.structures.sharedLength=a.structures.length:a.getStructures&&((a.structures=[]).uninitialized=!0,a.structures.sharedLength=0)),Object.assign(this,a)}unpack(a,b){if(C)// re-entrant execution, save the state and restore it after we do this unpack
return q(()=>(r(),this?this.unpack(a,b):T.prototype.unpack.call(O,a,b)));D=-1<b?b:a.length,J=0,M=0,F=null,G=null,C=a;// this provides cached access to the data view for a buffer if it is getting reused, which is a recommend
// technique for getting data from a database where it can be copied into an existing buffer instead of creating
// new ones
try{I=a.dataView||(a.dataView=new DataView(a.buffer,a.byteOffset,a.byteLength))}catch(b){if(C=null,a instanceof Uint8Array)throw b;throw new Error("Source must be a Uint8Array or Buffer but was a "+(a&&"object"==typeof a?a.constructor.name:typeof a))}if(this instanceof T){if(K=this,this.structures)return E=this.structures,c();(!E||0<E.length)&&(E=[])}else K=O,(!E||0<E.length)&&(E=[]);return c()}unpackMultiple(a,b){let d,e=0;try{R=!0;let f=a.length,g=this?this.unpack(a,f):ea.unpack(a,f);if(b){for(b(g);J<f;)if(e=J,!1===b(c()))return;}else{for(d=[g];J<f;)e=J,d.push(c());return d}}catch(a){throw a.lastPosition=e,a.values=d,a}finally{R=!1,r()}}_mergeStructures(a,b){a=a||[];for(let c,d=0,e=a.length;d<e;d++)c=a[d],c&&(c.isShared=!0,32<=d&&(c.highByte=d-32>>5));for(let c in a.sharedLength=a.length,b||[])if(0<=c){let d=a[c],e=b[c];e&&(d&&((a.restoreStructures||(a.restoreStructures=[]))[c]=d),a[c]=e)}return this.structures=a}decode(a,b){return this.unpack(a,b)}}const U=/^[a-zA-Z_$][a-zA-Z\d_$]*$/,V=(a,b)=>function(){let c=C[J++];if(0===c)return b();let d=32>a?-(a+(c<<5)):a+(c<<5),e=E[d]||g()[d];if(!e)throw new Error("Record id is not defined for "+d);return e.read||(e.read=f(e,a)),e.read()};var W=h,X=h,Y=h,Z=h;var $=String.fromCharCode,_=Array(4096);const aa=(a,b)=>{var c=e();let d=a;void 0!==b&&(a=32>a?-((b<<5)+a):(b<<5)+a,c.highByte=b);let g=E[a];return g&&g.isShared&&((E.restoreStructures||(E.restoreStructures=[]))[a]=g),E[a]=c,c.read=f(c,d),c.read()};N[0]=()=>{},N[0].noBuffer=!0,N[101]=()=>{let a=e();return(globalThis[a[0]]||Error)(a[1])},N[105]=()=>{// id extension (for structured clones)
let a=I.getUint32(J-4);H||(H=new Map);let b,c=C[J];b=144<=c&&160>c||220==c||221==c?[]:{};let d={target:b};// a placeholder object
H.set(a,d);let f=e();// read the next value as the target object to id
return d.used?Object.assign(b,f):(d.target=f,f);// no cycle, can just use the returned read object
},N[112]=()=>{// pointer extension (for structured clones)
let a=I.getUint32(J-4),b=H.get(a);return b.used=!0,b.target},N[115]=()=>new Set(e());const ba=["Int8","Uint8","Uint8Clamped","Int16","Uint16","Int32","Uint32","Float32","Float64","BigInt64","BigUint64"].map(a=>a+"Array");N[116]=a=>{let b=a[0],c=ba[b];if(!c)throw new Error("Could not find typed array for code "+b);// we have to always slice/copy here to get a new ArrayBuffer that is word/byte aligned
return new globalThis[c](Uint8Array.prototype.slice.call(a,1).buffer)},N[120]=()=>{let a=e();return new RegExp(a[0],a[1])};const ca=[];N[98]=a=>{let b=(a[0]<<24)+(a[1]<<16)+(a[2]<<8)+a[3],c=J;return J+=b-a.length,G=ca,G=[m(),m()],G.position0=0,G.position1=0,G.postBundlePosition=J,J=c,e()},N[255]=a=>4==a.length?new Date(1e3*(16777216*a[0]+(a[1]<<16)+(a[2]<<8)+a[3])):8==a.length?new Date(((a[0]<<22)+(a[1]<<14)+(a[2]<<6)+(a[3]>>2))/1e6+1e3*(4294967296*(3&a[3])+16777216*a[4]+(a[5]<<16)+(a[6]<<8)+a[7])):12==a.length?new Date(((a[0]<<24)+(a[1]<<16)+(a[2]<<8)+a[3])/1e6+1e3*((128&a[4]?-281474976710656:0)+1099511627776*a[6]+4294967296*a[7]+16777216*a[8]+(a[9]<<16)+(a[10]<<8)+a[11])):new Date("invalid");const da=Array(147);// this is a table matching binary exponents to the multiplier to determine significant digit rounding
for(let c=0;256>c;c++)da[c]=+("1e"+b(45.15-.30103*c));var ea=new T({useRecords:!1});const fa=ea.unpack,ga=ea.unpackMultiple,ha=ea.unpack,ia={NEVER:0,ALWAYS:1,DECIMAL_ROUND:3,DECIMAL_FIT:4};let ja,ka=new Float32Array(1),la=new Uint8Array(ka.buffer,0,4);try{ja=new TextEncoder}catch(a){}let ma,na;const oa="undefined"!=typeof Buffer,pa=oa?function(a){return Buffer.allocUnsafeSlow(a)}:Uint8Array,qa=oa?Buffer:Uint8Array,ra=oa?4294967296:2144337920;let sa,ta,ua,va,wa=0,xa=null;const ya=Symbol("record-id");class za extends T{constructor(a){super(a),this.offset=0;let b,c,d,e,f=0,g=qa.prototype.utf8Write?function(a,b){return sa.utf8Write(a,b,4294967295)}:!!(ja&&ja.encodeInto)&&function(a,b){return ja.encodeInto(a,sa.subarray(b)).written},h=this;a||(a={});let i=a&&a.sequential,j=a.structures||a.saveStructures,k=a.maxSharedStructures;if(null==k&&(k=j?32:0),8160<k)throw new Error("Maximum maxSharedStructure is 8160");a.structuredClone&&null==a.moreTypes&&(a.moreTypes=!0);let l=a.maxOwnStructures;null==l&&(l=j?32:64),this.structures||!1==a.useRecords||(this.structures=[]);// two byte record ids for shared structures
let m=32<k||64<l+k,n=k+64,o=k+l+64;if(8256<o)throw new Error("Maximum maxSharedStructure + maxOwnStructure is 8192");let p=[],q=0,r=0;this.pack=this.encode=function(a,g){if(sa||(sa=new pa(8192),ua=new DataView(sa.buffer,0,8192),wa=0),va=sa.length-10,2048>va-wa?(sa=new pa(sa.length),ua=new DataView(sa.buffer,0,sa.length),va=sa.length-10,wa=0):wa=2147483640&wa+7,b=wa,e=h.structuredClone?new Map:null,h.bundleStrings&&"string"!=typeof a?(xa=[],xa.size=1/0):xa=null,d=h.structures,d){d.uninitialized&&(d=h._mergeStructures(h.getStructures()));let a=d.sharedLength||0;if(a>k)//if (maxSharedStructures <= 32 && structures.sharedLength > 32) // TODO: could support this, but would need to update the limit ids
throw new Error("Shared structures is larger than maximum shared structures, try increasing maxSharedStructures to "+d.sharedLength);if(!d.transitions){d.transitions=Object.create(null);for(let b,c=0;c<a;c++){if(b=d[c],!b)continue;let a,e=d.transitions;for(let c,d=0,f=b.length;d<f;d++)c=b[d],a=e[c],a||(a=e[c]=Object.create(null)),e=a;e[ya]=c+64}f=a}i||(d.nextId=a+64)}c&&(c=!1);try{// update the offset so next serialization doesn't write over our buffer, but can continue writing to same buffer sequentially
if(s(a),xa&&x(b,s),h.offset=wa,e&&e.idsToInsert){wa+=6*e.idsToInsert.length,wa>va&&u(wa),h.offset=wa;let a=w(sa.subarray(b,wa),e.idsToInsert);return e=null,a}return g&Ha?(sa.start=b,sa.end=wa,sa):sa.subarray(b,wa);// position can change if we call pack again in saveStructures, so we get the buffer now
}finally{if(d){10>r&&r++;let e=d.sharedLength||k;if(d.length>e&&(d.length=e),1e4<q)d.transitions=null,r=0,q=0,0<p.length&&(p=[]);else if(0<p.length&&!i){for(let a=0,b=p.length;a<b;a++)p[a][ya]=0;p=[]}if(c&&h.saveStructures){// we can't rely on start/end with REUSE_BUFFER_MODE since they will (probably) change when we save
let c=sa.subarray(b,wa);return!1===h.saveStructures(d,f)?(h._mergeStructures(h.getStructures()),h.pack(a)):(f=e,c)}}g&Ia&&(wa=b)}};const s=a=>{wa>va&&(sa=u(wa));var c,d=typeof a;if("string"==d){let d=a.length;if(xa&&4<=d&&4096>d){if((xa.size+=d)>61440){let a,c=(xa[0]?3*xa[0].length+xa[1].length:0)+10;wa+c>va&&(sa=u(wa+c)),xa.position?(sa[wa]=200,wa+=3,sa[wa++]=98,a=wa-b,wa+=4,x(b,s),ua.setUint16(a+b-3,wa-b-a)):(sa[wa++]=214,sa[wa++]=98,a=wa-b,wa+=4),xa=["",""],xa.size=0,xa.position=a}let c=/[\u0080-\uFFFF]/.test(a);return xa[c?0:1]+=a,sa[wa++]=193,void s(c?-d:d)}let e=32>d?1:256>d?2:65536>d?3:5;// first we estimate the header size, so we can write to the correct location
let f=3*d;if(wa+f>va&&(sa=u(wa+f)),64>d||!g){let b,f,g,h=wa+e;for(b=0;b<d;b++)f=a.charCodeAt(b),128>f?sa[h++]=f:2048>f?(sa[h++]=192|f>>6,sa[h++]=128|63&f):55296==(64512&f)&&56320==(64512&(g=a.charCodeAt(b+1)))?(f=65536+((1023&f)<<10)+(1023&g),b++,sa[h++]=240|f>>18,sa[h++]=128|63&f>>12,sa[h++]=128|63&f>>6,sa[h++]=128|63&f):(sa[h++]=224|f>>12,sa[h++]=128|63&f>>6,sa[h++]=128|63&f);c=h-wa-e}else c=g(a,wa+e);32>c?sa[wa++]=160|c:256>c?(2>e&&sa.copyWithin(wa+2,wa+1,wa+1+c),sa[wa++]=217,sa[wa++]=c):65536>c?(3>e&&sa.copyWithin(wa+3,wa+2,wa+2+c),sa[wa++]=218,sa[wa++]=c>>8,sa[wa++]=255&c):(5>e&&sa.copyWithin(wa+5,wa+3,wa+3+c),sa[wa++]=219,ua.setUint32(wa,c),wa+=4),wa+=c}else if("number"===d){if(a>>>0===a)64>a||128>a&&!1===this.useRecords?sa[wa++]=a:256>a?(sa[wa++]=204,sa[wa++]=a):65536>a?(sa[wa++]=205,sa[wa++]=a>>8,sa[wa++]=255&a):(sa[wa++]=206,ua.setUint32(wa,a),wa+=4);else if(a>>0===a)-32<=a?sa[wa++]=256+a:-128<=a?(sa[wa++]=208,sa[wa++]=a+256):-32768<=a?(sa[wa++]=209,ua.setInt16(wa,a),wa+=2):(sa[wa++]=210,ua.setInt32(wa,a),wa+=4);else{let b;if(0<(b=this.useFloat32)&&4294967296>a&&-2147483648<=a){sa[wa++]=202,ua.setFloat32(wa,a);let c;if(4>b||// this checks for rounding of numbers that were encoded in 32-bit float to nearest significant decimal digit that could be preserved
(c=a*da[(127&sa[wa])<<1|sa[wa+1]>>7])>>0===c)return void(wa+=4);// move back into position for writing a double
wa--}sa[wa++]=203,ua.setFloat64(wa,a),wa+=8}}else if("object"===d){if(!a)sa[wa++]=192;else{if(e){let c=e.get(a);if(c){if(!c.id){let a=e.idsToInsert||(e.idsToInsert=[]);c.id=a.push(c)}return sa[wa++]=214,sa[wa++]=112,ua.setUint32(wa,c.id),void(wa+=4)}e.set(a,{offset:wa-b})}let d=a.constructor;if(d===Object)t(a,!0);else if(d===Array){c=a.length,16>c?sa[wa++]=144|c:65536>c?(sa[wa++]=220,sa[wa++]=c>>8,sa[wa++]=255&c):(sa[wa++]=221,ua.setUint32(wa,c),wa+=4);for(let b=0;b<c;b++)s(a[b])}else if(d===Map){c=a.size,16>c?sa[wa++]=128|c:65536>c?(sa[wa++]=222,sa[wa++]=c>>8,sa[wa++]=255&c):(sa[wa++]=223,ua.setUint32(wa,c),wa+=4);for(let[b,c]of a)s(b),s(c)}else{for(let b,c=0,d=ma.length;c<d;c++)if(b=na[c],a instanceof b){let b=ma[c];if(b.write)return b.type&&(sa[wa++]=212,sa[wa++]=b.type,sa[wa++]=0),void s(b.write.call(this,a));let d=sa,e=ua,f=wa;sa=null;let g;try{g=b.pack.call(this,a,a=>(sa=d,d=null,wa+=a,wa>va&&u(wa),{target:sa,targetView:ua,position:wa-a}),s)}finally{d&&(sa=d,ua=e,wa=f,va=sa.length-10)}return void(g&&(g.length+wa>va&&u(g.length+wa),wa=v(g,sa,wa,b.type)))}// no extension found, write as object
t(a,!a.hasOwnProperty)}}}else if("boolean"===d)sa[wa++]=a?195:194;else if("bigint"===d){if(a<BigInt(1)<<BigInt(63)&&a>=-(BigInt(1)<<BigInt(63)))sa[wa++]=211,ua.setBigInt64(wa,a);else if(a<BigInt(1)<<BigInt(64)&&0<a)sa[wa++]=207,ua.setBigUint64(wa,a);else// overflow
if(this.largeBigIntToFloat)sa[wa++]=203,ua.setFloat64(wa,+a);else throw new RangeError(a+" was too large to fit in MessagePack 64-bit integer format, set largeBigIntToFloat to convert to float-64");wa+=8}else if("undefined"===d)this.encodeUndefinedAsNil?sa[wa++]=192:(sa[wa++]=212,sa[wa++]=0,sa[wa++]=0);else if("function"===d)s(this.writeFunction&&this.writeFunction());else throw new Error("Unknown type: "+d)},t=!1===this.useRecords?this.variableMapSize?a=>{// this method is slightly slower, but generates "preferred serialization" (optimally small for smaller objects)
let b=Object.keys(a),c=b.length;16>c?sa[wa++]=128|c:65536>c?(sa[wa++]=222,sa[wa++]=c>>8,sa[wa++]=255&c):(sa[wa++]=223,ua.setUint32(wa,c),wa+=4);let d;for(let e=0;e<c;e++)s(d=b[e]),s(a[d])}:(a,c)=>{sa[wa++]=222;// always using map 16, so we can preallocate and set the length afterwards
let d=wa-b;wa+=2;let e=0;for(let b in a)(c||a.hasOwnProperty(b))&&(s(b),s(a[b]),e++);sa[d++ +b]=e>>8,sa[d+b]=255&e}:a.progressiveRecords&&!m?// this is about 2% faster for highly stable structures, since it only requires one for-in loop (but much more expensive when new structure needs to be written)
(a,c)=>{let e,f,g=d.transitions||(d.transitions=Object.create(null)),h=wa++-b;for(let i in a)if(c||a.hasOwnProperty(i)){if(e=g[i],e)g=e;else{// record doesn't exist, create full new record and insert it
let c=Object.keys(a),j=g;g=d.transitions;let k=0;for(let a,b=0,d=c.length;b<d;b++)a=c[b],e=g[a],e||(e=g[a]=Object.create(null),k++),g=e;h+b+1==wa?(wa--,y(g,c,k)):// otherwise we need to insert the record, moving existing data after the record
z(g,c,h,k),f=!0,g=j[i]}s(a[i])}if(!f){let c=g[ya];c?sa[h+b]=c:z(g,Object.keys(a),h,0)}}:(a,b)=>{let c,e=d.transitions||(d.transitions=Object.create(null)),f=0;for(let d in a)(b||a.hasOwnProperty(d))&&(c=e[d],c||(c=e[d]=Object.create(null),f++),e=c);let g=e[ya];// now write the values
for(let c in g?96<=g&&m?(sa[wa++]=(31&(g-=96))+96,sa[wa++]=g>>5):sa[wa++]=g:y(e,e.__keys__||Object.keys(a),f),a)(b||a.hasOwnProperty(c))&&s(a[c])},u=a=>{var c=Math.min,d=Math.round,e=Math.max;let f;if(16777216<a){// special handling for really large buffers
if(a-b>ra)throw new Error("Packed buffer would be larger than maximum buffer size");f=c(ra,4096*d(e((a-b)*(67108864<a?1.25:2),4194304)/4096))}else// faster handling for smaller buffers
f=(e(a-b<<2,sa.length-1)>>12)+1<<12;let g=new pa(f);return ua=new DataView(g.buffer,0,f),a=c(a,sa.length),sa.copy?sa.copy(g,0,b,a):g.set(sa.slice(b,a)),wa-=b,b=0,va=g.length-10,sa=g},y=(a,b,e)=>{let f=d.nextId;f||(f=64),f<n&&this.shouldShareStructure&&!this.shouldShareStructure(b)?(f=d.nextOwnId,!(f<o)&&(f=n),d.nextOwnId=f+1):(f>=o&&(// cycle back around
f=n),d.nextId=f+1);let g=b.highByte=96<=f&&m?f-96>>5:-1;a[ya]=f,a.__keys__=b,d[f-64]=b,f<n?(b.isShared=!0,d.sharedLength=f-63,c=!0,0<=g?(sa[wa++]=(31&f)+96,sa[wa++]=g):sa[wa++]=f):(0<=g?(sa[wa++]=213,sa[wa++]=114,sa[wa++]=(31&f)+96,sa[wa++]=g):(sa[wa++]=212,sa[wa++]=114,sa[wa++]=f),e&&(q+=r*e),p.length>=l&&(p.shift()[ya]=0),p.push(a),s(b))},z=(a,c,d,e)=>{let f=sa,g=wa,h=va,i=b;sa=ta,wa=0,b=0,sa||(ta=sa=new pa(8192)),va=sa.length-10,y(a,c,e),ta=sa;let j=wa;if(sa=f,wa=g,va=h,b=i,1<j){let a=wa+j-1;a>va&&u(a);let c=d+b;sa.copyWithin(c+j,c+1,wa),sa.set(ta.slice(0,j),c),wa=a}else sa[d+b]=ta[0]}}useBuffer(a){// this means we are finished using our own buffer and we can write over it safely
sa=a,ua=new DataView(sa.buffer,sa.byteOffset,sa.byteLength),wa=0}clearSharedData(){this.structures&&(this.structures=[])}}na=[Date,Set,Error,RegExp,ArrayBuffer,Object.getPrototypeOf(Uint8Array.prototype).constructor/*TypedArray*/,P],ma=[{pack(a,c,d){let e=a.getTime()/1e3;if((this.useTimestamp32||0===a.getMilliseconds())&&0<=e&&4294967296>e){// Timestamp 32
let{target:a,targetView:b,position:d}=c(6);a[d++]=214,a[d++]=255,b.setUint32(d,e)}else if(0<e&&4294967296>e){// Timestamp 64
let{target:b,targetView:d,position:f}=c(10);b[f++]=215,b[f++]=255,d.setUint32(f,4e6*a.getMilliseconds()+(e/1e3/4294967296>>0)),d.setUint32(f+4,e)}else if(isNaN(e)){if(this.onInvalidDate)return c(0),d(this.onInvalidDate());// Intentionally invalid timestamp
let{target:a,targetView:b,position:e}=c(3);a[e++]=212,a[e++]=255,a[e++]=255}else{// Timestamp 96
let{target:d,targetView:f,position:g}=c(15);d[g++]=199,d[g++]=12,d[g++]=255,f.setUint32(g,1e6*a.getMilliseconds()),f.setBigInt64(g+4,BigInt(b(e)))}}},{pack(a,b,c){let d=Array.from(a),{target:e,position:f}=b(this.moreTypes?3:0);this.moreTypes&&(e[f++]=212,e[f++]=115,e[f++]=0),c(d)}},{pack(a,b,c){let{target:d,position:e}=b(this.moreTypes?3:0);this.moreTypes&&(d[e++]=212,d[e++]=101,d[e++]=0),c([a.name,a.message])}},{pack(a,b,c){let{target:d,position:e}=b(this.moreTypes?3:0);this.moreTypes&&(d[e++]=212,d[e++]=120,d[e++]=0),c([a.source,a.flags])}},{pack(a,b){this.moreTypes?t(a,16,b):u(oa?Buffer.from(a):new Uint8Array(a),b)}},{pack(a,b){let c=a.constructor;c!==qa&&this.moreTypes?t(a,ba.indexOf(c.name),b):u(a,b)}},{pack(a,b){// specific 0xC1 object
let{target:c,position:d}=b(1);c[d]=193}}];let Aa=new za({useRecords:!1});const Ba=Aa.pack,Ca=Aa.pack,{NEVER:Da,ALWAYS:Ea,DECIMAL_ROUND:Fa,DECIMAL_FIT:Ga}=ia,Ha=512,Ia=1024;a.ALWAYS=Ea,a.C1=Q,a.DECIMAL_FIT=Ga,a.DECIMAL_ROUND=Fa,a.Decoder=T,a.Encoder=za,a.FLOAT32_OPTIONS=ia,a.NEVER=Da,a.Packr=za,a.REUSE_BUFFER_MODE=Ha,a.Unpackr=T,a.addExtension=y,a.clearSource=r,a.decode=ha,a.decodeIter=function(a,b={}){if(!a||"object"!=typeof a)throw new Error("first argument must be an Iterable, Async Iterable, Iterator, Async Iterator, or a promise");const c=new T(b);let d;const e=a=>{let b;// if there's incomplete data from previous chunk, concatinate and try again
d&&(a=Buffer.concat([d,a]),d=void 0);try{b=c.unpackMultiple(a)}catch(c){if(c.incomplete)d=a.slice(c.lastPosition),b=c.values;else throw c}return b};if("function"==typeof a[Symbol.iterator])return function*(){for(const b of a)yield*e(b)}();return"function"==typeof a[Symbol.asyncIterator]?async function*(){for await(const b of a)yield*e(b)}():void 0},a.encode=Ca,a.encodeIter=/**
	 * Given an Iterable first argument, returns an Iterable where each value is packed as a Buffer
	 * If the argument is only Async Iterable, the return value will be an Async Iterable.
	 * @param {Iterable|Iterator|AsyncIterable|AsyncIterator} objectIterator - iterable source, like a Readable object stream, an array, Set, or custom object
	 * @param {options} [options] - msgpackr pack options
	 * @returns {IterableIterator|Promise.<AsyncIterableIterator>}
	 */function(a,b={}){if(!a||"object"!=typeof a)throw new Error("first argument must be an Iterable, Async Iterable, or a Promise for an Async Iterable");else{if("function"==typeof a[Symbol.iterator])return z(a,b);if("function"==typeof a.then||"function"==typeof a[Symbol.asyncIterator])return A(a,b);throw new Error("first argument must be an Iterable, Async Iterable, Iterator, Async Iterator, or a Promise")}},a.isNativeAccelerationEnabled=!1,a.mapsAsObjects=!0,a.pack=Ba,a.roundFloat32=function(a){ka[0]=a;let b=da[(127&la[3])<<1|la[2]>>7];return(b*a+(0<a?.5:-.5)>>0)/b},a.unpack=fa,a.unpackMultiple=ga,a.useRecords=!1,Object.defineProperty(a,"__esModule",{value:!0})});


const RIBBON_CLOSE_CODES = {
	'1000': 'ribbon closed normally',
	'1001': 'client closed ribbon',
	'1002': 'protocol error',
	'1003': 'protocol violation',
	'1006': 'ribbon lost',
	'1007': 'payload data corrupted',
	'1008': 'protocol violation',
	'1009': 'too much data',
	'1010': 'negotiation error',
	'1011': 'server error',
	'1012': 'server restarting',
	'1013': 'temporary error',
	'1014': 'bad gateway',
	'1015': 'TLS error'
};
const RIBBON_BATCH_TIMEOUT = 25;
const RIBBON_CACHE_EVICTION_TIME = 25000;

const RIBBON_EXTRACTED_ID_TAG = new Uint8Array([174]);
const RIBBON_STANDARD_ID_TAG = new Uint8Array([69]);
const RIBBON_BATCH_TAG = new Uint8Array([88]);
const RIBBON_EXTENSION_TAG = new Uint8Array([0xB0]);

const RIBBON_EXTENSIONS = new Map();
RIBBON_EXTENSIONS.set(0x0B, (payload) => {
	if (payload.byteLength >= 6) {
		return { command: 'ping', at: new DataView(payload.buffer).getUint32(2, false) };
	} else {
		return { command: 'ping' };
	}
	
});
RIBBON_EXTENSIONS.set('PING', (extensionData) => {
	if (typeof extensionData === 'number') {
		const dat = new Uint8Array([0xB0, 0x0B, 0x00, 0x00, 0x00, 0x00]);
		new DataView(dat.buffer).setUint32(2, extensionData, false);
		return dat;
	} else {
		return new Uint8Array([0xB0, 0x0B]);
	}
});
RIBBON_EXTENSIONS.set(0x0C, (payload) => {
	if (payload.byteLength >= 6) {
		return { command: 'pong', at: new DataView(payload.buffer).getUint32(2, false) };
	} else {
		return { command: 'pong' };
	}
});
RIBBON_EXTENSIONS.set('PONG', (extensionData) => {
	if (typeof extensionData === 'number') {
		const dat = new Uint8Array([0xB0, 0x0C, 0x00, 0x00, 0x00, 0x00]);
		new DataView(dat.buffer).setUint32(2, extensionData, false);
		return dat;
	} else {
		return new Uint8Array([0xB0, 0x0C]);
	}
});

const globalRibbonPackr = new msgpackr.Packr({
	bundleStrings: true
});
const globalRibbonUnpackr = new msgpackr.Unpackr({
	bundleStrings: true
});



// Ribbon - blazing-fast, msgpacked resumeable WebSockets 
const Ribbon = function(uri) {
	let endpoint = uri;
	let spoolToken = undefined;
	let ws = null;
	let id = null;
	let resume = null;
	let lastSentId = 0;
	let lastReceivedId = 0;
	let lastSent = [];
	let lastSentTimes = [];
	let alive = true;
	let closeReason = 'ribbon lost';
	let messageListeners = {};
	let openListeners = [];
	let closeListeners = [];
	let pongListeners = [];
	let resumeListeners = [];
	let reconnectStartListeners = [];
	let saveListeners = [];
	let pingInterval = null;
	let lastPing = 0;
	let mayReconnect = true;
	let dead = false;
	let ignoreCleanness = false;
	let pingissues = false;
	let wasEverConnected = false;
	let incomingQueue = [];
	let switchingEndpoint = false;
	let batchQueue = [];
	let batchTimeout = null;
	let cacheSize = 200;
	let reconnecting = false;
	let lastCacheReping = Date.now();
	let fasterPingRequirement = false;
	let pingID = 0;
	let reconnectTimeout = null;

	pingInterval = setInterval(() => {
		pingID++;
		if (!fasterPingRequirement && (pingID % 2) !== 0) {
			return;
		}

		if (!alive) {
			// we're pinging out, get our ass a new connection
			pingissues = true;
			console.warn('Ping timeout in ribbon. Abandoning current socket and obtaining a new one...');
			closeReason = 'ping timeout';
			Reconnect();
		}
		alive = false;
		if (ws && ws.readyState === 1) {
			lastPing = Date.now();
			try {
				if (ws.readyState === 1) {
					ws.send(SmartEncode('PING', null, lastReceivedId));
				}
			} catch (ex) {}
		}

		// It's a bit cheeky to do this here, but it's fine. If we already have an interval, why create another one?
		while (lastSentTimes.length && (Date.now() - lastSentTimes[0]) >= RIBBON_CACHE_EVICTION_TIME) {
			lastSent.shift();
			lastSentTimes.shift();
		}
	}, 2500);

	function SmartEncode(packet, packr = null, extensionData = null) {
		if (typeof packet === 'string') {
			// This might be an extension, look it up
			const found = RIBBON_EXTENSIONS.get(packet);
			if (found) {
				return found(extensionData);
			}
		}

		let prependable = RIBBON_STANDARD_ID_TAG;

		const msgpacked = (packr || globalRibbonPackr).pack(packet);
		const merged = new Uint8Array(prependable.length + msgpacked.length);
		merged.set(prependable, 0);
		merged.set(msgpacked, prependable.length);

		return merged;
	}

	function SmartDecode(packet, unpackr = null) {
		if (packet[0] === RIBBON_EXTENSION_TAG[0]) {
			// look up this extension
			const found = RIBBON_EXTENSIONS.get(packet[1]);
			if (!found) {
				console.error(`Unknown Ribbon extension ${ packet[1] }!`);
				console.error(packet);
				throw 'Unknown extension';
			}
			return found(packet);
		} else if (packet[0] === RIBBON_STANDARD_ID_TAG[0]) {
			// simply extract
			return (unpackr || globalRibbonUnpackr).unpack(packet.slice(1));
		} else if (packet[0] === RIBBON_EXTRACTED_ID_TAG[0]) {
			// extract id and msgpacked, then inject id back in
			// these don't support sequential!
			const object = globalRibbonUnpackr.unpack(packet.slice(5));
			const view = new DataView(packet.buffer);
			const id = view.getUint32(1, false);
			object.id = id;

			return object;
		} else if (packet[0] === RIBBON_BATCH_TAG[0]) {
			// ok these are complex, keep looking through the header until you get to the (uint32)0 delimiter
			const items = [];
			const lengths = [];
			const view = new DataView(packet.buffer);
			
			// Get the lengths
			for (let i = 0; true; i++) {
				const length = view.getUint32(1 + (i * 4), false);
				if (length === 0) {
					// We've hit the end of the batch
					break;
				}
				lengths.push(length);
			}

			// Get the items at those lengths
			let pointer = 0;
			for (let i = 0; i < lengths.length; i++) {
				items.push(packet.slice(1 + (lengths.length * 4) + 4 + pointer, 1 + (lengths.length * 4) + 4 + pointer + lengths[i]));
				pointer += lengths[i];
			}

			return { command: 'X-MUL', items: items.map(o => SmartDecode(o, unpackr)) };
		} else {
			// try just parsing it straight?
			return (unpackr || globalRibbonUnpackr).unpack(packet);
		}
	}

	function Open() {
		if (ws) {
			// Discard the old socket entirely
			ws.onopen = ()=>{};
			ws.onmessage = ()=>{};
			ws.onerror = ()=>{};
			ws.onclose = ()=>{};
			ws.close();
		}

		ws = new WebSocket(endpoint, spoolToken);
		incomingQueue = [];
		ws.packr = new msgpackr.Packr({
			bundleStrings: true,
			sequential: true
		});
		ws.unpackr = new msgpackr.Unpackr({
			bundleStrings: true,
			sequential: true
		});

		ws.onclose = (e) => {
			ignoreCleanness = false;
			if (RIBBON_CLOSE_CODES[e.code]) {
				closeReason = RIBBON_CLOSE_CODES[e.code];
			}
			if (closeReason === 'ribbon lost' && pingissues) {
				closeReason = 'ping timeout';
			}
			if (closeReason === 'ribbon lost' && !wasEverConnected) {
				closeReason = 'failed to connect';
			}
			console.log(`Ribbon ${ id } closed (${ closeReason })`);
			Reconnect();
		};
		ws.onopen = (e) => {
			wasEverConnected = true;
			if (resume) {
				console.log(`Ribbon ${ id } resuming`);
				ws.send(SmartEncode({ command: 'resume', socketid: id, resumetoken: resume }, ws.packr));
			} else {
				ws.send(SmartEncode({ command: 'new' }, ws.packr));
			}
		};
		ws.onmessage = (e) => {
			try {
				new Response(e.data).arrayBuffer().then((ab) => {
					const msg = SmartDecode(new Uint8Array(ab), ws.unpackr);

					if (msg.command === 'kick') {
						mayReconnect = false;
					}

					if (msg.command === 'nope') {
						console.error(`Ribbon ${ id } noped out (${ msg.reason })`);
						mayReconnect = false;
						closeReason = msg.reason;
						Close();
					} else if (msg.command === 'hello') {
						reconnecting = false;
						id = msg.id;
						console.log(`Ribbon ${ id } ${ resume ? 'resumed' : 'opened' }`);
						if (resume) {
							ws.send(SmartEncode({ command: 'hello', packets: lastSent }, ws.packr));
						}
						resume = msg.resume;
						alive = true;
						msg.packets.forEach((p) => {
							HandleMessage(p);
						});
						openListeners.forEach((l) => {
							l();
						});
						saveListeners.forEach((l) => {
							l(closeReason);
						});
					} else if (msg.command === 'pong') {
						alive = true;
						pingissues = false;
						pongListeners.forEach((l) => {
							l(Date.now() - lastPing);
						});
						if (msg.at) {
							// we can evict anything lower from our to-be-sent
							while (lastSent.length && lastSent[0].id <= msg.at) {
								lastSent.shift();
								lastSentTimes.shift();
							}
						}
					} else if (msg.command === 'X-MUL') {
						msg.items.forEach((m) => {
							HandleMessage(m);
						});
					} else {
						HandleMessage(msg);
					}
				});
			} catch (ex) {
				console.error('Failed to parse message', ex);
			}
		};
		ws.onerror = (e) => {
			if (!wasEverConnected) {
				if (messageListeners['connect_error']) {
					messageListeners['connect_error'].forEach((l) => {
						l();
					});
				}
			}
			console.log(e);
		};
		alive = true;
	}

	function HandleMessage(msg) {
		if (msg.id) {
			if (msg.id <= lastReceivedId) {
				return; // already seen this
			}

			EnqueueMessage(msg);
			return;
		}

		if (messageListeners[msg.command]) {
			messageListeners[msg.command].forEach((l) => {
				l(msg.data);
			});
		}
	}

	function EnqueueMessage(msg) {
		if (msg.id === lastReceivedId + 1) {
			// we're in order, all good!
			if (messageListeners[msg.command]) {
				messageListeners[msg.command].forEach((l) => {
					l(msg.data);
				});
			}
			lastReceivedId = msg.id;
		} else {
			incomingQueue.push(msg);
		}

		if (incomingQueue.length) {
			// Try to go through these
			incomingQueue.sort((a, b) => {
				return a.id - b.id;
			});

			while (incomingQueue.length) {
				const trackbackMessage = incomingQueue[0];

				if (trackbackMessage.id !== lastReceivedId + 1) {
					// no good, wait longer
					break;
				}

				// cool, let's push it
				incomingQueue.shift();
				if (messageListeners[trackbackMessage.command]) {
					messageListeners[trackbackMessage.command].forEach((l) => {
						l(trackbackMessage.data);
					});
				}
				lastReceivedId = trackbackMessage.id;
			}
		}
		if (incomingQueue.length > 5200) {
			console.error(`Ribbon ${ id } unrecoverable: ${ incomingQueue.length } packets out of order`);
			closeReason = 'too many lost packets';
			Close();
			return;
		}
	}

	function Send(command, data, batched = false) {
		const packet = { id: ++lastSentId, command, data };
		lastSent.push(packet);
		lastSentTimes.push(Date.now());
		if (reconnecting) { return; }

		if ((lastSentId % 100) === 0) {
			// recalculate how large our cache should be
			const packetsPerSecond = 1000 / ((Date.now() - lastCacheReping) / 100);
			cacheSize = Math.max(100, Math.min(30 * packetsPerSecond, 2000));
			lastCacheReping = Date.now();
		}

		while (lastSent.length > cacheSize) {
			lastSent.shift();
			lastSentTimes.shift();
		}

		while (lastSentTimes.length && (Date.now() - lastSentTimes[0]) >= RIBBON_CACHE_EVICTION_TIME) {
			lastSent.shift();
			lastSentTimes.shift();
		}

		if (batched) {
			batchQueue.push(SmartEncode(packet, ws ? ws.packr : null));

			if (!batchTimeout) {
				batchTimeout = setTimeout(FlushBatch, RIBBON_BATCH_TIMEOUT);
			}
			return;
		} else {
			FlushBatch();
		}

		try {
			if (ws.readyState === 1) {
				ws.send(SmartEncode(packet, ws.packr));
			}
		} catch (ex) {}
	}

	function FlushBatch() {
		if (!batchQueue.length) { return; }
		if (reconnecting) { return; }

		if (batchTimeout) {
			clearTimeout(batchTimeout);
			batchTimeout = null;
		}

		// If our batch is only 1 long we really dont need to go through this painful process
		if (batchQueue.length === 1) {
			try {
				if (ws.readyState === 1) {
					ws.send(batchQueue[0]);
				}
			} catch (ex) {}

			batchQueue = [];
			return;
		}

		// Get the total size of our payload, so we can prepare a buffer for it
		let totalSize = batchQueue.reduce((a, c) => { return a + c.length; }, 0);
		const buffer = new Uint8Array(1 + (batchQueue.length * 4) + 4 + totalSize);
		const view = new DataView(buffer.buffer);

		// Set the tag
		buffer.set(RIBBON_BATCH_TAG, 0);

		// Set the lengths and data blocks
		let pointer = 0;

		for (let i = 0; i < batchQueue.length; i++) {
			// Set the length
			view.setUint32(1 + (i * 4), batchQueue[i].length, false);

			// Set the data
			buffer.set(batchQueue[i], 1 + (batchQueue.length * 4) + 4 + pointer);
			pointer += batchQueue[i].length;
		}

		// Batch ready to send!
		try {
			if (ws.readyState === 1) {
				ws.send(buffer);
			}
		} catch (ex) {}

		batchQueue = [];
	}

	function Close(reason = null, silent = false) {
		mayReconnect = false;
		if (reason) {
			closeReason = reason;
		}
		if (ws) {
			ws.onclose = ()=>{};
			try {
				if (ws.readyState === 1) {
					ws.send(SmartEncode({ command: 'die' }, ws.packr));
				}
				ws.close();
			} catch (ex) {}
		}

		Die(silent);
	}

	function Cut(penalty = 0) {
		ignoreCleanness = true;
		extraPenalty = penalty;
		if (ws) {
			ws.close();
		}
	}

	function SwitchEndpoint() {
		console.warn(`Ribbon ${ id } changing endpoint (new endpoint: ${ endpoint })`);
		ignoreCleanness = true;
		switchingEndpoint = true;
		if (ws) {
			ws.close();
		}

		ExpediteReconnect();
	}

	let reconnectCount = 0;
	let lastReconnect = 0;
	let extraPenalty = 0;

	function Reconnect() {
		reconnecting = true;

		if (!switchingEndpoint) {
			if ((Date.now() - lastReconnect) > 40000) {
				reconnectCount = 0;
			}
			lastReconnect = Date.now();

			if (reconnectCount >= 10 || !mayReconnect) {
				// Stop bothering
				console.error(`Ribbon ${ id } abandoned: ${ mayReconnect ? 'too many reconnects' : 'may not reconnect' }`);
				Die();
				return;
			}

			console.warn(`Ribbon ${ id } reconnecting in ${ extraPenalty + 5 + 100 * reconnectCount }ms (reconnects: ${ reconnectCount + 1 })`);
			resumeListeners.forEach((l) => {
				l(extraPenalty + 5 + 100 * reconnectCount);
			});
		}
		
		if (reconnectTimeout) { clearTimeout(reconnectTimeout); }
		reconnectTimeout = setTimeout(() => {
			reconnectTimeout = null;
			if (dead) {
				console.log(`Canceling reopen of ${ id }: no longer needed`);
				return;
			}

			reconnectStartListeners.forEach((l) => { l(); });

			Open();
		}, switchingEndpoint ? 0 : (extraPenalty + 5 + 100 * reconnectCount));

		if (switchingEndpoint) {
			switchingEndpoint = false;
		} else {
			reconnectCount++;
			extraPenalty = 0;
		}
	}

	function ExpediteReconnect() {
		if (!reconnectTimeout) { return; }
		clearTimeout(reconnectTimeout);

		reconnectTimeout = null;
		if (dead) {
			console.log(`Canceling reopen of ${ id }: no longer needed`);
			return;
		}

		reconnectStartListeners.forEach((l) => { l(); });

		Open();
		switchingEndpoint = false;
	}

	function Die(silent = false) {
		if (dead) { return; }
		console.log(`Ribbon ${ id } dead (${ closeReason })`);
		dead = true;
		mayReconnect = false;

		if (!silent) {
			closeListeners.forEach((l) => {
				l(closeReason);
			});
		}

		if (ws) {
			ws.onopen = ()=>{};
			ws.onmessage = ()=>{};
			ws.onerror = ()=>{};
			ws.onclose = ()=>{};
		}
		
		clearInterval(pingInterval);
	}


	// Publics
	return {
		getEndpoint: () => {
			return endpoint;
		},
		setEndpoint: (uri) => {
			endpoint = uri;
		},
		getSpoolToken: () => {
			return spoolToken;
		},
		setSpoolToken: (uri) => {
			spoolToken = uri;
		},
		getId: () => { return id; },
		open: Open,
		isAlive: () => { return alive; },
		close: Close,
		send: Send,
		emit: Send,
		onclose: (l) => { closeListeners.push(l); },
		onopen: (l) => { openListeners.push(l); },
		onpong: (l) => { pongListeners.push(l); },
		onresume: (l) => { resumeListeners.push(l); },
		onreconnectstart: (l) => { reconnectStartListeners.push(l); },
		onsave: (l) => { saveListeners.push(l); },
		on: (type, l) => {
			if (messageListeners[type]) {
				messageListeners[type].push(l);
			} else {
				messageListeners[type] = [l];
			}
		},
		off: (type, l) => {
			if (messageListeners[type]) {
				if (!l) {
					messageListeners[type] = [];
					return;
				} else {
					messageListeners[type] = messageListeners[type].filter(o => o !== l);
				}
			}
		},
		cut: Cut,
		switchEndpoint: SwitchEndpoint,
		setFasterPingRequirement: (nv) => { fasterPingRequirement = nv; }
	};
}


/**
 * FingerprintJS v3.0.7 - Copyright (c) FingerprintJS, Inc, 2021 (https://fingerprintjs.com)
 * Licensed under the MIT (http://www.opensource.org/licenses/mit-license.php) license.
 *
 * This software contains code from open-source projects:
 * MurmurHash3 by Karan Lyons (https://github.com/karanlyons/murmurHash3.js)
 */

var FingerprintJS=function(e){"use strict";function n(e,n){e=[e[0]>>>16,65535&e[0],e[1]>>>16,65535&e[1]],n=[n[0]>>>16,65535&n[0],n[1]>>>16,65535&n[1]];var t=[0,0,0,0];return t[3]+=e[3]+n[3],t[2]+=t[3]>>>16,t[3]&=65535,t[2]+=e[2]+n[2],t[1]+=t[2]>>>16,t[2]&=65535,t[1]+=e[1]+n[1],t[0]+=t[1]>>>16,t[1]&=65535,t[0]+=e[0]+n[0],t[0]&=65535,[t[0]<<16|t[1],t[2]<<16|t[3]]}function t(e,n){e=[e[0]>>>16,65535&e[0],e[1]>>>16,65535&e[1]],n=[n[0]>>>16,65535&n[0],n[1]>>>16,65535&n[1]];var t=[0,0,0,0];return t[3]+=e[3]*n[3],t[2]+=t[3]>>>16,t[3]&=65535,t[2]+=e[2]*n[3],t[1]+=t[2]>>>16,t[2]&=65535,t[2]+=e[3]*n[2],t[1]+=t[2]>>>16,t[2]&=65535,t[1]+=e[1]*n[3],t[0]+=t[1]>>>16,t[1]&=65535,t[1]+=e[2]*n[2],t[0]+=t[1]>>>16,t[1]&=65535,t[1]+=e[3]*n[1],t[0]+=t[1]>>>16,t[1]&=65535,t[0]+=e[0]*n[3]+e[1]*n[2]+e[2]*n[1]+e[3]*n[0],t[0]&=65535,[t[0]<<16|t[1],t[2]<<16|t[3]]}function r(e,n){return 32===(n%=64)?[e[1],e[0]]:n<32?[e[0]<<n|e[1]>>>32-n,e[1]<<n|e[0]>>>32-n]:(n-=32,[e[1]<<n|e[0]>>>32-n,e[0]<<n|e[1]>>>32-n])}function o(e,n){return 0===(n%=64)?e:n<32?[e[0]<<n|e[1]>>>32-n,e[1]<<n]:[e[1]<<n-32,0]}function i(e,n){return[e[0]^n[0],e[1]^n[1]]}function a(e){return e=i(e,[0,e[0]>>>1]),e=i(e=t(e,[4283543511,3981806797]),[0,e[0]>>>1]),e=i(e=t(e,[3301882366,444984403]),[0,e[0]>>>1])}function u(e,u){u=u||0;var c,s=(e=e||"").length%16,l=e.length-s,f=[0,u],d=[0,u],v=[0,0],h=[0,0],g=[2277735313,289559509],p=[1291169091,658871167];for(c=0;c<l;c+=16)v=[255&e.charCodeAt(c+4)|(255&e.charCodeAt(c+5))<<8|(255&e.charCodeAt(c+6))<<16|(255&e.charCodeAt(c+7))<<24,255&e.charCodeAt(c)|(255&e.charCodeAt(c+1))<<8|(255&e.charCodeAt(c+2))<<16|(255&e.charCodeAt(c+3))<<24],h=[255&e.charCodeAt(c+12)|(255&e.charCodeAt(c+13))<<8|(255&e.charCodeAt(c+14))<<16|(255&e.charCodeAt(c+15))<<24,255&e.charCodeAt(c+8)|(255&e.charCodeAt(c+9))<<8|(255&e.charCodeAt(c+10))<<16|(255&e.charCodeAt(c+11))<<24],v=r(v=t(v,g),31),f=n(f=r(f=i(f,v=t(v,p)),27),d),f=n(t(f,[0,5]),[0,1390208809]),h=r(h=t(h,p),33),d=n(d=r(d=i(d,h=t(h,g)),31),f),d=n(t(d,[0,5]),[0,944331445]);switch(v=[0,0],h=[0,0],s){case 15:h=i(h,o([0,e.charCodeAt(c+14)],48));case 14:h=i(h,o([0,e.charCodeAt(c+13)],40));case 13:h=i(h,o([0,e.charCodeAt(c+12)],32));case 12:h=i(h,o([0,e.charCodeAt(c+11)],24));case 11:h=i(h,o([0,e.charCodeAt(c+10)],16));case 10:h=i(h,o([0,e.charCodeAt(c+9)],8));case 9:h=t(h=i(h,[0,e.charCodeAt(c+8)]),p),d=i(d,h=t(h=r(h,33),g));case 8:v=i(v,o([0,e.charCodeAt(c+7)],56));case 7:v=i(v,o([0,e.charCodeAt(c+6)],48));case 6:v=i(v,o([0,e.charCodeAt(c+5)],40));case 5:v=i(v,o([0,e.charCodeAt(c+4)],32));case 4:v=i(v,o([0,e.charCodeAt(c+3)],24));case 3:v=i(v,o([0,e.charCodeAt(c+2)],16));case 2:v=i(v,o([0,e.charCodeAt(c+1)],8));case 1:v=t(v=i(v,[0,e.charCodeAt(c)]),g),f=i(f,v=t(v=r(v,31),p))}return f=n(f=i(f,[0,e.length]),d=i(d,[0,e.length])),d=n(d,f),f=n(f=a(f),d=a(d)),d=n(d,f),("00000000"+(f[0]>>>0).toString(16)).slice(-8)+("00000000"+(f[1]>>>0).toString(16)).slice(-8)+("00000000"+(d[0]>>>0).toString(16)).slice(-8)+("00000000"+(d[1]>>>0).toString(16)).slice(-8)}var c=function(){return(c=Object.assign||function(e){for(var n,t=1,r=arguments.length;t<r;t++)for(var o in n=arguments[t])Object.prototype.hasOwnProperty.call(n,o)&&(e[o]=n[o]);return e}).apply(this,arguments)};function s(e,n,t,r){return new(t||(t=Promise))((function(o,i){function a(e){try{c(r.next(e))}catch(n){i(n)}}function u(e){try{c(r.throw(e))}catch(n){i(n)}}function c(e){var n;e.done?o(e.value):(n=e.value,n instanceof t?n:new t((function(e){e(n)}))).then(a,u)}c((r=r.apply(e,n||[])).next())}))}function l(e,n){var t,r,o,i,a={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return i={next:u(0),throw:u(1),return:u(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function u(i){return function(u){return function(i){if(t)throw new TypeError("Generator is already executing.");for(;a;)try{if(t=1,r&&(o=2&i[0]?r.return:i[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,i[1])).done)return o;switch(r=0,o&&(i=[2&i[0],o.value]),i[0]){case 0:case 1:o=i;break;case 4:return a.label++,{value:i[1],done:!1};case 5:a.label++,r=i[1],i=[0];continue;case 7:i=a.ops.pop(),a.trys.pop();continue;default:if(!(o=a.trys,(o=o.length>0&&o[o.length-1])||6!==i[0]&&2!==i[0])){a=0;continue}if(3===i[0]&&(!o||i[1]>o[0]&&i[1]<o[3])){a.label=i[1];break}if(6===i[0]&&a.label<o[1]){a.label=o[1],o=i;break}if(o&&a.label<o[2]){a.label=o[2],a.ops.push(i);break}o[2]&&a.ops.pop(),a.trys.pop();continue}i=n.call(e,a)}catch(u){i=[6,u],r=0}finally{t=o=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,u])}}}function f(e,n){return new Promise((function(t){return setTimeout(t,e,n)}))}function d(e,n){void 0===n&&(n=1/0);var t=window.requestIdleCallback;return t?new Promise((function(e){return t((function(){return e()}),{timeout:n})})):f(Math.min(e,n))}function v(e){return parseInt(e)}function h(e){return parseFloat(e)}function g(e){return e.reduce((function(e,n){return e+(n?1:0)}),0)}function p(){var e=window,n=navigator;return g(["MSCSSMatrix"in e,"msSetImmediate"in e,"msIndexedDB"in e,"msMaxTouchPoints"in n,"msPointerEnabled"in n])>=4}function m(){var e=window,n=navigator;return g(["msWriteProfilerMark"in e,"MSStream"in e,"msLaunchUri"in n,"msSaveBlob"in n])>=3&&!p()}function w(){var e=window,n=navigator;return g(["webkitPersistentStorage"in n,"webkitTemporaryStorage"in n,0===n.vendor.indexOf("Google"),"webkitResolveLocalFileSystemURL"in e,"BatteryManager"in e,"webkitMediaStream"in e,"webkitSpeechGrammar"in e])>=5}function y(){var e=window,n=navigator;return g(["ApplePayError"in e,"CSSPrimitiveValue"in e,"Counter"in e,0===n.vendor.indexOf("Apple"),"getStorageUpdates"in n,"WebKitMediaKeys"in e])>=4}function b(){var e=window;return g(["safari"in e,!("DeviceMotionEvent"in e),!("ongestureend"in e),!("standalone"in navigator)])>=3}function S(e){return new Promise((function(n,t){e.oncomplete=function(e){return n(e.renderedBuffer)};var r=3,o=function(){switch(e.startRendering(),e.state){case"running":setTimeout((function(){return t(A("timeout"))}),1e3);break;case"suspended":document.hidden||r--,r>0?setTimeout(o,500):t(A("suspended"))}};o()}))}function C(e){for(var n=0,t=0;t<e.length;++t)n+=Math.abs(e[t]);return n}function A(e){var n=new Error(e);return n.name=e,n}var M=["monospace","sans-serif","serif"],T=["sans-serif-thin","ARNO PRO","Agency FB","Arabic Typesetting","Arial Unicode MS","AvantGarde Bk BT","BankGothic Md BT","Batang","Bitstream Vera Sans Mono","Calibri","Century","Century Gothic","Clarendon","EUROSTILE","Franklin Gothic","Futura Bk BT","Futura Md BT","GOTHAM","Gill Sans","HELV","Haettenschweiler","Helvetica Neue","Humanst521 BT","Leelawadee","Letter Gothic","Levenim MT","Lucida Bright","Lucida Sans","Menlo","MS Mincho","MS Outlook","MS Reference Specialty","MS UI Gothic","MT Extra","MYRIAD PRO","Marlett","Meiryo UI","Microsoft Uighur","Minion Pro","Monotype Corsiva","PMingLiU","Pristina","SCRIPTINA","Segoe UI Light","Serifa","SimHei","Small Fonts","Staccato222 BT","TRAJAN PRO","Univers CE 55 Medium","Vrinda","ZWAdobeF"];function k(e){return e.toDataURL()}var P={osCpu:function(){return navigator.oscpu},languages:function(){var e,n=navigator,t=[],r=n.language||n.userLanguage||n.browserLanguage||n.systemLanguage;if(void 0!==r&&t.push([r]),Array.isArray(n.languages))w()&&g([!("MediaSettingsRange"in(e=window)),"RTCEncodedAudioFrame"in e,""+e.Intl=="[object Intl]",""+e.Reflect=="[object Reflect]"])>=3||t.push(n.languages);else if("string"==typeof n.languages){var o=n.languages;o&&t.push(o.split(","))}return t},colorDepth:function(){return window.screen.colorDepth},deviceMemory:function(){return e=h(navigator.deviceMemory),n=void 0,"number"==typeof e&&isNaN(e)?n:e;var e,n},screenResolution:function(){var e=screen,n=[v(e.width),v(e.height)];return n.sort().reverse(),n},availableScreenResolution:function(){var e=screen;if(e.availWidth&&e.availHeight){var n=[v(e.availWidth),v(e.availHeight)];return n.sort().reverse(),n}},hardwareConcurrency:function(){try{var e=v(navigator.hardwareConcurrency);return isNaN(e)?1:e}catch(n){return 1}},timezoneOffset:function(){var e=(new Date).getFullYear();return Math.max(h(new Date(e,0,1).getTimezoneOffset()),h(new Date(e,6,1).getTimezoneOffset()))},timezone:function(){var e,n=null===(e=window.Intl)||void 0===e?void 0:e.DateTimeFormat;if(n)return(new n).resolvedOptions().timeZone},sessionStorage:function(){try{return!!window.sessionStorage}catch(e){return!0}},localStorage:function(){try{return!!window.localStorage}catch(e){return!0}},indexedDB:function(){if(!p()&&!m())try{return!!window.indexedDB}catch(e){return!0}},openDatabase:function(){return!!window.openDatabase},cpuClass:function(){return navigator.cpuClass},platform:function(){return navigator.platform},plugins:function(){if(p())return[];if(navigator.plugins){for(var e=[],n=0;n<navigator.plugins.length;++n){var t=navigator.plugins[n];if(t){for(var r=[],o=0;o<t.length;++o){var i=t[o];r.push({type:i.type,suffixes:i.suffixes})}e.push({name:t.name,description:t.description,mimeTypes:r})}}return e}},canvas:function(){var e=function(){var e=document.createElement("canvas");return e.width=240,e.height=140,e.style.display="inline",[e,e.getContext("2d")]}(),n=e[0],t=e[1];if(!function(e,n){return!(!n||!e.toDataURL)}(n,t))return{winding:!1,data:""};t.rect(0,0,10,10),t.rect(2,2,6,6);var r=!t.isPointInPath(5,5,"evenodd");t.textBaseline="alphabetic",t.fillStyle="#f60",t.fillRect(125,1,62,20),t.fillStyle="#069",t.font="11pt no-real-font-123";var o="Cwm fjordbank "+String.fromCharCode(55357,56835)+" gly";t.fillText(o,2,15),t.fillStyle="rgba(102, 204, 0, 0.2)",t.font="18pt Arial",t.fillText(o,4,45),t.globalCompositeOperation="multiply";for(var i=0,a=[["#f0f",50,50],["#0ff",100,50],["#ff0",75,100]];i<a.length;i++){var u=a[i],c=u[0],s=u[1],l=u[2];t.fillStyle=c,t.beginPath(),t.arc(s,l,50,0,2*Math.PI,!0),t.closePath(),t.fill()}return t.fillStyle="#f0f",t.arc(75,75,75,0,2*Math.PI,!0),t.arc(75,75,25,0,2*Math.PI,!0),t.fill("evenodd"),{winding:r,data:k(n)}},touchSupport:function(){var e,n=navigator,t=0;void 0!==n.maxTouchPoints?t=v(n.maxTouchPoints):void 0!==n.msMaxTouchPoints&&(t=n.msMaxTouchPoints);try{document.createEvent("TouchEvent"),e=!0}catch(r){e=!1}return{maxTouchPoints:t,touchEvent:e,touchStart:"ontouchstart"in window}},fonts:function(){return function(e,n,t){var r,o;return void 0===t&&(t=50),s(this,void 0,void 0,(function(){var i,a;return l(this,(function(u){switch(u.label){case 0:i=document,u.label=1;case 1:return i.body?[3,3]:[4,f(t)];case 2:return u.sent(),[3,1];case 3:a=i.createElement("iframe"),u.label=4;case 4:return u.trys.push([4,,10,11]),[4,new Promise((function(e,t){a.onload=e,a.onerror=t;var r=a.style;r.setProperty("display","block","important"),r.position="absolute",r.top="0",r.left="0",r.visibility="hidden",n&&"srcdoc"in a?a.srcdoc=n:a.src="about:blank",i.body.appendChild(a)}))];case 5:u.sent(),u.label=6;case 6:return(null===(r=a.contentWindow)||void 0===r?void 0:r.document.body)?[3,8]:[4,f(t)];case 7:return u.sent(),[3,6];case 8:return[4,e(a,a.contentWindow)];case 9:return[2,u.sent()];case 10:return null===(o=a.parentNode)||void 0===o||o.removeChild(a),[7];case 11:return[2]}}))}))}((function(e,n){var t=n.document,r=t.body;r.style.fontSize="48px";var o=t.createElement("div"),i={},a={},u=function(e){var n=t.createElement("span"),r=n.style;return r.position="absolute",r.top="0",r.left="0",r.fontFamily=e,n.textContent="mmMwWLliI0O&1",o.appendChild(n),n},c=M.map(u),s=function(){for(var e={},n=function(n){e[n]=M.map((function(e){return function(e,n){return u("'"+e+"',"+n)}(n,e)}))},t=0,r=T;t<r.length;t++){n(r[t])}return e}();r.appendChild(o);for(var l=0;l<M.length;l++)i[M[l]]=c[l].offsetWidth,a[M[l]]=c[l].offsetHeight;return T.filter((function(e){return n=s[e],M.some((function(e,t){return n[t].offsetWidth!==i[e]||n[t].offsetHeight!==a[e]}));var n}))}))},audio:function(){return s(this,void 0,void 0,(function(){var e,n,t,r,o,i,a,u;return l(this,(function(c){switch(c.label){case 0:if(e=window,!(n=e.OfflineAudioContext||e.webkitOfflineAudioContext))return[2,-2];if(y()&&!b()&&!function(){var e=window;return g(["DOMRectList"in e,"RTCPeerConnectionIceEvent"in e,"SVGGeometryElement"in e,"ontransitioncancel"in e])>=3}())return[2,-1];t=4500,5e3,r=new n(1,5e3,44100),(o=r.createOscillator()).type="triangle",o.frequency.value=1e4,(i=r.createDynamicsCompressor()).threshold.value=-50,i.knee.value=40,i.ratio.value=12,i.attack.value=0,i.release.value=.25,o.connect(i),i.connect(r.destination),o.start(0),c.label=1;case 1:return c.trys.push([1,3,,4]),[4,S(r)];case 2:return a=c.sent(),[3,4];case 3:if("timeout"===(u=c.sent()).name||"suspended"===u.name)return[2,-3];throw u;case 4:return[2,C(a.getChannelData(0).subarray(t))]}}))}))},pluginsSupport:function(){return void 0!==navigator.plugins},productSub:function(){return navigator.productSub},emptyEvalLength:function(){return eval.toString().length},errorFF:function(){try{throw"a"}catch(e){try{return e.toSource(),!0}catch(n){return!1}}},vendor:function(){return navigator.vendor},chrome:function(){return void 0!==window.chrome},cookiesEnabled:function(){var e=document;try{e.cookie="cookietest=1; SameSite=Strict;";var n=-1!==e.cookie.indexOf("cookietest=");return e.cookie="cookietest=1; SameSite=Strict; expires=Thu, 01-Jan-1970 00:00:01 GMT",n}catch(t){return!1}}};function x(e,n,t){return s(this,void 0,void 0,(function(){var r,o,i,a,u,s,f,d,v;return l(this,(function(l){switch(l.label){case 0:r=Date.now(),o={},i=0,a=Object.keys(e),l.label=1;case 1:if(!(i<a.length))return[3,7];if(u=a[i],function(e,n){for(var t=0,r=e.length;t<r;++t)if(e[t]===n)return!0;return!1}(t,u))return[3,6];s=void 0,l.label=2;case 2:return l.trys.push([2,4,,5]),v={},[4,e[u](n)];case 3:return v.value=l.sent(),s=v,[3,5];case 4:return f=l.sent(),s=f&&"object"==typeof f&&"message"in f?{error:f}:{error:{message:f}},[3,5];case 5:d=Date.now(),o[u]=c(c({},s),{duration:d-r}),r=d,l.label=6;case 6:return i++,[3,1];case 7:return[2,o]}}))}))}function O(e){return JSON.stringify(e,(function(e,n){return n instanceof Error?c({name:(t=n).name,message:t.message,stack:null===(r=t.stack)||void 0===r?void 0:r.split("\n")},t):n;var t,r}),2)}function E(e){return u(function(e){for(var n="",t=0,r=Object.keys(e);t<r.length;t++){var o=r[t],i=e[o],a=i.error?"error":JSON.stringify(i.value);n+=(n?"|":"")+o.replace(/([:|\\])/g,"\\$1")+":"+a}return n}(e))}var I=function(){function e(){}return e.prototype.get=function(e){return void 0===e&&(e={}),s(this,void 0,void 0,(function(){var n,t;return l(this,(function(r){switch(r.label){case 0:return[4,x(P,void 0,[])];case 1:return n=r.sent(),t=function(e){var n;return{components:e,get visitorId(){return void 0===n&&(n=E(this.components)),n},set visitorId(e){n=e},version:"3.0.7"}}(n),e.debug&&console.log("Copy the text below to get the debug data:\n\n```\nversion: "+t.version+"\nuserAgent: "+navigator.userAgent+"\ngetOptions: "+JSON.stringify(e,void 0,2)+"\nvisitorId: "+t.visitorId+"\ncomponents: "+O(n)+"\n```"),[2,t]}}))}))},e}();function D(e){var n=(void 0===e?{}:e).delayFallback,t=void 0===n?50:n;return s(this,void 0,void 0,(function(){return l(this,(function(e){switch(e.label){case 0:return[4,d(t,2*t)];case 1:return e.sent(),[2,new I]}}))}))}var R={load:D,hashComponents:E,componentsToDebugString:O},L=u;return e.componentsToDebugString=O,e.default=R,e.getComponents=x,e.hashComponents=E,e.isChromium=w,e.isDesktopSafari=b,e.isEdgeHTML=m,e.isGecko=function(){var e,n,t=window;return g(["buildID"in navigator,"MozAppearance"in(null!==(n=null===(e=document.documentElement)||void 0===e?void 0:e.style)&&void 0!==n?n:{}),"MediaRecorderErrorEvent"in t,"mozInnerScreenX"in t,"CSSMozDocumentRule"in t,"CanvasCaptureMediaStream"in t])>=4},e.isTrident=p,e.isWebKit=y,e.load=D,e.murmurX64Hash128=L,e}({});

/*!
 * pixi.js - v6.1.3
 * Compiled Mon, 13 Sep 2021 15:29:31 UTC
 *
 * pixi.js is licensed under the MIT License.
 * http://www.opensource.org/licenses/mit-license
 */
var PIXI=function(t){"use strict";var e=setTimeout;function r(t){return Boolean(t&&void 0!==t.length)}function i(){}function n(t){if(!(this instanceof n))throw new TypeError("Promises must be constructed via new");if("function"!=typeof t)throw new TypeError("not a function");this._state=0,this._handled=!1,this._value=void 0,this._deferreds=[],l(t,this)}function o(t,e){for(;3===t._state;)t=t._value;0!==t._state?(t._handled=!0,n._immediateFn(function(){var r=1===t._state?e.onFulfilled:e.onRejected;if(null!==r){var i;try{i=r(t._value)}catch(t){return void a(e.promise,t)}s(e.promise,i)}else(1===t._state?s:a)(e.promise,t._value)})):t._deferreds.push(e)}function s(t,e){try{if(e===t)throw new TypeError("A promise cannot be resolved with itself.");if(e&&("object"==typeof e||"function"==typeof e)){var r=e.then;if(e instanceof n)return t._state=3,t._value=e,void h(t);if("function"==typeof r)return void l((i=r,o=e,function(){i.apply(o,arguments)}),t)}t._state=1,t._value=e,h(t)}catch(e){a(t,e)}var i,o}function a(t,e){t._state=2,t._value=e,h(t)}function h(t){2===t._state&&0===t._deferreds.length&&n._immediateFn(function(){t._handled||n._unhandledRejectionFn(t._value)});for(var e=0,r=t._deferreds.length;e<r;e++)o(t,t._deferreds[e]);t._deferreds=null}function u(t,e,r){this.onFulfilled="function"==typeof t?t:null,this.onRejected="function"==typeof e?e:null,this.promise=r}function l(t,e){var r=!1;try{t(function(t){r||(r=!0,s(e,t))},function(t){r||(r=!0,a(e,t))})}catch(t){if(r)return;r=!0,a(e,t)}}n.prototype.catch=function(t){return this.then(null,t)},n.prototype.then=function(t,e){var r=new this.constructor(i);return o(this,new u(t,e,r)),r},n.prototype.finally=function(t){var e=this.constructor;return this.then(function(r){return e.resolve(t()).then(function(){return r})},function(r){return e.resolve(t()).then(function(){return e.reject(r)})})},n.all=function(t){return new n(function(e,i){if(!r(t))return i(new TypeError("Promise.all accepts an array"));var n=Array.prototype.slice.call(t);if(0===n.length)return e([]);var o=n.length;function s(t,r){try{if(r&&("object"==typeof r||"function"==typeof r)){var a=r.then;if("function"==typeof a)return void a.call(r,function(e){s(t,e)},i)}n[t]=r,0==--o&&e(n)}catch(t){i(t)}}for(var a=0;a<n.length;a++)s(a,n[a])})},n.allSettled=function(t){return new this(function(e,r){if(!t||void 0===t.length)return r(new TypeError(typeof t+" "+t+" is not iterable(cannot read property Symbol(Symbol.iterator))"));var i=Array.prototype.slice.call(t);if(0===i.length)return e([]);var n=i.length;function o(t,r){if(r&&("object"==typeof r||"function"==typeof r)){var s=r.then;if("function"==typeof s)return void s.call(r,function(e){o(t,e)},function(r){i[t]={status:"rejected",reason:r},0==--n&&e(i)})}i[t]={status:"fulfilled",value:r},0==--n&&e(i)}for(var s=0;s<i.length;s++)o(s,i[s])})},n.resolve=function(t){return t&&"object"==typeof t&&t.constructor===n?t:new n(function(e){e(t)})},n.reject=function(t){return new n(function(e,r){r(t)})},n.race=function(t){return new n(function(e,i){if(!r(t))return i(new TypeError("Promise.race accepts an array"));for(var o=0,s=t.length;o<s;o++)n.resolve(t[o]).then(e,i)})},n._immediateFn="function"==typeof setImmediate&&function(t){setImmediate(t)}||function(t){e(t,0)},n._unhandledRejectionFn=function(t){"undefined"!=typeof console&&console&&console.warn("Possible Unhandled Promise Rejection:",t)};var c=Object.getOwnPropertySymbols,d=Object.prototype.hasOwnProperty,f=Object.prototype.propertyIsEnumerable;var p=function(){try{if(!Object.assign)return!1;var t=new String("abc");if(t[5]="de","5"===Object.getOwnPropertyNames(t)[0])return!1;for(var e={},r=0;r<10;r++)e["_"+String.fromCharCode(r)]=r;if("0123456789"!==Object.getOwnPropertyNames(e).map(function(t){return e[t]}).join(""))return!1;var i={};return"abcdefghijklmnopqrst".split("").forEach(function(t){i[t]=t}),"abcdefghijklmnopqrst"===Object.keys(Object.assign({},i)).join("")}catch(t){return!1}}()?Object.assign:function(t,e){for(var r,i,n=arguments,o=function(t){if(null==t)throw new TypeError("Object.assign cannot be called with null or undefined");return Object(t)}(t),s=1;s<arguments.length;s++){for(var a in r=Object(n[s]))d.call(r,a)&&(o[a]=r[a]);if(c){i=c(r);for(var h=0;h<i.length;h++)f.call(r,i[h])&&(o[i[h]]=r[i[h]])}}return o};if(self.Promise||(self.Promise=n),Object.assign||(Object.assign=p),Date.now&&Date.prototype.getTime||(Date.now=function(){return(new Date).getTime()}),!self.performance||!self.performance.now){var _=Date.now();self.performance||(self.performance={}),self.performance.now=function(){return Date.now()-_}}for(var m=Date.now(),v=["ms","moz","webkit","o"],y=0;y<v.length&&!self.requestAnimationFrame;++y){var E=v[y];self.requestAnimationFrame=self[E+"RequestAnimationFrame"],self.cancelAnimationFrame=self[E+"CancelAnimationFrame"]||self[E+"CancelRequestAnimationFrame"]}self.requestAnimationFrame||(self.requestAnimationFrame=function(t){if("function"!=typeof t)throw new TypeError(t+"is not a function");var e=Date.now(),r=16+m-e;return r<0&&(r=0),m=e,self.setTimeout(function(){m=Date.now(),t(performance.now())},r)}),self.cancelAnimationFrame||(self.cancelAnimationFrame=function(t){return clearTimeout(t)}),Math.sign||(Math.sign=function(t){return 0===(t=Number(t))||isNaN(t)?t:t>0?1:-1}),Number.isInteger||(Number.isInteger=function(t){return"number"==typeof t&&isFinite(t)&&Math.floor(t)===t}),self.ArrayBuffer||(self.ArrayBuffer=Array),self.Float32Array||(self.Float32Array=Array),self.Uint32Array||(self.Uint32Array=Array),self.Uint16Array||(self.Uint16Array=Array),self.Uint8Array||(self.Uint8Array=Array),self.Int32Array||(self.Int32Array=Array);var g=/iPhone/i,T=/iPod/i,b=/iPad/i,R=/\biOS-universal(?:.+)Mac\b/i,x=/\bAndroid(?:.+)Mobile\b/i,A=/Android/i,S=/(?:SD4930UR|\bSilk(?:.+)Mobile\b)/i,O=/Silk/i,I=/Windows Phone/i,P=/\bWindows(?:.+)ARM\b/i,M=/BlackBerry/i,D=/BB10/i,N=/Opera Mini/i,w=/\b(CriOS|Chrome)(?:.+)Mobile/i,C=/Mobile(?:.+)Firefox\b/i,L=function(t){return void 0!==t&&"MacIntel"===t.platform&&"number"==typeof t.maxTouchPoints&&t.maxTouchPoints>1&&"undefined"==typeof MSStream};var F,U,B,G,X,k,H,Y,j,V,W,z,q,K,Z,Q,J,$,tt,et=function(t){var e={userAgent:"",platform:"",maxTouchPoints:0};t||"undefined"==typeof navigator?"string"==typeof t?e.userAgent=t:t&&t.userAgent&&(e={userAgent:t.userAgent,platform:t.platform,maxTouchPoints:t.maxTouchPoints||0}):e={userAgent:navigator.userAgent,platform:navigator.platform,maxTouchPoints:navigator.maxTouchPoints||0};var r=e.userAgent,i=r.split("[FBAN");void 0!==i[1]&&(r=i[0]),void 0!==(i=r.split("Twitter"))[1]&&(r=i[0]);var n=function(t){return function(e){return e.test(t)}}(r),o={apple:{phone:n(g)&&!n(I),ipod:n(T),tablet:!n(g)&&(n(b)||L(e))&&!n(I),universal:n(R),device:(n(g)||n(T)||n(b)||n(R)||L(e))&&!n(I)},amazon:{phone:n(S),tablet:!n(S)&&n(O),device:n(S)||n(O)},android:{phone:!n(I)&&n(S)||!n(I)&&n(x),tablet:!n(I)&&!n(S)&&!n(x)&&(n(O)||n(A)),device:!n(I)&&(n(S)||n(O)||n(x)||n(A))||n(/\bokhttp\b/i)},windows:{phone:n(I),tablet:n(P),device:n(I)||n(P)},other:{blackberry:n(M),blackberry10:n(D),opera:n(N),firefox:n(C),chrome:n(w),device:n(M)||n(D)||n(N)||n(C)||n(w)},any:!1,phone:!1,tablet:!1};return o.any=o.apple.device||o.android.device||o.windows.device||o.other.device,o.phone=o.apple.phone||o.android.phone||o.windows.phone,o.tablet=o.apple.tablet||o.android.tablet||o.windows.tablet,o}(self.navigator);!function(t){t[t.WEBGL_LEGACY=0]="WEBGL_LEGACY",t[t.WEBGL=1]="WEBGL",t[t.WEBGL2=2]="WEBGL2"}(F||(F={})),function(t){t[t.UNKNOWN=0]="UNKNOWN",t[t.WEBGL=1]="WEBGL",t[t.CANVAS=2]="CANVAS"}(U||(U={})),function(t){t[t.COLOR=16384]="COLOR",t[t.DEPTH=256]="DEPTH",t[t.STENCIL=1024]="STENCIL"}(B||(B={})),function(t){t[t.NORMAL=0]="NORMAL",t[t.ADD=1]="ADD",t[t.MULTIPLY=2]="MULTIPLY",t[t.SCREEN=3]="SCREEN",t[t.OVERLAY=4]="OVERLAY",t[t.DARKEN=5]="DARKEN",t[t.LIGHTEN=6]="LIGHTEN",t[t.COLOR_DODGE=7]="COLOR_DODGE",t[t.COLOR_BURN=8]="COLOR_BURN",t[t.HARD_LIGHT=9]="HARD_LIGHT",t[t.SOFT_LIGHT=10]="SOFT_LIGHT",t[t.DIFFERENCE=11]="DIFFERENCE",t[t.EXCLUSION=12]="EXCLUSION",t[t.HUE=13]="HUE",t[t.SATURATION=14]="SATURATION",t[t.COLOR=15]="COLOR",t[t.LUMINOSITY=16]="LUMINOSITY",t[t.NORMAL_NPM=17]="NORMAL_NPM",t[t.ADD_NPM=18]="ADD_NPM",t[t.SCREEN_NPM=19]="SCREEN_NPM",t[t.NONE=20]="NONE",t[t.SRC_OVER=0]="SRC_OVER",t[t.SRC_IN=21]="SRC_IN",t[t.SRC_OUT=22]="SRC_OUT",t[t.SRC_ATOP=23]="SRC_ATOP",t[t.DST_OVER=24]="DST_OVER",t[t.DST_IN=25]="DST_IN",t[t.DST_OUT=26]="DST_OUT",t[t.DST_ATOP=27]="DST_ATOP",t[t.ERASE=26]="ERASE",t[t.SUBTRACT=28]="SUBTRACT",t[t.XOR=29]="XOR"}(G||(G={})),function(t){t[t.POINTS=0]="POINTS",t[t.LINES=1]="LINES",t[t.LINE_LOOP=2]="LINE_LOOP",t[t.LINE_STRIP=3]="LINE_STRIP",t[t.TRIANGLES=4]="TRIANGLES",t[t.TRIANGLE_STRIP=5]="TRIANGLE_STRIP",t[t.TRIANGLE_FAN=6]="TRIANGLE_FAN"}(X||(X={})),function(t){t[t.RGBA=6408]="RGBA",t[t.RGB=6407]="RGB",t[t.RG=33319]="RG",t[t.RED=6403]="RED",t[t.RGBA_INTEGER=36249]="RGBA_INTEGER",t[t.RGB_INTEGER=36248]="RGB_INTEGER",t[t.RG_INTEGER=33320]="RG_INTEGER",t[t.RED_INTEGER=36244]="RED_INTEGER",t[t.ALPHA=6406]="ALPHA",t[t.LUMINANCE=6409]="LUMINANCE",t[t.LUMINANCE_ALPHA=6410]="LUMINANCE_ALPHA",t[t.DEPTH_COMPONENT=6402]="DEPTH_COMPONENT",t[t.DEPTH_STENCIL=34041]="DEPTH_STENCIL"}(k||(k={})),function(t){t[t.TEXTURE_2D=3553]="TEXTURE_2D",t[t.TEXTURE_CUBE_MAP=34067]="TEXTURE_CUBE_MAP",t[t.TEXTURE_2D_ARRAY=35866]="TEXTURE_2D_ARRAY",t[t.TEXTURE_CUBE_MAP_POSITIVE_X=34069]="TEXTURE_CUBE_MAP_POSITIVE_X",t[t.TEXTURE_CUBE_MAP_NEGATIVE_X=34070]="TEXTURE_CUBE_MAP_NEGATIVE_X",t[t.TEXTURE_CUBE_MAP_POSITIVE_Y=34071]="TEXTURE_CUBE_MAP_POSITIVE_Y",t[t.TEXTURE_CUBE_MAP_NEGATIVE_Y=34072]="TEXTURE_CUBE_MAP_NEGATIVE_Y",t[t.TEXTURE_CUBE_MAP_POSITIVE_Z=34073]="TEXTURE_CUBE_MAP_POSITIVE_Z",t[t.TEXTURE_CUBE_MAP_NEGATIVE_Z=34074]="TEXTURE_CUBE_MAP_NEGATIVE_Z"}(H||(H={})),function(t){t[t.UNSIGNED_BYTE=5121]="UNSIGNED_BYTE",t[t.UNSIGNED_SHORT=5123]="UNSIGNED_SHORT",t[t.UNSIGNED_SHORT_5_6_5=33635]="UNSIGNED_SHORT_5_6_5",t[t.UNSIGNED_SHORT_4_4_4_4=32819]="UNSIGNED_SHORT_4_4_4_4",t[t.UNSIGNED_SHORT_5_5_5_1=32820]="UNSIGNED_SHORT_5_5_5_1",t[t.UNSIGNED_INT=5125]="UNSIGNED_INT",t[t.UNSIGNED_INT_10F_11F_11F_REV=35899]="UNSIGNED_INT_10F_11F_11F_REV",t[t.UNSIGNED_INT_2_10_10_10_REV=33640]="UNSIGNED_INT_2_10_10_10_REV",t[t.UNSIGNED_INT_24_8=34042]="UNSIGNED_INT_24_8",t[t.UNSIGNED_INT_5_9_9_9_REV=35902]="UNSIGNED_INT_5_9_9_9_REV",t[t.BYTE=5120]="BYTE",t[t.SHORT=5122]="SHORT",t[t.INT=5124]="INT",t[t.FLOAT=5126]="FLOAT",t[t.FLOAT_32_UNSIGNED_INT_24_8_REV=36269]="FLOAT_32_UNSIGNED_INT_24_8_REV",t[t.HALF_FLOAT=36193]="HALF_FLOAT"}(Y||(Y={})),function(t){t[t.FLOAT=0]="FLOAT",t[t.INT=1]="INT",t[t.UINT=2]="UINT"}(j||(j={})),function(t){t[t.NEAREST=0]="NEAREST",t[t.LINEAR=1]="LINEAR"}(V||(V={})),function(t){t[t.CLAMP=33071]="CLAMP",t[t.REPEAT=10497]="REPEAT",t[t.MIRRORED_REPEAT=33648]="MIRRORED_REPEAT"}(W||(W={})),function(t){t[t.OFF=0]="OFF",t[t.POW2=1]="POW2",t[t.ON=2]="ON",t[t.ON_MANUAL=3]="ON_MANUAL"}(z||(z={})),function(t){t[t.NPM=0]="NPM",t[t.UNPACK=1]="UNPACK",t[t.PMA=2]="PMA",t[t.NO_PREMULTIPLIED_ALPHA=0]="NO_PREMULTIPLIED_ALPHA",t[t.PREMULTIPLY_ON_UPLOAD=1]="PREMULTIPLY_ON_UPLOAD",t[t.PREMULTIPLY_ALPHA=2]="PREMULTIPLY_ALPHA"}(q||(q={})),function(t){t[t.NO=0]="NO",t[t.YES=1]="YES",t[t.AUTO=2]="AUTO",t[t.BLEND=0]="BLEND",t[t.CLEAR=1]="CLEAR",t[t.BLIT=2]="BLIT"}(K||(K={})),function(t){t[t.AUTO=0]="AUTO",t[t.MANUAL=1]="MANUAL"}(Z||(Z={})),function(t){t.LOW="lowp",t.MEDIUM="mediump",t.HIGH="highp"}(Q||(Q={})),function(t){t[t.NONE=0]="NONE",t[t.SCISSOR=1]="SCISSOR",t[t.STENCIL=2]="STENCIL",t[t.SPRITE=3]="SPRITE"}(J||(J={})),function(t){t[t.NONE=0]="NONE",t[t.LOW=2]="LOW",t[t.MEDIUM=4]="MEDIUM",t[t.HIGH=8]="HIGH"}($||($={})),function(t){t[t.ELEMENT_ARRAY_BUFFER=34963]="ELEMENT_ARRAY_BUFFER",t[t.ARRAY_BUFFER=34962]="ARRAY_BUFFER",t[t.UNIFORM_BUFFER=35345]="UNIFORM_BUFFER"}(tt||(tt={}));var rt={MIPMAP_TEXTURES:z.POW2,ANISOTROPIC_LEVEL:0,RESOLUTION:1,FILTER_RESOLUTION:1,FILTER_MULTISAMPLE:$.NONE,SPRITE_MAX_TEXTURES:function(t){var e,r=!0;(et.tablet||et.phone)&&(et.apple.device&&(e=navigator.userAgent.match(/OS (\d+)_(\d+)?/))&&parseInt(e[1],10)<11&&(r=!1),et.android.device&&(e=navigator.userAgent.match(/Android\s([0-9.]*)/))&&parseInt(e[1],10)<7&&(r=!1));return r?32:4}(),SPRITE_BATCH_SIZE:4096,RENDER_OPTIONS:{view:null,antialias:!1,autoDensity:!1,backgroundColor:0,backgroundAlpha:1,useContextAlpha:!0,clearBeforeRender:!0,preserveDrawingBuffer:!1,width:800,height:600,legacy:!1},GC_MODE:Z.AUTO,GC_MAX_IDLE:3600,GC_MAX_CHECK_COUNT:600,WRAP_MODE:W.CLAMP,SCALE_MODE:V.LINEAR,PRECISION_VERTEX:Q.HIGH,PRECISION_FRAGMENT:et.apple.device?Q.HIGH:Q.MEDIUM,CAN_UPLOAD_SAME_BUFFER:!et.apple.device,CREATE_IMAGE_BITMAP:!1,ROUND_PIXELS:!1},it="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{};function nt(t,e,r){return t(r={path:e,exports:{},require:function(t,e){return function(){throw new Error("Dynamic requires are not currently supported by @rollup/plugin-commonjs")}(null==e&&r.path)}},r.exports),r.exports}var ot=nt(function(t){var e=Object.prototype.hasOwnProperty,r="~";function i(){}function n(t,e,r){this.fn=t,this.context=e,this.once=r||!1}function o(t,e,i,o,s){if("function"!=typeof i)throw new TypeError("The listener must be a function");var a=new n(i,o||t,s),h=r?r+e:e;return t._events[h]?t._events[h].fn?t._events[h]=[t._events[h],a]:t._events[h].push(a):(t._events[h]=a,t._eventsCount++),t}function s(t,e){0==--t._eventsCount?t._events=new i:delete t._events[e]}function a(){this._events=new i,this._eventsCount=0}Object.create&&(i.prototype=Object.create(null),(new i).__proto__||(r=!1)),a.prototype.eventNames=function(){var t,i,n=[];if(0===this._eventsCount)return n;for(i in t=this._events)e.call(t,i)&&n.push(r?i.slice(1):i);return Object.getOwnPropertySymbols?n.concat(Object.getOwnPropertySymbols(t)):n},a.prototype.listeners=function(t){var e=r?r+t:t,i=this._events[e];if(!i)return[];if(i.fn)return[i.fn];for(var n=0,o=i.length,s=new Array(o);n<o;n++)s[n]=i[n].fn;return s},a.prototype.listenerCount=function(t){var e=r?r+t:t,i=this._events[e];return i?i.fn?1:i.length:0},a.prototype.emit=function(t,e,i,n,o,s){var a=arguments,h=r?r+t:t;if(!this._events[h])return!1;var u,l,c=this._events[h],d=arguments.length;if(c.fn){switch(c.once&&this.removeListener(t,c.fn,void 0,!0),d){case 1:return c.fn.call(c.context),!0;case 2:return c.fn.call(c.context,e),!0;case 3:return c.fn.call(c.context,e,i),!0;case 4:return c.fn.call(c.context,e,i,n),!0;case 5:return c.fn.call(c.context,e,i,n,o),!0;case 6:return c.fn.call(c.context,e,i,n,o,s),!0}for(l=1,u=new Array(d-1);l<d;l++)u[l-1]=a[l];c.fn.apply(c.context,u)}else{var f,p=c.length;for(l=0;l<p;l++)switch(c[l].once&&this.removeListener(t,c[l].fn,void 0,!0),d){case 1:c[l].fn.call(c[l].context);break;case 2:c[l].fn.call(c[l].context,e);break;case 3:c[l].fn.call(c[l].context,e,i);break;case 4:c[l].fn.call(c[l].context,e,i,n);break;default:if(!u)for(f=1,u=new Array(d-1);f<d;f++)u[f-1]=a[f];c[l].fn.apply(c[l].context,u)}}return!0},a.prototype.on=function(t,e,r){return o(this,t,e,r,!1)},a.prototype.once=function(t,e,r){return o(this,t,e,r,!0)},a.prototype.removeListener=function(t,e,i,n){var o=r?r+t:t;if(!this._events[o])return this;if(!e)return s(this,o),this;var a=this._events[o];if(a.fn)a.fn!==e||n&&!a.once||i&&a.context!==i||s(this,o);else{for(var h=0,u=[],l=a.length;h<l;h++)(a[h].fn!==e||n&&!a[h].once||i&&a[h].context!==i)&&u.push(a[h]);u.length?this._events[o]=1===u.length?u[0]:u:s(this,o)}return this},a.prototype.removeAllListeners=function(t){var e;return t?(e=r?r+t:t,this._events[e]&&s(this,e)):(this._events=new i,this._eventsCount=0),this},a.prototype.off=a.prototype.removeListener,a.prototype.addListener=a.prototype.on,a.prefixed=r,a.EventEmitter=a,t.exports=a}),st=ht,at=ht;function ht(t,e,r){r=r||2;var i,n,o,s,a,h,u,l=e&&e.length,c=l?e[0]*r:t.length,d=ut(t,0,c,r,!0),f=[];if(!d||d.next===d.prev)return f;if(l&&(d=function(t,e,r,i){var n,o,s,a,h,u=[];for(n=0,o=e.length;n<o;n++)s=e[n]*i,a=n<o-1?e[n+1]*i:t.length,(h=ut(t,s,a,i,!1))===h.next&&(h.steiner=!0),u.push(gt(h));for(u.sort(mt),n=0;n<u.length;n++)vt(u[n],r),r=lt(r,r.next);return r}(t,e,d,r)),t.length>80*r){i=o=t[0],n=s=t[1];for(var p=r;p<c;p+=r)(a=t[p])<i&&(i=a),(h=t[p+1])<n&&(n=h),a>o&&(o=a),h>s&&(s=h);u=0!==(u=Math.max(o-i,s-n))?1/u:0}return ct(d,f,r,i,n,u),f}function ut(t,e,r,i,n){var o,s;if(n===wt(t,e,r,i)>0)for(o=e;o<r;o+=i)s=Mt(o,t[o],t[o+1],s);else for(o=r-i;o>=e;o-=i)s=Mt(o,t[o],t[o+1],s);return s&&xt(s,s.next)&&(Dt(s),s=s.next),s}function lt(t,e){if(!t)return t;e||(e=t);var r,i=t;do{if(r=!1,i.steiner||!xt(i,i.next)&&0!==Rt(i.prev,i,i.next))i=i.next;else{if(Dt(i),(i=e=i.prev)===i.next)break;r=!0}}while(r||i!==e);return e}function ct(t,e,r,i,n,o,s){if(t){!s&&o&&function(t,e,r,i){var n=t;do{null===n.z&&(n.z=Et(n.x,n.y,e,r,i)),n.prevZ=n.prev,n.nextZ=n.next,n=n.next}while(n!==t);n.prevZ.nextZ=null,n.prevZ=null,function(t){var e,r,i,n,o,s,a,h,u=1;do{for(r=t,t=null,o=null,s=0;r;){for(s++,i=r,a=0,e=0;e<u&&(a++,i=i.nextZ);e++);for(h=u;a>0||h>0&&i;)0!==a&&(0===h||!i||r.z<=i.z)?(n=r,r=r.nextZ,a--):(n=i,i=i.nextZ,h--),o?o.nextZ=n:t=n,n.prevZ=o,o=n;r=i}o.nextZ=null,u*=2}while(s>1)}(n)}(t,i,n,o);for(var a,h,u=t;t.prev!==t.next;)if(a=t.prev,h=t.next,o?ft(t,i,n,o):dt(t))e.push(a.i/r),e.push(t.i/r),e.push(h.i/r),Dt(t),t=h.next,u=h.next;else if((t=h)===u){s?1===s?ct(t=pt(lt(t),e,r),e,r,i,n,o,2):2===s&&_t(t,e,r,i,n,o):ct(lt(t),e,r,i,n,o,1);break}}}function dt(t){var e=t.prev,r=t,i=t.next;if(Rt(e,r,i)>=0)return!1;for(var n=t.next.next;n!==t.prev;){if(Tt(e.x,e.y,r.x,r.y,i.x,i.y,n.x,n.y)&&Rt(n.prev,n,n.next)>=0)return!1;n=n.next}return!0}function ft(t,e,r,i){var n=t.prev,o=t,s=t.next;if(Rt(n,o,s)>=0)return!1;for(var a=n.x<o.x?n.x<s.x?n.x:s.x:o.x<s.x?o.x:s.x,h=n.y<o.y?n.y<s.y?n.y:s.y:o.y<s.y?o.y:s.y,u=n.x>o.x?n.x>s.x?n.x:s.x:o.x>s.x?o.x:s.x,l=n.y>o.y?n.y>s.y?n.y:s.y:o.y>s.y?o.y:s.y,c=Et(a,h,e,r,i),d=Et(u,l,e,r,i),f=t.prevZ,p=t.nextZ;f&&f.z>=c&&p&&p.z<=d;){if(f!==t.prev&&f!==t.next&&Tt(n.x,n.y,o.x,o.y,s.x,s.y,f.x,f.y)&&Rt(f.prev,f,f.next)>=0)return!1;if(f=f.prevZ,p!==t.prev&&p!==t.next&&Tt(n.x,n.y,o.x,o.y,s.x,s.y,p.x,p.y)&&Rt(p.prev,p,p.next)>=0)return!1;p=p.nextZ}for(;f&&f.z>=c;){if(f!==t.prev&&f!==t.next&&Tt(n.x,n.y,o.x,o.y,s.x,s.y,f.x,f.y)&&Rt(f.prev,f,f.next)>=0)return!1;f=f.prevZ}for(;p&&p.z<=d;){if(p!==t.prev&&p!==t.next&&Tt(n.x,n.y,o.x,o.y,s.x,s.y,p.x,p.y)&&Rt(p.prev,p,p.next)>=0)return!1;p=p.nextZ}return!0}function pt(t,e,r){var i=t;do{var n=i.prev,o=i.next.next;!xt(n,o)&&At(n,i,i.next,o)&&It(n,o)&&It(o,n)&&(e.push(n.i/r),e.push(i.i/r),e.push(o.i/r),Dt(i),Dt(i.next),i=t=o),i=i.next}while(i!==t);return lt(i)}function _t(t,e,r,i,n,o){var s=t;do{for(var a=s.next.next;a!==s.prev;){if(s.i!==a.i&&bt(s,a)){var h=Pt(s,a);return s=lt(s,s.next),h=lt(h,h.next),ct(s,e,r,i,n,o),void ct(h,e,r,i,n,o)}a=a.next}s=s.next}while(s!==t)}function mt(t,e){return t.x-e.x}function vt(t,e){if(e=function(t,e){var r,i=e,n=t.x,o=t.y,s=-1/0;do{if(o<=i.y&&o>=i.next.y&&i.next.y!==i.y){var a=i.x+(o-i.y)*(i.next.x-i.x)/(i.next.y-i.y);if(a<=n&&a>s){if(s=a,a===n){if(o===i.y)return i;if(o===i.next.y)return i.next}r=i.x<i.next.x?i:i.next}}i=i.next}while(i!==e);if(!r)return null;if(n===s)return r;var h,u=r,l=r.x,c=r.y,d=1/0;i=r;do{n>=i.x&&i.x>=l&&n!==i.x&&Tt(o<c?n:s,o,l,c,o<c?s:n,o,i.x,i.y)&&(h=Math.abs(o-i.y)/(n-i.x),It(i,t)&&(h<d||h===d&&(i.x>r.x||i.x===r.x&&yt(r,i)))&&(r=i,d=h)),i=i.next}while(i!==u);return r}(t,e)){var r=Pt(e,t);lt(e,e.next),lt(r,r.next)}}function yt(t,e){return Rt(t.prev,t,e.prev)<0&&Rt(e.next,t,t.next)<0}function Et(t,e,r,i,n){return(t=1431655765&((t=858993459&((t=252645135&((t=16711935&((t=32767*(t-r)*n)|t<<8))|t<<4))|t<<2))|t<<1))|(e=1431655765&((e=858993459&((e=252645135&((e=16711935&((e=32767*(e-i)*n)|e<<8))|e<<4))|e<<2))|e<<1))<<1}function gt(t){var e=t,r=t;do{(e.x<r.x||e.x===r.x&&e.y<r.y)&&(r=e),e=e.next}while(e!==t);return r}function Tt(t,e,r,i,n,o,s,a){return(n-s)*(e-a)-(t-s)*(o-a)>=0&&(t-s)*(i-a)-(r-s)*(e-a)>=0&&(r-s)*(o-a)-(n-s)*(i-a)>=0}function bt(t,e){return t.next.i!==e.i&&t.prev.i!==e.i&&!function(t,e){var r=t;do{if(r.i!==t.i&&r.next.i!==t.i&&r.i!==e.i&&r.next.i!==e.i&&At(r,r.next,t,e))return!0;r=r.next}while(r!==t);return!1}(t,e)&&(It(t,e)&&It(e,t)&&function(t,e){var r=t,i=!1,n=(t.x+e.x)/2,o=(t.y+e.y)/2;do{r.y>o!=r.next.y>o&&r.next.y!==r.y&&n<(r.next.x-r.x)*(o-r.y)/(r.next.y-r.y)+r.x&&(i=!i),r=r.next}while(r!==t);return i}(t,e)&&(Rt(t.prev,t,e.prev)||Rt(t,e.prev,e))||xt(t,e)&&Rt(t.prev,t,t.next)>0&&Rt(e.prev,e,e.next)>0)}function Rt(t,e,r){return(e.y-t.y)*(r.x-e.x)-(e.x-t.x)*(r.y-e.y)}function xt(t,e){return t.x===e.x&&t.y===e.y}function At(t,e,r,i){var n=Ot(Rt(t,e,r)),o=Ot(Rt(t,e,i)),s=Ot(Rt(r,i,t)),a=Ot(Rt(r,i,e));return n!==o&&s!==a||(!(0!==n||!St(t,r,e))||(!(0!==o||!St(t,i,e))||(!(0!==s||!St(r,t,i))||!(0!==a||!St(r,e,i)))))}function St(t,e,r){return e.x<=Math.max(t.x,r.x)&&e.x>=Math.min(t.x,r.x)&&e.y<=Math.max(t.y,r.y)&&e.y>=Math.min(t.y,r.y)}function Ot(t){return t>0?1:t<0?-1:0}function It(t,e){return Rt(t.prev,t,t.next)<0?Rt(t,e,t.next)>=0&&Rt(t,t.prev,e)>=0:Rt(t,e,t.prev)<0||Rt(t,t.next,e)<0}function Pt(t,e){var r=new Nt(t.i,t.x,t.y),i=new Nt(e.i,e.x,e.y),n=t.next,o=e.prev;return t.next=e,e.prev=t,r.next=n,n.prev=r,i.next=r,r.prev=i,o.next=i,i.prev=o,i}function Mt(t,e,r,i){var n=new Nt(t,e,r);return i?(n.next=i.next,n.prev=i,i.next.prev=n,i.next=n):(n.prev=n,n.next=n),n}function Dt(t){t.next.prev=t.prev,t.prev.next=t.next,t.prevZ&&(t.prevZ.nextZ=t.nextZ),t.nextZ&&(t.nextZ.prevZ=t.prevZ)}function Nt(t,e,r){this.i=t,this.x=e,this.y=r,this.prev=null,this.next=null,this.z=null,this.prevZ=null,this.nextZ=null,this.steiner=!1}function wt(t,e,r,i){for(var n=0,o=e,s=r-i;o<r;o+=i)n+=(t[s]-t[o])*(t[o+1]+t[s+1]),s=o;return n}ht.deviation=function(t,e,r,i){var n=e&&e.length,o=n?e[0]*r:t.length,s=Math.abs(wt(t,0,o,r));if(n)for(var a=0,h=e.length;a<h;a++){var u=e[a]*r,l=a<h-1?e[a+1]*r:t.length;s-=Math.abs(wt(t,u,l,r))}var c=0;for(a=0;a<i.length;a+=3){var d=i[a]*r,f=i[a+1]*r,p=i[a+2]*r;c+=Math.abs((t[d]-t[p])*(t[f+1]-t[d+1])-(t[d]-t[f])*(t[p+1]-t[d+1]))}return 0===s&&0===c?0:Math.abs((c-s)/s)},ht.flatten=function(t){for(var e=t[0][0].length,r={vertices:[],holes:[],dimensions:e},i=0,n=0;n<t.length;n++){for(var o=0;o<t[n].length;o++)for(var s=0;s<e;s++)r.vertices.push(t[n][o][s]);n>0&&(i+=t[n-1].length,r.holes.push(i))}return r},st.default=at;var Ct=nt(function(t,e){!function(r){var i=e&&!e.nodeType&&e,n=t&&!t.nodeType&&t,o="object"==typeof it&&it;o.global!==o&&o.window!==o&&o.self!==o||(r=o);var s,a,h=2147483647,u=36,l=1,c=26,d=38,f=700,p=72,_=128,m="-",v=/^xn--/,y=/[^\x20-\x7E]/,E=/[\x2E\u3002\uFF0E\uFF61]/g,g={overflow:"Overflow: input needs wider integers to process","not-basic":"Illegal input >= 0x80 (not a basic code point)","invalid-input":"Invalid input"},T=u-l,b=Math.floor,R=String.fromCharCode;function x(t){throw RangeError(g[t])}function A(t,e){for(var r=t.length,i=[];r--;)i[r]=e(t[r]);return i}function S(t,e){var r=t.split("@"),i="";return r.length>1&&(i=r[0]+"@",t=r[1]),i+A((t=t.replace(E,".")).split("."),e).join(".")}function O(t){for(var e,r,i=[],n=0,o=t.length;n<o;)(e=t.charCodeAt(n++))>=55296&&e<=56319&&n<o?56320==(64512&(r=t.charCodeAt(n++)))?i.push(((1023&e)<<10)+(1023&r)+65536):(i.push(e),n--):i.push(e);return i}function I(t){return A(t,function(t){var e="";return t>65535&&(e+=R((t-=65536)>>>10&1023|55296),t=56320|1023&t),e+=R(t)}).join("")}function P(t,e){return t+22+75*(t<26)-((0!=e)<<5)}function M(t,e,r){var i=0;for(t=r?b(t/f):t>>1,t+=b(t/e);t>T*c>>1;i+=u)t=b(t/T);return b(i+(T+1)*t/(t+d))}function D(t){var e,r,i,n,o,s,a,d,f,v,y,E=[],g=t.length,T=0,R=_,A=p;for((r=t.lastIndexOf(m))<0&&(r=0),i=0;i<r;++i)t.charCodeAt(i)>=128&&x("not-basic"),E.push(t.charCodeAt(i));for(n=r>0?r+1:0;n<g;){for(o=T,s=1,a=u;n>=g&&x("invalid-input"),((d=(y=t.charCodeAt(n++))-48<10?y-22:y-65<26?y-65:y-97<26?y-97:u)>=u||d>b((h-T)/s))&&x("overflow"),T+=d*s,!(d<(f=a<=A?l:a>=A+c?c:a-A));a+=u)s>b(h/(v=u-f))&&x("overflow"),s*=v;A=M(T-o,e=E.length+1,0==o),b(T/e)>h-R&&x("overflow"),R+=b(T/e),T%=e,E.splice(T++,0,R)}return I(E)}function N(t){var e,r,i,n,o,s,a,d,f,v,y,E,g,T,A,S=[];for(E=(t=O(t)).length,e=_,r=0,o=p,s=0;s<E;++s)(y=t[s])<128&&S.push(R(y));for(i=n=S.length,n&&S.push(m);i<E;){for(a=h,s=0;s<E;++s)(y=t[s])>=e&&y<a&&(a=y);for(a-e>b((h-r)/(g=i+1))&&x("overflow"),r+=(a-e)*g,e=a,s=0;s<E;++s)if((y=t[s])<e&&++r>h&&x("overflow"),y==e){for(d=r,f=u;!(d<(v=f<=o?l:f>=o+c?c:f-o));f+=u)A=d-v,T=u-v,S.push(R(P(v+A%T,0))),d=b(A/T);S.push(R(P(d,0))),o=M(r,g,i==n),r=0,++i}++r,++e}return S.join("")}if(s={version:"1.3.2",ucs2:{decode:O,encode:I},decode:D,encode:N,toASCII:function(t){return S(t,function(t){return y.test(t)?"xn--"+N(t):t})},toUnicode:function(t){return S(t,function(t){return v.test(t)?D(t.slice(4).toLowerCase()):t})}},i&&n)if(t.exports==i)n.exports=s;else for(a in s)s.hasOwnProperty(a)&&(i[a]=s[a]);else r.punycode=s}(it)}),Lt={isString:function(t){return"string"==typeof t},isObject:function(t){return"object"==typeof t&&null!==t},isNull:function(t){return null===t},isNullOrUndefined:function(t){return null==t}};function Ft(t,e){return Object.prototype.hasOwnProperty.call(t,e)}var Ut=function(t,e,r,i){e=e||"&",r=r||"=";var n={};if("string"!=typeof t||0===t.length)return n;var o=/\+/g;t=t.split(e);var s=1e3;i&&"number"==typeof i.maxKeys&&(s=i.maxKeys);var a=t.length;s>0&&a>s&&(a=s);for(var h=0;h<a;++h){var u,l,c,d,f=t[h].replace(o,"%20"),p=f.indexOf(r);p>=0?(u=f.substr(0,p),l=f.substr(p+1)):(u=f,l=""),c=decodeURIComponent(u),d=decodeURIComponent(l),Ft(n,c)?Array.isArray(n[c])?n[c].push(d):n[c]=[n[c],d]:n[c]=d}return n},Bt=function(t){switch(typeof t){case"string":return t;case"boolean":return t?"true":"false";case"number":return isFinite(t)?t:"";default:return""}},Gt=function(t,e,r,i){return e=e||"&",r=r||"=",null===t&&(t=void 0),"object"==typeof t?Object.keys(t).map(function(i){var n=encodeURIComponent(Bt(i))+r;return Array.isArray(t[i])?t[i].map(function(t){return n+encodeURIComponent(Bt(t))}).join(e):n+encodeURIComponent(Bt(t[i]))}).join(e):i?encodeURIComponent(Bt(i))+r+encodeURIComponent(Bt(t)):""},Xt=nt(function(t,e){e.decode=e.parse=Ut,e.encode=e.stringify=Gt}),kt=ie,Ht=function(t,e){return ie(t,!1,!0).resolve(e)},Yt=function(t){Lt.isString(t)&&(t=ie(t));if(!(t instanceof jt))return jt.prototype.format.call(t);return t.format()};function jt(){this.protocol=null,this.slashes=null,this.auth=null,this.host=null,this.port=null,this.hostname=null,this.hash=null,this.search=null,this.query=null,this.pathname=null,this.path=null,this.href=null}var Vt=/^([a-z0-9.+-]+:)/i,Wt=/:[0-9]*$/,zt=/^(\/\/?(?!\/)[^\?\s]*)(\?[^\s]*)?$/,qt=["{","}","|","\\","^","`"].concat(["<",">",'"',"`"," ","\r","\n","\t"]),Kt=["'"].concat(qt),Zt=["%","/","?",";","#"].concat(Kt),Qt=["/","?","#"],Jt=/^[+a-z0-9A-Z_-]{0,63}$/,$t=/^([+a-z0-9A-Z_-]{0,63})(.*)$/,te={javascript:!0,"javascript:":!0},ee={javascript:!0,"javascript:":!0},re={http:!0,https:!0,ftp:!0,gopher:!0,file:!0,"http:":!0,"https:":!0,"ftp:":!0,"gopher:":!0,"file:":!0};function ie(t,e,r){if(t&&Lt.isObject(t)&&t instanceof jt)return t;var i=new jt;return i.parse(t,e,r),i}jt.prototype.parse=function(t,e,r){if(!Lt.isString(t))throw new TypeError("Parameter 'url' must be a string, not "+typeof t);var i=t.indexOf("?"),n=-1!==i&&i<t.indexOf("#")?"?":"#",o=t.split(n);o[0]=o[0].replace(/\\/g,"/");var s=t=o.join(n);if(s=s.trim(),!r&&1===t.split("#").length){var a=zt.exec(s);if(a)return this.path=s,this.href=s,this.pathname=a[1],a[2]?(this.search=a[2],this.query=e?Xt.parse(this.search.substr(1)):this.search.substr(1)):e&&(this.search="",this.query={}),this}var h=Vt.exec(s);if(h){var u=(h=h[0]).toLowerCase();this.protocol=u,s=s.substr(h.length)}if(r||h||s.match(/^\/\/[^@\/]+@[^@\/]+/)){var l="//"===s.substr(0,2);!l||h&&ee[h]||(s=s.substr(2),this.slashes=!0)}if(!ee[h]&&(l||h&&!re[h])){for(var c,d,f=-1,p=0;p<Qt.length;p++){-1!==(_=s.indexOf(Qt[p]))&&(-1===f||_<f)&&(f=_)}-1!==(d=-1===f?s.lastIndexOf("@"):s.lastIndexOf("@",f))&&(c=s.slice(0,d),s=s.slice(d+1),this.auth=decodeURIComponent(c)),f=-1;for(p=0;p<Zt.length;p++){var _;-1!==(_=s.indexOf(Zt[p]))&&(-1===f||_<f)&&(f=_)}-1===f&&(f=s.length),this.host=s.slice(0,f),s=s.slice(f),this.parseHost(),this.hostname=this.hostname||"";var m="["===this.hostname[0]&&"]"===this.hostname[this.hostname.length-1];if(!m)for(var v=this.hostname.split(/\./),y=(p=0,v.length);p<y;p++){var E=v[p];if(E&&!E.match(Jt)){for(var g="",T=0,b=E.length;T<b;T++)E.charCodeAt(T)>127?g+="x":g+=E[T];if(!g.match(Jt)){var R=v.slice(0,p),x=v.slice(p+1),A=E.match($t);A&&(R.push(A[1]),x.unshift(A[2])),x.length&&(s="/"+x.join(".")+s),this.hostname=R.join(".");break}}}this.hostname.length>255?this.hostname="":this.hostname=this.hostname.toLowerCase(),m||(this.hostname=Ct.toASCII(this.hostname));var S=this.port?":"+this.port:"",O=this.hostname||"";this.host=O+S,this.href+=this.host,m&&(this.hostname=this.hostname.substr(1,this.hostname.length-2),"/"!==s[0]&&(s="/"+s))}if(!te[u])for(p=0,y=Kt.length;p<y;p++){var I=Kt[p];if(-1!==s.indexOf(I)){var P=encodeURIComponent(I);P===I&&(P=escape(I)),s=s.split(I).join(P)}}var M=s.indexOf("#");-1!==M&&(this.hash=s.substr(M),s=s.slice(0,M));var D=s.indexOf("?");if(-1!==D?(this.search=s.substr(D),this.query=s.substr(D+1),e&&(this.query=Xt.parse(this.query)),s=s.slice(0,D)):e&&(this.search="",this.query={}),s&&(this.pathname=s),re[u]&&this.hostname&&!this.pathname&&(this.pathname="/"),this.pathname||this.search){S=this.pathname||"";var N=this.search||"";this.path=S+N}return this.href=this.format(),this},jt.prototype.format=function(){var t=this.auth||"";t&&(t=(t=encodeURIComponent(t)).replace(/%3A/i,":"),t+="@");var e=this.protocol||"",r=this.pathname||"",i=this.hash||"",n=!1,o="";this.host?n=t+this.host:this.hostname&&(n=t+(-1===this.hostname.indexOf(":")?this.hostname:"["+this.hostname+"]"),this.port&&(n+=":"+this.port)),this.query&&Lt.isObject(this.query)&&Object.keys(this.query).length&&(o=Xt.stringify(this.query));var s=this.search||o&&"?"+o||"";return e&&":"!==e.substr(-1)&&(e+=":"),this.slashes||(!e||re[e])&&!1!==n?(n="//"+(n||""),r&&"/"!==r.charAt(0)&&(r="/"+r)):n||(n=""),i&&"#"!==i.charAt(0)&&(i="#"+i),s&&"?"!==s.charAt(0)&&(s="?"+s),e+n+(r=r.replace(/[?#]/g,function(t){return encodeURIComponent(t)}))+(s=s.replace("#","%23"))+i},jt.prototype.resolve=function(t){return this.resolveObject(ie(t,!1,!0)).format()},jt.prototype.resolveObject=function(t){if(Lt.isString(t)){var e=new jt;e.parse(t,!1,!0),t=e}for(var r=new jt,i=Object.keys(this),n=0;n<i.length;n++){var o=i[n];r[o]=this[o]}if(r.hash=t.hash,""===t.href)return r.href=r.format(),r;if(t.slashes&&!t.protocol){for(var s=Object.keys(t),a=0;a<s.length;a++){var h=s[a];"protocol"!==h&&(r[h]=t[h])}return re[r.protocol]&&r.hostname&&!r.pathname&&(r.path=r.pathname="/"),r.href=r.format(),r}if(t.protocol&&t.protocol!==r.protocol){if(!re[t.protocol]){for(var u=Object.keys(t),l=0;l<u.length;l++){var c=u[l];r[c]=t[c]}return r.href=r.format(),r}if(r.protocol=t.protocol,t.host||ee[t.protocol])r.pathname=t.pathname;else{for(var d=(t.pathname||"").split("/");d.length&&!(t.host=d.shift()););t.host||(t.host=""),t.hostname||(t.hostname=""),""!==d[0]&&d.unshift(""),d.length<2&&d.unshift(""),r.pathname=d.join("/")}if(r.search=t.search,r.query=t.query,r.host=t.host||"",r.auth=t.auth,r.hostname=t.hostname||t.host,r.port=t.port,r.pathname||r.search){var f=r.pathname||"",p=r.search||"";r.path=f+p}return r.slashes=r.slashes||t.slashes,r.href=r.format(),r}var _=r.pathname&&"/"===r.pathname.charAt(0),m=t.host||t.pathname&&"/"===t.pathname.charAt(0),v=m||_||r.host&&t.pathname,y=v,E=r.pathname&&r.pathname.split("/")||[],g=(d=t.pathname&&t.pathname.split("/")||[],r.protocol&&!re[r.protocol]);if(g&&(r.hostname="",r.port=null,r.host&&(""===E[0]?E[0]=r.host:E.unshift(r.host)),r.host="",t.protocol&&(t.hostname=null,t.port=null,t.host&&(""===d[0]?d[0]=t.host:d.unshift(t.host)),t.host=null),v=v&&(""===d[0]||""===E[0])),m)r.host=t.host||""===t.host?t.host:r.host,r.hostname=t.hostname||""===t.hostname?t.hostname:r.hostname,r.search=t.search,r.query=t.query,E=d;else if(d.length)E||(E=[]),E.pop(),E=E.concat(d),r.search=t.search,r.query=t.query;else if(!Lt.isNullOrUndefined(t.search)){if(g)r.hostname=r.host=E.shift(),(A=!!(r.host&&r.host.indexOf("@")>0)&&r.host.split("@"))&&(r.auth=A.shift(),r.host=r.hostname=A.shift());return r.search=t.search,r.query=t.query,Lt.isNull(r.pathname)&&Lt.isNull(r.search)||(r.path=(r.pathname?r.pathname:"")+(r.search?r.search:"")),r.href=r.format(),r}if(!E.length)return r.pathname=null,r.search?r.path="/"+r.search:r.path=null,r.href=r.format(),r;for(var T=E.slice(-1)[0],b=(r.host||t.host||E.length>1)&&("."===T||".."===T)||""===T,R=0,x=E.length;x>=0;x--)"."===(T=E[x])?E.splice(x,1):".."===T?(E.splice(x,1),R++):R&&(E.splice(x,1),R--);if(!v&&!y)for(;R--;R)E.unshift("..");!v||""===E[0]||E[0]&&"/"===E[0].charAt(0)||E.unshift(""),b&&"/"!==E.join("/").substr(-1)&&E.push("");var A,S=""===E[0]||E[0]&&"/"===E[0].charAt(0);g&&(r.hostname=r.host=S?"":E.length?E.shift():"",(A=!!(r.host&&r.host.indexOf("@")>0)&&r.host.split("@"))&&(r.auth=A.shift(),r.host=r.hostname=A.shift()));return(v=v||r.host&&E.length)&&!S&&E.unshift(""),E.length?r.pathname=E.join("/"):(r.pathname=null,r.path=null),Lt.isNull(r.pathname)&&Lt.isNull(r.search)||(r.path=(r.pathname?r.pathname:"")+(r.search?r.search:"")),r.auth=t.auth||r.auth,r.slashes=r.slashes||t.slashes,r.href=r.format(),r},jt.prototype.parseHost=function(){var t=this.host,e=Wt.exec(t);e&&(":"!==(e=e[0])&&(this.port=e.substr(1)),t=t.substr(0,t.length-e.length)),t&&(this.hostname=t)};!function(t){t[t.WEBGL_LEGACY=0]="WEBGL_LEGACY",t[t.WEBGL=1]="WEBGL",t[t.WEBGL2=2]="WEBGL2"}(t.ENV||(t.ENV={})),function(t){t[t.UNKNOWN=0]="UNKNOWN",t[t.WEBGL=1]="WEBGL",t[t.CANVAS=2]="CANVAS"}(t.RENDERER_TYPE||(t.RENDERER_TYPE={})),function(t){t[t.COLOR=16384]="COLOR",t[t.DEPTH=256]="DEPTH",t[t.STENCIL=1024]="STENCIL"}(t.BUFFER_BITS||(t.BUFFER_BITS={})),function(t){t[t.NORMAL=0]="NORMAL",t[t.ADD=1]="ADD",t[t.MULTIPLY=2]="MULTIPLY",t[t.SCREEN=3]="SCREEN",t[t.OVERLAY=4]="OVERLAY",t[t.DARKEN=5]="DARKEN",t[t.LIGHTEN=6]="LIGHTEN",t[t.COLOR_DODGE=7]="COLOR_DODGE",t[t.COLOR_BURN=8]="COLOR_BURN",t[t.HARD_LIGHT=9]="HARD_LIGHT",t[t.SOFT_LIGHT=10]="SOFT_LIGHT",t[t.DIFFERENCE=11]="DIFFERENCE",t[t.EXCLUSION=12]="EXCLUSION",t[t.HUE=13]="HUE",t[t.SATURATION=14]="SATURATION",t[t.COLOR=15]="COLOR",t[t.LUMINOSITY=16]="LUMINOSITY",t[t.NORMAL_NPM=17]="NORMAL_NPM",t[t.ADD_NPM=18]="ADD_NPM",t[t.SCREEN_NPM=19]="SCREEN_NPM",t[t.NONE=20]="NONE",t[t.SRC_OVER=0]="SRC_OVER",t[t.SRC_IN=21]="SRC_IN",t[t.SRC_OUT=22]="SRC_OUT",t[t.SRC_ATOP=23]="SRC_ATOP",t[t.DST_OVER=24]="DST_OVER",t[t.DST_IN=25]="DST_IN",t[t.DST_OUT=26]="DST_OUT",t[t.DST_ATOP=27]="DST_ATOP",t[t.ERASE=26]="ERASE",t[t.SUBTRACT=28]="SUBTRACT",t[t.XOR=29]="XOR"}(t.BLEND_MODES||(t.BLEND_MODES={})),function(t){t[t.POINTS=0]="POINTS",t[t.LINES=1]="LINES",t[t.LINE_LOOP=2]="LINE_LOOP",t[t.LINE_STRIP=3]="LINE_STRIP",t[t.TRIANGLES=4]="TRIANGLES",t[t.TRIANGLE_STRIP=5]="TRIANGLE_STRIP",t[t.TRIANGLE_FAN=6]="TRIANGLE_FAN"}(t.DRAW_MODES||(t.DRAW_MODES={})),function(t){t[t.RGBA=6408]="RGBA",t[t.RGB=6407]="RGB",t[t.RG=33319]="RG",t[t.RED=6403]="RED",t[t.RGBA_INTEGER=36249]="RGBA_INTEGER",t[t.RGB_INTEGER=36248]="RGB_INTEGER",t[t.RG_INTEGER=33320]="RG_INTEGER",t[t.RED_INTEGER=36244]="RED_INTEGER",t[t.ALPHA=6406]="ALPHA",t[t.LUMINANCE=6409]="LUMINANCE",t[t.LUMINANCE_ALPHA=6410]="LUMINANCE_ALPHA",t[t.DEPTH_COMPONENT=6402]="DEPTH_COMPONENT",t[t.DEPTH_STENCIL=34041]="DEPTH_STENCIL"}(t.FORMATS||(t.FORMATS={})),function(t){t[t.TEXTURE_2D=3553]="TEXTURE_2D",t[t.TEXTURE_CUBE_MAP=34067]="TEXTURE_CUBE_MAP",t[t.TEXTURE_2D_ARRAY=35866]="TEXTURE_2D_ARRAY",t[t.TEXTURE_CUBE_MAP_POSITIVE_X=34069]="TEXTURE_CUBE_MAP_POSITIVE_X",t[t.TEXTURE_CUBE_MAP_NEGATIVE_X=34070]="TEXTURE_CUBE_MAP_NEGATIVE_X",t[t.TEXTURE_CUBE_MAP_POSITIVE_Y=34071]="TEXTURE_CUBE_MAP_POSITIVE_Y",t[t.TEXTURE_CUBE_MAP_NEGATIVE_Y=34072]="TEXTURE_CUBE_MAP_NEGATIVE_Y",t[t.TEXTURE_CUBE_MAP_POSITIVE_Z=34073]="TEXTURE_CUBE_MAP_POSITIVE_Z",t[t.TEXTURE_CUBE_MAP_NEGATIVE_Z=34074]="TEXTURE_CUBE_MAP_NEGATIVE_Z"}(t.TARGETS||(t.TARGETS={})),function(t){t[t.UNSIGNED_BYTE=5121]="UNSIGNED_BYTE",t[t.UNSIGNED_SHORT=5123]="UNSIGNED_SHORT",t[t.UNSIGNED_SHORT_5_6_5=33635]="UNSIGNED_SHORT_5_6_5",t[t.UNSIGNED_SHORT_4_4_4_4=32819]="UNSIGNED_SHORT_4_4_4_4",t[t.UNSIGNED_SHORT_5_5_5_1=32820]="UNSIGNED_SHORT_5_5_5_1",t[t.UNSIGNED_INT=5125]="UNSIGNED_INT",t[t.UNSIGNED_INT_10F_11F_11F_REV=35899]="UNSIGNED_INT_10F_11F_11F_REV",t[t.UNSIGNED_INT_2_10_10_10_REV=33640]="UNSIGNED_INT_2_10_10_10_REV",t[t.UNSIGNED_INT_24_8=34042]="UNSIGNED_INT_24_8",t[t.UNSIGNED_INT_5_9_9_9_REV=35902]="UNSIGNED_INT_5_9_9_9_REV",t[t.BYTE=5120]="BYTE",t[t.SHORT=5122]="SHORT",t[t.INT=5124]="INT",t[t.FLOAT=5126]="FLOAT",t[t.FLOAT_32_UNSIGNED_INT_24_8_REV=36269]="FLOAT_32_UNSIGNED_INT_24_8_REV",t[t.HALF_FLOAT=36193]="HALF_FLOAT"}(t.TYPES||(t.TYPES={})),function(t){t[t.FLOAT=0]="FLOAT",t[t.INT=1]="INT",t[t.UINT=2]="UINT"}(t.SAMPLER_TYPES||(t.SAMPLER_TYPES={})),function(t){t[t.NEAREST=0]="NEAREST",t[t.LINEAR=1]="LINEAR"}(t.SCALE_MODES||(t.SCALE_MODES={})),function(t){t[t.CLAMP=33071]="CLAMP",t[t.REPEAT=10497]="REPEAT",t[t.MIRRORED_REPEAT=33648]="MIRRORED_REPEAT"}(t.WRAP_MODES||(t.WRAP_MODES={})),function(t){t[t.OFF=0]="OFF",t[t.POW2=1]="POW2",t[t.ON=2]="ON",t[t.ON_MANUAL=3]="ON_MANUAL"}(t.MIPMAP_MODES||(t.MIPMAP_MODES={})),function(t){t[t.NPM=0]="NPM",t[t.UNPACK=1]="UNPACK",t[t.PMA=2]="PMA",t[t.NO_PREMULTIPLIED_ALPHA=0]="NO_PREMULTIPLIED_ALPHA",t[t.PREMULTIPLY_ON_UPLOAD=1]="PREMULTIPLY_ON_UPLOAD",t[t.PREMULTIPLY_ALPHA=2]="PREMULTIPLY_ALPHA"}(t.ALPHA_MODES||(t.ALPHA_MODES={})),function(t){t[t.NO=0]="NO",t[t.YES=1]="YES",t[t.AUTO=2]="AUTO",t[t.BLEND=0]="BLEND",t[t.CLEAR=1]="CLEAR",t[t.BLIT=2]="BLIT"}(t.CLEAR_MODES||(t.CLEAR_MODES={})),function(t){t[t.AUTO=0]="AUTO",t[t.MANUAL=1]="MANUAL"}(t.GC_MODES||(t.GC_MODES={})),function(t){t.LOW="lowp",t.MEDIUM="mediump",t.HIGH="highp"}(t.PRECISION||(t.PRECISION={})),function(t){t[t.NONE=0]="NONE",t[t.SCISSOR=1]="SCISSOR",t[t.STENCIL=2]="STENCIL",t[t.SPRITE=3]="SPRITE"}(t.MASK_TYPES||(t.MASK_TYPES={})),function(t){t[t.NONE=0]="NONE",t[t.LOW=2]="LOW",t[t.MEDIUM=4]="MEDIUM",t[t.HIGH=8]="HIGH"}(t.MSAA_QUALITY||(t.MSAA_QUALITY={})),function(t){t[t.ELEMENT_ARRAY_BUFFER=34963]="ELEMENT_ARRAY_BUFFER",t[t.ARRAY_BUFFER=34962]="ARRAY_BUFFER",t[t.UNIFORM_BUFFER=35345]="UNIFORM_BUFFER"}(t.BUFFER_TYPE||(t.BUFFER_TYPE={}));var ne={parse:kt,format:Yt,resolve:Ht};rt.RETINA_PREFIX=/@([0-9\.]+)x/,rt.FAIL_IF_MAJOR_PERFORMANCE_CAVEAT=!1;var oe,se=!1,ae="6.1.3";function he(t){var e;if(!se){if(navigator.userAgent.toLowerCase().indexOf("chrome")>-1){var r=["\n %c %c %c PixiJS "+ae+" -  "+t+"   %c  %c  http://www.pixijs.com/  %c %c %c%c \n\n","background: #ff66a5; padding:5px 0;","background: #ff66a5; padding:5px 0;","color: #ff66a5; background: #030307; padding:5px 0;","background: #ff66a5; padding:5px 0;","background: #ffc3dc; padding:5px 0;","background: #ff66a5; padding:5px 0;","color: #ff2424; background: #fff; padding:5px 0;","color: #ff2424; background: #fff; padding:5px 0;","color: #ff2424; background: #fff; padding:5px 0;"];(e=self.console).log.apply(e,r)}else self.console&&self.console.log("PixiJS "+ae+" - "+t+" - http://www.pixijs.com/");se=!0}}function ue(){return void 0===oe&&(oe=function(){var t={stencil:!0,failIfMajorPerformanceCaveat:rt.FAIL_IF_MAJOR_PERFORMANCE_CAVEAT};try{if(!self.WebGLRenderingContext)return!1;var e=document.createElement("canvas"),r=e.getContext("webgl",t)||e.getContext("experimental-webgl",t),i=!(!r||!r.getContextAttributes().stencil);if(r){var n=r.getExtension("WEBGL_lose_context");n&&n.loseContext()}return r=null,i}catch(t){return!1}}()),oe}var le={aliceblue:"#f0f8ff",antiquewhite:"#faebd7",aqua:"#00ffff",aquamarine:"#7fffd4",azure:"#f0ffff",beige:"#f5f5dc",bisque:"#ffe4c4",black:"#000000",blanchedalmond:"#ffebcd",blue:"#0000ff",blueviolet:"#8a2be2",brown:"#a52a2a",burlywood:"#deb887",cadetblue:"#5f9ea0",chartreuse:"#7fff00",chocolate:"#d2691e",coral:"#ff7f50",cornflowerblue:"#6495ed",cornsilk:"#fff8dc",crimson:"#dc143c",cyan:"#00ffff",darkblue:"#00008b",darkcyan:"#008b8b",darkgoldenrod:"#b8860b",darkgray:"#a9a9a9",darkgreen:"#006400",darkgrey:"#a9a9a9",darkkhaki:"#bdb76b",darkmagenta:"#8b008b",darkolivegreen:"#556b2f",darkorange:"#ff8c00",darkorchid:"#9932cc",darkred:"#8b0000",darksalmon:"#e9967a",darkseagreen:"#8fbc8f",darkslateblue:"#483d8b",darkslategray:"#2f4f4f",darkslategrey:"#2f4f4f",darkturquoise:"#00ced1",darkviolet:"#9400d3",deeppink:"#ff1493",deepskyblue:"#00bfff",dimgray:"#696969",dimgrey:"#696969",dodgerblue:"#1e90ff",firebrick:"#b22222",floralwhite:"#fffaf0",forestgreen:"#228b22",fuchsia:"#ff00ff",gainsboro:"#dcdcdc",ghostwhite:"#f8f8ff",goldenrod:"#daa520",gold:"#ffd700",gray:"#808080",green:"#008000",greenyellow:"#adff2f",grey:"#808080",honeydew:"#f0fff0",hotpink:"#ff69b4",indianred:"#cd5c5c",indigo:"#4b0082",ivory:"#fffff0",khaki:"#f0e68c",lavenderblush:"#fff0f5",lavender:"#e6e6fa",lawngreen:"#7cfc00",lemonchiffon:"#fffacd",lightblue:"#add8e6",lightcoral:"#f08080",lightcyan:"#e0ffff",lightgoldenrodyellow:"#fafad2",lightgray:"#d3d3d3",lightgreen:"#90ee90",lightgrey:"#d3d3d3",lightpink:"#ffb6c1",lightsalmon:"#ffa07a",lightseagreen:"#20b2aa",lightskyblue:"#87cefa",lightslategray:"#778899",lightslategrey:"#778899",lightsteelblue:"#b0c4de",lightyellow:"#ffffe0",lime:"#00ff00",limegreen:"#32cd32",linen:"#faf0e6",magenta:"#ff00ff",maroon:"#800000",mediumaquamarine:"#66cdaa",mediumblue:"#0000cd",mediumorchid:"#ba55d3",mediumpurple:"#9370db",mediumseagreen:"#3cb371",mediumslateblue:"#7b68ee",mediumspringgreen:"#00fa9a",mediumturquoise:"#48d1cc",mediumvioletred:"#c71585",midnightblue:"#191970",mintcream:"#f5fffa",mistyrose:"#ffe4e1",moccasin:"#ffe4b5",navajowhite:"#ffdead",navy:"#000080",oldlace:"#fdf5e6",olive:"#808000",olivedrab:"#6b8e23",orange:"#ffa500",orangered:"#ff4500",orchid:"#da70d6",palegoldenrod:"#eee8aa",palegreen:"#98fb98",paleturquoise:"#afeeee",palevioletred:"#db7093",papayawhip:"#ffefd5",peachpuff:"#ffdab9",peru:"#cd853f",pink:"#ffc0cb",plum:"#dda0dd",powderblue:"#b0e0e6",purple:"#800080",rebeccapurple:"#663399",red:"#ff0000",rosybrown:"#bc8f8f",royalblue:"#4169e1",saddlebrown:"#8b4513",salmon:"#fa8072",sandybrown:"#f4a460",seagreen:"#2e8b57",seashell:"#fff5ee",sienna:"#a0522d",silver:"#c0c0c0",skyblue:"#87ceeb",slateblue:"#6a5acd",slategray:"#708090",slategrey:"#708090",snow:"#fffafa",springgreen:"#00ff7f",steelblue:"#4682b4",tan:"#d2b48c",teal:"#008080",thistle:"#d8bfd8",tomato:"#ff6347",turquoise:"#40e0d0",violet:"#ee82ee",wheat:"#f5deb3",white:"#ffffff",whitesmoke:"#f5f5f5",yellow:"#ffff00",yellowgreen:"#9acd32"};function ce(t,e){return void 0===e&&(e=[]),e[0]=(t>>16&255)/255,e[1]=(t>>8&255)/255,e[2]=(255&t)/255,e}function de(t){var e=t.toString(16);return"#"+("000000".substr(0,6-e.length)+e)}function fe(t){return"string"==typeof t&&"#"===(t=le[t.toLowerCase()]||t)[0]&&(t=t.substr(1)),parseInt(t,16)}var pe=function(){for(var e=[],r=[],i=0;i<32;i++)e[i]=i,r[i]=i;e[t.BLEND_MODES.NORMAL_NPM]=t.BLEND_MODES.NORMAL,e[t.BLEND_MODES.ADD_NPM]=t.BLEND_MODES.ADD,e[t.BLEND_MODES.SCREEN_NPM]=t.BLEND_MODES.SCREEN,r[t.BLEND_MODES.NORMAL]=t.BLEND_MODES.NORMAL_NPM,r[t.BLEND_MODES.ADD]=t.BLEND_MODES.ADD_NPM,r[t.BLEND_MODES.SCREEN]=t.BLEND_MODES.SCREEN_NPM;var n=[];return n.push(r),n.push(e),n}();function _e(t,e){return pe[e?1:0][t]}function me(t,e,r,i){return r=r||new Float32Array(4),i||void 0===i?(r[0]=t[0]*e,r[1]=t[1]*e,r[2]=t[2]*e):(r[0]=t[0],r[1]=t[1],r[2]=t[2]),r[3]=e,r}function ve(t,e){if(1===e)return(255*e<<24)+t;if(0===e)return 0;var r=t>>16&255,i=t>>8&255,n=255&t;return(255*e<<24)+((r=r*e+.5|0)<<16)+((i=i*e+.5|0)<<8)+(n*e+.5|0)}function ye(t,e,r,i){return(r=r||new Float32Array(4))[0]=(t>>16&255)/255,r[1]=(t>>8&255)/255,r[2]=(255&t)/255,(i||void 0===i)&&(r[0]*=e,r[1]*=e,r[2]*=e),r[3]=e,r}function Ee(t,e){void 0===e&&(e=null);var r=6*t;if((e=e||new Uint16Array(r)).length!==r)throw new Error("Out buffer length is incorrect, got "+e.length+" and expected "+r);for(var i=0,n=0;i<r;i+=6,n+=4)e[i+0]=n+0,e[i+1]=n+1,e[i+2]=n+2,e[i+3]=n+0,e[i+4]=n+2,e[i+5]=n+3;return e}function ge(t){if(4===t.BYTES_PER_ELEMENT)return t instanceof Float32Array?"Float32Array":t instanceof Uint32Array?"Uint32Array":"Int32Array";if(2===t.BYTES_PER_ELEMENT){if(t instanceof Uint16Array)return"Uint16Array"}else if(1===t.BYTES_PER_ELEMENT&&t instanceof Uint8Array)return"Uint8Array";return null}var Te={Float32Array:Float32Array,Uint32Array:Uint32Array,Int32Array:Int32Array,Uint8Array:Uint8Array};function be(t){return t+=0===t?1:0,--t,t|=t>>>1,t|=t>>>2,t|=t>>>4,t|=t>>>8,1+(t|=t>>>16)}function Re(t){return!(t&t-1||!t)}function xe(t){var e=(t>65535?1:0)<<4,r=((t>>>=e)>255?1:0)<<3;return e|=r,e|=r=((t>>>=r)>15?1:0)<<2,(e|=r=((t>>>=r)>3?1:0)<<1)|(t>>>=r)>>1}function Ae(t,e,r){var i,n=t.length;if(!(e>=n||0===r)){var o=n-(r=e+r>n?n-e:r);for(i=e;i<o;++i)t[i]=t[i+r];t.length=o}}function Se(t){return 0===t?0:t<0?-1:1}var Oe=0;function Ie(){return++Oe}var Pe={};var Me={},De=Object.create(null),Ne=Object.create(null);var we=function(){function t(t,e,r){this.canvas=document.createElement("canvas"),this.context=this.canvas.getContext("2d"),this.resolution=r||rt.RESOLUTION,this.resize(t,e)}return t.prototype.clear=function(){this.context.setTransform(1,0,0,1,0,0),this.context.clearRect(0,0,this.canvas.width,this.canvas.height)},t.prototype.resize=function(t,e){this.canvas.width=Math.round(t*this.resolution),this.canvas.height=Math.round(e*this.resolution)},t.prototype.destroy=function(){this.context=null,this.canvas=null},Object.defineProperty(t.prototype,"width",{get:function(){return this.canvas.width},set:function(t){this.canvas.width=Math.round(t)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"height",{get:function(){return this.canvas.height},set:function(t){this.canvas.height=Math.round(t)},enumerable:!1,configurable:!0}),t}();function Ce(t){var e,r,i,n=t.width,o=t.height,s=t.getContext("2d"),a=s.getImageData(0,0,n,o).data,h=a.length,u={top:null,left:null,right:null,bottom:null},l=null;for(e=0;e<h;e+=4)0!==a[e+3]&&(r=e/4%n,i=~~(e/4/n),null===u.top&&(u.top=i),null===u.left?u.left=r:r<u.left&&(u.left=r),null===u.right?u.right=r+1:u.right<r&&(u.right=r+1),null===u.bottom?u.bottom=i:u.bottom<i&&(u.bottom=i));return null!==u.top&&(n=u.right-u.left,o=u.bottom-u.top+1,l=s.getImageData(u.left,u.top,n,o)),{height:o,width:n,data:l}}var Le,Fe=/^\s*data:(?:([\w-]+)\/([\w+.-]+))?(?:;charset=([\w-]+))?(?:;(base64))?,(.*)/i;function Ue(t,e){if(void 0===e&&(e=self.location),0===t.indexOf("data:"))return"";e=e||self.location,Le||(Le=document.createElement("a")),Le.href=t;var r=ne.parse(Le.href),i=!r.port&&""===e.port||r.port===e.port;return r.hostname===e.hostname&&i&&r.protocol===e.protocol?"":"anonymous"}function Be(t,e){var r=rt.RETINA_PREFIX.exec(t);return r?parseFloat(r[1]):void 0!==e?e:1}var Ge={__proto__:null,BaseTextureCache:Ne,CanvasRenderTarget:we,DATA_URI:Fe,ProgramCache:Me,TextureCache:De,clearTextureCache:function(){var t;for(t in De)delete De[t];for(t in Ne)delete Ne[t]},correctBlendMode:_e,createIndicesForQuads:Ee,decomposeDataUri:function(t){var e=Fe.exec(t);if(e)return{mediaType:e[1]?e[1].toLowerCase():void 0,subType:e[2]?e[2].toLowerCase():void 0,charset:e[3]?e[3].toLowerCase():void 0,encoding:e[4]?e[4].toLowerCase():void 0,data:e[5]}},deprecation:function(t,e,r){if(void 0===r&&(r=3),!Pe[e]){var i=(new Error).stack;void 0===i?console.warn("PixiJS Deprecation Warning: ",e+"\nDeprecated since v"+t):(i=i.split("\n").splice(r).join("\n"),console.groupCollapsed?(console.groupCollapsed("%cPixiJS Deprecation Warning: %c%s","color:#614108;background:#fffbe6","font-weight:normal;color:#614108;background:#fffbe6",e+"\nDeprecated since v"+t),console.warn(i),console.groupEnd()):(console.warn("PixiJS Deprecation Warning: ",e+"\nDeprecated since v"+t),console.warn(i))),Pe[e]=!0}},destroyTextureCache:function(){var t;for(t in De)De[t].destroy();for(t in Ne)Ne[t].destroy()},determineCrossOrigin:Ue,getBufferType:ge,getResolutionOfUrl:Be,hex2rgb:ce,hex2string:de,interleaveTypedArrays:function(t,e){for(var r=0,i=0,n={},o=0;o<t.length;o++)i+=e[o],r+=t[o].length;var s=new ArrayBuffer(4*r),a=null,h=0;for(o=0;o<t.length;o++){var u=e[o],l=t[o],c=ge(l);n[c]||(n[c]=new Te[c](s)),a=n[c];for(var d=0;d<l.length;d++)a[(d/u|0)*i+h+d%u]=l[d];h+=u}return new Float32Array(s)},isPow2:Re,isWebGLSupported:ue,log2:xe,nextPow2:be,premultiplyBlendMode:pe,premultiplyRgba:me,premultiplyTint:ve,premultiplyTintToRgba:ye,removeItems:Ae,rgb2hex:function(t){return(255*t[0]<<16)+(255*t[1]<<8)+(255*t[2]|0)},sayHello:he,sign:Se,skipHello:function(){se=!0},string2hex:fe,trimCanvas:Ce,uid:Ie,url:ne,isMobile:et,EventEmitter:ot,earcut:st},Xe=2*Math.PI,ke=180/Math.PI,He=Math.PI/180;!function(t){t[t.POLY=0]="POLY",t[t.RECT=1]="RECT",t[t.CIRC=2]="CIRC",t[t.ELIP=3]="ELIP",t[t.RREC=4]="RREC"}(t.SHAPES||(t.SHAPES={}));var Ye=function(){function e(e,r,i,n){void 0===e&&(e=0),void 0===r&&(r=0),void 0===i&&(i=0),void 0===n&&(n=0),this.x=Number(e),this.y=Number(r),this.width=Number(i),this.height=Number(n),this.type=t.SHAPES.RECT}return Object.defineProperty(e.prototype,"left",{get:function(){return this.x},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"right",{get:function(){return this.x+this.width},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"top",{get:function(){return this.y},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"bottom",{get:function(){return this.y+this.height},enumerable:!1,configurable:!0}),Object.defineProperty(e,"EMPTY",{get:function(){return new e(0,0,0,0)},enumerable:!1,configurable:!0}),e.prototype.clone=function(){return new e(this.x,this.y,this.width,this.height)},e.prototype.copyFrom=function(t){return this.x=t.x,this.y=t.y,this.width=t.width,this.height=t.height,this},e.prototype.copyTo=function(t){return t.x=this.x,t.y=this.y,t.width=this.width,t.height=this.height,t},e.prototype.contains=function(t,e){return!(this.width<=0||this.height<=0)&&t>=this.x&&t<this.x+this.width&&e>=this.y&&e<this.y+this.height},e.prototype.pad=function(t,e){return void 0===t&&(t=0),void 0===e&&(e=t),this.x-=t,this.y-=e,this.width+=2*t,this.height+=2*e,this},e.prototype.fit=function(t){var e=Math.max(this.x,t.x),r=Math.min(this.x+this.width,t.x+t.width),i=Math.max(this.y,t.y),n=Math.min(this.y+this.height,t.y+t.height);return this.x=e,this.width=Math.max(r-e,0),this.y=i,this.height=Math.max(n-i,0),this},e.prototype.ceil=function(t,e){void 0===t&&(t=1),void 0===e&&(e=.001);var r=Math.ceil((this.x+this.width-e)*t)/t,i=Math.ceil((this.y+this.height-e)*t)/t;return this.x=Math.floor((this.x+e)*t)/t,this.y=Math.floor((this.y+e)*t)/t,this.width=r-this.x,this.height=i-this.y,this},e.prototype.enlarge=function(t){var e=Math.min(this.x,t.x),r=Math.max(this.x+this.width,t.x+t.width),i=Math.min(this.y,t.y),n=Math.max(this.y+this.height,t.y+t.height);return this.x=e,this.width=r-e,this.y=i,this.height=n-i,this},e}(),je=function(){function e(e,r,i){void 0===e&&(e=0),void 0===r&&(r=0),void 0===i&&(i=0),this.x=e,this.y=r,this.radius=i,this.type=t.SHAPES.CIRC}return e.prototype.clone=function(){return new e(this.x,this.y,this.radius)},e.prototype.contains=function(t,e){if(this.radius<=0)return!1;var r=this.radius*this.radius,i=this.x-t,n=this.y-e;return(i*=i)+(n*=n)<=r},e.prototype.getBounds=function(){return new Ye(this.x-this.radius,this.y-this.radius,2*this.radius,2*this.radius)},e}(),Ve=function(){function e(e,r,i,n){void 0===e&&(e=0),void 0===r&&(r=0),void 0===i&&(i=0),void 0===n&&(n=0),this.x=e,this.y=r,this.width=i,this.height=n,this.type=t.SHAPES.ELIP}return e.prototype.clone=function(){return new e(this.x,this.y,this.width,this.height)},e.prototype.contains=function(t,e){if(this.width<=0||this.height<=0)return!1;var r=(t-this.x)/this.width,i=(e-this.y)/this.height;return(r*=r)+(i*=i)<=1},e.prototype.getBounds=function(){return new Ye(this.x-this.width,this.y-this.height,this.width,this.height)},e}(),We=function(){function e(){for(var e=arguments,r=[],i=0;i<arguments.length;i++)r[i]=e[i];var n=Array.isArray(r[0])?r[0]:r;if("number"!=typeof n[0]){for(var o=[],s=0,a=n.length;s<a;s++)o.push(n[s].x,n[s].y);n=o}this.points=n,this.type=t.SHAPES.POLY,this.closeStroke=!0}return e.prototype.clone=function(){var t=new e(this.points.slice());return t.closeStroke=this.closeStroke,t},e.prototype.contains=function(t,e){for(var r=!1,i=this.points.length/2,n=0,o=i-1;n<i;o=n++){var s=this.points[2*n],a=this.points[2*n+1],h=this.points[2*o],u=this.points[2*o+1];a>e!=u>e&&t<(e-a)/(u-a)*(h-s)+s&&(r=!r)}return r},e}(),ze=function(){function e(e,r,i,n,o){void 0===e&&(e=0),void 0===r&&(r=0),void 0===i&&(i=0),void 0===n&&(n=0),void 0===o&&(o=20),this.x=e,this.y=r,this.width=i,this.height=n,this.radius=o,this.type=t.SHAPES.RREC}return e.prototype.clone=function(){return new e(this.x,this.y,this.width,this.height,this.radius)},e.prototype.contains=function(t,e){if(this.width<=0||this.height<=0)return!1;if(t>=this.x&&t<=this.x+this.width&&e>=this.y&&e<=this.y+this.height){if(e>=this.y+this.radius&&e<=this.y+this.height-this.radius||t>=this.x+this.radius&&t<=this.x+this.width-this.radius)return!0;var r=t-(this.x+this.radius),i=e-(this.y+this.radius),n=this.radius*this.radius;if(r*r+i*i<=n)return!0;if((r=t-(this.x+this.width-this.radius))*r+i*i<=n)return!0;if(r*r+(i=e-(this.y+this.height-this.radius))*i<=n)return!0;if((r=t-(this.x+this.radius))*r+i*i<=n)return!0}return!1},e}(),qe=function(){function t(t,e){void 0===t&&(t=0),void 0===e&&(e=0),this.x=0,this.y=0,this.x=t,this.y=e}return t.prototype.clone=function(){return new t(this.x,this.y)},t.prototype.copyFrom=function(t){return this.set(t.x,t.y),this},t.prototype.copyTo=function(t){return t.set(this.x,this.y),t},t.prototype.equals=function(t){return t.x===this.x&&t.y===this.y},t.prototype.set=function(t,e){return void 0===t&&(t=0),void 0===e&&(e=t),this.x=t,this.y=e,this},t}(),Ke=function(){function t(t,e,r,i){void 0===r&&(r=0),void 0===i&&(i=0),this._x=r,this._y=i,this.cb=t,this.scope=e}return t.prototype.clone=function(e,r){return void 0===e&&(e=this.cb),void 0===r&&(r=this.scope),new t(e,r,this._x,this._y)},t.prototype.set=function(t,e){return void 0===t&&(t=0),void 0===e&&(e=t),this._x===t&&this._y===e||(this._x=t,this._y=e,this.cb.call(this.scope)),this},t.prototype.copyFrom=function(t){return this._x===t.x&&this._y===t.y||(this._x=t.x,this._y=t.y,this.cb.call(this.scope)),this},t.prototype.copyTo=function(t){return t.set(this._x,this._y),t},t.prototype.equals=function(t){return t.x===this._x&&t.y===this._y},Object.defineProperty(t.prototype,"x",{get:function(){return this._x},set:function(t){this._x!==t&&(this._x=t,this.cb.call(this.scope))},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"y",{get:function(){return this._y},set:function(t){this._y!==t&&(this._y=t,this.cb.call(this.scope))},enumerable:!1,configurable:!0}),t}(),Ze=function(){function t(t,e,r,i,n,o){void 0===t&&(t=1),void 0===e&&(e=0),void 0===r&&(r=0),void 0===i&&(i=1),void 0===n&&(n=0),void 0===o&&(o=0),this.array=null,this.a=t,this.b=e,this.c=r,this.d=i,this.tx=n,this.ty=o}return t.prototype.fromArray=function(t){this.a=t[0],this.b=t[1],this.c=t[3],this.d=t[4],this.tx=t[2],this.ty=t[5]},t.prototype.set=function(t,e,r,i,n,o){return this.a=t,this.b=e,this.c=r,this.d=i,this.tx=n,this.ty=o,this},t.prototype.toArray=function(t,e){this.array||(this.array=new Float32Array(9));var r=e||this.array;return t?(r[0]=this.a,r[1]=this.b,r[2]=0,r[3]=this.c,r[4]=this.d,r[5]=0,r[6]=this.tx,r[7]=this.ty,r[8]=1):(r[0]=this.a,r[1]=this.c,r[2]=this.tx,r[3]=this.b,r[4]=this.d,r[5]=this.ty,r[6]=0,r[7]=0,r[8]=1),r},t.prototype.apply=function(t,e){e=e||new qe;var r=t.x,i=t.y;return e.x=this.a*r+this.c*i+this.tx,e.y=this.b*r+this.d*i+this.ty,e},t.prototype.applyInverse=function(t,e){e=e||new qe;var r=1/(this.a*this.d+this.c*-this.b),i=t.x,n=t.y;return e.x=this.d*r*i+-this.c*r*n+(this.ty*this.c-this.tx*this.d)*r,e.y=this.a*r*n+-this.b*r*i+(-this.ty*this.a+this.tx*this.b)*r,e},t.prototype.translate=function(t,e){return this.tx+=t,this.ty+=e,this},t.prototype.scale=function(t,e){return this.a*=t,this.d*=e,this.c*=t,this.b*=e,this.tx*=t,this.ty*=e,this},t.prototype.rotate=function(t){var e=Math.cos(t),r=Math.sin(t),i=this.a,n=this.c,o=this.tx;return this.a=i*e-this.b*r,this.b=i*r+this.b*e,this.c=n*e-this.d*r,this.d=n*r+this.d*e,this.tx=o*e-this.ty*r,this.ty=o*r+this.ty*e,this},t.prototype.append=function(t){var e=this.a,r=this.b,i=this.c,n=this.d;return this.a=t.a*e+t.b*i,this.b=t.a*r+t.b*n,this.c=t.c*e+t.d*i,this.d=t.c*r+t.d*n,this.tx=t.tx*e+t.ty*i+this.tx,this.ty=t.tx*r+t.ty*n+this.ty,this},t.prototype.setTransform=function(t,e,r,i,n,o,s,a,h){return this.a=Math.cos(s+h)*n,this.b=Math.sin(s+h)*n,this.c=-Math.sin(s-a)*o,this.d=Math.cos(s-a)*o,this.tx=t-(r*this.a+i*this.c),this.ty=e-(r*this.b+i*this.d),this},t.prototype.prepend=function(t){var e=this.tx;if(1!==t.a||0!==t.b||0!==t.c||1!==t.d){var r=this.a,i=this.c;this.a=r*t.a+this.b*t.c,this.b=r*t.b+this.b*t.d,this.c=i*t.a+this.d*t.c,this.d=i*t.b+this.d*t.d}return this.tx=e*t.a+this.ty*t.c+t.tx,this.ty=e*t.b+this.ty*t.d+t.ty,this},t.prototype.decompose=function(t){var e=this.a,r=this.b,i=this.c,n=this.d,o=t.pivot,s=-Math.atan2(-i,n),a=Math.atan2(r,e),h=Math.abs(s+a);return h<1e-5||Math.abs(Xe-h)<1e-5?(t.rotation=a,t.skew.x=t.skew.y=0):(t.rotation=0,t.skew.x=s,t.skew.y=a),t.scale.x=Math.sqrt(e*e+r*r),t.scale.y=Math.sqrt(i*i+n*n),t.position.x=this.tx+(o.x*e+o.y*i),t.position.y=this.ty+(o.x*r+o.y*n),t},t.prototype.invert=function(){var t=this.a,e=this.b,r=this.c,i=this.d,n=this.tx,o=t*i-e*r;return this.a=i/o,this.b=-e/o,this.c=-r/o,this.d=t/o,this.tx=(r*this.ty-i*n)/o,this.ty=-(t*this.ty-e*n)/o,this},t.prototype.identity=function(){return this.a=1,this.b=0,this.c=0,this.d=1,this.tx=0,this.ty=0,this},t.prototype.clone=function(){var e=new t;return e.a=this.a,e.b=this.b,e.c=this.c,e.d=this.d,e.tx=this.tx,e.ty=this.ty,e},t.prototype.copyTo=function(t){return t.a=this.a,t.b=this.b,t.c=this.c,t.d=this.d,t.tx=this.tx,t.ty=this.ty,t},t.prototype.copyFrom=function(t){return this.a=t.a,this.b=t.b,this.c=t.c,this.d=t.d,this.tx=t.tx,this.ty=t.ty,this},Object.defineProperty(t,"IDENTITY",{get:function(){return new t},enumerable:!1,configurable:!0}),Object.defineProperty(t,"TEMP_MATRIX",{get:function(){return new t},enumerable:!1,configurable:!0}),t}(),Qe=[1,1,0,-1,-1,-1,0,1,1,1,0,-1,-1,-1,0,1],Je=[0,1,1,1,0,-1,-1,-1,0,1,1,1,0,-1,-1,-1],$e=[0,-1,-1,-1,0,1,1,1,0,1,1,1,0,-1,-1,-1],tr=[1,1,0,-1,-1,-1,0,1,-1,-1,0,1,1,1,0,-1],er=[],rr=[],ir=Math.sign;!function(){for(var t=0;t<16;t++){var e=[];er.push(e);for(var r=0;r<16;r++)for(var i=ir(Qe[t]*Qe[r]+$e[t]*Je[r]),n=ir(Je[t]*Qe[r]+tr[t]*Je[r]),o=ir(Qe[t]*$e[r]+$e[t]*tr[r]),s=ir(Je[t]*$e[r]+tr[t]*tr[r]),a=0;a<16;a++)if(Qe[a]===i&&Je[a]===n&&$e[a]===o&&tr[a]===s){e.push(a);break}}for(t=0;t<16;t++){var h=new Ze;h.set(Qe[t],Je[t],$e[t],tr[t],0,0),rr.push(h)}}();var nr={E:0,SE:1,S:2,SW:3,W:4,NW:5,N:6,NE:7,MIRROR_VERTICAL:8,MAIN_DIAGONAL:10,MIRROR_HORIZONTAL:12,REVERSE_DIAGONAL:14,uX:function(t){return Qe[t]},uY:function(t){return Je[t]},vX:function(t){return $e[t]},vY:function(t){return tr[t]},inv:function(t){return 8&t?15&t:7&-t},add:function(t,e){return er[t][e]},sub:function(t,e){return er[t][nr.inv(e)]},rotate180:function(t){return 4^t},isVertical:function(t){return 2==(3&t)},byDirection:function(t,e){return 2*Math.abs(t)<=Math.abs(e)?e>=0?nr.S:nr.N:2*Math.abs(e)<=Math.abs(t)?t>0?nr.E:nr.W:e>0?t>0?nr.SE:nr.SW:t>0?nr.NE:nr.NW},matrixAppendRotationInv:function(t,e,r,i){void 0===r&&(r=0),void 0===i&&(i=0);var n=rr[nr.inv(e)];n.tx=r,n.ty=i,t.append(n)}},or=function(){function t(){this.worldTransform=new Ze,this.localTransform=new Ze,this.position=new Ke(this.onChange,this,0,0),this.scale=new Ke(this.onChange,this,1,1),this.pivot=new Ke(this.onChange,this,0,0),this.skew=new Ke(this.updateSkew,this,0,0),this._rotation=0,this._cx=1,this._sx=0,this._cy=0,this._sy=1,this._localID=0,this._currentLocalID=0,this._worldID=0,this._parentID=0}return t.prototype.onChange=function(){this._localID++},t.prototype.updateSkew=function(){this._cx=Math.cos(this._rotation+this.skew.y),this._sx=Math.sin(this._rotation+this.skew.y),this._cy=-Math.sin(this._rotation-this.skew.x),this._sy=Math.cos(this._rotation-this.skew.x),this._localID++},t.prototype.updateLocalTransform=function(){var t=this.localTransform;this._localID!==this._currentLocalID&&(t.a=this._cx*this.scale.x,t.b=this._sx*this.scale.x,t.c=this._cy*this.scale.y,t.d=this._sy*this.scale.y,t.tx=this.position.x-(this.pivot.x*t.a+this.pivot.y*t.c),t.ty=this.position.y-(this.pivot.x*t.b+this.pivot.y*t.d),this._currentLocalID=this._localID,this._parentID=-1)},t.prototype.updateTransform=function(t){var e=this.localTransform;if(this._localID!==this._currentLocalID&&(e.a=this._cx*this.scale.x,e.b=this._sx*this.scale.x,e.c=this._cy*this.scale.y,e.d=this._sy*this.scale.y,e.tx=this.position.x-(this.pivot.x*e.a+this.pivot.y*e.c),e.ty=this.position.y-(this.pivot.x*e.b+this.pivot.y*e.d),this._currentLocalID=this._localID,this._parentID=-1),this._parentID!==t._worldID){var r=t.worldTransform,i=this.worldTransform;i.a=e.a*r.a+e.b*r.c,i.b=e.a*r.b+e.b*r.d,i.c=e.c*r.a+e.d*r.c,i.d=e.c*r.b+e.d*r.d,i.tx=e.tx*r.a+e.ty*r.c+r.tx,i.ty=e.tx*r.b+e.ty*r.d+r.ty,this._parentID=t._worldID,this._worldID++}},t.prototype.setFromMatrix=function(t){t.decompose(this),this._localID++},Object.defineProperty(t.prototype,"rotation",{get:function(){return this._rotation},set:function(t){this._rotation!==t&&(this._rotation=t,this.updateSkew())},enumerable:!1,configurable:!0}),t.IDENTITY=new t,t}();rt.SORTABLE_CHILDREN=!1;var sr=function(){function t(){this.minX=1/0,this.minY=1/0,this.maxX=-1/0,this.maxY=-1/0,this.rect=null,this.updateID=-1}return t.prototype.isEmpty=function(){return this.minX>this.maxX||this.minY>this.maxY},t.prototype.clear=function(){this.minX=1/0,this.minY=1/0,this.maxX=-1/0,this.maxY=-1/0},t.prototype.getRectangle=function(t){return this.minX>this.maxX||this.minY>this.maxY?Ye.EMPTY:((t=t||new Ye(0,0,1,1)).x=this.minX,t.y=this.minY,t.width=this.maxX-this.minX,t.height=this.maxY-this.minY,t)},t.prototype.addPoint=function(t){this.minX=Math.min(this.minX,t.x),this.maxX=Math.max(this.maxX,t.x),this.minY=Math.min(this.minY,t.y),this.maxY=Math.max(this.maxY,t.y)},t.prototype.addPointMatrix=function(t,e){var r=t.a,i=t.b,n=t.c,o=t.d,s=t.tx,a=t.ty,h=r*e.x+n*e.y+s,u=i*e.x+o*e.y+a;this.minX=Math.min(this.minX,h),this.maxX=Math.max(this.maxX,h),this.minY=Math.min(this.minY,u),this.maxY=Math.max(this.maxY,u)},t.prototype.addQuad=function(t){var e=this.minX,r=this.minY,i=this.maxX,n=this.maxY,o=t[0],s=t[1];e=o<e?o:e,r=s<r?s:r,i=o>i?o:i,n=s>n?s:n,e=(o=t[2])<e?o:e,r=(s=t[3])<r?s:r,i=o>i?o:i,n=s>n?s:n,e=(o=t[4])<e?o:e,r=(s=t[5])<r?s:r,i=o>i?o:i,n=s>n?s:n,e=(o=t[6])<e?o:e,r=(s=t[7])<r?s:r,i=o>i?o:i,n=s>n?s:n,this.minX=e,this.minY=r,this.maxX=i,this.maxY=n},t.prototype.addFrame=function(t,e,r,i,n){this.addFrameMatrix(t.worldTransform,e,r,i,n)},t.prototype.addFrameMatrix=function(t,e,r,i,n){var o=t.a,s=t.b,a=t.c,h=t.d,u=t.tx,l=t.ty,c=this.minX,d=this.minY,f=this.maxX,p=this.maxY,_=o*e+a*r+u,m=s*e+h*r+l;c=_<c?_:c,d=m<d?m:d,f=_>f?_:f,p=m>p?m:p,c=(_=o*i+a*r+u)<c?_:c,d=(m=s*i+h*r+l)<d?m:d,f=_>f?_:f,p=m>p?m:p,c=(_=o*e+a*n+u)<c?_:c,d=(m=s*e+h*n+l)<d?m:d,f=_>f?_:f,p=m>p?m:p,c=(_=o*i+a*n+u)<c?_:c,d=(m=s*i+h*n+l)<d?m:d,f=_>f?_:f,p=m>p?m:p,this.minX=c,this.minY=d,this.maxX=f,this.maxY=p},t.prototype.addVertexData=function(t,e,r){for(var i=this.minX,n=this.minY,o=this.maxX,s=this.maxY,a=e;a<r;a+=2){var h=t[a],u=t[a+1];i=h<i?h:i,n=u<n?u:n,o=h>o?h:o,s=u>s?u:s}this.minX=i,this.minY=n,this.maxX=o,this.maxY=s},t.prototype.addVertices=function(t,e,r,i){this.addVerticesMatrix(t.worldTransform,e,r,i)},t.prototype.addVerticesMatrix=function(t,e,r,i,n,o){void 0===n&&(n=0),void 0===o&&(o=n);for(var s=t.a,a=t.b,h=t.c,u=t.d,l=t.tx,c=t.ty,d=this.minX,f=this.minY,p=this.maxX,_=this.maxY,m=r;m<i;m+=2){var v=e[m],y=e[m+1],E=s*v+h*y+l,g=u*y+a*v+c;d=Math.min(d,E-n),p=Math.max(p,E+n),f=Math.min(f,g-o),_=Math.max(_,g+o)}this.minX=d,this.minY=f,this.maxX=p,this.maxY=_},t.prototype.addBounds=function(t){var e=this.minX,r=this.minY,i=this.maxX,n=this.maxY;this.minX=t.minX<e?t.minX:e,this.minY=t.minY<r?t.minY:r,this.maxX=t.maxX>i?t.maxX:i,this.maxY=t.maxY>n?t.maxY:n},t.prototype.addBoundsMask=function(t,e){var r=t.minX>e.minX?t.minX:e.minX,i=t.minY>e.minY?t.minY:e.minY,n=t.maxX<e.maxX?t.maxX:e.maxX,o=t.maxY<e.maxY?t.maxY:e.maxY;if(r<=n&&i<=o){var s=this.minX,a=this.minY,h=this.maxX,u=this.maxY;this.minX=r<s?r:s,this.minY=i<a?i:a,this.maxX=n>h?n:h,this.maxY=o>u?o:u}},t.prototype.addBoundsMatrix=function(t,e){this.addFrameMatrix(e,t.minX,t.minY,t.maxX,t.maxY)},t.prototype.addBoundsArea=function(t,e){var r=t.minX>e.x?t.minX:e.x,i=t.minY>e.y?t.minY:e.y,n=t.maxX<e.x+e.width?t.maxX:e.x+e.width,o=t.maxY<e.y+e.height?t.maxY:e.y+e.height;if(r<=n&&i<=o){var s=this.minX,a=this.minY,h=this.maxX,u=this.maxY;this.minX=r<s?r:s,this.minY=i<a?i:a,this.maxX=n>h?n:h,this.maxY=o>u?o:u}},t.prototype.pad=function(t,e){void 0===t&&(t=0),void 0===e&&(e=t),this.isEmpty()||(this.minX-=t,this.maxX+=t,this.minY-=e,this.maxY+=e)},t.prototype.addFramePad=function(t,e,r,i,n,o){t-=n,e-=o,r+=n,i+=o,this.minX=this.minX<t?this.minX:t,this.maxX=this.maxX>r?this.maxX:r,this.minY=this.minY<e?this.minY:e,this.maxY=this.maxY>i?this.maxY:i},t}(),ar=function(t,e){return(ar=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r])})(t,e)};function hr(t,e){function r(){this.constructor=t}ar(t,e),t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)}var ur=function(t){function e(){var e=t.call(this)||this;return e.tempDisplayObjectParent=null,e.transform=new or,e.alpha=1,e.visible=!0,e.renderable=!0,e.parent=null,e.worldAlpha=1,e._lastSortedIndex=0,e._zIndex=0,e.filterArea=null,e.filters=null,e._enabledFilters=null,e._bounds=new sr,e._localBounds=null,e._boundsID=0,e._boundsRect=null,e._localBoundsRect=null,e._mask=null,e._destroyed=!1,e.isSprite=!1,e.isMask=!1,e}return hr(e,t),e.mixin=function(t){for(var r=Object.keys(t),i=0;i<r.length;++i){var n=r[i];Object.defineProperty(e.prototype,n,Object.getOwnPropertyDescriptor(t,n))}},Object.defineProperty(e.prototype,"destroyed",{get:function(){return this._destroyed},enumerable:!1,configurable:!0}),e.prototype._recursivePostUpdateTransform=function(){this.parent?(this.parent._recursivePostUpdateTransform(),this.transform.updateTransform(this.parent.transform)):this.transform.updateTransform(this._tempDisplayObjectParent.transform)},e.prototype.updateTransform=function(){this._boundsID++,this.transform.updateTransform(this.parent.transform),this.worldAlpha=this.alpha*this.parent.worldAlpha},e.prototype.getBounds=function(t,e){return t||(this.parent?(this._recursivePostUpdateTransform(),this.updateTransform()):(this.parent=this._tempDisplayObjectParent,this.updateTransform(),this.parent=null)),this._bounds.updateID!==this._boundsID&&(this.calculateBounds(),this._bounds.updateID=this._boundsID),e||(this._boundsRect||(this._boundsRect=new Ye),e=this._boundsRect),this._bounds.getRectangle(e)},e.prototype.getLocalBounds=function(t){t||(this._localBoundsRect||(this._localBoundsRect=new Ye),t=this._localBoundsRect),this._localBounds||(this._localBounds=new sr);var e=this.transform,r=this.parent;this.parent=null,this.transform=this._tempDisplayObjectParent.transform;var i=this._bounds,n=this._boundsID;this._bounds=this._localBounds;var o=this.getBounds(!1,t);return this.parent=r,this.transform=e,this._bounds=i,this._bounds.updateID+=this._boundsID-n,o},e.prototype.toGlobal=function(t,e,r){return void 0===r&&(r=!1),r||(this._recursivePostUpdateTransform(),this.parent?this.displayObjectUpdateTransform():(this.parent=this._tempDisplayObjectParent,this.displayObjectUpdateTransform(),this.parent=null)),this.worldTransform.apply(t,e)},e.prototype.toLocal=function(t,e,r,i){return e&&(t=e.toGlobal(t,r,i)),i||(this._recursivePostUpdateTransform(),this.parent?this.displayObjectUpdateTransform():(this.parent=this._tempDisplayObjectParent,this.displayObjectUpdateTransform(),this.parent=null)),this.worldTransform.applyInverse(t,r)},e.prototype.setParent=function(t){if(!t||!t.addChild)throw new Error("setParent: Argument must be a Container");return t.addChild(this),t},e.prototype.setTransform=function(t,e,r,i,n,o,s,a,h){return void 0===t&&(t=0),void 0===e&&(e=0),void 0===r&&(r=1),void 0===i&&(i=1),void 0===n&&(n=0),void 0===o&&(o=0),void 0===s&&(s=0),void 0===a&&(a=0),void 0===h&&(h=0),this.position.x=t,this.position.y=e,this.scale.x=r||1,this.scale.y=i||1,this.rotation=n,this.skew.x=o,this.skew.y=s,this.pivot.x=a,this.pivot.y=h,this},e.prototype.destroy=function(t){this.parent&&this.parent.removeChild(this),this.emit("destroyed"),this.removeAllListeners(),this.transform=null,this.parent=null,this._bounds=null,this._mask=null,this.filters=null,this.filterArea=null,this.hitArea=null,this.interactive=!1,this.interactiveChildren=!1,this._destroyed=!0},Object.defineProperty(e.prototype,"_tempDisplayObjectParent",{get:function(){return null===this.tempDisplayObjectParent&&(this.tempDisplayObjectParent=new lr),this.tempDisplayObjectParent},enumerable:!1,configurable:!0}),e.prototype.enableTempParent=function(){var t=this.parent;return this.parent=this._tempDisplayObjectParent,t},e.prototype.disableTempParent=function(t){this.parent=t},Object.defineProperty(e.prototype,"x",{get:function(){return this.position.x},set:function(t){this.transform.position.x=t},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"y",{get:function(){return this.position.y},set:function(t){this.transform.position.y=t},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"worldTransform",{get:function(){return this.transform.worldTransform},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"localTransform",{get:function(){return this.transform.localTransform},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"position",{get:function(){return this.transform.position},set:function(t){this.transform.position.copyFrom(t)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"scale",{get:function(){return this.transform.scale},set:function(t){this.transform.scale.copyFrom(t)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pivot",{get:function(){return this.transform.pivot},set:function(t){this.transform.pivot.copyFrom(t)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"skew",{get:function(){return this.transform.skew},set:function(t){this.transform.skew.copyFrom(t)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"rotation",{get:function(){return this.transform.rotation},set:function(t){this.transform.rotation=t},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"angle",{get:function(){return this.transform.rotation*ke},set:function(t){this.transform.rotation=t*He},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"zIndex",{get:function(){return this._zIndex},set:function(t){this._zIndex=t,this.parent&&(this.parent.sortDirty=!0)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"worldVisible",{get:function(){var t=this;do{if(!t.visible)return!1;t=t.parent}while(t);return!0},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"mask",{get:function(){return this._mask},set:function(t){var e;this._mask&&((e=this._mask.maskObject||this._mask).renderable=!0,e.isMask=!1),this._mask=t,this._mask&&((e=this._mask.maskObject||this._mask).renderable=!1,e.isMask=!0)},enumerable:!1,configurable:!0}),e}(ot),lr=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e.sortDirty=null,e}return hr(e,t),e}(ur);function cr(t,e){return t.zIndex===e.zIndex?t._lastSortedIndex-e._lastSortedIndex:t.zIndex-e.zIndex}ur.prototype.displayObjectUpdateTransform=ur.prototype.updateTransform;var dr=function(t){function e(){var e=t.call(this)||this;return e.children=[],e.sortableChildren=rt.SORTABLE_CHILDREN,e.sortDirty=!1,e}return hr(e,t),e.prototype.onChildrenChange=function(t){},e.prototype.addChild=function(){for(var t=arguments,e=[],r=0;r<arguments.length;r++)e[r]=t[r];if(e.length>1)for(var i=0;i<e.length;i++)this.addChild(e[i]);else{var n=e[0];n.parent&&n.parent.removeChild(n),n.parent=this,this.sortDirty=!0,n.transform._parentID=-1,this.children.push(n),this._boundsID++,this.onChildrenChange(this.children.length-1),this.emit("childAdded",n,this,this.children.length-1),n.emit("added",this)}return e[0]},e.prototype.addChildAt=function(t,e){if(e<0||e>this.children.length)throw new Error(t+"addChildAt: The index "+e+" supplied is out of bounds "+this.children.length);return t.parent&&t.parent.removeChild(t),t.parent=this,this.sortDirty=!0,t.transform._parentID=-1,this.children.splice(e,0,t),this._boundsID++,this.onChildrenChange(e),t.emit("added",this),this.emit("childAdded",t,this,e),t},e.prototype.swapChildren=function(t,e){if(t!==e){var r=this.getChildIndex(t),i=this.getChildIndex(e);this.children[r]=e,this.children[i]=t,this.onChildrenChange(r<i?r:i)}},e.prototype.getChildIndex=function(t){var e=this.children.indexOf(t);if(-1===e)throw new Error("The supplied DisplayObject must be a child of the caller");return e},e.prototype.setChildIndex=function(t,e){if(e<0||e>=this.children.length)throw new Error("The index "+e+" supplied is out of bounds "+this.children.length);var r=this.getChildIndex(t);Ae(this.children,r,1),this.children.splice(e,0,t),this.onChildrenChange(e)},e.prototype.getChildAt=function(t){if(t<0||t>=this.children.length)throw new Error("getChildAt: Index ("+t+") does not exist.");return this.children[t]},e.prototype.removeChild=function(){for(var t=arguments,e=[],r=0;r<arguments.length;r++)e[r]=t[r];if(e.length>1)for(var i=0;i<e.length;i++)this.removeChild(e[i]);else{var n=e[0],o=this.children.indexOf(n);if(-1===o)return null;n.parent=null,n.transform._parentID=-1,Ae(this.children,o,1),this._boundsID++,this.onChildrenChange(o),n.emit("removed",this),this.emit("childRemoved",n,this,o)}return e[0]},e.prototype.removeChildAt=function(t){var e=this.getChildAt(t);return e.parent=null,e.transform._parentID=-1,Ae(this.children,t,1),this._boundsID++,this.onChildrenChange(t),e.emit("removed",this),this.emit("childRemoved",e,this,t),e},e.prototype.removeChildren=function(t,e){void 0===t&&(t=0),void 0===e&&(e=this.children.length);var r,i=t,n=e-i;if(n>0&&n<=e){r=this.children.splice(i,n);for(var o=0;o<r.length;++o)r[o].parent=null,r[o].transform&&(r[o].transform._parentID=-1);for(this._boundsID++,this.onChildrenChange(t),o=0;o<r.length;++o)r[o].emit("removed",this),this.emit("childRemoved",r[o],this,o);return r}if(0===n&&0===this.children.length)return[];throw new RangeError("removeChildren: numeric values are outside the acceptable range.")},e.prototype.sortChildren=function(){for(var t=!1,e=0,r=this.children.length;e<r;++e){var i=this.children[e];i._lastSortedIndex=e,t||0===i.zIndex||(t=!0)}t&&this.children.length>1&&this.children.sort(cr),this.sortDirty=!1},e.prototype.updateTransform=function(){this.sortableChildren&&this.sortDirty&&this.sortChildren(),this._boundsID++,this.transform.updateTransform(this.parent.transform),this.worldAlpha=this.alpha*this.parent.worldAlpha;for(var t=0,e=this.children.length;t<e;++t){var r=this.children[t];r.visible&&r.updateTransform()}},e.prototype.calculateBounds=function(){this._bounds.clear(),this._calculateBounds();for(var t=0;t<this.children.length;t++){var e=this.children[t];if(e.visible&&e.renderable)if(e.calculateBounds(),e._mask){var r=e._mask.maskObject||e._mask;r.calculateBounds(),this._bounds.addBoundsMask(e._bounds,r._bounds)}else e.filterArea?this._bounds.addBoundsArea(e._bounds,e.filterArea):this._bounds.addBounds(e._bounds)}this._bounds.updateID=this._boundsID},e.prototype.getLocalBounds=function(e,r){void 0===r&&(r=!1);var i=t.prototype.getLocalBounds.call(this,e);if(!r)for(var n=0,o=this.children.length;n<o;++n){var s=this.children[n];s.visible&&s.updateTransform()}return i},e.prototype._calculateBounds=function(){},e.prototype.render=function(t){if(this.visible&&!(this.worldAlpha<=0)&&this.renderable)if(this._mask||this.filters&&this.filters.length)this.renderAdvanced(t);else{this._render(t);for(var e=0,r=this.children.length;e<r;++e)this.children[e].render(t)}},e.prototype.renderAdvanced=function(t){t.batch.flush();var e=this.filters,r=this._mask;if(e){this._enabledFilters||(this._enabledFilters=[]),this._enabledFilters.length=0;for(var i=0;i<e.length;i++)e[i].enabled&&this._enabledFilters.push(e[i]);this._enabledFilters.length&&t.filter.push(this,this._enabledFilters)}r&&t.mask.push(this,this._mask),this._render(t),i=0;for(var n=this.children.length;i<n;i++)this.children[i].render(t);t.batch.flush(),r&&t.mask.pop(this),e&&this._enabledFilters&&this._enabledFilters.length&&t.filter.pop()},e.prototype._render=function(t){},e.prototype.destroy=function(e){t.prototype.destroy.call(this),this.sortDirty=!1;var r="boolean"==typeof e?e:e&&e.children,i=this.removeChildren(0,this.children.length);if(r)for(var n=0;n<i.length;++n)i[n].destroy(e)},Object.defineProperty(e.prototype,"width",{get:function(){return this.scale.x*this.getLocalBounds().width},set:function(t){var e=this.getLocalBounds().width;this.scale.x=0!==e?t/e:1,this._width=t},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"height",{get:function(){return this.scale.y*this.getLocalBounds().height},set:function(t){var e=this.getLocalBounds().height;this.scale.y=0!==e?t/e:1,this._height=t},enumerable:!1,configurable:!0}),e}(ur);dr.prototype.containerUpdateTransform=dr.prototype.updateTransform;var fr={accessible:!1,accessibleTitle:null,accessibleHint:null,tabIndex:0,_accessibleActive:!1,_accessibleDiv:null,accessibleType:"button",accessiblePointerEvents:"auto",accessibleChildren:!0,renderId:-1};ur.mixin(fr);var pr=100,_r=0,mr=0,vr=2,yr=function(){function t(t){this.debug=!1,this._isActive=!1,this._isMobileAccessibility=!1,this.pool=[],this.renderId=0,this.children=[],this.androidUpdateCount=0,this.androidUpdateFrequency=500,this._hookDiv=null,(et.tablet||et.phone)&&this.createTouchHook();var e=document.createElement("div");e.style.width=pr+"px",e.style.height=pr+"px",e.style.position="absolute",e.style.top=_r+"px",e.style.left=mr+"px",e.style.zIndex=vr.toString(),this.div=e,this.renderer=t,this._onKeyDown=this._onKeyDown.bind(this),this._onMouseMove=this._onMouseMove.bind(this),self.addEventListener("keydown",this._onKeyDown,!1)}return Object.defineProperty(t.prototype,"isActive",{get:function(){return this._isActive},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"isMobileAccessibility",{get:function(){return this._isMobileAccessibility},enumerable:!1,configurable:!0}),t.prototype.createTouchHook=function(){var t=this,e=document.createElement("button");e.style.width="1px",e.style.height="1px",e.style.position="absolute",e.style.top="-1000px",e.style.left="-1000px",e.style.zIndex=2..toString(),e.style.backgroundColor="#FF0000",e.title="select to enable accessibility for this content",e.addEventListener("focus",function(){t._isMobileAccessibility=!0,t.activate(),t.destroyTouchHook()}),document.body.appendChild(e),this._hookDiv=e},t.prototype.destroyTouchHook=function(){this._hookDiv&&(document.body.removeChild(this._hookDiv),this._hookDiv=null)},t.prototype.activate=function(){var t;this._isActive||(this._isActive=!0,self.document.addEventListener("mousemove",this._onMouseMove,!0),self.removeEventListener("keydown",this._onKeyDown,!1),this.renderer.on("postrender",this.update,this),null===(t=this.renderer.view.parentNode)||void 0===t||t.appendChild(this.div))},t.prototype.deactivate=function(){var t;this._isActive&&!this._isMobileAccessibility&&(this._isActive=!1,self.document.removeEventListener("mousemove",this._onMouseMove,!0),self.addEventListener("keydown",this._onKeyDown,!1),this.renderer.off("postrender",this.update),null===(t=this.div.parentNode)||void 0===t||t.removeChild(this.div))},t.prototype.updateAccessibleObjects=function(t){if(t.visible&&t.accessibleChildren){t.accessible&&t.interactive&&(t._accessibleActive||this.addChild(t),t.renderId=this.renderId);for(var e=t.children,r=0;r<e.length;r++)this.updateAccessibleObjects(e[r])}},t.prototype.update=function(){var t=performance.now();if(!(et.android.device&&t<this.androidUpdateCount)&&(this.androidUpdateCount=t+this.androidUpdateFrequency,this.renderer.renderingToScreen)){this.renderer._lastObjectRendered&&this.updateAccessibleObjects(this.renderer._lastObjectRendered);var e=this.renderer.view.getBoundingClientRect(),r=e.left,i=e.top,n=e.width,o=e.height,s=this.renderer,a=s.width,h=s.height,u=s.resolution,l=n/a*u,c=o/h*u,d=this.div;d.style.left=r+"px",d.style.top=i+"px",d.style.width=a+"px",d.style.height=h+"px";for(var f=0;f<this.children.length;f++){var p=this.children[f];if(p.renderId!==this.renderId)p._accessibleActive=!1,Ae(this.children,f,1),this.div.removeChild(p._accessibleDiv),this.pool.push(p._accessibleDiv),p._accessibleDiv=null,f--;else{d=p._accessibleDiv;var _=p.hitArea,m=p.worldTransform;p.hitArea?(d.style.left=(m.tx+_.x*m.a)*l+"px",d.style.top=(m.ty+_.y*m.d)*c+"px",d.style.width=_.width*m.a*l+"px",d.style.height=_.height*m.d*c+"px"):(_=p.getBounds(),this.capHitArea(_),d.style.left=_.x*l+"px",d.style.top=_.y*c+"px",d.style.width=_.width*l+"px",d.style.height=_.height*c+"px",d.title!==p.accessibleTitle&&null!==p.accessibleTitle&&(d.title=p.accessibleTitle),d.getAttribute("aria-label")!==p.accessibleHint&&null!==p.accessibleHint&&d.setAttribute("aria-label",p.accessibleHint)),p.accessibleTitle===d.title&&p.tabIndex===d.tabIndex||(d.title=p.accessibleTitle,d.tabIndex=p.tabIndex,this.debug&&this.updateDebugHTML(d))}}this.renderId++}},t.prototype.updateDebugHTML=function(t){t.innerHTML="type: "+t.type+"</br> title : "+t.title+"</br> tabIndex: "+t.tabIndex},t.prototype.capHitArea=function(t){t.x<0&&(t.width+=t.x,t.x=0),t.y<0&&(t.height+=t.y,t.y=0);var e=this.renderer,r=e.width,i=e.height;t.x+t.width>r&&(t.width=r-t.x),t.y+t.height>i&&(t.height=i-t.y)},t.prototype.addChild=function(t){var e=this.pool.pop();e||((e=document.createElement("button")).style.width=pr+"px",e.style.height=pr+"px",e.style.backgroundColor=this.debug?"rgba(255,255,255,0.5)":"transparent",e.style.position="absolute",e.style.zIndex=vr.toString(),e.style.borderStyle="none",navigator.userAgent.toLowerCase().indexOf("chrome")>-1?e.setAttribute("aria-live","off"):e.setAttribute("aria-live","polite"),navigator.userAgent.match(/rv:.*Gecko\//)?e.setAttribute("aria-relevant","additions"):e.setAttribute("aria-relevant","text"),e.addEventListener("click",this._onClick.bind(this)),e.addEventListener("focus",this._onFocus.bind(this)),e.addEventListener("focusout",this._onFocusOut.bind(this))),e.style.pointerEvents=t.accessiblePointerEvents,e.type=t.accessibleType,t.accessibleTitle&&null!==t.accessibleTitle?e.title=t.accessibleTitle:t.accessibleHint&&null!==t.accessibleHint||(e.title="displayObject "+t.tabIndex),t.accessibleHint&&null!==t.accessibleHint&&e.setAttribute("aria-label",t.accessibleHint),this.debug&&this.updateDebugHTML(e),t._accessibleActive=!0,t._accessibleDiv=e,e.displayObject=t,this.children.push(t),this.div.appendChild(t._accessibleDiv),t._accessibleDiv.tabIndex=t.tabIndex},t.prototype._onClick=function(t){var e=this.renderer.plugins.interaction,r=t.target.displayObject,i=e.eventData;e.dispatchEvent(r,"click",i),e.dispatchEvent(r,"pointertap",i),e.dispatchEvent(r,"tap",i)},t.prototype._onFocus=function(t){t.target.getAttribute("aria-live")||t.target.setAttribute("aria-live","assertive");var e=this.renderer.plugins.interaction,r=t.target.displayObject,i=e.eventData;e.dispatchEvent(r,"mouseover",i)},t.prototype._onFocusOut=function(t){t.target.getAttribute("aria-live")||t.target.setAttribute("aria-live","polite");var e=this.renderer.plugins.interaction,r=t.target.displayObject,i=e.eventData;e.dispatchEvent(r,"mouseout",i)},t.prototype._onKeyDown=function(t){9===t.keyCode&&this.activate()},t.prototype._onMouseMove=function(t){0===t.movementX&&0===t.movementY||this.deactivate()},t.prototype.destroy=function(){this.destroyTouchHook(),this.div=null,self.document.removeEventListener("mousemove",this._onMouseMove,!0),self.removeEventListener("keydown",this._onKeyDown),this.pool=null,this.children=null,this.renderer=null},t}();rt.TARGET_FPMS=.06,function(t){t[t.INTERACTION=50]="INTERACTION",t[t.HIGH=25]="HIGH",t[t.NORMAL=0]="NORMAL",t[t.LOW=-25]="LOW",t[t.UTILITY=-50]="UTILITY"}(t.UPDATE_PRIORITY||(t.UPDATE_PRIORITY={}));var Er=function(){function t(t,e,r,i){void 0===e&&(e=null),void 0===r&&(r=0),void 0===i&&(i=!1),this.next=null,this.previous=null,this._destroyed=!1,this.fn=t,this.context=e,this.priority=r,this.once=i}return t.prototype.match=function(t,e){return void 0===e&&(e=null),this.fn===t&&this.context===e},t.prototype.emit=function(t){this.fn&&(this.context?this.fn.call(this.context,t):this.fn(t));var e=this.next;return this.once&&this.destroy(!0),this._destroyed&&(this.next=null),e},t.prototype.connect=function(t){this.previous=t,t.next&&(t.next.previous=this),this.next=t.next,t.next=this},t.prototype.destroy=function(t){void 0===t&&(t=!1),this._destroyed=!0,this.fn=null,this.context=null,this.previous&&(this.previous.next=this.next),this.next&&(this.next.previous=this.previous);var e=this.next;return this.next=t?null:e,this.previous=null,e},t}(),gr=function(){function e(){var t=this;this.autoStart=!1,this.deltaTime=1,this.lastTime=-1,this.speed=1,this.started=!1,this._requestId=null,this._maxElapsedMS=100,this._minElapsedMS=0,this._protected=!1,this._lastFrame=-1,this._head=new Er(null,null,1/0),this.deltaMS=1/rt.TARGET_FPMS,this.elapsedMS=1/rt.TARGET_FPMS,this._tick=function(e){t._requestId=null,t.started&&(t.update(e),t.started&&null===t._requestId&&t._head.next&&(t._requestId=requestAnimationFrame(t._tick)))}}return e.prototype._requestIfNeeded=function(){null===this._requestId&&this._head.next&&(this.lastTime=performance.now(),this._lastFrame=this.lastTime,this._requestId=requestAnimationFrame(this._tick))},e.prototype._cancelIfNeeded=function(){null!==this._requestId&&(cancelAnimationFrame(this._requestId),this._requestId=null)},e.prototype._startIfPossible=function(){this.started?this._requestIfNeeded():this.autoStart&&this.start()},e.prototype.add=function(e,r,i){return void 0===i&&(i=t.UPDATE_PRIORITY.NORMAL),this._addListener(new Er(e,r,i))},e.prototype.addOnce=function(e,r,i){return void 0===i&&(i=t.UPDATE_PRIORITY.NORMAL),this._addListener(new Er(e,r,i,!0))},e.prototype._addListener=function(t){var e=this._head.next,r=this._head;if(e){for(;e;){if(t.priority>e.priority){t.connect(r);break}r=e,e=e.next}t.previous||t.connect(r)}else t.connect(r);return this._startIfPossible(),this},e.prototype.remove=function(t,e){for(var r=this._head.next;r;)r=r.match(t,e)?r.destroy():r.next;return this._head.next||this._cancelIfNeeded(),this},Object.defineProperty(e.prototype,"count",{get:function(){if(!this._head)return 0;for(var t=0,e=this._head;e=e.next;)t++;return t},enumerable:!1,configurable:!0}),e.prototype.start=function(){this.started||(this.started=!0,this._requestIfNeeded())},e.prototype.stop=function(){this.started&&(this.started=!1,this._cancelIfNeeded())},e.prototype.destroy=function(){if(!this._protected){this.stop();for(var t=this._head.next;t;)t=t.destroy(!0);this._head.destroy(),this._head=null}},e.prototype.update=function(t){var e;if(void 0===t&&(t=performance.now()),t>this.lastTime){if((e=this.elapsedMS=t-this.lastTime)>this._maxElapsedMS&&(e=this._maxElapsedMS),e*=this.speed,this._minElapsedMS){var r=t-this._lastFrame|0;if(r<this._minElapsedMS)return;this._lastFrame=t-r%this._minElapsedMS}this.deltaMS=e,this.deltaTime=this.deltaMS*rt.TARGET_FPMS;for(var i=this._head,n=i.next;n;)n=n.emit(this.deltaTime);i.next||this._cancelIfNeeded()}else this.deltaTime=this.deltaMS=this.elapsedMS=0;this.lastTime=t},Object.defineProperty(e.prototype,"FPS",{get:function(){return 1e3/this.elapsedMS},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"minFPS",{get:function(){return 1e3/this._maxElapsedMS},set:function(t){var e=Math.min(this.maxFPS,t),r=Math.min(Math.max(0,e)/1e3,rt.TARGET_FPMS);this._maxElapsedMS=1/r},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"maxFPS",{get:function(){return this._minElapsedMS?Math.round(1e3/this._minElapsedMS):0},set:function(t){if(0===t)this._minElapsedMS=0;else{var e=Math.max(this.minFPS,t);this._minElapsedMS=1/(e/1e3)}},enumerable:!1,configurable:!0}),Object.defineProperty(e,"shared",{get:function(){if(!e._shared){var t=e._shared=new e;t.autoStart=!0,t._protected=!0}return e._shared},enumerable:!1,configurable:!0}),Object.defineProperty(e,"system",{get:function(){if(!e._system){var t=e._system=new e;t.autoStart=!0,t._protected=!0}return e._system},enumerable:!1,configurable:!0}),e}(),Tr=function(){function e(){}return e.init=function(e){var r=this;e=Object.assign({autoStart:!0,sharedTicker:!1},e),Object.defineProperty(this,"ticker",{set:function(e){this._ticker&&this._ticker.remove(this.render,this),this._ticker=e,e&&e.add(this.render,this,t.UPDATE_PRIORITY.LOW)},get:function(){return this._ticker}}),this.stop=function(){r._ticker.stop()},this.start=function(){r._ticker.start()},this._ticker=null,this.ticker=e.sharedTicker?gr.shared:new gr,e.autoStart&&this.start()},e.destroy=function(){if(this._ticker){var t=this._ticker;this.ticker=null,t.destroy()}},e}(),br=function(){function t(){this.pressure=0,this.rotationAngle=0,this.twist=0,this.tangentialPressure=0,this.global=new qe,this.target=null,this.originalEvent=null,this.identifier=null,this.isPrimary=!1,this.button=0,this.buttons=0,this.width=0,this.height=0,this.tiltX=0,this.tiltY=0,this.pointerType=null,this.pressure=0,this.rotationAngle=0,this.twist=0,this.tangentialPressure=0}return Object.defineProperty(t.prototype,"pointerId",{get:function(){return this.identifier},enumerable:!1,configurable:!0}),t.prototype.getLocalPosition=function(t,e,r){return t.worldTransform.applyInverse(r||this.global,e)},t.prototype.copyEvent=function(t){"isPrimary"in t&&t.isPrimary&&(this.isPrimary=!0),this.button="button"in t&&t.button;var e="buttons"in t&&t.buttons;this.buttons=Number.isInteger(e)?e:"which"in t&&t.which,this.width="width"in t&&t.width,this.height="height"in t&&t.height,this.tiltX="tiltX"in t&&t.tiltX,this.tiltY="tiltY"in t&&t.tiltY,this.pointerType="pointerType"in t&&t.pointerType,this.pressure="pressure"in t&&t.pressure,this.rotationAngle="rotationAngle"in t&&t.rotationAngle,this.twist="twist"in t&&t.twist||0,this.tangentialPressure="tangentialPressure"in t&&t.tangentialPressure||0},t.prototype.reset=function(){this.isPrimary=!1},t}(),Rr=function(t,e){return(Rr=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r])})(t,e)},xr=function(){function t(){this.stopped=!1,this.stopsPropagatingAt=null,this.stopPropagationHint=!1,this.target=null,this.currentTarget=null,this.type=null,this.data=null}return t.prototype.stopPropagation=function(){this.stopped=!0,this.stopPropagationHint=!0,this.stopsPropagatingAt=this.currentTarget},t.prototype.reset=function(){this.stopped=!1,this.stopsPropagatingAt=null,this.stopPropagationHint=!1,this.currentTarget=null,this.target=null},t}(),Ar=function(){function t(e){this._pointerId=e,this._flags=t.FLAGS.NONE}return t.prototype._doSet=function(t,e){this._flags=e?this._flags|t:this._flags&~t},Object.defineProperty(t.prototype,"pointerId",{get:function(){return this._pointerId},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"flags",{get:function(){return this._flags},set:function(t){this._flags=t},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"none",{get:function(){return this._flags===t.FLAGS.NONE},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"over",{get:function(){return 0!=(this._flags&t.FLAGS.OVER)},set:function(e){this._doSet(t.FLAGS.OVER,e)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"rightDown",{get:function(){return 0!=(this._flags&t.FLAGS.RIGHT_DOWN)},set:function(e){this._doSet(t.FLAGS.RIGHT_DOWN,e)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"leftDown",{get:function(){return 0!=(this._flags&t.FLAGS.LEFT_DOWN)},set:function(e){this._doSet(t.FLAGS.LEFT_DOWN,e)},enumerable:!1,configurable:!0}),t.FLAGS=Object.freeze({NONE:0,OVER:1,LEFT_DOWN:2,RIGHT_DOWN:4}),t}(),Sr=function(){function t(){this._tempPoint=new qe}return t.prototype.recursiveFindHit=function(t,e,r,i,n){if(!e||!e.visible)return!1;var o=t.data.global,s=!1,a=n=e.interactive||n,h=!0;if(e.hitArea?(i&&(e.worldTransform.applyInverse(o,this._tempPoint),e.hitArea.contains(this._tempPoint.x,this._tempPoint.y)?s=!0:(i=!1,h=!1)),a=!1):e._mask&&i&&(e._mask.containsPoint&&e._mask.containsPoint(o)||(i=!1)),h&&e.interactiveChildren&&e.children)for(var u=e.children,l=u.length-1;l>=0;l--){var c=u[l],d=this.recursiveFindHit(t,c,r,i,a);if(d){if(!c.parent)continue;a=!1,d&&(t.target&&(i=!1),s=!0)}}return n&&(i&&!t.target&&!e.hitArea&&e.containsPoint&&e.containsPoint(o)&&(s=!0),e.interactive&&(s&&!t.target&&(t.target=e),r&&r(t,e,!!s))),s},t.prototype.findHit=function(t,e,r,i){this.recursiveFindHit(t,e,r,i,!1)},t}(),Or={interactive:!1,interactiveChildren:!0,hitArea:null,get buttonMode(){return"pointer"===this.cursor},set buttonMode(t){t?this.cursor="pointer":"pointer"===this.cursor&&(this.cursor=null)},cursor:null,get trackedPointers(){return void 0===this._trackedPointers&&(this._trackedPointers={}),this._trackedPointers},_trackedPointers:void 0};ur.mixin(Or);var Ir=1,Pr={target:null,data:{global:null}},Mr=function(e){function r(t,r){var i=e.call(this)||this;return r=r||{},i.renderer=t,i.autoPreventDefault=void 0===r.autoPreventDefault||r.autoPreventDefault,i.interactionFrequency=r.interactionFrequency||10,i.mouse=new br,i.mouse.identifier=Ir,i.mouse.global.set(-999999),i.activeInteractionData={},i.activeInteractionData[Ir]=i.mouse,i.interactionDataPool=[],i.eventData=new xr,i.interactionDOMElement=null,i.moveWhenInside=!1,i.eventsAdded=!1,i.tickerAdded=!1,i.mouseOverRenderer=!("PointerEvent"in self),i.supportsTouchEvents="ontouchstart"in self,i.supportsPointerEvents=!!self.PointerEvent,i.onPointerUp=i.onPointerUp.bind(i),i.processPointerUp=i.processPointerUp.bind(i),i.onPointerCancel=i.onPointerCancel.bind(i),i.processPointerCancel=i.processPointerCancel.bind(i),i.onPointerDown=i.onPointerDown.bind(i),i.processPointerDown=i.processPointerDown.bind(i),i.onPointerMove=i.onPointerMove.bind(i),i.processPointerMove=i.processPointerMove.bind(i),i.onPointerOut=i.onPointerOut.bind(i),i.processPointerOverOut=i.processPointerOverOut.bind(i),i.onPointerOver=i.onPointerOver.bind(i),i.cursorStyles={default:"inherit",pointer:"pointer"},i.currentCursorMode=null,i.cursor=null,i.resolution=1,i.delayedEvents=[],i.search=new Sr,i._tempDisplayObject=new lr,i._eventListenerOptions={capture:!0,passive:!1},i._useSystemTicker=void 0===r.useSystemTicker||r.useSystemTicker,i.setTargetElement(i.renderer.view,i.renderer.resolution),i}return function(t,e){function r(){this.constructor=t}Rr(t,e),t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)}(r,e),Object.defineProperty(r.prototype,"useSystemTicker",{get:function(){return this._useSystemTicker},set:function(t){this._useSystemTicker=t,t?this.addTickerListener():this.removeTickerListener()},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"lastObjectRendered",{get:function(){return this.renderer._lastObjectRendered||this._tempDisplayObject},enumerable:!1,configurable:!0}),r.prototype.hitTest=function(t,e){return Pr.target=null,Pr.data.global=t,e||(e=this.lastObjectRendered),this.processInteractive(Pr,e,null,!0),Pr.target},r.prototype.setTargetElement=function(t,e){void 0===e&&(e=1),this.removeTickerListener(),this.removeEvents(),this.interactionDOMElement=t,this.resolution=e,this.addEvents(),this.addTickerListener()},r.prototype.addTickerListener=function(){!this.tickerAdded&&this.interactionDOMElement&&this._useSystemTicker&&(gr.system.add(this.tickerUpdate,this,t.UPDATE_PRIORITY.INTERACTION),this.tickerAdded=!0)},r.prototype.removeTickerListener=function(){this.tickerAdded&&(gr.system.remove(this.tickerUpdate,this),this.tickerAdded=!1)},r.prototype.addEvents=function(){if(!this.eventsAdded&&this.interactionDOMElement){var t=this.interactionDOMElement.style;self.navigator.msPointerEnabled?(t.msContentZooming="none",t.msTouchAction="none"):this.supportsPointerEvents&&(t.touchAction="none"),this.supportsPointerEvents?(self.document.addEventListener("pointermove",this.onPointerMove,this._eventListenerOptions),this.interactionDOMElement.addEventListener("pointerdown",this.onPointerDown,this._eventListenerOptions),this.interactionDOMElement.addEventListener("pointerleave",this.onPointerOut,this._eventListenerOptions),this.interactionDOMElement.addEventListener("pointerover",this.onPointerOver,this._eventListenerOptions),self.addEventListener("pointercancel",this.onPointerCancel,this._eventListenerOptions),self.addEventListener("pointerup",this.onPointerUp,this._eventListenerOptions)):(self.document.addEventListener("mousemove",this.onPointerMove,this._eventListenerOptions),this.interactionDOMElement.addEventListener("mousedown",this.onPointerDown,this._eventListenerOptions),this.interactionDOMElement.addEventListener("mouseout",this.onPointerOut,this._eventListenerOptions),this.interactionDOMElement.addEventListener("mouseover",this.onPointerOver,this._eventListenerOptions),self.addEventListener("mouseup",this.onPointerUp,this._eventListenerOptions)),this.supportsTouchEvents&&(this.interactionDOMElement.addEventListener("touchstart",this.onPointerDown,this._eventListenerOptions),this.interactionDOMElement.addEventListener("touchcancel",this.onPointerCancel,this._eventListenerOptions),this.interactionDOMElement.addEventListener("touchend",this.onPointerUp,this._eventListenerOptions),this.interactionDOMElement.addEventListener("touchmove",this.onPointerMove,this._eventListenerOptions)),this.eventsAdded=!0}},r.prototype.removeEvents=function(){if(this.eventsAdded&&this.interactionDOMElement){var t=this.interactionDOMElement.style;self.navigator.msPointerEnabled?(t.msContentZooming="",t.msTouchAction=""):this.supportsPointerEvents&&(t.touchAction=""),this.supportsPointerEvents?(self.document.removeEventListener("pointermove",this.onPointerMove,this._eventListenerOptions),this.interactionDOMElement.removeEventListener("pointerdown",this.onPointerDown,this._eventListenerOptions),this.interactionDOMElement.removeEventListener("pointerleave",this.onPointerOut,this._eventListenerOptions),this.interactionDOMElement.removeEventListener("pointerover",this.onPointerOver,this._eventListenerOptions),self.removeEventListener("pointercancel",this.onPointerCancel,this._eventListenerOptions),self.removeEventListener("pointerup",this.onPointerUp,this._eventListenerOptions)):(self.document.removeEventListener("mousemove",this.onPointerMove,this._eventListenerOptions),this.interactionDOMElement.removeEventListener("mousedown",this.onPointerDown,this._eventListenerOptions),this.interactionDOMElement.removeEventListener("mouseout",this.onPointerOut,this._eventListenerOptions),this.interactionDOMElement.removeEventListener("mouseover",this.onPointerOver,this._eventListenerOptions),self.removeEventListener("mouseup",this.onPointerUp,this._eventListenerOptions)),this.supportsTouchEvents&&(this.interactionDOMElement.removeEventListener("touchstart",this.onPointerDown,this._eventListenerOptions),this.interactionDOMElement.removeEventListener("touchcancel",this.onPointerCancel,this._eventListenerOptions),this.interactionDOMElement.removeEventListener("touchend",this.onPointerUp,this._eventListenerOptions),this.interactionDOMElement.removeEventListener("touchmove",this.onPointerMove,this._eventListenerOptions)),this.interactionDOMElement=null,this.eventsAdded=!1}},r.prototype.tickerUpdate=function(t){this._deltaTime+=t,this._deltaTime<this.interactionFrequency||(this._deltaTime=0,this.update())},r.prototype.update=function(){if(this.interactionDOMElement)if(this._didMove)this._didMove=!1;else{for(var t in this.cursor=null,this.activeInteractionData)if(this.activeInteractionData.hasOwnProperty(t)){var e=this.activeInteractionData[t];if(e.originalEvent&&"touch"!==e.pointerType){var r=this.configureInteractionEventForDOMEvent(this.eventData,e.originalEvent,e);this.processInteractive(r,this.lastObjectRendered,this.processPointerOverOut,!0)}}this.setCursorMode(this.cursor)}},r.prototype.setCursorMode=function(t){t=t||"default";var e=!0;if(self.OffscreenCanvas&&this.interactionDOMElement instanceof OffscreenCanvas&&(e=!1),this.currentCursorMode!==t){this.currentCursorMode=t;var r=this.cursorStyles[t];if(r)switch(typeof r){case"string":e&&(this.interactionDOMElement.style.cursor=r);break;case"function":r(t);break;case"object":e&&Object.assign(this.interactionDOMElement.style,r)}else e&&"string"==typeof t&&!Object.prototype.hasOwnProperty.call(this.cursorStyles,t)&&(this.interactionDOMElement.style.cursor=t)}},r.prototype.dispatchEvent=function(t,e,r){r.stopPropagationHint&&t!==r.stopsPropagatingAt||(r.currentTarget=t,r.type=e,t.emit(e,r),t[e]&&t[e](r))},r.prototype.delayDispatchEvent=function(t,e,r){this.delayedEvents.push({displayObject:t,eventString:e,eventData:r})},r.prototype.mapPositionToPoint=function(t,e,r){var i;i=this.interactionDOMElement.parentElement?this.interactionDOMElement.getBoundingClientRect():{x:0,y:0,width:this.interactionDOMElement.width,height:this.interactionDOMElement.height,left:0,top:0};var n=1/this.resolution;t.x=(e-i.left)*(this.interactionDOMElement.width/i.width)*n,t.y=(r-i.top)*(this.interactionDOMElement.height/i.height)*n},r.prototype.processInteractive=function(t,e,r,i){var n=this.search.findHit(t,e,r,i),o=this.delayedEvents;if(!o.length)return n;t.stopPropagationHint=!1;var s=o.length;this.delayedEvents=[];for(var a=0;a<s;a++){var h=o[a],u=h.displayObject,l=h.eventString,c=h.eventData;c.stopsPropagatingAt===u&&(c.stopPropagationHint=!0),this.dispatchEvent(u,l,c)}return n},r.prototype.onPointerDown=function(t){if(!this.supportsTouchEvents||"touch"!==t.pointerType){var e=this.normalizeToPointerData(t);this.autoPreventDefault&&e[0].isNormalized&&(t.cancelable||!("cancelable"in t))&&t.preventDefault();for(var r=e.length,i=0;i<r;i++){var n=e[i],o=this.getInteractionDataForPointerId(n),s=this.configureInteractionEventForDOMEvent(this.eventData,n,o);if(s.data.originalEvent=t,this.processInteractive(s,this.lastObjectRendered,this.processPointerDown,!0),this.emit("pointerdown",s),"touch"===n.pointerType)this.emit("touchstart",s);else if("mouse"===n.pointerType||"pen"===n.pointerType){var a=2===n.button;this.emit(a?"rightdown":"mousedown",this.eventData)}}}},r.prototype.processPointerDown=function(t,e,r){var i=t.data,n=t.data.identifier;if(r)if(e.trackedPointers[n]||(e.trackedPointers[n]=new Ar(n)),this.dispatchEvent(e,"pointerdown",t),"touch"===i.pointerType)this.dispatchEvent(e,"touchstart",t);else if("mouse"===i.pointerType||"pen"===i.pointerType){var o=2===i.button;o?e.trackedPointers[n].rightDown=!0:e.trackedPointers[n].leftDown=!0,this.dispatchEvent(e,o?"rightdown":"mousedown",t)}},r.prototype.onPointerComplete=function(t,e,r){for(var i=this.normalizeToPointerData(t),n=i.length,o=t.target!==this.interactionDOMElement?"outside":"",s=0;s<n;s++){var a=i[s],h=this.getInteractionDataForPointerId(a),u=this.configureInteractionEventForDOMEvent(this.eventData,a,h);if(u.data.originalEvent=t,this.processInteractive(u,this.lastObjectRendered,r,e||!o),this.emit(e?"pointercancel":"pointerup"+o,u),"mouse"===a.pointerType||"pen"===a.pointerType){var l=2===a.button;this.emit(l?"rightup"+o:"mouseup"+o,u)}else"touch"===a.pointerType&&(this.emit(e?"touchcancel":"touchend"+o,u),this.releaseInteractionDataForPointerId(a.pointerId))}},r.prototype.onPointerCancel=function(t){this.supportsTouchEvents&&"touch"===t.pointerType||this.onPointerComplete(t,!0,this.processPointerCancel)},r.prototype.processPointerCancel=function(t,e){var r=t.data,i=t.data.identifier;void 0!==e.trackedPointers[i]&&(delete e.trackedPointers[i],this.dispatchEvent(e,"pointercancel",t),"touch"===r.pointerType&&this.dispatchEvent(e,"touchcancel",t))},r.prototype.onPointerUp=function(t){this.supportsTouchEvents&&"touch"===t.pointerType||this.onPointerComplete(t,!1,this.processPointerUp)},r.prototype.processPointerUp=function(t,e,r){var i=t.data,n=t.data.identifier,o=e.trackedPointers[n],s="touch"===i.pointerType,a="mouse"===i.pointerType||"pen"===i.pointerType,h=!1;if(a){var u=2===i.button,l=Ar.FLAGS,c=u?l.RIGHT_DOWN:l.LEFT_DOWN,d=void 0!==o&&o.flags&c;r?(this.dispatchEvent(e,u?"rightup":"mouseup",t),d&&(this.dispatchEvent(e,u?"rightclick":"click",t),h=!0)):d&&this.dispatchEvent(e,u?"rightupoutside":"mouseupoutside",t),o&&(u?o.rightDown=!1:o.leftDown=!1)}r?(this.dispatchEvent(e,"pointerup",t),s&&this.dispatchEvent(e,"touchend",t),o&&(a&&!h||this.dispatchEvent(e,"pointertap",t),s&&(this.dispatchEvent(e,"tap",t),o.over=!1))):o&&(this.dispatchEvent(e,"pointerupoutside",t),s&&this.dispatchEvent(e,"touchendoutside",t)),o&&o.none&&delete e.trackedPointers[n]},r.prototype.onPointerMove=function(t){if(!this.supportsTouchEvents||"touch"!==t.pointerType){var e=this.normalizeToPointerData(t);"mouse"!==e[0].pointerType&&"pen"!==e[0].pointerType||(this._didMove=!0,this.cursor=null);for(var r=e.length,i=0;i<r;i++){var n=e[i],o=this.getInteractionDataForPointerId(n),s=this.configureInteractionEventForDOMEvent(this.eventData,n,o);s.data.originalEvent=t,this.processInteractive(s,this.lastObjectRendered,this.processPointerMove,!0),this.emit("pointermove",s),"touch"===n.pointerType&&this.emit("touchmove",s),"mouse"!==n.pointerType&&"pen"!==n.pointerType||this.emit("mousemove",s)}"mouse"===e[0].pointerType&&this.setCursorMode(this.cursor)}},r.prototype.processPointerMove=function(t,e,r){var i=t.data,n="touch"===i.pointerType,o="mouse"===i.pointerType||"pen"===i.pointerType;o&&this.processPointerOverOut(t,e,r),this.moveWhenInside&&!r||(this.dispatchEvent(e,"pointermove",t),n&&this.dispatchEvent(e,"touchmove",t),o&&this.dispatchEvent(e,"mousemove",t))},r.prototype.onPointerOut=function(t){if(!this.supportsTouchEvents||"touch"!==t.pointerType){var e=this.normalizeToPointerData(t)[0];"mouse"===e.pointerType&&(this.mouseOverRenderer=!1,this.setCursorMode(null));var r=this.getInteractionDataForPointerId(e),i=this.configureInteractionEventForDOMEvent(this.eventData,e,r);i.data.originalEvent=e,this.processInteractive(i,this.lastObjectRendered,this.processPointerOverOut,!1),this.emit("pointerout",i),"mouse"===e.pointerType||"pen"===e.pointerType?this.emit("mouseout",i):this.releaseInteractionDataForPointerId(r.identifier)}},r.prototype.processPointerOverOut=function(t,e,r){var i=t.data,n=t.data.identifier,o="mouse"===i.pointerType||"pen"===i.pointerType,s=e.trackedPointers[n];r&&!s&&(s=e.trackedPointers[n]=new Ar(n)),void 0!==s&&(r&&this.mouseOverRenderer?(s.over||(s.over=!0,this.delayDispatchEvent(e,"pointerover",t),o&&this.delayDispatchEvent(e,"mouseover",t)),o&&null===this.cursor&&(this.cursor=e.cursor)):s.over&&(s.over=!1,this.dispatchEvent(e,"pointerout",this.eventData),o&&this.dispatchEvent(e,"mouseout",t),s.none&&delete e.trackedPointers[n]))},r.prototype.onPointerOver=function(t){var e=this.normalizeToPointerData(t)[0],r=this.getInteractionDataForPointerId(e),i=this.configureInteractionEventForDOMEvent(this.eventData,e,r);i.data.originalEvent=e,"mouse"===e.pointerType&&(this.mouseOverRenderer=!0),this.emit("pointerover",i),"mouse"!==e.pointerType&&"pen"!==e.pointerType||this.emit("mouseover",i)},r.prototype.getInteractionDataForPointerId=function(t){var e,r=t.pointerId;return r===Ir||"mouse"===t.pointerType?e=this.mouse:this.activeInteractionData[r]?e=this.activeInteractionData[r]:((e=this.interactionDataPool.pop()||new br).identifier=r,this.activeInteractionData[r]=e),e.copyEvent(t),e},r.prototype.releaseInteractionDataForPointerId=function(t){var e=this.activeInteractionData[t];e&&(delete this.activeInteractionData[t],e.reset(),this.interactionDataPool.push(e))},r.prototype.configureInteractionEventForDOMEvent=function(t,e,r){return t.data=r,this.mapPositionToPoint(r.global,e.clientX,e.clientY),"touch"===e.pointerType&&(e.globalX=r.global.x,e.globalY=r.global.y),r.originalEvent=e,t.reset(),t},r.prototype.normalizeToPointerData=function(t){var e=[];if(this.supportsTouchEvents&&t instanceof TouchEvent)for(var r=0,i=t.changedTouches.length;r<i;r++){var n=t.changedTouches[r];void 0===n.button&&(n.button=t.touches.length?1:0),void 0===n.buttons&&(n.buttons=t.touches.length?1:0),void 0===n.isPrimary&&(n.isPrimary=1===t.touches.length&&"touchstart"===t.type),void 0===n.width&&(n.width=n.radiusX||1),void 0===n.height&&(n.height=n.radiusY||1),void 0===n.tiltX&&(n.tiltX=0),void 0===n.tiltY&&(n.tiltY=0),void 0===n.pointerType&&(n.pointerType="touch"),void 0===n.pointerId&&(n.pointerId=n.identifier||0),void 0===n.pressure&&(n.pressure=n.force||.5),void 0===n.twist&&(n.twist=0),void 0===n.tangentialPressure&&(n.tangentialPressure=0),void 0===n.layerX&&(n.layerX=n.offsetX=n.clientX),void 0===n.layerY&&(n.layerY=n.offsetY=n.clientY),n.isNormalized=!0,e.push(n)}else if(!self.MouseEvent||t instanceof MouseEvent&&!(this.supportsPointerEvents&&t instanceof self.PointerEvent)){var o=t;void 0===o.isPrimary&&(o.isPrimary=!0),void 0===o.width&&(o.width=1),void 0===o.height&&(o.height=1),void 0===o.tiltX&&(o.tiltX=0),void 0===o.tiltY&&(o.tiltY=0),void 0===o.pointerType&&(o.pointerType="mouse"),void 0===o.pointerId&&(o.pointerId=Ir),void 0===o.pressure&&(o.pressure=.5),void 0===o.twist&&(o.twist=0),void 0===o.tangentialPressure&&(o.tangentialPressure=0),o.isNormalized=!0,e.push(o)}else e.push(t);return e},r.prototype.destroy=function(){this.removeEvents(),this.removeTickerListener(),this.removeAllListeners(),this.renderer=null,this.mouse=null,this.eventData=null,this.interactionDOMElement=null,this.onPointerDown=null,this.processPointerDown=null,this.onPointerUp=null,this.processPointerUp=null,this.onPointerCancel=null,this.processPointerCancel=null,this.onPointerMove=null,this.processPointerMove=null,this.onPointerOut=null,this.processPointerOverOut=null,this.onPointerOver=null,this.search=null},r}(ot),Dr=function(){function t(t){this.items=[],this._name=t,this._aliasCount=0}return t.prototype.emit=function(t,e,r,i,n,o,s,a){if(arguments.length>8)throw new Error("max arguments reached");var h=this.name,u=this.items;this._aliasCount++;for(var l=0,c=u.length;l<c;l++)u[l][h](t,e,r,i,n,o,s,a);return u===this.items&&this._aliasCount--,this},t.prototype.ensureNonAliasedItems=function(){this._aliasCount>0&&this.items.length>1&&(this._aliasCount=0,this.items=this.items.slice(0))},t.prototype.add=function(t){return t[this._name]&&(this.ensureNonAliasedItems(),this.remove(t),this.items.push(t)),this},t.prototype.remove=function(t){var e=this.items.indexOf(t);return-1!==e&&(this.ensureNonAliasedItems(),this.items.splice(e,1)),this},t.prototype.contains=function(t){return-1!==this.items.indexOf(t)},t.prototype.removeAll=function(){return this.ensureNonAliasedItems(),this.items.length=0,this},t.prototype.destroy=function(){this.removeAll(),this.items=null,this._name=null},Object.defineProperty(t.prototype,"empty",{get:function(){return 0===this.items.length},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"name",{get:function(){return this._name},enumerable:!1,configurable:!0}),t}();Object.defineProperties(Dr.prototype,{dispatch:{value:Dr.prototype.emit},run:{value:Dr.prototype.emit}}),rt.PREFER_ENV=et.any?t.ENV.WEBGL:t.ENV.WEBGL2,rt.STRICT_TEXTURE_CACHE=!1;var Nr=[];function wr(t,e){if(!t)return null;var r="";if("string"==typeof t){var i=/\.(\w{3,4})(?:$|\?|#)/i.exec(t);i&&(r=i[1].toLowerCase())}for(var n=Nr.length-1;n>=0;--n){var o=Nr[n];if(o.test&&o.test(t,r))return new o(t,e)}throw new Error("Unrecognized source type to auto-detect Resource")}var Cr=function(t,e){return(Cr=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r])})(t,e)};function Lr(t,e){function r(){this.constructor=t}Cr(t,e),t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)}var Fr=function(){return(Fr=Object.assign||function(t){for(var e,r=arguments,i=1,n=arguments.length;i<n;i++)for(var o in e=r[i])Object.prototype.hasOwnProperty.call(e,o)&&(t[o]=e[o]);return t}).apply(this,arguments)},Ur=function(){function t(t,e){void 0===t&&(t=0),void 0===e&&(e=0),this._width=t,this._height=e,this.destroyed=!1,this.internal=!1,this.onResize=new Dr("setRealSize"),this.onUpdate=new Dr("update"),this.onError=new Dr("onError")}return t.prototype.bind=function(t){this.onResize.add(t),this.onUpdate.add(t),this.onError.add(t),(this._width||this._height)&&this.onResize.emit(this._width,this._height)},t.prototype.unbind=function(t){this.onResize.remove(t),this.onUpdate.remove(t),this.onError.remove(t)},t.prototype.resize=function(t,e){t===this._width&&e===this._height||(this._width=t,this._height=e,this.onResize.emit(t,e))},Object.defineProperty(t.prototype,"valid",{get:function(){return!!this._width&&!!this._height},enumerable:!1,configurable:!0}),t.prototype.update=function(){this.destroyed||this.onUpdate.emit()},t.prototype.load=function(){return Promise.resolve(this)},Object.defineProperty(t.prototype,"width",{get:function(){return this._width},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"height",{get:function(){return this._height},enumerable:!1,configurable:!0}),t.prototype.style=function(t,e,r){return!1},t.prototype.dispose=function(){},t.prototype.destroy=function(){this.destroyed||(this.destroyed=!0,this.dispose(),this.onError.removeAll(),this.onError=null,this.onResize.removeAll(),this.onResize=null,this.onUpdate.removeAll(),this.onUpdate=null)},t.test=function(t,e){return!1},t}(),Br=function(e){function r(t,r){var i=this,n=r||{},o=n.width,s=n.height;if(!o||!s)throw new Error("BufferResource width or height invalid");return(i=e.call(this,o,s)||this).data=t,i}return Lr(r,e),r.prototype.upload=function(e,r,i){var n=e.gl;n.pixelStorei(n.UNPACK_PREMULTIPLY_ALPHA_WEBGL,r.alphaMode===t.ALPHA_MODES.UNPACK);var o=r.realWidth,s=r.realHeight;return i.width===o&&i.height===s?n.texSubImage2D(r.target,0,0,0,o,s,r.format,i.type,this.data):(i.width=o,i.height=s,n.texImage2D(r.target,0,i.internalFormat,o,s,0,r.format,i.type,this.data)),!0},r.prototype.dispose=function(){this.data=null},r.test=function(t){return t instanceof Float32Array||t instanceof Uint8Array||t instanceof Uint32Array},r}(Ur),Gr={scaleMode:t.SCALE_MODES.NEAREST,format:t.FORMATS.RGBA,alphaMode:t.ALPHA_MODES.NPM},Xr=function(e){function r(r,i){void 0===r&&(r=null),void 0===i&&(i=null);var n=e.call(this)||this,o=(i=i||{}).alphaMode,s=i.mipmap,a=i.anisotropicLevel,h=i.scaleMode,u=i.width,l=i.height,c=i.wrapMode,d=i.format,f=i.type,p=i.target,_=i.resolution,m=i.resourceOptions;return!r||r instanceof Ur||((r=wr(r,m)).internal=!0),n.resolution=_||rt.RESOLUTION,n.width=Math.round((u||0)*n.resolution)/n.resolution,n.height=Math.round((l||0)*n.resolution)/n.resolution,n._mipmap=void 0!==s?s:rt.MIPMAP_TEXTURES,n.anisotropicLevel=void 0!==a?a:rt.ANISOTROPIC_LEVEL,n._wrapMode=c||rt.WRAP_MODE,n._scaleMode=void 0!==h?h:rt.SCALE_MODE,n.format=d||t.FORMATS.RGBA,n.type=f||t.TYPES.UNSIGNED_BYTE,n.target=p||t.TARGETS.TEXTURE_2D,n.alphaMode=void 0!==o?o:t.ALPHA_MODES.UNPACK,n.uid=Ie(),n.touched=0,n.isPowerOfTwo=!1,n._refreshPOT(),n._glTextures={},n.dirtyId=0,n.dirtyStyleId=0,n.cacheId=null,n.valid=u>0&&l>0,n.textureCacheIds=[],n.destroyed=!1,n.resource=null,n._batchEnabled=0,n._batchLocation=0,n.parentTextureArray=null,n.setResource(r),n}return Lr(r,e),Object.defineProperty(r.prototype,"realWidth",{get:function(){return Math.round(this.width*this.resolution)},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"realHeight",{get:function(){return Math.round(this.height*this.resolution)},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"mipmap",{get:function(){return this._mipmap},set:function(t){this._mipmap!==t&&(this._mipmap=t,this.dirtyStyleId++)},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"scaleMode",{get:function(){return this._scaleMode},set:function(t){this._scaleMode!==t&&(this._scaleMode=t,this.dirtyStyleId++)},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"wrapMode",{get:function(){return this._wrapMode},set:function(t){this._wrapMode!==t&&(this._wrapMode=t,this.dirtyStyleId++)},enumerable:!1,configurable:!0}),r.prototype.setStyle=function(t,e){var r;return void 0!==t&&t!==this.scaleMode&&(this.scaleMode=t,r=!0),void 0!==e&&e!==this.mipmap&&(this.mipmap=e,r=!0),r&&this.dirtyStyleId++,this},r.prototype.setSize=function(t,e,r){return r=r||this.resolution,this.setRealSize(t*r,e*r,r)},r.prototype.setRealSize=function(t,e,r){return this.resolution=r||this.resolution,this.width=Math.round(t)/this.resolution,this.height=Math.round(e)/this.resolution,this._refreshPOT(),this.update(),this},r.prototype._refreshPOT=function(){this.isPowerOfTwo=Re(this.realWidth)&&Re(this.realHeight)},r.prototype.setResolution=function(t){var e=this.resolution;return e===t?this:(this.resolution=t,this.valid&&(this.width=Math.round(this.width*e)/t,this.height=Math.round(this.height*e)/t,this.emit("update",this)),this._refreshPOT(),this)},r.prototype.setResource=function(t){if(this.resource===t)return this;if(this.resource)throw new Error("Resource can be set only once");return t.bind(this),this.resource=t,this},r.prototype.update=function(){this.valid?(this.dirtyId++,this.dirtyStyleId++,this.emit("update",this)):this.width>0&&this.height>0&&(this.valid=!0,this.emit("loaded",this),this.emit("update",this))},r.prototype.onError=function(t){this.emit("error",this,t)},r.prototype.destroy=function(){this.resource&&(this.resource.unbind(this),this.resource.internal&&this.resource.destroy(),this.resource=null),this.cacheId&&(delete Ne[this.cacheId],delete De[this.cacheId],this.cacheId=null),this.dispose(),r.removeFromCache(this),this.textureCacheIds=null,this.destroyed=!0},r.prototype.dispose=function(){this.emit("dispose",this)},r.prototype.castToBaseTexture=function(){return this},r.from=function(t,e,i){void 0===i&&(i=rt.STRICT_TEXTURE_CACHE);var n="string"==typeof t,o=null;if(n)o=t;else{if(!t._pixiId){var s=e&&e.pixiIdPrefix||"pixiid";t._pixiId=s+"_"+Ie()}o=t._pixiId}var a=Ne[o];if(n&&i&&!a)throw new Error('The cacheId "'+o+'" does not exist in BaseTextureCache.');return a||((a=new r(t,e)).cacheId=o,r.addToCache(a,o)),a},r.fromBuffer=function(e,i,n,o){e=e||new Float32Array(i*n*4);var s=new Br(e,{width:i,height:n}),a=e instanceof Float32Array?t.TYPES.FLOAT:t.TYPES.UNSIGNED_BYTE;return new r(s,Object.assign(Gr,o||{width:i,height:n,type:a}))},r.addToCache=function(t,e){e&&(-1===t.textureCacheIds.indexOf(e)&&t.textureCacheIds.push(e),Ne[e]&&console.warn("BaseTexture added to the cache with an id ["+e+"] that already had an entry"),Ne[e]=t)},r.removeFromCache=function(t){if("string"==typeof t){var e=Ne[t];if(e){var r=e.textureCacheIds.indexOf(t);return r>-1&&e.textureCacheIds.splice(r,1),delete Ne[t],e}}else if(t&&t.textureCacheIds){for(var i=0;i<t.textureCacheIds.length;++i)delete Ne[t.textureCacheIds[i]];return t.textureCacheIds.length=0,t}return null},r._globalBatch=0,r}(ot),kr=function(t){function e(e,r){var i=this,n=r||{},o=n.width,s=n.height;(i=t.call(this,o,s)||this).items=[],i.itemDirtyIds=[];for(var a=0;a<e;a++){var h=new Xr;i.items.push(h),i.itemDirtyIds.push(-2)}return i.length=e,i._load=null,i.baseTexture=null,i}return Lr(e,t),e.prototype.initFromArray=function(t,e){for(var r=0;r<this.length;r++)t[r]&&(t[r].castToBaseTexture?this.addBaseTextureAt(t[r].castToBaseTexture(),r):t[r]instanceof Ur?this.addResourceAt(t[r],r):this.addResourceAt(wr(t[r],e),r))},e.prototype.dispose=function(){for(var t=0,e=this.length;t<e;t++)this.items[t].destroy();this.items=null,this.itemDirtyIds=null,this._load=null},e.prototype.addResourceAt=function(t,e){if(!this.items[e])throw new Error("Index "+e+" is out of bounds");return t.valid&&!this.valid&&this.resize(t.width,t.height),this.items[e].setResource(t),this},e.prototype.bind=function(e){if(null!==this.baseTexture)throw new Error("Only one base texture per TextureArray is allowed");t.prototype.bind.call(this,e);for(var r=0;r<this.length;r++)this.items[r].parentTextureArray=e,this.items[r].on("update",e.update,e)},e.prototype.unbind=function(e){t.prototype.unbind.call(this,e);for(var r=0;r<this.length;r++)this.items[r].parentTextureArray=null,this.items[r].off("update",e.update,e)},e.prototype.load=function(){var t=this;if(this._load)return this._load;var e=this.items.map(function(t){return t.resource}).filter(function(t){return t}).map(function(t){return t.load()});return this._load=Promise.all(e).then(function(){var e=t.items[0],r=e.realWidth,i=e.realHeight;return t.resize(r,i),Promise.resolve(t)}),this._load},e}(Ur),Hr=function(e){function r(t,r){var i,n,o=this,s=r||{},a=s.width,h=s.height;return Array.isArray(t)?(i=t,n=t.length):n=t,o=e.call(this,n,{width:a,height:h})||this,i&&o.initFromArray(i,r),o}return Lr(r,e),r.prototype.addBaseTextureAt=function(t,e){if(!t.resource)throw new Error("ArrayResource does not support RenderTexture");return this.addResourceAt(t.resource,e),this},r.prototype.bind=function(r){e.prototype.bind.call(this,r),r.target=t.TARGETS.TEXTURE_2D_ARRAY},r.prototype.upload=function(t,e,r){var i=this.length,n=this.itemDirtyIds,o=this.items,s=t.gl;r.dirtyId<0&&s.texImage3D(s.TEXTURE_2D_ARRAY,0,r.internalFormat,this._width,this._height,i,0,e.format,r.type,null);for(var a=0;a<i;a++){var h=o[a];n[a]<h.dirtyId&&(n[a]=h.dirtyId,h.valid&&s.texSubImage3D(s.TEXTURE_2D_ARRAY,0,0,0,a,h.resource.width,h.resource.height,1,e.format,r.type,h.resource.source))}return!0},r}(kr),Yr=function(e){function r(t){var r=this,i=t,n=i.naturalWidth||i.videoWidth||i.width,o=i.naturalHeight||i.videoHeight||i.height;return(r=e.call(this,n,o)||this).source=t,r.noSubImage=!1,r}return Lr(r,e),r.crossOrigin=function(t,e,r){void 0===r&&0!==e.indexOf("data:")?t.crossOrigin=Ue(e):!1!==r&&(t.crossOrigin="string"==typeof r?r:"anonymous")},r.prototype.upload=function(e,r,i,n){var o=e.gl,s=r.realWidth,a=r.realHeight;return n=n||this.source,o.pixelStorei(o.UNPACK_PREMULTIPLY_ALPHA_WEBGL,r.alphaMode===t.ALPHA_MODES.UNPACK),this.noSubImage||r.target!==o.TEXTURE_2D||i.width!==s||i.height!==a?(i.width=s,i.height=a,o.texImage2D(r.target,0,i.internalFormat,r.format,i.type,n)):o.texSubImage2D(o.TEXTURE_2D,0,0,0,r.format,i.type,n),!0},r.prototype.update=function(){if(!this.destroyed){var t=this.source,r=t.naturalWidth||t.videoWidth||t.width,i=t.naturalHeight||t.videoHeight||t.height;this.resize(r,i),e.prototype.update.call(this)}},r.prototype.dispose=function(){this.source=null},r}(Ur),jr=function(t){function e(e){return t.call(this,e)||this}return Lr(e,t),e.test=function(t){var e=self.OffscreenCanvas;return!!(e&&t instanceof e)||self.HTMLCanvasElement&&t instanceof HTMLCanvasElement},e}(Yr),Vr=function(e){function r(i,n){var o=this,s=n||{},a=s.width,h=s.height,u=s.autoLoad,l=s.linkBaseTexture;if(i&&i.length!==r.SIDES)throw new Error("Invalid length. Got "+i.length+", expected 6");o=e.call(this,6,{width:a,height:h})||this;for(var c=0;c<r.SIDES;c++)o.items[c].target=t.TARGETS.TEXTURE_CUBE_MAP_POSITIVE_X+c;return o.linkBaseTexture=!1!==l,i&&o.initFromArray(i,n),!1!==u&&o.load(),o}return Lr(r,e),r.prototype.bind=function(r){e.prototype.bind.call(this,r),r.target=t.TARGETS.TEXTURE_CUBE_MAP},r.prototype.addBaseTextureAt=function(e,r,i){if(void 0===i&&(i=this.linkBaseTexture),!this.items[r])throw new Error("Index "+r+" is out of bounds");if(!this.linkBaseTexture||e.parentTextureArray||Object.keys(e._glTextures).length>0){if(!e.resource)throw new Error("CubeResource does not support copying of renderTexture.");this.addResourceAt(e.resource,r)}else e.target=t.TARGETS.TEXTURE_CUBE_MAP_POSITIVE_X+r,e.parentTextureArray=this.baseTexture,this.items[r]=e;return e.valid&&!this.valid&&this.resize(e.realWidth,e.realHeight),this.items[r]=e,this},r.prototype.upload=function(t,e,i){for(var n=this.itemDirtyIds,o=0;o<r.SIDES;o++){var s=this.items[o];n[o]<s.dirtyId&&(s.valid&&s.resource?(s.resource.upload(t,s,i),n[o]=s.dirtyId):n[o]<-1&&(t.gl.texImage2D(s.target,0,i.internalFormat,e.realWidth,e.realHeight,0,e.format,i.type,null),n[o]=-1))}return!0},r.test=function(t){return Array.isArray(t)&&t.length===r.SIDES},r.SIDES=6,r}(kr),Wr=function(e){function r(t,r){var i=this;if(r=r||{},!(t instanceof HTMLImageElement)){var n=new Image;Yr.crossOrigin(n,t,r.crossorigin),n.src=t,t=n}return i=e.call(this,t)||this,!t.complete&&i._width&&i._height&&(i._width=0,i._height=0),i.url=t.src,i._process=null,i.preserveBitmap=!1,i.createBitmap=(void 0!==r.createBitmap?r.createBitmap:rt.CREATE_IMAGE_BITMAP)&&!!self.createImageBitmap,i.alphaMode="number"==typeof r.alphaMode?r.alphaMode:null,i.bitmap=null,i._load=null,!1!==r.autoLoad&&i.load(),i}return Lr(r,e),r.prototype.load=function(t){var e=this;return this._load?this._load:(void 0!==t&&(this.createBitmap=t),this._load=new Promise(function(t,r){var i=e.source;e.url=i.src;var n=function(){e.destroyed||(i.onload=null,i.onerror=null,e.resize(i.width,i.height),e._load=null,e.createBitmap?t(e.process()):t(e))};i.complete&&i.src?n():(i.onload=n,i.onerror=function(t){r(t),e.onError.emit(t)})}),this._load)},r.prototype.process=function(){var e=this,r=this.source;if(null!==this._process)return this._process;if(null!==this.bitmap||!self.createImageBitmap)return Promise.resolve(this);var i=self.createImageBitmap,n=!r.crossOrigin||"anonymous"===r.crossOrigin;return this._process=fetch(r.src,{mode:n?"cors":"no-cors"}).then(function(t){return t.blob()}).then(function(n){return i(n,0,0,r.width,r.height,{premultiplyAlpha:e.alphaMode===t.ALPHA_MODES.UNPACK?"premultiply":"none"})}).then(function(t){return e.destroyed?Promise.reject():(e.bitmap=t,e.update(),e._process=null,Promise.resolve(e))}),this._process},r.prototype.upload=function(t,r,i){if("number"==typeof this.alphaMode&&(r.alphaMode=this.alphaMode),!this.createBitmap)return e.prototype.upload.call(this,t,r,i);if(!this.bitmap&&(this.process(),!this.bitmap))return!1;if(e.prototype.upload.call(this,t,r,i,this.bitmap),!this.preserveBitmap){var n=!0,o=r._glTextures;for(var s in o){var a=o[s];if(a!==i&&a.dirtyId!==r.dirtyId){n=!1;break}}n&&(this.bitmap.close&&this.bitmap.close(),this.bitmap=null)}return!0},r.prototype.dispose=function(){this.source.onload=null,this.source.onerror=null,e.prototype.dispose.call(this),this.bitmap&&(this.bitmap.close(),this.bitmap=null),this._process=null,this._load=null},r.test=function(t){return"string"==typeof t||t instanceof HTMLImageElement},r}(Yr),zr=function(t){function e(e,r){var i=this;return r=r||{},(i=t.call(this,document.createElement("canvas"))||this)._width=0,i._height=0,i.svg=e,i.scale=r.scale||1,i._overrideWidth=r.width,i._overrideHeight=r.height,i._resolve=null,i._crossorigin=r.crossorigin,i._load=null,!1!==r.autoLoad&&i.load(),i}return Lr(e,t),e.prototype.load=function(){var t=this;return this._load?this._load:(this._load=new Promise(function(e){if(t._resolve=function(){t.resize(t.source.width,t.source.height),e(t)},/^\<svg/.test(t.svg.trim())){if(!btoa)throw new Error("Your browser doesn't support base64 conversions.");t.svg="data:image/svg+xml;base64,"+btoa(unescape(encodeURIComponent(t.svg)))}t._loadSvg()}),this._load)},e.prototype._loadSvg=function(){var t=this,e=new Image;Yr.crossOrigin(e,this.svg,this._crossorigin),e.src=this.svg,e.onerror=function(r){t._resolve&&(e.onerror=null,t.onError.emit(r))},e.onload=function(){if(t._resolve){var r=e.width,i=e.height;if(!r||!i)throw new Error("The SVG image must have width and height defined (in pixels), canvas API needs them.");var n=r*t.scale,o=i*t.scale;(t._overrideWidth||t._overrideHeight)&&(n=t._overrideWidth||t._overrideHeight/i*r,o=t._overrideHeight||t._overrideWidth/r*i),n=Math.round(n),o=Math.round(o);var s=t.source;s.width=n,s.height=o,s._pixiId="canvas_"+Ie(),s.getContext("2d").drawImage(e,0,0,r,i,0,0,n,o),t._resolve(),t._resolve=null}}},e.getSize=function(t){var r=e.SVG_SIZE.exec(t),i={};return r&&(i[r[1]]=Math.round(parseFloat(r[3])),i[r[5]]=Math.round(parseFloat(r[7]))),i},e.prototype.dispose=function(){t.prototype.dispose.call(this),this._resolve=null,this._crossorigin=null},e.test=function(t,r){return"svg"===r||"string"==typeof t&&/^data:image\/svg\+xml(;(charset=utf8|utf8))?;base64/.test(t)||"string"==typeof t&&e.SVG_XML.test(t)},e.SVG_XML=/^(<\?xml[^?]+\?>)?\s*(<!--[^(-->)]*-->)?\s*\<svg/m,e.SVG_SIZE=/<svg[^>]*(?:\s(width|height)=('|")(\d*(?:\.\d+)?)(?:px)?('|"))[^>]*(?:\s(width|height)=('|")(\d*(?:\.\d+)?)(?:px)?('|"))[^>]*>/i,e}(Yr),qr=function(t){function e(r,i){var n=this;if(i=i||{},!(r instanceof HTMLVideoElement)){var o=document.createElement("video");o.setAttribute("preload","auto"),o.setAttribute("webkit-playsinline",""),o.setAttribute("playsinline",""),"string"==typeof r&&(r=[r]);var s=r[0].src||r[0];Yr.crossOrigin(o,s,i.crossorigin);for(var a=0;a<r.length;++a){var h=document.createElement("source"),u=r[a],l=u.src,c=u.mime,d=(l=l||r[a]).split("?").shift().toLowerCase(),f=d.substr(d.lastIndexOf(".")+1);c=c||e.MIME_TYPES[f]||"video/"+f,h.src=l,h.type=c,o.appendChild(h)}r=o}return(n=t.call(this,r)||this).noSubImage=!0,n._autoUpdate=!0,n._isConnectedToTicker=!1,n._updateFPS=i.updateFPS||0,n._msToNextUpdate=0,n.autoPlay=!1!==i.autoPlay,n._load=null,n._resolve=null,n._onCanPlay=n._onCanPlay.bind(n),n._onError=n._onError.bind(n),!1!==i.autoLoad&&n.load(),n}return Lr(e,t),e.prototype.update=function(e){if(!this.destroyed){var r=gr.shared.elapsedMS*this.source.playbackRate;this._msToNextUpdate=Math.floor(this._msToNextUpdate-r),(!this._updateFPS||this._msToNextUpdate<=0)&&(t.prototype.update.call(this),this._msToNextUpdate=this._updateFPS?Math.floor(1e3/this._updateFPS):0)}},e.prototype.load=function(){var t=this;if(this._load)return this._load;var e=this.source;return(e.readyState===e.HAVE_ENOUGH_DATA||e.readyState===e.HAVE_FUTURE_DATA)&&e.width&&e.height&&(e.complete=!0),e.addEventListener("play",this._onPlayStart.bind(this)),e.addEventListener("pause",this._onPlayStop.bind(this)),this._isSourceReady()?this._onCanPlay():(e.addEventListener("canplay",this._onCanPlay),e.addEventListener("canplaythrough",this._onCanPlay),e.addEventListener("error",this._onError,!0)),this._load=new Promise(function(r){t.valid?r(t):(t._resolve=r,e.load())}),this._load},e.prototype._onError=function(t){this.source.removeEventListener("error",this._onError,!0),this.onError.emit(t)},e.prototype._isSourcePlaying=function(){var t=this.source;return t.currentTime>0&&!1===t.paused&&!1===t.ended&&t.readyState>2},e.prototype._isSourceReady=function(){var t=this.source;return 3===t.readyState||4===t.readyState},e.prototype._onPlayStart=function(){this.valid||this._onCanPlay(),this.autoUpdate&&!this._isConnectedToTicker&&(gr.shared.add(this.update,this),this._isConnectedToTicker=!0)},e.prototype._onPlayStop=function(){this._isConnectedToTicker&&(gr.shared.remove(this.update,this),this._isConnectedToTicker=!1)},e.prototype._onCanPlay=function(){var t=this.source;t.removeEventListener("canplay",this._onCanPlay),t.removeEventListener("canplaythrough",this._onCanPlay);var e=this.valid;this.resize(t.videoWidth,t.videoHeight),!e&&this._resolve&&(this._resolve(this),this._resolve=null),this._isSourcePlaying()?this._onPlayStart():this.autoPlay&&t.play()},e.prototype.dispose=function(){this._isConnectedToTicker&&(gr.shared.remove(this.update,this),this._isConnectedToTicker=!1);var e=this.source;e&&(e.removeEventListener("error",this._onError,!0),e.pause(),e.src="",e.load()),t.prototype.dispose.call(this)},Object.defineProperty(e.prototype,"autoUpdate",{get:function(){return this._autoUpdate},set:function(t){t!==this._autoUpdate&&(this._autoUpdate=t,!this._autoUpdate&&this._isConnectedToTicker?(gr.shared.remove(this.update,this),this._isConnectedToTicker=!1):this._autoUpdate&&!this._isConnectedToTicker&&this._isSourcePlaying()&&(gr.shared.add(this.update,this),this._isConnectedToTicker=!0))},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"updateFPS",{get:function(){return this._updateFPS},set:function(t){t!==this._updateFPS&&(this._updateFPS=t)},enumerable:!1,configurable:!0}),e.test=function(t,r){return self.HTMLVideoElement&&t instanceof HTMLVideoElement||e.TYPES.indexOf(r)>-1},e.TYPES=["mp4","m4v","webm","ogg","ogv","h264","avi","mov"],e.MIME_TYPES={ogv:"video/ogg",mov:"video/quicktime",m4v:"video/mp4"},e}(Yr),Kr=function(t){function e(e){return t.call(this,e)||this}return Lr(e,t),e.test=function(t){return!!self.createImageBitmap&&t instanceof ImageBitmap},e}(Yr);Nr.push(Wr,Kr,jr,qr,zr,Br,Vr,Hr);var Zr={__proto__:null,Resource:Ur,BaseImageResource:Yr,INSTALLED:Nr,autoDetectResource:wr,AbstractMultiResource:kr,ArrayResource:Hr,BufferResource:Br,CanvasResource:jr,CubeResource:Vr,ImageResource:Wr,SVGResource:zr,VideoResource:qr,ImageBitmapResource:Kr},Qr=function(e){function r(){return null!==e&&e.apply(this,arguments)||this}return Lr(r,e),r.prototype.upload=function(e,r,i){var n=e.gl;n.pixelStorei(n.UNPACK_PREMULTIPLY_ALPHA_WEBGL,r.alphaMode===t.ALPHA_MODES.UNPACK);var o=r.realWidth,s=r.realHeight;return i.width===o&&i.height===s?n.texSubImage2D(r.target,0,0,0,o,s,r.format,i.type,this.data):(i.width=o,i.height=s,n.texImage2D(r.target,0,i.internalFormat,o,s,0,r.format,i.type,this.data)),!0},r}(Br),Jr=function(){function e(e,r){this.width=Math.round(e||100),this.height=Math.round(r||100),this.stencil=!1,this.depth=!1,this.dirtyId=0,this.dirtyFormat=0,this.dirtySize=0,this.depthTexture=null,this.colorTextures=[],this.glFramebuffers={},this.disposeRunner=new Dr("disposeFramebuffer"),this.multisample=t.MSAA_QUALITY.NONE}return Object.defineProperty(e.prototype,"colorTexture",{get:function(){return this.colorTextures[0]},enumerable:!1,configurable:!0}),e.prototype.addColorTexture=function(e,r){return void 0===e&&(e=0),this.colorTextures[e]=r||new Xr(null,{scaleMode:t.SCALE_MODES.NEAREST,resolution:1,mipmap:t.MIPMAP_MODES.OFF,width:this.width,height:this.height}),this.dirtyId++,this.dirtyFormat++,this},e.prototype.addDepthTexture=function(e){return this.depthTexture=e||new Xr(new Qr(null,{width:this.width,height:this.height}),{scaleMode:t.SCALE_MODES.NEAREST,resolution:1,width:this.width,height:this.height,mipmap:t.MIPMAP_MODES.OFF,format:t.FORMATS.DEPTH_COMPONENT,type:t.TYPES.UNSIGNED_SHORT}),this.dirtyId++,this.dirtyFormat++,this},e.prototype.enableDepth=function(){return this.depth=!0,this.dirtyId++,this.dirtyFormat++,this},e.prototype.enableStencil=function(){return this.stencil=!0,this.dirtyId++,this.dirtyFormat++,this},e.prototype.resize=function(t,e){if(t=Math.round(t),e=Math.round(e),t!==this.width||e!==this.height){this.width=t,this.height=e,this.dirtyId++,this.dirtySize++;for(var r=0;r<this.colorTextures.length;r++){var i=this.colorTextures[r],n=i.resolution;i.setSize(t/n,e/n)}this.depthTexture&&(n=this.depthTexture.resolution,this.depthTexture.setSize(t/n,e/n))}},e.prototype.dispose=function(){this.disposeRunner.emit(this,!1)},e.prototype.destroyDepthTexture=function(){this.depthTexture&&(this.depthTexture.destroy(),this.depthTexture=null,++this.dirtyId,++this.dirtyFormat)},e}(),$r=function(e){function r(r){var i=this;return"number"==typeof r&&(r={width:arguments[0],height:arguments[1],scaleMode:arguments[2],resolution:arguments[3]}),r.width=r.width||100,r.height=r.height||100,r.multisample=void 0!==r.multisample?r.multisample:t.MSAA_QUALITY.NONE,(i=e.call(this,null,r)||this).mipmap=t.MIPMAP_MODES.OFF,i.valid=!0,i.clearColor=[0,0,0,0],i.framebuffer=new Jr(i.realWidth,i.realHeight).addColorTexture(0,i),i.framebuffer.multisample=r.multisample,i.maskStack=[],i.filterStack=[{}],i}return Lr(r,e),r.prototype.resize=function(t,e){this.framebuffer.resize(t*this.resolution,e*this.resolution),this.setRealSize(this.framebuffer.width,this.framebuffer.height)},r.prototype.dispose=function(){this.framebuffer.dispose(),e.prototype.dispose.call(this)},r.prototype.destroy=function(){e.prototype.destroy.call(this),this.framebuffer.destroyDepthTexture(),this.framebuffer=null},r}(Xr),ti=function(){function t(){this.x0=0,this.y0=0,this.x1=1,this.y1=0,this.x2=1,this.y2=1,this.x3=0,this.y3=1,this.uvsFloat32=new Float32Array(8)}return t.prototype.set=function(t,e,r){var i=e.width,n=e.height;if(r){var o=t.width/2/i,s=t.height/2/n,a=t.x/i+o,h=t.y/n+s;r=nr.add(r,nr.NW),this.x0=a+o*nr.uX(r),this.y0=h+s*nr.uY(r),r=nr.add(r,2),this.x1=a+o*nr.uX(r),this.y1=h+s*nr.uY(r),r=nr.add(r,2),this.x2=a+o*nr.uX(r),this.y2=h+s*nr.uY(r),r=nr.add(r,2),this.x3=a+o*nr.uX(r),this.y3=h+s*nr.uY(r)}else this.x0=t.x/i,this.y0=t.y/n,this.x1=(t.x+t.width)/i,this.y1=t.y/n,this.x2=(t.x+t.width)/i,this.y2=(t.y+t.height)/n,this.x3=t.x/i,this.y3=(t.y+t.height)/n;this.uvsFloat32[0]=this.x0,this.uvsFloat32[1]=this.y0,this.uvsFloat32[2]=this.x1,this.uvsFloat32[3]=this.y1,this.uvsFloat32[4]=this.x2,this.uvsFloat32[5]=this.y2,this.uvsFloat32[6]=this.x3,this.uvsFloat32[7]=this.y3},t}(),ei=new ti,ri=function(t){function e(r,i,n,o,s,a){var h=t.call(this)||this;if(h.noFrame=!1,i||(h.noFrame=!0,i=new Ye(0,0,1,1)),r instanceof e&&(r=r.baseTexture),h.baseTexture=r,h._frame=i,h.trim=o,h.valid=!1,h._uvs=ei,h.uvMatrix=null,h.orig=n||i,h._rotate=Number(s||0),!0===s)h._rotate=2;else if(h._rotate%2!=0)throw new Error("attempt to use diamond-shaped UVs. If you are sure, set rotation manually");return h.defaultAnchor=a?new qe(a.x,a.y):new qe(0,0),h._updateID=0,h.textureCacheIds=[],r.valid?h.noFrame?r.valid&&h.onBaseTextureUpdated(r):h.frame=i:r.once("loaded",h.onBaseTextureUpdated,h),h.noFrame&&r.on("update",h.onBaseTextureUpdated,h),h}return Lr(e,t),e.prototype.update=function(){this.baseTexture.resource&&this.baseTexture.resource.update()},e.prototype.onBaseTextureUpdated=function(t){if(this.noFrame){if(!this.baseTexture.valid)return;this._frame.width=t.width,this._frame.height=t.height,this.valid=!0,this.updateUvs()}else this.frame=this._frame;this.emit("update",this)},e.prototype.destroy=function(t){if(this.baseTexture){if(t){var r=this.baseTexture.resource;r&&r.url&&De[r.url]&&e.removeFromCache(r.url),this.baseTexture.destroy()}this.baseTexture.off("loaded",this.onBaseTextureUpdated,this),this.baseTexture.off("update",this.onBaseTextureUpdated,this),this.baseTexture=null}this._frame=null,this._uvs=null,this.trim=null,this.orig=null,this.valid=!1,e.removeFromCache(this),this.textureCacheIds=null},e.prototype.clone=function(){var t=this._frame.clone(),r=this._frame===this.orig?t:this.orig.clone(),i=new e(this.baseTexture,!this.noFrame&&t,r,this.trim&&this.trim.clone(),this.rotate,this.defaultAnchor);return this.noFrame&&(i._frame=t),i},e.prototype.updateUvs=function(){this._uvs===ei&&(this._uvs=new ti),this._uvs.set(this._frame,this.baseTexture,this.rotate),this._updateID++},e.from=function(t,r,i){void 0===r&&(r={}),void 0===i&&(i=rt.STRICT_TEXTURE_CACHE);var n="string"==typeof t,o=null;if(n)o=t;else{if(!t._pixiId){var s=r&&r.pixiIdPrefix||"pixiid";t._pixiId=s+"_"+Ie()}o=t._pixiId}var a=De[o];if(n&&i&&!a)throw new Error('The cacheId "'+o+'" does not exist in TextureCache.');return a||(r.resolution||(r.resolution=Be(t)),(a=new e(new Xr(t,r))).baseTexture.cacheId=o,Xr.addToCache(a.baseTexture,o),e.addToCache(a,o)),a},e.fromURL=function(t,r){var i=Object.assign({autoLoad:!1},null==r?void 0:r.resourceOptions),n=e.from(t,Object.assign({resourceOptions:i},r),!1),o=n.baseTexture.resource;return n.baseTexture.valid?Promise.resolve(n):o.load().then(function(){return Promise.resolve(n)})},e.fromBuffer=function(t,r,i,n){return new e(Xr.fromBuffer(t,r,i,n))},e.fromLoader=function(t,r,i,n){var o=new Xr(t,Object.assign({scaleMode:rt.SCALE_MODE,resolution:Be(r)},n)),s=o.resource;s instanceof Wr&&(s.url=r);var a=new e(o);return i||(i=r),Xr.addToCache(a.baseTexture,i),e.addToCache(a,i),i!==r&&(Xr.addToCache(a.baseTexture,r),e.addToCache(a,r)),a.baseTexture.valid?Promise.resolve(a):new Promise(function(t){a.baseTexture.once("loaded",function(){return t(a)})})},e.addToCache=function(t,e){e&&(-1===t.textureCacheIds.indexOf(e)&&t.textureCacheIds.push(e),De[e]&&console.warn("Texture added to the cache with an id ["+e+"] that already had an entry"),De[e]=t)},e.removeFromCache=function(t){if("string"==typeof t){var e=De[t];if(e){var r=e.textureCacheIds.indexOf(t);return r>-1&&e.textureCacheIds.splice(r,1),delete De[t],e}}else if(t&&t.textureCacheIds){for(var i=0;i<t.textureCacheIds.length;++i)De[t.textureCacheIds[i]]===t&&delete De[t.textureCacheIds[i]];return t.textureCacheIds.length=0,t}return null},Object.defineProperty(e.prototype,"resolution",{get:function(){return this.baseTexture.resolution},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"frame",{get:function(){return this._frame},set:function(t){this._frame=t,this.noFrame=!1;var e=t.x,r=t.y,i=t.width,n=t.height,o=e+i>this.baseTexture.width,s=r+n>this.baseTexture.height;if(o||s){var a=o&&s?"and":"or",h="X: "+e+" + "+i+" = "+(e+i)+" > "+this.baseTexture.width,u="Y: "+r+" + "+n+" = "+(r+n)+" > "+this.baseTexture.height;throw new Error("Texture Error: frame does not fit inside the base Texture dimensions: "+h+" "+a+" "+u)}this.valid=i&&n&&this.baseTexture.valid,this.trim||this.rotate||(this.orig=t),this.valid&&this.updateUvs()},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"rotate",{get:function(){return this._rotate},set:function(t){this._rotate=t,this.valid&&this.updateUvs()},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"width",{get:function(){return this.orig.width},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"height",{get:function(){return this.orig.height},enumerable:!1,configurable:!0}),e.prototype.castToBaseTexture=function(){return this.baseTexture},e}(ot);function ii(t){t.destroy=function(){},t.on=function(){},t.once=function(){},t.emit=function(){}}ri.EMPTY=new ri(new Xr),ii(ri.EMPTY),ii(ri.EMPTY.baseTexture),ri.WHITE=function(){var t=document.createElement("canvas");t.width=16,t.height=16;var e=t.getContext("2d");return e.fillStyle="white",e.fillRect(0,0,16,16),new ri(new Xr(new jr(t)))}(),ii(ri.WHITE),ii(ri.WHITE.baseTexture);var ni=function(t){function e(e,r){var i=t.call(this,e,r)||this;return i.valid=!0,i.filterFrame=null,i.filterPoolKey=null,i.updateUvs(),i}return Lr(e,t),Object.defineProperty(e.prototype,"framebuffer",{get:function(){return this.baseTexture.framebuffer},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"multisample",{get:function(){return this.framebuffer.multisample},set:function(t){this.framebuffer.multisample=t},enumerable:!1,configurable:!0}),e.prototype.resize=function(t,e,r){void 0===r&&(r=!0);var i=this.baseTexture.resolution,n=Math.round(t*i)/i,o=Math.round(e*i)/i;this.valid=n>0&&o>0,this._frame.width=this.orig.width=n,this._frame.height=this.orig.height=o,r&&this.baseTexture.resize(n,o),this.updateUvs()},e.prototype.setResolution=function(t){var e=this.baseTexture;e.resolution!==t&&(e.setResolution(t),this.resize(e.width,e.height,!1))},e.create=function(t){for(var r=arguments,i=[],n=1;n<arguments.length;n++)i[n-1]=r[n];return"number"==typeof t&&(t={width:t,height:i[0],scaleMode:i[1],resolution:i[2]}),new e(new $r(t))},e}(ri),oi=function(){function e(t){this.texturePool={},this.textureOptions=t||{},this.enableFullScreen=!1,this._pixelsWidth=0,this._pixelsHeight=0}return e.prototype.createTexture=function(e,r,i){void 0===i&&(i=t.MSAA_QUALITY.NONE);var n=new $r(Object.assign({width:e,height:r,resolution:1,multisample:i},this.textureOptions));return new ni(n)},e.prototype.getOptimalTexture=function(e,r,i,n){var o;void 0===i&&(i=1),void 0===n&&(n=t.MSAA_QUALITY.NONE),e=Math.ceil(e*i),r=Math.ceil(r*i),this.enableFullScreen&&e===this._pixelsWidth&&r===this._pixelsHeight?o=n>1?-n:-1:(o=((65535&(e=be(e)))<<16|65535&(r=be(r)))>>>0,n>1&&(o+=4294967296*n)),this.texturePool[o]||(this.texturePool[o]=[]);var s=this.texturePool[o].pop();return s||(s=this.createTexture(e,r,n)),s.filterPoolKey=o,s.setResolution(i),s},e.prototype.getFilterTexture=function(e,r,i){var n=this.getOptimalTexture(e.width,e.height,r||e.resolution,i||t.MSAA_QUALITY.NONE);return n.filterFrame=e.filterFrame,n},e.prototype.returnTexture=function(t){var e=t.filterPoolKey;t.filterFrame=null,this.texturePool[e].push(t)},e.prototype.returnFilterTexture=function(t){this.returnTexture(t)},e.prototype.clear=function(t){if(t=!1!==t)for(var e in this.texturePool){var r=this.texturePool[e];if(r)for(var i=0;i<r.length;i++)r[i].destroy(!0)}this.texturePool={}},e.prototype.setScreenSize=function(t){if(t.width!==this._pixelsWidth||t.height!==this._pixelsHeight){for(var e in this.enableFullScreen=t.width>0&&t.height>0,this.texturePool)if(Number(e)<0){var r=this.texturePool[e];if(r)for(var i=0;i<r.length;i++)r[i].destroy(!0);this.texturePool[e]=[]}this._pixelsWidth=t.width,this._pixelsHeight=t.height}},e.SCREEN_KEY=-1,e}(),si=function(){function e(e,r,i,n,o,s,a){void 0===r&&(r=0),void 0===i&&(i=!1),void 0===n&&(n=t.TYPES.FLOAT),this.buffer=e,this.size=r,this.normalized=i,this.type=n,this.stride=o,this.start=s,this.instance=a}return e.prototype.destroy=function(){this.buffer=null},e.from=function(t,r,i,n,o){return new e(t,r,i,n,o)},e}(),ai=0,hi=function(){function e(t,e,r){void 0===e&&(e=!0),void 0===r&&(r=!1),this.data=t||new Float32Array(1),this._glBuffers={},this._updateID=0,this.index=r,this.static=e,this.id=ai++,this.disposeRunner=new Dr("disposeBuffer")}return e.prototype.update=function(t){t instanceof Array&&(t=new Float32Array(t)),this.data=t||this.data,this._updateID++},e.prototype.dispose=function(){this.disposeRunner.emit(this,!1)},e.prototype.destroy=function(){this.dispose(),this.data=null},Object.defineProperty(e.prototype,"index",{get:function(){return this.type===t.BUFFER_TYPE.ELEMENT_ARRAY_BUFFER},set:function(e){this.type=e?t.BUFFER_TYPE.ELEMENT_ARRAY_BUFFER:t.BUFFER_TYPE.ARRAY_BUFFER},enumerable:!1,configurable:!0}),e.from=function(t){return t instanceof Array&&(t=new Float32Array(t)),new e(t)},e}(),ui={Float32Array:Float32Array,Uint32Array:Uint32Array,Int32Array:Int32Array,Uint8Array:Uint8Array},li={5126:4,5123:2,5121:1},ci=0,di={Float32Array:Float32Array,Uint32Array:Uint32Array,Int32Array:Int32Array,Uint8Array:Uint8Array,Uint16Array:Uint16Array},fi=function(){function e(t,e){void 0===t&&(t=[]),void 0===e&&(e={}),this.buffers=t,this.indexBuffer=null,this.attributes=e,this.glVertexArrayObjects={},this.id=ci++,this.instanced=!1,this.instanceCount=1,this.disposeRunner=new Dr("disposeGeometry"),this.refCount=0}return e.prototype.addAttribute=function(t,e,r,i,n,o,s,a){if(void 0===r&&(r=0),void 0===i&&(i=!1),void 0===a&&(a=!1),!e)throw new Error("You must pass a buffer when creating an attribute");e instanceof hi||(e instanceof Array&&(e=new Float32Array(e)),e=new hi(e));var h=t.split("|");if(h.length>1){for(var u=0;u<h.length;u++)this.addAttribute(h[u],e,r,i,n);return this}var l=this.buffers.indexOf(e);return-1===l&&(this.buffers.push(e),l=this.buffers.length-1),this.attributes[t]=new si(l,r,i,n,o,s,a),this.instanced=this.instanced||a,this},e.prototype.getAttribute=function(t){return this.attributes[t]},e.prototype.getBuffer=function(t){return this.buffers[this.getAttribute(t).buffer]},e.prototype.addIndex=function(e){return e instanceof hi||(e instanceof Array&&(e=new Uint16Array(e)),e=new hi(e)),e.type=t.BUFFER_TYPE.ELEMENT_ARRAY_BUFFER,this.indexBuffer=e,-1===this.buffers.indexOf(e)&&this.buffers.push(e),this},e.prototype.getIndex=function(){return this.indexBuffer},e.prototype.interleave=function(){if(1===this.buffers.length||2===this.buffers.length&&this.indexBuffer)return this;var t,e=[],r=[],i=new hi;for(t in this.attributes){var n=this.attributes[t],o=this.buffers[n.buffer];e.push(o.data),r.push(n.size*li[n.type]/4),n.buffer=0}for(i.data=function(t,e){for(var r=0,i=0,n={},o=0;o<t.length;o++)i+=e[o],r+=t[o].length;var s=new ArrayBuffer(4*r),a=null,h=0;for(o=0;o<t.length;o++){var u=e[o],l=t[o],c=ge(l);n[c]||(n[c]=new ui[c](s)),a=n[c];for(var d=0;d<l.length;d++)a[(d/u|0)*i+h+d%u]=l[d];h+=u}return new Float32Array(s)}(e,r),t=0;t<this.buffers.length;t++)this.buffers[t]!==this.indexBuffer&&this.buffers[t].destroy();return this.buffers=[i],this.indexBuffer&&this.buffers.push(this.indexBuffer),this},e.prototype.getSize=function(){for(var t in this.attributes){var e=this.attributes[t];return this.buffers[e.buffer].data.length/(e.stride/4||e.size)}return 0},e.prototype.dispose=function(){this.disposeRunner.emit(this,!1)},e.prototype.destroy=function(){this.dispose(),this.buffers=null,this.indexBuffer=null,this.attributes=null},e.prototype.clone=function(){for(var r=new e,i=0;i<this.buffers.length;i++)r.buffers[i]=new hi(this.buffers[i].data.slice(0));for(var i in this.attributes){var n=this.attributes[i];r.attributes[i]=new si(n.buffer,n.size,n.normalized,n.type,n.stride,n.start,n.instance)}return this.indexBuffer&&(r.indexBuffer=r.buffers[this.buffers.indexOf(this.indexBuffer)],r.indexBuffer.type=t.BUFFER_TYPE.ELEMENT_ARRAY_BUFFER),r},e.merge=function(r){for(var i,n=new e,o=[],s=[],a=[],h=0;h<r.length;h++){i=r[h];for(var u=0;u<i.buffers.length;u++)s[u]=s[u]||0,s[u]+=i.buffers[u].data.length,a[u]=0}for(h=0;h<i.buffers.length;h++)o[h]=new(di[ge(i.buffers[h].data)])(s[h]),n.buffers[h]=new hi(o[h]);for(h=0;h<r.length;h++)for(i=r[h],u=0;u<i.buffers.length;u++)o[u].set(i.buffers[u].data,a[u]),a[u]+=i.buffers[u].data.length;if(n.attributes=i.attributes,i.indexBuffer){n.indexBuffer=n.buffers[i.buffers.indexOf(i.indexBuffer)],n.indexBuffer.type=t.BUFFER_TYPE.ELEMENT_ARRAY_BUFFER;var l=0,c=0,d=0,f=0;for(h=0;h<i.buffers.length;h++)if(i.buffers[h]!==i.indexBuffer){f=h;break}for(var h in i.attributes){var p=i.attributes[h];(0|p.buffer)===f&&(c+=p.size*li[p.type]/4)}for(h=0;h<r.length;h++){var _=r[h].indexBuffer.data;for(u=0;u<_.length;u++)n.indexBuffer.data[u+d]+=l;l+=r[h].buffers[f].data.length/c,d+=_.length}}return n},e}(),pi=function(t){function e(){var e=t.call(this)||this;return e.addAttribute("aVertexPosition",new Float32Array([0,0,1,0,1,1,0,1])).addIndex([0,1,3,2]),e}return Lr(e,t),e}(fi),_i=function(t){function e(){var e=t.call(this)||this;return e.vertices=new Float32Array([-1,-1,1,-1,1,1,-1,1]),e.uvs=new Float32Array([0,0,1,0,1,1,0,1]),e.vertexBuffer=new hi(e.vertices),e.uvBuffer=new hi(e.uvs),e.addAttribute("aVertexPosition",e.vertexBuffer).addAttribute("aTextureCoord",e.uvBuffer).addIndex([0,1,2,0,2,3]),e}return Lr(e,t),e.prototype.map=function(t,e){var r=0,i=0;return this.uvs[0]=r,this.uvs[1]=i,this.uvs[2]=r+e.width/t.width,this.uvs[3]=i,this.uvs[4]=r+e.width/t.width,this.uvs[5]=i+e.height/t.height,this.uvs[6]=r,this.uvs[7]=i+e.height/t.height,r=e.x,i=e.y,this.vertices[0]=r,this.vertices[1]=i,this.vertices[2]=r+e.width,this.vertices[3]=i,this.vertices[4]=r+e.width,this.vertices[5]=i+e.height,this.vertices[6]=r,this.vertices[7]=i+e.height,this.invalidate(),this},e.prototype.invalidate=function(){return this.vertexBuffer._updateID++,this.uvBuffer._updateID++,this},e}(fi),mi=0,vi=function(){function e(e,r,i){this.group=!0,this.syncUniforms={},this.dirtyId=0,this.id=mi++,this.static=!!r,this.ubo=!!i,e instanceof hi?(this.buffer=e,this.buffer.type=t.BUFFER_TYPE.UNIFORM_BUFFER,this.autoManage=!1,this.ubo=!0):(this.uniforms=e,this.ubo&&(this.buffer=new hi(new Float32Array(1)),this.buffer.type=t.BUFFER_TYPE.UNIFORM_BUFFER,this.autoManage=!0))}return e.prototype.update=function(){this.dirtyId++,!this.autoManage&&this.buffer&&this.buffer.update()},e.prototype.add=function(t,r,i){if(this.ubo)throw new Error("[UniformGroup] uniform groups in ubo mode cannot be modified, or have uniform groups nested in them");this.uniforms[t]=new e(r,i)},e.from=function(t,r,i){return new e(t,r,i)},e.uboFrom=function(t,r){return new e(t,null==r||r,!0)},e}(),yi=function(){function e(){this.renderTexture=null,this.target=null,this.legacy=!1,this.resolution=1,this.multisample=t.MSAA_QUALITY.NONE,this.sourceFrame=new Ye,this.destinationFrame=new Ye,this.bindingSourceFrame=new Ye,this.bindingDestinationFrame=new Ye,this.filters=[],this.transform=null}return e.prototype.clear=function(){this.target=null,this.filters=null,this.renderTexture=null},e}(),Ei=[new qe,new qe,new qe,new qe],gi=new Ze,Ti=function(){function e(t){this.renderer=t,this.defaultFilterStack=[{}],this.texturePool=new oi,this.texturePool.setScreenSize(t.view),this.statePool=[],this.quad=new pi,this.quadUv=new _i,this.tempRect=new Ye,this.activeState={},this.globalUniforms=new vi({outputFrame:new Ye,inputSize:new Float32Array(4),inputPixel:new Float32Array(4),inputClamp:new Float32Array(4),resolution:1,filterArea:new Float32Array(4),filterClamp:new Float32Array(4)},!0),this.forceClear=!1,this.useMaxPadding=!1}return e.prototype.push=function(t,e){for(var r=this.renderer,i=this.defaultFilterStack,n=this.statePool.pop()||new yi,o=this.renderer.renderTexture,s=e[0].resolution,a=e[0].multisample,h=e[0].padding,u=e[0].autoFit,l=e[0].legacy,c=1;c<e.length;c++){var d=e[c];s=Math.min(s,d.resolution),a=Math.min(a,d.multisample),h=this.useMaxPadding?Math.max(h,d.padding):h+d.padding,u=u&&d.autoFit,l=l||d.legacy}if(1===i.length&&(this.defaultFilterStack[0].renderTexture=o.current),i.push(n),n.resolution=s,n.multisample=a,n.legacy=l,n.target=t,n.sourceFrame.copyFrom(t.filterArea||t.getBounds(!0)),n.sourceFrame.pad(h),u){var f=this.tempRect.copyFrom(o.sourceFrame);r.projection.transform&&this.transformAABB(gi.copyFrom(r.projection.transform).invert(),f),n.sourceFrame.fit(f)}this.roundFrame(n.sourceFrame,o.current?o.current.resolution:r.resolution,o.sourceFrame,o.destinationFrame,r.projection.transform),n.renderTexture=this.getOptimalFilterTexture(n.sourceFrame.width,n.sourceFrame.height,s,a),n.filters=e,n.destinationFrame.width=n.renderTexture.width,n.destinationFrame.height=n.renderTexture.height;var p=this.tempRect;p.x=0,p.y=0,p.width=n.sourceFrame.width,p.height=n.sourceFrame.height,n.renderTexture.filterFrame=n.sourceFrame,n.bindingSourceFrame.copyFrom(o.sourceFrame),n.bindingDestinationFrame.copyFrom(o.destinationFrame),n.transform=r.projection.transform,r.projection.transform=null,o.bind(n.renderTexture,n.sourceFrame,p),r.framebuffer.clear(0,0,0,0)},e.prototype.pop=function(){var e=this.defaultFilterStack,r=e.pop(),i=r.filters;this.activeState=r;var n=this.globalUniforms.uniforms;n.outputFrame=r.sourceFrame,n.resolution=r.resolution;var o=n.inputSize,s=n.inputPixel,a=n.inputClamp;if(o[0]=r.destinationFrame.width,o[1]=r.destinationFrame.height,o[2]=1/o[0],o[3]=1/o[1],s[0]=Math.round(o[0]*r.resolution),s[1]=Math.round(o[1]*r.resolution),s[2]=1/s[0],s[3]=1/s[1],a[0]=.5*s[2],a[1]=.5*s[3],a[2]=r.sourceFrame.width*o[2]-.5*s[2],a[3]=r.sourceFrame.height*o[3]-.5*s[3],r.legacy){var h=n.filterArea;h[0]=r.destinationFrame.width,h[1]=r.destinationFrame.height,h[2]=r.sourceFrame.x,h[3]=r.sourceFrame.y,n.filterClamp=n.inputClamp}this.globalUniforms.update();var u=e[e.length-1];if(this.renderer.framebuffer.blit(),1===i.length)i[0].apply(this,r.renderTexture,u.renderTexture,t.CLEAR_MODES.BLEND,r),this.returnFilterTexture(r.renderTexture);else{var l=r.renderTexture,c=this.getOptimalFilterTexture(l.width,l.height,r.resolution);c.filterFrame=l.filterFrame;var d=0;for(d=0;d<i.length-1;++d){1===d&&r.multisample>1&&((c=this.getOptimalFilterTexture(l.width,l.height,r.resolution)).filterFrame=l.filterFrame),i[d].apply(this,l,c,t.CLEAR_MODES.CLEAR,r);var f=l;l=c,c=f}i[d].apply(this,l,u.renderTexture,t.CLEAR_MODES.BLEND,r),d>1&&r.multisample>1&&this.returnFilterTexture(r.renderTexture),this.returnFilterTexture(l),this.returnFilterTexture(c)}r.clear(),this.statePool.push(r)},e.prototype.bindAndClear=function(e,r){void 0===r&&(r=t.CLEAR_MODES.CLEAR);var i=this.renderer,n=i.renderTexture,o=i.state;if(e===this.defaultFilterStack[this.defaultFilterStack.length-1].renderTexture?this.renderer.projection.transform=this.activeState.transform:this.renderer.projection.transform=null,e&&e.filterFrame){var s=this.tempRect;s.x=0,s.y=0,s.width=e.filterFrame.width,s.height=e.filterFrame.height,n.bind(e,e.filterFrame,s)}else e!==this.defaultFilterStack[this.defaultFilterStack.length-1].renderTexture?n.bind(e):this.renderer.renderTexture.bind(e,this.activeState.bindingSourceFrame,this.activeState.bindingDestinationFrame);var a=1&o.stateId||this.forceClear;(r===t.CLEAR_MODES.CLEAR||r===t.CLEAR_MODES.BLIT&&a)&&this.renderer.framebuffer.clear(0,0,0,0)},e.prototype.applyFilter=function(e,r,i,n){var o=this.renderer;o.state.set(e.state),this.bindAndClear(i,n),e.uniforms.uSampler=r,e.uniforms.filterGlobals=this.globalUniforms,o.shader.bind(e),e.legacy=!!e.program.attributeData.aTextureCoord,e.legacy?(this.quadUv.map(r._frame,r.filterFrame),o.geometry.bind(this.quadUv),o.geometry.draw(t.DRAW_MODES.TRIANGLES)):(o.geometry.bind(this.quad),o.geometry.draw(t.DRAW_MODES.TRIANGLE_STRIP))},e.prototype.calculateSpriteMatrix=function(t,e){var r=this.activeState,i=r.sourceFrame,n=r.destinationFrame,o=e._texture.orig,s=t.set(n.width,0,0,n.height,i.x,i.y),a=e.worldTransform.copyTo(Ze.TEMP_MATRIX);return a.invert(),s.prepend(a),s.scale(1/o.width,1/o.height),s.translate(e.anchor.x,e.anchor.y),s},e.prototype.destroy=function(){this.renderer=null,this.texturePool.clear(!1)},e.prototype.getOptimalFilterTexture=function(e,r,i,n){return void 0===i&&(i=1),void 0===n&&(n=t.MSAA_QUALITY.NONE),this.texturePool.getOptimalTexture(e,r,i,n)},e.prototype.getFilterTexture=function(e,r,i){if("number"==typeof e){var n=e;e=r,r=n}e=e||this.activeState.renderTexture;var o=this.texturePool.getOptimalTexture(e.width,e.height,r||e.resolution,i||t.MSAA_QUALITY.NONE);return o.filterFrame=e.filterFrame,o},e.prototype.returnFilterTexture=function(t){this.texturePool.returnTexture(t)},e.prototype.emptyPool=function(){this.texturePool.clear(!0)},e.prototype.resize=function(){this.texturePool.setScreenSize(this.renderer.view)},e.prototype.transformAABB=function(t,e){var r=Ei[0],i=Ei[1],n=Ei[2],o=Ei[3];r.set(e.left,e.top),i.set(e.left,e.bottom),n.set(e.right,e.top),o.set(e.right,e.bottom),t.apply(r,r),t.apply(i,i),t.apply(n,n),t.apply(o,o);var s=Math.min(r.x,i.x,n.x,o.x),a=Math.min(r.y,i.y,n.y,o.y),h=Math.max(r.x,i.x,n.x,o.x),u=Math.max(r.y,i.y,n.y,o.y);e.x=s,e.y=a,e.width=h-s,e.height=u-a},e.prototype.roundFrame=function(t,e,r,i,n){if(n){var o=n.a,s=n.b,a=n.c,h=n.d;if((Math.abs(s)>1e-4||Math.abs(a)>1e-4)&&(Math.abs(o)>1e-4||Math.abs(h)>1e-4))return}(n=n?gi.copyFrom(n):gi.identity()).translate(-r.x,-r.y).scale(i.width/r.width,i.height/r.height).translate(i.x,i.y),this.transformAABB(n,t),t.ceil(e),this.transformAABB(n.invert(),t)},e}(),bi=function(){function t(t){this.renderer=t}return t.prototype.flush=function(){},t.prototype.destroy=function(){this.renderer=null},t.prototype.start=function(){},t.prototype.stop=function(){this.flush()},t.prototype.render=function(t){},t}(),Ri=function(){function t(t){this.renderer=t,this.emptyRenderer=new bi(t),this.currentRenderer=this.emptyRenderer}return t.prototype.setObjectRenderer=function(t){this.currentRenderer!==t&&(this.currentRenderer.stop(),this.currentRenderer=t,this.currentRenderer.start())},t.prototype.flush=function(){this.setObjectRenderer(this.emptyRenderer)},t.prototype.reset=function(){this.setObjectRenderer(this.emptyRenderer)},t.prototype.copyBoundTextures=function(t,e){for(var r=this.renderer.texture.boundTextures,i=e-1;i>=0;--i)t[i]=r[i]||null,t[i]&&(t[i]._batchLocation=i)},t.prototype.boundArray=function(t,e,r,i){for(var n=t.elements,o=t.ids,s=t.count,a=0,h=0;h<s;h++){var u=n[h],l=u._batchLocation;if(l>=0&&l<i&&e[l]===u)o[h]=l;else for(;a<i;){var c=e[a];if(!c||c._batchEnabled!==r||c._batchLocation!==a){o[h]=a,u._batchLocation=a,e[a]=u;break}a++}}},t.prototype.destroy=function(){this.renderer=null},t}(),xi=0,Ai=function(){function e(t){this.renderer=t,this.webGLVersion=1,this.extensions={},this.supports={uint32Indices:!1},this.handleContextLost=this.handleContextLost.bind(this),this.handleContextRestored=this.handleContextRestored.bind(this),t.view.addEventListener("webglcontextlost",this.handleContextLost,!1),t.view.addEventListener("webglcontextrestored",this.handleContextRestored,!1)}return Object.defineProperty(e.prototype,"isLost",{get:function(){return!this.gl||this.gl.isContextLost()},enumerable:!1,configurable:!0}),e.prototype.contextChange=function(t){this.gl=t,this.renderer.gl=t,this.renderer.CONTEXT_UID=xi++,t.isContextLost()&&t.getExtension("WEBGL_lose_context")&&t.getExtension("WEBGL_lose_context").restoreContext()},e.prototype.initFromContext=function(t){this.gl=t,this.validateContext(t),this.renderer.gl=t,this.renderer.CONTEXT_UID=xi++,this.renderer.runners.contextChange.emit(t)},e.prototype.initFromOptions=function(t){var e=this.createContext(this.renderer.view,t);this.initFromContext(e)},e.prototype.createContext=function(e,r){var i;if(rt.PREFER_ENV>=t.ENV.WEBGL2&&(i=e.getContext("webgl2",r)),i)this.webGLVersion=2;else if(this.webGLVersion=1,!(i=e.getContext("webgl",r)||e.getContext("experimental-webgl",r)))throw new Error("This browser does not support WebGL. Try using the canvas renderer");return this.gl=i,this.getExtensions(),this.gl},e.prototype.getExtensions=function(){var t=this.gl,e={anisotropicFiltering:t.getExtension("EXT_texture_filter_anisotropic"),floatTextureLinear:t.getExtension("OES_texture_float_linear"),s3tc:t.getExtension("WEBGL_compressed_texture_s3tc"),s3tc_sRGB:t.getExtension("WEBGL_compressed_texture_s3tc_srgb"),etc:t.getExtension("WEBGL_compressed_texture_etc"),etc1:t.getExtension("WEBGL_compressed_texture_etc1"),pvrtc:t.getExtension("WEBGL_compressed_texture_pvrtc")||t.getExtension("WEBKIT_WEBGL_compressed_texture_pvrtc"),atc:t.getExtension("WEBGL_compressed_texture_atc"),astc:t.getExtension("WEBGL_compressed_texture_astc")};1===this.webGLVersion?Object.assign(this.extensions,e,{drawBuffers:t.getExtension("WEBGL_draw_buffers"),depthTexture:t.getExtension("WEBGL_depth_texture"),loseContext:t.getExtension("WEBGL_lose_context"),vertexArrayObject:t.getExtension("OES_vertex_array_object")||t.getExtension("MOZ_OES_vertex_array_object")||t.getExtension("WEBKIT_OES_vertex_array_object"),uint32ElementIndex:t.getExtension("OES_element_index_uint"),floatTexture:t.getExtension("OES_texture_float"),floatTextureLinear:t.getExtension("OES_texture_float_linear"),textureHalfFloat:t.getExtension("OES_texture_half_float"),textureHalfFloatLinear:t.getExtension("OES_texture_half_float_linear")}):2===this.webGLVersion&&Object.assign(this.extensions,e,{colorBufferFloat:t.getExtension("EXT_color_buffer_float")})},e.prototype.handleContextLost=function(t){t.preventDefault()},e.prototype.handleContextRestored=function(){this.renderer.runners.contextChange.emit(this.gl)},e.prototype.destroy=function(){var t=this.renderer.view;this.renderer=null,t.removeEventListener("webglcontextlost",this.handleContextLost),t.removeEventListener("webglcontextrestored",this.handleContextRestored),this.gl.useProgram(null),this.extensions.loseContext&&this.extensions.loseContext.loseContext()},e.prototype.postrender=function(){this.renderer.renderingToScreen&&this.gl.flush()},e.prototype.validateContext=function(t){var e=t.getContextAttributes(),r="WebGL2RenderingContext"in self&&t instanceof self.WebGL2RenderingContext;r&&(this.webGLVersion=2),e.stencil||console.warn("Provided WebGL context does not have a stencil buffer, masks may not render correctly");var i=r||!!t.getExtension("OES_element_index_uint");this.supports.uint32Indices=i,i||console.warn("Provided WebGL context does not support 32 index buffer, complex graphics may not render correctly")},e}(),Si=function(e){this.framebuffer=e,this.stencil=null,this.dirtyId=-1,this.dirtyFormat=-1,this.dirtySize=-1,this.multisample=t.MSAA_QUALITY.NONE,this.msaaBuffer=null,this.blitFramebuffer=null,this.mipLevel=0},Oi=new Ye,Ii=function(){function e(t){this.renderer=t,this.managedFramebuffers=[],this.unknownFramebuffer=new Jr(10,10),this.msaaSamples=null}return e.prototype.contextChange=function(){var e=this.gl=this.renderer.gl;if(this.CONTEXT_UID=this.renderer.CONTEXT_UID,this.current=this.unknownFramebuffer,this.viewport=new Ye,this.hasMRT=!0,this.writeDepthTexture=!0,this.disposeAll(!0),1===this.renderer.context.webGLVersion){var r=this.renderer.context.extensions.drawBuffers,i=this.renderer.context.extensions.depthTexture;rt.PREFER_ENV===t.ENV.WEBGL_LEGACY&&(r=null,i=null),r?e.drawBuffers=function(t){return r.drawBuffersWEBGL(t)}:(this.hasMRT=!1,e.drawBuffers=function(){}),i||(this.writeDepthTexture=!1)}else this.msaaSamples=e.getInternalformatParameter(e.RENDERBUFFER,e.RGBA8,e.SAMPLES)},e.prototype.bind=function(t,e,r){void 0===r&&(r=0);var i=this.gl;if(t){var n=t.glFramebuffers[this.CONTEXT_UID]||this.initFramebuffer(t);this.current!==t&&(this.current=t,i.bindFramebuffer(i.FRAMEBUFFER,n.framebuffer)),n.mipLevel!==r&&(t.dirtyId++,t.dirtyFormat++,n.mipLevel=r),n.dirtyId!==t.dirtyId&&(n.dirtyId=t.dirtyId,n.dirtyFormat!==t.dirtyFormat?(n.dirtyFormat=t.dirtyFormat,n.dirtySize=t.dirtySize,this.updateFramebuffer(t,r)):n.dirtySize!==t.dirtySize&&(n.dirtySize=t.dirtySize,this.resizeFramebuffer(t)));for(var o=0;o<t.colorTextures.length;o++){var s=t.colorTextures[o];this.renderer.texture.unbind(s.parentTextureArray||s)}if(t.depthTexture&&this.renderer.texture.unbind(t.depthTexture),e){var a=e.width>>r,h=e.height>>r,u=a/e.width;this.setViewport(e.x*u,e.y*u,a,h)}else a=t.width>>r,h=t.height>>r,this.setViewport(0,0,a,h)}else this.current&&(this.current=null,i.bindFramebuffer(i.FRAMEBUFFER,null)),e?this.setViewport(e.x,e.y,e.width,e.height):this.setViewport(0,0,this.renderer.width,this.renderer.height)},e.prototype.setViewport=function(t,e,r,i){var n=this.viewport;t=Math.round(t),e=Math.round(e),r=Math.round(r),i=Math.round(i),n.width===r&&n.height===i&&n.x===t&&n.y===e||(n.x=t,n.y=e,n.width=r,n.height=i,this.gl.viewport(t,e,r,i))},Object.defineProperty(e.prototype,"size",{get:function(){return this.current?{x:0,y:0,width:this.current.width,height:this.current.height}:{x:0,y:0,width:this.renderer.width,height:this.renderer.height}},enumerable:!1,configurable:!0}),e.prototype.clear=function(e,r,i,n,o){void 0===o&&(o=t.BUFFER_BITS.COLOR|t.BUFFER_BITS.DEPTH);var s=this.gl;s.clearColor(e,r,i,n),s.clear(o)},e.prototype.initFramebuffer=function(t){var e=this.gl,r=new Si(e.createFramebuffer());return r.multisample=this.detectSamples(t.multisample),t.glFramebuffers[this.CONTEXT_UID]=r,this.managedFramebuffers.push(t),t.disposeRunner.add(this),r},e.prototype.resizeFramebuffer=function(t){var e=this.gl,r=t.glFramebuffers[this.CONTEXT_UID];r.msaaBuffer&&(e.bindRenderbuffer(e.RENDERBUFFER,r.msaaBuffer),e.renderbufferStorageMultisample(e.RENDERBUFFER,r.multisample,e.RGBA8,t.width,t.height)),r.stencil&&(e.bindRenderbuffer(e.RENDERBUFFER,r.stencil),r.msaaBuffer?e.renderbufferStorageMultisample(e.RENDERBUFFER,r.multisample,e.DEPTH24_STENCIL8,t.width,t.height):e.renderbufferStorage(e.RENDERBUFFER,e.DEPTH_STENCIL,t.width,t.height));var i=t.colorTextures,n=i.length;e.drawBuffers||(n=Math.min(n,1));for(var o=0;o<n;o++){var s=i[o],a=s.parentTextureArray||s;this.renderer.texture.bind(a,0)}t.depthTexture&&this.writeDepthTexture&&this.renderer.texture.bind(t.depthTexture,0)},e.prototype.updateFramebuffer=function(t,e){var r=this.gl,i=t.glFramebuffers[this.CONTEXT_UID],n=t.colorTextures,o=n.length;r.drawBuffers||(o=Math.min(o,1)),i.multisample>1&&this.canMultisampleFramebuffer(t)?(i.msaaBuffer=i.msaaBuffer||r.createRenderbuffer(),r.bindRenderbuffer(r.RENDERBUFFER,i.msaaBuffer),r.renderbufferStorageMultisample(r.RENDERBUFFER,i.multisample,r.RGBA8,t.width,t.height),r.framebufferRenderbuffer(r.FRAMEBUFFER,r.COLOR_ATTACHMENT0,r.RENDERBUFFER,i.msaaBuffer)):i.msaaBuffer&&(r.deleteRenderbuffer(i.msaaBuffer),i.msaaBuffer=null,i.blitFramebuffer&&(i.blitFramebuffer.dispose(),i.blitFramebuffer=null));for(var s=[],a=0;a<o;a++){var h=n[a],u=h.parentTextureArray||h;this.renderer.texture.bind(u,0),0===a&&i.msaaBuffer||(r.framebufferTexture2D(r.FRAMEBUFFER,r.COLOR_ATTACHMENT0+a,h.target,u._glTextures[this.CONTEXT_UID].texture,e),s.push(r.COLOR_ATTACHMENT0+a))}if(s.length>1&&r.drawBuffers(s),t.depthTexture&&this.writeDepthTexture){var l=t.depthTexture;this.renderer.texture.bind(l,0),r.framebufferTexture2D(r.FRAMEBUFFER,r.DEPTH_ATTACHMENT,r.TEXTURE_2D,l._glTextures[this.CONTEXT_UID].texture,e)}!t.stencil&&!t.depth||t.depthTexture&&this.writeDepthTexture?i.stencil&&(r.deleteRenderbuffer(i.stencil),i.stencil=null):(i.stencil=i.stencil||r.createRenderbuffer(),r.bindRenderbuffer(r.RENDERBUFFER,i.stencil),i.msaaBuffer?r.renderbufferStorageMultisample(r.RENDERBUFFER,i.multisample,r.DEPTH24_STENCIL8,t.width,t.height):r.renderbufferStorage(r.RENDERBUFFER,r.DEPTH_STENCIL,t.width,t.height),r.framebufferRenderbuffer(r.FRAMEBUFFER,r.DEPTH_STENCIL_ATTACHMENT,r.RENDERBUFFER,i.stencil))},e.prototype.canMultisampleFramebuffer=function(t){return 1!==this.renderer.context.webGLVersion&&t.colorTextures.length<=1&&!t.depthTexture},e.prototype.detectSamples=function(e){var r=this.msaaSamples,i=t.MSAA_QUALITY.NONE;if(e<=1||null===r)return i;for(var n=0;n<r.length;n++)if(r[n]<=e){i=r[n];break}return 1===i&&(i=t.MSAA_QUALITY.NONE),i},e.prototype.blit=function(t,e,r){var i=this.current,n=this.renderer,o=this.gl,s=this.CONTEXT_UID;if(2===n.context.webGLVersion&&i){var a=i.glFramebuffers[s];if(a){if(!t){if(!a.msaaBuffer)return;var h=i.colorTextures[0];if(!h)return;a.blitFramebuffer||(a.blitFramebuffer=new Jr(i.width,i.height),a.blitFramebuffer.addColorTexture(0,h)),(t=a.blitFramebuffer).colorTextures[0]!==h&&(t.colorTextures[0]=h,t.dirtyId++,t.dirtyFormat++),t.width===i.width&&t.height===i.height||(t.width=i.width,t.height=i.height,t.dirtyId++,t.dirtySize++)}e||((e=Oi).width=i.width,e.height=i.height),r||(r=e);var u=e.width===r.width&&e.height===r.height;this.bind(t),o.bindFramebuffer(o.READ_FRAMEBUFFER,a.framebuffer),o.blitFramebuffer(e.x,e.y,e.width,e.height,r.x,r.y,r.width,r.height,o.COLOR_BUFFER_BIT,u?o.NEAREST:o.LINEAR)}}},e.prototype.disposeFramebuffer=function(t,e){var r=t.glFramebuffers[this.CONTEXT_UID],i=this.gl;if(r){delete t.glFramebuffers[this.CONTEXT_UID];var n=this.managedFramebuffers.indexOf(t);n>=0&&this.managedFramebuffers.splice(n,1),t.disposeRunner.remove(this),e||(i.deleteFramebuffer(r.framebuffer),r.msaaBuffer&&i.deleteRenderbuffer(r.msaaBuffer),r.stencil&&i.deleteRenderbuffer(r.stencil)),r.blitFramebuffer&&r.blitFramebuffer.dispose()}},e.prototype.disposeAll=function(t){var e=this.managedFramebuffers;this.managedFramebuffers=[];for(var r=0;r<e.length;r++)this.disposeFramebuffer(e[r],t)},e.prototype.forceStencil=function(){var t=this.current;if(t){var e=t.glFramebuffers[this.CONTEXT_UID];if(e&&!e.stencil){t.stencil=!0;var r=t.width,i=t.height,n=this.gl,o=n.createRenderbuffer();n.bindRenderbuffer(n.RENDERBUFFER,o),e.msaaBuffer?n.renderbufferStorageMultisample(n.RENDERBUFFER,e.multisample,n.DEPTH24_STENCIL8,r,i):n.renderbufferStorage(n.RENDERBUFFER,n.DEPTH_STENCIL,r,i),e.stencil=o,n.framebufferRenderbuffer(n.FRAMEBUFFER,n.DEPTH_STENCIL_ATTACHMENT,n.RENDERBUFFER,o)}}},e.prototype.reset=function(){this.current=this.unknownFramebuffer,this.viewport=new Ye},e.prototype.destroy=function(){this.renderer=null},e}(),Pi={5126:4,5123:2,5121:1},Mi=function(){function e(t){this.renderer=t,this._activeGeometry=null,this._activeVao=null,this.hasVao=!0,this.hasInstance=!0,this.canUseUInt32ElementIndex=!1,this.managedGeometries={}}return e.prototype.contextChange=function(){this.disposeAll(!0);var e=this.gl=this.renderer.gl,r=this.renderer.context;if(this.CONTEXT_UID=this.renderer.CONTEXT_UID,2!==r.webGLVersion){var i=this.renderer.context.extensions.vertexArrayObject;rt.PREFER_ENV===t.ENV.WEBGL_LEGACY&&(i=null),i?(e.createVertexArray=function(){return i.createVertexArrayOES()},e.bindVertexArray=function(t){return i.bindVertexArrayOES(t)},e.deleteVertexArray=function(t){return i.deleteVertexArrayOES(t)}):(this.hasVao=!1,e.createVertexArray=function(){return null},e.bindVertexArray=function(){return null},e.deleteVertexArray=function(){return null})}if(2!==r.webGLVersion){var n=e.getExtension("ANGLE_instanced_arrays");n?(e.vertexAttribDivisor=function(t,e){return n.vertexAttribDivisorANGLE(t,e)},e.drawElementsInstanced=function(t,e,r,i,o){return n.drawElementsInstancedANGLE(t,e,r,i,o)},e.drawArraysInstanced=function(t,e,r,i){return n.drawArraysInstancedANGLE(t,e,r,i)}):this.hasInstance=!1}this.canUseUInt32ElementIndex=2===r.webGLVersion||!!r.extensions.uint32ElementIndex},e.prototype.bind=function(t,e){e=e||this.renderer.shader.shader;var r=this.gl,i=t.glVertexArrayObjects[this.CONTEXT_UID],n=!1;i||(this.managedGeometries[t.id]=t,t.disposeRunner.add(this),t.glVertexArrayObjects[this.CONTEXT_UID]=i={},n=!0);var o=i[e.program.id]||this.initGeometryVao(t,e,n);this._activeGeometry=t,this._activeVao!==o&&(this._activeVao=o,this.hasVao?r.bindVertexArray(o):this.activateVao(t,e.program)),this.updateBuffers()},e.prototype.reset=function(){this.unbind()},e.prototype.updateBuffers=function(){for(var t=this._activeGeometry,e=this.renderer.buffer,r=0;r<t.buffers.length;r++){var i=t.buffers[r];e.update(i)}},e.prototype.checkCompatibility=function(t,e){var r=t.attributes,i=e.attributeData;for(var n in i)if(!r[n])throw new Error('shader and geometry incompatible, geometry missing the "'+n+'" attribute')},e.prototype.getSignature=function(t,e){var r=t.attributes,i=e.attributeData,n=["g",t.id];for(var o in r)i[o]&&n.push(o);return n.join("-")},e.prototype.initGeometryVao=function(t,e,r){void 0===r&&(r=!0);var i=this.gl,n=this.CONTEXT_UID,o=this.renderer.buffer,s=e.program;s.glPrograms[n]||this.renderer.shader.generateProgram(e),this.checkCompatibility(t,s);var a=this.getSignature(t,s),h=t.glVertexArrayObjects[this.CONTEXT_UID],u=h[a];if(u)return h[s.id]=u,u;var l=t.buffers,c=t.attributes,d={},f={};for(var p in l)d[p]=0,f[p]=0;for(var p in c)!c[p].size&&s.attributeData[p]?c[p].size=s.attributeData[p].size:c[p].size||console.warn("PIXI Geometry attribute '"+p+"' size cannot be determined (likely the bound shader does not have the attribute)"),d[c[p].buffer]+=c[p].size*Pi[c[p].type];for(var p in c){var _=c[p],m=_.size;void 0===_.stride&&(d[_.buffer]===m*Pi[_.type]?_.stride=0:_.stride=d[_.buffer]),void 0===_.start&&(_.start=f[_.buffer],f[_.buffer]+=m*Pi[_.type])}u=i.createVertexArray(),i.bindVertexArray(u);for(var v=0;v<l.length;v++){var y=l[v];o.bind(y),r&&y._glBuffers[n].refCount++}return this.activateVao(t,s),this._activeVao=u,h[s.id]=u,h[a]=u,u},e.prototype.disposeGeometry=function(t,e){var r;if(this.managedGeometries[t.id]){delete this.managedGeometries[t.id];var i=t.glVertexArrayObjects[this.CONTEXT_UID],n=this.gl,o=t.buffers,s=null===(r=this.renderer)||void 0===r?void 0:r.buffer;if(t.disposeRunner.remove(this),i){if(s)for(var a=0;a<o.length;a++){var h=o[a]._glBuffers[this.CONTEXT_UID];h&&(h.refCount--,0!==h.refCount||e||s.dispose(o[a],e))}if(!e)for(var u in i)if("g"===u[0]){var l=i[u];this._activeVao===l&&this.unbind(),n.deleteVertexArray(l)}delete t.glVertexArrayObjects[this.CONTEXT_UID]}}},e.prototype.disposeAll=function(t){for(var e=Object.keys(this.managedGeometries),r=0;r<e.length;r++)this.disposeGeometry(this.managedGeometries[e[r]],t)},e.prototype.activateVao=function(t,e){var r=this.gl,i=this.CONTEXT_UID,n=this.renderer.buffer,o=t.buffers,s=t.attributes;t.indexBuffer&&n.bind(t.indexBuffer);var a=null;for(var h in s){var u=s[h],l=o[u.buffer],c=l._glBuffers[i];if(e.attributeData[h]){a!==c&&(n.bind(l),a=c);var d=e.attributeData[h].location;if(r.enableVertexAttribArray(d),r.vertexAttribPointer(d,u.size,u.type||r.FLOAT,u.normalized,u.stride,u.start),u.instance){if(!this.hasInstance)throw new Error("geometry error, GPU Instancing is not supported on this device");r.vertexAttribDivisor(d,1)}}}},e.prototype.draw=function(t,e,r,i){var n=this.gl,o=this._activeGeometry;if(o.indexBuffer){var s=o.indexBuffer.data.BYTES_PER_ELEMENT,a=2===s?n.UNSIGNED_SHORT:n.UNSIGNED_INT;2===s||4===s&&this.canUseUInt32ElementIndex?o.instanced?n.drawElementsInstanced(t,e||o.indexBuffer.data.length,a,(r||0)*s,i||1):n.drawElements(t,e||o.indexBuffer.data.length,a,(r||0)*s):console.warn("unsupported index buffer type: uint32")}else o.instanced?n.drawArraysInstanced(t,r,e||o.getSize(),i||1):n.drawArrays(t,r,e||o.getSize());return this},e.prototype.unbind=function(){this.gl.bindVertexArray(null),this._activeVao=null,this._activeGeometry=null},e.prototype.destroy=function(){this.renderer=null},e}(),Di=function(){function e(e){void 0===e&&(e=null),this.type=t.MASK_TYPES.NONE,this.autoDetect=!0,this.maskObject=e||null,this.pooled=!1,this.isMaskData=!0,this.resolution=null,this.multisample=rt.FILTER_MULTISAMPLE,this._stencilCounter=0,this._scissorCounter=0,this._scissorRect=null,this._target=null}return e.prototype.reset=function(){this.pooled&&(this.maskObject=null,this.type=t.MASK_TYPES.NONE,this.autoDetect=!0),this._target=null},e.prototype.copyCountersOrReset=function(t){t?(this._stencilCounter=t._stencilCounter,this._scissorCounter=t._scissorCounter,this._scissorRect=t._scissorRect):(this._stencilCounter=0,this._scissorCounter=0,this._scissorRect=null)},e}();function Ni(t,e,r){var i=t.createShader(e);return t.shaderSource(i,r),t.compileShader(i),i}function wi(t,e){var r=t.getShaderSource(e).split("\n").map(function(t,e){return e+": "+t}),i=t.getShaderInfoLog(e),n=i.split("\n"),o={},s=n.map(function(t){return parseFloat(t.replace(/^ERROR\: 0\:([\d]+)\:.*$/,"$1"))}).filter(function(t){return!(!t||o[t]||(o[t]=!0,0))}),a=[""];s.forEach(function(t){r[t-1]="%c"+r[t-1]+"%c",a.push("background: #FF0000; color:#FFFFFF; font-size: 10px","font-size: 10px")});var h=r.join("\n");a[0]=h,console.error(i),console.groupCollapsed("click to view full shader code"),console.warn.apply(console,a),console.groupEnd()}function Ci(t){for(var e=new Array(t),r=0;r<e.length;r++)e[r]=!1;return e}function Li(t,e){switch(t){case"float":return 0;case"vec2":return new Float32Array(2*e);case"vec3":return new Float32Array(3*e);case"vec4":return new Float32Array(4*e);case"int":case"uint":case"sampler2D":case"sampler2DArray":return 0;case"ivec2":return new Int32Array(2*e);case"ivec3":return new Int32Array(3*e);case"ivec4":return new Int32Array(4*e);case"uvec2":return new Uint32Array(2*e);case"uvec3":return new Uint32Array(3*e);case"uvec4":return new Uint32Array(4*e);case"bool":return!1;case"bvec2":return Ci(2*e);case"bvec3":return Ci(3*e);case"bvec4":return Ci(4*e);case"mat2":return new Float32Array([1,0,0,1]);case"mat3":return new Float32Array([1,0,0,0,1,0,0,0,1]);case"mat4":return new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1])}return null}var Fi,Ui={},Bi=Ui;function Gi(){if(Bi===Ui||Bi&&Bi.isContextLost()){var e=document.createElement("canvas"),r=void 0;rt.PREFER_ENV>=t.ENV.WEBGL2&&(r=e.getContext("webgl2",{})),r||((r=e.getContext("webgl",{})||e.getContext("experimental-webgl",{}))?r.getExtension("WEBGL_draw_buffers"):r=null),Bi=r}return Bi}function Xi(e,r,i){if("precision"!==e.substring(0,9)){var n=r;return r===t.PRECISION.HIGH&&i!==t.PRECISION.HIGH&&(n=t.PRECISION.MEDIUM),"precision "+n+" float;\n"+e}return i!==t.PRECISION.HIGH&&"precision highp"===e.substring(0,15)?e.replace("precision highp","precision mediump"):e}var ki={float:1,vec2:2,vec3:3,vec4:4,int:1,ivec2:2,ivec3:3,ivec4:4,uint:1,uvec2:2,uvec3:3,uvec4:4,bool:1,bvec2:2,bvec3:3,bvec4:4,mat2:4,mat3:9,mat4:16,sampler2D:1};function Hi(t){return ki[t]}var Yi=null,ji={FLOAT:"float",FLOAT_VEC2:"vec2",FLOAT_VEC3:"vec3",FLOAT_VEC4:"vec4",INT:"int",INT_VEC2:"ivec2",INT_VEC3:"ivec3",INT_VEC4:"ivec4",UNSIGNED_INT:"uint",UNSIGNED_INT_VEC2:"uvec2",UNSIGNED_INT_VEC3:"uvec3",UNSIGNED_INT_VEC4:"uvec4",BOOL:"bool",BOOL_VEC2:"bvec2",BOOL_VEC3:"bvec3",BOOL_VEC4:"bvec4",FLOAT_MAT2:"mat2",FLOAT_MAT3:"mat3",FLOAT_MAT4:"mat4",SAMPLER_2D:"sampler2D",INT_SAMPLER_2D:"sampler2D",UNSIGNED_INT_SAMPLER_2D:"sampler2D",SAMPLER_CUBE:"samplerCube",INT_SAMPLER_CUBE:"samplerCube",UNSIGNED_INT_SAMPLER_CUBE:"samplerCube",SAMPLER_2D_ARRAY:"sampler2DArray",INT_SAMPLER_2D_ARRAY:"sampler2DArray",UNSIGNED_INT_SAMPLER_2D_ARRAY:"sampler2DArray"};function Vi(t,e){if(!Yi){var r=Object.keys(ji);Yi={};for(var i=0;i<r.length;++i){var n=r[i];Yi[t[n]]=ji[n]}}return Yi[e]}var Wi,zi=[{test:function(t){return"float"===t.type&&1===t.size},code:function(t){return'\n            if(uv["'+t+'"] !== ud["'+t+'"].value)\n            {\n                ud["'+t+'"].value = uv["'+t+'"]\n                gl.uniform1f(ud["'+t+'"].location, uv["'+t+'"])\n            }\n            '}},{test:function(t){return("sampler2D"===t.type||"samplerCube"===t.type||"sampler2DArray"===t.type)&&1===t.size&&!t.isArray},code:function(t){return't = syncData.textureCount++;\n\n            renderer.texture.bind(uv["'+t+'"], t);\n\n            if(ud["'+t+'"].value !== t)\n            {\n                ud["'+t+'"].value = t;\n                gl.uniform1i(ud["'+t+'"].location, t);\n; // eslint-disable-line max-len\n            }'}},{test:function(t,e){return"mat3"===t.type&&1===t.size&&void 0!==e.a},code:function(t){return'\n            gl.uniformMatrix3fv(ud["'+t+'"].location, false, uv["'+t+'"].toArray(true));\n            '},codeUbo:function(t){return"\n                var "+t+"_matrix = uv."+t+".toArray(true);\n\n                data[offset] = "+t+"_matrix[0];\n                data[offset+1] = "+t+"_matrix[1];\n                data[offset+2] = "+t+"_matrix[2];\n        \n                data[offset + 4] = "+t+"_matrix[3];\n                data[offset + 5] = "+t+"_matrix[4];\n                data[offset + 6] = "+t+"_matrix[5];\n        \n                data[offset + 8] = "+t+"_matrix[6];\n                data[offset + 9] = "+t+"_matrix[7];\n                data[offset + 10] = "+t+"_matrix[8];\n            "}},{test:function(t,e){return"vec2"===t.type&&1===t.size&&void 0!==e.x},code:function(t){return'\n                cv = ud["'+t+'"].value;\n                v = uv["'+t+'"];\n\n                if(cv[0] !== v.x || cv[1] !== v.y)\n                {\n                    cv[0] = v.x;\n                    cv[1] = v.y;\n                    gl.uniform2f(ud["'+t+'"].location, v.x, v.y);\n                }'},codeUbo:function(t){return"\n                v = uv."+t+";\n\n                data[offset] = v.x;\n                data[offset+1] = v.y;\n            "}},{test:function(t){return"vec2"===t.type&&1===t.size},code:function(t){return'\n                cv = ud["'+t+'"].value;\n                v = uv["'+t+'"];\n\n                if(cv[0] !== v[0] || cv[1] !== v[1])\n                {\n                    cv[0] = v[0];\n                    cv[1] = v[1];\n                    gl.uniform2f(ud["'+t+'"].location, v[0], v[1]);\n                }\n            '}},{test:function(t,e){return"vec4"===t.type&&1===t.size&&void 0!==e.width},code:function(t){return'\n                cv = ud["'+t+'"].value;\n                v = uv["'+t+'"];\n\n                if(cv[0] !== v.x || cv[1] !== v.y || cv[2] !== v.width || cv[3] !== v.height)\n                {\n                    cv[0] = v.x;\n                    cv[1] = v.y;\n                    cv[2] = v.width;\n                    cv[3] = v.height;\n                    gl.uniform4f(ud["'+t+'"].location, v.x, v.y, v.width, v.height)\n                }'},codeUbo:function(t){return"\n                    v = uv."+t+";\n\n                    data[offset] = v.x;\n                    data[offset+1] = v.y;\n                    data[offset+2] = v.width;\n                    data[offset+3] = v.height;\n                "}},{test:function(t){return"vec4"===t.type&&1===t.size},code:function(t){return'\n                cv = ud["'+t+'"].value;\n                v = uv["'+t+'"];\n\n                if(cv[0] !== v[0] || cv[1] !== v[1] || cv[2] !== v[2] || cv[3] !== v[3])\n                {\n                    cv[0] = v[0];\n                    cv[1] = v[1];\n                    cv[2] = v[2];\n                    cv[3] = v[3];\n\n                    gl.uniform4f(ud["'+t+'"].location, v[0], v[1], v[2], v[3])\n                }'}}],qi={float:"\n    if(cv !== v)\n    {\n        cv.v = v;\n        gl.uniform1f(location, v)\n    }",vec2:"\n    if(cv[0] !== v[0] || cv[1] !== v[1])\n    {\n        cv[0] = v[0];\n        cv[1] = v[1];\n        gl.uniform2f(location, v[0], v[1])\n    }",vec3:"\n    if(cv[0] !== v[0] || cv[1] !== v[1] || cv[2] !== v[2])\n    {\n        cv[0] = v[0];\n        cv[1] = v[1];\n        cv[2] = v[2];\n\n        gl.uniform3f(location, v[0], v[1], v[2])\n    }",vec4:"gl.uniform4f(location, v[0], v[1], v[2], v[3])",int:"gl.uniform1i(location, v)",ivec2:"gl.uniform2i(location, v[0], v[1])",ivec3:"gl.uniform3i(location, v[0], v[1], v[2])",ivec4:"gl.uniform4i(location, v[0], v[1], v[2], v[3])",uint:"gl.uniform1ui(location, v)",uvec2:"gl.uniform2ui(location, v[0], v[1])",uvec3:"gl.uniform3ui(location, v[0], v[1], v[2])",uvec4:"gl.uniform4ui(location, v[0], v[1], v[2], v[3])",bool:"\n    if(cv !== v)\n    {\n        cv.v = v;\n        gl.uniform1i(location, v)\n    }",bvec2:"gl.uniform2i(location, v[0], v[1])",bvec3:"gl.uniform3i(location, v[0], v[1], v[2])",bvec4:"gl.uniform4i(location, v[0], v[1], v[2], v[3])",mat2:"gl.uniformMatrix2fv(location, false, v)",mat3:"gl.uniformMatrix3fv(location, false, v)",mat4:"gl.uniformMatrix4fv(location, false, v)",sampler2D:"gl.uniform1i(location, v)",samplerCube:"gl.uniform1i(location, v)",sampler2DArray:"gl.uniform1i(location, v)"},Ki={float:"gl.uniform1fv(location, v)",vec2:"gl.uniform2fv(location, v)",vec3:"gl.uniform3fv(location, v)",vec4:"gl.uniform4fv(location, v)",mat4:"gl.uniformMatrix4fv(location, false, v)",mat3:"gl.uniformMatrix3fv(location, false, v)",mat2:"gl.uniformMatrix2fv(location, false, v)",int:"gl.uniform1iv(location, v)",ivec2:"gl.uniform2iv(location, v)",ivec3:"gl.uniform3iv(location, v)",ivec4:"gl.uniform4iv(location, v)",uint:"gl.uniform1uiv(location, v)",uvec2:"gl.uniform2uiv(location, v)",uvec3:"gl.uniform3uiv(location, v)",uvec4:"gl.uniform4uiv(location, v)",bool:"gl.uniform1iv(location, v)",bvec2:"gl.uniform2iv(location, v)",bvec3:"gl.uniform3iv(location, v)",bvec4:"gl.uniform4iv(location, v)",sampler2D:"gl.uniform1iv(location, v)",samplerCube:"gl.uniform1iv(location, v)",sampler2DArray:"gl.uniform1iv(location, v)"},Zi=["precision mediump float;","void main(void){","float test = 0.1;","%forloop%","gl_FragColor = vec4(0.0);","}"].join("\n");function Qi(t){for(var e="",r=0;r<t;++r)r>0&&(e+="\nelse "),r<t-1&&(e+="if(test == "+r+".0){}");return e}function Ji(t,e){if(0===t)throw new Error("Invalid value of `0` passed to `checkMaxIfStatementsInShader`");for(var r=e.createShader(e.FRAGMENT_SHADER);;){var i=Zi.replace(/%forloop%/gi,Qi(t));if(e.shaderSource(r,i),e.compileShader(r),e.getShaderParameter(r,e.COMPILE_STATUS))break;t=t/2|0}return t}var $i=0,tn={},en=function(){function e(r,i,n){void 0===n&&(n="pixi-shader"),this.id=$i++,this.vertexSrc=r||e.defaultVertexSrc,this.fragmentSrc=i||e.defaultFragmentSrc,this.vertexSrc=this.vertexSrc.trim(),this.fragmentSrc=this.fragmentSrc.trim(),"#version"!==this.vertexSrc.substring(0,8)&&(n=n.replace(/\s+/g,"-"),tn[n]?(tn[n]++,n+="-"+tn[n]):tn[n]=1,this.vertexSrc="#define SHADER_NAME "+n+"\n"+this.vertexSrc,this.fragmentSrc="#define SHADER_NAME "+n+"\n"+this.fragmentSrc,this.vertexSrc=Xi(this.vertexSrc,rt.PRECISION_VERTEX,t.PRECISION.HIGH),this.fragmentSrc=Xi(this.fragmentSrc,rt.PRECISION_FRAGMENT,function(){if(!Fi){Fi=t.PRECISION.MEDIUM;var e=Gi();if(e&&e.getShaderPrecisionFormat){var r=e.getShaderPrecisionFormat(e.FRAGMENT_SHADER,e.HIGH_FLOAT);Fi=r.precision?t.PRECISION.HIGH:t.PRECISION.MEDIUM}}return Fi}())),this.glPrograms={},this.syncUniforms=null}return Object.defineProperty(e,"defaultVertexSrc",{get:function(){return"attribute vec2 aVertexPosition;\nattribute vec2 aTextureCoord;\n\nuniform mat3 projectionMatrix;\n\nvarying vec2 vTextureCoord;\n\nvoid main(void){\n   gl_Position = vec4((projectionMatrix * vec3(aVertexPosition, 1.0)).xy, 0.0, 1.0);\n   vTextureCoord = aTextureCoord;\n}\n"},enumerable:!1,configurable:!0}),Object.defineProperty(e,"defaultFragmentSrc",{get:function(){return"varying vec2 vTextureCoord;\n\nuniform sampler2D uSampler;\n\nvoid main(void){\n   gl_FragColor *= texture2D(uSampler, vTextureCoord);\n}"},enumerable:!1,configurable:!0}),e.from=function(t,r,i){var n=t+r,o=Me[n];return o||(Me[n]=o=new e(t,r,i)),o},e}(),rn=function(){function t(t,e){this.uniformBindCount=0,this.program=t,this.uniformGroup=e?e instanceof vi?e:new vi(e):new vi({})}return t.prototype.checkUniformExists=function(t,e){if(e.uniforms[t])return!0;for(var r in e.uniforms){var i=e.uniforms[r];if(i.group&&this.checkUniformExists(t,i))return!0}return!1},t.prototype.destroy=function(){this.uniformGroup=null},Object.defineProperty(t.prototype,"uniforms",{get:function(){return this.uniformGroup.uniforms},enumerable:!1,configurable:!0}),t.from=function(e,r,i){return new t(en.from(e,r),i)},t}(),nn=function(){function e(){this.data=0,this.blendMode=t.BLEND_MODES.NORMAL,this.polygonOffset=0,this.blend=!0,this.depthMask=!0}return Object.defineProperty(e.prototype,"blend",{get:function(){return!!(1&this.data)},set:function(t){!!(1&this.data)!==t&&(this.data^=1)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"offsets",{get:function(){return!!(2&this.data)},set:function(t){!!(2&this.data)!==t&&(this.data^=2)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"culling",{get:function(){return!!(4&this.data)},set:function(t){!!(4&this.data)!==t&&(this.data^=4)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"depthTest",{get:function(){return!!(8&this.data)},set:function(t){!!(8&this.data)!==t&&(this.data^=8)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"depthMask",{get:function(){return!!(32&this.data)},set:function(t){!!(32&this.data)!==t&&(this.data^=32)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"clockwiseFrontFace",{get:function(){return!!(16&this.data)},set:function(t){!!(16&this.data)!==t&&(this.data^=16)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"blendMode",{get:function(){return this._blendMode},set:function(e){this.blend=e!==t.BLEND_MODES.NONE,this._blendMode=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"polygonOffset",{get:function(){return this._polygonOffset},set:function(t){this.offsets=!!t,this._polygonOffset=t},enumerable:!1,configurable:!0}),e.for2d=function(){var t=new e;return t.depthTest=!1,t.blend=!0,t},e}(),on=function(t){function e(r,i,n){var o=this,s=en.from(r||e.defaultVertexSrc,i||e.defaultFragmentSrc);return(o=t.call(this,s,n)||this).padding=0,o.resolution=rt.FILTER_RESOLUTION,o.multisample=rt.FILTER_MULTISAMPLE,o.enabled=!0,o.autoFit=!0,o.state=new nn,o}return Lr(e,t),e.prototype.apply=function(t,e,r,i,n){t.applyFilter(this,e,r,i)},Object.defineProperty(e.prototype,"blendMode",{get:function(){return this.state.blendMode},set:function(t){this.state.blendMode=t},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"resolution",{get:function(){return this._resolution},set:function(t){this._resolution=t},enumerable:!1,configurable:!0}),Object.defineProperty(e,"defaultVertexSrc",{get:function(){return"attribute vec2 aVertexPosition;\n\nuniform mat3 projectionMatrix;\n\nvarying vec2 vTextureCoord;\n\nuniform vec4 inputSize;\nuniform vec4 outputFrame;\n\nvec4 filterVertexPosition( void )\n{\n    vec2 position = aVertexPosition * max(outputFrame.zw, vec2(0.)) + outputFrame.xy;\n\n    return vec4((projectionMatrix * vec3(position, 1.0)).xy, 0.0, 1.0);\n}\n\nvec2 filterTextureCoord( void )\n{\n    return aVertexPosition * (outputFrame.zw * inputSize.zw);\n}\n\nvoid main(void)\n{\n    gl_Position = filterVertexPosition();\n    vTextureCoord = filterTextureCoord();\n}\n"},enumerable:!1,configurable:!0}),Object.defineProperty(e,"defaultFragmentSrc",{get:function(){return"varying vec2 vTextureCoord;\n\nuniform sampler2D uSampler;\n\nvoid main(void){\n   gl_FragColor = texture2D(uSampler, vTextureCoord);\n}\n"},enumerable:!1,configurable:!0}),e}(rn),sn="attribute vec2 aVertexPosition;\nattribute vec2 aTextureCoord;\n\nuniform mat3 projectionMatrix;\nuniform mat3 otherMatrix;\n\nvarying vec2 vMaskCoord;\nvarying vec2 vTextureCoord;\n\nvoid main(void)\n{\n    gl_Position = vec4((projectionMatrix * vec3(aVertexPosition, 1.0)).xy, 0.0, 1.0);\n\n    vTextureCoord = aTextureCoord;\n    vMaskCoord = ( otherMatrix * vec3( aTextureCoord, 1.0)  ).xy;\n}\n",an="varying vec2 vMaskCoord;\nvarying vec2 vTextureCoord;\n\nuniform sampler2D uSampler;\nuniform sampler2D mask;\nuniform float alpha;\nuniform float npmAlpha;\nuniform vec4 maskClamp;\n\nvoid main(void)\n{\n    float clip = step(3.5,\n        step(maskClamp.x, vMaskCoord.x) +\n        step(maskClamp.y, vMaskCoord.y) +\n        step(vMaskCoord.x, maskClamp.z) +\n        step(vMaskCoord.y, maskClamp.w));\n\n    vec4 original = texture2D(uSampler, vTextureCoord);\n    vec4 masky = texture2D(mask, vMaskCoord);\n    float alphaMul = 1.0 - npmAlpha * (1.0 - masky.a);\n\n    original *= (alphaMul * masky.r * alpha * clip);\n\n    gl_FragColor = original;\n}\n",hn=new Ze,un=function(){function t(t,e){this._texture=t,this.mapCoord=new Ze,this.uClampFrame=new Float32Array(4),this.uClampOffset=new Float32Array(2),this._textureID=-1,this._updateID=0,this.clampOffset=0,this.clampMargin=void 0===e?.5:e,this.isSimple=!1}return Object.defineProperty(t.prototype,"texture",{get:function(){return this._texture},set:function(t){this._texture=t,this._textureID=-1},enumerable:!1,configurable:!0}),t.prototype.multiplyUvs=function(t,e){void 0===e&&(e=t);for(var r=this.mapCoord,i=0;i<t.length;i+=2){var n=t[i],o=t[i+1];e[i]=n*r.a+o*r.c+r.tx,e[i+1]=n*r.b+o*r.d+r.ty}return e},t.prototype.update=function(t){var e=this._texture;if(!e||!e.valid)return!1;if(!t&&this._textureID===e._updateID)return!1;this._textureID=e._updateID,this._updateID++;var r=e._uvs;this.mapCoord.set(r.x1-r.x0,r.y1-r.y0,r.x3-r.x0,r.y3-r.y0,r.x0,r.y0);var i=e.orig,n=e.trim;n&&(hn.set(i.width/n.width,0,0,i.height/n.height,-n.x/n.width,-n.y/n.height),this.mapCoord.append(hn));var o=e.baseTexture,s=this.uClampFrame,a=this.clampMargin/o.resolution,h=this.clampOffset;return s[0]=(e._frame.x+a+h)/o.width,s[1]=(e._frame.y+a+h)/o.height,s[2]=(e._frame.x+e._frame.width-a+h)/o.width,s[3]=(e._frame.y+e._frame.height-a+h)/o.height,this.uClampOffset[0]=h/o.realWidth,this.uClampOffset[1]=h/o.realHeight,this.isSimple=e._frame.width===o.width&&e._frame.height===o.height&&0===e.rotate,!0},t}(),ln=function(t){function e(e){var r=this,i=new Ze;return r=t.call(this,sn,an)||this,e.renderable=!1,r.maskSprite=e,r.maskMatrix=i,r}return Lr(e,t),e.prototype.apply=function(t,e,r,i){var n=this.maskSprite,o=n._texture;o.valid&&(o.uvMatrix||(o.uvMatrix=new un(o,0)),o.uvMatrix.update(),this.uniforms.npmAlpha=o.baseTexture.alphaMode?0:1,this.uniforms.mask=o,this.uniforms.otherMatrix=t.calculateSpriteMatrix(this.maskMatrix,n).prepend(o.uvMatrix.mapCoord),this.uniforms.alpha=n.worldAlpha,this.uniforms.maskClamp=o.uvMatrix.uClampFrame,t.applyFilter(this,e,r,i))},e}(on),cn=function(){function e(t){this.renderer=t,this.enableScissor=!0,this.alphaMaskPool=[],this.maskDataPool=[],this.maskStack=[],this.alphaMaskIndex=0}return e.prototype.setMaskStack=function(t){this.maskStack=t,this.renderer.scissor.setMaskStack(t),this.renderer.stencil.setMaskStack(t)},e.prototype.push=function(e,r){var i=r;if(!i.isMaskData){var n=this.maskDataPool.pop()||new Di;n.pooled=!0,n.maskObject=r,i=n}switch(i.autoDetect&&this.detect(i),i.copyCountersOrReset(this.maskStack[this.maskStack.length-1]),i._target=e,i.type){case t.MASK_TYPES.SCISSOR:this.maskStack.push(i),this.renderer.scissor.push(i);break;case t.MASK_TYPES.STENCIL:this.maskStack.push(i),this.renderer.stencil.push(i);break;case t.MASK_TYPES.SPRITE:i.copyCountersOrReset(null),this.pushSpriteMask(i),this.maskStack.push(i)}},e.prototype.pop=function(e){var r=this.maskStack.pop();if(r&&r._target===e){switch(r.type){case t.MASK_TYPES.SCISSOR:this.renderer.scissor.pop();break;case t.MASK_TYPES.STENCIL:this.renderer.stencil.pop(r.maskObject);break;case t.MASK_TYPES.SPRITE:this.popSpriteMask()}r.reset(),r.pooled&&this.maskDataPool.push(r)}},e.prototype.detect=function(e){var r=e.maskObject;if(r.isSprite)e.type=t.MASK_TYPES.SPRITE;else if(e.type=t.MASK_TYPES.STENCIL,this.enableScissor&&r.isFastRect&&r.isFastRect()){var i=r.worldTransform,n=Math.atan2(i.b,i.a),o=Math.atan2(i.d,i.c);n=Math.round(n*(180/Math.PI)*100),o=((o=Math.round(o*(180/Math.PI)*100)-n)%18e3+18e3)%18e3,0==(n=(n%9e3+9e3)%9e3)&&9e3===o&&(e.type=t.MASK_TYPES.SCISSOR)}},e.prototype.pushSpriteMask=function(t){var e,r,i=t.maskObject,n=t._target,o=this.alphaMaskPool[this.alphaMaskIndex];o||(o=this.alphaMaskPool[this.alphaMaskIndex]=[new ln(i)]);var s,a,h=this.renderer,u=h.renderTexture;if(u.current){var l=u.current;s=t.resolution||l.resolution,a=null!==(e=t.multisample)&&void 0!==e?e:l.multisample}else s=t.resolution||h.resolution,a=null!==(r=t.multisample)&&void 0!==r?r:h.multisample;o[0].resolution=s,o[0].multisample=a,o[0].maskSprite=i;var c=n.filterArea;n.filterArea=i.getBounds(!0),h.filter.push(n,o),n.filterArea=c,this.alphaMaskIndex++},e.prototype.popSpriteMask=function(){this.renderer.filter.pop(),this.alphaMaskIndex--},e.prototype.destroy=function(){this.renderer=null},e}(),dn=function(){function t(t){this.renderer=t,this.maskStack=[],this.glConst=0}return t.prototype.getStackLength=function(){return this.maskStack.length},t.prototype.setMaskStack=function(t){var e=this.renderer.gl,r=this.getStackLength();this.maskStack=t;var i=this.getStackLength();i!==r&&(0===i?e.disable(this.glConst):(e.enable(this.glConst),this._useCurrent()))},t.prototype._useCurrent=function(){},t.prototype.destroy=function(){this.renderer=null,this.maskStack=null},t}(),fn=function(t){function e(e){var r=t.call(this,e)||this;return r.glConst=WebGLRenderingContext.SCISSOR_TEST,r}return Lr(e,t),e.prototype.getStackLength=function(){var t=this.maskStack[this.maskStack.length-1];return t?t._scissorCounter:0},e.prototype.push=function(t){var e=t.maskObject;e.renderable=!0;var r=t._scissorRect,i=e.getBounds(!0),n=this.renderer.gl;e.renderable=!1,r?i.fit(r):n.enable(n.SCISSOR_TEST),t._scissorCounter++,t._scissorRect=i,this._useCurrent()},e.prototype.pop=function(){var t=this.renderer.gl;this.getStackLength()>0?this._useCurrent():t.disable(t.SCISSOR_TEST)},e.prototype._useCurrent=function(){var t=this.maskStack[this.maskStack.length-1]._scissorRect,e=this.renderer.renderTexture.current,r=this.renderer.projection,i=r.transform,n=r.sourceFrame,o=r.destinationFrame,s=e?e.resolution:this.renderer.resolution,a=o.width/n.width,h=o.height/n.height,u=((t.x-n.x)*a+o.x)*s,l=((t.y-n.y)*h+o.y)*s,c=t.width*a*s,d=t.height*h*s;i&&(u+=i.tx*s,l+=i.ty*s),e||(l=this.renderer.height-d-l),u=Math.round(u),l=Math.round(l),c=Math.round(c),d=Math.round(d),this.renderer.gl.scissor(u,l,c,d)},e}(dn),pn=function(t){function e(e){var r=t.call(this,e)||this;return r.glConst=WebGLRenderingContext.STENCIL_TEST,r}return Lr(e,t),e.prototype.getStackLength=function(){var t=this.maskStack[this.maskStack.length-1];return t?t._stencilCounter:0},e.prototype.push=function(t){var e=t.maskObject,r=this.renderer.gl,i=t._stencilCounter;0===i&&(this.renderer.framebuffer.forceStencil(),r.enable(r.STENCIL_TEST)),t._stencilCounter++,r.colorMask(!1,!1,!1,!1),r.stencilFunc(r.EQUAL,i,4294967295),r.stencilOp(r.KEEP,r.KEEP,r.INCR),e.renderable=!0,e.render(this.renderer),this.renderer.batch.flush(),e.renderable=!1,this._useCurrent()},e.prototype.pop=function(t){var e=this.renderer.gl;0===this.getStackLength()?(e.disable(e.STENCIL_TEST),e.clearStencil(0),e.clear(e.STENCIL_BUFFER_BIT)):(e.colorMask(!1,!1,!1,!1),e.stencilOp(e.KEEP,e.KEEP,e.DECR),t.renderable=!0,t.render(this.renderer),this.renderer.batch.flush(),t.renderable=!1,this._useCurrent())},e.prototype._useCurrent=function(){var t=this.renderer.gl;t.colorMask(!0,!0,!0,!0),t.stencilFunc(t.EQUAL,this.getStackLength(),4294967295),t.stencilOp(t.KEEP,t.KEEP,t.KEEP)},e}(dn),_n=function(){function t(t){this.renderer=t,this.destinationFrame=null,this.sourceFrame=null,this.defaultFrame=null,this.projectionMatrix=new Ze,this.transform=null}return t.prototype.update=function(t,e,r,i){this.destinationFrame=t||this.destinationFrame||this.defaultFrame,this.sourceFrame=e||this.sourceFrame||t,this.calculateProjection(this.destinationFrame,this.sourceFrame,r,i),this.transform&&this.projectionMatrix.append(this.transform);var n=this.renderer;n.globalUniforms.uniforms.projectionMatrix=this.projectionMatrix,n.globalUniforms.update(),n.shader.shader&&n.shader.syncUniformGroup(n.shader.shader.uniforms.globals)},t.prototype.calculateProjection=function(t,e,r,i){var n=this.projectionMatrix,o=i?-1:1;n.identity(),n.a=1/e.width*2,n.d=o*(1/e.height*2),n.tx=-1-e.x*n.a,n.ty=-o-e.y*n.d},t.prototype.setTransform=function(t){},t.prototype.destroy=function(){this.renderer=null},t}(),mn=new Ye,vn=new Ye,yn=function(){function t(t){this.renderer=t,this.clearColor=t._backgroundColorRgba,this.defaultMaskStack=[],this.current=null,this.sourceFrame=new Ye,this.destinationFrame=new Ye,this.viewportFrame=new Ye}return t.prototype.bind=function(t,e,r){void 0===t&&(t=null);var i,n,o,s=this.renderer;this.current=t,t?(o=(i=t.baseTexture).resolution,e||(mn.width=t.frame.width,mn.height=t.frame.height,e=mn),r||(vn.x=t.frame.x,vn.y=t.frame.y,vn.width=e.width,vn.height=e.height,r=vn),n=i.framebuffer):(o=s.resolution,e||(mn.width=s.screen.width,mn.height=s.screen.height,e=mn),r||((r=mn).width=e.width,r.height=e.height));var a=this.viewportFrame;a.x=r.x*o,a.y=r.y*o,a.width=r.width*o,a.height=r.height*o,t||(a.y=s.view.height-(a.y+a.height)),a.ceil(),this.renderer.framebuffer.bind(n,a),this.renderer.projection.update(r,e,o,!n),t?this.renderer.mask.setMaskStack(i.maskStack):this.renderer.mask.setMaskStack(this.defaultMaskStack),this.sourceFrame.copyFrom(e),this.destinationFrame.copyFrom(r)},t.prototype.clear=function(t,e){t=this.current?t||this.current.baseTexture.clearColor:t||this.clearColor;var r=this.destinationFrame,i=this.current?this.current.baseTexture:this.renderer.screen,n=r.width!==i.width||r.height!==i.height;if(n){var o=this.viewportFrame,s=o.x,a=o.y,h=o.width,u=o.height;s=Math.round(s),a=Math.round(a),h=Math.round(h),u=Math.round(u),this.renderer.gl.enable(this.renderer.gl.SCISSOR_TEST),this.renderer.gl.scissor(s,a,h,u)}this.renderer.framebuffer.clear(t[0],t[1],t[2],t[3],e),n&&this.renderer.scissor.pop()},t.prototype.resize=function(){this.bind(null)},t.prototype.reset=function(){this.bind(null)},t.prototype.destroy=function(){this.renderer=null},t}();function En(t,e,r,i,n){r.buffer.update(n)}var gn={float:"\n        data[offset] = v;\n    ",vec2:"\n        data[offset] = v[0];\n        data[offset+1] = v[1];\n    ",vec3:"\n        data[offset] = v[0];\n        data[offset+1] = v[1];\n        data[offset+2] = v[2];\n\n    ",vec4:"\n        data[offset] = v[0];\n        data[offset+1] = v[1];\n        data[offset+2] = v[2];\n        data[offset+3] = v[3];\n    ",mat2:"\n        data[offset] = v[0];\n        data[offset+1] = v[1];\n\n        data[offset+4] = v[2];\n        data[offset+5] = v[3];\n    ",mat3:"\n        data[offset] = v[0];\n        data[offset+1] = v[1];\n        data[offset+2] = v[2];\n\n        data[offset + 4] = v[3];\n        data[offset + 5] = v[4];\n        data[offset + 6] = v[5];\n\n        data[offset + 8] = v[6];\n        data[offset + 9] = v[7];\n        data[offset + 10] = v[8];\n    ",mat4:"\n        for(var i = 0; i < 16; i++)\n        {\n            data[offset + i] = v[i];\n        }\n    "},Tn={float:4,vec2:8,vec3:12,vec4:16,int:4,ivec2:8,ivec3:12,ivec4:16,uint:4,uvec2:8,uvec3:12,uvec4:16,bool:4,bvec2:8,bvec3:12,bvec4:16,mat2:32,mat3:48,mat4:64};function bn(t){for(var e=t.map(function(t){return{data:t,offset:0,dataLen:0,dirty:0}}),r=0,i=0,n=0,o=0;o<e.length;o++){var s=e[o];if(r=Tn[s.data.type],s.data.size>1&&(r=Math.max(r,16)*s.data.size),s.dataLen=r,i%r!=0&&i<16){var a=i%r%16;i+=a,n+=a}i+r>16?(n=16*Math.ceil(n/16),s.offset=n,n+=r,i=r):(s.offset=n,i+=r,n+=r)}return{uboElements:e,size:n=16*Math.ceil(n/16)}}function Rn(t,e){var r=[];for(var i in t)e[i]&&r.push(e[i]);return r.sort(function(t,e){return t.index-e.index}),r}function xn(t,e){if(!t.autoManage)return{size:0,syncFunc:En};for(var r=bn(Rn(t.uniforms,e)),i=r.uboElements,n=r.size,o=["\n    var v = null;\n    var v2 = null;\n    var cv = null;\n    var t = 0;\n    var gl = renderer.gl\n    var index = 0;\n    var data = buffer.data;\n    "],s=0;s<i.length;s++){for(var a=i[s],h=t.uniforms[a.data.name],u=a.data.name,l=!1,c=0;c<zi.length;c++){var d=zi[c];if(d.codeUbo&&d.test(a.data,h)){o.push("offset = "+a.offset/4+";",zi[c].codeUbo(a.data.name,h)),l=!0;break}}if(!l)if(a.data.size>1){var f=Hi(a.data.type),p=Math.max(Tn[a.data.type]/16,1),_=f/p,m=(4-_%4)%4;o.push("\n                cv = ud."+u+".value;\n                v = uv."+u+";\n                offset = "+a.offset/4+";\n\n                t = 0;\n\n                for(var i=0; i < "+a.data.size*p+"; i++)\n                {\n                    for(var j = 0; j < "+_+"; j++)\n                    {\n                        data[offset++] = v[t++];\n                    }\n                    offset += "+m+";\n                }\n\n                ")}else{var v=gn[a.data.type];o.push("\n                cv = ud."+u+".value;\n                v = uv."+u+";\n                offset = "+a.offset/4+";\n                "+v+";\n                ")}}return o.push("\n       renderer.buffer.update(buffer);\n    "),{size:n,syncFunc:new Function("ud","uv","renderer","syncData","buffer",o.join("\n"))}}var An=function(){},Sn=function(){function t(t,e){this.program=t,this.uniformData=e,this.uniformGroups={},this.uniformDirtyGroups={},this.uniformBufferBindings={}}return t.prototype.destroy=function(){this.uniformData=null,this.uniformGroups=null,this.uniformDirtyGroups=null,this.uniformBufferBindings=null,this.program=null},t}();function On(t,e){var r=Ni(t,t.VERTEX_SHADER,e.vertexSrc),i=Ni(t,t.FRAGMENT_SHADER,e.fragmentSrc),n=t.createProgram();t.attachShader(n,r),t.attachShader(n,i),t.linkProgram(n),t.getProgramParameter(n,t.LINK_STATUS)||function(t,e,r,i){t.getProgramParameter(e,t.LINK_STATUS)||(t.getShaderParameter(r,t.COMPILE_STATUS)||wi(t,r),t.getShaderParameter(i,t.COMPILE_STATUS)||wi(t,i),console.error("PixiJS Error: Could not initialize shader."),""!==t.getProgramInfoLog(e)&&console.warn("PixiJS Warning: gl.getProgramInfoLog()",t.getProgramInfoLog(e)))}(t,n,r,i),e.attributeData=function(t,e){for(var r={},i=e.getProgramParameter(t,e.ACTIVE_ATTRIBUTES),n=0;n<i;n++){var o=e.getActiveAttrib(t,n);if(0!==o.name.indexOf("gl_")){var s=Vi(e,o.type),a={type:s,name:o.name,size:Hi(s),location:n};r[o.name]=a}}return r}(n,t),e.uniformData=function(t,e){for(var r={},i=e.getProgramParameter(t,e.ACTIVE_UNIFORMS),n=0;n<i;n++){var o=e.getActiveUniform(t,n),s=o.name.replace(/\[.*?\]$/,""),a=!!o.name.match(/\[.*?\]$/),h=Vi(e,o.type);r[s]={name:s,index:n,type:h,size:o.size,isArray:a,value:Li(h,o.size)}}return r}(n,t);var o=Object.keys(e.attributeData);o.sort(function(t,e){return t>e?1:-1});for(var s=0;s<o.length;s++)e.attributeData[o[s]].location=s,t.bindAttribLocation(n,s,o[s]);t.linkProgram(n),t.deleteShader(r),t.deleteShader(i);var a={};for(var s in e.uniformData){var h=e.uniformData[s];a[s]={location:t.getUniformLocation(n,s),value:Li(h.type,h.size)}}return new Sn(n,a)}var In=0,Pn={textureCount:0,uboCount:0},Mn=function(){function t(t){this.destroyed=!1,this.renderer=t,this.systemCheck(),this.gl=null,this.shader=null,this.program=null,this.cache={},this._uboCache={},this.id=In++}return t.prototype.systemCheck=function(){if(!function(){if("boolean"==typeof Wi)return Wi;try{var t=new Function("param1","param2","param3","return param1[param2] === param3;");Wi=!0===t({a:"b"},"a","b")}catch(t){Wi=!1}return Wi}())throw new Error("Current environment does not allow unsafe-eval, please use @pixi/unsafe-eval module to enable support.")},t.prototype.contextChange=function(t){this.gl=t,this.reset()},t.prototype.bind=function(t,e){t.uniforms.globals=this.renderer.globalUniforms;var r=t.program,i=r.glPrograms[this.renderer.CONTEXT_UID]||this.generateProgram(t);return this.shader=t,this.program!==r&&(this.program=r,this.gl.useProgram(i.program)),e||(Pn.textureCount=0,Pn.uboCount=0,this.syncUniformGroup(t.uniformGroup,Pn)),i},t.prototype.setUniforms=function(t){var e=this.shader.program,r=e.glPrograms[this.renderer.CONTEXT_UID];e.syncUniforms(r.uniformData,t,this.renderer)},t.prototype.syncUniformGroup=function(t,e){var r=this.getGlProgram();t.static&&t.dirtyId===r.uniformDirtyGroups[t.id]||(r.uniformDirtyGroups[t.id]=t.dirtyId,this.syncUniforms(t,r,e))},t.prototype.syncUniforms=function(t,e,r){(t.syncUniforms[this.shader.program.id]||this.createSyncGroups(t))(e.uniformData,t.uniforms,this.renderer,r)},t.prototype.createSyncGroups=function(t){var e=this.getSignature(t,this.shader.program.uniformData,"u");return this.cache[e]||(this.cache[e]=function(t,e){var r=["\n        var v = null;\n        var cv = null\n        var t = 0;\n        var gl = renderer.gl\n    "];for(var i in t.uniforms){var n=e[i];if(n){for(var o=t.uniforms[i],s=!1,a=0;a<zi.length;a++)if(zi[a].test(n,o)){r.push(zi[a].code(i,o)),s=!0;break}if(!s){var h=(1===n.size?qi:Ki)[n.type].replace("location",'ud["'+i+'"].location');r.push('\n            cv = ud["'+i+'"].value;\n            v = uv["'+i+'"];\n            '+h+";")}}else t.uniforms[i].group&&(t.uniforms[i].ubo?r.push("\n                        renderer.shader.syncUniformBufferGroup(uv."+i+", '"+i+"');\n                    "):r.push("\n                        renderer.shader.syncUniformGroup(uv."+i+", syncData);\n                    "))}return new Function("ud","uv","renderer","syncData",r.join("\n"))}(t,this.shader.program.uniformData)),t.syncUniforms[this.shader.program.id]=this.cache[e],t.syncUniforms[this.shader.program.id]},t.prototype.syncUniformBufferGroup=function(t,e){var r=this.getGlProgram();if(!t.static||0!==t.dirtyId||!r.uniformGroups[t.id]){t.dirtyId=0;var i=r.uniformGroups[t.id]||this.createSyncBufferGroup(t,r,e);t.buffer.update(),i(r.uniformData,t.uniforms,this.renderer,Pn,t.buffer)}this.renderer.buffer.bindBufferBase(t.buffer,r.uniformBufferBindings[e])},t.prototype.createSyncBufferGroup=function(t,e,r){var i=this.renderer.gl;this.renderer.buffer.bind(t.buffer);var n=this.gl.getUniformBlockIndex(e.program,r);e.uniformBufferBindings[r]=this.shader.uniformBindCount,i.uniformBlockBinding(e.program,n,this.shader.uniformBindCount),this.shader.uniformBindCount++;var o=this.getSignature(t,this.shader.program.uniformData,"ubo"),s=this._uboCache[o];if(s||(s=this._uboCache[o]=xn(t,this.shader.program.uniformData)),t.autoManage){var a=new Float32Array(s.size/4);t.buffer.update(a)}return e.uniformGroups[t.id]=s.syncFunc,e.uniformGroups[t.id]},t.prototype.getSignature=function(t,e,r){var i=t.uniforms,n=[r+"-"];for(var o in i)n.push(o),e[o]&&n.push(e[o].type);return n.join("-")},t.prototype.getGlProgram=function(){return this.shader?this.shader.program.glPrograms[this.renderer.CONTEXT_UID]:null},t.prototype.generateProgram=function(t){var e=this.gl,r=t.program,i=On(e,r);return r.glPrograms[this.renderer.CONTEXT_UID]=i,i},t.prototype.reset=function(){this.program=null,this.shader=null},t.prototype.destroy=function(){this.renderer=null,this.destroyed=!0},t}(),Dn=0,Nn=1,wn=2,Cn=3,Ln=4,Fn=5,Un=function(){function e(){this.gl=null,this.stateId=0,this.polygonOffset=0,this.blendMode=t.BLEND_MODES.NONE,this._blendEq=!1,this.map=[],this.map[Dn]=this.setBlend,this.map[Nn]=this.setOffset,this.map[wn]=this.setCullFace,this.map[Cn]=this.setDepthTest,this.map[Ln]=this.setFrontFace,this.map[Fn]=this.setDepthMask,this.checks=[],this.defaultState=new nn,this.defaultState.blend=!0}return e.prototype.contextChange=function(e){this.gl=e,this.blendModes=function(e,r){return void 0===r&&(r=[]),r[t.BLEND_MODES.NORMAL]=[e.ONE,e.ONE_MINUS_SRC_ALPHA],r[t.BLEND_MODES.ADD]=[e.ONE,e.ONE],r[t.BLEND_MODES.MULTIPLY]=[e.DST_COLOR,e.ONE_MINUS_SRC_ALPHA,e.ONE,e.ONE_MINUS_SRC_ALPHA],r[t.BLEND_MODES.SCREEN]=[e.ONE,e.ONE_MINUS_SRC_COLOR,e.ONE,e.ONE_MINUS_SRC_ALPHA],r[t.BLEND_MODES.OVERLAY]=[e.ONE,e.ONE_MINUS_SRC_ALPHA],r[t.BLEND_MODES.DARKEN]=[e.ONE,e.ONE_MINUS_SRC_ALPHA],r[t.BLEND_MODES.LIGHTEN]=[e.ONE,e.ONE_MINUS_SRC_ALPHA],r[t.BLEND_MODES.COLOR_DODGE]=[e.ONE,e.ONE_MINUS_SRC_ALPHA],r[t.BLEND_MODES.COLOR_BURN]=[e.ONE,e.ONE_MINUS_SRC_ALPHA],r[t.BLEND_MODES.HARD_LIGHT]=[e.ONE,e.ONE_MINUS_SRC_ALPHA],r[t.BLEND_MODES.SOFT_LIGHT]=[e.ONE,e.ONE_MINUS_SRC_ALPHA],r[t.BLEND_MODES.DIFFERENCE]=[e.ONE,e.ONE_MINUS_SRC_ALPHA],r[t.BLEND_MODES.EXCLUSION]=[e.ONE,e.ONE_MINUS_SRC_ALPHA],r[t.BLEND_MODES.HUE]=[e.ONE,e.ONE_MINUS_SRC_ALPHA],r[t.BLEND_MODES.SATURATION]=[e.ONE,e.ONE_MINUS_SRC_ALPHA],r[t.BLEND_MODES.COLOR]=[e.ONE,e.ONE_MINUS_SRC_ALPHA],r[t.BLEND_MODES.LUMINOSITY]=[e.ONE,e.ONE_MINUS_SRC_ALPHA],r[t.BLEND_MODES.NONE]=[0,0],r[t.BLEND_MODES.NORMAL_NPM]=[e.SRC_ALPHA,e.ONE_MINUS_SRC_ALPHA,e.ONE,e.ONE_MINUS_SRC_ALPHA],r[t.BLEND_MODES.ADD_NPM]=[e.SRC_ALPHA,e.ONE,e.ONE,e.ONE],r[t.BLEND_MODES.SCREEN_NPM]=[e.SRC_ALPHA,e.ONE_MINUS_SRC_COLOR,e.ONE,e.ONE_MINUS_SRC_ALPHA],r[t.BLEND_MODES.SRC_IN]=[e.DST_ALPHA,e.ZERO],r[t.BLEND_MODES.SRC_OUT]=[e.ONE_MINUS_DST_ALPHA,e.ZERO],r[t.BLEND_MODES.SRC_ATOP]=[e.DST_ALPHA,e.ONE_MINUS_SRC_ALPHA],r[t.BLEND_MODES.DST_OVER]=[e.ONE_MINUS_DST_ALPHA,e.ONE],r[t.BLEND_MODES.DST_IN]=[e.ZERO,e.SRC_ALPHA],r[t.BLEND_MODES.DST_OUT]=[e.ZERO,e.ONE_MINUS_SRC_ALPHA],r[t.BLEND_MODES.DST_ATOP]=[e.ONE_MINUS_DST_ALPHA,e.SRC_ALPHA],r[t.BLEND_MODES.XOR]=[e.ONE_MINUS_DST_ALPHA,e.ONE_MINUS_SRC_ALPHA],r[t.BLEND_MODES.SUBTRACT]=[e.ONE,e.ONE,e.ONE,e.ONE,e.FUNC_REVERSE_SUBTRACT,e.FUNC_ADD],r}(e),this.set(this.defaultState),this.reset()},e.prototype.set=function(t){if(t=t||this.defaultState,this.stateId!==t.data){for(var e=this.stateId^t.data,r=0;e;)1&e&&this.map[r].call(this,!!(t.data&1<<r)),e>>=1,r++;this.stateId=t.data}for(r=0;r<this.checks.length;r++)this.checks[r](this,t)},e.prototype.forceState=function(t){t=t||this.defaultState;for(var e=0;e<this.map.length;e++)this.map[e].call(this,!!(t.data&1<<e));for(e=0;e<this.checks.length;e++)this.checks[e](this,t);this.stateId=t.data},e.prototype.setBlend=function(t){this.updateCheck(e.checkBlendMode,t),this.gl[t?"enable":"disable"](this.gl.BLEND)},e.prototype.setOffset=function(t){this.updateCheck(e.checkPolygonOffset,t),this.gl[t?"enable":"disable"](this.gl.POLYGON_OFFSET_FILL)},e.prototype.setDepthTest=function(t){this.gl[t?"enable":"disable"](this.gl.DEPTH_TEST)},e.prototype.setDepthMask=function(t){this.gl.depthMask(t)},e.prototype.setCullFace=function(t){this.gl[t?"enable":"disable"](this.gl.CULL_FACE)},e.prototype.setFrontFace=function(t){this.gl.frontFace(this.gl[t?"CW":"CCW"])},e.prototype.setBlendMode=function(t){if(t!==this.blendMode){this.blendMode=t;var e=this.blendModes[t],r=this.gl;2===e.length?r.blendFunc(e[0],e[1]):r.blendFuncSeparate(e[0],e[1],e[2],e[3]),6===e.length?(this._blendEq=!0,r.blendEquationSeparate(e[4],e[5])):this._blendEq&&(this._blendEq=!1,r.blendEquationSeparate(r.FUNC_ADD,r.FUNC_ADD))}},e.prototype.setPolygonOffset=function(t,e){this.gl.polygonOffset(t,e)},e.prototype.reset=function(){this.gl.pixelStorei(this.gl.UNPACK_FLIP_Y_WEBGL,!1),this.forceState(this.defaultState),this._blendEq=!0,this.blendMode=-1,this.setBlendMode(0)},e.prototype.updateCheck=function(t,e){var r=this.checks.indexOf(t);e&&-1===r?this.checks.push(t):e||-1===r||this.checks.splice(r,1)},e.checkBlendMode=function(t,e){t.setBlendMode(e.blendMode)},e.checkPolygonOffset=function(t,e){t.setPolygonOffset(1,e.polygonOffset)},e.prototype.destroy=function(){this.gl=null},e}(),Bn=function(){function e(t){this.renderer=t,this.count=0,this.checkCount=0,this.maxIdle=rt.GC_MAX_IDLE,this.checkCountMax=rt.GC_MAX_CHECK_COUNT,this.mode=rt.GC_MODE}return e.prototype.postrender=function(){this.renderer.renderingToScreen&&(this.count++,this.mode!==t.GC_MODES.MANUAL&&(this.checkCount++,this.checkCount>this.checkCountMax&&(this.checkCount=0,this.run())))},e.prototype.run=function(){for(var t=this.renderer.texture,e=t.managedTextures,r=!1,i=0;i<e.length;i++){var n=e[i];!n.framebuffer&&this.count-n.touched>this.maxIdle&&(t.destroyTexture(n,!0),e[i]=null,r=!0)}if(r){var o=0;for(i=0;i<e.length;i++)null!==e[i]&&(e[o++]=e[i]);e.length=o}},e.prototype.unload=function(t){var e=this.renderer.texture,r=t._texture;r&&!r.framebuffer&&e.destroyTexture(r);for(var i=t.children.length-1;i>=0;i--)this.unload(t.children[i])},e.prototype.destroy=function(){this.renderer=null},e}(),Gn=function(e){this.texture=e,this.width=-1,this.height=-1,this.dirtyId=-1,this.dirtyStyleId=-1,this.mipmap=!1,this.wrapMode=33071,this.type=t.TYPES.UNSIGNED_BYTE,this.internalFormat=t.FORMATS.RGBA,this.samplerType=0},Xn=function(){function e(t){this.renderer=t,this.boundTextures=[],this.currentLocation=-1,this.managedTextures=[],this._unknownBoundTextures=!1,this.unknownTexture=new Xr,this.hasIntegerTextures=!1}return e.prototype.contextChange=function(){var e=this.gl=this.renderer.gl;this.CONTEXT_UID=this.renderer.CONTEXT_UID,this.webGLVersion=this.renderer.context.webGLVersion,this.internalFormats=function(e){var r,i,n,o,s,a,h,u,l,c,d,f,p,_,m,v,y,E,g,T,b,R,x;return"WebGL2RenderingContext"in self&&e instanceof self.WebGL2RenderingContext?((r={})[t.TYPES.UNSIGNED_BYTE]=((i={})[t.FORMATS.RGBA]=e.RGBA8,i[t.FORMATS.RGB]=e.RGB8,i[t.FORMATS.RG]=e.RG8,i[t.FORMATS.RED]=e.R8,i[t.FORMATS.RGBA_INTEGER]=e.RGBA8UI,i[t.FORMATS.RGB_INTEGER]=e.RGB8UI,i[t.FORMATS.RG_INTEGER]=e.RG8UI,i[t.FORMATS.RED_INTEGER]=e.R8UI,i[t.FORMATS.ALPHA]=e.ALPHA,i[t.FORMATS.LUMINANCE]=e.LUMINANCE,i[t.FORMATS.LUMINANCE_ALPHA]=e.LUMINANCE_ALPHA,i),r[t.TYPES.BYTE]=((n={})[t.FORMATS.RGBA]=e.RGBA8_SNORM,n[t.FORMATS.RGB]=e.RGB8_SNORM,n[t.FORMATS.RG]=e.RG8_SNORM,n[t.FORMATS.RED]=e.R8_SNORM,n[t.FORMATS.RGBA_INTEGER]=e.RGBA8I,n[t.FORMATS.RGB_INTEGER]=e.RGB8I,n[t.FORMATS.RG_INTEGER]=e.RG8I,n[t.FORMATS.RED_INTEGER]=e.R8I,n),r[t.TYPES.UNSIGNED_SHORT]=((o={})[t.FORMATS.RGBA_INTEGER]=e.RGBA16UI,o[t.FORMATS.RGB_INTEGER]=e.RGB16UI,o[t.FORMATS.RG_INTEGER]=e.RG16UI,o[t.FORMATS.RED_INTEGER]=e.R16UI,o[t.FORMATS.DEPTH_COMPONENT]=e.DEPTH_COMPONENT16,o),r[t.TYPES.SHORT]=((s={})[t.FORMATS.RGBA_INTEGER]=e.RGBA16I,s[t.FORMATS.RGB_INTEGER]=e.RGB16I,s[t.FORMATS.RG_INTEGER]=e.RG16I,s[t.FORMATS.RED_INTEGER]=e.R16I,s),r[t.TYPES.UNSIGNED_INT]=((a={})[t.FORMATS.RGBA_INTEGER]=e.RGBA32UI,a[t.FORMATS.RGB_INTEGER]=e.RGB32UI,a[t.FORMATS.RG_INTEGER]=e.RG32UI,a[t.FORMATS.RED_INTEGER]=e.R32UI,a[t.FORMATS.DEPTH_COMPONENT]=e.DEPTH_COMPONENT24,a),r[t.TYPES.INT]=((h={})[t.FORMATS.RGBA_INTEGER]=e.RGBA32I,h[t.FORMATS.RGB_INTEGER]=e.RGB32I,h[t.FORMATS.RG_INTEGER]=e.RG32I,h[t.FORMATS.RED_INTEGER]=e.R32I,h),r[t.TYPES.FLOAT]=((u={})[t.FORMATS.RGBA]=e.RGBA32F,u[t.FORMATS.RGB]=e.RGB32F,u[t.FORMATS.RG]=e.RG32F,u[t.FORMATS.RED]=e.R32F,u[t.FORMATS.DEPTH_COMPONENT]=e.DEPTH_COMPONENT32F,u),r[t.TYPES.HALF_FLOAT]=((l={})[t.FORMATS.RGBA]=e.RGBA16F,l[t.FORMATS.RGB]=e.RGB16F,l[t.FORMATS.RG]=e.RG16F,l[t.FORMATS.RED]=e.R16F,l),r[t.TYPES.UNSIGNED_SHORT_5_6_5]=((c={})[t.FORMATS.RGB]=e.RGB565,c),r[t.TYPES.UNSIGNED_SHORT_4_4_4_4]=((d={})[t.FORMATS.RGBA]=e.RGBA4,d),r[t.TYPES.UNSIGNED_SHORT_5_5_5_1]=((f={})[t.FORMATS.RGBA]=e.RGB5_A1,f),r[t.TYPES.UNSIGNED_INT_2_10_10_10_REV]=((p={})[t.FORMATS.RGBA]=e.RGB10_A2,p[t.FORMATS.RGBA_INTEGER]=e.RGB10_A2UI,p),r[t.TYPES.UNSIGNED_INT_10F_11F_11F_REV]=((_={})[t.FORMATS.RGB]=e.R11F_G11F_B10F,_),r[t.TYPES.UNSIGNED_INT_5_9_9_9_REV]=((m={})[t.FORMATS.RGB]=e.RGB9_E5,m),r[t.TYPES.UNSIGNED_INT_24_8]=((v={})[t.FORMATS.DEPTH_STENCIL]=e.DEPTH24_STENCIL8,v),r[t.TYPES.FLOAT_32_UNSIGNED_INT_24_8_REV]=((y={})[t.FORMATS.DEPTH_STENCIL]=e.DEPTH32F_STENCIL8,y),x=r):((E={})[t.TYPES.UNSIGNED_BYTE]=((g={})[t.FORMATS.RGBA]=e.RGBA,g[t.FORMATS.RGB]=e.RGB,g[t.FORMATS.ALPHA]=e.ALPHA,g[t.FORMATS.LUMINANCE]=e.LUMINANCE,g[t.FORMATS.LUMINANCE_ALPHA]=e.LUMINANCE_ALPHA,g),E[t.TYPES.UNSIGNED_SHORT_5_6_5]=((T={})[t.FORMATS.RGB]=e.RGB,T),E[t.TYPES.UNSIGNED_SHORT_4_4_4_4]=((b={})[t.FORMATS.RGBA]=e.RGBA,b),E[t.TYPES.UNSIGNED_SHORT_5_5_5_1]=((R={})[t.FORMATS.RGBA]=e.RGBA,R),x=E),x}(e);var r=e.getParameter(e.MAX_TEXTURE_IMAGE_UNITS);this.boundTextures.length=r;for(var i=0;i<r;i++)this.boundTextures[i]=null;this.emptyTextures={};var n=new Gn(e.createTexture());for(e.bindTexture(e.TEXTURE_2D,n.texture),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,1,1,0,e.RGBA,e.UNSIGNED_BYTE,new Uint8Array(4)),this.emptyTextures[e.TEXTURE_2D]=n,this.emptyTextures[e.TEXTURE_CUBE_MAP]=new Gn(e.createTexture()),e.bindTexture(e.TEXTURE_CUBE_MAP,this.emptyTextures[e.TEXTURE_CUBE_MAP].texture),i=0;i<6;i++)e.texImage2D(e.TEXTURE_CUBE_MAP_POSITIVE_X+i,0,e.RGBA,1,1,0,e.RGBA,e.UNSIGNED_BYTE,null);for(e.texParameteri(e.TEXTURE_CUBE_MAP,e.TEXTURE_MAG_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_CUBE_MAP,e.TEXTURE_MIN_FILTER,e.LINEAR),i=0;i<this.boundTextures.length;i++)this.bind(null,i)},e.prototype.bind=function(t,e){void 0===e&&(e=0);var r=this.gl;if((t=null==t?void 0:t.castToBaseTexture())&&t.valid&&!t.parentTextureArray){t.touched=this.renderer.textureGC.count;var i=t._glTextures[this.CONTEXT_UID]||this.initTexture(t);this.boundTextures[e]!==t&&(this.currentLocation!==e&&(this.currentLocation=e,r.activeTexture(r.TEXTURE0+e)),r.bindTexture(t.target,i.texture)),i.dirtyId!==t.dirtyId&&(this.currentLocation!==e&&(this.currentLocation=e,r.activeTexture(r.TEXTURE0+e)),this.updateTexture(t)),this.boundTextures[e]=t}else this.currentLocation!==e&&(this.currentLocation=e,r.activeTexture(r.TEXTURE0+e)),r.bindTexture(r.TEXTURE_2D,this.emptyTextures[r.TEXTURE_2D].texture),this.boundTextures[e]=null},e.prototype.reset=function(){this._unknownBoundTextures=!0,this.hasIntegerTextures=!1,this.currentLocation=-1;for(var t=0;t<this.boundTextures.length;t++)this.boundTextures[t]=this.unknownTexture},e.prototype.unbind=function(t){var e=this.gl,r=this.boundTextures;if(this._unknownBoundTextures){this._unknownBoundTextures=!1;for(var i=0;i<r.length;i++)r[i]===this.unknownTexture&&this.bind(null,i)}for(i=0;i<r.length;i++)r[i]===t&&(this.currentLocation!==i&&(e.activeTexture(e.TEXTURE0+i),this.currentLocation=i),e.bindTexture(t.target,this.emptyTextures[t.target].texture),r[i]=null)},e.prototype.ensureSamplerType=function(e){var r=this.boundTextures,i=this.hasIntegerTextures,n=this.CONTEXT_UID;if(i)for(var o=e-1;o>=0;--o){var s=r[o];s&&s._glTextures[n].samplerType!==t.SAMPLER_TYPES.FLOAT&&this.renderer.texture.unbind(s)}},e.prototype.initTexture=function(t){var e=new Gn(this.gl.createTexture());return e.dirtyId=-1,t._glTextures[this.CONTEXT_UID]=e,this.managedTextures.push(t),t.on("dispose",this.destroyTexture,this),e},e.prototype.initTextureType=function(e,r){var i,n;r.internalFormat=null!==(n=null===(i=this.internalFormats[e.type])||void 0===i?void 0:i[e.format])&&void 0!==n?n:e.format,2===this.webGLVersion&&e.type===t.TYPES.HALF_FLOAT?r.type=this.gl.HALF_FLOAT:r.type=e.type},e.prototype.updateTexture=function(e){var r=e._glTextures[this.CONTEXT_UID];if(r){var i=this.renderer;if(this.initTextureType(e,r),e.resource&&e.resource.upload(i,e,r))r.samplerType!==t.SAMPLER_TYPES.FLOAT&&(this.hasIntegerTextures=!0);else{var n=e.realWidth,o=e.realHeight,s=i.gl;(r.width!==n||r.height!==o||r.dirtyId<0)&&(r.width=n,r.height=o,s.texImage2D(e.target,0,r.internalFormat,n,o,0,e.format,r.type,null))}e.dirtyStyleId!==r.dirtyStyleId&&this.updateTextureStyle(e),r.dirtyId=e.dirtyId}},e.prototype.destroyTexture=function(t,e){var r=this.gl;if((t=t.castToBaseTexture())._glTextures[this.CONTEXT_UID]&&(this.unbind(t),r.deleteTexture(t._glTextures[this.CONTEXT_UID].texture),t.off("dispose",this.destroyTexture,this),delete t._glTextures[this.CONTEXT_UID],!e)){var i=this.managedTextures.indexOf(t);-1!==i&&Ae(this.managedTextures,i,1)}},e.prototype.updateTextureStyle=function(e){var r=e._glTextures[this.CONTEXT_UID];r&&(e.mipmap!==t.MIPMAP_MODES.POW2&&2===this.webGLVersion||e.isPowerOfTwo?r.mipmap=e.mipmap>=1:r.mipmap=!1,2===this.webGLVersion||e.isPowerOfTwo?r.wrapMode=e.wrapMode:r.wrapMode=t.WRAP_MODES.CLAMP,e.resource&&e.resource.style(this.renderer,e,r)||this.setStyle(e,r),r.dirtyStyleId=e.dirtyStyleId)},e.prototype.setStyle=function(e,r){var i=this.gl;if(r.mipmap&&e.mipmap!==t.MIPMAP_MODES.ON_MANUAL&&i.generateMipmap(e.target),i.texParameteri(e.target,i.TEXTURE_WRAP_S,r.wrapMode),i.texParameteri(e.target,i.TEXTURE_WRAP_T,r.wrapMode),r.mipmap){i.texParameteri(e.target,i.TEXTURE_MIN_FILTER,e.scaleMode===t.SCALE_MODES.LINEAR?i.LINEAR_MIPMAP_LINEAR:i.NEAREST_MIPMAP_NEAREST);var n=this.renderer.context.extensions.anisotropicFiltering;if(n&&e.anisotropicLevel>0&&e.scaleMode===t.SCALE_MODES.LINEAR){var o=Math.min(e.anisotropicLevel,i.getParameter(n.MAX_TEXTURE_MAX_ANISOTROPY_EXT));i.texParameterf(e.target,n.TEXTURE_MAX_ANISOTROPY_EXT,o)}}else i.texParameteri(e.target,i.TEXTURE_MIN_FILTER,e.scaleMode===t.SCALE_MODES.LINEAR?i.LINEAR:i.NEAREST);i.texParameteri(e.target,i.TEXTURE_MAG_FILTER,e.scaleMode===t.SCALE_MODES.LINEAR?i.LINEAR:i.NEAREST)},e.prototype.destroy=function(){this.renderer=null},e}(),kn={__proto__:null,FilterSystem:Ti,BatchSystem:Ri,ContextSystem:Ai,FramebufferSystem:Ii,GeometrySystem:Mi,MaskSystem:cn,ScissorSystem:fn,StencilSystem:pn,ProjectionSystem:_n,RenderTextureSystem:yn,ShaderSystem:Mn,StateSystem:Un,TextureGCSystem:Bn,TextureSystem:Xn},Hn=new Ze,Yn=function(e){function r(r,i){void 0===r&&(r=t.RENDERER_TYPE.UNKNOWN);var n=e.call(this)||this;return i=Object.assign({},rt.RENDER_OPTIONS,i),n.options=i,n.type=r,n.screen=new Ye(0,0,i.width,i.height),n.view=i.view||document.createElement("canvas"),n.resolution=i.resolution||rt.RESOLUTION,n.useContextAlpha=i.useContextAlpha,n.autoDensity=!!i.autoDensity,n.preserveDrawingBuffer=i.preserveDrawingBuffer,n.clearBeforeRender=i.clearBeforeRender,n._backgroundColor=0,n._backgroundColorRgba=[0,0,0,1],n._backgroundColorString="#000000",n.backgroundColor=i.backgroundColor||n._backgroundColor,n.backgroundAlpha=i.backgroundAlpha,void 0!==i.transparent&&(n.useContextAlpha=i.transparent,n.backgroundAlpha=i.transparent?0:1),n._lastObjectRendered=null,n.plugins={},n}return Lr(r,e),r.prototype.initPlugins=function(t){for(var e in t)this.plugins[e]=new t[e](this)},Object.defineProperty(r.prototype,"width",{get:function(){return this.view.width},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"height",{get:function(){return this.view.height},enumerable:!1,configurable:!0}),r.prototype.resize=function(t,e){this.view.width=Math.round(t*this.resolution),this.view.height=Math.round(e*this.resolution);var r=this.view.width/this.resolution,i=this.view.height/this.resolution;this.screen.width=r,this.screen.height=i,this.autoDensity&&(this.view.style.width=r+"px",this.view.style.height=i+"px"),this.emit("resize",r,i)},r.prototype.generateTexture=function(t,e,r,i){void 0===e&&(e={}),"number"==typeof e&&(e={scaleMode:e,resolution:r,region:i});var n=e.region,o=function(t,e){var r={};for(var i in t)Object.prototype.hasOwnProperty.call(t,i)&&e.indexOf(i)<0&&(r[i]=t[i]);if(null!=t&&"function"==typeof Object.getOwnPropertySymbols){var n=0;for(i=Object.getOwnPropertySymbols(t);n<i.length;n++)e.indexOf(i[n])<0&&(r[i[n]]=t[i[n]])}return r}(e,["region"]);0===(i=n||t.getLocalBounds(null,!0)).width&&(i.width=1),0===i.height&&(i.height=1);var s=ni.create(Fr({width:i.width,height:i.height},o));return Hn.tx=-i.x,Hn.ty=-i.y,this.render(t,{renderTexture:s,clear:!1,transform:Hn,skipUpdateTransform:!!t.parent}),s},r.prototype.destroy=function(e){for(var r in this.plugins)this.plugins[r].destroy(),this.plugins[r]=null;e&&this.view.parentNode&&this.view.parentNode.removeChild(this.view),this.plugins=null,this.type=t.RENDERER_TYPE.UNKNOWN,this.view=null,this.screen=null,this._tempDisplayObjectParent=null,this.options=null,this._backgroundColorRgba=null,this._backgroundColorString=null,this._lastObjectRendered=null},Object.defineProperty(r.prototype,"backgroundColor",{get:function(){return this._backgroundColor},set:function(t){this._backgroundColor=t,this._backgroundColorString=de(t),ce(t,this._backgroundColorRgba)},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"backgroundAlpha",{get:function(){return this._backgroundColorRgba[3]},set:function(t){this._backgroundColorRgba[3]=t},enumerable:!1,configurable:!0}),r}(ot),jn=function(t){this.buffer=t||null,this.updateID=-1,this.byteLength=-1,this.refCount=0},Vn=function(){function t(t){this.renderer=t,this.managedBuffers={},this.boundBufferBases={}}return t.prototype.destroy=function(){this.renderer=null},t.prototype.contextChange=function(){this.disposeAll(!0),this.gl=this.renderer.gl,this.CONTEXT_UID=this.renderer.CONTEXT_UID},t.prototype.bind=function(t){var e=this.gl,r=this.CONTEXT_UID,i=t._glBuffers[r]||this.createGLBuffer(t);e.bindBuffer(t.type,i.buffer)},t.prototype.bindBufferBase=function(t,e){var r=this.gl,i=this.CONTEXT_UID;if(this.boundBufferBases[e]!==t){var n=t._glBuffers[i]||this.createGLBuffer(t);this.boundBufferBases[e]=t,r.bindBufferBase(r.UNIFORM_BUFFER,e,n.buffer)}},t.prototype.bindBufferRange=function(t,e,r){var i=this.gl,n=this.CONTEXT_UID;r=r||0;var o=t._glBuffers[n]||this.createGLBuffer(t);i.bindBufferRange(i.UNIFORM_BUFFER,e||0,o.buffer,256*r,256)},t.prototype.update=function(t){var e=this.gl,r=this.CONTEXT_UID,i=t._glBuffers[r];if(t._updateID!==i.updateID)if(i.updateID=t._updateID,e.bindBuffer(t.type,i.buffer),i.byteLength>=t.data.byteLength)e.bufferSubData(t.type,0,t.data);else{var n=t.static?e.STATIC_DRAW:e.DYNAMIC_DRAW;i.byteLength=t.data.byteLength,e.bufferData(t.type,t.data,n)}},t.prototype.dispose=function(t,e){if(this.managedBuffers[t.id]){delete this.managedBuffers[t.id];var r=t._glBuffers[this.CONTEXT_UID],i=this.gl;t.disposeRunner.remove(this),r&&(e||i.deleteBuffer(r.buffer),delete t._glBuffers[this.CONTEXT_UID])}},t.prototype.disposeAll=function(t){for(var e=Object.keys(this.managedBuffers),r=0;r<e.length;r++)this.dispose(this.managedBuffers[e[r]],t)},t.prototype.createGLBuffer=function(t){var e=this.CONTEXT_UID,r=this.gl;return t._glBuffers[e]=new jn(r.createBuffer()),this.managedBuffers[t.id]=t,t.disposeRunner.add(this),t._glBuffers[e]},t}(),Wn=function(e){function r(i){var n=e.call(this,t.RENDERER_TYPE.WEBGL,i)||this;return i=n.options,n.gl=null,n.CONTEXT_UID=0,n.runners={destroy:new Dr("destroy"),contextChange:new Dr("contextChange"),reset:new Dr("reset"),update:new Dr("update"),postrender:new Dr("postrender"),prerender:new Dr("prerender"),resize:new Dr("resize")},n.runners.contextChange.add(n),n.globalUniforms=new vi({projectionMatrix:new Ze},!0),n.addSystem(cn,"mask").addSystem(Ai,"context").addSystem(Un,"state").addSystem(Mn,"shader").addSystem(Xn,"texture").addSystem(Vn,"buffer").addSystem(Mi,"geometry").addSystem(Ii,"framebuffer").addSystem(fn,"scissor").addSystem(pn,"stencil").addSystem(_n,"projection").addSystem(Bn,"textureGC").addSystem(Ti,"filter").addSystem(yn,"renderTexture").addSystem(Ri,"batch"),n.initPlugins(r.__plugins),n.multisample=void 0,i.context?n.context.initFromContext(i.context):n.context.initFromOptions({alpha:!!n.useContextAlpha,antialias:i.antialias,premultipliedAlpha:n.useContextAlpha&&"notMultiplied"!==n.useContextAlpha,stencil:!0,preserveDrawingBuffer:i.preserveDrawingBuffer,powerPreference:n.options.powerPreference}),n.renderingToScreen=!0,he(2===n.context.webGLVersion?"WebGL 2":"WebGL 1"),n.resize(n.options.width,n.options.height),n}return Lr(r,e),r.create=function(t){if(ue())return new r(t);throw new Error('WebGL unsupported in this browser, use "pixi.js-legacy" for fallback canvas2d support.')},r.prototype.contextChange=function(){var e,r=this.gl;if(1===this.context.webGLVersion){var i=r.getParameter(r.FRAMEBUFFER_BINDING);r.bindFramebuffer(r.FRAMEBUFFER,null),e=r.getParameter(r.SAMPLES),r.bindFramebuffer(r.FRAMEBUFFER,i)}else i=r.getParameter(r.DRAW_FRAMEBUFFER_BINDING),r.bindFramebuffer(r.DRAW_FRAMEBUFFER,null),e=r.getParameter(r.SAMPLES),r.bindFramebuffer(r.DRAW_FRAMEBUFFER,i);e>=t.MSAA_QUALITY.HIGH?this.multisample=t.MSAA_QUALITY.HIGH:e>=t.MSAA_QUALITY.MEDIUM?this.multisample=t.MSAA_QUALITY.MEDIUM:e>=t.MSAA_QUALITY.LOW?this.multisample=t.MSAA_QUALITY.LOW:this.multisample=t.MSAA_QUALITY.NONE},r.prototype.addSystem=function(t,e){var r=new t(this);if(this[e])throw new Error('Whoops! The name "'+e+'" is already in use');for(var i in this[e]=r,this.runners)this.runners[i].add(r);return this},r.prototype.render=function(t,e){var r,i,n,o;if(e&&(e instanceof ni?(r=e,i=arguments[2],n=arguments[3],o=arguments[4]):(r=e.renderTexture,i=e.clear,n=e.transform,o=e.skipUpdateTransform)),this.renderingToScreen=!r,this.runners.prerender.emit(),this.emit("prerender"),this.projection.transform=n,!this.context.isLost){if(r||(this._lastObjectRendered=t),!o){var s=t.enableTempParent();t.updateTransform(),t.disableTempParent(s)}this.renderTexture.bind(r),this.batch.currentRenderer.start(),(void 0!==i?i:this.clearBeforeRender)&&this.renderTexture.clear(),t.render(this),this.batch.currentRenderer.flush(),r&&r.baseTexture.update(),this.runners.postrender.emit(),this.projection.transform=null,this.emit("postrender")}},r.prototype.generateTexture=function(t,r,i,n){void 0===r&&(r={});var o=e.prototype.generateTexture.call(this,t,r,i,n);return this.framebuffer.blit(),o},r.prototype.resize=function(t,r){e.prototype.resize.call(this,t,r),this.runners.resize.emit(this.screen.height,this.screen.width)},r.prototype.reset=function(){return this.runners.reset.emit(),this},r.prototype.clear=function(){this.renderTexture.bind(),this.renderTexture.clear()},r.prototype.destroy=function(t){for(var r in this.runners.destroy.emit(),this.runners)this.runners[r].destroy();e.prototype.destroy.call(this,t),this.gl=null},Object.defineProperty(r.prototype,"extract",{get:function(){return this.plugins.extract},enumerable:!1,configurable:!0}),r.registerPlugin=function(t,e){r.__plugins=r.__plugins||{},r.__plugins[t]=e},r}(Yn);function zn(t){return Wn.create(t)}var qn="attribute vec2 aVertexPosition;\nattribute vec2 aTextureCoord;\n\nuniform mat3 projectionMatrix;\n\nvarying vec2 vTextureCoord;\n\nvoid main(void)\n{\n    gl_Position = vec4((projectionMatrix * vec3(aVertexPosition, 1.0)).xy, 0.0, 1.0);\n    vTextureCoord = aTextureCoord;\n}",Kn="attribute vec2 aVertexPosition;\n\nuniform mat3 projectionMatrix;\n\nvarying vec2 vTextureCoord;\n\nuniform vec4 inputSize;\nuniform vec4 outputFrame;\n\nvec4 filterVertexPosition( void )\n{\n    vec2 position = aVertexPosition * max(outputFrame.zw, vec2(0.)) + outputFrame.xy;\n\n    return vec4((projectionMatrix * vec3(position, 1.0)).xy, 0.0, 1.0);\n}\n\nvec2 filterTextureCoord( void )\n{\n    return aVertexPosition * (outputFrame.zw * inputSize.zw);\n}\n\nvoid main(void)\n{\n    gl_Position = filterVertexPosition();\n    vTextureCoord = filterTextureCoord();\n}\n",Zn=function(){function t(t){this.renderer=t}return t.prototype.destroy=function(){this.renderer=null},t}(),Qn=function(){this.texArray=null,this.blend=0,this.type=t.DRAW_MODES.TRIANGLES,this.start=0,this.size=0,this.data=null},Jn=function(){function t(){this.elements=[],this.ids=[],this.count=0}return t.prototype.clear=function(){for(var t=0;t<this.count;t++)this.elements[t]=null;this.count=0},t}(),$n=function(){function t(t){"number"==typeof t?this.rawBinaryData=new ArrayBuffer(t):t instanceof Uint8Array?this.rawBinaryData=t.buffer:this.rawBinaryData=t,this.uint32View=new Uint32Array(this.rawBinaryData),this.float32View=new Float32Array(this.rawBinaryData)}return Object.defineProperty(t.prototype,"int8View",{get:function(){return this._int8View||(this._int8View=new Int8Array(this.rawBinaryData)),this._int8View},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"uint8View",{get:function(){return this._uint8View||(this._uint8View=new Uint8Array(this.rawBinaryData)),this._uint8View},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"int16View",{get:function(){return this._int16View||(this._int16View=new Int16Array(this.rawBinaryData)),this._int16View},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"uint16View",{get:function(){return this._uint16View||(this._uint16View=new Uint16Array(this.rawBinaryData)),this._uint16View},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"int32View",{get:function(){return this._int32View||(this._int32View=new Int32Array(this.rawBinaryData)),this._int32View},enumerable:!1,configurable:!0}),t.prototype.view=function(t){return this[t+"View"]},t.prototype.destroy=function(){this.rawBinaryData=null,this._int8View=null,this._uint8View=null,this._int16View=null,this._uint16View=null,this._int32View=null,this.uint32View=null,this.float32View=null},t.sizeOf=function(t){switch(t){case"int8":case"uint8":return 1;case"int16":case"uint16":return 2;case"int32":case"uint32":case"float32":return 4;default:throw new Error(t+" isn't a valid view type")}},t}(),to=function(e){function r(t){var r=e.call(this,t)||this;return r.shaderGenerator=null,r.geometryClass=null,r.vertexSize=null,r.state=nn.for2d(),r.size=4*rt.SPRITE_BATCH_SIZE,r._vertexCount=0,r._indexCount=0,r._bufferedElements=[],r._bufferedTextures=[],r._bufferSize=0,r._shader=null,r._packedGeometries=[],r._packedGeometryPoolSize=2,r._flushId=0,r._aBuffers={},r._iBuffers={},r.MAX_TEXTURES=1,r.renderer.on("prerender",r.onPrerender,r),t.runners.contextChange.add(r),r._dcIndex=0,r._aIndex=0,r._iIndex=0,r._attributeBuffer=null,r._indexBuffer=null,r._tempBoundTextures=[],r}return Lr(r,e),r.prototype.contextChange=function(){var e=this.renderer.gl;rt.PREFER_ENV===t.ENV.WEBGL_LEGACY?this.MAX_TEXTURES=1:(this.MAX_TEXTURES=Math.min(e.getParameter(e.MAX_TEXTURE_IMAGE_UNITS),rt.SPRITE_MAX_TEXTURES),this.MAX_TEXTURES=Ji(this.MAX_TEXTURES,e)),this._shader=this.shaderGenerator.generateShader(this.MAX_TEXTURES);for(var r=0;r<this._packedGeometryPoolSize;r++)this._packedGeometries[r]=new this.geometryClass;this.initFlushBuffers()},r.prototype.initFlushBuffers=function(){for(var t=r._drawCallPool,e=r._textureArrayPool,i=this.size/4,n=Math.floor(i/this.MAX_TEXTURES)+1;t.length<i;)t.push(new Qn);for(;e.length<n;)e.push(new Jn);for(var o=0;o<this.MAX_TEXTURES;o++)this._tempBoundTextures[o]=null},r.prototype.onPrerender=function(){this._flushId=0},r.prototype.render=function(t){t._texture.valid&&(this._vertexCount+t.vertexData.length/2>this.size&&this.flush(),this._vertexCount+=t.vertexData.length/2,this._indexCount+=t.indices.length,this._bufferedTextures[this._bufferSize]=t._texture.baseTexture,this._bufferedElements[this._bufferSize++]=t)},r.prototype.buildTexturesAndDrawCalls=function(){var t=this._bufferedTextures,e=this.MAX_TEXTURES,i=r._textureArrayPool,n=this.renderer.batch,o=this._tempBoundTextures,s=this.renderer.textureGC.count,a=++Xr._globalBatch,h=0,u=i[0],l=0;n.copyBoundTextures(o,e);for(var c=0;c<this._bufferSize;++c){var d=t[c];t[c]=null,d._batchEnabled!==a&&(u.count>=e&&(n.boundArray(u,o,a,e),this.buildDrawCalls(u,l,c),l=c,u=i[++h],++a),d._batchEnabled=a,d.touched=s,u.elements[u.count++]=d)}for(u.count>0&&(n.boundArray(u,o,a,e),this.buildDrawCalls(u,l,this._bufferSize),++h,++a),c=0;c<o.length;c++)o[c]=null;Xr._globalBatch=a},r.prototype.buildDrawCalls=function(t,e,i){var n=this._bufferedElements,o=this._attributeBuffer,s=this._indexBuffer,a=this.vertexSize,h=r._drawCallPool,u=this._dcIndex,l=this._aIndex,c=this._iIndex,d=h[u];d.start=this._iIndex,d.texArray=t;for(var f=e;f<i;++f){var p=n[f],_=p._texture.baseTexture,m=pe[_.alphaMode?1:0][p.blendMode];n[f]=null,e<f&&d.blend!==m&&(d.size=c-d.start,e=f,(d=h[++u]).texArray=t,d.start=c),this.packInterleavedGeometry(p,o,s,l,c),l+=p.vertexData.length/2*a,c+=p.indices.length,d.blend=m}e<i&&(d.size=c-d.start,++u),this._dcIndex=u,this._aIndex=l,this._iIndex=c},r.prototype.bindAndClearTexArray=function(t){for(var e=this.renderer.texture,r=0;r<t.count;r++)e.bind(t.elements[r],t.ids[r]),t.elements[r]=null;t.count=0},r.prototype.updateGeometry=function(){var t=this._packedGeometries,e=this._attributeBuffer,r=this._indexBuffer;rt.CAN_UPLOAD_SAME_BUFFER?(t[this._flushId]._buffer.update(e.rawBinaryData),t[this._flushId]._indexBuffer.update(r),this.renderer.geometry.updateBuffers()):(this._packedGeometryPoolSize<=this._flushId&&(this._packedGeometryPoolSize++,t[this._flushId]=new this.geometryClass),t[this._flushId]._buffer.update(e.rawBinaryData),t[this._flushId]._indexBuffer.update(r),this.renderer.geometry.bind(t[this._flushId]),this.renderer.geometry.updateBuffers(),this._flushId++)},r.prototype.drawBatches=function(){for(var t=this._dcIndex,e=this.renderer,i=e.gl,n=e.state,o=r._drawCallPool,s=null,a=0;a<t;a++){var h=o[a],u=h.texArray,l=h.type,c=h.size,d=h.start,f=h.blend;s!==u&&(s=u,this.bindAndClearTexArray(u)),this.state.blendMode=f,n.set(this.state),i.drawElements(l,c,i.UNSIGNED_SHORT,2*d)}},r.prototype.flush=function(){0!==this._vertexCount&&(this._attributeBuffer=this.getAttributeBuffer(this._vertexCount),this._indexBuffer=this.getIndexBuffer(this._indexCount),this._aIndex=0,this._iIndex=0,this._dcIndex=0,this.buildTexturesAndDrawCalls(),this.updateGeometry(),this.drawBatches(),this._bufferSize=0,this._vertexCount=0,this._indexCount=0)},r.prototype.start=function(){this.renderer.state.set(this.state),this.renderer.texture.ensureSamplerType(this.MAX_TEXTURES),this.renderer.shader.bind(this._shader),rt.CAN_UPLOAD_SAME_BUFFER&&this.renderer.geometry.bind(this._packedGeometries[this._flushId])},r.prototype.stop=function(){this.flush()},r.prototype.destroy=function(){for(var t=0;t<this._packedGeometryPoolSize;t++)this._packedGeometries[t]&&this._packedGeometries[t].destroy();this.renderer.off("prerender",this.onPrerender,this),this._aBuffers=null,this._iBuffers=null,this._packedGeometries=null,this._attributeBuffer=null,this._indexBuffer=null,this._shader&&(this._shader.destroy(),this._shader=null),e.prototype.destroy.call(this)},r.prototype.getAttributeBuffer=function(t){var e=be(Math.ceil(t/8)),r=xe(e),i=8*e;this._aBuffers.length<=r&&(this._iBuffers.length=r+1);var n=this._aBuffers[i];return n||(this._aBuffers[i]=n=new $n(i*this.vertexSize*4)),n},r.prototype.getIndexBuffer=function(t){var e=be(Math.ceil(t/12)),r=xe(e),i=12*e;this._iBuffers.length<=r&&(this._iBuffers.length=r+1);var n=this._iBuffers[r];return n||(this._iBuffers[r]=n=new Uint16Array(i)),n},r.prototype.packInterleavedGeometry=function(t,e,r,i,n){for(var o=e.uint32View,s=e.float32View,a=i/this.vertexSize,h=t.uvs,u=t.indices,l=t.vertexData,c=t._texture.baseTexture._batchLocation,d=Math.min(t.worldAlpha,1),f=d<1&&t._texture.baseTexture.alphaMode?ve(t._tintRGB,d):t._tintRGB+(255*d<<24),p=0;p<l.length;p+=2)s[i++]=l[p],s[i++]=l[p+1],s[i++]=h[p],s[i++]=h[p+1],o[i++]=f,s[i++]=c;for(p=0;p<u.length;p++)r[n++]=a+u[p]},r._drawCallPool=[],r._textureArrayPool=[],r}(bi),eo=function(){function t(t,e){if(this.vertexSrc=t,this.fragTemplate=e,this.programCache={},this.defaultGroupCache={},e.indexOf("%count%")<0)throw new Error('Fragment template must contain "%count%".');if(e.indexOf("%forloop%")<0)throw new Error('Fragment template must contain "%forloop%".')}return t.prototype.generateShader=function(t){if(!this.programCache[t]){for(var e=new Int32Array(t),r=0;r<t;r++)e[r]=r;this.defaultGroupCache[t]=vi.from({uSamplers:e},!0);var i=this.fragTemplate;i=(i=i.replace(/%count%/gi,""+t)).replace(/%forloop%/gi,this.generateSampleSrc(t)),this.programCache[t]=new en(this.vertexSrc,i)}var n={tint:new Float32Array([1,1,1,1]),translationMatrix:new Ze,default:this.defaultGroupCache[t]};return new rn(this.programCache[t],n)},t.prototype.generateSampleSrc=function(t){var e="";e+="\n",e+="\n";for(var r=0;r<t;r++)r>0&&(e+="\nelse "),r<t-1&&(e+="if(vTextureId < "+r+".5)"),e+="\n{",e+="\n\tcolor = texture2D(uSamplers["+r+"], vTextureCoord);",e+="\n}";return(e+="\n")+"\n"},t}(),ro=function(e){function r(r){void 0===r&&(r=!1);var i=e.call(this)||this;return i._buffer=new hi(null,r,!1),i._indexBuffer=new hi(null,r,!0),i.addAttribute("aVertexPosition",i._buffer,2,!1,t.TYPES.FLOAT).addAttribute("aTextureCoord",i._buffer,2,!1,t.TYPES.FLOAT).addAttribute("aColor",i._buffer,4,!0,t.TYPES.UNSIGNED_BYTE).addAttribute("aTextureId",i._buffer,1,!0,t.TYPES.FLOAT).addIndex(i._indexBuffer),i}return Lr(r,e),r}(fi),io="precision highp float;\nattribute vec2 aVertexPosition;\nattribute vec2 aTextureCoord;\nattribute vec4 aColor;\nattribute float aTextureId;\n\nuniform mat3 projectionMatrix;\nuniform mat3 translationMatrix;\nuniform vec4 tint;\n\nvarying vec2 vTextureCoord;\nvarying vec4 vColor;\nvarying float vTextureId;\n\nvoid main(void){\n    gl_Position = vec4((projectionMatrix * translationMatrix * vec3(aVertexPosition, 1.0)).xy, 0.0, 1.0);\n\n    vTextureCoord = aTextureCoord;\n    vTextureId = aTextureId;\n    vColor = aColor * tint;\n}\n",no="varying vec2 vTextureCoord;\nvarying vec4 vColor;\nvarying float vTextureId;\nuniform sampler2D uSamplers[%count%];\n\nvoid main(void){\n    vec4 color;\n    %forloop%\n    gl_FragColor = color * vColor;\n}\n",oo=function(){function t(){}return t.create=function(t){var e=Object.assign({vertex:io,fragment:no,geometryClass:ro,vertexSize:6},t),r=e.vertex,i=e.fragment,n=e.vertexSize,o=e.geometryClass;return function(t){function e(e){var s=t.call(this,e)||this;return s.shaderGenerator=new eo(r,i),s.geometryClass=o,s.vertexSize=n,s}return Lr(e,t),e}(to)},Object.defineProperty(t,"defaultVertexSrc",{get:function(){return io},enumerable:!1,configurable:!0}),Object.defineProperty(t,"defaultFragmentTemplate",{get:function(){return no},enumerable:!1,configurable:!0}),t}(),so=oo.create(),ao={},ho=function(t){Object.defineProperty(ao,t,{get:function(){return Zr[t]}})};for(var uo in Zr)ho(uo);var lo={},co=function(t){Object.defineProperty(lo,t,{get:function(){return kn[t]}})};for(var uo in kn)co(uo);var fo=function(){function t(e){var r=this;this.stage=new dr,e=Object.assign({forceCanvas:!1},e),this.renderer=zn(e),t._plugins.forEach(function(t){t.init.call(r,e)})}return t.registerPlugin=function(e){t._plugins.push(e)},t.prototype.render=function(){this.renderer.render(this.stage)},Object.defineProperty(t.prototype,"view",{get:function(){return this.renderer.view},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"screen",{get:function(){return this.renderer.screen},enumerable:!1,configurable:!0}),t.prototype.destroy=function(e,r){var i=this,n=t._plugins.slice(0);n.reverse(),n.forEach(function(t){t.destroy.call(i)}),this.stage.destroy(r),this.stage=null,this.renderer.destroy(e),this.renderer=null},t._plugins=[],t}(),po=function(){function t(){}return t.init=function(t){var e=this;Object.defineProperty(this,"resizeTo",{set:function(t){self.removeEventListener("resize",this.queueResize),this._resizeTo=t,t&&(self.addEventListener("resize",this.queueResize),this.resize())},get:function(){return this._resizeTo}}),this.queueResize=function(){e._resizeTo&&(e.cancelResize(),e._resizeId=requestAnimationFrame(function(){return e.resize()}))},this.cancelResize=function(){e._resizeId&&(cancelAnimationFrame(e._resizeId),e._resizeId=null)},this.resize=function(){if(e._resizeTo){var t,r;if(e.cancelResize(),e._resizeTo===self)t=self.innerWidth,r=self.innerHeight;else{var i=e._resizeTo;t=i.clientWidth,r=i.clientHeight}e.renderer.resize(t,r)}},this._resizeId=null,this._resizeTo=null,this.resizeTo=t.resizeTo||null},t.destroy=function(){self.removeEventListener("resize",this.queueResize),this.cancelResize(),this.cancelResize=null,this.queueResize=null,this.resizeTo=null,this.resize=null},t}();fo.registerPlugin(po);var _o=new Ye,mo=function(){function t(t){this.renderer=t}return t.prototype.image=function(t,e,r){var i=new Image;return i.src=this.base64(t,e,r),i},t.prototype.base64=function(t,e,r){return this.canvas(t).toDataURL(e,r)},t.prototype.canvas=function(e){var r,i,n,o=this.renderer,s=!1,a=!1;e&&(e instanceof ni?n=e:(n=this.renderer.generateTexture(e),a=!0)),n?(r=n.baseTexture.resolution,i=n.frame,s=!1,o.renderTexture.bind(n)):(r=this.renderer.resolution,s=!0,(i=_o).width=this.renderer.width,i.height=this.renderer.height,o.renderTexture.bind(null));var h=Math.floor(i.width*r+1e-4),u=Math.floor(i.height*r+1e-4),l=new we(h,u,1),c=new Uint8Array(4*h*u),d=o.gl;d.readPixels(i.x*r,i.y*r,h,u,d.RGBA,d.UNSIGNED_BYTE,c);var f=l.context.getImageData(0,0,h,u);if(t.arrayPostDivide(c,f.data),l.context.putImageData(f,0,0),s){var p=new we(l.width,l.height,1);p.context.scale(1,-1),p.context.drawImage(l.canvas,0,-u),l.destroy(),l=p}return a&&n.destroy(!0),l.canvas},t.prototype.pixels=function(e){var r,i,n,o=this.renderer,s=!1;e&&(e instanceof ni?n=e:(n=this.renderer.generateTexture(e),s=!0)),n?(r=n.baseTexture.resolution,i=n.frame,o.renderTexture.bind(n)):(r=o.resolution,(i=_o).width=o.width,i.height=o.height,o.renderTexture.bind(null));var a=i.width*r,h=i.height*r,u=new Uint8Array(4*a*h),l=o.gl;return l.readPixels(i.x*r,i.y*r,a,h,l.RGBA,l.UNSIGNED_BYTE,u),s&&n.destroy(!0),t.arrayPostDivide(u,u),u},t.prototype.destroy=function(){this.renderer=null},t.arrayPostDivide=function(t,e){for(var r=0;r<t.length;r+=4){var i=e[r+3]=t[r+3];0!==i?(e[r]=Math.round(Math.min(255*t[r]/i,255)),e[r+1]=Math.round(Math.min(255*t[r+1]/i,255)),e[r+2]=Math.round(Math.min(255*t[r+2]/i,255))):(e[r]=t[r],e[r+1]=t[r+1],e[r+2]=t[r+2])}},t}(),vo=function(){function t(t,e,r){void 0===e&&(e=!1),this._fn=t,this._once=e,this._thisArg=r,this._next=this._prev=this._owner=null}return t.prototype.detach=function(){return null!==this._owner&&(this._owner.detach(this),!0)},t}();function yo(t,e){return t._head?(t._tail._next=e,e._prev=t._tail,t._tail=e):(t._head=e,t._tail=e),e._owner=t,e}var Eo=function(){function t(){this._head=this._tail=void 0}return t.prototype.handlers=function(t){void 0===t&&(t=!1);var e=this._head;if(t)return!!e;for(var r=[];e;)r.push(e),e=e._next;return r},t.prototype.has=function(t){if(!(t instanceof vo))throw new Error("MiniSignal#has(): First arg must be a SignalBinding object.");return t._owner===this},t.prototype.dispatch=function(){for(var t=arguments,e=[],r=0;r<arguments.length;r++)e[r]=t[r];var i=this._head;if(!i)return!1;for(;i;)i._once&&this.detach(i),i._fn.apply(i._thisArg,e),i=i._next;return!0},t.prototype.add=function(t,e){if(void 0===e&&(e=null),"function"!=typeof t)throw new Error("MiniSignal#add(): First arg must be a Function.");return yo(this,new vo(t,!1,e))},t.prototype.once=function(t,e){if(void 0===e&&(e=null),"function"!=typeof t)throw new Error("MiniSignal#once(): First arg must be a Function.");return yo(this,new vo(t,!0,e))},t.prototype.detach=function(t){if(!(t instanceof vo))throw new Error("MiniSignal#detach(): First arg must be a SignalBinding object.");return t._owner!==this?this:(t._prev&&(t._prev._next=t._next),t._next&&(t._next._prev=t._prev),t===this._head?(this._head=t._next,null===t._next&&(this._tail=null)):t===this._tail&&(this._tail=t._prev,this._tail._next=null),t._owner=null,this)},t.prototype.detachAll=function(){var t=this._head;if(!t)return this;for(this._head=this._tail=null;t;)t._owner=null,t=t._next;return this},t}();function go(t,e){e=e||{};for(var r={key:["source","protocol","authority","userInfo","user","password","host","port","relative","path","directory","file","query","anchor"],q:{name:"queryKey",parser:/(?:^|&)([^&=]*)=?([^&]*)/g},parser:{strict:/^(?:([^:\/?#]+):)?(?:\/\/((?:(([^:@]*)(?::([^:@]*))?)?@)?([^:\/?#]*)(?::(\d*))?))?((((?:[^?#\/]*\/)*)([^?#]*))(?:\?([^#]*))?(?:#(.*))?)/,loose:/^(?:(?![^:@]+:[^:@\/]*@)([^:\/?#.]+):)?(?:\/\/)?((?:(([^:@]*)(?::([^:@]*))?)?@)?([^:\/?#]*)(?::(\d*))?)(((\/(?:[^?#](?![^?#\/]*\.[^?#\/.]+(?:[?#]|$)))*\/?)?([^?#\/]*))(?:\?([^#]*))?(?:#(.*))?)/}},i=r.parser[e.strictMode?"strict":"loose"].exec(t),n={},o=14;o--;)n[r.key[o]]=i[o]||"";return n[r.q.name]={},n[r.key[12]].replace(r.q.parser,function(t,e,i){e&&(n[r.q.name][e]=i)}),n}var To=!(!self.XDomainRequest||"withCredentials"in new XMLHttpRequest),bo=null;function Ro(){}function xo(t,e,r){e&&0===e.indexOf(".")&&(e=e.substring(1)),e&&(t[e]=r)}function Ao(t){return t.toString().replace("object ","")}function So(){}function Oo(t){return function(){for(var e=arguments,r=[],i=0;i<arguments.length;i++)r[i]=e[i];if(null===t)throw new Error("Callback was already called.");var n=t;t=null,n.apply(this,r)}}t.LoaderResource=function(){function t(e,r,i){if(this._dequeue=Ro,this._onLoadBinding=null,this._elementTimer=0,this._boundComplete=null,this._boundOnError=null,this._boundOnProgress=null,this._boundOnTimeout=null,this._boundXhrOnError=null,this._boundXhrOnTimeout=null,this._boundXhrOnAbort=null,this._boundXhrOnLoad=null,"string"!=typeof e||"string"!=typeof r)throw new Error("Both name and url are required for constructing a resource.");i=i||{},this._flags=0,this._setFlag(t.STATUS_FLAGS.DATA_URL,0===r.indexOf("data:")),this.name=e,this.url=r,this.extension=this._getExtension(),this.data=null,this.crossOrigin=!0===i.crossOrigin?"anonymous":i.crossOrigin,this.timeout=i.timeout||0,this.loadType=i.loadType||this._determineLoadType(),this.xhrType=i.xhrType,this.metadata=i.metadata||{},this.error=null,this.xhr=null,this.children=[],this.type=t.TYPE.UNKNOWN,this.progressChunk=0,this._dequeue=Ro,this._onLoadBinding=null,this._elementTimer=0,this._boundComplete=this.complete.bind(this),this._boundOnError=this._onError.bind(this),this._boundOnProgress=this._onProgress.bind(this),this._boundOnTimeout=this._onTimeout.bind(this),this._boundXhrOnError=this._xhrOnError.bind(this),this._boundXhrOnTimeout=this._xhrOnTimeout.bind(this),this._boundXhrOnAbort=this._xhrOnAbort.bind(this),this._boundXhrOnLoad=this._xhrOnLoad.bind(this),this.onStart=new Eo,this.onProgress=new Eo,this.onComplete=new Eo,this.onAfterMiddleware=new Eo}return t.setExtensionLoadType=function(e,r){xo(t._loadTypeMap,e,r)},t.setExtensionXhrType=function(e,r){xo(t._xhrTypeMap,e,r)},Object.defineProperty(t.prototype,"isDataUrl",{get:function(){return this._hasFlag(t.STATUS_FLAGS.DATA_URL)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"isComplete",{get:function(){return this._hasFlag(t.STATUS_FLAGS.COMPLETE)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"isLoading",{get:function(){return this._hasFlag(t.STATUS_FLAGS.LOADING)},enumerable:!1,configurable:!0}),t.prototype.complete=function(){this._clearEvents(),this._finish()},t.prototype.abort=function(e){if(!this.error){if(this.error=new Error(e),this._clearEvents(),this.xhr)this.xhr.abort();else if(this.xdr)this.xdr.abort();else if(this.data)if(this.data.src)this.data.src=t.EMPTY_GIF;else for(;this.data.firstChild;)this.data.removeChild(this.data.firstChild);this._finish()}},t.prototype.load=function(e){var r=this;if(!this.isLoading)if(this.isComplete)e&&setTimeout(function(){return e(r)},1);else switch(e&&this.onComplete.once(e),this._setFlag(t.STATUS_FLAGS.LOADING,!0),this.onStart.dispatch(this),!1!==this.crossOrigin&&"string"==typeof this.crossOrigin||(this.crossOrigin=this._determineCrossOrigin(this.url)),this.loadType){case t.LOAD_TYPE.IMAGE:this.type=t.TYPE.IMAGE,this._loadElement("image");break;case t.LOAD_TYPE.AUDIO:this.type=t.TYPE.AUDIO,this._loadSourceElement("audio");break;case t.LOAD_TYPE.VIDEO:this.type=t.TYPE.VIDEO,this._loadSourceElement("video");break;case t.LOAD_TYPE.XHR:default:To&&this.crossOrigin?this._loadXdr():this._loadXhr()}},t.prototype._hasFlag=function(t){return 0!=(this._flags&t)},t.prototype._setFlag=function(t,e){this._flags=e?this._flags|t:this._flags&~t},t.prototype._clearEvents=function(){clearTimeout(this._elementTimer),this.data&&this.data.removeEventListener&&(this.data.removeEventListener("error",this._boundOnError,!1),this.data.removeEventListener("load",this._boundComplete,!1),this.data.removeEventListener("progress",this._boundOnProgress,!1),this.data.removeEventListener("canplaythrough",this._boundComplete,!1)),this.xhr&&(this.xhr.removeEventListener?(this.xhr.removeEventListener("error",this._boundXhrOnError,!1),this.xhr.removeEventListener("timeout",this._boundXhrOnTimeout,!1),this.xhr.removeEventListener("abort",this._boundXhrOnAbort,!1),this.xhr.removeEventListener("progress",this._boundOnProgress,!1),this.xhr.removeEventListener("load",this._boundXhrOnLoad,!1)):(this.xhr.onerror=null,this.xhr.ontimeout=null,this.xhr.onprogress=null,this.xhr.onload=null))},t.prototype._finish=function(){if(this.isComplete)throw new Error("Complete called again for an already completed resource.");this._setFlag(t.STATUS_FLAGS.COMPLETE,!0),this._setFlag(t.STATUS_FLAGS.LOADING,!1),this.onComplete.dispatch(this)},t.prototype._loadElement=function(t){this.metadata.loadElement?this.data=this.metadata.loadElement:"image"===t&&void 0!==self.Image?this.data=new Image:this.data=document.createElement(t),this.crossOrigin&&(this.data.crossOrigin=this.crossOrigin),this.metadata.skipSource||(this.data.src=this.url),this.data.addEventListener("error",this._boundOnError,!1),this.data.addEventListener("load",this._boundComplete,!1),this.data.addEventListener("progress",this._boundOnProgress,!1),this.timeout&&(this._elementTimer=setTimeout(this._boundOnTimeout,this.timeout))},t.prototype._loadSourceElement=function(t){if(this.metadata.loadElement?this.data=this.metadata.loadElement:"audio"===t&&void 0!==self.Audio?this.data=new Audio:this.data=document.createElement(t),null!==this.data){if(this.crossOrigin&&(this.data.crossOrigin=this.crossOrigin),!this.metadata.skipSource)if(navigator.isCocoonJS)this.data.src=Array.isArray(this.url)?this.url[0]:this.url;else if(Array.isArray(this.url))for(var e=this.metadata.mimeType,r=0;r<this.url.length;++r)this.data.appendChild(this._createSource(t,this.url[r],Array.isArray(e)?e[r]:e));else e=this.metadata.mimeType,this.data.appendChild(this._createSource(t,this.url,Array.isArray(e)?e[0]:e));this.data.addEventListener("error",this._boundOnError,!1),this.data.addEventListener("load",this._boundComplete,!1),this.data.addEventListener("progress",this._boundOnProgress,!1),this.data.addEventListener("canplaythrough",this._boundComplete,!1),this.data.load(),this.timeout&&(this._elementTimer=setTimeout(this._boundOnTimeout,this.timeout))}else this.abort("Unsupported element: "+t)},t.prototype._loadXhr=function(){"string"!=typeof this.xhrType&&(this.xhrType=this._determineXhrType());var e=this.xhr=new XMLHttpRequest;e.open("GET",this.url,!0),e.timeout=this.timeout,this.xhrType===t.XHR_RESPONSE_TYPE.JSON||this.xhrType===t.XHR_RESPONSE_TYPE.DOCUMENT?e.responseType=t.XHR_RESPONSE_TYPE.TEXT:e.responseType=this.xhrType,e.addEventListener("error",this._boundXhrOnError,!1),e.addEventListener("timeout",this._boundXhrOnTimeout,!1),e.addEventListener("abort",this._boundXhrOnAbort,!1),e.addEventListener("progress",this._boundOnProgress,!1),e.addEventListener("load",this._boundXhrOnLoad,!1),e.send()},t.prototype._loadXdr=function(){"string"!=typeof this.xhrType&&(this.xhrType=this._determineXhrType());var t=this.xhr=new self.XDomainRequest;t.timeout=this.timeout||5e3,t.onerror=this._boundXhrOnError,t.ontimeout=this._boundXhrOnTimeout,t.onprogress=this._boundOnProgress,t.onload=this._boundXhrOnLoad,t.open("GET",this.url,!0),setTimeout(function(){return t.send()},1)},t.prototype._createSource=function(t,e,r){r||(r=t+"/"+this._getExtension(e));var i=document.createElement("source");return i.src=e,i.type=r,i},t.prototype._onError=function(t){this.abort("Failed to load element using: "+t.target.nodeName)},t.prototype._onProgress=function(t){t&&t.lengthComputable&&this.onProgress.dispatch(this,t.loaded/t.total)},t.prototype._onTimeout=function(){this.abort("Load timed out.")},t.prototype._xhrOnError=function(){var t=this.xhr;this.abort(Ao(t)+" Request failed. Status: "+t.status+', text: "'+t.statusText+'"')},t.prototype._xhrOnTimeout=function(){var t=this.xhr;this.abort(Ao(t)+" Request timed out.")},t.prototype._xhrOnAbort=function(){var t=this.xhr;this.abort(Ao(t)+" Request was aborted by the user.")},t.prototype._xhrOnLoad=function(){var e=this.xhr,r="",i=void 0===e.status?200:e.status;if(""!==e.responseType&&"text"!==e.responseType&&void 0!==e.responseType||(r=e.responseText),0===i&&(r.length>0||e.responseType===t.XHR_RESPONSE_TYPE.BUFFER)?i=200:1223===i&&(i=204),2==(i/100|0)){if(this.xhrType===t.XHR_RESPONSE_TYPE.TEXT)this.data=r,this.type=t.TYPE.TEXT;else if(this.xhrType===t.XHR_RESPONSE_TYPE.JSON)try{this.data=JSON.parse(r),this.type=t.TYPE.JSON}catch(t){return void this.abort("Error trying to parse loaded json: "+t)}else if(this.xhrType===t.XHR_RESPONSE_TYPE.DOCUMENT)try{if(self.DOMParser){var n=new DOMParser;this.data=n.parseFromString(r,"text/xml")}else{var o=document.createElement("div");o.innerHTML=r,this.data=o}this.type=t.TYPE.XML}catch(t){return void this.abort("Error trying to parse loaded xml: "+t)}else this.data=e.response||r;this.complete()}else this.abort("["+e.status+"] "+e.statusText+": "+e.responseURL)},t.prototype._determineCrossOrigin=function(t,e){if(0===t.indexOf("data:"))return"";if(self.origin!==self.location.origin)return"anonymous";e=e||self.location,bo||(bo=document.createElement("a")),bo.href=t;var r=go(bo.href,{strictMode:!0}),i=!r.port&&""===e.port||r.port===e.port,n=r.protocol?r.protocol+":":"";return r.host===e.hostname&&i&&n===e.protocol?"":"anonymous"},t.prototype._determineXhrType=function(){return t._xhrTypeMap[this.extension]||t.XHR_RESPONSE_TYPE.TEXT},t.prototype._determineLoadType=function(){return t._loadTypeMap[this.extension]||t.LOAD_TYPE.XHR},t.prototype._getExtension=function(t){void 0===t&&(t=this.url);var e="";if(this.isDataUrl){var r=t.indexOf("/");e=t.substring(r+1,t.indexOf(";",r))}else{var i=t.indexOf("?"),n=t.indexOf("#"),o=Math.min(i>-1?i:t.length,n>-1?n:t.length);e=(t=t.substring(0,o)).substring(t.lastIndexOf(".")+1)}return e.toLowerCase()},t.prototype._getMimeFromXhrType=function(e){switch(e){case t.XHR_RESPONSE_TYPE.BUFFER:return"application/octet-binary";case t.XHR_RESPONSE_TYPE.BLOB:return"application/blob";case t.XHR_RESPONSE_TYPE.DOCUMENT:return"application/xml";case t.XHR_RESPONSE_TYPE.JSON:return"application/json";case t.XHR_RESPONSE_TYPE.DEFAULT:case t.XHR_RESPONSE_TYPE.TEXT:default:return"text/plain"}},t}(),function(t){!function(t){t[t.NONE=0]="NONE",t[t.DATA_URL=1]="DATA_URL",t[t.COMPLETE=2]="COMPLETE",t[t.LOADING=4]="LOADING"}(t.STATUS_FLAGS||(t.STATUS_FLAGS={})),function(t){t[t.UNKNOWN=0]="UNKNOWN",t[t.JSON=1]="JSON",t[t.XML=2]="XML",t[t.IMAGE=3]="IMAGE",t[t.AUDIO=4]="AUDIO",t[t.VIDEO=5]="VIDEO",t[t.TEXT=6]="TEXT"}(t.TYPE||(t.TYPE={})),function(t){t[t.XHR=1]="XHR",t[t.IMAGE=2]="IMAGE",t[t.AUDIO=3]="AUDIO",t[t.VIDEO=4]="VIDEO"}(t.LOAD_TYPE||(t.LOAD_TYPE={})),function(t){t.DEFAULT="text",t.BUFFER="arraybuffer",t.BLOB="blob",t.DOCUMENT="document",t.JSON="json",t.TEXT="text"}(t.XHR_RESPONSE_TYPE||(t.XHR_RESPONSE_TYPE={})),t._loadTypeMap={gif:t.LOAD_TYPE.IMAGE,png:t.LOAD_TYPE.IMAGE,bmp:t.LOAD_TYPE.IMAGE,jpg:t.LOAD_TYPE.IMAGE,jpeg:t.LOAD_TYPE.IMAGE,tif:t.LOAD_TYPE.IMAGE,tiff:t.LOAD_TYPE.IMAGE,webp:t.LOAD_TYPE.IMAGE,tga:t.LOAD_TYPE.IMAGE,svg:t.LOAD_TYPE.IMAGE,"svg+xml":t.LOAD_TYPE.IMAGE,mp3:t.LOAD_TYPE.AUDIO,ogg:t.LOAD_TYPE.AUDIO,wav:t.LOAD_TYPE.AUDIO,mp4:t.LOAD_TYPE.VIDEO,webm:t.LOAD_TYPE.VIDEO},t._xhrTypeMap={xhtml:t.XHR_RESPONSE_TYPE.DOCUMENT,html:t.XHR_RESPONSE_TYPE.DOCUMENT,htm:t.XHR_RESPONSE_TYPE.DOCUMENT,xml:t.XHR_RESPONSE_TYPE.DOCUMENT,tmx:t.XHR_RESPONSE_TYPE.DOCUMENT,svg:t.XHR_RESPONSE_TYPE.DOCUMENT,tsx:t.XHR_RESPONSE_TYPE.DOCUMENT,gif:t.XHR_RESPONSE_TYPE.BLOB,png:t.XHR_RESPONSE_TYPE.BLOB,bmp:t.XHR_RESPONSE_TYPE.BLOB,jpg:t.XHR_RESPONSE_TYPE.BLOB,jpeg:t.XHR_RESPONSE_TYPE.BLOB,tif:t.XHR_RESPONSE_TYPE.BLOB,tiff:t.XHR_RESPONSE_TYPE.BLOB,webp:t.XHR_RESPONSE_TYPE.BLOB,tga:t.XHR_RESPONSE_TYPE.BLOB,json:t.XHR_RESPONSE_TYPE.JSON,text:t.XHR_RESPONSE_TYPE.TEXT,txt:t.XHR_RESPONSE_TYPE.TEXT,ttf:t.XHR_RESPONSE_TYPE.BUFFER,otf:t.XHR_RESPONSE_TYPE.BUFFER},t.EMPTY_GIF="data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw=="}(t.LoaderResource||(t.LoaderResource={}));var Io=function(t,e){this.data=t,this.callback=e},Po=function(){function t(t,e){var r=this;if(void 0===e&&(e=1),this.workers=0,this.saturated=So,this.unsaturated=So,this.empty=So,this.drain=So,this.error=So,this.started=!1,this.paused=!1,this._tasks=[],this._insert=function(t,e,i){if(i&&"function"!=typeof i)throw new Error("task callback must be a function");if(r.started=!0,null==t&&r.idle())setTimeout(function(){return r.drain()},1);else{var n=new Io(t,"function"==typeof i?i:So);e?r._tasks.unshift(n):r._tasks.push(n),setTimeout(r.process,1)}},this.process=function(){for(;!r.paused&&r.workers<r.concurrency&&r._tasks.length;){var t=r._tasks.shift();0===r._tasks.length&&r.empty(),r.workers+=1,r.workers===r.concurrency&&r.saturated(),r._worker(t.data,Oo(r._next(t)))}},this._worker=t,0===e)throw new Error("Concurrency must not be zero");this.concurrency=e,this.buffer=e/4}return t.prototype._next=function(t){var e=this;return function(){for(var r=arguments,i=[],n=0;n<arguments.length;n++)i[n]=r[n];e.workers-=1,t.callback.apply(t,i),null!=i[0]&&e.error(i[0],t.data),e.workers<=e.concurrency-e.buffer&&e.unsaturated(),e.idle()&&e.drain(),e.process()}},t.prototype.push=function(t,e){this._insert(t,!1,e)},t.prototype.kill=function(){this.workers=0,this.drain=So,this.started=!1,this._tasks=[]},t.prototype.unshift=function(t,e){this._insert(t,!0,e)},t.prototype.length=function(){return this._tasks.length},t.prototype.running=function(){return this.workers},t.prototype.idle=function(){return this._tasks.length+this.workers===0},t.prototype.pause=function(){!0!==this.paused&&(this.paused=!0)},t.prototype.resume=function(){if(!1!==this.paused){this.paused=!1;for(var t=1;t<=this.concurrency;t++)this.process()}},t.eachSeries=function(t,e,r,i){var n=0,o=t.length;!function s(a){a||n===o?r&&r(a):i?setTimeout(function(){e(t[n++],s)},1):e(t[n++],s)}()},t.queue=function(e,r){return new t(e,r)},t}(),Mo=/(#[\w-]+)?$/,Do=function(){function e(t,r){var i=this;void 0===t&&(t=""),void 0===r&&(r=10),this._beforeMiddleware=[],this._afterMiddleware=[],this._resourcesParsing=[],this._boundLoadResource=function(t,e){return i._loadResource(t,e)},this.resources={},this.baseUrl=t,this.progress=0,this.loading=!1,this.defaultQueryString="",this._beforeMiddleware=[],this._afterMiddleware=[],this._resourcesParsing=[],this._boundLoadResource=function(t,e){return i._loadResource(t,e)},this._queue=Po.queue(this._boundLoadResource,r),this._queue.pause(),this.resources={},this.onProgress=new Eo,this.onError=new Eo,this.onLoad=new Eo,this.onStart=new Eo,this.onComplete=new Eo;for(var n=0;n<e._plugins.length;++n){var o=e._plugins[n],s=o.pre,a=o.use;s&&this.pre(s),a&&this.use(a)}this._protected=!1}return e.prototype._add=function(e,r,i,n){if(this.loading&&(!i||!i.parentResource))throw new Error("Cannot add resources while the loader is running.");if(this.resources[e])throw new Error('Resource named "'+e+'" already exists.');if(r=this._prepareUrl(r),this.resources[e]=new t.LoaderResource(e,r,i),"function"==typeof n&&this.resources[e].onAfterMiddleware.once(n),this.loading){for(var o=i.parentResource,s=[],a=0;a<o.children.length;++a)o.children[a].isComplete||s.push(o.children[a]);var h=o.progressChunk*(s.length+1)/(s.length+2);for(o.children.push(this.resources[e]),o.progressChunk=h,a=0;a<s.length;++a)s[a].progressChunk=h;this.resources[e].progressChunk=h}return this._queue.push(this.resources[e]),this},e.prototype.pre=function(t){return this._beforeMiddleware.push(t),this},e.prototype.use=function(t){return this._afterMiddleware.push(t),this},e.prototype.reset=function(){for(var t in this.progress=0,this.loading=!1,this._queue.kill(),this._queue.pause(),this.resources){var e=this.resources[t];e._onLoadBinding&&e._onLoadBinding.detach(),e.isLoading&&e.abort("loader reset")}return this.resources={},this},e.prototype.load=function(t){if("function"==typeof t&&this.onComplete.once(t),this.loading)return this;if(this._queue.idle())this._onStart(),this._onComplete();else{for(var e=100/this._queue._tasks.length,r=0;r<this._queue._tasks.length;++r)this._queue._tasks[r].data.progressChunk=e;this._onStart(),this._queue.resume()}return this},Object.defineProperty(e.prototype,"concurrency",{get:function(){return this._queue.concurrency},set:function(t){this._queue.concurrency=t},enumerable:!1,configurable:!0}),e.prototype._prepareUrl=function(t){var e,r=go(t,{strictMode:!0});if(e=r.protocol||!r.path||0===t.indexOf("//")?t:this.baseUrl.length&&this.baseUrl.lastIndexOf("/")!==this.baseUrl.length-1&&"/"!==t.charAt(0)?this.baseUrl+"/"+t:this.baseUrl+t,this.defaultQueryString){var i=Mo.exec(e)[0];-1!==(e=e.substr(0,e.length-i.length)).indexOf("?")?e+="&"+this.defaultQueryString:e+="?"+this.defaultQueryString,e+=i}return e},e.prototype._loadResource=function(t,e){var r=this;t._dequeue=e,Po.eachSeries(this._beforeMiddleware,function(e,i){e.call(r,t,function(){i(t.isComplete?{}:null)})},function(){t.isComplete?r._onLoad(t):(t._onLoadBinding=t.onComplete.once(r._onLoad,r),t.load())},!0)},e.prototype._onStart=function(){this.progress=0,this.loading=!0,this.onStart.dispatch(this)},e.prototype._onComplete=function(){this.progress=100,this.loading=!1,this.onComplete.dispatch(this,this.resources)},e.prototype._onLoad=function(t){var e=this;t._onLoadBinding=null,this._resourcesParsing.push(t),t._dequeue(),Po.eachSeries(this._afterMiddleware,function(r,i){r.call(e,t,i)},function(){t.onAfterMiddleware.dispatch(t),e.progress=Math.min(100,e.progress+t.progressChunk),e.onProgress.dispatch(e,t),t.error?e.onError.dispatch(t.error,e,t):e.onLoad.dispatch(e,t),e._resourcesParsing.splice(e._resourcesParsing.indexOf(t),1),e._queue.idle()&&0===e._resourcesParsing.length&&e._onComplete()},!0)},e.prototype.destroy=function(){this._protected||this.reset()},Object.defineProperty(e,"shared",{get:function(){var t=e._shared;return t||((t=new e)._protected=!0,e._shared=t),t},enumerable:!1,configurable:!0}),e.registerPlugin=function(t){return e._plugins.push(t),t.add&&t.add(),e},e._plugins=[],e}();Do.prototype.add=function(t,e,r,i){if(Array.isArray(t)){for(var n=0;n<t.length;++n)this.add(t[n]);return this}if("object"==typeof t&&(r=t,i=e||r.callback||r.onComplete,e=r.url,t=r.name||r.key||r.url),"string"!=typeof e&&(i=r,r=e,e=t),"string"!=typeof e)throw new Error("No url passed to add resource to loader.");return"function"==typeof r&&(i=r,r=null),this._add(t,e,r,i)};var No,wo=function(){function t(){}return t.init=function(t){t=Object.assign({sharedLoader:!1},t),this.loader=t.sharedLoader?Do.shared:new Do},t.destroy=function(){this.loader&&(this.loader.destroy(),this.loader=null)},t}(),Co=function(){function e(){}return e.add=function(){t.LoaderResource.setExtensionLoadType("svg",t.LoaderResource.LOAD_TYPE.XHR),t.LoaderResource.setExtensionXhrType("svg",t.LoaderResource.XHR_RESPONSE_TYPE.TEXT)},e.use=function(e,r){if(!e.data||e.type!==t.LoaderResource.TYPE.IMAGE&&"svg"!==e.extension)r();else{var i=e.data,n=e.url,o=e.name,s=e.metadata;ri.fromLoader(i,n,o,s).then(function(t){e.texture=t,r()}).catch(r)}},e}(),Lo=self.URL||self.webkitURL;Do.registerPlugin({use:function(e,r){if(e.data){if(e.xhr&&e.xhrType===t.LoaderResource.XHR_RESPONSE_TYPE.BLOB)if(self.Blob&&"string"!=typeof e.data){if(0===e.data.type.indexOf("image")){var i=Lo.createObjectURL(e.data);return e.blob=e.data,e.data=new Image,e.data.src=i,e.type=t.LoaderResource.TYPE.IMAGE,void(e.data.onload=function(){Lo.revokeObjectURL(i),e.data.onload=null,r()})}}else{var n=e.xhr.getResponseHeader("content-type");if(n&&0===n.indexOf("image"))return e.data=new Image,e.data.src="data:"+n+";base64,"+function(t){for(var e="",r=0;r<t.length;){for(var i=[0,0,0],n=[0,0,0,0],o=0;o<i.length;++o)r<t.length?i[o]=255&t.charCodeAt(r++):i[o]=0;switch(n[0]=i[0]>>2,n[1]=(3&i[0])<<4|i[1]>>4,n[2]=(15&i[1])<<2|i[2]>>6,n[3]=63&i[2],r-(t.length-1)){case 2:n[3]=64,n[2]=64;break;case 1:n[3]=64}for(o=0;o<n.length;++o)e+="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".charAt(n[o])}return e}(e.xhr.responseText),e.type=t.LoaderResource.TYPE.IMAGE,void(e.data.onload=function(){e.data.onload=null,r()})}r()}else r()}}),Do.registerPlugin(Co),function(t){t[t.COMPRESSED_RGB_S3TC_DXT1_EXT=33776]="COMPRESSED_RGB_S3TC_DXT1_EXT",t[t.COMPRESSED_RGBA_S3TC_DXT1_EXT=33777]="COMPRESSED_RGBA_S3TC_DXT1_EXT",t[t.COMPRESSED_RGBA_S3TC_DXT3_EXT=33778]="COMPRESSED_RGBA_S3TC_DXT3_EXT",t[t.COMPRESSED_RGBA_S3TC_DXT5_EXT=33779]="COMPRESSED_RGBA_S3TC_DXT5_EXT",t[t.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT=35917]="COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT",t[t.COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT=35918]="COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT",t[t.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT=35919]="COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT",t[t.COMPRESSED_SRGB_S3TC_DXT1_EXT=35916]="COMPRESSED_SRGB_S3TC_DXT1_EXT",t[t.COMPRESSED_R11_EAC=37488]="COMPRESSED_R11_EAC",t[t.COMPRESSED_SIGNED_R11_EAC=37489]="COMPRESSED_SIGNED_R11_EAC",t[t.COMPRESSED_RG11_EAC=37490]="COMPRESSED_RG11_EAC",t[t.COMPRESSED_SIGNED_RG11_EAC=37491]="COMPRESSED_SIGNED_RG11_EAC",t[t.COMPRESSED_RGB8_ETC2=37492]="COMPRESSED_RGB8_ETC2",t[t.COMPRESSED_RGBA8_ETC2_EAC=37496]="COMPRESSED_RGBA8_ETC2_EAC",t[t.COMPRESSED_SRGB8_ETC2=37493]="COMPRESSED_SRGB8_ETC2",t[t.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC=37497]="COMPRESSED_SRGB8_ALPHA8_ETC2_EAC",t[t.COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2=37494]="COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2",t[t.COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2=37495]="COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2",t[t.COMPRESSED_RGB_PVRTC_4BPPV1_IMG=35840]="COMPRESSED_RGB_PVRTC_4BPPV1_IMG",t[t.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG=35842]="COMPRESSED_RGBA_PVRTC_4BPPV1_IMG",t[t.COMPRESSED_RGB_PVRTC_2BPPV1_IMG=35841]="COMPRESSED_RGB_PVRTC_2BPPV1_IMG",t[t.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG=35843]="COMPRESSED_RGBA_PVRTC_2BPPV1_IMG",t[t.COMPRESSED_RGB_ETC1_WEBGL=36196]="COMPRESSED_RGB_ETC1_WEBGL",t[t.COMPRESSED_RGB_ATC_WEBGL=35986]="COMPRESSED_RGB_ATC_WEBGL",t[t.COMPRESSED_RGBA_ATC_EXPLICIT_ALPHA_WEBGL=35986]="COMPRESSED_RGBA_ATC_EXPLICIT_ALPHA_WEBGL",t[t.COMPRESSED_RGBA_ATC_INTERPOLATED_ALPHA_WEBGL=34798]="COMPRESSED_RGBA_ATC_INTERPOLATED_ALPHA_WEBGL"}(t.INTERNAL_FORMATS||(t.INTERNAL_FORMATS={}));var Fo=((No={})[t.INTERNAL_FORMATS.COMPRESSED_RGB_S3TC_DXT1_EXT]=.5,No[t.INTERNAL_FORMATS.COMPRESSED_RGBA_S3TC_DXT1_EXT]=.5,No[t.INTERNAL_FORMATS.COMPRESSED_RGBA_S3TC_DXT3_EXT]=1,No[t.INTERNAL_FORMATS.COMPRESSED_RGBA_S3TC_DXT5_EXT]=1,No[t.INTERNAL_FORMATS.COMPRESSED_SRGB_S3TC_DXT1_EXT]=.5,No[t.INTERNAL_FORMATS.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT]=.5,No[t.INTERNAL_FORMATS.COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT]=1,No[t.INTERNAL_FORMATS.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT]=1,No[t.INTERNAL_FORMATS.COMPRESSED_R11_EAC]=.5,No[t.INTERNAL_FORMATS.COMPRESSED_SIGNED_R11_EAC]=.5,No[t.INTERNAL_FORMATS.COMPRESSED_RG11_EAC]=1,No[t.INTERNAL_FORMATS.COMPRESSED_SIGNED_RG11_EAC]=1,No[t.INTERNAL_FORMATS.COMPRESSED_RGB8_ETC2]=.5,No[t.INTERNAL_FORMATS.COMPRESSED_RGBA8_ETC2_EAC]=1,No[t.INTERNAL_FORMATS.COMPRESSED_SRGB8_ETC2]=.5,No[t.INTERNAL_FORMATS.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC]=1,No[t.INTERNAL_FORMATS.COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2]=.5,No[t.INTERNAL_FORMATS.COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2]=.5,No[t.INTERNAL_FORMATS.COMPRESSED_RGB_PVRTC_4BPPV1_IMG]=.5,No[t.INTERNAL_FORMATS.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG]=.5,No[t.INTERNAL_FORMATS.COMPRESSED_RGB_PVRTC_2BPPV1_IMG]=.25,No[t.INTERNAL_FORMATS.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG]=.25,No[t.INTERNAL_FORMATS.COMPRESSED_RGB_ETC1_WEBGL]=.5,No[t.INTERNAL_FORMATS.COMPRESSED_RGB_ATC_WEBGL]=.5,No[t.INTERNAL_FORMATS.COMPRESSED_RGBA_ATC_EXPLICIT_ALPHA_WEBGL]=1,No[t.INTERNAL_FORMATS.COMPRESSED_RGBA_ATC_INTERPOLATED_ALPHA_WEBGL]=1,No),Uo=function(t,e){return(Uo=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r])})(t,e)};function Bo(t,e){function r(){this.constructor=t}Uo(t,e),t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)}var Go,Xo,ko=function(t){function e(e,r){void 0===r&&(r={width:1,height:1,autoLoad:!0});var i,n,o=this;return"string"==typeof e?(i=e,n=new Uint8Array):(i=null,n=e),(o=t.call(this,n,r)||this).origin=i,o.buffer=n?new $n(n):null,o.origin&&!1!==r.autoLoad&&o.load(),n&&n.length&&(o.loaded=!0,o.onBlobLoaded(o.buffer.rawBinaryData)),o}return Bo(e,t),e.prototype.onBlobLoaded=function(t){},e.prototype.load=function(){return t=this,void 0,e=Promise,r=function(){var t;return function(t,e){var r,i,n,o,s={label:0,sent:function(){if(1&n[0])throw n[1];return n[1]},trys:[],ops:[]};return o={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function a(o){return function(a){return function(o){if(r)throw new TypeError("Generator is already executing.");for(;s;)try{if(r=1,i&&(n=2&o[0]?i.return:o[0]?i.throw||((n=i.return)&&n.call(i),0):i.next)&&!(n=n.call(i,o[1])).done)return n;switch(i=0,n&&(o=[2&o[0],n.value]),o[0]){case 0:case 1:n=o;break;case 4:return s.label++,{value:o[1],done:!1};case 5:s.label++,i=o[1],o=[0];continue;case 7:o=s.ops.pop(),s.trys.pop();continue;default:if(!(n=(n=s.trys).length>0&&n[n.length-1])&&(6===o[0]||2===o[0])){s=0;continue}if(3===o[0]&&(!n||o[1]>n[0]&&o[1]<n[3])){s.label=o[1];break}if(6===o[0]&&s.label<n[1]){s.label=n[1],n=o;break}if(n&&s.label<n[2]){s.label=n[2],s.ops.push(o);break}n[2]&&s.ops.pop(),s.trys.pop();continue}o=e.call(t,s)}catch(t){o=[6,t],i=0}finally{r=n=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,a])}}}(this,function(e){switch(e.label){case 0:return[4,fetch(this.origin)];case 1:return[4,e.sent().blob()];case 2:return[4,e.sent().arrayBuffer()];case 3:return t=e.sent(),this.data=new Uint32Array(t),this.buffer=new $n(t),this.loaded=!0,this.onBlobLoaded(t),this.update(),[2,this]}})},new(e||(e=Promise))(function(i,n){function o(t){try{a(r.next(t))}catch(t){n(t)}}function s(t){try{a(r.throw(t))}catch(t){n(t)}}function a(t){t.done?i(t.value):new e(function(e){e(t.value)}).then(o,s)}a((r=r.apply(t,[])).next())});var t,e,r},e}(Br),Ho=function(t){function e(r,i){var n=t.call(this,r,i)||this;return n.format=i.format,n.levels=i.levels||1,n._width=i.width,n._height=i.height,n._extension=e._formatToExtension(n.format),(i.levelBuffers||n.buffer)&&(n._levelBuffers=i.levelBuffers||e._createLevelBuffers(r instanceof Uint8Array?r:n.buffer.uint8View,n.format,n.levels,4,4,n.width,n.height)),n}return Bo(e,t),e.prototype.upload=function(t,e,r){var i=t.gl;if(!t.context.extensions[this._extension])throw new Error(this._extension+" textures are not supported on the current machine");if(!this._levelBuffers)return!1;for(var n=0,o=this.levels;n<o;n++){var s=this._levelBuffers[n],a=s.levelID,h=s.levelWidth,u=s.levelHeight,l=s.levelBuffer;i.compressedTexImage2D(i.TEXTURE_2D,a,this.format,h,u,0,l)}return!0},e.prototype.onBlobLoaded=function(){this._levelBuffers=e._createLevelBuffers(this.buffer.uint8View,this.format,this.levels,4,4,this.width,this.height)},e._formatToExtension=function(t){if(t>=33776&&t<=33779)return"s3tc";if(t>=37488&&t<=37497)return"etc";if(t>=35840&&t<=35843)return"pvrtc";if(t>=36196)return"etc1";if(t>=35986&&t<=34798)return"atc";throw new Error("Invalid (compressed) texture format given!")},e._createLevelBuffers=function(t,e,r,i,n,o,s){for(var a=new Array(r),h=t.byteOffset,u=o,l=s,c=u+i-1&~(i-1),d=l+n-1&~(n-1),f=c*d*Fo[e],p=0;p<r;p++)a[p]={levelID:p,levelWidth:r>1?u:c,levelHeight:r>1?l:d,levelBuffer:new Uint8Array(t.buffer,h,f)},h+=f,f=(c=(u=u>>1||1)+i-1&~(i-1))*(d=(l=l>>1||1)+n-1&~(n-1))*Fo[e];return a},e}(ko),Yo=function(){function e(){}return e.use=function(r,i){var n=r.data;if(r.type===t.LoaderResource.TYPE.JSON&&n&&n.cacheID&&n.textures){for(var o=n.textures,s=void 0,a=void 0,h=0,u=o.length;h<u;h++){var l=o[h],c=l.src,d=l.format;if(d||(a=c),e.textureFormats[d]){s=c;break}}if(!(s=s||a))return void i(new Error("Cannot load compressed-textures in "+r.url+", make sure you provide a fallback"));if(s===r.url)return void i(new Error("URL of compressed texture cannot be the same as the manifest's URL"));var f={crossOrigin:r.crossOrigin,metadata:r.metadata.imageMetadata,parentResource:r},p=ne.resolve(r.url.replace(this.baseUrl,""),s),_=n.cacheID;this.add(_,p,f,function(t){if(t.error)i(t.error);else{var e=t.texture,n=void 0===e?null:e,o=t.textures,s=void 0===o?{}:o;Object.assign(r,{texture:n,textures:s}),i()}})}else i()},e.add=function(){var t=document.createElement("canvas").getContext("webgl");if(t){var r={s3tc:t.getExtension("WEBGL_compressed_texture_s3tc"),s3tc_sRGB:t.getExtension("WEBGL_compressed_texture_s3tc_srgb"),etc:t.getExtension("WEBGL_compressed_texture_etc"),etc1:t.getExtension("WEBGL_compressed_texture_etc1"),pvrtc:t.getExtension("WEBGL_compressed_texture_pvrtc")||t.getExtension("WEBKIT_WEBGL_compressed_texture_pvrtc"),atc:t.getExtension("WEBGL_compressed_texture_atc"),astc:t.getExtension("WEBGL_compressed_texture_astc")};for(var i in e.textureExtensions=r,e.textureFormats={},r){var n=r[i];n&&Object.assign(e.textureFormats,Object.getPrototypeOf(n))}}},e}();function jo(e,r,i){var n={textures:{},texture:null};return r?(r.map(function(e){return new ri(new Xr(e,Object.assign({mipmap:t.MIPMAP_MODES.OFF,alphaMode:t.ALPHA_MODES.NO_PREMULTIPLIED_ALPHA},i)))}).forEach(function(t,r){var i=t.baseTexture,o=e+"-"+(r+1);Xr.addToCache(i,o),ri.addToCache(t,o),0===r&&(Xr.addToCache(i,e),ri.addToCache(t,e),n.texture=t),n.textures[o]=t}),n):n}t.LoaderResource.setExtensionXhrType("dds",t.LoaderResource.XHR_RESPONSE_TYPE.BUFFER);var Vo,Wo;!function(t){t[t.DXGI_FORMAT_UNKNOWN=0]="DXGI_FORMAT_UNKNOWN",t[t.DXGI_FORMAT_R32G32B32A32_TYPELESS=1]="DXGI_FORMAT_R32G32B32A32_TYPELESS",t[t.DXGI_FORMAT_R32G32B32A32_FLOAT=2]="DXGI_FORMAT_R32G32B32A32_FLOAT",t[t.DXGI_FORMAT_R32G32B32A32_UINT=3]="DXGI_FORMAT_R32G32B32A32_UINT",t[t.DXGI_FORMAT_R32G32B32A32_SINT=4]="DXGI_FORMAT_R32G32B32A32_SINT",t[t.DXGI_FORMAT_R32G32B32_TYPELESS=5]="DXGI_FORMAT_R32G32B32_TYPELESS",t[t.DXGI_FORMAT_R32G32B32_FLOAT=6]="DXGI_FORMAT_R32G32B32_FLOAT",t[t.DXGI_FORMAT_R32G32B32_UINT=7]="DXGI_FORMAT_R32G32B32_UINT",t[t.DXGI_FORMAT_R32G32B32_SINT=8]="DXGI_FORMAT_R32G32B32_SINT",t[t.DXGI_FORMAT_R16G16B16A16_TYPELESS=9]="DXGI_FORMAT_R16G16B16A16_TYPELESS",t[t.DXGI_FORMAT_R16G16B16A16_FLOAT=10]="DXGI_FORMAT_R16G16B16A16_FLOAT",t[t.DXGI_FORMAT_R16G16B16A16_UNORM=11]="DXGI_FORMAT_R16G16B16A16_UNORM",t[t.DXGI_FORMAT_R16G16B16A16_UINT=12]="DXGI_FORMAT_R16G16B16A16_UINT",t[t.DXGI_FORMAT_R16G16B16A16_SNORM=13]="DXGI_FORMAT_R16G16B16A16_SNORM",t[t.DXGI_FORMAT_R16G16B16A16_SINT=14]="DXGI_FORMAT_R16G16B16A16_SINT",t[t.DXGI_FORMAT_R32G32_TYPELESS=15]="DXGI_FORMAT_R32G32_TYPELESS",t[t.DXGI_FORMAT_R32G32_FLOAT=16]="DXGI_FORMAT_R32G32_FLOAT",t[t.DXGI_FORMAT_R32G32_UINT=17]="DXGI_FORMAT_R32G32_UINT",t[t.DXGI_FORMAT_R32G32_SINT=18]="DXGI_FORMAT_R32G32_SINT",t[t.DXGI_FORMAT_R32G8X24_TYPELESS=19]="DXGI_FORMAT_R32G8X24_TYPELESS",t[t.DXGI_FORMAT_D32_FLOAT_S8X24_UINT=20]="DXGI_FORMAT_D32_FLOAT_S8X24_UINT",t[t.DXGI_FORMAT_R32_FLOAT_X8X24_TYPELESS=21]="DXGI_FORMAT_R32_FLOAT_X8X24_TYPELESS",t[t.DXGI_FORMAT_X32_TYPELESS_G8X24_UINT=22]="DXGI_FORMAT_X32_TYPELESS_G8X24_UINT",t[t.DXGI_FORMAT_R10G10B10A2_TYPELESS=23]="DXGI_FORMAT_R10G10B10A2_TYPELESS",t[t.DXGI_FORMAT_R10G10B10A2_UNORM=24]="DXGI_FORMAT_R10G10B10A2_UNORM",t[t.DXGI_FORMAT_R10G10B10A2_UINT=25]="DXGI_FORMAT_R10G10B10A2_UINT",t[t.DXGI_FORMAT_R11G11B10_FLOAT=26]="DXGI_FORMAT_R11G11B10_FLOAT",t[t.DXGI_FORMAT_R8G8B8A8_TYPELESS=27]="DXGI_FORMAT_R8G8B8A8_TYPELESS",t[t.DXGI_FORMAT_R8G8B8A8_UNORM=28]="DXGI_FORMAT_R8G8B8A8_UNORM",t[t.DXGI_FORMAT_R8G8B8A8_UNORM_SRGB=29]="DXGI_FORMAT_R8G8B8A8_UNORM_SRGB",t[t.DXGI_FORMAT_R8G8B8A8_UINT=30]="DXGI_FORMAT_R8G8B8A8_UINT",t[t.DXGI_FORMAT_R8G8B8A8_SNORM=31]="DXGI_FORMAT_R8G8B8A8_SNORM",t[t.DXGI_FORMAT_R8G8B8A8_SINT=32]="DXGI_FORMAT_R8G8B8A8_SINT",t[t.DXGI_FORMAT_R16G16_TYPELESS=33]="DXGI_FORMAT_R16G16_TYPELESS",t[t.DXGI_FORMAT_R16G16_FLOAT=34]="DXGI_FORMAT_R16G16_FLOAT",t[t.DXGI_FORMAT_R16G16_UNORM=35]="DXGI_FORMAT_R16G16_UNORM",t[t.DXGI_FORMAT_R16G16_UINT=36]="DXGI_FORMAT_R16G16_UINT",t[t.DXGI_FORMAT_R16G16_SNORM=37]="DXGI_FORMAT_R16G16_SNORM",t[t.DXGI_FORMAT_R16G16_SINT=38]="DXGI_FORMAT_R16G16_SINT",t[t.DXGI_FORMAT_R32_TYPELESS=39]="DXGI_FORMAT_R32_TYPELESS",t[t.DXGI_FORMAT_D32_FLOAT=40]="DXGI_FORMAT_D32_FLOAT",t[t.DXGI_FORMAT_R32_FLOAT=41]="DXGI_FORMAT_R32_FLOAT",t[t.DXGI_FORMAT_R32_UINT=42]="DXGI_FORMAT_R32_UINT",t[t.DXGI_FORMAT_R32_SINT=43]="DXGI_FORMAT_R32_SINT",t[t.DXGI_FORMAT_R24G8_TYPELESS=44]="DXGI_FORMAT_R24G8_TYPELESS",t[t.DXGI_FORMAT_D24_UNORM_S8_UINT=45]="DXGI_FORMAT_D24_UNORM_S8_UINT",t[t.DXGI_FORMAT_R24_UNORM_X8_TYPELESS=46]="DXGI_FORMAT_R24_UNORM_X8_TYPELESS",t[t.DXGI_FORMAT_X24_TYPELESS_G8_UINT=47]="DXGI_FORMAT_X24_TYPELESS_G8_UINT",t[t.DXGI_FORMAT_R8G8_TYPELESS=48]="DXGI_FORMAT_R8G8_TYPELESS",t[t.DXGI_FORMAT_R8G8_UNORM=49]="DXGI_FORMAT_R8G8_UNORM",t[t.DXGI_FORMAT_R8G8_UINT=50]="DXGI_FORMAT_R8G8_UINT",t[t.DXGI_FORMAT_R8G8_SNORM=51]="DXGI_FORMAT_R8G8_SNORM",t[t.DXGI_FORMAT_R8G8_SINT=52]="DXGI_FORMAT_R8G8_SINT",t[t.DXGI_FORMAT_R16_TYPELESS=53]="DXGI_FORMAT_R16_TYPELESS",t[t.DXGI_FORMAT_R16_FLOAT=54]="DXGI_FORMAT_R16_FLOAT",t[t.DXGI_FORMAT_D16_UNORM=55]="DXGI_FORMAT_D16_UNORM",t[t.DXGI_FORMAT_R16_UNORM=56]="DXGI_FORMAT_R16_UNORM",t[t.DXGI_FORMAT_R16_UINT=57]="DXGI_FORMAT_R16_UINT",t[t.DXGI_FORMAT_R16_SNORM=58]="DXGI_FORMAT_R16_SNORM",t[t.DXGI_FORMAT_R16_SINT=59]="DXGI_FORMAT_R16_SINT",t[t.DXGI_FORMAT_R8_TYPELESS=60]="DXGI_FORMAT_R8_TYPELESS",t[t.DXGI_FORMAT_R8_UNORM=61]="DXGI_FORMAT_R8_UNORM",t[t.DXGI_FORMAT_R8_UINT=62]="DXGI_FORMAT_R8_UINT",t[t.DXGI_FORMAT_R8_SNORM=63]="DXGI_FORMAT_R8_SNORM",t[t.DXGI_FORMAT_R8_SINT=64]="DXGI_FORMAT_R8_SINT",t[t.DXGI_FORMAT_A8_UNORM=65]="DXGI_FORMAT_A8_UNORM",t[t.DXGI_FORMAT_R1_UNORM=66]="DXGI_FORMAT_R1_UNORM",t[t.DXGI_FORMAT_R9G9B9E5_SHAREDEXP=67]="DXGI_FORMAT_R9G9B9E5_SHAREDEXP",t[t.DXGI_FORMAT_R8G8_B8G8_UNORM=68]="DXGI_FORMAT_R8G8_B8G8_UNORM",t[t.DXGI_FORMAT_G8R8_G8B8_UNORM=69]="DXGI_FORMAT_G8R8_G8B8_UNORM",t[t.DXGI_FORMAT_BC1_TYPELESS=70]="DXGI_FORMAT_BC1_TYPELESS",t[t.DXGI_FORMAT_BC1_UNORM=71]="DXGI_FORMAT_BC1_UNORM",t[t.DXGI_FORMAT_BC1_UNORM_SRGB=72]="DXGI_FORMAT_BC1_UNORM_SRGB",t[t.DXGI_FORMAT_BC2_TYPELESS=73]="DXGI_FORMAT_BC2_TYPELESS",t[t.DXGI_FORMAT_BC2_UNORM=74]="DXGI_FORMAT_BC2_UNORM",t[t.DXGI_FORMAT_BC2_UNORM_SRGB=75]="DXGI_FORMAT_BC2_UNORM_SRGB",t[t.DXGI_FORMAT_BC3_TYPELESS=76]="DXGI_FORMAT_BC3_TYPELESS",t[t.DXGI_FORMAT_BC3_UNORM=77]="DXGI_FORMAT_BC3_UNORM",t[t.DXGI_FORMAT_BC3_UNORM_SRGB=78]="DXGI_FORMAT_BC3_UNORM_SRGB",t[t.DXGI_FORMAT_BC4_TYPELESS=79]="DXGI_FORMAT_BC4_TYPELESS",t[t.DXGI_FORMAT_BC4_UNORM=80]="DXGI_FORMAT_BC4_UNORM",t[t.DXGI_FORMAT_BC4_SNORM=81]="DXGI_FORMAT_BC4_SNORM",t[t.DXGI_FORMAT_BC5_TYPELESS=82]="DXGI_FORMAT_BC5_TYPELESS",t[t.DXGI_FORMAT_BC5_UNORM=83]="DXGI_FORMAT_BC5_UNORM",t[t.DXGI_FORMAT_BC5_SNORM=84]="DXGI_FORMAT_BC5_SNORM",t[t.DXGI_FORMAT_B5G6R5_UNORM=85]="DXGI_FORMAT_B5G6R5_UNORM",t[t.DXGI_FORMAT_B5G5R5A1_UNORM=86]="DXGI_FORMAT_B5G5R5A1_UNORM",t[t.DXGI_FORMAT_B8G8R8A8_UNORM=87]="DXGI_FORMAT_B8G8R8A8_UNORM",t[t.DXGI_FORMAT_B8G8R8X8_UNORM=88]="DXGI_FORMAT_B8G8R8X8_UNORM",t[t.DXGI_FORMAT_R10G10B10_XR_BIAS_A2_UNORM=89]="DXGI_FORMAT_R10G10B10_XR_BIAS_A2_UNORM",t[t.DXGI_FORMAT_B8G8R8A8_TYPELESS=90]="DXGI_FORMAT_B8G8R8A8_TYPELESS",t[t.DXGI_FORMAT_B8G8R8A8_UNORM_SRGB=91]="DXGI_FORMAT_B8G8R8A8_UNORM_SRGB",t[t.DXGI_FORMAT_B8G8R8X8_TYPELESS=92]="DXGI_FORMAT_B8G8R8X8_TYPELESS",t[t.DXGI_FORMAT_B8G8R8X8_UNORM_SRGB=93]="DXGI_FORMAT_B8G8R8X8_UNORM_SRGB",t[t.DXGI_FORMAT_BC6H_TYPELESS=94]="DXGI_FORMAT_BC6H_TYPELESS",t[t.DXGI_FORMAT_BC6H_UF16=95]="DXGI_FORMAT_BC6H_UF16",t[t.DXGI_FORMAT_BC6H_SF16=96]="DXGI_FORMAT_BC6H_SF16",t[t.DXGI_FORMAT_BC7_TYPELESS=97]="DXGI_FORMAT_BC7_TYPELESS",t[t.DXGI_FORMAT_BC7_UNORM=98]="DXGI_FORMAT_BC7_UNORM",t[t.DXGI_FORMAT_BC7_UNORM_SRGB=99]="DXGI_FORMAT_BC7_UNORM_SRGB",t[t.DXGI_FORMAT_AYUV=100]="DXGI_FORMAT_AYUV",t[t.DXGI_FORMAT_Y410=101]="DXGI_FORMAT_Y410",t[t.DXGI_FORMAT_Y416=102]="DXGI_FORMAT_Y416",t[t.DXGI_FORMAT_NV12=103]="DXGI_FORMAT_NV12",t[t.DXGI_FORMAT_P010=104]="DXGI_FORMAT_P010",t[t.DXGI_FORMAT_P016=105]="DXGI_FORMAT_P016",t[t.DXGI_FORMAT_420_OPAQUE=106]="DXGI_FORMAT_420_OPAQUE",t[t.DXGI_FORMAT_YUY2=107]="DXGI_FORMAT_YUY2",t[t.DXGI_FORMAT_Y210=108]="DXGI_FORMAT_Y210",t[t.DXGI_FORMAT_Y216=109]="DXGI_FORMAT_Y216",t[t.DXGI_FORMAT_NV11=110]="DXGI_FORMAT_NV11",t[t.DXGI_FORMAT_AI44=111]="DXGI_FORMAT_AI44",t[t.DXGI_FORMAT_IA44=112]="DXGI_FORMAT_IA44",t[t.DXGI_FORMAT_P8=113]="DXGI_FORMAT_P8",t[t.DXGI_FORMAT_A8P8=114]="DXGI_FORMAT_A8P8",t[t.DXGI_FORMAT_B4G4R4A4_UNORM=115]="DXGI_FORMAT_B4G4R4A4_UNORM",t[t.DXGI_FORMAT_P208=116]="DXGI_FORMAT_P208",t[t.DXGI_FORMAT_V208=117]="DXGI_FORMAT_V208",t[t.DXGI_FORMAT_V408=118]="DXGI_FORMAT_V408",t[t.DXGI_FORMAT_SAMPLER_FEEDBACK_MIN_MIP_OPAQUE=119]="DXGI_FORMAT_SAMPLER_FEEDBACK_MIN_MIP_OPAQUE",t[t.DXGI_FORMAT_SAMPLER_FEEDBACK_MIP_REGION_USED_OPAQUE=120]="DXGI_FORMAT_SAMPLER_FEEDBACK_MIP_REGION_USED_OPAQUE",t[t.DXGI_FORMAT_FORCE_UINT=121]="DXGI_FORMAT_FORCE_UINT"}(Vo||(Vo={})),function(t){t[t.DDS_DIMENSION_TEXTURE1D=2]="DDS_DIMENSION_TEXTURE1D",t[t.DDS_DIMENSION_TEXTURE2D=3]="DDS_DIMENSION_TEXTURE2D",t[t.DDS_DIMENSION_TEXTURE3D=6]="DDS_DIMENSION_TEXTURE3D"}(Wo||(Wo={}));var zo,qo,Ko,Zo=((Go={})[827611204]=t.INTERNAL_FORMATS.COMPRESSED_RGBA_S3TC_DXT1_EXT,Go[861165636]=t.INTERNAL_FORMATS.COMPRESSED_RGBA_S3TC_DXT3_EXT,Go[894720068]=t.INTERNAL_FORMATS.COMPRESSED_RGBA_S3TC_DXT5_EXT,Go),Qo=((Xo={})[Vo.DXGI_FORMAT_BC1_TYPELESS]=t.INTERNAL_FORMATS.COMPRESSED_RGBA_S3TC_DXT1_EXT,Xo[Vo.DXGI_FORMAT_BC1_UNORM]=t.INTERNAL_FORMATS.COMPRESSED_RGBA_S3TC_DXT1_EXT,Xo[Vo.DXGI_FORMAT_BC2_TYPELESS]=t.INTERNAL_FORMATS.COMPRESSED_RGBA_S3TC_DXT3_EXT,Xo[Vo.DXGI_FORMAT_BC2_UNORM]=t.INTERNAL_FORMATS.COMPRESSED_RGBA_S3TC_DXT3_EXT,Xo[Vo.DXGI_FORMAT_BC3_TYPELESS]=t.INTERNAL_FORMATS.COMPRESSED_RGBA_S3TC_DXT5_EXT,Xo[Vo.DXGI_FORMAT_BC3_UNORM]=t.INTERNAL_FORMATS.COMPRESSED_RGBA_S3TC_DXT5_EXT,Xo[Vo.DXGI_FORMAT_BC1_UNORM_SRGB]=t.INTERNAL_FORMATS.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT,Xo[Vo.DXGI_FORMAT_BC2_UNORM_SRGB]=t.INTERNAL_FORMATS.COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT,Xo[Vo.DXGI_FORMAT_BC3_UNORM_SRGB]=t.INTERNAL_FORMATS.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT,Xo),Jo=function(){function t(){}return t.use=function(e,r){if("dds"===e.extension&&e.data)try{Object.assign(e,jo(e.name||e.url,t.parse(e.data),e.metadata))}catch(t){return void r(t)}r()},t.parse=function(t){var e=new Uint32Array(t);if(542327876!==e[0])throw new Error("Invalid DDS file magic word");var r=new Uint32Array(t,0,124/Uint32Array.BYTES_PER_ELEMENT),i=r[3],n=r[4],o=r[7],s=new Uint32Array(t,19*Uint32Array.BYTES_PER_ELEMENT,32/Uint32Array.BYTES_PER_ELEMENT),a=s[1];if(4&a){var h=s[2];if(808540228!==h){var u=Zo[h],l=new Uint8Array(t,128);return[new Ho(l,{format:u,width:n,height:i,levels:o})]}var c=new Uint32Array(e.buffer,128,20/Uint32Array.BYTES_PER_ELEMENT),d=c[0],f=c[1],p=c[2],_=c[3],m=Qo[d];if(void 0===m)throw new Error("DDSLoader cannot parse texture data with DXGI format "+d);if(4===p)throw new Error("DDSLoader does not support cubemap textures");if(f===Wo.DDS_DIMENSION_TEXTURE3D)throw new Error("DDSLoader does not supported 3D texture data");var v=new Array;if(1===_)v.push(new Uint8Array(t,148));else{for(var y=Fo[m],E=0,g=n,T=i,b=0;b<o;b++)E+=Math.max(1,g+3&-4)*Math.max(1,T+3&-4)*y,g>>>=1,T>>>=1;var R=148;for(b=0;b<_;b++)v.push(new Uint8Array(t,R,E)),R+=E}return v.map(function(t){return new Ho(t,{format:m,width:n,height:i,levels:o})})}if(64&a)throw new Error("DDSLoader does not support uncompressed texture data.");if(512&a)throw new Error("DDSLoader does not supported YUV uncompressed texture data.");if(131072&a)throw new Error("DDSLoader does not support single-channel (lumninance) texture data!");if(2&a)throw new Error("DDSLoader does not support single-channel (alpha) texture data!");throw new Error("DDSLoader failed to load a texture file due to an unknown reason!")},t}();t.LoaderResource.setExtensionXhrType("ktx",t.LoaderResource.XHR_RESPONSE_TYPE.BUFFER);var $o=[171,75,84,88,32,49,49,187,13,10,26,10],ts=((zo={})[t.TYPES.UNSIGNED_BYTE]=1,zo[t.TYPES.UNSIGNED_SHORT]=2,zo[t.TYPES.FLOAT]=4,zo[t.TYPES.HALF_FLOAT]=8,zo),es=((qo={})[t.FORMATS.RGBA]=4,qo[t.FORMATS.RGB]=3,qo[t.FORMATS.LUMINANCE]=1,qo[t.FORMATS.LUMINANCE_ALPHA]=2,qo[t.FORMATS.ALPHA]=1,qo),rs=((Ko={})[t.TYPES.UNSIGNED_SHORT_4_4_4_4]=2,Ko[t.TYPES.UNSIGNED_SHORT_5_5_5_1]=2,Ko[t.TYPES.UNSIGNED_SHORT_5_6_5]=2,Ko),is=function(){function t(){}return t.use=function(e,r){if("ktx"===e.extension&&e.data)try{var i=e.name||e.url;Object.assign(e,jo(i,t.parse(i,e.data),e.metadata))}catch(t){return void r(t)}r()},t.parse=function(e,r){var i=new DataView(r);if(!t.validate(e,i))return null;var n=67305985===i.getUint32(12,!0),o=i.getUint32(16,n),s=i.getUint32(24,n),a=i.getUint32(28,n),h=i.getUint32(36,n),u=i.getUint32(40,n)||1,l=i.getUint32(44,n)||1,c=i.getUint32(48,n)||1,d=i.getUint32(52,n),f=i.getUint32(56,n),p=i.getUint32(60,n);if(0===u||1!==l)throw new Error("Only 2D textures are supported");if(1!==d)throw new Error("CubeTextures are not supported by KTXLoader yet!");if(1!==c)throw new Error("WebGL does not support array textures");var _,m=h+3&-4,v=u+3&-4,y=new Array(c),E=h*u;if(0===o&&(E=m*v),void 0===(_=0!==o?ts[o]?ts[o]*es[s]:rs[o]:Fo[a]))throw new Error("Unable to resolve the pixel format stored in the *.ktx file!");for(var g=E*_,T=h,b=u,R=m,x=v,A=64+p,S=0;S<f;S++){for(var O=i.getUint32(A,n),I=A+4,P=0;P<c;P++){var M=y[P];M||(M=y[P]=new Array(f)),M[S]={levelID:S,levelWidth:f>1?T:R,levelHeight:f>1?b:x,levelBuffer:new Uint8Array(r,I,g)},I+=g}A=(A+=O+4)%4!=0?A+4-A%4:A,g=(R=(T=T>>1||1)+4-1&-4)*(x=(b=b>>1||1)+4-1&-4)*_}if(0!==o)throw new Error("TODO: Uncompressed");return y.map(function(t){return new Ho(null,{format:a,width:h,height:u,levels:f,levelBuffers:t})})},t.validate=function(t,e){for(var r=0;r<$o.length;r++)if(e.getUint8(r)!==$o[r])return!1;return!0},t}(),ns=function(t,e){return(ns=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r])})(t,e)};function os(t,e){function r(){this.constructor=t}ns(t,e),t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)}var ss=function(e){function r(r,i,n,o){void 0===r&&(r=1500),void 0===n&&(n=16384),void 0===o&&(o=!1);var s=e.call(this)||this;return n>16384&&(n=16384),s._properties=[!1,!0,!1,!1,!1],s._maxSize=r,s._batchSize=n,s._buffers=null,s._bufferUpdateIDs=[],s._updateID=0,s.interactiveChildren=!1,s.blendMode=t.BLEND_MODES.NORMAL,s.autoResize=o,s.roundPixels=!0,s.baseTexture=null,s.setProperties(i),s._tint=0,s.tintRgb=new Float32Array(4),s.tint=16777215,s}return os(r,e),r.prototype.setProperties=function(t){t&&(this._properties[0]="vertices"in t||"scale"in t?!!t.vertices||!!t.scale:this._properties[0],this._properties[1]="position"in t?!!t.position:this._properties[1],this._properties[2]="rotation"in t?!!t.rotation:this._properties[2],this._properties[3]="uvs"in t?!!t.uvs:this._properties[3],this._properties[4]="tint"in t||"alpha"in t?!!t.tint||!!t.alpha:this._properties[4])},r.prototype.updateTransform=function(){this.displayObjectUpdateTransform()},Object.defineProperty(r.prototype,"tint",{get:function(){return this._tint},set:function(t){this._tint=t,ce(t,this.tintRgb)},enumerable:!1,configurable:!0}),r.prototype.render=function(t){var e=this;this.visible&&!(this.worldAlpha<=0)&&this.children.length&&this.renderable&&(this.baseTexture||(this.baseTexture=this.children[0]._texture.baseTexture,this.baseTexture.valid||this.baseTexture.once("update",function(){return e.onChildrenChange(0)})),t.batch.setObjectRenderer(t.plugins.particle),t.plugins.particle.render(this))},r.prototype.onChildrenChange=function(t){for(var e=Math.floor(t/this._batchSize);this._bufferUpdateIDs.length<e;)this._bufferUpdateIDs.push(0);this._bufferUpdateIDs[e]=++this._updateID},r.prototype.dispose=function(){if(this._buffers){for(var t=0;t<this._buffers.length;++t)this._buffers[t].destroy();this._buffers=null}},r.prototype.destroy=function(t){e.prototype.destroy.call(this,t),this.dispose(),this._properties=null,this._buffers=null,this._bufferUpdateIDs=null},r}(dr),as=function(){function e(e,r,i){this.geometry=new fi,this.indexBuffer=null,this.size=i,this.dynamicProperties=[],this.staticProperties=[];for(var n=0;n<e.length;++n){var o=e[n];o={attributeName:o.attributeName,size:o.size,uploadFunction:o.uploadFunction,type:o.type||t.TYPES.FLOAT,offset:o.offset},r[n]?this.dynamicProperties.push(o):this.staticProperties.push(o)}this.staticStride=0,this.staticBuffer=null,this.staticData=null,this.staticDataUint32=null,this.dynamicStride=0,this.dynamicBuffer=null,this.dynamicData=null,this.dynamicDataUint32=null,this._updateID=0,this.initBuffers()}return e.prototype.initBuffers=function(){var e=this.geometry,r=0;this.indexBuffer=new hi(Ee(this.size),!0,!0),e.addIndex(this.indexBuffer),this.dynamicStride=0;for(var i=0;i<this.dynamicProperties.length;++i)(a=this.dynamicProperties[i]).offset=r,r+=a.size,this.dynamicStride+=a.size;var n=new ArrayBuffer(this.size*this.dynamicStride*4*4);this.dynamicData=new Float32Array(n),this.dynamicDataUint32=new Uint32Array(n),this.dynamicBuffer=new hi(this.dynamicData,!1,!1);var o=0;for(this.staticStride=0,i=0;i<this.staticProperties.length;++i)(a=this.staticProperties[i]).offset=o,o+=a.size,this.staticStride+=a.size;var s=new ArrayBuffer(this.size*this.staticStride*4*4);for(this.staticData=new Float32Array(s),this.staticDataUint32=new Uint32Array(s),this.staticBuffer=new hi(this.staticData,!0,!1),i=0;i<this.dynamicProperties.length;++i){var a=this.dynamicProperties[i];e.addAttribute(a.attributeName,this.dynamicBuffer,0,a.type===t.TYPES.UNSIGNED_BYTE,a.type,4*this.dynamicStride,4*a.offset)}for(i=0;i<this.staticProperties.length;++i)a=this.staticProperties[i],e.addAttribute(a.attributeName,this.staticBuffer,0,a.type===t.TYPES.UNSIGNED_BYTE,a.type,4*this.staticStride,4*a.offset)},e.prototype.uploadDynamic=function(e,r,i){for(var n=0;n<this.dynamicProperties.length;n++){var o=this.dynamicProperties[n];o.uploadFunction(e,r,i,o.type===t.TYPES.UNSIGNED_BYTE?this.dynamicDataUint32:this.dynamicData,this.dynamicStride,o.offset)}this.dynamicBuffer._updateID++},e.prototype.uploadStatic=function(e,r,i){for(var n=0;n<this.staticProperties.length;n++){var o=this.staticProperties[n];o.uploadFunction(e,r,i,o.type===t.TYPES.UNSIGNED_BYTE?this.staticDataUint32:this.staticData,this.staticStride,o.offset)}this.staticBuffer._updateID++},e.prototype.destroy=function(){this.indexBuffer=null,this.dynamicProperties=null,this.dynamicBuffer=null,this.dynamicData=null,this.dynamicDataUint32=null,this.staticProperties=null,this.staticBuffer=null,this.staticData=null,this.staticDataUint32=null,this.geometry.destroy()},e}(),hs="varying vec2 vTextureCoord;\nvarying vec4 vColor;\n\nuniform sampler2D uSampler;\n\nvoid main(void){\n    vec4 color = texture2D(uSampler, vTextureCoord) * vColor;\n    gl_FragColor = color;\n}",us="attribute vec2 aVertexPosition;\nattribute vec2 aTextureCoord;\nattribute vec4 aColor;\n\nattribute vec2 aPositionCoord;\nattribute float aRotation;\n\nuniform mat3 translationMatrix;\nuniform vec4 uColor;\n\nvarying vec2 vTextureCoord;\nvarying vec4 vColor;\n\nvoid main(void){\n    float x = (aVertexPosition.x) * cos(aRotation) - (aVertexPosition.y) * sin(aRotation);\n    float y = (aVertexPosition.x) * sin(aRotation) + (aVertexPosition.y) * cos(aRotation);\n\n    vec2 v = vec2(x, y);\n    v = v + aPositionCoord;\n\n    gl_Position = vec4((translationMatrix * vec3(v, 1.0)).xy, 0.0, 1.0);\n\n    vTextureCoord = aTextureCoord;\n    vColor = aColor * uColor;\n}\n",ls=function(e){function r(r){var i=e.call(this,r)||this;return i.shader=null,i.properties=null,i.tempMatrix=new Ze,i.properties=[{attributeName:"aVertexPosition",size:2,uploadFunction:i.uploadVertices,offset:0},{attributeName:"aPositionCoord",size:2,uploadFunction:i.uploadPosition,offset:0},{attributeName:"aRotation",size:1,uploadFunction:i.uploadRotation,offset:0},{attributeName:"aTextureCoord",size:2,uploadFunction:i.uploadUvs,offset:0},{attributeName:"aColor",size:1,type:t.TYPES.UNSIGNED_BYTE,uploadFunction:i.uploadTint,offset:0}],i.shader=rn.from(us,hs,{}),i.state=nn.for2d(),i}return os(r,e),r.prototype.render=function(t){var e=t.children,r=t._maxSize,i=t._batchSize,n=this.renderer,o=e.length;if(0!==o){o>r&&!t.autoResize&&(o=r);var s=t._buffers;s||(s=t._buffers=this.generateBuffers(t));var a=e[0]._texture.baseTexture;this.state.blendMode=_e(t.blendMode,a.alphaMode),n.state.set(this.state);var h=n.gl,u=t.worldTransform.copyTo(this.tempMatrix);u.prepend(n.globalUniforms.uniforms.projectionMatrix),this.shader.uniforms.translationMatrix=u.toArray(!0),this.shader.uniforms.uColor=me(t.tintRgb,t.worldAlpha,this.shader.uniforms.uColor,a.alphaMode),this.shader.uniforms.uSampler=a,this.renderer.shader.bind(this.shader);for(var l=!1,c=0,d=0;c<o;c+=i,d+=1){var f=o-c;f>i&&(f=i),d>=s.length&&s.push(this._generateOneMoreBuffer(t));var p=s[d];p.uploadDynamic(e,c,f);var _=t._bufferUpdateIDs[d]||0;(l=l||p._updateID<_)&&(p._updateID=t._updateID,p.uploadStatic(e,c,f)),n.geometry.bind(p.geometry),h.drawElements(h.TRIANGLES,6*f,h.UNSIGNED_SHORT,0)}}},r.prototype.generateBuffers=function(t){for(var e=[],r=t._maxSize,i=t._batchSize,n=t._properties,o=0;o<r;o+=i)e.push(new as(this.properties,n,i));return e},r.prototype._generateOneMoreBuffer=function(t){var e=t._batchSize,r=t._properties;return new as(this.properties,r,e)},r.prototype.uploadVertices=function(t,e,r,i,n,o){for(var s=0,a=0,h=0,u=0,l=0;l<r;++l){var c=t[e+l],d=c._texture,f=c.scale.x,p=c.scale.y,_=d.trim,m=d.orig;_?(s=(a=_.x-c.anchor.x*m.width)+_.width,h=(u=_.y-c.anchor.y*m.height)+_.height):(s=m.width*(1-c.anchor.x),a=m.width*-c.anchor.x,h=m.height*(1-c.anchor.y),u=m.height*-c.anchor.y),i[o]=a*f,i[o+1]=u*p,i[o+n]=s*f,i[o+n+1]=u*p,i[o+2*n]=s*f,i[o+2*n+1]=h*p,i[o+3*n]=a*f,i[o+3*n+1]=h*p,o+=4*n}},r.prototype.uploadPosition=function(t,e,r,i,n,o){for(var s=0;s<r;s++){var a=t[e+s].position;i[o]=a.x,i[o+1]=a.y,i[o+n]=a.x,i[o+n+1]=a.y,i[o+2*n]=a.x,i[o+2*n+1]=a.y,i[o+3*n]=a.x,i[o+3*n+1]=a.y,o+=4*n}},r.prototype.uploadRotation=function(t,e,r,i,n,o){for(var s=0;s<r;s++){var a=t[e+s].rotation;i[o]=a,i[o+n]=a,i[o+2*n]=a,i[o+3*n]=a,o+=4*n}},r.prototype.uploadUvs=function(t,e,r,i,n,o){for(var s=0;s<r;++s){var a=t[e+s]._texture._uvs;a?(i[o]=a.x0,i[o+1]=a.y0,i[o+n]=a.x1,i[o+n+1]=a.y1,i[o+2*n]=a.x2,i[o+2*n+1]=a.y2,i[o+3*n]=a.x3,i[o+3*n+1]=a.y3,o+=4*n):(i[o]=0,i[o+1]=0,i[o+n]=0,i[o+n+1]=0,i[o+2*n]=0,i[o+2*n+1]=0,i[o+3*n]=0,i[o+3*n+1]=0,o+=4*n)}},r.prototype.uploadTint=function(t,e,r,i,n,o){for(var s=0;s<r;++s){var a=t[e+s],h=a._texture.baseTexture.alphaMode>0,u=a.alpha,l=u<1&&h?ve(a._tintRGB,u):a._tintRGB+(255*u<<24);i[o]=l,i[o+n]=l,i[o+2*n]=l,i[o+3*n]=l,o+=4*n}},r.prototype.destroy=function(){e.prototype.destroy.call(this),this.shader&&(this.shader.destroy(),this.shader=null),this.tempMatrix=null},r}(bi);!function(t){t.MITER="miter",t.BEVEL="bevel",t.ROUND="round"}(t.LINE_JOIN||(t.LINE_JOIN={})),function(t){t.BUTT="butt",t.ROUND="round",t.SQUARE="square"}(t.LINE_CAP||(t.LINE_CAP={}));var cs={adaptive:!0,maxLength:10,minSegments:8,maxSegments:2048,epsilon:1e-4,_segmentsCount:function(t,e){if(void 0===e&&(e=20),!this.adaptive||!t||isNaN(t))return e;var r=Math.ceil(t/this.maxLength);return r<this.minSegments?r=this.minSegments:r>this.maxSegments&&(r=this.maxSegments),r}},ds=function(){function t(){this.color=16777215,this.alpha=1,this.texture=ri.WHITE,this.matrix=null,this.visible=!1,this.reset()}return t.prototype.clone=function(){var e=new t;return e.color=this.color,e.alpha=this.alpha,e.texture=this.texture,e.matrix=this.matrix,e.visible=this.visible,e},t.prototype.reset=function(){this.color=16777215,this.alpha=1,this.texture=ri.WHITE,this.matrix=null,this.visible=!1},t.prototype.destroy=function(){this.texture=null,this.matrix=null},t}(),fs=function(t,e){return(fs=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r])})(t,e)};function ps(t,e){function r(){this.constructor=t}fs(t,e),t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)}var _s={build:function(t){t.points=t.shape.points.slice()},triangulate:function(t,e){var r=t.points,i=t.holes,n=e.points,o=e.indices;if(r.length>=6){for(var s=[],a=0;a<i.length;a++){var h=i[a];s.push(r.length/2),r=r.concat(h.points)}var u=st(r,s,2);if(!u)return;var l=n.length/2;for(a=0;a<u.length;a+=3)o.push(u[a]+l),o.push(u[a+1]+l),o.push(u[a+2]+l);for(a=0;a<r.length;a++)n.push(r[a])}}},ms={build:function(e){var r,i,n=e.shape,o=e.points,s=n.x,a=n.y;if(o.length=0,e.type===t.SHAPES.CIRC)r=n.radius,i=n.radius;else{var h=e.shape;r=h.width,i=h.height}if(0!==r&&0!==i){var u=Math.floor(30*Math.sqrt(n.radius))||Math.floor(15*Math.sqrt(r+i));u/=2.3;for(var l=2*Math.PI/u,c=0;c<u-.5;c++)o.push(s+Math.sin(-l*c)*r,a+Math.cos(-l*c)*i);o.push(o[0],o[1])}},triangulate:function(t,e){var r=t.points,i=e.points,n=e.indices,o=i.length/2,s=o,a=t.shape,h=t.matrix,u=a.x,l=a.y;i.push(t.matrix?h.a*u+h.c*l+h.tx:u,t.matrix?h.b*u+h.d*l+h.ty:l);for(var c=0;c<r.length;c+=2)i.push(r[c],r[c+1]),n.push(o++,s,o)}},vs={build:function(t){var e=t.shape,r=e.x,i=e.y,n=e.width,o=e.height,s=t.points;s.length=0,s.push(r,i,r+n,i,r+n,i+o,r,i+o)},triangulate:function(t,e){var r=t.points,i=e.points,n=i.length/2;i.push(r[0],r[1],r[2],r[3],r[6],r[7],r[4],r[5]),e.indices.push(n,n+1,n+2,n+1,n+2,n+3)}};function ys(t,e,r){return t+(e-t)*r}function Es(t,e,r,i,n,o,s){void 0===s&&(s=[]);for(var a=s,h=0,u=0,l=0,c=0,d=0,f=0,p=0,_=0;p<=20;++p)h=ys(t,r,_=p/20),u=ys(e,i,_),l=ys(r,n,_),c=ys(i,o,_),d=ys(h,l,_),f=ys(u,c,_),0===p&&a[a.length-2]===d&&a[a.length-1]===f||a.push(d,f);return a}var gs={build:function(t){var e=t.shape,r=t.points,i=e.x,n=e.y,o=e.width,s=e.height,a=Math.max(0,Math.min(e.radius,Math.min(o,s)/2));r.length=0,a?(Es(i,n+a,i,n,i+a,n,r),Es(i+o-a,n,i+o,n,i+o,n+a,r),Es(i+o,n+s-a,i+o,n+s,i+o-a,n+s,r),Es(i+a,n+s,i,n+s,i,n+s-a,r)):r.push(i,n,i+o,n,i+o,n+s,i,n+s)},triangulate:function(t,e){for(var r=t.points,i=e.points,n=e.indices,o=i.length/2,s=st(r,null,2),a=0,h=s.length;a<h;a+=3)n.push(s[a]+o),n.push(s[a+1]+o),n.push(s[a+2]+o);for(a=0,h=r.length;a<h;a++)i.push(r[a],r[++a])}};function Ts(t,e,r,i,n,o,s,a){var h,u;s?(h=i,u=-r):(h=-i,u=r);var l=t-r*n+h,c=e-i*n+u,d=t+r*o+h,f=e+i*o+u;return a.push(l,c),a.push(d,f),2}function bs(t,e,r,i,n,o,s,a){var h=r-t,u=i-e,l=Math.atan2(h,u),c=Math.atan2(n-t,o-e);a&&l<c?l+=2*Math.PI:!a&&l>c&&(c+=2*Math.PI);var d=l,f=c-l,p=Math.abs(f),_=Math.sqrt(h*h+u*u),m=1+(15*p*Math.sqrt(_)/Math.PI>>0),v=f/m;if(d+=v,a){s.push(t,e),s.push(r,i);for(var y=1,E=d;y<m;y++,E+=v)s.push(t,e),s.push(t+Math.sin(E)*_,e+Math.cos(E)*_);s.push(t,e),s.push(n,o)}else{for(s.push(r,i),s.push(t,e),y=1,E=d;y<m;y++,E+=v)s.push(t+Math.sin(E)*_,e+Math.cos(E)*_),s.push(t,e);s.push(n,o),s.push(t,e)}return 2*m}function Rs(e,r){e.lineStyle.native?function(e,r){var i=0,n=e.shape,o=e.points||n.points,s=n.type!==t.SHAPES.POLY||n.closeStroke;if(0!==o.length){var a=r.points,h=r.indices,u=o.length/2,l=a.length/2,c=l;for(a.push(o[0],o[1]),i=1;i<u;i++)a.push(o[2*i],o[2*i+1]),h.push(c,c+1),c++;s&&h.push(c,l)}}(e,r):function(e,r){var i=e.shape,n=e.points||i.points.slice(),o=r.closePointEps;if(0!==n.length){var s=e.lineStyle,a=new qe(n[0],n[1]),h=new qe(n[n.length-2],n[n.length-1]),u=i.type!==t.SHAPES.POLY||i.closeStroke,l=Math.abs(a.x-h.x)<o&&Math.abs(a.y-h.y)<o;if(u){n=n.slice(),l&&(n.pop(),n.pop(),h.set(n[n.length-2],n[n.length-1]));var c=.5*(a.x+h.x),d=.5*(h.y+a.y);n.unshift(c,d),n.push(c,d)}var f=r.points,p=n.length/2,_=n.length,m=f.length/2,v=s.width/2,y=v*v,E=s.miterLimit*s.miterLimit,g=n[0],T=n[1],b=n[2],R=n[3],x=0,A=0,S=-(T-R),O=g-b,I=0,P=0,M=Math.sqrt(S*S+O*O);S/=M,O/=M,S*=v,O*=v;var D=s.alignment,N=2*(1-D),w=2*D;u||(s.cap===t.LINE_CAP.ROUND?_+=bs(g-S*(N-w)*.5,T-O*(N-w)*.5,g-S*N,T-O*N,g+S*w,T+O*w,f,!0)+2:s.cap===t.LINE_CAP.SQUARE&&(_+=Ts(g,T,S,O,N,w,!0,f))),f.push(g-S*N,T-O*N),f.push(g+S*w,T+O*w);for(var C=1;C<p-1;++C){g=n[2*(C-1)],T=n[2*(C-1)+1],b=n[2*C],R=n[2*C+1],x=n[2*(C+1)],A=n[2*(C+1)+1],S=-(T-R),O=g-b,S/=M=Math.sqrt(S*S+O*O),O/=M,S*=v,O*=v,I=-(R-A),P=b-x,I/=M=Math.sqrt(I*I+P*P),P/=M,I*=v,P*=v;var L=b-g,F=T-R,U=b-x,B=A-R,G=F*U-B*L,X=G<0;if(Math.abs(G)<.1)f.push(b-S*N,R-O*N),f.push(b+S*w,R+O*w);else{var k=(-S+g)*(-O+R)-(-S+b)*(-O+T),H=(-I+x)*(-P+R)-(-I+b)*(-P+A),Y=(L*H-U*k)/G,j=(B*k-F*H)/G,V=(Y-b)*(Y-b)+(j-R)*(j-R),W=b+(Y-b)*N,z=R+(j-R)*N,q=b-(Y-b)*w,K=R-(j-R)*w,Z=X?N:w;V<=Math.min(L*L+F*F,U*U+B*B)+Z*Z*y?s.join===t.LINE_JOIN.BEVEL||V/y>E?(X?(f.push(W,z),f.push(b+S*w,R+O*w),f.push(W,z),f.push(b+I*w,R+P*w)):(f.push(b-S*N,R-O*N),f.push(q,K),f.push(b-I*N,R-P*N),f.push(q,K)),_+=2):s.join===t.LINE_JOIN.ROUND?X?(f.push(W,z),f.push(b+S*w,R+O*w),_+=bs(b,R,b+S*w,R+O*w,b+I*w,R+P*w,f,!0)+4,f.push(W,z),f.push(b+I*w,R+P*w)):(f.push(b-S*N,R-O*N),f.push(q,K),_+=bs(b,R,b-S*N,R-O*N,b-I*N,R-P*N,f,!1)+4,f.push(b-I*N,R-P*N),f.push(q,K)):(f.push(W,z),f.push(q,K)):(f.push(b-S*N,R-O*N),f.push(b+S*w,R+O*w),s.join===t.LINE_JOIN.BEVEL||V/y>E||(s.join===t.LINE_JOIN.ROUND?_+=X?bs(b,R,b+S*w,R+O*w,b+I*w,R+P*w,f,!0)+2:bs(b,R,b-S*N,R-O*N,b-I*N,R-P*N,f,!1)+2:(X?(f.push(q,K),f.push(q,K)):(f.push(W,z),f.push(W,z)),_+=2)),f.push(b-I*N,R-P*N),f.push(b+I*w,R+P*w),_+=2)}}g=n[2*(p-2)],T=n[2*(p-2)+1],b=n[2*(p-1)],S=-(T-(R=n[2*(p-1)+1])),O=g-b,S/=M=Math.sqrt(S*S+O*O),O/=M,S*=v,O*=v,f.push(b-S*N,R-O*N),f.push(b+S*w,R+O*w),u||(s.cap===t.LINE_CAP.ROUND?_+=bs(b-S*(N-w)*.5,R-O*(N-w)*.5,b-S*N,R-O*N,b+S*w,R+O*w,f,!1)+2:s.cap===t.LINE_CAP.SQUARE&&(_+=Ts(b,R,S,O,N,w,!1,f)));var Q=r.indices,J=cs.epsilon*cs.epsilon;for(C=m;C<_+m-2;++C)g=f[2*C],T=f[2*C+1],b=f[2*(C+1)],R=f[2*(C+1)+1],x=f[2*(C+2)],A=f[2*(C+2)+1],Math.abs(g*(R-A)+b*(A-T)+x*(T-R))<J||Q.push(C,C+1,C+2)}}(e,r)}var xs,As=function(){function t(){}return t.curveTo=function(t,e,r,i,n,o){var s=o[o.length-2],a=o[o.length-1]-e,h=s-t,u=i-e,l=r-t,c=Math.abs(a*l-h*u);if(c<1e-8||0===n)return o[o.length-2]===t&&o[o.length-1]===e||o.push(t,e),null;var d=a*a+h*h,f=u*u+l*l,p=a*u+h*l,_=n*Math.sqrt(d)/c,m=n*Math.sqrt(f)/c,v=_*p/d,y=m*p/f,E=_*l+m*h,g=_*u+m*a,T=h*(m+v),b=a*(m+v),R=l*(_+y),x=u*(_+y);return{cx:E+t,cy:g+e,radius:n,startAngle:Math.atan2(b-g,T-E),endAngle:Math.atan2(x-g,R-E),anticlockwise:h*u>l*a}},t.arc=function(t,e,r,i,n,o,s,a,h){for(var u=s-o,l=cs._segmentsCount(Math.abs(u)*n,40*Math.ceil(Math.abs(u)/Xe)),c=u/(2*l),d=2*c,f=Math.cos(c),p=Math.sin(c),_=l-1,m=_%1/_,v=0;v<=_;++v){var y=c+o+d*(v+m*v),E=Math.cos(y),g=-Math.sin(y);h.push((f*E+p*g)*n+r,(f*-g+p*E)*n+i)}},t}(),Ss=function(){function t(){}return t.curveLength=function(t,e,r,i,n,o,s,a){for(var h=0,u=0,l=0,c=0,d=0,f=0,p=0,_=0,m=0,v=0,y=0,E=t,g=e,T=1;T<=10;++T)v=E-(_=(p=(f=(d=1-(u=T/10))*d)*d)*t+3*f*u*r+3*d*(l=u*u)*n+(c=l*u)*s),y=g-(m=p*e+3*f*u*i+3*d*l*o+c*a),E=_,g=m,h+=Math.sqrt(v*v+y*y);return h},t.curveTo=function(e,r,i,n,o,s,a){var h=a[a.length-2],u=a[a.length-1];a.length-=2;var l=cs._segmentsCount(t.curveLength(h,u,e,r,i,n,o,s)),c=0,d=0,f=0,p=0,_=0;a.push(h,u);for(var m=1,v=0;m<=l;++m)f=(d=(c=1-(v=m/l))*c)*c,_=(p=v*v)*v,a.push(f*h+3*d*v*e+3*c*p*i+_*o,f*u+3*d*v*r+3*c*p*n+_*s)},t}(),Os=function(){function t(){}return t.curveLength=function(t,e,r,i,n,o){var s=t-2*r+n,a=e-2*i+o,h=2*r-2*t,u=2*i-2*e,l=4*(s*s+a*a),c=4*(s*h+a*u),d=h*h+u*u,f=2*Math.sqrt(l+c+d),p=Math.sqrt(l),_=2*l*p,m=2*Math.sqrt(d),v=c/p;return(_*f+p*c*(f-m)+(4*d*l-c*c)*Math.log((2*p+v+f)/(v+m)))/(4*_)},t.curveTo=function(e,r,i,n,o){for(var s=o[o.length-2],a=o[o.length-1],h=cs._segmentsCount(t.curveLength(s,a,e,r,i,n)),u=0,l=0,c=1;c<=h;++c){var d=c/h;u=s+(e-s)*d,l=a+(r-a)*d,o.push(u+(e+(i-e)*d-u)*d,l+(r+(n-r)*d-l)*d)}},t}(),Is=function(){function t(){this.reset()}return t.prototype.begin=function(t,e,r){this.reset(),this.style=t,this.start=e,this.attribStart=r},t.prototype.end=function(t,e){this.attribSize=e-this.attribStart,this.size=t-this.start},t.prototype.reset=function(){this.style=null,this.size=0,this.start=0,this.attribStart=0,this.attribSize=0},t}(),Ps=((xs={})[t.SHAPES.POLY]=_s,xs[t.SHAPES.CIRC]=ms,xs[t.SHAPES.ELIP]=ms,xs[t.SHAPES.RECT]=vs,xs[t.SHAPES.RREC]=gs,xs),Ms=[],Ds=[];function Ns(t){for(var e=t.points,r=0,i=0;i<e.length-2;i+=2)r+=(e[i+2]-e[i])*(e[i+3]+e[i+1]);return r>0}var ws=function(){function t(t,e,r,i){void 0===e&&(e=null),void 0===r&&(r=null),void 0===i&&(i=null),this.points=[],this.holes=[],this.shape=t,this.lineStyle=r,this.fillStyle=e,this.matrix=i,this.type=t.type}return t.prototype.clone=function(){return new t(this.shape,this.fillStyle,this.lineStyle,this.matrix)},t.prototype.destroy=function(){this.shape=null,this.holes.length=0,this.holes=null,this.points.length=0,this.points=null,this.lineStyle=null,this.fillStyle=null},t}(),Cs=new qe,Ls=new sr,Fs=function(e){function r(){var t=e.call(this)||this;return t.closePointEps=1e-4,t.boundsPadding=0,t.uvsFloat32=null,t.indicesUint16=null,t.batchable=!1,t.points=[],t.colors=[],t.uvs=[],t.indices=[],t.textureIds=[],t.graphicsData=[],t.drawCalls=[],t.batchDirty=-1,t.batches=[],t.dirty=0,t.cacheDirty=-1,t.clearDirty=0,t.shapeIndex=0,t._bounds=new sr,t.boundsDirty=-1,t}return ps(r,e),Object.defineProperty(r.prototype,"bounds",{get:function(){return this.boundsDirty!==this.dirty&&(this.boundsDirty=this.dirty,this.calculateBounds()),this._bounds},enumerable:!1,configurable:!0}),r.prototype.invalidate=function(){this.boundsDirty=-1,this.dirty++,this.batchDirty++,this.shapeIndex=0,this.points.length=0,this.colors.length=0,this.uvs.length=0,this.indices.length=0,this.textureIds.length=0;for(var t=0;t<this.drawCalls.length;t++)this.drawCalls[t].texArray.clear(),Ds.push(this.drawCalls[t]);for(this.drawCalls.length=0,t=0;t<this.batches.length;t++){var e=this.batches[t];e.reset(),Ms.push(e)}this.batches.length=0},r.prototype.clear=function(){return this.graphicsData.length>0&&(this.invalidate(),this.clearDirty++,this.graphicsData.length=0),this},r.prototype.drawShape=function(t,e,r,i){void 0===e&&(e=null),void 0===r&&(r=null),void 0===i&&(i=null);var n=new ws(t,e,r,i);return this.graphicsData.push(n),this.dirty++,this},r.prototype.drawHole=function(t,e){if(void 0===e&&(e=null),!this.graphicsData.length)return null;var r=new ws(t,null,null,e),i=this.graphicsData[this.graphicsData.length-1];return r.lineStyle=i.lineStyle,i.holes.push(r),this.dirty++,this},r.prototype.destroy=function(){e.prototype.destroy.call(this);for(var t=0;t<this.graphicsData.length;++t)this.graphicsData[t].destroy();this.points.length=0,this.points=null,this.colors.length=0,this.colors=null,this.uvs.length=0,this.uvs=null,this.indices.length=0,this.indices=null,this.indexBuffer.destroy(),this.indexBuffer=null,this.graphicsData.length=0,this.graphicsData=null,this.drawCalls.length=0,this.drawCalls=null,this.batches.length=0,this.batches=null,this._bounds=null},r.prototype.containsPoint=function(t){for(var e=this.graphicsData,r=0;r<e.length;++r){var i=e[r];if(i.fillStyle.visible&&i.shape&&(i.matrix?i.matrix.applyInverse(t,Cs):Cs.copyFrom(t),i.shape.contains(Cs.x,Cs.y))){var n=!1;if(i.holes)for(var o=0;o<i.holes.length;o++)if(i.holes[o].shape.contains(Cs.x,Cs.y)){n=!0;break}if(!n)return!0}}return!1},r.prototype.updateBatches=function(e){if(this.graphicsData.length){if(this.validateBatching()){this.cacheDirty=this.dirty;var r=this.uvs,i=this.graphicsData,n=null,o=null;this.batches.length>0&&(o=(n=this.batches[this.batches.length-1]).style);for(var s=this.shapeIndex;s<i.length;s++){this.shapeIndex++;var a=i[s],h=a.fillStyle,u=a.lineStyle;Ps[a.type].build(a),a.matrix&&this.transformPoints(a.points,a.matrix);for(var l=0;l<2;l++){var c=0===l?h:u;if(c.visible){var d=c.texture.baseTexture,f=this.indices.length,p=this.points.length/2;d.wrapMode=t.WRAP_MODES.REPEAT,0===l?this.processFill(a):this.processLine(a);var _=this.points.length/2-p;0!==_&&(n&&!this._compareStyles(o,c)&&(n.end(f,p),n=null),n||((n=Ms.pop()||new Is).begin(c,f,p),this.batches.push(n),o=c),this.addUvs(this.points,r,c.texture,p,_,c.matrix))}}}var m=this.indices.length,v=this.points.length/2;if(n&&n.end(m,v),0!==this.batches.length){if(this.indicesUint16&&this.indices.length===this.indicesUint16.length)this.indicesUint16.set(this.indices);else{var y=v>65535&&e;this.indicesUint16=y?new Uint32Array(this.indices):new Uint16Array(this.indices)}this.batchable=this.isBatchable(),this.batchable?this.packBatches():this.buildDrawCalls()}else this.batchable=!0}}else this.batchable=!0},r.prototype._compareStyles=function(t,e){return!(!t||!e)&&t.texture.baseTexture===e.texture.baseTexture&&t.color+t.alpha===e.color+e.alpha&&!!t.native==!!e.native},r.prototype.validateBatching=function(){if(this.dirty===this.cacheDirty||!this.graphicsData.length)return!1;for(var t=0,e=this.graphicsData.length;t<e;t++){var r=this.graphicsData[t],i=r.fillStyle,n=r.lineStyle;if(i&&!i.texture.baseTexture.valid)return!1;if(n&&!n.texture.baseTexture.valid)return!1}return!0},r.prototype.packBatches=function(){this.batchDirty++,this.uvsFloat32=new Float32Array(this.uvs);for(var t=this.batches,e=0,r=t.length;e<r;e++)for(var i=t[e],n=0;n<i.size;n++){var o=i.start+n;this.indicesUint16[o]=this.indicesUint16[o]-i.attribStart}},r.prototype.isBatchable=function(){if(this.points.length>131070)return!1;for(var t=this.batches,e=0;e<t.length;e++)if(t[e].style.native)return!1;return this.points.length<2*r.BATCHABLE_SIZE},r.prototype.buildDrawCalls=function(){for(var e=++Xr._globalBatch,r=0;r<this.drawCalls.length;r++)this.drawCalls[r].texArray.clear(),Ds.push(this.drawCalls[r]);this.drawCalls.length=0;var i=this.colors,n=this.textureIds,o=Ds.pop();o||((o=new Qn).texArray=new Jn),o.texArray.count=0,o.start=0,o.size=0,o.type=t.DRAW_MODES.TRIANGLES;var s=0,a=null,h=0,u=!1,l=t.DRAW_MODES.TRIANGLES,c=0;for(this.drawCalls.push(o),r=0;r<this.batches.length;r++){var d=this.batches[r],f=d.style,p=f.texture.baseTexture;u!==!!f.native&&(l=(u=!!f.native)?t.DRAW_MODES.LINES:t.DRAW_MODES.TRIANGLES,a=null,s=8,e++),a!==p&&(a=p,p._batchEnabled!==e&&(8===s&&(e++,s=0,o.size>0&&((o=Ds.pop())||((o=new Qn).texArray=new Jn),this.drawCalls.push(o)),o.start=c,o.size=0,o.texArray.count=0,o.type=l),p.touched=1,p._batchEnabled=e,p._batchLocation=s,p.wrapMode=t.WRAP_MODES.REPEAT,o.texArray.elements[o.texArray.count++]=p,s++)),o.size+=d.size,c+=d.size,h=p._batchLocation,this.addColors(i,f.color,f.alpha,d.attribSize,d.attribStart),this.addTextureIds(n,h,d.attribSize,d.attribStart)}Xr._globalBatch=e,this.packAttributes()},r.prototype.packAttributes=function(){for(var t=this.points,e=this.uvs,r=this.colors,i=this.textureIds,n=new ArrayBuffer(3*t.length*4),o=new Float32Array(n),s=new Uint32Array(n),a=0,h=0;h<t.length/2;h++)o[a++]=t[2*h],o[a++]=t[2*h+1],o[a++]=e[2*h],o[a++]=e[2*h+1],s[a++]=r[h],o[a++]=i[h];this._buffer.update(n),this._indexBuffer.update(this.indicesUint16)},r.prototype.processFill=function(t){t.holes.length?(this.processHoles(t.holes),_s.triangulate(t,this)):Ps[t.type].triangulate(t,this)},r.prototype.processLine=function(t){Rs(t,this);for(var e=0;e<t.holes.length;e++)Rs(t.holes[e],this)},r.prototype.processHoles=function(t){for(var e=0;e<t.length;e++){var r=t[e];Ps[r.type].build(r),r.matrix&&this.transformPoints(r.points,r.matrix)}},r.prototype.calculateBounds=function(){var e=this._bounds,r=Ls,i=Ze.IDENTITY;this._bounds.clear(),r.clear();for(var n=0;n<this.graphicsData.length;n++){var o=this.graphicsData[n],s=o.shape,a=o.type,h=o.lineStyle,u=o.matrix||Ze.IDENTITY,l=0;if(h&&h.visible){var c=h.alignment;l=h.width,a===t.SHAPES.POLY?Ns(s)?l*=1-c:l*=c:l*=Math.max(0,c)}if(i!==u&&(r.isEmpty()||(e.addBoundsMatrix(r,i),r.clear()),i=u),a===t.SHAPES.RECT||a===t.SHAPES.RREC){var d=s;r.addFramePad(d.x,d.y,d.x+d.width,d.y+d.height,l,l)}else if(a===t.SHAPES.CIRC){var f=s;r.addFramePad(f.x,f.y,f.x,f.y,f.radius+l,f.radius+l)}else if(a===t.SHAPES.ELIP){var p=s;r.addFramePad(p.x,p.y,p.x,p.y,p.width+l,p.height+l)}else{var _=s;e.addVerticesMatrix(i,_.points,0,_.points.length,l,l)}}r.isEmpty()||e.addBoundsMatrix(r,i),e.pad(this.boundsPadding,this.boundsPadding)},r.prototype.transformPoints=function(t,e){for(var r=0;r<t.length/2;r++){var i=t[2*r],n=t[2*r+1];t[2*r]=e.a*i+e.c*n+e.tx,t[2*r+1]=e.b*i+e.d*n+e.ty}},r.prototype.addColors=function(t,e,r,i,n){void 0===n&&(n=0);var o=ve((e>>16)+(65280&e)+((255&e)<<16),r);t.length=Math.max(t.length,n+i);for(var s=0;s<i;s++)t[n+s]=o},r.prototype.addTextureIds=function(t,e,r,i){void 0===i&&(i=0),t.length=Math.max(t.length,i+r);for(var n=0;n<r;n++)t[i+n]=e},r.prototype.addUvs=function(t,e,r,i,n,o){void 0===o&&(o=null);for(var s=0,a=e.length,h=r.frame;s<n;){var u=t[2*(i+s)],l=t[2*(i+s)+1];if(o){var c=o.a*u+o.c*l+o.tx;l=o.b*u+o.d*l+o.ty,u=c}s++,e.push(u/h.width,l/h.height)}var d=r.baseTexture;(h.width<d.width||h.height<d.height)&&this.adjustUvs(e,r,a,n)},r.prototype.adjustUvs=function(t,e,r,i){for(var n=e.baseTexture,o=r+2*i,s=e.frame,a=s.width/n.width,h=s.height/n.height,u=s.x/s.width,l=s.y/s.height,c=Math.floor(t[r]+1e-6),d=Math.floor(t[r+1]+1e-6),f=r+2;f<o;f+=2)c=Math.min(c,Math.floor(t[f]+1e-6)),d=Math.min(d,Math.floor(t[f+1]+1e-6));for(u-=c,l-=d,f=r;f<o;f+=2)t[f]=(t[f]+u)*a,t[f+1]=(t[f+1]+l)*h},r.BATCHABLE_SIZE=100,r}(ro),Us=function(e){function r(){var r=null!==e&&e.apply(this,arguments)||this;return r.width=0,r.alignment=.5,r.native=!1,r.cap=t.LINE_CAP.BUTT,r.join=t.LINE_JOIN.MITER,r.miterLimit=10,r}return ps(r,e),r.prototype.clone=function(){var t=new r;return t.color=this.color,t.alpha=this.alpha,t.texture=this.texture,t.matrix=this.matrix,t.visible=this.visible,t.width=this.width,t.alignment=this.alignment,t.native=this.native,t.cap=this.cap,t.join=this.join,t.miterLimit=this.miterLimit,t},r.prototype.reset=function(){e.prototype.reset.call(this),this.color=0,this.alignment=.5,this.width=0,this.native=!1},r}(ds),Bs=new Float32Array(3),Gs={},Xs=function(e){function r(r){void 0===r&&(r=null);var i=e.call(this)||this;return i.shader=null,i.pluginName="batch",i.currentPath=null,i.batches=[],i.batchTint=-1,i.batchDirty=-1,i.vertexData=null,i._fillStyle=new ds,i._lineStyle=new Us,i._matrix=null,i._holeMode=!1,i.state=nn.for2d(),i._geometry=r||new Fs,i._geometry.refCount++,i._transformID=-1,i.tint=16777215,i.blendMode=t.BLEND_MODES.NORMAL,i}return ps(r,e),Object.defineProperty(r.prototype,"geometry",{get:function(){return this._geometry},enumerable:!1,configurable:!0}),r.prototype.clone=function(){return this.finishPoly(),new r(this._geometry)},Object.defineProperty(r.prototype,"blendMode",{get:function(){return this.state.blendMode},set:function(t){this.state.blendMode=t},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"tint",{get:function(){return this._tint},set:function(t){this._tint=t},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"fill",{get:function(){return this._fillStyle},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"line",{get:function(){return this._lineStyle},enumerable:!1,configurable:!0}),r.prototype.lineStyle=function(t,e,r,i,n){return void 0===t&&(t=null),void 0===e&&(e=0),void 0===r&&(r=1),void 0===i&&(i=.5),void 0===n&&(n=!1),"number"==typeof t&&(t={width:t,color:e,alpha:r,alignment:i,native:n}),this.lineTextureStyle(t)},r.prototype.lineTextureStyle=function(e){e=Object.assign({width:0,texture:ri.WHITE,color:e&&e.texture?16777215:0,alpha:1,matrix:null,alignment:.5,native:!1,cap:t.LINE_CAP.BUTT,join:t.LINE_JOIN.MITER,miterLimit:10},e),this.currentPath&&this.startPoly();var r=e.width>0&&e.alpha>0;return r?(e.matrix&&(e.matrix=e.matrix.clone(),e.matrix.invert()),Object.assign(this._lineStyle,{visible:r},e)):this._lineStyle.reset(),this},r.prototype.startPoly=function(){if(this.currentPath){var t=this.currentPath.points,e=this.currentPath.points.length;e>2&&(this.drawShape(this.currentPath),this.currentPath=new We,this.currentPath.closeStroke=!1,this.currentPath.points.push(t[e-2],t[e-1]))}else this.currentPath=new We,this.currentPath.closeStroke=!1},r.prototype.finishPoly=function(){this.currentPath&&(this.currentPath.points.length>2?(this.drawShape(this.currentPath),this.currentPath=null):this.currentPath.points.length=0)},r.prototype.moveTo=function(t,e){return this.startPoly(),this.currentPath.points[0]=t,this.currentPath.points[1]=e,this},r.prototype.lineTo=function(t,e){this.currentPath||this.moveTo(0,0);var r=this.currentPath.points,i=r[r.length-2],n=r[r.length-1];return i===t&&n===e||r.push(t,e),this},r.prototype._initCurve=function(t,e){void 0===t&&(t=0),void 0===e&&(e=0),this.currentPath?0===this.currentPath.points.length&&(this.currentPath.points=[t,e]):this.moveTo(t,e)},r.prototype.quadraticCurveTo=function(t,e,r,i){this._initCurve();var n=this.currentPath.points;return 0===n.length&&this.moveTo(0,0),Os.curveTo(t,e,r,i,n),this},r.prototype.bezierCurveTo=function(t,e,r,i,n,o){return this._initCurve(),Ss.curveTo(t,e,r,i,n,o,this.currentPath.points),this},r.prototype.arcTo=function(t,e,r,i,n){this._initCurve(t,e);var o=this.currentPath.points,s=As.curveTo(t,e,r,i,n,o);if(s){var a=s.cx,h=s.cy,u=s.radius,l=s.startAngle,c=s.endAngle,d=s.anticlockwise;this.arc(a,h,u,l,c,d)}return this},r.prototype.arc=function(t,e,r,i,n,o){if(void 0===o&&(o=!1),i===n)return this;if(!o&&n<=i?n+=Xe:o&&i<=n&&(i+=Xe),0==n-i)return this;var s=t+Math.cos(i)*r,a=e+Math.sin(i)*r,h=this._geometry.closePointEps,u=this.currentPath?this.currentPath.points:null;if(u){var l=Math.abs(u[u.length-2]-s),c=Math.abs(u[u.length-1]-a);l<h&&c<h||u.push(s,a)}else this.moveTo(s,a),u=this.currentPath.points;return As.arc(s,a,t,e,r,i,n,o,u),this},r.prototype.beginFill=function(t,e){return void 0===t&&(t=0),void 0===e&&(e=1),this.beginTextureFill({texture:ri.WHITE,color:t,alpha:e})},r.prototype.beginTextureFill=function(t){t=Object.assign({texture:ri.WHITE,color:16777215,alpha:1,matrix:null},t),this.currentPath&&this.startPoly();var e=t.alpha>0;return e?(t.matrix&&(t.matrix=t.matrix.clone(),t.matrix.invert()),Object.assign(this._fillStyle,{visible:e},t)):this._fillStyle.reset(),this},r.prototype.endFill=function(){return this.finishPoly(),this._fillStyle.reset(),this},r.prototype.drawRect=function(t,e,r,i){return this.drawShape(new Ye(t,e,r,i))},r.prototype.drawRoundedRect=function(t,e,r,i,n){return this.drawShape(new ze(t,e,r,i,n))},r.prototype.drawCircle=function(t,e,r){return this.drawShape(new je(t,e,r))},r.prototype.drawEllipse=function(t,e,r,i){return this.drawShape(new Ve(t,e,r,i))},r.prototype.drawPolygon=function(){for(var t,e=arguments,r=[],i=0;i<arguments.length;i++)r[i]=e[i];var n=!0,o=r[0];o.points?(n=o.closeStroke,t=o.points):t=Array.isArray(r[0])?r[0]:r;var s=new We(t);return s.closeStroke=n,this.drawShape(s),this},r.prototype.drawShape=function(t){return this._holeMode?this._geometry.drawHole(t,this._matrix):this._geometry.drawShape(t,this._fillStyle.clone(),this._lineStyle.clone(),this._matrix),this},r.prototype.clear=function(){return this._geometry.clear(),this._lineStyle.reset(),this._fillStyle.reset(),this._boundsID++,this._matrix=null,this._holeMode=!1,this.currentPath=null,this},r.prototype.isFastRect=function(){var e=this._geometry.graphicsData;return!(1!==e.length||e[0].shape.type!==t.SHAPES.RECT||e[0].holes.length||e[0].lineStyle.visible&&e[0].lineStyle.width)},r.prototype._render=function(t){this.finishPoly();var e=this._geometry,r=t.context.supports.uint32Indices;e.updateBatches(r),e.batchable?(this.batchDirty!==e.batchDirty&&this._populateBatches(),this._renderBatched(t)):(t.batch.flush(),this._renderDirect(t))},r.prototype._populateBatches=function(){var t=this._geometry,e=this.blendMode,r=t.batches.length;this.batchTint=-1,this._transformID=-1,this.batchDirty=t.batchDirty,this.batches.length=r,this.vertexData=new Float32Array(t.points);for(var i=0;i<r;i++){var n=t.batches[i],o=n.style.color,s=new Float32Array(this.vertexData.buffer,4*n.attribStart*2,2*n.attribSize),a=new Float32Array(t.uvsFloat32.buffer,4*n.attribStart*2,2*n.attribSize),h={vertexData:s,blendMode:e,indices:new Uint16Array(t.indicesUint16.buffer,2*n.start,n.size),uvs:a,_batchRGB:ce(o),_tintRGB:o,_texture:n.style.texture,alpha:n.style.alpha,worldAlpha:1};this.batches[i]=h}},r.prototype._renderBatched=function(t){if(this.batches.length){t.batch.setObjectRenderer(t.plugins[this.pluginName]),this.calculateVertices(),this.calculateTints();for(var e=0,r=this.batches.length;e<r;e++){var i=this.batches[e];i.worldAlpha=this.worldAlpha*i.alpha,t.plugins[this.pluginName].render(i)}}},r.prototype._renderDirect=function(t){var e=this._resolveDirectShader(t),r=this._geometry,i=this.tint,n=this.worldAlpha,o=e.uniforms,s=r.drawCalls;o.translationMatrix=this.transform.worldTransform,o.tint[0]=(i>>16&255)/255*n,o.tint[1]=(i>>8&255)/255*n,o.tint[2]=(255&i)/255*n,o.tint[3]=n,t.shader.bind(e),t.geometry.bind(r,e),t.state.set(this.state);for(var a=0,h=s.length;a<h;a++)this._renderDrawCallDirect(t,r.drawCalls[a])},r.prototype._renderDrawCallDirect=function(t,e){for(var r=e.texArray,i=e.type,n=e.size,o=e.start,s=r.count,a=0;a<s;a++)t.texture.bind(r.elements[a],a);t.geometry.draw(i,n,o)},r.prototype._resolveDirectShader=function(t){var e=this.shader,r=this.pluginName;if(!e){if(!Gs[r]){for(var i=t.plugins.batch.MAX_TEXTURES,n=new Int32Array(i),o=0;o<i;o++)n[o]=o;var s={tint:new Float32Array([1,1,1,1]),translationMatrix:new Ze,default:vi.from({uSamplers:n},!0)},a=t.plugins[r]._shader.program;Gs[r]=new rn(a,s)}e=Gs[r]}return e},r.prototype._calculateBounds=function(){this.finishPoly();var t=this._geometry;if(t.graphicsData.length){var e=t.bounds,r=e.minX,i=e.minY,n=e.maxX,o=e.maxY;this._bounds.addFrame(this.transform,r,i,n,o)}},r.prototype.containsPoint=function(t){return this.worldTransform.applyInverse(t,r._TEMP_POINT),this._geometry.containsPoint(r._TEMP_POINT)},r.prototype.calculateTints=function(){if(this.batchTint!==this.tint){this.batchTint=this.tint;for(var t=ce(this.tint,Bs),e=0;e<this.batches.length;e++){var r=this.batches[e],i=r._batchRGB,n=(t[0]*i[0]*255<<16)+(t[1]*i[1]*255<<8)+(0|t[2]*i[2]*255);r._tintRGB=(n>>16)+(65280&n)+((255&n)<<16)}}},r.prototype.calculateVertices=function(){var t=this.transform._worldID;if(this._transformID!==t){this._transformID=t;for(var e=this.transform.worldTransform,r=e.a,i=e.b,n=e.c,o=e.d,s=e.tx,a=e.ty,h=this._geometry.points,u=this.vertexData,l=0,c=0;c<h.length;c+=2){var d=h[c],f=h[c+1];u[l++]=r*d+n*f+s,u[l++]=o*f+i*d+a}}},r.prototype.closePath=function(){var t=this.currentPath;return t&&(t.closeStroke=!0,this.finishPoly()),this},r.prototype.setMatrix=function(t){return this._matrix=t,this},r.prototype.beginHole=function(){return this.finishPoly(),this._holeMode=!0,this},r.prototype.endHole=function(){return this.finishPoly(),this._holeMode=!1,this},r.prototype.destroy=function(t){this._geometry.refCount--,0===this._geometry.refCount&&this._geometry.dispose(),this._matrix=null,this.currentPath=null,this._lineStyle.destroy(),this._lineStyle=null,this._fillStyle.destroy(),this._fillStyle=null,this._geometry=null,this.shader=null,this.vertexData=null,this.batches.length=0,this.batches=null,e.prototype.destroy.call(this,t)},r._TEMP_POINT=new qe,r}(dr),ks={buildPoly:_s,buildCircle:ms,buildRectangle:vs,buildRoundedRectangle:gs,buildLine:Rs,ArcUtils:As,BezierUtils:Ss,QuadraticUtils:Os,BatchPart:Is,FILL_COMMANDS:Ps,BATCH_POOL:Ms,DRAW_CALL_POOL:Ds},Hs=function(t,e){return(Hs=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r])})(t,e)},Ys=new qe,js=new Uint16Array([0,1,2,0,2,3]),Vs=function(e){function r(r){var i=e.call(this)||this;return i._anchor=new Ke(i._onAnchorUpdate,i,r?r.defaultAnchor.x:0,r?r.defaultAnchor.y:0),i._texture=null,i._width=0,i._height=0,i._tint=null,i._tintRGB=null,i.tint=16777215,i.blendMode=t.BLEND_MODES.NORMAL,i._cachedTint=16777215,i.uvs=null,i.texture=r||ri.EMPTY,i.vertexData=new Float32Array(8),i.vertexTrimmedData=null,i._transformID=-1,i._textureID=-1,i._transformTrimmedID=-1,i._textureTrimmedID=-1,i.indices=js,i.pluginName="batch",i.isSprite=!0,i._roundPixels=rt.ROUND_PIXELS,i}return function(t,e){function r(){this.constructor=t}Hs(t,e),t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)}(r,e),r.prototype._onTextureUpdate=function(){this._textureID=-1,this._textureTrimmedID=-1,this._cachedTint=16777215,this._width&&(this.scale.x=Se(this.scale.x)*this._width/this._texture.orig.width),this._height&&(this.scale.y=Se(this.scale.y)*this._height/this._texture.orig.height)},r.prototype._onAnchorUpdate=function(){this._transformID=-1,this._transformTrimmedID=-1},r.prototype.calculateVertices=function(){var t=this._texture;if(this._transformID!==this.transform._worldID||this._textureID!==t._updateID){this._textureID!==t._updateID&&(this.uvs=this._texture._uvs.uvsFloat32),this._transformID=this.transform._worldID,this._textureID=t._updateID;var e=this.transform.worldTransform,r=e.a,i=e.b,n=e.c,o=e.d,s=e.tx,a=e.ty,h=this.vertexData,u=t.trim,l=t.orig,c=this._anchor,d=0,f=0,p=0,_=0;if(u?(d=(f=u.x-c._x*l.width)+u.width,p=(_=u.y-c._y*l.height)+u.height):(d=(f=-c._x*l.width)+l.width,p=(_=-c._y*l.height)+l.height),h[0]=r*f+n*_+s,h[1]=o*_+i*f+a,h[2]=r*d+n*_+s,h[3]=o*_+i*d+a,h[4]=r*d+n*p+s,h[5]=o*p+i*d+a,h[6]=r*f+n*p+s,h[7]=o*p+i*f+a,this._roundPixels)for(var m=rt.RESOLUTION,v=0;v<h.length;++v)h[v]=Math.round((h[v]*m|0)/m)}},r.prototype.calculateTrimmedVertices=function(){if(this.vertexTrimmedData){if(this._transformTrimmedID===this.transform._worldID&&this._textureTrimmedID===this._texture._updateID)return}else this.vertexTrimmedData=new Float32Array(8);this._transformTrimmedID=this.transform._worldID,this._textureTrimmedID=this._texture._updateID;var t=this._texture,e=this.vertexTrimmedData,r=t.orig,i=this._anchor,n=this.transform.worldTransform,o=n.a,s=n.b,a=n.c,h=n.d,u=n.tx,l=n.ty,c=-i._x*r.width,d=c+r.width,f=-i._y*r.height,p=f+r.height;e[0]=o*c+a*f+u,e[1]=h*f+s*c+l,e[2]=o*d+a*f+u,e[3]=h*f+s*d+l,e[4]=o*d+a*p+u,e[5]=h*p+s*d+l,e[6]=o*c+a*p+u,e[7]=h*p+s*c+l},r.prototype._render=function(t){this.calculateVertices(),t.batch.setObjectRenderer(t.plugins[this.pluginName]),t.plugins[this.pluginName].render(this)},r.prototype._calculateBounds=function(){var t=this._texture.trim,e=this._texture.orig;!t||t.width===e.width&&t.height===e.height?(this.calculateVertices(),this._bounds.addQuad(this.vertexData)):(this.calculateTrimmedVertices(),this._bounds.addQuad(this.vertexTrimmedData))},r.prototype.getLocalBounds=function(t){return 0===this.children.length?(this._bounds.minX=this._texture.orig.width*-this._anchor._x,this._bounds.minY=this._texture.orig.height*-this._anchor._y,this._bounds.maxX=this._texture.orig.width*(1-this._anchor._x),this._bounds.maxY=this._texture.orig.height*(1-this._anchor._y),t||(this._localBoundsRect||(this._localBoundsRect=new Ye),t=this._localBoundsRect),this._bounds.getRectangle(t)):e.prototype.getLocalBounds.call(this,t)},r.prototype.containsPoint=function(t){this.worldTransform.applyInverse(t,Ys);var e=this._texture.orig.width,r=this._texture.orig.height,i=-e*this.anchor.x,n=0;return Ys.x>=i&&Ys.x<i+e&&(n=-r*this.anchor.y,Ys.y>=n&&Ys.y<n+r)},r.prototype.destroy=function(t){if(e.prototype.destroy.call(this,t),this._texture.off("update",this._onTextureUpdate,this),this._anchor=null,"boolean"==typeof t?t:t&&t.texture){var r="boolean"==typeof t?t:t&&t.baseTexture;this._texture.destroy(!!r)}this._texture=null},r.from=function(t,e){return new r(t instanceof ri?t:ri.from(t,e))},Object.defineProperty(r.prototype,"roundPixels",{get:function(){return this._roundPixels},set:function(t){this._roundPixels!==t&&(this._transformID=-1),this._roundPixels=t},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"width",{get:function(){return Math.abs(this.scale.x)*this._texture.orig.width},set:function(t){var e=Se(this.scale.x)||1;this.scale.x=e*t/this._texture.orig.width,this._width=t},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"height",{get:function(){return Math.abs(this.scale.y)*this._texture.orig.height},set:function(t){var e=Se(this.scale.y)||1;this.scale.y=e*t/this._texture.orig.height,this._height=t},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"anchor",{get:function(){return this._anchor},set:function(t){this._anchor.copyFrom(t)},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"tint",{get:function(){return this._tint},set:function(t){this._tint=t,this._tintRGB=(t>>16)+(65280&t)+((255&t)<<16)},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"texture",{get:function(){return this._texture},set:function(t){this._texture!==t&&(this._texture&&this._texture.off("update",this._onTextureUpdate,this),this._texture=t||ri.EMPTY,this._cachedTint=16777215,this._textureID=-1,this._textureTrimmedID=-1,t&&(t.baseTexture.valid?this._onTextureUpdate():t.once("update",this._onTextureUpdate,this)))},enumerable:!1,configurable:!0}),r}(dr),Ws=function(t,e){return(Ws=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r])})(t,e)};!function(t){t[t.LINEAR_VERTICAL=0]="LINEAR_VERTICAL",t[t.LINEAR_HORIZONTAL=1]="LINEAR_HORIZONTAL"}(t.TEXT_GRADIENT||(t.TEXT_GRADIENT={}));var zs={align:"left",breakWords:!1,dropShadow:!1,dropShadowAlpha:1,dropShadowAngle:Math.PI/6,dropShadowBlur:0,dropShadowColor:"black",dropShadowDistance:5,fill:"black",fillGradientType:t.TEXT_GRADIENT.LINEAR_VERTICAL,fillGradientStops:[],fontFamily:"Arial",fontSize:26,fontStyle:"normal",fontVariant:"normal",fontWeight:"normal",letterSpacing:0,lineHeight:0,lineJoin:"miter",miterLimit:10,padding:0,stroke:"black",strokeThickness:0,textBaseline:"alphabetic",trim:!1,whiteSpace:"pre",wordWrap:!1,wordWrapWidth:100,leading:0},qs=["serif","sans-serif","monospace","cursive","fantasy","system-ui"],Ks=function(){function t(t){this.styleID=0,this.reset(),Js(this,t,t)}return t.prototype.clone=function(){var e={};return Js(e,this,zs),new t(e)},t.prototype.reset=function(){Js(this,zs,zs)},Object.defineProperty(t.prototype,"align",{get:function(){return this._align},set:function(t){this._align!==t&&(this._align=t,this.styleID++)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"breakWords",{get:function(){return this._breakWords},set:function(t){this._breakWords!==t&&(this._breakWords=t,this.styleID++)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"dropShadow",{get:function(){return this._dropShadow},set:function(t){this._dropShadow!==t&&(this._dropShadow=t,this.styleID++)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"dropShadowAlpha",{get:function(){return this._dropShadowAlpha},set:function(t){this._dropShadowAlpha!==t&&(this._dropShadowAlpha=t,this.styleID++)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"dropShadowAngle",{get:function(){return this._dropShadowAngle},set:function(t){this._dropShadowAngle!==t&&(this._dropShadowAngle=t,this.styleID++)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"dropShadowBlur",{get:function(){return this._dropShadowBlur},set:function(t){this._dropShadowBlur!==t&&(this._dropShadowBlur=t,this.styleID++)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"dropShadowColor",{get:function(){return this._dropShadowColor},set:function(t){var e=Qs(t);this._dropShadowColor!==e&&(this._dropShadowColor=e,this.styleID++)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"dropShadowDistance",{get:function(){return this._dropShadowDistance},set:function(t){this._dropShadowDistance!==t&&(this._dropShadowDistance=t,this.styleID++)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"fill",{get:function(){return this._fill},set:function(t){var e=Qs(t);this._fill!==e&&(this._fill=e,this.styleID++)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"fillGradientType",{get:function(){return this._fillGradientType},set:function(t){this._fillGradientType!==t&&(this._fillGradientType=t,this.styleID++)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"fillGradientStops",{get:function(){return this._fillGradientStops},set:function(t){(function(t,e){if(!Array.isArray(t)||!Array.isArray(e))return!1;if(t.length!==e.length)return!1;for(var r=0;r<t.length;++r)if(t[r]!==e[r])return!1;return!0})(this._fillGradientStops,t)||(this._fillGradientStops=t,this.styleID++)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"fontFamily",{get:function(){return this._fontFamily},set:function(t){this.fontFamily!==t&&(this._fontFamily=t,this.styleID++)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"fontSize",{get:function(){return this._fontSize},set:function(t){this._fontSize!==t&&(this._fontSize=t,this.styleID++)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"fontStyle",{get:function(){return this._fontStyle},set:function(t){this._fontStyle!==t&&(this._fontStyle=t,this.styleID++)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"fontVariant",{get:function(){return this._fontVariant},set:function(t){this._fontVariant!==t&&(this._fontVariant=t,this.styleID++)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"fontWeight",{get:function(){return this._fontWeight},set:function(t){this._fontWeight!==t&&(this._fontWeight=t,this.styleID++)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"letterSpacing",{get:function(){return this._letterSpacing},set:function(t){this._letterSpacing!==t&&(this._letterSpacing=t,this.styleID++)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"lineHeight",{get:function(){return this._lineHeight},set:function(t){this._lineHeight!==t&&(this._lineHeight=t,this.styleID++)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"leading",{get:function(){return this._leading},set:function(t){this._leading!==t&&(this._leading=t,this.styleID++)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"lineJoin",{get:function(){return this._lineJoin},set:function(t){this._lineJoin!==t&&(this._lineJoin=t,this.styleID++)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"miterLimit",{get:function(){return this._miterLimit},set:function(t){this._miterLimit!==t&&(this._miterLimit=t,this.styleID++)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"padding",{get:function(){return this._padding},set:function(t){this._padding!==t&&(this._padding=t,this.styleID++)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"stroke",{get:function(){return this._stroke},set:function(t){var e=Qs(t);this._stroke!==e&&(this._stroke=e,this.styleID++)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"strokeThickness",{get:function(){return this._strokeThickness},set:function(t){this._strokeThickness!==t&&(this._strokeThickness=t,this.styleID++)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"textBaseline",{get:function(){return this._textBaseline},set:function(t){this._textBaseline!==t&&(this._textBaseline=t,this.styleID++)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"trim",{get:function(){return this._trim},set:function(t){this._trim!==t&&(this._trim=t,this.styleID++)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"whiteSpace",{get:function(){return this._whiteSpace},set:function(t){this._whiteSpace!==t&&(this._whiteSpace=t,this.styleID++)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"wordWrap",{get:function(){return this._wordWrap},set:function(t){this._wordWrap!==t&&(this._wordWrap=t,this.styleID++)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"wordWrapWidth",{get:function(){return this._wordWrapWidth},set:function(t){this._wordWrapWidth!==t&&(this._wordWrapWidth=t,this.styleID++)},enumerable:!1,configurable:!0}),t.prototype.toFontString=function(){var t="number"==typeof this.fontSize?this.fontSize+"px":this.fontSize,e=this.fontFamily;Array.isArray(this.fontFamily)||(e=this.fontFamily.split(","));for(var r=e.length-1;r>=0;r--){var i=e[r].trim();!/([\"\'])[^\'\"]+\1/.test(i)&&qs.indexOf(i)<0&&(i='"'+i+'"'),e[r]=i}return this.fontStyle+" "+this.fontVariant+" "+this.fontWeight+" "+t+" "+e.join(",")},t}();function Zs(t){return"number"==typeof t?de(t):("string"==typeof t&&0===t.indexOf("0x")&&(t=t.replace("0x","#")),t)}function Qs(t){if(Array.isArray(t)){for(var e=0;e<t.length;++e)t[e]=Zs(t[e]);return t}return Zs(t)}function Js(t,e,r){for(var i in r)Array.isArray(e[i])?t[i]=e[i].slice():t[i]=e[i]}var $s=function(){function t(t,e,r,i,n,o,s,a,h){this.text=t,this.style=e,this.width=r,this.height=i,this.lines=n,this.lineWidths=o,this.lineHeight=s,this.maxLineWidth=a,this.fontProperties=h}return t.measureText=function(e,r,i,n){void 0===n&&(n=t._canvas),i=null==i?r.wordWrap:i;var o=r.toFontString(),s=t.measureFont(o);0===s.fontSize&&(s.fontSize=r.fontSize,s.ascent=r.fontSize);var a=n.getContext("2d");a.font=o;for(var h=(i?t.wordWrap(e,r,n):e).split(/(?:\r\n|\r|\n)/),u=new Array(h.length),l=0,c=0;c<h.length;c++){var d=a.measureText(h[c]).width+(h[c].length-1)*r.letterSpacing;u[c]=d,l=Math.max(l,d)}var f=l+r.strokeThickness;r.dropShadow&&(f+=r.dropShadowDistance);var p=r.lineHeight||s.fontSize+r.strokeThickness,_=Math.max(p,s.fontSize+r.strokeThickness)+(h.length-1)*(p+r.leading);return r.dropShadow&&(_+=r.dropShadowDistance),new t(e,r,f,_,h,u,p+r.leading,l,s)},t.wordWrap=function(e,r,i){void 0===i&&(i=t._canvas);for(var n=i.getContext("2d"),o=0,s="",a="",h=Object.create(null),u=r.letterSpacing,l=r.whiteSpace,c=t.collapseSpaces(l),d=t.collapseNewlines(l),f=!c,p=r.wordWrapWidth+u,_=t.tokenize(e),m=0;m<_.length;m++){var v=_[m];if(t.isNewline(v)){if(!d){a+=t.addLine(s),f=!c,s="",o=0;continue}v=" "}if(c){var y=t.isBreakingSpace(v),E=t.isBreakingSpace(s[s.length-1]);if(y&&E)continue}var g=t.getFromCache(v,u,h,n);if(g>p)if(""!==s&&(a+=t.addLine(s),s="",o=0),t.canBreakWords(v,r.breakWords))for(var T=t.wordWrapSplit(v),b=0;b<T.length;b++){for(var R=T[b],x=1;T[b+x];){var A=T[b+x],S=R[R.length-1];if(t.canBreakChars(S,A,v,b,r.breakWords))break;R+=A,x++}b+=R.length-1;var O=t.getFromCache(R,u,h,n);O+o>p&&(a+=t.addLine(s),f=!1,s="",o=0),s+=R,o+=O}else{s.length>0&&(a+=t.addLine(s),s="",o=0);var I=m===_.length-1;a+=t.addLine(v,!I),f=!1,s="",o=0}else g+o>p&&(f=!1,a+=t.addLine(s),s="",o=0),(s.length>0||!t.isBreakingSpace(v)||f)&&(s+=v,o+=g)}return a+t.addLine(s,!1)},t.addLine=function(e,r){return void 0===r&&(r=!0),e=t.trimRight(e),r?e+"\n":e},t.getFromCache=function(t,e,r,i){var n=r[t];if("number"!=typeof n){var o=t.length*e;n=i.measureText(t).width+o,r[t]=n}return n},t.collapseSpaces=function(t){return"normal"===t||"pre-line"===t},t.collapseNewlines=function(t){return"normal"===t},t.trimRight=function(e){if("string"!=typeof e)return"";for(var r=e.length-1;r>=0;r--){var i=e[r];if(!t.isBreakingSpace(i))break;e=e.slice(0,-1)}return e},t.isNewline=function(e){return"string"==typeof e&&t._newlines.indexOf(e.charCodeAt(0))>=0},t.isBreakingSpace=function(e,r){return"string"==typeof e&&t._breakingSpaces.indexOf(e.charCodeAt(0))>=0},t.tokenize=function(e){var r=[],i="";if("string"!=typeof e)return r;for(var n=0;n<e.length;n++){var o=e[n],s=e[n+1];t.isBreakingSpace(o,s)||t.isNewline(o)?(""!==i&&(r.push(i),i=""),r.push(o)):i+=o}return""!==i&&r.push(i),r},t.canBreakWords=function(t,e){return e},t.canBreakChars=function(t,e,r,i,n){return!0},t.wordWrapSplit=function(t){return t.split("")},t.measureFont=function(e){if(t._fonts[e])return t._fonts[e];var r={ascent:0,descent:0,fontSize:0},i=t._canvas,n=t._context;n.font=e;var o=t.METRICS_STRING+t.BASELINE_SYMBOL,s=Math.ceil(n.measureText(o).width),a=Math.ceil(n.measureText(t.BASELINE_SYMBOL).width),h=Math.ceil(t.HEIGHT_MULTIPLIER*a);a=a*t.BASELINE_MULTIPLIER|0,i.width=s,i.height=h,n.fillStyle="#f00",n.fillRect(0,0,s,h),n.font=e,n.textBaseline="alphabetic",n.fillStyle="#000",n.fillText(o,0,a);var u=n.getImageData(0,0,s,h).data,l=u.length,c=4*s,d=0,f=0,p=!1;for(d=0;d<a;++d){for(var _=0;_<c;_+=4)if(255!==u[f+_]){p=!0;break}if(p)break;f+=c}for(r.ascent=a-d,f=l-c,p=!1,d=h;d>a;--d){for(_=0;_<c;_+=4)if(255!==u[f+_]){p=!0;break}if(p)break;f-=c}return r.descent=d-a,r.fontSize=r.ascent+r.descent,t._fonts[e]=r,r},t.clearMetrics=function(e){void 0===e&&(e=""),e?delete t._fonts[e]:t._fonts={}},t}(),ta=function(){try{var t=new OffscreenCanvas(0,0),e=t.getContext("2d");return e&&e.measureText?t:document.createElement("canvas")}catch(t){return document.createElement("canvas")}}();ta.width=ta.height=10,$s._canvas=ta,$s._context=ta.getContext("2d"),$s._fonts={},$s.METRICS_STRING="|q",$s.BASELINE_SYMBOL="M",$s.BASELINE_MULTIPLIER=1.4,$s.HEIGHT_MULTIPLIER=2,$s._newlines=[10,13],$s._breakingSpaces=[9,32,8192,8193,8194,8195,8196,8197,8198,8200,8201,8202,8287,12288];var ea={texture:!0,children:!1,baseTexture:!0},ra=function(e){function r(t,r,i){var n=this,o=!1;i||(i=document.createElement("canvas"),o=!0),i.width=3,i.height=3;var s=ri.from(i);return s.orig=new Ye,s.trim=new Ye,(n=e.call(this,s)||this)._ownCanvas=o,n.canvas=i,n.context=n.canvas.getContext("2d"),n._resolution=rt.RESOLUTION,n._autoResolution=!0,n._text=null,n._style=null,n._styleListener=null,n._font="",n.text=t,n.style=r,n.localStyleID=-1,n}return function(t,e){function r(){this.constructor=t}Ws(t,e),t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)}(r,e),r.prototype.updateText=function(t){var e=this._style;if(this.localStyleID!==e.styleID&&(this.dirty=!0,this.localStyleID=e.styleID),this.dirty||!t){this._font=this._style.toFontString();var i,n,o=this.context,s=$s.measureText(this._text||" ",this._style,this._style.wordWrap,this.canvas),a=s.width,h=s.height,u=s.lines,l=s.lineHeight,c=s.lineWidths,d=s.maxLineWidth,f=s.fontProperties;this.canvas.width=Math.ceil(Math.ceil(Math.max(1,a)+2*e.padding)*this._resolution),this.canvas.height=Math.ceil(Math.ceil(Math.max(1,h)+2*e.padding)*this._resolution),o.scale(this._resolution,this._resolution),o.clearRect(0,0,this.canvas.width,this.canvas.height),o.font=this._font,o.lineWidth=e.strokeThickness,o.textBaseline=e.textBaseline,o.lineJoin=e.lineJoin,o.miterLimit=e.miterLimit;for(var p=e.dropShadow?2:1,_=0;_<p;++_){var m=e.dropShadow&&0===_,v=m?Math.ceil(Math.max(1,h)+2*e.padding):0,y=v*this._resolution;if(m){o.fillStyle="black",o.strokeStyle="black";var E=e.dropShadowColor,g=ce("number"==typeof E?E:fe(E));o.shadowColor="rgba("+255*g[0]+","+255*g[1]+","+255*g[2]+","+e.dropShadowAlpha+")",o.shadowBlur=e.dropShadowBlur,o.shadowOffsetX=Math.cos(e.dropShadowAngle)*e.dropShadowDistance,o.shadowOffsetY=Math.sin(e.dropShadowAngle)*e.dropShadowDistance+y}else o.fillStyle=this._generateFillStyle(e,u,s),o.strokeStyle=e.stroke,o.shadowColor="black",o.shadowBlur=0,o.shadowOffsetX=0,o.shadowOffsetY=0;var T=(l-f.fontSize)/2;(!r.nextLineHeightBehavior||l-f.fontSize<0)&&(T=0);for(var b=0;b<u.length;b++)i=e.strokeThickness/2,n=e.strokeThickness/2+b*l+f.ascent+T,"right"===e.align?i+=d-c[b]:"center"===e.align&&(i+=(d-c[b])/2),e.stroke&&e.strokeThickness&&this.drawLetterSpacing(u[b],i+e.padding,n+e.padding-v,!0),e.fill&&this.drawLetterSpacing(u[b],i+e.padding,n+e.padding-v)}this.updateTexture()}},r.prototype.drawLetterSpacing=function(t,e,r,i){void 0===i&&(i=!1);var n=this._style.letterSpacing;if(0!==n)for(var o=e,s=Array.from?Array.from(t):t.split(""),a=this.context.measureText(t).width,h=0,u=0;u<s.length;++u){var l=s[u];i?this.context.strokeText(l,o,r):this.context.fillText(l,o,r),o+=a-(h=this.context.measureText(t.substring(u+1)).width)+n,a=h}else i?this.context.strokeText(t,e,r):this.context.fillText(t,e,r)},r.prototype.updateTexture=function(){var t=this.canvas;if(this._style.trim){var e=Ce(t);e.data&&(t.width=e.width,t.height=e.height,this.context.putImageData(e.data,0,0))}var r=this._texture,i=this._style,n=i.trim?0:i.padding,o=r.baseTexture;r.trim.width=r._frame.width=t.width/this._resolution,r.trim.height=r._frame.height=t.height/this._resolution,r.trim.x=-n,r.trim.y=-n,r.orig.width=r._frame.width-2*n,r.orig.height=r._frame.height-2*n,this._onTextureUpdate(),o.setRealSize(t.width,t.height,this._resolution),r.updateUvs(),this._recursivePostUpdateTransform(),this.dirty=!1},r.prototype._render=function(t){this._autoResolution&&this._resolution!==t.resolution&&(this._resolution=t.resolution,this.dirty=!0),this.updateText(!0),e.prototype._render.call(this,t)},r.prototype.getLocalBounds=function(t){return this.updateText(!0),e.prototype.getLocalBounds.call(this,t)},r.prototype._calculateBounds=function(){this.updateText(!0),this.calculateVertices(),this._bounds.addQuad(this.vertexData)},r.prototype._generateFillStyle=function(e,r,i){var n,o=e.fill;if(!Array.isArray(o))return o;if(1===o.length)return o[0];var s=e.dropShadow?e.dropShadowDistance:0,a=e.padding||0,h=this.canvas.width/this._resolution-s-2*a,u=this.canvas.height/this._resolution-s-2*a,l=o.slice(),c=e.fillGradientStops.slice();if(!c.length)for(var d=l.length+1,f=1;f<d;++f)c.push(f/d);if(l.unshift(o[0]),c.unshift(0),l.push(o[o.length-1]),c.push(1),e.fillGradientType===t.TEXT_GRADIENT.LINEAR_VERTICAL){n=this.context.createLinearGradient(h/2,a,h/2,u+a);var p=i.fontProperties.fontSize+e.strokeThickness;for(f=0;f<r.length;f++){var _=i.lineHeight*(f-1)+p,m=i.lineHeight*f,v=m;f>0&&_>m&&(v=(m+_)/2);var y=m+p,E=i.lineHeight*(f+1),g=y;f+1<r.length&&E<y&&(g=(y+E)/2);for(var T=(g-v)/u,b=0;b<l.length;b++){var R;R="number"==typeof c[b]?c[b]:b/l.length;var x=Math.min(1,Math.max(0,v/u+R*T));x=Number(x.toFixed(5)),n.addColorStop(x,l[b])}}}else{n=this.context.createLinearGradient(a,u/2,h+a,u/2);var A=l.length+1,S=1;for(f=0;f<l.length;f++){var O;O="number"==typeof c[f]?c[f]:S/A,n.addColorStop(O,l[f]),S++}}return n},r.prototype.destroy=function(t){"boolean"==typeof t&&(t={children:t}),t=Object.assign({},ea,t),e.prototype.destroy.call(this,t),this._ownCanvas&&(this.canvas.height=this.canvas.width=0),this.context=null,this.canvas=null,this._style=null},Object.defineProperty(r.prototype,"width",{get:function(){return this.updateText(!0),Math.abs(this.scale.x)*this._texture.orig.width},set:function(t){this.updateText(!0);var e=Se(this.scale.x)||1;this.scale.x=e*t/this._texture.orig.width,this._width=t},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"height",{get:function(){return this.updateText(!0),Math.abs(this.scale.y)*this._texture.orig.height},set:function(t){this.updateText(!0);var e=Se(this.scale.y)||1;this.scale.y=e*t/this._texture.orig.height,this._height=t},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"style",{get:function(){return this._style},set:function(t){t=t||{},this._style=t instanceof Ks?t:new Ks(t),this.localStyleID=-1,this.dirty=!0},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"text",{get:function(){return this._text},set:function(t){t=String(null==t?"":t),this._text!==t&&(this._text=t,this.dirty=!0)},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"resolution",{get:function(){return this._resolution},set:function(t){this._autoResolution=!1,this._resolution!==t&&(this._resolution=t,this.dirty=!0)},enumerable:!1,configurable:!0}),r.nextLineHeightBehavior=!1,r}(Vs);rt.UPLOADS_PER_FRAME=4;var ia=function(t,e){return(ia=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r])})(t,e)},na=function(){function t(t){this.maxItemsPerFrame=t,this.itemsLeft=0}return t.prototype.beginFrame=function(){this.itemsLeft=this.maxItemsPerFrame},t.prototype.allowedToUpload=function(){return this.itemsLeft-- >0},t}();function oa(t,e){var r=!1;if(t&&t._textures&&t._textures.length)for(var i=0;i<t._textures.length;i++)if(t._textures[i]instanceof ri){var n=t._textures[i].baseTexture;-1===e.indexOf(n)&&(e.push(n),r=!0)}return r}function sa(t,e){if(t.baseTexture instanceof Xr){var r=t.baseTexture;return-1===e.indexOf(r)&&e.push(r),!0}return!1}function aa(t,e){if(t._texture&&t._texture instanceof ri){var r=t._texture.baseTexture;return-1===e.indexOf(r)&&e.push(r),!0}return!1}function ha(t,e){return e instanceof ra&&(e.updateText(!0),!0)}function ua(t,e){if(e instanceof Ks){var r=e.toFontString();return $s.measureFont(r),!0}return!1}function la(t,e){if(t instanceof ra){-1===e.indexOf(t.style)&&e.push(t.style),-1===e.indexOf(t)&&e.push(t);var r=t._texture.baseTexture;return-1===e.indexOf(r)&&e.push(r),!0}return!1}function ca(t,e){return t instanceof Ks&&(-1===e.indexOf(t)&&e.push(t),!0)}var da=function(){function e(t){var e=this;this.limiter=new na(rt.UPLOADS_PER_FRAME),this.renderer=t,this.uploadHookHelper=null,this.queue=[],this.addHooks=[],this.uploadHooks=[],this.completes=[],this.ticking=!1,this.delayedTick=function(){e.queue&&e.prepareItems()},this.registerFindHook(la),this.registerFindHook(ca),this.registerFindHook(oa),this.registerFindHook(sa),this.registerFindHook(aa),this.registerUploadHook(ha),this.registerUploadHook(ua)}return e.prototype.upload=function(e,r){"function"==typeof e&&(r=e,e=null),e&&this.add(e),this.queue.length?(r&&this.completes.push(r),this.ticking||(this.ticking=!0,gr.system.addOnce(this.tick,this,t.UPDATE_PRIORITY.UTILITY))):r&&r()},e.prototype.tick=function(){setTimeout(this.delayedTick,0)},e.prototype.prepareItems=function(){for(this.limiter.beginFrame();this.queue.length&&this.limiter.allowedToUpload();){var e=this.queue[0],r=!1;if(e&&!e._destroyed)for(var i=0,n=this.uploadHooks.length;i<n;i++)if(this.uploadHooks[i](this.uploadHookHelper,e)){this.queue.shift(),r=!0;break}r||this.queue.shift()}if(this.queue.length)gr.system.addOnce(this.tick,this,t.UPDATE_PRIORITY.UTILITY);else{this.ticking=!1;var o=this.completes.slice(0);for(this.completes.length=0,i=0,n=o.length;i<n;i++)o[i]()}},e.prototype.registerFindHook=function(t){return t&&this.addHooks.push(t),this},e.prototype.registerUploadHook=function(t){return t&&this.uploadHooks.push(t),this},e.prototype.add=function(t){for(var e=0,r=this.addHooks.length;e<r&&!this.addHooks[e](t,this.queue);e++);if(t instanceof dr)for(e=t.children.length-1;e>=0;e--)this.add(t.children[e]);return this},e.prototype.destroy=function(){this.ticking&&gr.system.remove(this.tick,this),this.ticking=!1,this.addHooks=null,this.uploadHooks=null,this.renderer=null,this.completes=null,this.queue=null,this.limiter=null,this.uploadHookHelper=null},e}();function fa(t,e){return e instanceof Xr&&(e._glTextures[t.CONTEXT_UID]||t.texture.bind(e),!0)}function pa(t,e){if(!(e instanceof Xs))return!1;var r=e.geometry;e.finishPoly(),r.updateBatches();for(var i=r.batches,n=0;n<i.length;n++){var o=i[n].style.texture;o&&fa(t,o.baseTexture)}return r.batchable||t.geometry.bind(r,e._resolveDirectShader(t)),!0}function _a(t,e){return t instanceof Xs&&(e.push(t),!0)}var ma=function(t){function e(e){var r=t.call(this,e)||this;return r.uploadHookHelper=r.renderer,r.registerFindHook(_a),r.registerUploadHook(fa),r.registerUploadHook(pa),r}return function(t,e){function r(){this.constructor=t}ia(t,e),t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)}(e,t),e}(da),va=function(){function t(t){this.maxMilliseconds=t,this.frameStart=0}return t.prototype.beginFrame=function(){this.frameStart=Date.now()},t.prototype.allowedToUpload=function(){return Date.now()-this.frameStart<this.maxMilliseconds},t}(),ya=function(){function t(t,e,r){void 0===r&&(r=null),this._texture=t instanceof ri?t:null,this.baseTexture=t instanceof Xr?t:this._texture.baseTexture,this.textures={},this.animations={},this.data=e;var i=this.baseTexture.resource;this.resolution=this._updateResolution(r||(i?i.url:null)),this._frames=this.data.frames,this._frameKeys=Object.keys(this._frames),this._batchIndex=0,this._callback=null}return t.prototype._updateResolution=function(t){void 0===t&&(t=null);var e=this.data.meta.scale,r=Be(t,null);return null===r&&(r=void 0!==e?parseFloat(e):1),1!==r&&this.baseTexture.setResolution(r),r},t.prototype.parse=function(e){this._batchIndex=0,this._callback=e,this._frameKeys.length<=t.BATCH_SIZE?(this._processFrames(0),this._processAnimations(),this._parseComplete()):this._nextBatch()},t.prototype._processFrames=function(e){for(var r=e,i=t.BATCH_SIZE;r-e<i&&r<this._frameKeys.length;){var n=this._frameKeys[r],o=this._frames[n],s=o.frame;if(s){var a,h=null,u=!1!==o.trimmed&&o.sourceSize?o.sourceSize:o.frame,l=new Ye(0,0,Math.floor(u.w)/this.resolution,Math.floor(u.h)/this.resolution);a=o.rotated?new Ye(Math.floor(s.x)/this.resolution,Math.floor(s.y)/this.resolution,Math.floor(s.h)/this.resolution,Math.floor(s.w)/this.resolution):new Ye(Math.floor(s.x)/this.resolution,Math.floor(s.y)/this.resolution,Math.floor(s.w)/this.resolution,Math.floor(s.h)/this.resolution),!1!==o.trimmed&&o.spriteSourceSize&&(h=new Ye(Math.floor(o.spriteSourceSize.x)/this.resolution,Math.floor(o.spriteSourceSize.y)/this.resolution,Math.floor(s.w)/this.resolution,Math.floor(s.h)/this.resolution)),this.textures[n]=new ri(this.baseTexture,a,l,h,o.rotated?2:0,o.anchor),ri.addToCache(this.textures[n],n)}r++}},t.prototype._processAnimations=function(){var t=this.data.animations||{};for(var e in t){this.animations[e]=[];for(var r=0;r<t[e].length;r++){var i=t[e][r];this.animations[e].push(this.textures[i])}}},t.prototype._parseComplete=function(){var t=this._callback;this._callback=null,this._batchIndex=0,t.call(this,this.textures)},t.prototype._nextBatch=function(){var e=this;this._processFrames(this._batchIndex*t.BATCH_SIZE),this._batchIndex++,setTimeout(function(){e._batchIndex*t.BATCH_SIZE<e._frameKeys.length?e._nextBatch():(e._processAnimations(),e._parseComplete())},0)},t.prototype.destroy=function(t){var e;for(var r in void 0===t&&(t=!1),this.textures)this.textures[r].destroy();this._frames=null,this._frameKeys=null,this.data=null,this.textures=null,t&&(null===(e=this._texture)||void 0===e||e.destroy(),this.baseTexture.destroy()),this._texture=null,this.baseTexture=null},t.BATCH_SIZE=1e3,t}(),Ea=function(){function e(){}return e.use=function(r,i){var n,o,s=this,a=r.name+"_image";if(r.data&&r.type===t.LoaderResource.TYPE.JSON&&r.data.frames&&!s.resources[a]){var h=null===(o=null===(n=r.data)||void 0===n?void 0:n.meta)||void 0===o?void 0:o.related_multi_packs;if(Array.isArray(h))for(var u=function(e){if("string"!=typeof e)return"continue";var i=e.replace(".json",""),n=ne.resolve(r.url.replace(s.baseUrl,""),e);if(s.resources[i]||Object.values(s.resources).some(function(t){return ne.format(ne.parse(t.url))===n}))return"continue";var o={crossOrigin:r.crossOrigin,loadType:t.LoaderResource.LOAD_TYPE.XHR,xhrType:t.LoaderResource.XHR_RESPONSE_TYPE.JSON,parentResource:r,metadata:r.metadata};s.add(i,n,o)},l=0,c=h;l<c.length;l++)u(c[l]);var d={crossOrigin:r.crossOrigin,metadata:r.metadata.imageMetadata,parentResource:r},f=e.getResourcePath(r,s.baseUrl);s.add(a,f,d,function(t){if(t.error)i(t.error);else{var e=new ya(t.texture,r.data,r.url);e.parse(function(){r.spritesheet=e,r.textures=e.textures,i()})}})}else i()},e.getResourcePath=function(t,e){return t.isDataUrl?t.data.meta.image:ne.resolve(t.url.replace(e,""),t.data.meta.image)},e}(),ga=function(t,e){return(ga=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r])})(t,e)};function Ta(t,e){function r(){this.constructor=t}ga(t,e),t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)}var ba=new qe,Ra=function(t){function e(e,r,i){void 0===r&&(r=100),void 0===i&&(i=100);var n=t.call(this,e)||this;return n.tileTransform=new or,n._width=r,n._height=i,n.uvMatrix=n.texture.uvMatrix||new un(e),n.pluginName="tilingSprite",n.uvRespectAnchor=!1,n}return Ta(e,t),Object.defineProperty(e.prototype,"clampMargin",{get:function(){return this.uvMatrix.clampMargin},set:function(t){this.uvMatrix.clampMargin=t,this.uvMatrix.update(!0)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"tileScale",{get:function(){return this.tileTransform.scale},set:function(t){this.tileTransform.scale.copyFrom(t)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"tilePosition",{get:function(){return this.tileTransform.position},set:function(t){this.tileTransform.position.copyFrom(t)},enumerable:!1,configurable:!0}),e.prototype._onTextureUpdate=function(){this.uvMatrix&&(this.uvMatrix.texture=this._texture),this._cachedTint=16777215},e.prototype._render=function(t){var e=this._texture;e&&e.valid&&(this.tileTransform.updateLocalTransform(),this.uvMatrix.update(),t.batch.setObjectRenderer(t.plugins[this.pluginName]),t.plugins[this.pluginName].render(this))},e.prototype._calculateBounds=function(){var t=this._width*-this._anchor._x,e=this._height*-this._anchor._y,r=this._width*(1-this._anchor._x),i=this._height*(1-this._anchor._y);this._bounds.addFrame(this.transform,t,e,r,i)},e.prototype.getLocalBounds=function(e){return 0===this.children.length?(this._bounds.minX=this._width*-this._anchor._x,this._bounds.minY=this._height*-this._anchor._y,this._bounds.maxX=this._width*(1-this._anchor._x),this._bounds.maxY=this._height*(1-this._anchor._y),e||(this._localBoundsRect||(this._localBoundsRect=new Ye),e=this._localBoundsRect),this._bounds.getRectangle(e)):t.prototype.getLocalBounds.call(this,e)},e.prototype.containsPoint=function(t){this.worldTransform.applyInverse(t,ba);var e=this._width,r=this._height,i=-e*this.anchor._x;if(ba.x>=i&&ba.x<i+e){var n=-r*this.anchor._y;if(ba.y>=n&&ba.y<n+r)return!0}return!1},e.prototype.destroy=function(e){t.prototype.destroy.call(this,e),this.tileTransform=null,this.uvMatrix=null},e.from=function(t,r){return new e(t instanceof ri?t:ri.from(t,r),r.width,r.height)},Object.defineProperty(e.prototype,"width",{get:function(){return this._width},set:function(t){this._width=t},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"height",{get:function(){return this._height},set:function(t){this._height=t},enumerable:!1,configurable:!0}),e}(Vs),xa="attribute vec2 aVertexPosition;\nattribute vec2 aTextureCoord;\n\nuniform mat3 projectionMatrix;\nuniform mat3 translationMatrix;\nuniform mat3 uTransform;\n\nvarying vec2 vTextureCoord;\n\nvoid main(void)\n{\n    gl_Position = vec4((projectionMatrix * translationMatrix * vec3(aVertexPosition, 1.0)).xy, 0.0, 1.0);\n\n    vTextureCoord = (uTransform * vec3(aTextureCoord, 1.0)).xy;\n}\n",Aa="varying vec2 vTextureCoord;\n\nuniform sampler2D uSampler;\nuniform vec4 uColor;\nuniform mat3 uMapCoord;\nuniform vec4 uClampFrame;\nuniform vec2 uClampOffset;\n\nvoid main(void)\n{\n    vec2 coord = vTextureCoord + ceil(uClampOffset - vTextureCoord);\n    coord = (uMapCoord * vec3(coord, 1.0)).xy;\n    coord = clamp(coord, uClampFrame.xy, uClampFrame.zw);\n\n    vec4 texSample = texture2D(uSampler, coord);\n    gl_FragColor = texSample * uColor;\n}\n",Sa="varying vec2 vTextureCoord;\n\nuniform sampler2D uSampler;\nuniform vec4 uColor;\n\nvoid main(void)\n{\n    vec4 sample = texture2D(uSampler, vTextureCoord);\n    gl_FragColor = sample * uColor;\n}\n",Oa=new Ze,Ia=function(e){function r(t){var r=e.call(this,t)||this,i={globals:r.renderer.globalUniforms};return r.shader=rn.from(xa,Aa,i),r.simpleShader=rn.from(xa,Sa,i),r.quad=new _i,r.state=nn.for2d(),r}return Ta(r,e),r.prototype.render=function(e){var r=this.renderer,i=this.quad,n=i.vertices;n[0]=n[6]=e._width*-e.anchor.x,n[1]=n[3]=e._height*-e.anchor.y,n[2]=n[4]=e._width*(1-e.anchor.x),n[5]=n[7]=e._height*(1-e.anchor.y);var o=e.uvRespectAnchor?e.anchor.x:0,s=e.uvRespectAnchor?e.anchor.y:0;(n=i.uvs)[0]=n[6]=-o,n[1]=n[3]=-s,n[2]=n[4]=1-o,n[5]=n[7]=1-s,i.invalidate();var a=e._texture,h=a.baseTexture,u=e.tileTransform.localTransform,l=e.uvMatrix,c=h.isPowerOfTwo&&a.frame.width===h.width&&a.frame.height===h.height;c&&(h._glTextures[r.CONTEXT_UID]?c=h.wrapMode!==t.WRAP_MODES.CLAMP:h.wrapMode===t.WRAP_MODES.CLAMP&&(h.wrapMode=t.WRAP_MODES.REPEAT));var d=c?this.simpleShader:this.shader,f=a.width,p=a.height,_=e._width,m=e._height;Oa.set(u.a*f/_,u.b*f/m,u.c*p/_,u.d*p/m,u.tx/_,u.ty/m),Oa.invert(),c?Oa.prepend(l.mapCoord):(d.uniforms.uMapCoord=l.mapCoord.toArray(!0),d.uniforms.uClampFrame=l.uClampFrame,d.uniforms.uClampOffset=l.uClampOffset),d.uniforms.uTransform=Oa.toArray(!0),d.uniforms.uColor=ye(e.tint,e.worldAlpha,d.uniforms.uColor,h.alphaMode),d.uniforms.translationMatrix=e.transform.worldTransform.toArray(!0),d.uniforms.uSampler=a,r.shader.bind(d),r.geometry.bind(i),this.state.blendMode=_e(e.blendMode,h.alphaMode),r.state.set(this.state),r.geometry.draw(this.renderer.gl.TRIANGLES,6,0)},r}(bi),Pa=function(t,e){return(Pa=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r])})(t,e)};function Ma(t,e){function r(){this.constructor=t}Pa(t,e),t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)}var Da=function(){function t(t,e){this.uvBuffer=t,this.uvMatrix=e,this.data=null,this._bufferUpdateId=-1,this._textureUpdateId=-1,this._updateID=0}return t.prototype.update=function(t){if(t||this._bufferUpdateId!==this.uvBuffer._updateID||this._textureUpdateId!==this.uvMatrix._updateID){this._bufferUpdateId=this.uvBuffer._updateID,this._textureUpdateId=this.uvMatrix._updateID;var e=this.uvBuffer.data;this.data&&this.data.length===e.length||(this.data=new Float32Array(e.length)),this.uvMatrix.multiplyUvs(e,this.data),this._updateID++}},t}(),Na=new qe,wa=new We,Ca=function(e){function r(r,i,n,o){void 0===o&&(o=t.DRAW_MODES.TRIANGLES);var s=e.call(this)||this;return s.geometry=r,r.refCount++,s.shader=i,s.state=n||nn.for2d(),s.drawMode=o,s.start=0,s.size=0,s.uvs=null,s.indices=null,s.vertexData=new Float32Array(1),s.vertexDirty=-1,s._transformID=-1,s._roundPixels=rt.ROUND_PIXELS,s.batchUvs=null,s}return Ma(r,e),Object.defineProperty(r.prototype,"uvBuffer",{get:function(){return this.geometry.buffers[1]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"verticesBuffer",{get:function(){return this.geometry.buffers[0]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"material",{get:function(){return this.shader},set:function(t){this.shader=t},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"blendMode",{get:function(){return this.state.blendMode},set:function(t){this.state.blendMode=t},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"roundPixels",{get:function(){return this._roundPixels},set:function(t){this._roundPixels!==t&&(this._transformID=-1),this._roundPixels=t},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"tint",{get:function(){return"tint"in this.shader?this.shader.tint:null},set:function(t){this.shader.tint=t},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"texture",{get:function(){return"texture"in this.shader?this.shader.texture:null},set:function(t){this.shader.texture=t},enumerable:!1,configurable:!0}),r.prototype._render=function(e){var i=this.geometry.buffers[0].data;this.shader.batchable&&this.drawMode===t.DRAW_MODES.TRIANGLES&&i.length<2*r.BATCHABLE_SIZE?this._renderToBatch(e):this._renderDefault(e)},r.prototype._renderDefault=function(t){var e=this.shader;e.alpha=this.worldAlpha,e.update&&e.update(),t.batch.flush(),e.uniforms.translationMatrix=this.transform.worldTransform.toArray(!0),t.shader.bind(e),t.state.set(this.state),t.geometry.bind(this.geometry,e),t.geometry.draw(this.drawMode,this.size,this.start,this.geometry.instanceCount)},r.prototype._renderToBatch=function(t){var e=this.geometry,r=this.shader;r.uvMatrix&&(r.uvMatrix.update(),this.calculateUvs()),this.calculateVertices(),this.indices=e.indexBuffer.data,this._tintRGB=r._tintRGB,this._texture=r.texture;var i=this.material.pluginName;t.batch.setObjectRenderer(t.plugins[i]),t.plugins[i].render(this)},r.prototype.calculateVertices=function(){var t=this.geometry.buffers[0],e=t.data,r=t._updateID;if(r!==this.vertexDirty||this._transformID!==this.transform._worldID){this._transformID=this.transform._worldID,this.vertexData.length!==e.length&&(this.vertexData=new Float32Array(e.length));for(var i=this.transform.worldTransform,n=i.a,o=i.b,s=i.c,a=i.d,h=i.tx,u=i.ty,l=this.vertexData,c=0;c<l.length/2;c++){var d=e[2*c],f=e[2*c+1];l[2*c]=n*d+s*f+h,l[2*c+1]=o*d+a*f+u}if(this._roundPixels){var p=rt.RESOLUTION;for(c=0;c<l.length;++c)l[c]=Math.round((l[c]*p|0)/p)}this.vertexDirty=r}},r.prototype.calculateUvs=function(){var t=this.geometry.buffers[1],e=this.shader;e.uvMatrix.isSimple?this.uvs=t.data:(this.batchUvs||(this.batchUvs=new Da(t,e.uvMatrix)),this.batchUvs.update(),this.uvs=this.batchUvs.data)},r.prototype._calculateBounds=function(){this.calculateVertices(),this._bounds.addVertexData(this.vertexData,0,this.vertexData.length)},r.prototype.containsPoint=function(t){if(!this.getBounds().contains(t.x,t.y))return!1;this.worldTransform.applyInverse(t,Na);for(var e=this.geometry.getBuffer("aVertexPosition").data,r=wa.points,i=this.geometry.getIndex().data,n=i.length,o=4===this.drawMode?3:1,s=0;s+2<n;s+=o){var a=2*i[s],h=2*i[s+1],u=2*i[s+2];if(r[0]=e[a],r[1]=e[a+1],r[2]=e[h],r[3]=e[h+1],r[4]=e[u],r[5]=e[u+1],wa.contains(Na.x,Na.y))return!0}return!1},r.prototype.destroy=function(t){e.prototype.destroy.call(this,t),this.geometry.refCount--,0===this.geometry.refCount&&this.geometry.dispose(),this._cachedTexture&&(this._cachedTexture.destroy(),this._cachedTexture=null),this.geometry=null,this.shader=null,this.state=null,this.uvs=null,this.indices=null,this.vertexData=null},r.BATCHABLE_SIZE=100,r}(dr),La="varying vec2 vTextureCoord;\nuniform vec4 uColor;\n\nuniform sampler2D uSampler;\n\nvoid main(void)\n{\n    gl_FragColor = texture2D(uSampler, vTextureCoord) * uColor;\n}\n",Fa="attribute vec2 aVertexPosition;\nattribute vec2 aTextureCoord;\n\nuniform mat3 projectionMatrix;\nuniform mat3 translationMatrix;\nuniform mat3 uTextureMatrix;\n\nvarying vec2 vTextureCoord;\n\nvoid main(void)\n{\n    gl_Position = vec4((projectionMatrix * translationMatrix * vec3(aVertexPosition, 1.0)).xy, 0.0, 1.0);\n\n    vTextureCoord = (uTextureMatrix * vec3(aTextureCoord, 1.0)).xy;\n}\n",Ua=function(t){function e(e,r){var i=this,n={uSampler:e,alpha:1,uTextureMatrix:Ze.IDENTITY,uColor:new Float32Array([1,1,1,1])};return(r=Object.assign({tint:16777215,alpha:1,pluginName:"batch"},r)).uniforms&&Object.assign(n,r.uniforms),(i=t.call(this,r.program||en.from(Fa,La),n)||this)._colorDirty=!1,i.uvMatrix=new un(e),i.batchable=void 0===r.program,i.pluginName=r.pluginName,i.tint=r.tint,i.alpha=r.alpha,i}return Ma(e,t),Object.defineProperty(e.prototype,"texture",{get:function(){return this.uniforms.uSampler},set:function(t){this.uniforms.uSampler!==t&&(this.uniforms.uSampler=t,this.uvMatrix.texture=t)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"alpha",{get:function(){return this._alpha},set:function(t){t!==this._alpha&&(this._alpha=t,this._colorDirty=!0)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"tint",{get:function(){return this._tint},set:function(t){t!==this._tint&&(this._tint=t,this._tintRGB=(t>>16)+(65280&t)+((255&t)<<16),this._colorDirty=!0)},enumerable:!1,configurable:!0}),e.prototype.update=function(){if(this._colorDirty){this._colorDirty=!1;var t=this.texture.baseTexture;ye(this._tint,this._alpha,this.uniforms.uColor,t.alphaMode)}this.uvMatrix.update()&&(this.uniforms.uTextureMatrix=this.uvMatrix.mapCoord)},e}(rn),Ba=function(e){function r(r,i,n){var o=e.call(this)||this,s=new hi(r),a=new hi(i,!0),h=new hi(n,!0,!0);return o.addAttribute("aVertexPosition",s,2,!1,t.TYPES.FLOAT).addAttribute("aTextureCoord",a,2,!1,t.TYPES.FLOAT).addIndex(h),o._updateId=-1,o}return Ma(r,e),Object.defineProperty(r.prototype,"vertexDirtyId",{get:function(){return this.buffers[0]._updateID},enumerable:!1,configurable:!0}),r}(fi),Ga=function(t,e){return(Ga=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r])})(t,e)},Xa=function(){this.info=[],this.common=[],this.page=[],this.char=[],this.kerning=[]},ka=function(){function t(){}return t.test=function(t){return"string"==typeof t&&0===t.indexOf("info face=")},t.parse=function(t){var e=t.match(/^[a-z]+\s+.+$/gm),r={info:[],common:[],page:[],char:[],chars:[],kerning:[],kernings:[]};for(var i in e){var n=e[i].match(/^[a-z]+/gm)[0],o=e[i].match(/[a-zA-Z]+=([^\s"']+|"([^"]*)")/gm),s={};for(var a in o){var h=o[a].split("="),u=h[0],l=h[1].replace(/"/gm,""),c=parseFloat(l),d=isNaN(c)?l:c;s[u]=d}r[n].push(s)}var f=new Xa;return r.info.forEach(function(t){return f.info.push({face:t.face,size:parseInt(t.size,10)})}),r.common.forEach(function(t){return f.common.push({lineHeight:parseInt(t.lineHeight,10)})}),r.page.forEach(function(t){return f.page.push({id:parseInt(t.id,10),file:t.file})}),r.char.forEach(function(t){return f.char.push({id:parseInt(t.id,10),page:parseInt(t.page,10),x:parseInt(t.x,10),y:parseInt(t.y,10),width:parseInt(t.width,10),height:parseInt(t.height,10),xoffset:parseInt(t.xoffset,10),yoffset:parseInt(t.yoffset,10),xadvance:parseInt(t.xadvance,10)})}),r.kerning.forEach(function(t){return f.kerning.push({first:parseInt(t.first,10),second:parseInt(t.second,10),amount:parseInt(t.amount,10)})}),f},t}(),Ha=function(){function t(){}return t.test=function(t){return t instanceof XMLDocument&&t.getElementsByTagName("page").length&&null!==t.getElementsByTagName("info")[0].getAttribute("face")},t.parse=function(t){for(var e=new Xa,r=t.getElementsByTagName("info"),i=t.getElementsByTagName("common"),n=t.getElementsByTagName("page"),o=t.getElementsByTagName("char"),s=t.getElementsByTagName("kerning"),a=0;a<r.length;a++)e.info.push({face:r[a].getAttribute("face"),size:parseInt(r[a].getAttribute("size"),10)});for(a=0;a<i.length;a++)e.common.push({lineHeight:parseInt(i[a].getAttribute("lineHeight"),10)});for(a=0;a<n.length;a++)e.page.push({id:parseInt(n[a].getAttribute("id"),10)||0,file:n[a].getAttribute("file")});for(a=0;a<o.length;a++){var h=o[a];e.char.push({id:parseInt(h.getAttribute("id"),10),page:parseInt(h.getAttribute("page"),10)||0,x:parseInt(h.getAttribute("x"),10),y:parseInt(h.getAttribute("y"),10),width:parseInt(h.getAttribute("width"),10),height:parseInt(h.getAttribute("height"),10),xoffset:parseInt(h.getAttribute("xoffset"),10),yoffset:parseInt(h.getAttribute("yoffset"),10),xadvance:parseInt(h.getAttribute("xadvance"),10)})}for(a=0;a<s.length;a++)e.kerning.push({first:parseInt(s[a].getAttribute("first"),10),second:parseInt(s[a].getAttribute("second"),10),amount:parseInt(s[a].getAttribute("amount"),10)});return e},t}(),Ya=function(){function t(){}return t.test=function(t){if("string"==typeof t&&t.indexOf("<font>")>-1){var e=(new self.DOMParser).parseFromString(t,"text/xml");return Ha.test(e)}return!1},t.parse=function(t){var e=(new self.DOMParser).parseFromString(t,"text/xml");return Ha.parse(e)},t}(),ja=[ka,Ha,Ya];function Va(t){for(var e=0;e<ja.length;e++)if(ja[e].test(t))return ja[e];return null}function Wa(e,r,i,n,o,s,a){var h=i.text,u=i.fontProperties;r.translate(n,o),r.scale(s,s);var l=a.strokeThickness/2,c=-a.strokeThickness/2;r.font=a.toFontString(),r.lineWidth=a.strokeThickness,r.textBaseline=a.textBaseline,r.lineJoin=a.lineJoin,r.miterLimit=a.miterLimit,r.fillStyle=function(e,r,i,n,o,s){var a,h=i.fill;if(!Array.isArray(h))return h;if(1===h.length)return h[0];var u=i.dropShadow?i.dropShadowDistance:0,l=i.padding||0,c=e.width/n-u-2*l,d=e.height/n-u-2*l,f=h.slice(),p=i.fillGradientStops.slice();if(!p.length)for(var _=f.length+1,m=1;m<_;++m)p.push(m/_);if(f.unshift(h[0]),p.unshift(0),f.push(h[h.length-1]),p.push(1),i.fillGradientType===t.TEXT_GRADIENT.LINEAR_VERTICAL){a=r.createLinearGradient(c/2,l,c/2,d+l);var v=0,y=(s.fontProperties.fontSize+i.strokeThickness)/d;for(m=0;m<o.length;m++)for(var E=s.lineHeight*m,g=0;g<f.length;g++){var T=E/d+("number"==typeof p[g]?p[g]:g/f.length)*y,b=Math.max(v,T);b=Math.min(b,1),a.addColorStop(b,f[g]),v=b}}else{a=r.createLinearGradient(l,d/2,c+l,d/2);var R=f.length+1,x=1;for(m=0;m<f.length;m++){var A;A="number"==typeof p[m]?p[m]:x/R,a.addColorStop(A,f[m]),x++}}return a}(e,r,a,s,[h],i),r.strokeStyle=a.stroke;var d=a.dropShadowColor,f=ce("number"==typeof d?d:fe(d));a.dropShadow?(r.shadowColor="rgba("+255*f[0]+","+255*f[1]+","+255*f[2]+","+a.dropShadowAlpha+")",r.shadowBlur=a.dropShadowBlur,r.shadowOffsetX=Math.cos(a.dropShadowAngle)*a.dropShadowDistance,r.shadowOffsetY=Math.sin(a.dropShadowAngle)*a.dropShadowDistance):(r.shadowColor="black",r.shadowBlur=0,r.shadowOffsetX=0,r.shadowOffsetY=0),a.stroke&&a.strokeThickness&&r.strokeText(h,l,c+i.lineHeight-u.descent),a.fill&&r.fillText(h,l,c+i.lineHeight-u.descent),r.setTransform(1,0,0,1,0,0),r.fillStyle="rgba(0, 0, 0, 0)"}var za=function(){function t(t,e,r){var i=t.info[0],n=t.common[0],o=Be(t.page[0].file),s={};this._ownsTextures=r,this.font=i.face,this.size=i.size,this.lineHeight=n.lineHeight/o,this.chars={},this.pageTextures=s;for(var a=0;a<t.page.length;a++){var h=t.page[a],u=h.id,l=h.file;s[u]=e instanceof Array?e[a]:e[l]}for(a=0;a<t.char.length;a++){var c=t.char[a],d=(u=c.id,c.page),f=t.char[a],p=f.x,_=f.y,m=f.width,v=f.height,y=f.xoffset,E=f.yoffset,g=f.xadvance;_/=o,m/=o,v/=o,y/=o,E/=o,g/=o;var T=new Ye((p/=o)+s[d].frame.x/o,_+s[d].frame.y/o,m,v);this.chars[u]={xOffset:y,yOffset:E,xAdvance:g,kerning:{},texture:new ri(s[d].baseTexture,T),page:d}}for(a=0;a<t.kerning.length;a++){var b=t.kerning[a],R=b.first,x=b.second,A=b.amount;R/=o,x/=o,A/=o,this.chars[x]&&(this.chars[x].kerning[R]=A)}}return t.prototype.destroy=function(){for(var t in this.chars)this.chars[t].texture.destroy(),this.chars[t].texture=null;for(var t in this.pageTextures)this._ownsTextures&&this.pageTextures[t].destroy(!0),this.pageTextures[t]=null;this.chars=null,this.pageTextures=null},t.install=function(e,r,i){var n;if(e instanceof Xa)n=e;else{var o=Va(e);if(!o)throw new Error("Unrecognized data format for font.");n=o.parse(e)}r instanceof ri&&(r=[r]);var s=new t(n,r,i);return t.available[s.font]=s,s},t.uninstall=function(e){var r=t.available[e];if(!r)throw new Error("No font found named '"+e+"'");r.destroy(),delete t.available[e]},t.from=function(e,r,i){if(!e)throw new Error("[BitmapFont] Property `name` is required.");var n=Object.assign({},t.defaultOptions,i),o=n.chars,s=n.padding,a=n.resolution,h=n.textureWidth,u=n.textureHeight,l=function(t){"string"==typeof t&&(t=[t]);for(var e=[],r=0,i=t.length;r<i;r++){var n=t[r];if(Array.isArray(n)){if(2!==n.length)throw new Error("[BitmapFont]: Invalid character range length, expecting 2 got "+n.length+".");var o=n[0].charCodeAt(0),s=n[1].charCodeAt(0);if(s<o)throw new Error("[BitmapFont]: Invalid character range.");for(var a=o,h=s;a<=h;a++)e.push(String.fromCharCode(a))}else e.push.apply(e,n.split(""))}if(0===e.length)throw new Error("[BitmapFont]: Empty set when resolving characters.");return e}(o),c=r instanceof Ks?r:new Ks(r),d=h,f=new Xa;f.info[0]={face:c.fontFamily,size:c.fontSize},f.common[0]={lineHeight:c.fontSize};for(var p,_,m,v=0,y=0,E=0,g=[],T=0;T<l.length;T++){p||((p=document.createElement("canvas")).width=h,p.height=u,_=p.getContext("2d"),m=new Xr(p,{resolution:a}),g.push(new ri(m)),f.page.push({id:g.length-1,file:""}));var b=$s.measureText(l[T],c,!1,p),R=b.width,x=Math.ceil(b.height),A=Math.ceil(("italic"===c.fontStyle?2:1)*R);if(y>=u-x*a){if(0===y)throw new Error("[BitmapFont] textureHeight "+u+"px is too small for "+c.fontSize+"px fonts");--T,p=null,_=null,m=null,y=0,v=0,E=0}else if(E=Math.max(x+b.fontProperties.descent,E),A*a+v>=d)--T,y+=E*a,y=Math.ceil(y),v=0,E=0;else{Wa(p,_,b,v,y,a,c);var S=b.text.charCodeAt(0);f.char.push({id:S,page:g.length-1,x:v/a,y:y/a,width:A,height:x,xoffset:0,yoffset:0,xadvance:Math.ceil(R-(c.dropShadow?c.dropShadowDistance:0)-(c.stroke?c.strokeThickness:0))}),v+=(A+2*s)*a,v=Math.ceil(v)}}T=0;for(var O=l.length;T<O;T++)for(var I=l[T],P=0;P<O;P++){var M=l[P],D=_.measureText(I).width,N=_.measureText(M).width,w=_.measureText(I+M).width-(D+N);w&&f.kerning.push({first:I.charCodeAt(0),second:M.charCodeAt(0),amount:w})}var C=new t(f,g,!0);return void 0!==t.available[e]&&t.uninstall(e),t.available[e]=C,C},t.ALPHA=[["a","z"],["A","Z"]," "],t.NUMERIC=[["0","9"]],t.ALPHANUMERIC=[["a","z"],["A","Z"],["0","9"]," "],t.ASCII=[[" ","~"]],t.defaultOptions={resolution:1,textureWidth:512,textureHeight:512,padding:4,chars:t.ALPHANUMERIC},t.available={},t}(),qa=[],Ka=[],Za=function(t){function e(r,i){void 0===i&&(i={});var n=t.call(this)||this;n._tint=16777215;var o=Object.assign({},e.styleDefaults,i),s=o.align,a=o.tint,h=o.maxWidth,u=o.letterSpacing,l=o.fontName,c=o.fontSize;if(!za.available[l])throw new Error('Missing BitmapFont "'+l+'"');return n._activePagesMeshData=[],n._textWidth=0,n._textHeight=0,n._align=s,n._tint=a,n._fontName=l,n._fontSize=c||za.available[l].size,n._text=r,n._maxWidth=h,n._maxLineHeight=0,n._letterSpacing=u,n._anchor=new Ke(function(){n.dirty=!0},n,0,0),n._roundPixels=rt.ROUND_PIXELS,n.dirty=!0,n._textureCache={},n}return function(t,e){function r(){this.constructor=t}Ga(t,e),t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)}(e,t),e.prototype.updateText=function(){for(var t,e=za.available[this._fontName],r=this._fontSize/e.size,i=new qe,n=[],o=[],s=[],a=this._text.replace(/(?:\r\n|\r)/g,"\n")||" ",h=a.length,u=this._maxWidth*e.size/this._fontSize,l=null,c=0,d=0,f=0,p=-1,_=0,m=0,v=0,y=0,E=0;E<h;E++){var g=a.charCodeAt(E),T=a.charAt(E);if(/(?:\s)/.test(T)&&(p=E,_=c,y++),"\r"!==T&&"\n"!==T){var b=e.chars[g];if(b){l&&b.kerning[l]&&(i.x+=b.kerning[l]);var R=Ka.pop()||{texture:ri.EMPTY,line:0,charCode:0,prevSpaces:0,position:new qe};R.texture=b.texture,R.line=f,R.charCode=g,R.position.x=i.x+b.xOffset+this._letterSpacing/2,R.position.y=i.y+b.yOffset,R.prevSpaces=y,n.push(R),c=R.position.x+b.texture.orig.width,i.x+=b.xAdvance+this._letterSpacing,v=Math.max(v,b.yOffset+b.texture.height),l=g,-1!==p&&u>0&&i.x>u&&(Ae(n,1+p-++m,1+E-p),E=p,p=-1,o.push(_),s.push(n.length>0?n[n.length-1].prevSpaces:0),d=Math.max(d,_),f++,i.x=0,i.y+=e.lineHeight,l=null,y=0)}}else o.push(c),s.push(-1),d=Math.max(d,c),++f,++m,i.x=0,i.y+=e.lineHeight,l=null,y=0}var x=a.charAt(a.length-1);"\r"!==x&&"\n"!==x&&(/(?:\s)/.test(x)&&(c=_),o.push(c),d=Math.max(d,c),s.push(-1));var A=[];for(E=0;E<=f;E++){var S=0;"right"===this._align?S=d-o[E]:"center"===this._align?S=(d-o[E])/2:"justify"===this._align&&(S=s[E]<0?0:(d-o[E])/s[E]),A.push(S)}var O=n.length,I={},P=[],M=this._activePagesMeshData;for(E=0;E<M.length;E++)qa.push(M[E]);for(E=0;E<O;E++){var D=(X=n[E].texture).baseTexture.uid;if(!I[D]){if(!(z=qa.pop())){var N=new Ba,w=new Ua(ri.EMPTY);z={index:0,indexCount:0,vertexCount:0,uvsCount:0,total:0,mesh:new Ca(N,w),vertices:null,uvs:null,indices:null}}z.index=0,z.indexCount=0,z.vertexCount=0,z.uvsCount=0,z.total=0;var C=this._textureCache;C[D]=C[D]||new ri(X.baseTexture),z.mesh.texture=C[D],z.mesh.tint=this._tint,P.push(z),I[D]=z}I[D].total++}for(E=0;E<M.length;E++)-1===P.indexOf(M[E])&&this.removeChild(M[E].mesh);for(E=0;E<P.length;E++)P[E].mesh.parent!==this&&this.addChild(P[E].mesh);for(var E in this._activePagesMeshData=P,I){var L=(z=I[E]).total;if(!((null===(t=z.indices)||void 0===t?void 0:t.length)>6*L)||z.vertices.length<2*Ca.BATCHABLE_SIZE)z.vertices=new Float32Array(8*L),z.uvs=new Float32Array(8*L),z.indices=new Uint16Array(6*L);else for(var F=z.total,U=z.vertices,B=4*F*2;B<U.length;B++)U[B]=0;z.mesh.size=6*L}for(E=0;E<O;E++){var G=(T=n[E]).position.x+A[T.line]*("justify"===this._align?T.prevSpaces:1);this._roundPixels&&(G=Math.round(G));var X,k=G*r,H=T.position.y*r,Y=I[(X=T.texture).baseTexture.uid],j=X.frame,V=X._uvs,W=Y.index++;Y.indices[6*W+0]=0+4*W,Y.indices[6*W+1]=1+4*W,Y.indices[6*W+2]=2+4*W,Y.indices[6*W+3]=0+4*W,Y.indices[6*W+4]=2+4*W,Y.indices[6*W+5]=3+4*W,Y.vertices[8*W+0]=k,Y.vertices[8*W+1]=H,Y.vertices[8*W+2]=k+j.width*r,Y.vertices[8*W+3]=H,Y.vertices[8*W+4]=k+j.width*r,Y.vertices[8*W+5]=H+j.height*r,Y.vertices[8*W+6]=k,Y.vertices[8*W+7]=H+j.height*r,Y.uvs[8*W+0]=V.x0,Y.uvs[8*W+1]=V.y0,Y.uvs[8*W+2]=V.x1,Y.uvs[8*W+3]=V.y1,Y.uvs[8*W+4]=V.x2,Y.uvs[8*W+5]=V.y2,Y.uvs[8*W+6]=V.x3,Y.uvs[8*W+7]=V.y3}for(var E in this._textWidth=d*r,this._textHeight=(i.y+e.lineHeight)*r,I){var z=I[E];if(0!==this.anchor.x||0!==this.anchor.y)for(var q=0,K=this._textWidth*this.anchor.x,Z=this._textHeight*this.anchor.y,Q=0;Q<z.total;Q++)z.vertices[q++]-=K,z.vertices[q++]-=Z,z.vertices[q++]-=K,z.vertices[q++]-=Z,z.vertices[q++]-=K,z.vertices[q++]-=Z,z.vertices[q++]-=K,z.vertices[q++]-=Z;this._maxLineHeight=v*r;var J=z.mesh.geometry.getBuffer("aVertexPosition"),$=z.mesh.geometry.getBuffer("aTextureCoord"),tt=z.mesh.geometry.getIndex();J.data=z.vertices,$.data=z.uvs,tt.data=z.indices,J.update(),$.update(),tt.update()}for(E=0;E<n.length;E++)Ka.push(n[E])},e.prototype.updateTransform=function(){this.validate(),this.containerUpdateTransform()},e.prototype.getLocalBounds=function(){return this.validate(),t.prototype.getLocalBounds.call(this)},e.prototype.validate=function(){this.dirty&&(this.updateText(),this.dirty=!1)},Object.defineProperty(e.prototype,"tint",{get:function(){return this._tint},set:function(t){if(this._tint!==t){this._tint=t;for(var e=0;e<this._activePagesMeshData.length;e++)this._activePagesMeshData[e].mesh.tint=t}},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"align",{get:function(){return this._align},set:function(t){this._align!==t&&(this._align=t,this.dirty=!0)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"fontName",{get:function(){return this._fontName},set:function(t){if(!za.available[t])throw new Error('Missing BitmapFont "'+t+'"');this._fontName!==t&&(this._fontName=t,this.dirty=!0)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"fontSize",{get:function(){return this._fontSize},set:function(t){this._fontSize!==t&&(this._fontSize=t,this.dirty=!0)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"anchor",{get:function(){return this._anchor},set:function(t){"number"==typeof t?this._anchor.set(t):this._anchor.copyFrom(t)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"text",{get:function(){return this._text},set:function(t){t=String(null==t?"":t),this._text!==t&&(this._text=t,this.dirty=!0)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"maxWidth",{get:function(){return this._maxWidth},set:function(t){this._maxWidth!==t&&(this._maxWidth=t,this.dirty=!0)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"maxLineHeight",{get:function(){return this.validate(),this._maxLineHeight},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"textWidth",{get:function(){return this.validate(),this._textWidth},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"letterSpacing",{get:function(){return this._letterSpacing},set:function(t){this._letterSpacing!==t&&(this._letterSpacing=t,this.dirty=!0)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"roundPixels",{get:function(){return this._roundPixels},set:function(t){t!==this._roundPixels&&(this._roundPixels=t,this.dirty=!0)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"textHeight",{get:function(){return this.validate(),this._textHeight},enumerable:!1,configurable:!0}),e.prototype.destroy=function(e){var r=this._textureCache;for(var i in r)r[i].destroy(),delete r[i];this._textureCache=null,t.prototype.destroy.call(this,e)},e.styleDefaults={align:"left",tint:16777215,maxWidth:0,letterSpacing:0},e}(dr),Qa=function(){function e(){}return e.add=function(){t.LoaderResource.setExtensionXhrType("fnt",t.LoaderResource.XHR_RESPONSE_TYPE.TEXT)},e.use=function(r,i){var n=Va(r.data);if(n)for(var o=e.getBaseUrl(this,r),s=n.parse(r.data),a={},h=function(t){a[t.metadata.pageFile]=t.texture,Object.keys(a).length===s.page.length&&(r.bitmapFont=za.install(s,a,!0),i())},u=0;u<s.page.length;++u){var l=s.page[u].file,c=o+l,d=!1;for(var f in this.resources){var p=this.resources[f];if(p.url===c){p.metadata.pageFile=l,p.texture?h(p):p.onAfterMiddleware.add(h),d=!0;break}}if(!d){var _={crossOrigin:r.crossOrigin,loadType:t.LoaderResource.LOAD_TYPE.IMAGE,metadata:Object.assign({pageFile:l},r.metadata.imageMetadata),parentResource:r};this.add(c,_,h)}}else i()},e.getBaseUrl=function(t,r){var i=r.isDataUrl?"":e.dirname(r.url);return r.isDataUrl&&("."===i&&(i=""),t.baseUrl&&i&&"/"===t.baseUrl.charAt(t.baseUrl.length-1)&&(i+="/")),(i=i.replace(t.baseUrl,""))&&"/"!==i.charAt(i.length-1)&&(i+="/"),i},e.dirname=function(t){var e=t.replace(/\\/g,"/").replace(/\/$/,"").replace(/\/[^\/]*$/,"");return e===t?".":""===e?"/":e},e}(),Ja=function(t,e){return(Ja=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r])})(t,e)},$a="varying vec2 vTextureCoord;\n\nuniform sampler2D uSampler;\nuniform float uAlpha;\n\nvoid main(void)\n{\n   gl_FragColor = texture2D(uSampler, vTextureCoord) * uAlpha;\n}\n",th=function(t){function e(e){void 0===e&&(e=1);var r=t.call(this,qn,$a,{uAlpha:1})||this;return r.alpha=e,r}return function(t,e){function r(){this.constructor=t}Ja(t,e),t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)}(e,t),Object.defineProperty(e.prototype,"alpha",{get:function(){return this.uniforms.uAlpha},set:function(t){this.uniforms.uAlpha=t},enumerable:!1,configurable:!0}),e}(on),eh=function(t,e){return(eh=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r])})(t,e)};function rh(t,e){function r(){this.constructor=t}eh(t,e),t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)}var ih,nh,oh,sh,ah,hh,uh,lh,ch,dh,fh,ph,_h,mh,vh,yh,Eh,gh,Th,bh="\n    attribute vec2 aVertexPosition;\n\n    uniform mat3 projectionMatrix;\n\n    uniform float strength;\n\n    varying vec2 vBlurTexCoords[%size%];\n\n    uniform vec4 inputSize;\n    uniform vec4 outputFrame;\n\n    vec4 filterVertexPosition( void )\n    {\n        vec2 position = aVertexPosition * max(outputFrame.zw, vec2(0.)) + outputFrame.xy;\n\n        return vec4((projectionMatrix * vec3(position, 1.0)).xy, 0.0, 1.0);\n    }\n\n    vec2 filterTextureCoord( void )\n    {\n        return aVertexPosition * (outputFrame.zw * inputSize.zw);\n    }\n\n    void main(void)\n    {\n        gl_Position = filterVertexPosition();\n\n        vec2 textureCoord = filterTextureCoord();\n        %blur%\n    }",Rh={5:[.153388,.221461,.250301],7:[.071303,.131514,.189879,.214607],9:[.028532,.067234,.124009,.179044,.20236],11:[.0093,.028002,.065984,.121703,.175713,.198596],13:[.002406,.009255,.027867,.065666,.121117,.174868,.197641],15:[489e-6,.002403,.009246,.02784,.065602,.120999,.174697,.197448]},xh=["varying vec2 vBlurTexCoords[%size%];","uniform sampler2D uSampler;","void main(void)","{","    gl_FragColor = vec4(0.0);","    %blur%","}"].join("\n");!function(t){t[t.WEBGL_LEGACY=0]="WEBGL_LEGACY",t[t.WEBGL=1]="WEBGL",t[t.WEBGL2=2]="WEBGL2"}(ih||(ih={})),function(t){t[t.UNKNOWN=0]="UNKNOWN",t[t.WEBGL=1]="WEBGL",t[t.CANVAS=2]="CANVAS"}(nh||(nh={})),function(t){t[t.COLOR=16384]="COLOR",t[t.DEPTH=256]="DEPTH",t[t.STENCIL=1024]="STENCIL"}(oh||(oh={})),function(t){t[t.NORMAL=0]="NORMAL",t[t.ADD=1]="ADD",t[t.MULTIPLY=2]="MULTIPLY",t[t.SCREEN=3]="SCREEN",t[t.OVERLAY=4]="OVERLAY",t[t.DARKEN=5]="DARKEN",t[t.LIGHTEN=6]="LIGHTEN",t[t.COLOR_DODGE=7]="COLOR_DODGE",t[t.COLOR_BURN=8]="COLOR_BURN",t[t.HARD_LIGHT=9]="HARD_LIGHT",t[t.SOFT_LIGHT=10]="SOFT_LIGHT",t[t.DIFFERENCE=11]="DIFFERENCE",t[t.EXCLUSION=12]="EXCLUSION",t[t.HUE=13]="HUE",t[t.SATURATION=14]="SATURATION",t[t.COLOR=15]="COLOR",t[t.LUMINOSITY=16]="LUMINOSITY",t[t.NORMAL_NPM=17]="NORMAL_NPM",t[t.ADD_NPM=18]="ADD_NPM",t[t.SCREEN_NPM=19]="SCREEN_NPM",t[t.NONE=20]="NONE",t[t.SRC_OVER=0]="SRC_OVER",t[t.SRC_IN=21]="SRC_IN",t[t.SRC_OUT=22]="SRC_OUT",t[t.SRC_ATOP=23]="SRC_ATOP",t[t.DST_OVER=24]="DST_OVER",t[t.DST_IN=25]="DST_IN",t[t.DST_OUT=26]="DST_OUT",t[t.DST_ATOP=27]="DST_ATOP",t[t.ERASE=26]="ERASE",t[t.SUBTRACT=28]="SUBTRACT",t[t.XOR=29]="XOR"}(sh||(sh={})),function(t){t[t.POINTS=0]="POINTS",t[t.LINES=1]="LINES",t[t.LINE_LOOP=2]="LINE_LOOP",t[t.LINE_STRIP=3]="LINE_STRIP",t[t.TRIANGLES=4]="TRIANGLES",t[t.TRIANGLE_STRIP=5]="TRIANGLE_STRIP",t[t.TRIANGLE_FAN=6]="TRIANGLE_FAN"}(ah||(ah={})),function(t){t[t.RGBA=6408]="RGBA",t[t.RGB=6407]="RGB",t[t.RG=33319]="RG",t[t.RED=6403]="RED",t[t.RGBA_INTEGER=36249]="RGBA_INTEGER",t[t.RGB_INTEGER=36248]="RGB_INTEGER",t[t.RG_INTEGER=33320]="RG_INTEGER",t[t.RED_INTEGER=36244]="RED_INTEGER",t[t.ALPHA=6406]="ALPHA",t[t.LUMINANCE=6409]="LUMINANCE",t[t.LUMINANCE_ALPHA=6410]="LUMINANCE_ALPHA",t[t.DEPTH_COMPONENT=6402]="DEPTH_COMPONENT",t[t.DEPTH_STENCIL=34041]="DEPTH_STENCIL"}(hh||(hh={})),function(t){t[t.TEXTURE_2D=3553]="TEXTURE_2D",t[t.TEXTURE_CUBE_MAP=34067]="TEXTURE_CUBE_MAP",t[t.TEXTURE_2D_ARRAY=35866]="TEXTURE_2D_ARRAY",t[t.TEXTURE_CUBE_MAP_POSITIVE_X=34069]="TEXTURE_CUBE_MAP_POSITIVE_X",t[t.TEXTURE_CUBE_MAP_NEGATIVE_X=34070]="TEXTURE_CUBE_MAP_NEGATIVE_X",t[t.TEXTURE_CUBE_MAP_POSITIVE_Y=34071]="TEXTURE_CUBE_MAP_POSITIVE_Y",t[t.TEXTURE_CUBE_MAP_NEGATIVE_Y=34072]="TEXTURE_CUBE_MAP_NEGATIVE_Y",t[t.TEXTURE_CUBE_MAP_POSITIVE_Z=34073]="TEXTURE_CUBE_MAP_POSITIVE_Z",t[t.TEXTURE_CUBE_MAP_NEGATIVE_Z=34074]="TEXTURE_CUBE_MAP_NEGATIVE_Z"}(uh||(uh={})),function(t){t[t.UNSIGNED_BYTE=5121]="UNSIGNED_BYTE",t[t.UNSIGNED_SHORT=5123]="UNSIGNED_SHORT",t[t.UNSIGNED_SHORT_5_6_5=33635]="UNSIGNED_SHORT_5_6_5",t[t.UNSIGNED_SHORT_4_4_4_4=32819]="UNSIGNED_SHORT_4_4_4_4",t[t.UNSIGNED_SHORT_5_5_5_1=32820]="UNSIGNED_SHORT_5_5_5_1",t[t.UNSIGNED_INT=5125]="UNSIGNED_INT",t[t.UNSIGNED_INT_10F_11F_11F_REV=35899]="UNSIGNED_INT_10F_11F_11F_REV",t[t.UNSIGNED_INT_2_10_10_10_REV=33640]="UNSIGNED_INT_2_10_10_10_REV",t[t.UNSIGNED_INT_24_8=34042]="UNSIGNED_INT_24_8",t[t.UNSIGNED_INT_5_9_9_9_REV=35902]="UNSIGNED_INT_5_9_9_9_REV",t[t.BYTE=5120]="BYTE",t[t.SHORT=5122]="SHORT",t[t.INT=5124]="INT",t[t.FLOAT=5126]="FLOAT",t[t.FLOAT_32_UNSIGNED_INT_24_8_REV=36269]="FLOAT_32_UNSIGNED_INT_24_8_REV",t[t.HALF_FLOAT=36193]="HALF_FLOAT"}(lh||(lh={})),function(t){t[t.FLOAT=0]="FLOAT",t[t.INT=1]="INT",t[t.UINT=2]="UINT"}(ch||(ch={})),function(t){t[t.NEAREST=0]="NEAREST",t[t.LINEAR=1]="LINEAR"}(dh||(dh={})),function(t){t[t.CLAMP=33071]="CLAMP",t[t.REPEAT=10497]="REPEAT",t[t.MIRRORED_REPEAT=33648]="MIRRORED_REPEAT"}(fh||(fh={})),function(t){t[t.OFF=0]="OFF",t[t.POW2=1]="POW2",t[t.ON=2]="ON",t[t.ON_MANUAL=3]="ON_MANUAL"}(ph||(ph={})),function(t){t[t.NPM=0]="NPM",t[t.UNPACK=1]="UNPACK",t[t.PMA=2]="PMA",t[t.NO_PREMULTIPLIED_ALPHA=0]="NO_PREMULTIPLIED_ALPHA",t[t.PREMULTIPLY_ON_UPLOAD=1]="PREMULTIPLY_ON_UPLOAD",t[t.PREMULTIPLY_ALPHA=2]="PREMULTIPLY_ALPHA"}(_h||(_h={})),function(t){t[t.NO=0]="NO",t[t.YES=1]="YES",t[t.AUTO=2]="AUTO",t[t.BLEND=0]="BLEND",t[t.CLEAR=1]="CLEAR",t[t.BLIT=2]="BLIT"}(mh||(mh={})),function(t){t[t.AUTO=0]="AUTO",t[t.MANUAL=1]="MANUAL"}(vh||(vh={})),function(t){t.LOW="lowp",t.MEDIUM="mediump",t.HIGH="highp"}(yh||(yh={})),function(t){t[t.NONE=0]="NONE",t[t.SCISSOR=1]="SCISSOR",t[t.STENCIL=2]="STENCIL",t[t.SPRITE=3]="SPRITE"}(Eh||(Eh={})),function(t){t[t.NONE=0]="NONE",t[t.LOW=2]="LOW",t[t.MEDIUM=4]="MEDIUM",t[t.HIGH=8]="HIGH"}(gh||(gh={})),function(t){t[t.ELEMENT_ARRAY_BUFFER=34963]="ELEMENT_ARRAY_BUFFER",t[t.ARRAY_BUFFER=34962]="ARRAY_BUFFER",t[t.UNIFORM_BUFFER=35345]="UNIFORM_BUFFER"}(Th||(Th={}));var Ah=function(t){function e(e,r,i,n,o){void 0===r&&(r=8),void 0===i&&(i=4),void 0===n&&(n=rt.FILTER_RESOLUTION),void 0===o&&(o=5);var s=this,a=function(t,e){var r,i=Math.ceil(t/2),n=bh,o="";r=e?"vBlurTexCoords[%index%] =  textureCoord + vec2(%sampleIndex% * strength, 0.0);":"vBlurTexCoords[%index%] =  textureCoord + vec2(0.0, %sampleIndex% * strength);";for(var s=0;s<t;s++){var a=r.replace("%index%",s.toString());o+=a=a.replace("%sampleIndex%",s-(i-1)+".0"),o+="\n"}return(n=n.replace("%blur%",o)).replace("%size%",t.toString())}(o,e),h=function(t){for(var e,r=Rh[t],i=r.length,n=xh,o="",s=0;s<t;s++){var a="gl_FragColor += texture2D(uSampler, vBlurTexCoords[%index%]) * %value%;".replace("%index%",s.toString());e=s,s>=i&&(e=t-s-1),o+=a=a.replace("%value%",r[e].toString()),o+="\n"}return(n=n.replace("%blur%",o)).replace("%size%",t.toString())}(o);return(s=t.call(this,a,h)||this).horizontal=e,s.resolution=n,s._quality=0,s.quality=i,s.blur=r,s}return rh(e,t),e.prototype.apply=function(t,e,r,i){if(r?this.horizontal?this.uniforms.strength=1/r.width*(r.width/e.width):this.uniforms.strength=1/r.height*(r.height/e.height):this.horizontal?this.uniforms.strength=1/t.renderer.width*(t.renderer.width/e.width):this.uniforms.strength=1/t.renderer.height*(t.renderer.height/e.height),this.uniforms.strength*=this.strength,this.uniforms.strength/=this.passes,1===this.passes)t.applyFilter(this,e,r,i);else{var n=t.getFilterTexture(),o=t.renderer,s=e,a=n;this.state.blend=!1,t.applyFilter(this,s,a,mh.CLEAR);for(var h=1;h<this.passes-1;h++){t.bindAndClear(s,mh.BLIT),this.uniforms.uSampler=a;var u=a;a=s,s=u,o.shader.bind(this),o.geometry.draw(5)}this.state.blend=!0,t.applyFilter(this,a,r,i),t.returnFilterTexture(n)}},Object.defineProperty(e.prototype,"blur",{get:function(){return this.strength},set:function(t){this.padding=1+2*Math.abs(t),this.strength=t},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"quality",{get:function(){return this._quality},set:function(t){this._quality=t,this.passes=t},enumerable:!1,configurable:!0}),e}(on),Sh=function(t){function e(e,r,i,n){void 0===e&&(e=8),void 0===r&&(r=4),void 0===i&&(i=rt.FILTER_RESOLUTION),void 0===n&&(n=5);var o=t.call(this)||this;return o.blurXFilter=new Ah(!0,e,r,i,n),o.blurYFilter=new Ah(!1,e,r,i,n),o.resolution=i,o.quality=r,o.blur=e,o.repeatEdgePixels=!1,o}return rh(e,t),e.prototype.apply=function(t,e,r,i){var n=Math.abs(this.blurXFilter.strength),o=Math.abs(this.blurYFilter.strength);if(n&&o){var s=t.getFilterTexture();this.blurXFilter.apply(t,e,s,mh.CLEAR),this.blurYFilter.apply(t,s,r,i),t.returnFilterTexture(s)}else o?this.blurYFilter.apply(t,e,r,i):this.blurXFilter.apply(t,e,r,i)},e.prototype.updatePadding=function(){this._repeatEdgePixels?this.padding=0:this.padding=2*Math.max(Math.abs(this.blurXFilter.strength),Math.abs(this.blurYFilter.strength))},Object.defineProperty(e.prototype,"blur",{get:function(){return this.blurXFilter.blur},set:function(t){this.blurXFilter.blur=this.blurYFilter.blur=t,this.updatePadding()},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"quality",{get:function(){return this.blurXFilter.quality},set:function(t){this.blurXFilter.quality=this.blurYFilter.quality=t},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"blurX",{get:function(){return this.blurXFilter.blur},set:function(t){this.blurXFilter.blur=t,this.updatePadding()},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"blurY",{get:function(){return this.blurYFilter.blur},set:function(t){this.blurYFilter.blur=t,this.updatePadding()},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"blendMode",{get:function(){return this.blurYFilter.blendMode},set:function(t){this.blurYFilter.blendMode=t},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"repeatEdgePixels",{get:function(){return this._repeatEdgePixels},set:function(t){this._repeatEdgePixels=t,this.updatePadding()},enumerable:!1,configurable:!0}),e}(on),Oh=function(t,e){return(Oh=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r])})(t,e)},Ih="varying vec2 vTextureCoord;\nuniform sampler2D uSampler;\nuniform float m[20];\nuniform float uAlpha;\n\nvoid main(void)\n{\n    vec4 c = texture2D(uSampler, vTextureCoord);\n\n    if (uAlpha == 0.0) {\n        gl_FragColor = c;\n        return;\n    }\n\n    // Un-premultiply alpha before applying the color matrix. See issue #3539.\n    if (c.a > 0.0) {\n      c.rgb /= c.a;\n    }\n\n    vec4 result;\n\n    result.r = (m[0] * c.r);\n        result.r += (m[1] * c.g);\n        result.r += (m[2] * c.b);\n        result.r += (m[3] * c.a);\n        result.r += m[4];\n\n    result.g = (m[5] * c.r);\n        result.g += (m[6] * c.g);\n        result.g += (m[7] * c.b);\n        result.g += (m[8] * c.a);\n        result.g += m[9];\n\n    result.b = (m[10] * c.r);\n       result.b += (m[11] * c.g);\n       result.b += (m[12] * c.b);\n       result.b += (m[13] * c.a);\n       result.b += m[14];\n\n    result.a = (m[15] * c.r);\n       result.a += (m[16] * c.g);\n       result.a += (m[17] * c.b);\n       result.a += (m[18] * c.a);\n       result.a += m[19];\n\n    vec3 rgb = mix(c.rgb, result.rgb, uAlpha);\n\n    // Premultiply alpha again.\n    rgb *= result.a;\n\n    gl_FragColor = vec4(rgb, result.a);\n}\n",Ph=function(t){function e(){var e=this,r={m:new Float32Array([1,0,0,0,0,0,1,0,0,0,0,0,1,0,0,0,0,0,1,0]),uAlpha:1};return(e=t.call(this,Kn,Ih,r)||this).alpha=1,e}return function(t,e){function r(){this.constructor=t}Oh(t,e),t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)}(e,t),e.prototype._loadMatrix=function(t,e){void 0===e&&(e=!1);var r=t;e&&(this._multiply(r,this.uniforms.m,t),r=this._colorMatrix(r)),this.uniforms.m=r},e.prototype._multiply=function(t,e,r){return t[0]=e[0]*r[0]+e[1]*r[5]+e[2]*r[10]+e[3]*r[15],t[1]=e[0]*r[1]+e[1]*r[6]+e[2]*r[11]+e[3]*r[16],t[2]=e[0]*r[2]+e[1]*r[7]+e[2]*r[12]+e[3]*r[17],t[3]=e[0]*r[3]+e[1]*r[8]+e[2]*r[13]+e[3]*r[18],t[4]=e[0]*r[4]+e[1]*r[9]+e[2]*r[14]+e[3]*r[19]+e[4],t[5]=e[5]*r[0]+e[6]*r[5]+e[7]*r[10]+e[8]*r[15],t[6]=e[5]*r[1]+e[6]*r[6]+e[7]*r[11]+e[8]*r[16],t[7]=e[5]*r[2]+e[6]*r[7]+e[7]*r[12]+e[8]*r[17],t[8]=e[5]*r[3]+e[6]*r[8]+e[7]*r[13]+e[8]*r[18],t[9]=e[5]*r[4]+e[6]*r[9]+e[7]*r[14]+e[8]*r[19]+e[9],t[10]=e[10]*r[0]+e[11]*r[5]+e[12]*r[10]+e[13]*r[15],t[11]=e[10]*r[1]+e[11]*r[6]+e[12]*r[11]+e[13]*r[16],t[12]=e[10]*r[2]+e[11]*r[7]+e[12]*r[12]+e[13]*r[17],t[13]=e[10]*r[3]+e[11]*r[8]+e[12]*r[13]+e[13]*r[18],t[14]=e[10]*r[4]+e[11]*r[9]+e[12]*r[14]+e[13]*r[19]+e[14],t[15]=e[15]*r[0]+e[16]*r[5]+e[17]*r[10]+e[18]*r[15],t[16]=e[15]*r[1]+e[16]*r[6]+e[17]*r[11]+e[18]*r[16],t[17]=e[15]*r[2]+e[16]*r[7]+e[17]*r[12]+e[18]*r[17],t[18]=e[15]*r[3]+e[16]*r[8]+e[17]*r[13]+e[18]*r[18],t[19]=e[15]*r[4]+e[16]*r[9]+e[17]*r[14]+e[18]*r[19]+e[19],t},e.prototype._colorMatrix=function(t){var e=new Float32Array(t);return e[4]/=255,e[9]/=255,e[14]/=255,e[19]/=255,e},e.prototype.brightness=function(t,e){var r=[t,0,0,0,0,0,t,0,0,0,0,0,t,0,0,0,0,0,1,0];this._loadMatrix(r,e)},e.prototype.tint=function(t,e){var r=[(t>>16&255)/255,0,0,0,0,0,(t>>8&255)/255,0,0,0,0,0,(255&t)/255,0,0,0,0,0,1,0];this._loadMatrix(r,e)},e.prototype.greyscale=function(t,e){var r=[t,t,t,0,0,t,t,t,0,0,t,t,t,0,0,0,0,0,1,0];this._loadMatrix(r,e)},e.prototype.blackAndWhite=function(t){this._loadMatrix([.3,.6,.1,0,0,.3,.6,.1,0,0,.3,.6,.1,0,0,0,0,0,1,0],t)},e.prototype.hue=function(t,e){t=(t||0)/180*Math.PI;var r=Math.cos(t),i=Math.sin(t),n=1/3,o=(0,Math.sqrt)(n),s=[r+(1-r)*n,n*(1-r)-o*i,n*(1-r)+o*i,0,0,n*(1-r)+o*i,r+n*(1-r),n*(1-r)-o*i,0,0,n*(1-r)-o*i,n*(1-r)+o*i,r+n*(1-r),0,0,0,0,0,1,0];this._loadMatrix(s,e)},e.prototype.contrast=function(t,e){var r=(t||0)+1,i=-.5*(r-1),n=[r,0,0,0,i,0,r,0,0,i,0,0,r,0,i,0,0,0,1,0];this._loadMatrix(n,e)},e.prototype.saturate=function(t,e){void 0===t&&(t=0);var r=2*t/3+1,i=-.5*(r-1),n=[r,i,i,0,0,i,r,i,0,0,i,i,r,0,0,0,0,0,1,0];this._loadMatrix(n,e)},e.prototype.desaturate=function(){this.saturate(-1)},e.prototype.negative=function(t){this._loadMatrix([-1,0,0,1,0,0,-1,0,1,0,0,0,-1,1,0,0,0,0,1,0],t)},e.prototype.sepia=function(t){this._loadMatrix([.393,.7689999,.18899999,0,0,.349,.6859999,.16799999,0,0,.272,.5339999,.13099999,0,0,0,0,0,1,0],t)},e.prototype.technicolor=function(t){this._loadMatrix([1.9125277891456083,-.8545344976951645,-.09155508482755585,0,11.793603434377337,-.3087833385928097,1.7658908555458428,-.10601743074722245,0,-70.35205161461398,-.231103377548616,-.7501899197440212,1.847597816108189,0,30.950940869491138,0,0,0,1,0],t)},e.prototype.polaroid=function(t){this._loadMatrix([1.438,-.062,-.062,0,0,-.122,1.378,-.122,0,0,-.016,-.016,1.483,0,0,0,0,0,1,0],t)},e.prototype.toBGR=function(t){this._loadMatrix([0,0,1,0,0,0,1,0,0,0,1,0,0,0,0,0,0,0,1,0],t)},e.prototype.kodachrome=function(t){this._loadMatrix([1.1285582396593525,-.3967382283601348,-.03992559172921793,0,63.72958762196502,-.16404339962244616,1.0835251566291304,-.05498805115633132,0,24.732407896706203,-.16786010706155763,-.5603416277695248,1.6014850761964943,0,35.62982807460946,0,0,0,1,0],t)},e.prototype.browni=function(t){this._loadMatrix([.5997023498159715,.34553243048391263,-.2708298674538042,0,47.43192855600873,-.037703249837783157,.8609577587992641,.15059552388459913,0,-36.96841498319127,.24113635128153335,-.07441037908422492,.44972182064877153,0,-7.562075277591283,0,0,0,1,0],t)},e.prototype.vintage=function(t){this._loadMatrix([.6279345635605994,.3202183420819367,-.03965408211312453,0,9.651285835294123,.02578397704808868,.6441188644374771,.03259127616149294,0,7.462829176470591,.0466055556782719,-.0851232987247891,.5241648018700465,0,5.159190588235296,0,0,0,1,0],t)},e.prototype.colorTone=function(t,e,r,i,n){var o=((r=r||16770432)>>16&255)/255,s=(r>>8&255)/255,a=(255&r)/255,h=((i=i||3375104)>>16&255)/255,u=(i>>8&255)/255,l=(255&i)/255,c=[.3,.59,.11,0,0,o,s,a,t=t||.2,0,h,u,l,e=e||.15,0,o-h,s-u,a-l,0,0];this._loadMatrix(c,n)},e.prototype.night=function(t,e){var r=[-2*(t=t||.1),-t,0,0,0,-t,0,t,0,0,0,t,2*t,0,0,0,0,0,1,0];this._loadMatrix(r,e)},e.prototype.predator=function(t,e){var r=[11.224130630493164*t,-4.794486999511719*t,-2.8746118545532227*t,0*t,.40342438220977783*t,-3.6330697536468506*t,9.193157196044922*t,-2.951810836791992*t,0*t,-1.316135048866272*t,-3.2184197902679443*t,-4.2375030517578125*t,7.476448059082031*t,0*t,.8044459223747253*t,0,0,0,1,0];this._loadMatrix(r,e)},e.prototype.lsd=function(t){this._loadMatrix([2,-.4,.5,0,0,-.5,2,-.4,0,0,-.4,-.5,3,0,0,0,0,0,1,0],t)},e.prototype.reset=function(){this._loadMatrix([1,0,0,0,0,0,1,0,0,0,0,0,1,0,0,0,0,0,1,0],!1)},Object.defineProperty(e.prototype,"matrix",{get:function(){return this.uniforms.m},set:function(t){this.uniforms.m=t},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"alpha",{get:function(){return this.uniforms.uAlpha},set:function(t){this.uniforms.uAlpha=t},enumerable:!1,configurable:!0}),e}(on);Ph.prototype.grayscale=Ph.prototype.greyscale;var Mh,Dh,Nh,wh,Ch,Lh,Fh,Uh,Bh,Gh,Xh,kh,Hh,Yh,jh,Vh,Wh,zh,qh,Kh=function(t,e){return(Kh=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r])})(t,e)},Zh="varying vec2 vFilterCoord;\nvarying vec2 vTextureCoord;\n\nuniform vec2 scale;\nuniform mat2 rotation;\nuniform sampler2D uSampler;\nuniform sampler2D mapSampler;\n\nuniform highp vec4 inputSize;\nuniform vec4 inputClamp;\n\nvoid main(void)\n{\n  vec4 map =  texture2D(mapSampler, vFilterCoord);\n\n  map -= 0.5;\n  map.xy = scale * inputSize.zw * (rotation * map.xy);\n\n  gl_FragColor = texture2D(uSampler, clamp(vec2(vTextureCoord.x + map.x, vTextureCoord.y + map.y), inputClamp.xy, inputClamp.zw));\n}\n",Qh="attribute vec2 aVertexPosition;\n\nuniform mat3 projectionMatrix;\nuniform mat3 filterMatrix;\n\nvarying vec2 vTextureCoord;\nvarying vec2 vFilterCoord;\n\nuniform vec4 inputSize;\nuniform vec4 outputFrame;\n\nvec4 filterVertexPosition( void )\n{\n    vec2 position = aVertexPosition * max(outputFrame.zw, vec2(0.)) + outputFrame.xy;\n\n    return vec4((projectionMatrix * vec3(position, 1.0)).xy, 0.0, 1.0);\n}\n\nvec2 filterTextureCoord( void )\n{\n    return aVertexPosition * (outputFrame.zw * inputSize.zw);\n}\n\nvoid main(void)\n{\n\tgl_Position = filterVertexPosition();\n\tvTextureCoord = filterTextureCoord();\n\tvFilterCoord = ( filterMatrix * vec3( vTextureCoord, 1.0)  ).xy;\n}\n",Jh=function(t){function e(e,r){var i=this,n=new Ze;return e.renderable=!1,(i=t.call(this,Qh,Zh,{mapSampler:e._texture,filterMatrix:n,scale:{x:1,y:1},rotation:new Float32Array([1,0,0,1])})||this).maskSprite=e,i.maskMatrix=n,null==r&&(r=20),i.scale=new qe(r,r),i}return function(t,e){function r(){this.constructor=t}Kh(t,e),t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)}(e,t),e.prototype.apply=function(t,e,r,i){this.uniforms.filterMatrix=t.calculateSpriteMatrix(this.maskMatrix,this.maskSprite),this.uniforms.scale.x=this.scale.x,this.uniforms.scale.y=this.scale.y;var n=this.maskSprite.worldTransform,o=Math.sqrt(n.a*n.a+n.b*n.b),s=Math.sqrt(n.c*n.c+n.d*n.d);0!==o&&0!==s&&(this.uniforms.rotation[0]=n.a/o,this.uniforms.rotation[1]=n.b/o,this.uniforms.rotation[2]=n.c/s,this.uniforms.rotation[3]=n.d/s),t.applyFilter(this,e,r,i)},Object.defineProperty(e.prototype,"map",{get:function(){return this.uniforms.mapSampler},set:function(t){this.uniforms.mapSampler=t},enumerable:!1,configurable:!0}),e}(on),$h=function(t,e){return($h=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r])})(t,e)},tu="\nattribute vec2 aVertexPosition;\n\nuniform mat3 projectionMatrix;\n\nvarying vec2 v_rgbNW;\nvarying vec2 v_rgbNE;\nvarying vec2 v_rgbSW;\nvarying vec2 v_rgbSE;\nvarying vec2 v_rgbM;\n\nvarying vec2 vFragCoord;\n\nuniform vec4 inputSize;\nuniform vec4 outputFrame;\n\nvec4 filterVertexPosition( void )\n{\n    vec2 position = aVertexPosition * max(outputFrame.zw, vec2(0.)) + outputFrame.xy;\n\n    return vec4((projectionMatrix * vec3(position, 1.0)).xy, 0.0, 1.0);\n}\n\nvoid texcoords(vec2 fragCoord, vec2 inverseVP,\n               out vec2 v_rgbNW, out vec2 v_rgbNE,\n               out vec2 v_rgbSW, out vec2 v_rgbSE,\n               out vec2 v_rgbM) {\n    v_rgbNW = (fragCoord + vec2(-1.0, -1.0)) * inverseVP;\n    v_rgbNE = (fragCoord + vec2(1.0, -1.0)) * inverseVP;\n    v_rgbSW = (fragCoord + vec2(-1.0, 1.0)) * inverseVP;\n    v_rgbSE = (fragCoord + vec2(1.0, 1.0)) * inverseVP;\n    v_rgbM = vec2(fragCoord * inverseVP);\n}\n\nvoid main(void) {\n\n   gl_Position = filterVertexPosition();\n\n   vFragCoord = aVertexPosition * outputFrame.zw;\n\n   texcoords(vFragCoord, inputSize.zw, v_rgbNW, v_rgbNE, v_rgbSW, v_rgbSE, v_rgbM);\n}\n",eu='varying vec2 v_rgbNW;\nvarying vec2 v_rgbNE;\nvarying vec2 v_rgbSW;\nvarying vec2 v_rgbSE;\nvarying vec2 v_rgbM;\n\nvarying vec2 vFragCoord;\nuniform sampler2D uSampler;\nuniform highp vec4 inputSize;\n\n\n/**\n Basic FXAA implementation based on the code on geeks3d.com with the\n modification that the texture2DLod stuff was removed since it\'s\n unsupported by WebGL.\n\n --\n\n From:\n https://github.com/mitsuhiko/webgl-meincraft\n\n Copyright (c) 2011 by Armin Ronacher.\n\n Some rights reserved.\n\n Redistribution and use in source and binary forms, with or without\n modification, are permitted provided that the following conditions are\n met:\n\n * Redistributions of source code must retain the above copyright\n notice, this list of conditions and the following disclaimer.\n\n * Redistributions in binary form must reproduce the above\n copyright notice, this list of conditions and the following\n disclaimer in the documentation and/or other materials provided\n with the distribution.\n\n * The names of the contributors may not be used to endorse or\n promote products derived from this software without specific\n prior written permission.\n\n THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS\n "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT\n LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR\n A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT\n OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,\n SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT\n LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,\n DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY\n THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT\n (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE\n OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.\n */\n\n#ifndef FXAA_REDUCE_MIN\n#define FXAA_REDUCE_MIN   (1.0/ 128.0)\n#endif\n#ifndef FXAA_REDUCE_MUL\n#define FXAA_REDUCE_MUL   (1.0 / 8.0)\n#endif\n#ifndef FXAA_SPAN_MAX\n#define FXAA_SPAN_MAX     8.0\n#endif\n\n//optimized version for mobile, where dependent\n//texture reads can be a bottleneck\nvec4 fxaa(sampler2D tex, vec2 fragCoord, vec2 inverseVP,\n          vec2 v_rgbNW, vec2 v_rgbNE,\n          vec2 v_rgbSW, vec2 v_rgbSE,\n          vec2 v_rgbM) {\n    vec4 color;\n    vec3 rgbNW = texture2D(tex, v_rgbNW).xyz;\n    vec3 rgbNE = texture2D(tex, v_rgbNE).xyz;\n    vec3 rgbSW = texture2D(tex, v_rgbSW).xyz;\n    vec3 rgbSE = texture2D(tex, v_rgbSE).xyz;\n    vec4 texColor = texture2D(tex, v_rgbM);\n    vec3 rgbM  = texColor.xyz;\n    vec3 luma = vec3(0.299, 0.587, 0.114);\n    float lumaNW = dot(rgbNW, luma);\n    float lumaNE = dot(rgbNE, luma);\n    float lumaSW = dot(rgbSW, luma);\n    float lumaSE = dot(rgbSE, luma);\n    float lumaM  = dot(rgbM,  luma);\n    float lumaMin = min(lumaM, min(min(lumaNW, lumaNE), min(lumaSW, lumaSE)));\n    float lumaMax = max(lumaM, max(max(lumaNW, lumaNE), max(lumaSW, lumaSE)));\n\n    mediump vec2 dir;\n    dir.x = -((lumaNW + lumaNE) - (lumaSW + lumaSE));\n    dir.y =  ((lumaNW + lumaSW) - (lumaNE + lumaSE));\n\n    float dirReduce = max((lumaNW + lumaNE + lumaSW + lumaSE) *\n                          (0.25 * FXAA_REDUCE_MUL), FXAA_REDUCE_MIN);\n\n    float rcpDirMin = 1.0 / (min(abs(dir.x), abs(dir.y)) + dirReduce);\n    dir = min(vec2(FXAA_SPAN_MAX, FXAA_SPAN_MAX),\n              max(vec2(-FXAA_SPAN_MAX, -FXAA_SPAN_MAX),\n                  dir * rcpDirMin)) * inverseVP;\n\n    vec3 rgbA = 0.5 * (\n                       texture2D(tex, fragCoord * inverseVP + dir * (1.0 / 3.0 - 0.5)).xyz +\n                       texture2D(tex, fragCoord * inverseVP + dir * (2.0 / 3.0 - 0.5)).xyz);\n    vec3 rgbB = rgbA * 0.5 + 0.25 * (\n                                     texture2D(tex, fragCoord * inverseVP + dir * -0.5).xyz +\n                                     texture2D(tex, fragCoord * inverseVP + dir * 0.5).xyz);\n\n    float lumaB = dot(rgbB, luma);\n    if ((lumaB < lumaMin) || (lumaB > lumaMax))\n        color = vec4(rgbA, texColor.a);\n    else\n        color = vec4(rgbB, texColor.a);\n    return color;\n}\n\nvoid main() {\n\n      vec4 color;\n\n      color = fxaa(uSampler, vFragCoord, inputSize.zw, v_rgbNW, v_rgbNE, v_rgbSW, v_rgbSE, v_rgbM);\n\n      gl_FragColor = color;\n}\n',ru=function(t){function e(){return t.call(this,tu,eu)||this}return function(t,e){function r(){this.constructor=t}$h(t,e),t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)}(e,t),e}(on),iu=function(t,e){return(iu=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r])})(t,e)},nu="precision highp float;\n\nvarying vec2 vTextureCoord;\nvarying vec4 vColor;\n\nuniform float uNoise;\nuniform float uSeed;\nuniform sampler2D uSampler;\n\nfloat rand(vec2 co)\n{\n    return fract(sin(dot(co.xy, vec2(12.9898, 78.233))) * 43758.5453);\n}\n\nvoid main()\n{\n    vec4 color = texture2D(uSampler, vTextureCoord);\n    float randomValue = rand(gl_FragCoord.xy * uSeed);\n    float diff = (randomValue - 0.5) * uNoise;\n\n    // Un-premultiply alpha before applying the color matrix. See issue #3539.\n    if (color.a > 0.0) {\n        color.rgb /= color.a;\n    }\n\n    color.r += diff;\n    color.g += diff;\n    color.b += diff;\n\n    // Premultiply alpha again.\n    color.rgb *= color.a;\n\n    gl_FragColor = color;\n}\n",ou=function(t){function e(e,r){void 0===e&&(e=.5),void 0===r&&(r=Math.random());var i=t.call(this,Kn,nu,{uNoise:0,uSeed:0})||this;return i.noise=e,i.seed=r,i}return function(t,e){function r(){this.constructor=t}iu(t,e),t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)}(e,t),Object.defineProperty(e.prototype,"noise",{get:function(){return this.uniforms.uNoise},set:function(t){this.uniforms.uNoise=t},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"seed",{get:function(){return this.uniforms.uSeed},set:function(t){this.uniforms.uSeed=t},enumerable:!1,configurable:!0}),e}(on);!function(t){t[t.WEBGL_LEGACY=0]="WEBGL_LEGACY",t[t.WEBGL=1]="WEBGL",t[t.WEBGL2=2]="WEBGL2"}(Mh||(Mh={})),function(t){t[t.UNKNOWN=0]="UNKNOWN",t[t.WEBGL=1]="WEBGL",t[t.CANVAS=2]="CANVAS"}(Dh||(Dh={})),function(t){t[t.COLOR=16384]="COLOR",t[t.DEPTH=256]="DEPTH",t[t.STENCIL=1024]="STENCIL"}(Nh||(Nh={})),function(t){t[t.NORMAL=0]="NORMAL",t[t.ADD=1]="ADD",t[t.MULTIPLY=2]="MULTIPLY",t[t.SCREEN=3]="SCREEN",t[t.OVERLAY=4]="OVERLAY",t[t.DARKEN=5]="DARKEN",t[t.LIGHTEN=6]="LIGHTEN",t[t.COLOR_DODGE=7]="COLOR_DODGE",t[t.COLOR_BURN=8]="COLOR_BURN",t[t.HARD_LIGHT=9]="HARD_LIGHT",t[t.SOFT_LIGHT=10]="SOFT_LIGHT",t[t.DIFFERENCE=11]="DIFFERENCE",t[t.EXCLUSION=12]="EXCLUSION",t[t.HUE=13]="HUE",t[t.SATURATION=14]="SATURATION",t[t.COLOR=15]="COLOR",t[t.LUMINOSITY=16]="LUMINOSITY",t[t.NORMAL_NPM=17]="NORMAL_NPM",t[t.ADD_NPM=18]="ADD_NPM",t[t.SCREEN_NPM=19]="SCREEN_NPM",t[t.NONE=20]="NONE",t[t.SRC_OVER=0]="SRC_OVER",t[t.SRC_IN=21]="SRC_IN",t[t.SRC_OUT=22]="SRC_OUT",t[t.SRC_ATOP=23]="SRC_ATOP",t[t.DST_OVER=24]="DST_OVER",t[t.DST_IN=25]="DST_IN",t[t.DST_OUT=26]="DST_OUT",t[t.DST_ATOP=27]="DST_ATOP",t[t.ERASE=26]="ERASE",t[t.SUBTRACT=28]="SUBTRACT",t[t.XOR=29]="XOR"}(wh||(wh={})),function(t){t[t.POINTS=0]="POINTS",t[t.LINES=1]="LINES",t[t.LINE_LOOP=2]="LINE_LOOP",t[t.LINE_STRIP=3]="LINE_STRIP",t[t.TRIANGLES=4]="TRIANGLES",t[t.TRIANGLE_STRIP=5]="TRIANGLE_STRIP",t[t.TRIANGLE_FAN=6]="TRIANGLE_FAN"}(Ch||(Ch={})),function(t){t[t.RGBA=6408]="RGBA",t[t.RGB=6407]="RGB",t[t.RG=33319]="RG",t[t.RED=6403]="RED",t[t.RGBA_INTEGER=36249]="RGBA_INTEGER",t[t.RGB_INTEGER=36248]="RGB_INTEGER",t[t.RG_INTEGER=33320]="RG_INTEGER",t[t.RED_INTEGER=36244]="RED_INTEGER",t[t.ALPHA=6406]="ALPHA",t[t.LUMINANCE=6409]="LUMINANCE",t[t.LUMINANCE_ALPHA=6410]="LUMINANCE_ALPHA",t[t.DEPTH_COMPONENT=6402]="DEPTH_COMPONENT",t[t.DEPTH_STENCIL=34041]="DEPTH_STENCIL"}(Lh||(Lh={})),function(t){t[t.TEXTURE_2D=3553]="TEXTURE_2D",t[t.TEXTURE_CUBE_MAP=34067]="TEXTURE_CUBE_MAP",t[t.TEXTURE_2D_ARRAY=35866]="TEXTURE_2D_ARRAY",t[t.TEXTURE_CUBE_MAP_POSITIVE_X=34069]="TEXTURE_CUBE_MAP_POSITIVE_X",t[t.TEXTURE_CUBE_MAP_NEGATIVE_X=34070]="TEXTURE_CUBE_MAP_NEGATIVE_X",t[t.TEXTURE_CUBE_MAP_POSITIVE_Y=34071]="TEXTURE_CUBE_MAP_POSITIVE_Y",t[t.TEXTURE_CUBE_MAP_NEGATIVE_Y=34072]="TEXTURE_CUBE_MAP_NEGATIVE_Y",t[t.TEXTURE_CUBE_MAP_POSITIVE_Z=34073]="TEXTURE_CUBE_MAP_POSITIVE_Z",t[t.TEXTURE_CUBE_MAP_NEGATIVE_Z=34074]="TEXTURE_CUBE_MAP_NEGATIVE_Z"}(Fh||(Fh={})),function(t){t[t.UNSIGNED_BYTE=5121]="UNSIGNED_BYTE",t[t.UNSIGNED_SHORT=5123]="UNSIGNED_SHORT",t[t.UNSIGNED_SHORT_5_6_5=33635]="UNSIGNED_SHORT_5_6_5",t[t.UNSIGNED_SHORT_4_4_4_4=32819]="UNSIGNED_SHORT_4_4_4_4",t[t.UNSIGNED_SHORT_5_5_5_1=32820]="UNSIGNED_SHORT_5_5_5_1",t[t.UNSIGNED_INT=5125]="UNSIGNED_INT",t[t.UNSIGNED_INT_10F_11F_11F_REV=35899]="UNSIGNED_INT_10F_11F_11F_REV",t[t.UNSIGNED_INT_2_10_10_10_REV=33640]="UNSIGNED_INT_2_10_10_10_REV",t[t.UNSIGNED_INT_24_8=34042]="UNSIGNED_INT_24_8",t[t.UNSIGNED_INT_5_9_9_9_REV=35902]="UNSIGNED_INT_5_9_9_9_REV",t[t.BYTE=5120]="BYTE",t[t.SHORT=5122]="SHORT",t[t.INT=5124]="INT",t[t.FLOAT=5126]="FLOAT",t[t.FLOAT_32_UNSIGNED_INT_24_8_REV=36269]="FLOAT_32_UNSIGNED_INT_24_8_REV",t[t.HALF_FLOAT=36193]="HALF_FLOAT"}(Uh||(Uh={})),function(t){t[t.FLOAT=0]="FLOAT",t[t.INT=1]="INT",t[t.UINT=2]="UINT"}(Bh||(Bh={})),function(t){t[t.NEAREST=0]="NEAREST",t[t.LINEAR=1]="LINEAR"}(Gh||(Gh={})),function(t){t[t.CLAMP=33071]="CLAMP",t[t.REPEAT=10497]="REPEAT",t[t.MIRRORED_REPEAT=33648]="MIRRORED_REPEAT"}(Xh||(Xh={})),function(t){t[t.OFF=0]="OFF",t[t.POW2=1]="POW2",t[t.ON=2]="ON",t[t.ON_MANUAL=3]="ON_MANUAL"}(kh||(kh={})),function(t){t[t.NPM=0]="NPM",t[t.UNPACK=1]="UNPACK",t[t.PMA=2]="PMA",t[t.NO_PREMULTIPLIED_ALPHA=0]="NO_PREMULTIPLIED_ALPHA",t[t.PREMULTIPLY_ON_UPLOAD=1]="PREMULTIPLY_ON_UPLOAD",t[t.PREMULTIPLY_ALPHA=2]="PREMULTIPLY_ALPHA"}(Hh||(Hh={})),function(t){t[t.NO=0]="NO",t[t.YES=1]="YES",t[t.AUTO=2]="AUTO",t[t.BLEND=0]="BLEND",t[t.CLEAR=1]="CLEAR",t[t.BLIT=2]="BLIT"}(Yh||(Yh={})),function(t){t[t.AUTO=0]="AUTO",t[t.MANUAL=1]="MANUAL"}(jh||(jh={})),function(t){t.LOW="lowp",t.MEDIUM="mediump",t.HIGH="highp"}(Vh||(Vh={})),function(t){t[t.NONE=0]="NONE",t[t.SCISSOR=1]="SCISSOR",t[t.STENCIL=2]="STENCIL",t[t.SPRITE=3]="SPRITE"}(Wh||(Wh={})),function(t){t[t.NONE=0]="NONE",t[t.LOW=2]="LOW",t[t.MEDIUM=4]="MEDIUM",t[t.HIGH=8]="HIGH"}(zh||(zh={})),function(t){t[t.ELEMENT_ARRAY_BUFFER=34963]="ELEMENT_ARRAY_BUFFER",t[t.ARRAY_BUFFER=34962]="ARRAY_BUFFER",t[t.UNIFORM_BUFFER=35345]="UNIFORM_BUFFER"}(qh||(qh={}));var su=new Ze;ur.prototype._cacheAsBitmap=!1,ur.prototype._cacheData=null,ur.prototype._cacheAsBitmapResolution=null,ur.prototype._cacheAsBitmapMultisample=zh.NONE;var au=function(){this.textureCacheId=null,this.originalRender=null,this.originalRenderCanvas=null,this.originalCalculateBounds=null,this.originalGetLocalBounds=null,this.originalUpdateTransform=null,this.originalDestroy=null,this.originalMask=null,this.originalFilterArea=null,this.originalContainsPoint=null,this.sprite=null};Object.defineProperties(ur.prototype,{cacheAsBitmapResolution:{get:function(){return this._cacheAsBitmapResolution},set:function(t){t!==this._cacheAsBitmapResolution&&(this._cacheAsBitmapResolution=t,this.cacheAsBitmap&&(this.cacheAsBitmap=!1,this.cacheAsBitmap=!0))}},cacheAsBitmapMultisample:{get:function(){return this._cacheAsBitmapMultisample},set:function(t){t!==this._cacheAsBitmapMultisample&&(this._cacheAsBitmapMultisample=t,this.cacheAsBitmap&&(this.cacheAsBitmap=!1,this.cacheAsBitmap=!0))}},cacheAsBitmap:{get:function(){return this._cacheAsBitmap},set:function(t){var e;this._cacheAsBitmap!==t&&(this._cacheAsBitmap=t,t?(this._cacheData||(this._cacheData=new au),(e=this._cacheData).originalRender=this.render,e.originalRenderCanvas=this.renderCanvas,e.originalUpdateTransform=this.updateTransform,e.originalCalculateBounds=this.calculateBounds,e.originalGetLocalBounds=this.getLocalBounds,e.originalDestroy=this.destroy,e.originalContainsPoint=this.containsPoint,e.originalMask=this._mask,e.originalFilterArea=this.filterArea,this.render=this._renderCached,this.renderCanvas=this._renderCachedCanvas,this.destroy=this._cacheAsBitmapDestroy):((e=this._cacheData).sprite&&this._destroyCachedDisplayObject(),this.render=e.originalRender,this.renderCanvas=e.originalRenderCanvas,this.calculateBounds=e.originalCalculateBounds,this.getLocalBounds=e.originalGetLocalBounds,this.destroy=e.originalDestroy,this.updateTransform=e.originalUpdateTransform,this.containsPoint=e.originalContainsPoint,this._mask=e.originalMask,this.filterArea=e.originalFilterArea))}}}),ur.prototype._renderCached=function(t){!this.visible||this.worldAlpha<=0||!this.renderable||(this._initCachedDisplayObject(t),this._cacheData.sprite.transform._worldID=this.transform._worldID,this._cacheData.sprite.worldAlpha=this.worldAlpha,this._cacheData.sprite._render(t))},ur.prototype._initCachedDisplayObject=function(t){var e;if(!this._cacheData||!this._cacheData.sprite){var r=this.alpha;this.alpha=1,t.batch.flush();var i=this.getLocalBounds(null,!0).clone();if(this.filters){var n=this.filters[0].padding;i.pad(n)}i.ceil(rt.RESOLUTION);var o=t.renderTexture.current,s=t.renderTexture.sourceFrame.clone(),a=t.renderTexture.destinationFrame.clone(),h=t.projection.transform,u=ni.create({width:i.width,height:i.height,resolution:this.cacheAsBitmapResolution||t.resolution,multisample:null!==(e=this.cacheAsBitmapMultisample)&&void 0!==e?e:t.multisample}),l="cacheAsBitmap_"+Ie();this._cacheData.textureCacheId=l,Xr.addToCache(u.baseTexture,l),ri.addToCache(u,l);var c=this.transform.localTransform.copyTo(su).invert().translate(-i.x,-i.y);this.render=this._cacheData.originalRender,t.render(this,{renderTexture:u,clear:!0,transform:c,skipUpdateTransform:!1}),t.framebuffer.blit(),t.projection.transform=h,t.renderTexture.bind(o,s,a),this.render=this._renderCached,this.updateTransform=this.displayObjectUpdateTransform,this.calculateBounds=this._calculateCachedBounds,this.getLocalBounds=this._getCachedLocalBounds,this._mask=null,this.filterArea=null,this.alpha=r;var d=new Vs(u);d.transform.worldTransform=this.transform.worldTransform,d.anchor.x=-i.x/i.width,d.anchor.y=-i.y/i.height,d.alpha=r,d._bounds=this._bounds,this._cacheData.sprite=d,this.transform._parentID=-1,this.parent?this.updateTransform():(this.enableTempParent(),this.updateTransform(),this.disableTempParent(null)),this.containsPoint=d.containsPoint.bind(d)}},ur.prototype._renderCachedCanvas=function(t){!this.visible||this.worldAlpha<=0||!this.renderable||(this._initCachedDisplayObjectCanvas(t),this._cacheData.sprite.worldAlpha=this.worldAlpha,this._cacheData.sprite._renderCanvas(t))},ur.prototype._initCachedDisplayObjectCanvas=function(t){if(!this._cacheData||!this._cacheData.sprite){var e=this.getLocalBounds(null,!0),r=this.alpha;this.alpha=1;var i=t.context,n=t._projTransform;e.ceil(rt.RESOLUTION);var o=ni.create({width:e.width,height:e.height}),s="cacheAsBitmap_"+Ie();this._cacheData.textureCacheId=s,Xr.addToCache(o.baseTexture,s),ri.addToCache(o,s);var a=su;this.transform.localTransform.copyTo(a),a.invert(),a.tx-=e.x,a.ty-=e.y,this.renderCanvas=this._cacheData.originalRenderCanvas,t.render(this,{renderTexture:o,clear:!0,transform:a,skipUpdateTransform:!1}),t.context=i,t._projTransform=n,this.renderCanvas=this._renderCachedCanvas,this.updateTransform=this.displayObjectUpdateTransform,this.calculateBounds=this._calculateCachedBounds,this.getLocalBounds=this._getCachedLocalBounds,this._mask=null,this.filterArea=null,this.alpha=r;var h=new Vs(o);h.transform.worldTransform=this.transform.worldTransform,h.anchor.x=-e.x/e.width,h.anchor.y=-e.y/e.height,h.alpha=r,h._bounds=this._bounds,this._cacheData.sprite=h,this.transform._parentID=-1,this.parent?this.updateTransform():(this.parent=t._tempDisplayObjectParent,this.updateTransform(),this.parent=null),this.containsPoint=h.containsPoint.bind(h)}},ur.prototype._calculateCachedBounds=function(){this._bounds.clear(),this._cacheData.sprite.transform._worldID=this.transform._worldID,this._cacheData.sprite._calculateBounds(),this._bounds.updateID=this._boundsID},ur.prototype._getCachedLocalBounds=function(){return this._cacheData.sprite.getLocalBounds(null)},ur.prototype._destroyCachedDisplayObject=function(){this._cacheData.sprite._texture.destroy(!0),this._cacheData.sprite=null,Xr.removeFromCache(this._cacheData.textureCacheId),ri.removeFromCache(this._cacheData.textureCacheId),this._cacheData.textureCacheId=null},ur.prototype._cacheAsBitmapDestroy=function(t){this.cacheAsBitmap=!1,this.destroy(t)},ur.prototype.name=null,dr.prototype.getChildByName=function(t,e){for(var r=0,i=this.children.length;r<i;r++)if(this.children[r].name===t)return this.children[r];if(e)for(r=0,i=this.children.length;r<i;r++)if(this.children[r].getChildByName){var n=this.children[r].getChildByName(t,!0);if(n)return n}return null},ur.prototype.getGlobalPosition=function(t,e){return void 0===t&&(t=new qe),void 0===e&&(e=!1),this.parent?this.parent.toGlobal(this.position,t,e):(t.x=this.position.x,t.y=this.position.y),t};var hu=function(t,e){return(hu=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r])})(t,e)};function uu(t,e){function r(){this.constructor=t}hu(t,e),t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)}var lu=function(t){function e(e,r,i,n){void 0===e&&(e=100),void 0===r&&(r=100),void 0===i&&(i=10),void 0===n&&(n=10);var o=t.call(this)||this;return o.segWidth=i,o.segHeight=n,o.width=e,o.height=r,o.build(),o}return uu(e,t),e.prototype.build=function(){for(var t=this.segWidth*this.segHeight,e=[],r=[],i=[],n=this.segWidth-1,o=this.segHeight-1,s=this.width/n,a=this.height/o,h=0;h<t;h++){var u=h%this.segWidth,l=h/this.segWidth|0;e.push(u*s,l*a),r.push(u/n,l/o)}var c=n*o;for(h=0;h<c;h++){var d=h%n,f=h/n|0,p=f*this.segWidth+d,_=f*this.segWidth+d+1,m=(f+1)*this.segWidth+d,v=(f+1)*this.segWidth+d+1;i.push(p,_,m,_,v,m)}this.buffers[0].data=new Float32Array(e),this.buffers[1].data=new Float32Array(r),this.indexBuffer.data=new Uint16Array(i),this.buffers[0].update(),this.buffers[1].update(),this.indexBuffer.update()},e}(Ba),cu=function(t){function e(e,r,i){void 0===e&&(e=200),void 0===i&&(i=0);var n=t.call(this,new Float32Array(4*r.length),new Float32Array(4*r.length),new Uint16Array(6*(r.length-1)))||this;return n.points=r,n._width=e,n.textureScale=i,n.build(),n}return uu(e,t),Object.defineProperty(e.prototype,"width",{get:function(){return this._width},enumerable:!1,configurable:!0}),e.prototype.build=function(){var t=this.points;if(t){var e=this.getBuffer("aVertexPosition"),r=this.getBuffer("aTextureCoord"),i=this.getIndex();if(!(t.length<1)){e.data.length/4!==t.length&&(e.data=new Float32Array(4*t.length),r.data=new Float32Array(4*t.length),i.data=new Uint16Array(6*(t.length-1)));var n=r.data,o=i.data;n[0]=0,n[1]=0,n[2]=0,n[3]=1;for(var s=0,a=t[0],h=this._width*this.textureScale,u=t.length,l=0;l<u;l++){var c=4*l;if(this.textureScale>0){var d=a.x-t[l].x,f=a.y-t[l].y,p=Math.sqrt(d*d+f*f);a=t[l],s+=p/h}else s=l/(u-1);n[c]=s,n[c+1]=0,n[c+2]=s,n[c+3]=1}var _=0;for(l=0;l<u-1;l++)c=2*l,o[_++]=c,o[_++]=c+1,o[_++]=c+2,o[_++]=c+2,o[_++]=c+1,o[_++]=c+3;r.update(),i.update(),this.updateVertices()}}},e.prototype.updateVertices=function(){var t=this.points;if(!(t.length<1)){for(var e,r=t[0],i=0,n=0,o=this.buffers[0].data,s=t.length,a=0;a<s;a++){var h=t[a],u=4*a;n=-((e=a<t.length-1?t[a+1]:h).x-r.x),i=e.y-r.y;var l=Math.sqrt(i*i+n*n),c=this.textureScale>0?this.textureScale*this._width/2:this._width/2;i/=l,n/=l,i*=c,n*=c,o[u]=h.x+i,o[u+1]=h.y+n,o[u+2]=h.x-i,o[u+3]=h.y-n,r=h}this.buffers[0].update()}},e.prototype.update=function(){this.textureScale>0?this.build():this.updateVertices()},e}(Ba),du=function(e){function r(r,i,n){void 0===n&&(n=0);var o=this,s=new cu(r.height,i,n),a=new Ua(r);return n>0&&(r.baseTexture.wrapMode=t.WRAP_MODES.REPEAT),(o=e.call(this,s,a)||this).autoUpdate=!0,o}return uu(r,e),r.prototype._render=function(t){var r=this.geometry;(this.autoUpdate||r._width!==this.shader.texture.height)&&(r._width=this.shader.texture.height,r.update()),e.prototype._render.call(this,t)},r}(Ca),fu=function(t){function e(e,r,i){var n=this,o=new lu(e.width,e.height,r,i),s=new Ua(ri.WHITE);return(n=t.call(this,o,s)||this).texture=e,n.autoResize=!0,n}return uu(e,t),e.prototype.textureUpdated=function(){this._textureID=this.shader.texture._updateID;var t=this.geometry,e=this.shader.texture,r=e.width,i=e.height;!this.autoResize||t.width===r&&t.height===i||(t.width=this.shader.texture.width,t.height=this.shader.texture.height,t.build())},Object.defineProperty(e.prototype,"texture",{get:function(){return this.shader.texture},set:function(t){this.shader.texture!==t&&(this.shader.texture=t,this._textureID=-1,t.baseTexture.valid?this.textureUpdated():t.once("update",this.textureUpdated,this))},enumerable:!1,configurable:!0}),e.prototype._render=function(e){this._textureID!==this.shader.texture._updateID&&this.textureUpdated(),t.prototype._render.call(this,e)},e.prototype.destroy=function(e){this.shader.texture.off("update",this.textureUpdated,this),t.prototype.destroy.call(this,e)},e}(Ca),pu=function(t){function e(e,r,i,n,o){void 0===e&&(e=ri.EMPTY);var s=this,a=new Ba(r,i,n);a.getBuffer("aVertexPosition").static=!1;var h=new Ua(e);return(s=t.call(this,a,h,null,o)||this).autoUpdate=!0,s}return uu(e,t),Object.defineProperty(e.prototype,"vertices",{get:function(){return this.geometry.getBuffer("aVertexPosition").data},set:function(t){this.geometry.getBuffer("aVertexPosition").data=t},enumerable:!1,configurable:!0}),e.prototype._render=function(e){this.autoUpdate&&this.geometry.getBuffer("aVertexPosition").update(),t.prototype._render.call(this,e)},e}(Ca),_u=10,mu=function(t){function e(e,r,i,n,o){void 0===r&&(r=_u),void 0===i&&(i=_u),void 0===n&&(n=_u),void 0===o&&(o=_u);var s=t.call(this,ri.WHITE,4,4)||this;return s._origWidth=e.orig.width,s._origHeight=e.orig.height,s._width=s._origWidth,s._height=s._origHeight,s._leftWidth=r,s._rightWidth=n,s._topHeight=i,s._bottomHeight=o,s.texture=e,s}return uu(e,t),e.prototype.textureUpdated=function(){this._textureID=this.shader.texture._updateID,this._refresh()},Object.defineProperty(e.prototype,"vertices",{get:function(){return this.geometry.getBuffer("aVertexPosition").data},set:function(t){this.geometry.getBuffer("aVertexPosition").data=t},enumerable:!1,configurable:!0}),e.prototype.updateHorizontalVertices=function(){var t=this.vertices,e=this._getMinScale();t[9]=t[11]=t[13]=t[15]=this._topHeight*e,t[17]=t[19]=t[21]=t[23]=this._height-this._bottomHeight*e,t[25]=t[27]=t[29]=t[31]=this._height},e.prototype.updateVerticalVertices=function(){var t=this.vertices,e=this._getMinScale();t[2]=t[10]=t[18]=t[26]=this._leftWidth*e,t[4]=t[12]=t[20]=t[28]=this._width-this._rightWidth*e,t[6]=t[14]=t[22]=t[30]=this._width},e.prototype._getMinScale=function(){var t=this._leftWidth+this._rightWidth,e=this._width>t?1:this._width/t,r=this._topHeight+this._bottomHeight,i=this._height>r?1:this._height/r;return Math.min(e,i)},Object.defineProperty(e.prototype,"width",{get:function(){return this._width},set:function(t){this._width=t,this._refresh()},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"height",{get:function(){return this._height},set:function(t){this._height=t,this._refresh()},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"leftWidth",{get:function(){return this._leftWidth},set:function(t){this._leftWidth=t,this._refresh()},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"rightWidth",{get:function(){return this._rightWidth},set:function(t){this._rightWidth=t,this._refresh()},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"topHeight",{get:function(){return this._topHeight},set:function(t){this._topHeight=t,this._refresh()},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"bottomHeight",{get:function(){return this._bottomHeight},set:function(t){this._bottomHeight=t,this._refresh()},enumerable:!1,configurable:!0}),e.prototype._refresh=function(){var t=this.texture,e=this.geometry.buffers[1].data;this._origWidth=t.orig.width,this._origHeight=t.orig.height;var r=1/this._origWidth,i=1/this._origHeight;e[0]=e[8]=e[16]=e[24]=0,e[1]=e[3]=e[5]=e[7]=0,e[6]=e[14]=e[22]=e[30]=1,e[25]=e[27]=e[29]=e[31]=1,e[2]=e[10]=e[18]=e[26]=r*this._leftWidth,e[4]=e[12]=e[20]=e[28]=1-r*this._rightWidth,e[9]=e[11]=e[13]=e[15]=i*this._topHeight,e[17]=e[19]=e[21]=e[23]=1-i*this._bottomHeight,this.updateHorizontalVertices(),this.updateVerticalVertices(),this.geometry.buffers[0].update(),this.geometry.buffers[1].update()},e}(fu),vu=function(t,e){return(vu=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r])})(t,e)},yu=function(e){function r(t,r){void 0===r&&(r=!0);var i=e.call(this,t[0]instanceof ri?t[0]:t[0].texture)||this;return i._textures=null,i._durations=null,i._autoUpdate=r,i._isConnectedToTicker=!1,i.animationSpeed=1,i.loop=!0,i.updateAnchor=!1,i.onComplete=null,i.onFrameChange=null,i.onLoop=null,i._currentTime=0,i._playing=!1,i._previousFrame=null,i.textures=t,i}return function(t,e){function r(){this.constructor=t}vu(t,e),t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)}(r,e),r.prototype.stop=function(){this._playing&&(this._playing=!1,this._autoUpdate&&this._isConnectedToTicker&&(gr.shared.remove(this.update,this),this._isConnectedToTicker=!1))},r.prototype.play=function(){this._playing||(this._playing=!0,this._autoUpdate&&!this._isConnectedToTicker&&(gr.shared.add(this.update,this,t.UPDATE_PRIORITY.HIGH),this._isConnectedToTicker=!0))},r.prototype.gotoAndStop=function(t){this.stop();var e=this.currentFrame;this._currentTime=t,e!==this.currentFrame&&this.updateTexture()},r.prototype.gotoAndPlay=function(t){var e=this.currentFrame;this._currentTime=t,e!==this.currentFrame&&this.updateTexture(),this.play()},r.prototype.update=function(t){if(this._playing){var e=this.animationSpeed*t,r=this.currentFrame;if(null!==this._durations){var i=this._currentTime%1*this._durations[this.currentFrame];for(i+=e/60*1e3;i<0;)this._currentTime--,i+=this._durations[this.currentFrame];var n=Math.sign(this.animationSpeed*t);for(this._currentTime=Math.floor(this._currentTime);i>=this._durations[this.currentFrame];)i-=this._durations[this.currentFrame]*n,this._currentTime+=n;this._currentTime+=i/this._durations[this.currentFrame]}else this._currentTime+=e;this._currentTime<0&&!this.loop?(this.gotoAndStop(0),this.onComplete&&this.onComplete()):this._currentTime>=this._textures.length&&!this.loop?(this.gotoAndStop(this._textures.length-1),this.onComplete&&this.onComplete()):r!==this.currentFrame&&(this.loop&&this.onLoop&&(this.animationSpeed>0&&this.currentFrame<r?this.onLoop():this.animationSpeed<0&&this.currentFrame>r&&this.onLoop()),this.updateTexture())}},r.prototype.updateTexture=function(){var t=this.currentFrame;this._previousFrame!==t&&(this._previousFrame=t,this._texture=this._textures[t],this._textureID=-1,this._textureTrimmedID=-1,this._cachedTint=16777215,this.uvs=this._texture._uvs.uvsFloat32,this.updateAnchor&&this._anchor.copyFrom(this._texture.defaultAnchor),this.onFrameChange&&this.onFrameChange(this.currentFrame))},r.prototype.destroy=function(t){this.stop(),e.prototype.destroy.call(this,t),this.onComplete=null,this.onFrameChange=null,this.onLoop=null},r.fromFrames=function(t){for(var e=[],i=0;i<t.length;++i)e.push(ri.from(t[i]));return new r(e)},r.fromImages=function(t){for(var e=[],i=0;i<t.length;++i)e.push(ri.from(t[i]));return new r(e)},Object.defineProperty(r.prototype,"totalFrames",{get:function(){return this._textures.length},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"textures",{get:function(){return this._textures},set:function(t){if(t[0]instanceof ri)this._textures=t,this._durations=null;else{this._textures=[],this._durations=[];for(var e=0;e<t.length;e++)this._textures.push(t[e].texture),this._durations.push(t[e].time)}this._previousFrame=null,this.gotoAndStop(0),this.updateTexture()},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"currentFrame",{get:function(){var t=Math.floor(this._currentTime)%this._textures.length;return t<0&&(t+=this._textures.length),t},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"playing",{get:function(){return this._playing},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"autoUpdate",{get:function(){return this._autoUpdate},set:function(t){t!==this._autoUpdate&&(this._autoUpdate=t,!this._autoUpdate&&this._isConnectedToTicker?(gr.shared.remove(this.update,this),this._isConnectedToTicker=!1):this._autoUpdate&&!this._isConnectedToTicker&&this._playing&&(gr.shared.add(this.update,this),this._isConnectedToTicker=!0))},enumerable:!1,configurable:!0}),r}(Vs);Wn.registerPlugin("accessibility",yr),Wn.registerPlugin("extract",mo),Wn.registerPlugin("interaction",Mr),Wn.registerPlugin("particle",ls),Wn.registerPlugin("prepare",ma),Wn.registerPlugin("batch",so),Wn.registerPlugin("tilingSprite",Ia),Do.registerPlugin(Qa),Do.registerPlugin(Yo),Do.registerPlugin(Jo),Do.registerPlugin(is),Do.registerPlugin(Ea),fo.registerPlugin(Tr),fo.registerPlugin(wo);var Eu={AlphaFilter:th,BlurFilter:Sh,BlurFilterPass:Ah,ColorMatrixFilter:Ph,DisplacementFilter:Jh,FXAAFilter:ru,NoiseFilter:ou};return t.AbstractBatchRenderer=to,t.AbstractMultiResource=kr,t.AbstractRenderer=Yn,t.AccessibilityManager=yr,t.AnimatedSprite=yu,t.AppLoaderPlugin=wo,t.Application=fo,t.ArrayResource=Hr,t.Attribute=si,t.BaseImageResource=Yr,t.BasePrepare=da,t.BaseRenderTexture=$r,t.BaseTexture=Xr,t.BatchDrawCall=Qn,t.BatchGeometry=ro,t.BatchPluginFactory=oo,t.BatchRenderer=so,t.BatchShaderGenerator=eo,t.BatchSystem=Ri,t.BatchTextureArray=Jn,t.BitmapFont=za,t.BitmapFontData=Xa,t.BitmapFontLoader=Qa,t.BitmapText=Za,t.BlobResource=ko,t.Bounds=sr,t.Buffer=hi,t.BufferResource=Br,t.CanvasResource=jr,t.Circle=je,t.CompressedTextureLoader=Yo,t.CompressedTextureResource=Ho,t.Container=dr,t.ContextSystem=Ai,t.CountLimiter=na,t.CubeResource=Vr,t.DDSLoader=Jo,t.DEG_TO_RAD=He,t.DisplayObject=ur,t.Ellipse=Ve,t.Extract=mo,t.FORMATS_TO_COMPONENTS=es,t.FillStyle=ds,t.Filter=on,t.FilterState=yi,t.FilterSystem=Ti,t.Framebuffer=Jr,t.FramebufferSystem=Ii,t.GLFramebuffer=Si,t.GLProgram=Sn,t.GLTexture=Gn,t.GRAPHICS_CURVES=cs,t.Geometry=fi,t.GeometrySystem=Mi,t.Graphics=Xs,t.GraphicsData=ws,t.GraphicsGeometry=Fs,t.IGLUniformData=An,t.INSTALLED=Nr,t.INTERNAL_FORMAT_TO_BYTES_PER_PIXEL=Fo,t.ImageBitmapResource=Kr,t.ImageResource=Wr,t.InteractionData=br,t.InteractionEvent=xr,t.InteractionManager=Mr,t.InteractionTrackingData=Ar,t.KTXLoader=is,t.LineStyle=Us,t.Loader=Do,t.MaskData=Di,t.MaskSystem=cn,t.Matrix=Ze,t.Mesh=Ca,t.MeshBatchUvs=Da,t.MeshGeometry=Ba,t.MeshMaterial=Ua,t.NineSlicePlane=mu,t.ObjectRenderer=bi,t.ObservablePoint=Ke,t.PI_2=Xe,t.ParticleContainer=ss,t.ParticleRenderer=ls,t.PlaneGeometry=lu,t.Point=qe,t.Polygon=We,t.Prepare=ma,t.Program=en,t.ProjectionSystem=_n,t.Quad=pi,t.QuadUv=_i,t.RAD_TO_DEG=ke,t.Rectangle=Ye,t.RenderTexture=ni,t.RenderTexturePool=oi,t.RenderTextureSystem=yn,t.Renderer=Wn,t.Resource=Ur,t.RopeGeometry=cu,t.RoundedRectangle=ze,t.Runner=Dr,t.SVGResource=zr,t.ScissorSystem=fn,t.Shader=rn,t.ShaderSystem=Mn,t.SimpleMesh=pu,t.SimplePlane=fu,t.SimpleRope=du,t.Sprite=Vs,t.SpriteMaskFilter=ln,t.Spritesheet=ya,t.SpritesheetLoader=Ea,t.State=nn,t.StateSystem=Un,t.StencilSystem=pn,t.System=Zn,t.TYPES_TO_BYTES_PER_COMPONENT=ts,t.TYPES_TO_BYTES_PER_PIXEL=rs,t.TemporaryDisplayObject=lr,t.Text=ra,t.TextMetrics=$s,t.TextStyle=Ks,t.Texture=ri,t.TextureGCSystem=Bn,t.TextureLoader=Co,t.TextureMatrix=un,t.TextureSystem=Xn,t.TextureUvs=ti,t.Ticker=gr,t.TickerPlugin=Tr,t.TilingSprite=Ra,t.TilingSpriteRenderer=Ia,t.TimeLimiter=va,t.Transform=or,t.UniformGroup=vi,t.VERSION="6.1.3",t.VideoResource=qr,t.ViewableBuffer=$n,t.accessibleTarget=fr,t.autoDetectRenderer=zn,t.autoDetectResource=wr,t.checkMaxIfStatementsInShader=Ji,t.createUBOElements=bn,t.defaultFilterVertex=Kn,t.defaultVertex=qn,t.filters=Eu,t.generateProgram=On,t.generateUniformBufferSync=xn,t.getTestContext=Gi,t.getUBOData=Rn,t.graphicsUtils=ks,t.groupD8=nr,t.interactiveTarget=Or,t.isMobile=et,t.resources=ao,t.settings=rt,t.systems=lo,t.uniformParsers=zi,t.utils=Ge,t}({});
//# sourceMappingURL=pixi.min.js.map


/*!
 * pixi-filters - v3.1.0
 * Compiled Wed, 11 Mar 2020 20:38:18 UTC
 *
 * pixi-filters is licensed under the MIT License.
 * http://www.opensource.org/licenses/mit-license
 */
var __filters=function(e,t,n,r,o,i,l,s){"use strict";var a="attribute vec2 aVertexPosition;\nattribute vec2 aTextureCoord;\n\nuniform mat3 projectionMatrix;\n\nvarying vec2 vTextureCoord;\n\nvoid main(void)\n{\n    gl_Position = vec4((projectionMatrix * vec3(aVertexPosition, 1.0)).xy, 0.0, 1.0);\n    vTextureCoord = aTextureCoord;\n}",u="varying vec2 vTextureCoord;\nuniform sampler2D uSampler;\n\nuniform float gamma;\nuniform float contrast;\nuniform float saturation;\nuniform float brightness;\nuniform float red;\nuniform float green;\nuniform float blue;\nuniform float alpha;\n\nvoid main(void)\n{\n    vec4 c = texture2D(uSampler, vTextureCoord);\n\n    if (c.a > 0.0) {\n        c.rgb /= c.a;\n\n        vec3 rgb = pow(c.rgb, vec3(1. / gamma));\n        rgb = mix(vec3(.5), mix(vec3(dot(vec3(.2125, .7154, .0721), rgb)), rgb, saturation), contrast);\n        rgb.r *= red;\n        rgb.g *= green;\n        rgb.b *= blue;\n        c.rgb = rgb * brightness;\n\n        c.rgb *= c.a;\n    }\n\n    gl_FragColor = c * alpha;\n}\n",c=function(e){function t(t){e.call(this,a,u),Object.assign(this,{gamma:1,saturation:1,contrast:1,brightness:1,red:1,green:1,blue:1,alpha:1},t)}return e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t,t.prototype.apply=function(e,t,n,r){this.uniforms.gamma=Math.max(this.gamma,1e-4),this.uniforms.saturation=this.saturation,this.uniforms.contrast=this.contrast,this.uniforms.brightness=this.brightness,this.uniforms.red=this.red,this.uniforms.green=this.green,this.uniforms.blue=this.blue,this.uniforms.alpha=this.alpha,e.applyFilter(this,t,n,r)},t}(t.Filter),f=a,h="\nvarying vec2 vTextureCoord;\nuniform sampler2D uSampler;\n\nuniform vec2 uOffset;\n\nvoid main(void)\n{\n    vec4 color = vec4(0.0);\n\n    // Sample top left pixel\n    color += texture2D(uSampler, vec2(vTextureCoord.x - uOffset.x, vTextureCoord.y + uOffset.y));\n\n    // Sample top right pixel\n    color += texture2D(uSampler, vec2(vTextureCoord.x + uOffset.x, vTextureCoord.y + uOffset.y));\n\n    // Sample bottom right pixel\n    color += texture2D(uSampler, vec2(vTextureCoord.x + uOffset.x, vTextureCoord.y - uOffset.y));\n\n    // Sample bottom left pixel\n    color += texture2D(uSampler, vec2(vTextureCoord.x - uOffset.x, vTextureCoord.y - uOffset.y));\n\n    // Average\n    color *= 0.25;\n\n    gl_FragColor = color;\n}",p="\nvarying vec2 vTextureCoord;\nuniform sampler2D uSampler;\n\nuniform vec2 uOffset;\nuniform vec4 filterClamp;\n\nvoid main(void)\n{\n    vec4 color = vec4(0.0);\n\n    // Sample top left pixel\n    color += texture2D(uSampler, clamp(vec2(vTextureCoord.x - uOffset.x, vTextureCoord.y + uOffset.y), filterClamp.xy, filterClamp.zw));\n\n    // Sample top right pixel\n    color += texture2D(uSampler, clamp(vec2(vTextureCoord.x + uOffset.x, vTextureCoord.y + uOffset.y), filterClamp.xy, filterClamp.zw));\n\n    // Sample bottom right pixel\n    color += texture2D(uSampler, clamp(vec2(vTextureCoord.x + uOffset.x, vTextureCoord.y - uOffset.y), filterClamp.xy, filterClamp.zw));\n\n    // Sample bottom left pixel\n    color += texture2D(uSampler, clamp(vec2(vTextureCoord.x - uOffset.x, vTextureCoord.y - uOffset.y), filterClamp.xy, filterClamp.zw));\n\n    // Average\n    color *= 0.25;\n\n    gl_FragColor = color;\n}\n",d=function(e){function t(t,r,o){void 0===t&&(t=4),void 0===r&&(r=3),void 0===o&&(o=!1),e.call(this,f,o?p:h),this.uniforms.uOffset=new Float32Array(2),this._pixelSize=new n.Point,this.pixelSize=1,this._clamp=o,this._kernels=null,Array.isArray(t)?this.kernels=t:(this._blur=t,this.quality=r)}e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t;var r={kernels:{configurable:!0},clamp:{configurable:!0},pixelSize:{configurable:!0},quality:{configurable:!0},blur:{configurable:!0}};return t.prototype.apply=function(e,t,n,r){var o,i=this.pixelSize.x/t._frame.width,l=this.pixelSize.y/t._frame.height;if(1===this._quality||0===this._blur)o=this._kernels[0]+.5,this.uniforms.uOffset[0]=o*i,this.uniforms.uOffset[1]=o*l,e.applyFilter(this,t,n,r);else{for(var s,a=e.getFilterTexture(),u=t,c=a,f=this._quality-1,h=0;h<f;h++)o=this._kernels[h]+.5,this.uniforms.uOffset[0]=o*i,this.uniforms.uOffset[1]=o*l,e.applyFilter(this,u,c,1),s=u,u=c,c=s;o=this._kernels[f]+.5,this.uniforms.uOffset[0]=o*i,this.uniforms.uOffset[1]=o*l,e.applyFilter(this,u,n,r),e.returnFilterTexture(a)}},t.prototype._generateKernels=function(){var e=this._blur,t=this._quality,n=[e];if(e>0)for(var r=e,o=e/t,i=1;i<t;i++)r-=o,n.push(r);this._kernels=n},r.kernels.get=function(){return this._kernels},r.kernels.set=function(e){Array.isArray(e)&&e.length>0?(this._kernels=e,this._quality=e.length,this._blur=Math.max.apply(Math,e)):(this._kernels=[0],this._quality=1)},r.clamp.get=function(){return this._clamp},r.pixelSize.set=function(e){"number"==typeof e?(this._pixelSize.x=e,this._pixelSize.y=e):Array.isArray(e)?(this._pixelSize.x=e[0],this._pixelSize.y=e[1]):e instanceof n.Point?(this._pixelSize.x=e.x,this._pixelSize.y=e.y):(this._pixelSize.x=1,this._pixelSize.y=1)},r.pixelSize.get=function(){return this._pixelSize},r.quality.get=function(){return this._quality},r.quality.set=function(e){this._quality=Math.max(1,Math.round(e)),this._generateKernels()},r.blur.get=function(){return this._blur},r.blur.set=function(e){this._blur=e,this._generateKernels()},Object.defineProperties(t.prototype,r),t}(t.Filter),m=a,g="\nuniform sampler2D uSampler;\nvarying vec2 vTextureCoord;\n\nuniform float threshold;\n\nvoid main() {\n    vec4 color = texture2D(uSampler, vTextureCoord);\n\n    // A simple & fast algorithm for getting brightness.\n    // It's inaccuracy , but good enought for this feature.\n    float _max = max(max(color.r, color.g), color.b);\n    float _min = min(min(color.r, color.g), color.b);\n    float brightness = (_max + _min) * 0.5;\n\n    if(brightness > threshold) {\n        gl_FragColor = color;\n    } else {\n        gl_FragColor = vec4(0.0, 0.0, 0.0, 0.0);\n    }\n}\n",v=function(e){function t(t){void 0===t&&(t=.5),e.call(this,m,g),this.threshold=t}e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t;var n={threshold:{configurable:!0}};return n.threshold.get=function(){return this.uniforms.threshold},n.threshold.set=function(e){this.uniforms.threshold=e},Object.defineProperties(t.prototype,n),t}(t.Filter),x="uniform sampler2D uSampler;\nvarying vec2 vTextureCoord;\n\nuniform sampler2D bloomTexture;\nuniform float bloomScale;\nuniform float brightness;\n\nvoid main() {\n    vec4 color = texture2D(uSampler, vTextureCoord);\n    color.rgb *= brightness;\n    vec4 bloomColor = vec4(texture2D(bloomTexture, vTextureCoord).rgb, 0.0);\n    bloomColor.rgb *= bloomScale;\n    gl_FragColor = color + bloomColor;\n}\n",y=function(e){function t(t){e.call(this,m,x),"number"==typeof t&&(t={threshold:t}),t=Object.assign({threshold:.5,bloomScale:1,brightness:1,kernels:null,blur:8,quality:4,pixelSize:1,resolution:r.settings.RESOLUTION},t),this.bloomScale=t.bloomScale,this.brightness=t.brightness;var n=t.kernels,o=t.blur,i=t.quality,l=t.pixelSize,s=t.resolution;this._extractFilter=new v(t.threshold),this._extractFilter.resolution=s,this._blurFilter=n?new d(n):new d(o,i),this.pixelSize=l,this.resolution=s}e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t;var n={resolution:{configurable:!0},threshold:{configurable:!0},kernels:{configurable:!0},blur:{configurable:!0},quality:{configurable:!0},pixelSize:{configurable:!0}};return t.prototype.apply=function(e,t,n,r,o){var i=e.getFilterTexture();this._extractFilter.apply(e,t,i,1,o);var l=e.getFilterTexture();this._blurFilter.apply(e,i,l,1,o),this.uniforms.bloomScale=this.bloomScale,this.uniforms.brightness=this.brightness,this.uniforms.bloomTexture=l,e.applyFilter(this,t,n,r),e.returnFilterTexture(l),e.returnFilterTexture(i)},n.resolution.get=function(){return this._resolution},n.resolution.set=function(e){this._resolution=e,this._extractFilter&&(this._extractFilter.resolution=e),this._blurFilter&&(this._blurFilter.resolution=e)},n.threshold.get=function(){return this._extractFilter.threshold},n.threshold.set=function(e){this._extractFilter.threshold=e},n.kernels.get=function(){return this._blurFilter.kernels},n.kernels.set=function(e){this._blurFilter.kernels=e},n.blur.get=function(){return this._blurFilter.blur},n.blur.set=function(e){this._blurFilter.blur=e},n.quality.get=function(){return this._blurFilter.quality},n.quality.set=function(e){this._blurFilter.quality=e},n.pixelSize.get=function(){return this._blurFilter.pixelSize},n.pixelSize.set=function(e){this._blurFilter.pixelSize=e},Object.defineProperties(t.prototype,n),t}(t.Filter),_=a,b="varying vec2 vTextureCoord;\n\nuniform vec4 filterArea;\nuniform float pixelSize;\nuniform sampler2D uSampler;\n\nvec2 mapCoord( vec2 coord )\n{\n    coord *= filterArea.xy;\n    coord += filterArea.zw;\n\n    return coord;\n}\n\nvec2 unmapCoord( vec2 coord )\n{\n    coord -= filterArea.zw;\n    coord /= filterArea.xy;\n\n    return coord;\n}\n\nvec2 pixelate(vec2 coord, vec2 size)\n{\n    return floor( coord / size ) * size;\n}\n\nvec2 getMod(vec2 coord, vec2 size)\n{\n    return mod( coord , size) / size;\n}\n\nfloat character(float n, vec2 p)\n{\n    p = floor(p*vec2(4.0, -4.0) + 2.5);\n\n    if (clamp(p.x, 0.0, 4.0) == p.x)\n    {\n        if (clamp(p.y, 0.0, 4.0) == p.y)\n        {\n            if (int(mod(n/exp2(p.x + 5.0*p.y), 2.0)) == 1) return 1.0;\n        }\n    }\n    return 0.0;\n}\n\nvoid main()\n{\n    vec2 coord = mapCoord(vTextureCoord);\n\n    // get the rounded color..\n    vec2 pixCoord = pixelate(coord, vec2(pixelSize));\n    pixCoord = unmapCoord(pixCoord);\n\n    vec4 color = texture2D(uSampler, pixCoord);\n\n    // determine the character to use\n    float gray = (color.r + color.g + color.b) / 3.0;\n\n    float n =  65536.0;             // .\n    if (gray > 0.2) n = 65600.0;    // :\n    if (gray > 0.3) n = 332772.0;   // *\n    if (gray > 0.4) n = 15255086.0; // o\n    if (gray > 0.5) n = 23385164.0; // &\n    if (gray > 0.6) n = 15252014.0; // 8\n    if (gray > 0.7) n = 13199452.0; // @\n    if (gray > 0.8) n = 11512810.0; // #\n\n    // get the mod..\n    vec2 modd = getMod(coord, vec2(pixelSize));\n\n    gl_FragColor = color * character( n, vec2(-1.0) + modd * 2.0);\n\n}\n",C=function(e){function t(t){void 0===t&&(t=8),e.call(this,_,b),this.size=t}e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t;var n={size:{configurable:!0}};return n.size.get=function(){return this.uniforms.pixelSize},n.size.set=function(e){this.uniforms.pixelSize=e},Object.defineProperties(t.prototype,n),t}(t.Filter),S=a,F="precision mediump float;\n\nvarying vec2 vTextureCoord;\nuniform sampler2D uSampler;\nuniform vec4 filterArea;\n\nuniform float transformX;\nuniform float transformY;\nuniform vec3 lightColor;\nuniform float lightAlpha;\nuniform vec3 shadowColor;\nuniform float shadowAlpha;\n\nvoid main(void) {\n    vec2 transform = vec2(1.0 / filterArea) * vec2(transformX, transformY);\n    vec4 color = texture2D(uSampler, vTextureCoord);\n    float light = texture2D(uSampler, vTextureCoord - transform).a;\n    float shadow = texture2D(uSampler, vTextureCoord + transform).a;\n\n    color.rgb = mix(color.rgb, lightColor, clamp((color.a - light) * lightAlpha, 0.0, 1.0));\n    color.rgb = mix(color.rgb, shadowColor, clamp((color.a - shadow) * shadowAlpha, 0.0, 1.0));\n    gl_FragColor = vec4(color.rgb * color.a, color.a);\n}\n",z=function(e){function t(t){void 0===t&&(t={}),e.call(this,S,F),this.uniforms.lightColor=new Float32Array(3),this.uniforms.shadowColor=new Float32Array(3),t=Object.assign({rotation:45,thickness:2,lightColor:16777215,lightAlpha:.7,shadowColor:0,shadowAlpha:.7},t),this.rotation=t.rotation,this.thickness=t.thickness,this.lightColor=t.lightColor,this.lightAlpha=t.lightAlpha,this.shadowColor=t.shadowColor,this.shadowAlpha=t.shadowAlpha}e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t;var r={rotation:{configurable:!0},thickness:{configurable:!0},lightColor:{configurable:!0},lightAlpha:{configurable:!0},shadowColor:{configurable:!0},shadowAlpha:{configurable:!0}};return t.prototype._updateTransform=function(){this.uniforms.transformX=this._thickness*Math.cos(this._angle),this.uniforms.transformY=this._thickness*Math.sin(this._angle)},r.rotation.get=function(){return this._angle/n.DEG_TO_RAD},r.rotation.set=function(e){this._angle=e*n.DEG_TO_RAD,this._updateTransform()},r.thickness.get=function(){return this._thickness},r.thickness.set=function(e){this._thickness=e,this._updateTransform()},r.lightColor.get=function(){return o.rgb2hex(this.uniforms.lightColor)},r.lightColor.set=function(e){o.hex2rgb(e,this.uniforms.lightColor)},r.lightAlpha.get=function(){return this.uniforms.lightAlpha},r.lightAlpha.set=function(e){this.uniforms.lightAlpha=e},r.shadowColor.get=function(){return o.rgb2hex(this.uniforms.shadowColor)},r.shadowColor.set=function(e){o.hex2rgb(e,this.uniforms.shadowColor)},r.shadowAlpha.get=function(){return this.uniforms.shadowAlpha},r.shadowAlpha.set=function(e){this.uniforms.shadowAlpha=e},Object.defineProperties(t.prototype,r),t}(t.Filter),A=function(e){function t(t,o,a,u){var c,f;void 0===t&&(t=2),void 0===o&&(o=4),void 0===a&&(a=r.settings.RESOLUTION),void 0===u&&(u=5),e.call(this),"number"==typeof t?(c=t,f=t):t instanceof n.Point?(c=t.x,f=t.y):Array.isArray(t)&&(c=t[0],f=t[1]),this.blurXFilter=new s.BlurFilterPass(!0,c,o,a,u),this.blurYFilter=new s.BlurFilterPass(!1,f,o,a,u),this.blurYFilter.blendMode=i.BLEND_MODES.SCREEN,this.defaultFilter=new l.AlphaFilter}e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t;var o={blur:{configurable:!0},blurX:{configurable:!0},blurY:{configurable:!0}};return t.prototype.apply=function(e,t,n){var r=e.getFilterTexture(!0);this.defaultFilter.apply(e,t,n),this.blurXFilter.apply(e,t,r),this.blurYFilter.apply(e,r,n),e.returnFilterTexture(r)},o.blur.get=function(){return this.blurXFilter.blur},o.blur.set=function(e){this.blurXFilter.blur=this.blurYFilter.blur=e},o.blurX.get=function(){return this.blurXFilter.blur},o.blurX.set=function(e){this.blurXFilter.blur=e},o.blurY.get=function(){return this.blurYFilter.blur},o.blurY.set=function(e){this.blurYFilter.blur=e},Object.defineProperties(t.prototype,o),t}(t.Filter),w=a,T="uniform float radius;\nuniform float strength;\nuniform vec2 center;\nuniform sampler2D uSampler;\nvarying vec2 vTextureCoord;\n\nuniform vec4 filterArea;\nuniform vec4 filterClamp;\nuniform vec2 dimensions;\n\nvoid main()\n{\n    vec2 coord = vTextureCoord * filterArea.xy;\n    coord -= center * dimensions.xy;\n    float distance = length(coord);\n    if (distance < radius) {\n        float percent = distance / radius;\n        if (strength > 0.0) {\n            coord *= mix(1.0, smoothstep(0.0, radius / distance, percent), strength * 0.75);\n        } else {\n            coord *= mix(1.0, pow(percent, 1.0 + strength * 0.75) * radius / distance, 1.0 - percent);\n        }\n    }\n    coord += center * dimensions.xy;\n    coord /= filterArea.xy;\n    vec2 clampedCoord = clamp(coord, filterClamp.xy, filterClamp.zw);\n    vec4 color = texture2D(uSampler, clampedCoord);\n    if (coord != clampedCoord) {\n        color *= max(0.0, 1.0 - length(coord - clampedCoord));\n    }\n\n    gl_FragColor = color;\n}\n",O=function(e){function t(t){if(e.call(this,w,T),"object"!=typeof t){var n=arguments[0],r=arguments[1],o=arguments[2];t={},void 0!==n&&(t.center=n),void 0!==r&&(t.radius=r),void 0!==o&&(t.strength=o)}this.uniforms.dimensions=new Float32Array(2),Object.assign(this,{center:[.5,.5],radius:100,strength:1},t)}e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t;var n={radius:{configurable:!0},strength:{configurable:!0},center:{configurable:!0}};return t.prototype.apply=function(e,t,n,r){this.uniforms.dimensions[0]=t.filterFrame.width,this.uniforms.dimensions[1]=t.filterFrame.height,e.applyFilter(this,t,n,r)},n.radius.get=function(){return this.uniforms.radius},n.radius.set=function(e){this.uniforms.radius=e},n.strength.get=function(){return this.uniforms.strength},n.strength.set=function(e){this.uniforms.strength=e},n.center.get=function(){return this.uniforms.center},n.center.set=function(e){this.uniforms.center=e},Object.defineProperties(t.prototype,n),t}(t.Filter),D=a,P="varying vec2 vTextureCoord;\nuniform sampler2D uSampler;\nuniform sampler2D colorMap;\nuniform float _mix;\nuniform float _size;\nuniform float _sliceSize;\nuniform float _slicePixelSize;\nuniform float _sliceInnerSize;\nvoid main() {\n    vec4 color = texture2D(uSampler, vTextureCoord.xy);\n\n    vec4 adjusted;\n    if (color.a > 0.0) {\n        color.rgb /= color.a;\n        float innerWidth = _size - 1.0;\n        float zSlice0 = min(floor(color.b * innerWidth), innerWidth);\n        float zSlice1 = min(zSlice0 + 1.0, innerWidth);\n        float xOffset = _slicePixelSize * 0.5 + color.r * _sliceInnerSize;\n        float s0 = xOffset + (zSlice0 * _sliceSize);\n        float s1 = xOffset + (zSlice1 * _sliceSize);\n        float yOffset = _sliceSize * 0.5 + color.g * (1.0 - _sliceSize);\n        vec4 slice0Color = texture2D(colorMap, vec2(s0,yOffset));\n        vec4 slice1Color = texture2D(colorMap, vec2(s1,yOffset));\n        float zOffset = fract(color.b * innerWidth);\n        adjusted = mix(slice0Color, slice1Color, zOffset);\n\n        color.rgb *= color.a;\n    }\n    gl_FragColor = vec4(mix(color, adjusted, _mix).rgb, color.a);\n\n}",M=function(e){function n(t,n,r){void 0===n&&(n=!1),void 0===r&&(r=1),e.call(this,D,P),this._size=0,this._sliceSize=0,this._slicePixelSize=0,this._sliceInnerSize=0,this._scaleMode=null,this._nearest=!1,this.nearest=n,this.mix=r,this.colorMap=t}e&&(n.__proto__=e),n.prototype=Object.create(e&&e.prototype),n.prototype.constructor=n;var r={colorSize:{configurable:!0},colorMap:{configurable:!0},nearest:{configurable:!0}};return n.prototype.apply=function(e,t,n,r){this.uniforms._mix=this.mix,e.applyFilter(this,t,n,r)},r.colorSize.get=function(){return this._size},r.colorMap.get=function(){return this._colorMap},r.colorMap.set=function(e){e instanceof t.Texture||(e=t.Texture.from(e)),e&&e.baseTexture&&(e.baseTexture.scaleMode=this._scaleMode,e.baseTexture.mipmap=!1,this._size=e.height,this._sliceSize=1/this._size,this._slicePixelSize=this._sliceSize/this._size,this._sliceInnerSize=this._slicePixelSize*(this._size-1),this.uniforms._size=this._size,this.uniforms._sliceSize=this._sliceSize,this.uniforms._slicePixelSize=this._slicePixelSize,this.uniforms._sliceInnerSize=this._sliceInnerSize,this.uniforms.colorMap=e),this._colorMap=e},r.nearest.get=function(){return this._nearest},r.nearest.set=function(e){this._nearest=e,this._scaleMode=e?i.SCALE_MODES.NEAREST:i.SCALE_MODES.LINEAR;var t=this._colorMap;t&&t.baseTexture&&(t.baseTexture._glTextures={},t.baseTexture.scaleMode=this._scaleMode,t.baseTexture.mipmap=!1,t._updateID++,t.baseTexture.emit("update",t.baseTexture))},n.prototype.updateColorMap=function(){var e=this._colorMap;e&&e.baseTexture&&(e._updateID++,e.baseTexture.emit("update",e.baseTexture),this.colorMap=e)},n.prototype.destroy=function(t){this._colorMap&&this._colorMap.destroy(t),e.prototype.destroy.call(this)},Object.defineProperties(n.prototype,r),n}(t.Filter),R=a,k="varying vec2 vTextureCoord;\nuniform sampler2D uSampler;\nuniform vec3 color;\nvoid main(void) {\n    vec4 currentColor = texture2D(uSampler, vTextureCoord);\n    vec3 colorOverlay = color * currentColor.a;\n    gl_FragColor = vec4(colorOverlay.r, colorOverlay.g, colorOverlay.b, currentColor.a);\n}\n",j=function(e){function t(t){void 0===t&&(t=0),e.call(this,R,k),this.uniforms.color=new Float32Array(3),this.color=t}e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t;var n={color:{configurable:!0}};return n.color.set=function(e){var t=this.uniforms.color;"number"==typeof e?(o.hex2rgb(e,t),this._color=e):(t[0]=e[0],t[1]=e[1],t[2]=e[2],this._color=o.rgb2hex(t))},n.color.get=function(){return this._color},Object.defineProperties(t.prototype,n),t}(t.Filter),E=a,L="varying vec2 vTextureCoord;\nuniform sampler2D uSampler;\nuniform vec3 originalColor;\nuniform vec3 newColor;\nuniform float epsilon;\nvoid main(void) {\n    vec4 currentColor = texture2D(uSampler, vTextureCoord);\n    vec3 colorDiff = originalColor - (currentColor.rgb / max(currentColor.a, 0.0000000001));\n    float colorDistance = length(colorDiff);\n    float doReplace = step(colorDistance, epsilon);\n    gl_FragColor = vec4(mix(currentColor.rgb, (newColor + colorDiff) * currentColor.a, doReplace), currentColor.a);\n}\n",I=function(e){function t(t,n,r){void 0===t&&(t=16711680),void 0===n&&(n=0),void 0===r&&(r=.4),e.call(this,E,L),this.uniforms.originalColor=new Float32Array(3),this.uniforms.newColor=new Float32Array(3),this.originalColor=t,this.newColor=n,this.epsilon=r}e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t;var n={originalColor:{configurable:!0},newColor:{configurable:!0},epsilon:{configurable:!0}};return n.originalColor.set=function(e){var t=this.uniforms.originalColor;"number"==typeof e?(o.hex2rgb(e,t),this._originalColor=e):(t[0]=e[0],t[1]=e[1],t[2]=e[2],this._originalColor=o.rgb2hex(t))},n.originalColor.get=function(){return this._originalColor},n.newColor.set=function(e){var t=this.uniforms.newColor;"number"==typeof e?(o.hex2rgb(e,t),this._newColor=e):(t[0]=e[0],t[1]=e[1],t[2]=e[2],this._newColor=o.rgb2hex(t))},n.newColor.get=function(){return this._newColor},n.epsilon.set=function(e){this.uniforms.epsilon=e},n.epsilon.get=function(){return this.uniforms.epsilon},Object.defineProperties(t.prototype,n),t}(t.Filter),X=a,B="precision mediump float;\n\nvarying mediump vec2 vTextureCoord;\n\nuniform sampler2D uSampler;\nuniform vec2 texelSize;\nuniform float matrix[9];\n\nvoid main(void)\n{\n   vec4 c11 = texture2D(uSampler, vTextureCoord - texelSize); // top left\n   vec4 c12 = texture2D(uSampler, vec2(vTextureCoord.x, vTextureCoord.y - texelSize.y)); // top center\n   vec4 c13 = texture2D(uSampler, vec2(vTextureCoord.x + texelSize.x, vTextureCoord.y - texelSize.y)); // top right\n\n   vec4 c21 = texture2D(uSampler, vec2(vTextureCoord.x - texelSize.x, vTextureCoord.y)); // mid left\n   vec4 c22 = texture2D(uSampler, vTextureCoord); // mid center\n   vec4 c23 = texture2D(uSampler, vec2(vTextureCoord.x + texelSize.x, vTextureCoord.y)); // mid right\n\n   vec4 c31 = texture2D(uSampler, vec2(vTextureCoord.x - texelSize.x, vTextureCoord.y + texelSize.y)); // bottom left\n   vec4 c32 = texture2D(uSampler, vec2(vTextureCoord.x, vTextureCoord.y + texelSize.y)); // bottom center\n   vec4 c33 = texture2D(uSampler, vTextureCoord + texelSize); // bottom right\n\n   gl_FragColor =\n       c11 * matrix[0] + c12 * matrix[1] + c13 * matrix[2] +\n       c21 * matrix[3] + c22 * matrix[4] + c23 * matrix[5] +\n       c31 * matrix[6] + c32 * matrix[7] + c33 * matrix[8];\n\n   gl_FragColor.a = c22.a;\n}\n",N=function(e){function t(t,n,r){void 0===n&&(n=200),void 0===r&&(r=200),e.call(this,X,B),this.uniforms.texelSize=new Float32Array(2),this.uniforms.matrix=new Float32Array(9),void 0!==t&&(this.matrix=t),this.width=n,this.height=r}e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t;var n={matrix:{configurable:!0},width:{configurable:!0},height:{configurable:!0}};return n.matrix.get=function(){return this.uniforms.matrix},n.matrix.set=function(e){var t=this;e.forEach(function(e,n){return t.uniforms.matrix[n]=e})},n.width.get=function(){return 1/this.uniforms.texelSize[0]},n.width.set=function(e){this.uniforms.texelSize[0]=1/e},n.height.get=function(){return 1/this.uniforms.texelSize[1]},n.height.set=function(e){this.uniforms.texelSize[1]=1/e},Object.defineProperties(t.prototype,n),t}(t.Filter),G=a,q="precision mediump float;\n\nvarying vec2 vTextureCoord;\n\nuniform sampler2D uSampler;\n\nvoid main(void)\n{\n    float lum = length(texture2D(uSampler, vTextureCoord.xy).rgb);\n\n    gl_FragColor = vec4(1.0, 1.0, 1.0, 1.0);\n\n    if (lum < 1.00)\n    {\n        if (mod(gl_FragCoord.x + gl_FragCoord.y, 10.0) == 0.0)\n        {\n            gl_FragColor = vec4(0.0, 0.0, 0.0, 1.0);\n        }\n    }\n\n    if (lum < 0.75)\n    {\n        if (mod(gl_FragCoord.x - gl_FragCoord.y, 10.0) == 0.0)\n        {\n            gl_FragColor = vec4(0.0, 0.0, 0.0, 1.0);\n        }\n    }\n\n    if (lum < 0.50)\n    {\n        if (mod(gl_FragCoord.x + gl_FragCoord.y - 5.0, 10.0) == 0.0)\n        {\n            gl_FragColor = vec4(0.0, 0.0, 0.0, 1.0);\n        }\n    }\n\n    if (lum < 0.3)\n    {\n        if (mod(gl_FragCoord.x - gl_FragCoord.y - 5.0, 10.0) == 0.0)\n        {\n            gl_FragColor = vec4(0.0, 0.0, 0.0, 1.0);\n        }\n    }\n}\n",W=function(e){function t(){e.call(this,G,q)}return e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t,t}(t.Filter),K=a,Y="varying vec2 vTextureCoord;\nuniform sampler2D uSampler;\n\nuniform vec4 filterArea;\nuniform vec2 dimensions;\n\nconst float SQRT_2 = 1.414213;\n\nconst float light = 1.0;\n\nuniform float curvature;\nuniform float lineWidth;\nuniform float lineContrast;\nuniform bool verticalLine;\nuniform float noise;\nuniform float noiseSize;\n\nuniform float vignetting;\nuniform float vignettingAlpha;\nuniform float vignettingBlur;\n\nuniform float seed;\nuniform float time;\n\nfloat rand(vec2 co) {\n    return fract(sin(dot(co.xy, vec2(12.9898, 78.233))) * 43758.5453);\n}\n\nvoid main(void)\n{\n    vec2 pixelCoord = vTextureCoord.xy * filterArea.xy;\n    vec2 coord = pixelCoord / dimensions;\n\n    vec2 dir = vec2(coord - vec2(0.5, 0.5));\n\n    float _c = curvature > 0. ? curvature : 1.;\n    float k = curvature > 0. ?(length(dir * dir) * 0.25 * _c * _c + 0.935 * _c) : 1.;\n    vec2 uv = dir * k;\n\n    gl_FragColor = texture2D(uSampler, vTextureCoord);\n    vec3 rgb = gl_FragColor.rgb;\n\n\n    if (noise > 0.0 && noiseSize > 0.0)\n    {\n        pixelCoord.x = floor(pixelCoord.x / noiseSize);\n        pixelCoord.y = floor(pixelCoord.y / noiseSize);\n        float _noise = rand(pixelCoord * noiseSize * seed) - 0.5;\n        rgb += _noise * noise;\n    }\n\n    if (lineWidth > 0.0) {\n        float v = (verticalLine ? uv.x * dimensions.x : uv.y * dimensions.y) * min(1.0, 2.0 / lineWidth ) / _c;\n        float j = 1. + cos(v * 1.2 - time) * 0.5 * lineContrast;\n        rgb *= j;\n        float segment = verticalLine ? mod((dir.x + .5) * dimensions.x, 4.) : mod((dir.y + .5) * dimensions.y, 4.);\n        rgb *= 0.99 + ceil(segment) * 0.015;\n    }\n\n    if (vignetting > 0.0)\n    {\n        float outter = SQRT_2 - vignetting * SQRT_2;\n        float darker = clamp((outter - length(dir) * SQRT_2) / ( 0.00001 + vignettingBlur * SQRT_2), 0.0, 1.0);\n        rgb *= darker + (1.0 - darker) * (1.0 - vignettingAlpha);\n    }\n\n    gl_FragColor.rgb = rgb;\n}\n",Z=function(e){function t(t){e.call(this,K,Y),this.uniforms.dimensions=new Float32Array(2),this.time=0,this.seed=0,Object.assign(this,{curvature:1,lineWidth:1,lineContrast:.25,verticalLine:!1,noise:0,noiseSize:1,seed:0,vignetting:.3,vignettingAlpha:1,vignettingBlur:.3,time:0},t)}e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t;var n={curvature:{configurable:!0},lineWidth:{configurable:!0},lineContrast:{configurable:!0},verticalLine:{configurable:!0},noise:{configurable:!0},noiseSize:{configurable:!0},vignetting:{configurable:!0},vignettingAlpha:{configurable:!0},vignettingBlur:{configurable:!0}};return t.prototype.apply=function(e,t,n,r){this.uniforms.dimensions[0]=t.filterFrame.width,this.uniforms.dimensions[1]=t.filterFrame.height,this.uniforms.seed=this.seed,this.uniforms.time=this.time,e.applyFilter(this,t,n,r)},n.curvature.set=function(e){this.uniforms.curvature=e},n.curvature.get=function(){return this.uniforms.curvature},n.lineWidth.set=function(e){this.uniforms.lineWidth=e},n.lineWidth.get=function(){return this.uniforms.lineWidth},n.lineContrast.set=function(e){this.uniforms.lineContrast=e},n.lineContrast.get=function(){return this.uniforms.lineContrast},n.verticalLine.set=function(e){this.uniforms.verticalLine=e},n.verticalLine.get=function(){return this.uniforms.verticalLine},n.noise.set=function(e){this.uniforms.noise=e},n.noise.get=function(){return this.uniforms.noise},n.noiseSize.set=function(e){this.uniforms.noiseSize=e},n.noiseSize.get=function(){return this.uniforms.noiseSize},n.vignetting.set=function(e){this.uniforms.vignetting=e},n.vignetting.get=function(){return this.uniforms.vignetting},n.vignettingAlpha.set=function(e){this.uniforms.vignettingAlpha=e},n.vignettingAlpha.get=function(){return this.uniforms.vignettingAlpha},n.vignettingBlur.set=function(e){this.uniforms.vignettingBlur=e},n.vignettingBlur.get=function(){return this.uniforms.vignettingBlur},Object.defineProperties(t.prototype,n),t}(t.Filter),Q=a,U="precision mediump float;\n\nvarying vec2 vTextureCoord;\nvarying vec4 vColor;\n\nuniform vec4 filterArea;\nuniform sampler2D uSampler;\n\nuniform float angle;\nuniform float scale;\n\nfloat pattern()\n{\n   float s = sin(angle), c = cos(angle);\n   vec2 tex = vTextureCoord * filterArea.xy;\n   vec2 point = vec2(\n       c * tex.x - s * tex.y,\n       s * tex.x + c * tex.y\n   ) * scale;\n   return (sin(point.x) * sin(point.y)) * 4.0;\n}\n\nvoid main()\n{\n   vec4 color = texture2D(uSampler, vTextureCoord);\n   float average = (color.r + color.g + color.b) / 3.0;\n   gl_FragColor = vec4(vec3(average * 10.0 - 5.0 + pattern()), color.a);\n}\n",V=function(e){function t(t,n){void 0===t&&(t=1),void 0===n&&(n=5),e.call(this,Q,U),this.scale=t,this.angle=n}e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t;var n={scale:{configurable:!0},angle:{configurable:!0}};return n.scale.get=function(){return this.uniforms.scale},n.scale.set=function(e){this.uniforms.scale=e},n.angle.get=function(){return this.uniforms.angle},n.angle.set=function(e){this.uniforms.angle=e},Object.defineProperties(t.prototype,n),t}(t.Filter),H=a,$="varying vec2 vTextureCoord;\nuniform sampler2D uSampler;\nuniform float alpha;\nuniform vec3 color;\n\nuniform vec2 shift;\nuniform vec4 inputSize;\n\nvoid main(void){\n    vec4 sample = texture2D(uSampler, vTextureCoord - shift * inputSize.zw);\n\n    // Premultiply alpha\n    sample.rgb = color.rgb * sample.a;\n\n    // alpha user alpha\n    sample *= alpha;\n\n    gl_FragColor = sample;\n}",J=function(e){function t(t){t&&t.constructor!==Object&&(console.warn("DropShadowFilter now uses options instead of (rotation, distance, blur, color, alpha)"),t={rotation:t},void 0!==arguments[1]&&(t.distance=arguments[1]),void 0!==arguments[2]&&(t.blur=arguments[2]),void 0!==arguments[3]&&(t.color=arguments[3]),void 0!==arguments[4]&&(t.alpha=arguments[4])),t=Object.assign({rotation:45,distance:5,color:0,alpha:.5,shadowOnly:!1,kernels:null,blur:2,quality:3,pixelSize:1,resolution:r.settings.RESOLUTION},t),e.call(this);var o=t.kernels,i=t.blur,l=t.quality,s=t.pixelSize,a=t.resolution;this._tintFilter=new e(H,$),this._tintFilter.uniforms.color=new Float32Array(4),this._tintFilter.uniforms.shift=new n.Point,this._tintFilter.resolution=a,this._blurFilter=o?new d(o):new d(i,l),this.pixelSize=s,this.resolution=a;var u=t.shadowOnly,c=t.rotation,f=t.distance,h=t.alpha,p=t.color;this.shadowOnly=u,this.rotation=c,this.distance=f,this.alpha=h,this.color=p,this._updatePadding()}e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t;var i={resolution:{configurable:!0},distance:{configurable:!0},rotation:{configurable:!0},alpha:{configurable:!0},color:{configurable:!0},kernels:{configurable:!0},blur:{configurable:!0},quality:{configurable:!0},pixelSize:{configurable:!0}};return t.prototype.apply=function(e,t,n,r){var o=e.getFilterTexture();this._tintFilter.apply(e,t,o,1),this._blurFilter.apply(e,o,n,r),!0!==this.shadowOnly&&e.applyFilter(this,t,n,0),e.returnFilterTexture(o)},t.prototype._updatePadding=function(){this.padding=this.distance+2*this.blur},t.prototype._updateShift=function(){this._tintFilter.uniforms.shift.set(this.distance*Math.cos(this.angle),this.distance*Math.sin(this.angle))},i.resolution.get=function(){return this._resolution},i.resolution.set=function(e){this._resolution=e,this._tintFilter&&(this._tintFilter.resolution=e),this._blurFilter&&(this._blurFilter.resolution=e)},i.distance.get=function(){return this._distance},i.distance.set=function(e){this._distance=e,this._updatePadding(),this._updateShift()},i.rotation.get=function(){return this.angle/n.DEG_TO_RAD},i.rotation.set=function(e){this.angle=e*n.DEG_TO_RAD,this._updateShift()},i.alpha.get=function(){return this._tintFilter.uniforms.alpha},i.alpha.set=function(e){this._tintFilter.uniforms.alpha=e},i.color.get=function(){return o.rgb2hex(this._tintFilter.uniforms.color)},i.color.set=function(e){o.hex2rgb(e,this._tintFilter.uniforms.color)},i.kernels.get=function(){return this._blurFilter.kernels},i.kernels.set=function(e){this._blurFilter.kernels=e},i.blur.get=function(){return this._blurFilter.blur},i.blur.set=function(e){this._blurFilter.blur=e,this._updatePadding()},i.quality.get=function(){return this._blurFilter.quality},i.quality.set=function(e){this._blurFilter.quality=e},i.pixelSize.get=function(){return this._blurFilter.pixelSize},i.pixelSize.set=function(e){this._blurFilter.pixelSize=e},Object.defineProperties(t.prototype,i),t}(t.Filter),ee=a,te="precision mediump float;\n\nvarying vec2 vTextureCoord;\n\nuniform sampler2D uSampler;\nuniform float strength;\nuniform vec4 filterArea;\n\n\nvoid main(void)\n{\n\tvec2 onePixel = vec2(1.0 / filterArea);\n\n\tvec4 color;\n\n\tcolor.rgb = vec3(0.5);\n\n\tcolor -= texture2D(uSampler, vTextureCoord - onePixel) * strength;\n\tcolor += texture2D(uSampler, vTextureCoord + onePixel) * strength;\n\n\tcolor.rgb = vec3((color.r + color.g + color.b) / 3.0);\n\n\tfloat alpha = texture2D(uSampler, vTextureCoord).a;\n\n\tgl_FragColor = vec4(color.rgb * alpha, alpha);\n}\n",ne=function(e){function t(t){void 0===t&&(t=5),e.call(this,ee,te),this.strength=t}e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t;var n={strength:{configurable:!0}};return n.strength.get=function(){return this.uniforms.strength},n.strength.set=function(e){this.uniforms.strength=e},Object.defineProperties(t.prototype,n),t}(t.Filter),re=a,oe="// precision highp float;\n\nvarying vec2 vTextureCoord;\nuniform sampler2D uSampler;\n\nuniform vec4 filterArea;\nuniform vec4 filterClamp;\nuniform vec2 dimensions;\nuniform float aspect;\n\nuniform sampler2D displacementMap;\nuniform float offset;\nuniform float sinDir;\nuniform float cosDir;\nuniform int fillMode;\n\nuniform float seed;\nuniform vec2 red;\nuniform vec2 green;\nuniform vec2 blue;\n\nconst int TRANSPARENT = 0;\nconst int ORIGINAL = 1;\nconst int LOOP = 2;\nconst int CLAMP = 3;\nconst int MIRROR = 4;\n\nvoid main(void)\n{\n    vec2 coord = (vTextureCoord * filterArea.xy) / dimensions;\n\n    if (coord.x > 1.0 || coord.y > 1.0) {\n        return;\n    }\n\n    float cx = coord.x - 0.5;\n    float cy = (coord.y - 0.5) * aspect;\n    float ny = (-sinDir * cx + cosDir * cy) / aspect + 0.5;\n\n    // displacementMap: repeat\n    // ny = ny > 1.0 ? ny - 1.0 : (ny < 0.0 ? 1.0 + ny : ny);\n\n    // displacementMap: mirror\n    ny = ny > 1.0 ? 2.0 - ny : (ny < 0.0 ? -ny : ny);\n\n    vec4 dc = texture2D(displacementMap, vec2(0.5, ny));\n\n    float displacement = (dc.r - dc.g) * (offset / filterArea.x);\n\n    coord = vTextureCoord + vec2(cosDir * displacement, sinDir * displacement * aspect);\n\n    if (fillMode == CLAMP) {\n        coord = clamp(coord, filterClamp.xy, filterClamp.zw);\n    } else {\n        if( coord.x > filterClamp.z ) {\n            if (fillMode == TRANSPARENT) {\n                discard;\n            } else if (fillMode == LOOP) {\n                coord.x -= filterClamp.z;\n            } else if (fillMode == MIRROR) {\n                coord.x = filterClamp.z * 2.0 - coord.x;\n            }\n        } else if( coord.x < filterClamp.x ) {\n            if (fillMode == TRANSPARENT) {\n                discard;\n            } else if (fillMode == LOOP) {\n                coord.x += filterClamp.z;\n            } else if (fillMode == MIRROR) {\n                coord.x *= -filterClamp.z;\n            }\n        }\n\n        if( coord.y > filterClamp.w ) {\n            if (fillMode == TRANSPARENT) {\n                discard;\n            } else if (fillMode == LOOP) {\n                coord.y -= filterClamp.w;\n            } else if (fillMode == MIRROR) {\n                coord.y = filterClamp.w * 2.0 - coord.y;\n            }\n        } else if( coord.y < filterClamp.y ) {\n            if (fillMode == TRANSPARENT) {\n                discard;\n            } else if (fillMode == LOOP) {\n                coord.y += filterClamp.w;\n            } else if (fillMode == MIRROR) {\n                coord.y *= -filterClamp.w;\n            }\n        }\n    }\n\n    gl_FragColor.r = texture2D(uSampler, coord + red * (1.0 - seed * 0.4) / filterArea.xy).r;\n    gl_FragColor.g = texture2D(uSampler, coord + green * (1.0 - seed * 0.3) / filterArea.xy).g;\n    gl_FragColor.b = texture2D(uSampler, coord + blue * (1.0 - seed * 0.2) / filterArea.xy).b;\n    gl_FragColor.a = texture2D(uSampler, coord).a;\n}\n",ie=function(e){function r(n){void 0===n&&(n={}),e.call(this,re,oe),this.uniforms.dimensions=new Float32Array(2),n=Object.assign({slices:5,offset:100,direction:0,fillMode:0,average:!1,seed:0,red:[0,0],green:[0,0],blue:[0,0],minSize:8,sampleSize:512},n),this.direction=n.direction,this.red=n.red,this.green=n.green,this.blue=n.blue,this.offset=n.offset,this.fillMode=n.fillMode,this.average=n.average,this.seed=n.seed,this.minSize=n.minSize,this.sampleSize=n.sampleSize,this._canvas=document.createElement("canvas"),this._canvas.width=4,this._canvas.height=this.sampleSize,this.texture=t.Texture.from(this._canvas,{scaleMode:i.SCALE_MODES.NEAREST}),this._slices=0,this.slices=n.slices}e&&(r.__proto__=e),r.prototype=Object.create(e&&e.prototype),r.prototype.constructor=r;var o={sizes:{configurable:!0},offsets:{configurable:!0},slices:{configurable:!0},direction:{configurable:!0},red:{configurable:!0},green:{configurable:!0},blue:{configurable:!0}};return r.prototype.apply=function(e,t,n,r){var o=t.filterFrame.width,i=t.filterFrame.height;this.uniforms.dimensions[0]=o,this.uniforms.dimensions[1]=i,this.uniforms.aspect=i/o,this.uniforms.seed=this.seed,this.uniforms.offset=this.offset,this.uniforms.fillMode=this.fillMode,e.applyFilter(this,t,n,r)},r.prototype._randomizeSizes=function(){var e=this._sizes,t=this._slices-1,n=this.sampleSize,r=Math.min(this.minSize/n,.9/this._slices);if(this.average){for(var o=this._slices,i=1,l=0;l<t;l++){var s=i/(o-l),a=Math.max(s*(1-.6*Math.random()),r);e[l]=a,i-=a}e[t]=i}else{for(var u=1,c=Math.sqrt(1/this._slices),f=0;f<t;f++){var h=Math.max(c*u*Math.random(),r);e[f]=h,u-=h}e[t]=u}this.shuffle()},r.prototype.shuffle=function(){for(var e=this._sizes,t=this._slices-1;t>0;t--){var n=Math.random()*t>>0,r=e[t];e[t]=e[n],e[n]=r}},r.prototype._randomizeOffsets=function(){for(var e=0;e<this._slices;e++)this._offsets[e]=Math.random()*(Math.random()<.5?-1:1)},r.prototype.refresh=function(){this._randomizeSizes(),this._randomizeOffsets(),this.redraw()},r.prototype.redraw=function(){var e,t=this.sampleSize,n=this.texture,r=this._canvas.getContext("2d");r.clearRect(0,0,8,t);for(var o=0,i=0;i<this._slices;i++){e=Math.floor(256*this._offsets[i]);var l=this._sizes[i]*t,s=e>0?e:0,a=e<0?-e:0;r.fillStyle="rgba("+s+", "+a+", 0, 1)",r.fillRect(0,o>>0,t,l+1>>0),o+=l}n.baseTexture.update(),this.uniforms.displacementMap=n},o.sizes.set=function(e){for(var t=Math.min(this._slices,e.length),n=0;n<t;n++)this._sizes[n]=e[n]},o.sizes.get=function(){return this._sizes},o.offsets.set=function(e){for(var t=Math.min(this._slices,e.length),n=0;n<t;n++)this._offsets[n]=e[n]},o.offsets.get=function(){return this._offsets},o.slices.get=function(){return this._slices},o.slices.set=function(e){this._slices!==e&&(this._slices=e,this.uniforms.slices=e,this._sizes=this.uniforms.slicesWidth=new Float32Array(e),this._offsets=this.uniforms.slicesOffset=new Float32Array(e),this.refresh())},o.direction.get=function(){return this._direction},o.direction.set=function(e){if(this._direction!==e){this._direction=e;var t=e*n.DEG_TO_RAD;this.uniforms.sinDir=Math.sin(t),this.uniforms.cosDir=Math.cos(t)}},o.red.get=function(){return this.uniforms.red},o.red.set=function(e){this.uniforms.red=e},o.green.get=function(){return this.uniforms.green},o.green.set=function(e){this.uniforms.green=e},o.blue.get=function(){return this.uniforms.blue},o.blue.set=function(e){this.uniforms.blue=e},r.prototype.destroy=function(){this.texture.destroy(!0),this.texture=null,this._canvas=null,this.red=null,this.green=null,this.blue=null,this._sizes=null,this._offsets=null},Object.defineProperties(r.prototype,o),r}(t.Filter);ie.TRANSPARENT=0,ie.ORIGINAL=1,ie.LOOP=2,ie.CLAMP=3,ie.MIRROR=4;var le=a,se="varying vec2 vTextureCoord;\nvarying vec4 vColor;\n\nuniform sampler2D uSampler;\n\nuniform float outerStrength;\nuniform float innerStrength;\n\nuniform vec4 glowColor;\n\nuniform vec4 filterArea;\nuniform vec4 filterClamp;\nuniform bool knockout;\n\nconst float PI = 3.14159265358979323846264;\n\nconst float DIST = __DIST__;\nconst float ANGLE_STEP_SIZE = min(__ANGLE_STEP_SIZE__, PI * 2.0);\nconst float ANGLE_STEP_NUM = ceil(PI * 2.0 / ANGLE_STEP_SIZE);\n\nconst float MAX_TOTAL_ALPHA = ANGLE_STEP_NUM * DIST * (DIST + 1.0) / 2.0;\n\nvoid main(void) {\n    vec2 px = vec2(1.0 / filterArea.x, 1.0 / filterArea.y);\n\n    float totalAlpha = 0.0;\n\n    vec2 direction;\n    vec2 displaced;\n    vec4 curColor;\n\n    for (float angle = 0.0; angle < PI * 2.0; angle += ANGLE_STEP_SIZE) {\n       direction = vec2(cos(angle), sin(angle)) * px;\n\n       for (float curDistance = 0.0; curDistance < DIST; curDistance++) {\n           displaced = clamp(vTextureCoord + direction * \n                   (curDistance + 1.0), filterClamp.xy, filterClamp.zw);\n\n           curColor = texture2D(uSampler, displaced);\n\n           totalAlpha += (DIST - curDistance) * curColor.a;\n       }\n    }\n    \n    curColor = texture2D(uSampler, vTextureCoord);\n\n    float alphaRatio = (totalAlpha / MAX_TOTAL_ALPHA);\n\n    float innerGlowAlpha = (1.0 - alphaRatio) * innerStrength * curColor.a;\n    float innerGlowStrength = min(1.0, innerGlowAlpha);\n    \n    vec4 innerColor = mix(curColor, glowColor, innerGlowStrength);\n\n    float outerGlowAlpha = alphaRatio * outerStrength * (1. - curColor.a);\n    float outerGlowStrength = min(1.0 - innerColor.a, outerGlowAlpha);\n\n    vec4 outerGlowColor = outerGlowStrength * glowColor.rgba;\n    \n    if (knockout) {\n      float resultAlpha = outerGlowAlpha + innerGlowAlpha;\n      gl_FragColor = vec4(glowColor.rgb * resultAlpha, resultAlpha);\n    }\n    else {\n      gl_FragColor = innerColor + outerGlowColor;\n    }\n}\n",ae=function(e){function t(n){var r=Object.assign({},t.defaults,n),o=r.distance,i=r.outerStrength,l=r.innerStrength,s=r.color,a=r.knockout,u=r.quality;o=Math.round(o),e.call(this,le,se.replace(/__ANGLE_STEP_SIZE__/gi,""+(1/u/o).toFixed(7)).replace(/__DIST__/gi,o.toFixed(0)+".0")),this.uniforms.glowColor=new Float32Array([0,0,0,1]),Object.assign(this,{color:s,outerStrength:i,innerStrength:l,padding:o,knockout:a})}e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t;var n={color:{configurable:!0},outerStrength:{configurable:!0},innerStrength:{configurable:!0},knockout:{configurable:!0}};return n.color.get=function(){return o.rgb2hex(this.uniforms.glowColor)},n.color.set=function(e){o.hex2rgb(e,this.uniforms.glowColor)},n.outerStrength.get=function(){return this.uniforms.outerStrength},n.outerStrength.set=function(e){this.uniforms.outerStrength=e},n.innerStrength.get=function(){return this.uniforms.innerStrength},n.innerStrength.set=function(e){this.uniforms.innerStrength=e},n.knockout.get=function(){return this.uniforms.knockout},n.knockout.set=function(e){this.uniforms.knockout=e},Object.defineProperties(t.prototype,n),t}(t.Filter);ae.defaults={distance:10,outerStrength:4,innerStrength:0,color:16777215,quality:.1,knockout:!1};var ue=a,ce="vec3 mod289(vec3 x)\n{\n    return x - floor(x * (1.0 / 289.0)) * 289.0;\n}\nvec4 mod289(vec4 x)\n{\n    return x - floor(x * (1.0 / 289.0)) * 289.0;\n}\nvec4 permute(vec4 x)\n{\n    return mod289(((x * 34.0) + 1.0) * x);\n}\nvec4 taylorInvSqrt(vec4 r)\n{\n    return 1.79284291400159 - 0.85373472095314 * r;\n}\nvec3 fade(vec3 t)\n{\n    return t * t * t * (t * (t * 6.0 - 15.0) + 10.0);\n}\n// Classic Perlin noise, periodic variant\nfloat pnoise(vec3 P, vec3 rep)\n{\n    vec3 Pi0 = mod(floor(P), rep); // Integer part, modulo period\n    vec3 Pi1 = mod(Pi0 + vec3(1.0), rep); // Integer part + 1, mod period\n    Pi0 = mod289(Pi0);\n    Pi1 = mod289(Pi1);\n    vec3 Pf0 = fract(P); // Fractional part for interpolation\n    vec3 Pf1 = Pf0 - vec3(1.0); // Fractional part - 1.0\n    vec4 ix = vec4(Pi0.x, Pi1.x, Pi0.x, Pi1.x);\n    vec4 iy = vec4(Pi0.yy, Pi1.yy);\n    vec4 iz0 = Pi0.zzzz;\n    vec4 iz1 = Pi1.zzzz;\n    vec4 ixy = permute(permute(ix) + iy);\n    vec4 ixy0 = permute(ixy + iz0);\n    vec4 ixy1 = permute(ixy + iz1);\n    vec4 gx0 = ixy0 * (1.0 / 7.0);\n    vec4 gy0 = fract(floor(gx0) * (1.0 / 7.0)) - 0.5;\n    gx0 = fract(gx0);\n    vec4 gz0 = vec4(0.5) - abs(gx0) - abs(gy0);\n    vec4 sz0 = step(gz0, vec4(0.0));\n    gx0 -= sz0 * (step(0.0, gx0) - 0.5);\n    gy0 -= sz0 * (step(0.0, gy0) - 0.5);\n    vec4 gx1 = ixy1 * (1.0 / 7.0);\n    vec4 gy1 = fract(floor(gx1) * (1.0 / 7.0)) - 0.5;\n    gx1 = fract(gx1);\n    vec4 gz1 = vec4(0.5) - abs(gx1) - abs(gy1);\n    vec4 sz1 = step(gz1, vec4(0.0));\n    gx1 -= sz1 * (step(0.0, gx1) - 0.5);\n    gy1 -= sz1 * (step(0.0, gy1) - 0.5);\n    vec3 g000 = vec3(gx0.x, gy0.x, gz0.x);\n    vec3 g100 = vec3(gx0.y, gy0.y, gz0.y);\n    vec3 g010 = vec3(gx0.z, gy0.z, gz0.z);\n    vec3 g110 = vec3(gx0.w, gy0.w, gz0.w);\n    vec3 g001 = vec3(gx1.x, gy1.x, gz1.x);\n    vec3 g101 = vec3(gx1.y, gy1.y, gz1.y);\n    vec3 g011 = vec3(gx1.z, gy1.z, gz1.z);\n    vec3 g111 = vec3(gx1.w, gy1.w, gz1.w);\n    vec4 norm0 = taylorInvSqrt(vec4(dot(g000, g000), dot(g010, g010), dot(g100, g100), dot(g110, g110)));\n    g000 *= norm0.x;\n    g010 *= norm0.y;\n    g100 *= norm0.z;\n    g110 *= norm0.w;\n    vec4 norm1 = taylorInvSqrt(vec4(dot(g001, g001), dot(g011, g011), dot(g101, g101), dot(g111, g111)));\n    g001 *= norm1.x;\n    g011 *= norm1.y;\n    g101 *= norm1.z;\n    g111 *= norm1.w;\n    float n000 = dot(g000, Pf0);\n    float n100 = dot(g100, vec3(Pf1.x, Pf0.yz));\n    float n010 = dot(g010, vec3(Pf0.x, Pf1.y, Pf0.z));\n    float n110 = dot(g110, vec3(Pf1.xy, Pf0.z));\n    float n001 = dot(g001, vec3(Pf0.xy, Pf1.z));\n    float n101 = dot(g101, vec3(Pf1.x, Pf0.y, Pf1.z));\n    float n011 = dot(g011, vec3(Pf0.x, Pf1.yz));\n    float n111 = dot(g111, Pf1);\n    vec3 fade_xyz = fade(Pf0);\n    vec4 n_z = mix(vec4(n000, n100, n010, n110), vec4(n001, n101, n011, n111), fade_xyz.z);\n    vec2 n_yz = mix(n_z.xy, n_z.zw, fade_xyz.y);\n    float n_xyz = mix(n_yz.x, n_yz.y, fade_xyz.x);\n    return 2.2 * n_xyz;\n}\nfloat turb(vec3 P, vec3 rep, float lacunarity, float gain)\n{\n    float sum = 0.0;\n    float sc = 1.0;\n    float totalgain = 1.0;\n    for (float i = 0.0; i < 6.0; i++)\n    {\n        sum += totalgain * pnoise(P * sc, rep);\n        sc *= lacunarity;\n        totalgain *= gain;\n    }\n    return abs(sum);\n}\n",fe="varying vec2 vTextureCoord;\nuniform sampler2D uSampler;\nuniform vec4 filterArea;\nuniform vec2 dimensions;\n\nuniform vec2 light;\nuniform bool parallel;\nuniform float aspect;\n\nuniform float gain;\nuniform float lacunarity;\nuniform float time;\n\n${perlin}\n\nvoid main(void) {\n    vec2 coord = vTextureCoord * filterArea.xy / dimensions.xy;\n\n    float d;\n\n    if (parallel) {\n        float _cos = light.x;\n        float _sin = light.y;\n        d = (_cos * coord.x) + (_sin * coord.y * aspect);\n    } else {\n        float dx = coord.x - light.x / dimensions.x;\n        float dy = (coord.y - light.y / dimensions.y) * aspect;\n        float dis = sqrt(dx * dx + dy * dy) + 0.00001;\n        d = dy / dis;\n    }\n\n    vec3 dir = vec3(d, d, 0.0);\n\n    float noise = turb(dir + vec3(time, 0.0, 62.1 + time) * 0.05, vec3(480.0, 320.0, 480.0), lacunarity, gain);\n    noise = mix(noise, 0.0, 0.3);\n    //fade vertically.\n    vec4 mist = vec4(noise, noise, noise, 1.0) * (1.0 - coord.y);\n    mist.a = 1.0;\n\n    gl_FragColor = texture2D(uSampler, vTextureCoord) + mist;\n}\n",he=function(e){function t(t){e.call(this,ue,fe.replace("${perlin}",ce)),this.uniforms.dimensions=new Float32Array(2),"number"==typeof t&&(console.warn("GodrayFilter now uses options instead of (angle, gain, lacunarity, time)"),t={angle:t},void 0!==arguments[1]&&(t.gain=arguments[1]),void 0!==arguments[2]&&(t.lacunarity=arguments[2]),void 0!==arguments[3]&&(t.time=arguments[3])),t=Object.assign({angle:30,gain:.5,lacunarity:2.5,time:0,parallel:!0,center:[0,0]},t),this._angleLight=new n.Point,this.angle=t.angle,this.gain=t.gain,this.lacunarity=t.lacunarity,this.parallel=t.parallel,this.center=t.center,this.time=t.time}e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t;var r={angle:{configurable:!0},gain:{configurable:!0},lacunarity:{configurable:!0}};return t.prototype.apply=function(e,t,n,r){var o=t.filterFrame,i=o.width,l=o.height;this.uniforms.light=this.parallel?this._angleLight:this.center,this.uniforms.parallel=this.parallel,this.uniforms.dimensions[0]=i,this.uniforms.dimensions[1]=l,this.uniforms.aspect=l/i,this.uniforms.time=this.time,e.applyFilter(this,t,n,r)},r.angle.get=function(){return this._angle},r.angle.set=function(e){this._angle=e;var t=e*n.DEG_TO_RAD;this._angleLight.x=Math.cos(t),this._angleLight.y=Math.sin(t)},r.gain.get=function(){return this.uniforms.gain},r.gain.set=function(e){this.uniforms.gain=e},r.lacunarity.get=function(){return this.uniforms.lacunarity},r.lacunarity.set=function(e){this.uniforms.lacunarity=e},Object.defineProperties(t.prototype,r),t}(t.Filter),pe=a,de="varying vec2 vTextureCoord;\nuniform sampler2D uSampler;\nuniform vec4 filterArea;\n\nuniform vec2 uVelocity;\nuniform int uKernelSize;\nuniform float uOffset;\n\nconst int MAX_KERNEL_SIZE = 2048;\n\n// Notice:\n// the perfect way:\n//    int kernelSize = min(uKernelSize, MAX_KERNELSIZE);\n// BUT in real use-case , uKernelSize < MAX_KERNELSIZE almost always.\n// So use uKernelSize directly.\n\nvoid main(void)\n{\n    vec4 color = texture2D(uSampler, vTextureCoord);\n\n    if (uKernelSize == 0)\n    {\n        gl_FragColor = color;\n        return;\n    }\n\n    vec2 velocity = uVelocity / filterArea.xy;\n    float offset = -uOffset / length(uVelocity) - 0.5;\n    int k = uKernelSize - 1;\n\n    for(int i = 0; i < MAX_KERNEL_SIZE - 1; i++) {\n        if (i == k) {\n            break;\n        }\n        vec2 bias = velocity * (float(i) / float(k) + offset);\n        color += texture2D(uSampler, vTextureCoord + bias);\n    }\n    gl_FragColor = color / float(uKernelSize);\n}\n",me=function(e){function t(t,r,o){void 0===t&&(t=[0,0]),void 0===r&&(r=5),void 0===o&&(o=0),e.call(this,pe,de),this.uniforms.uVelocity=new Float32Array(2),this._velocity=new n.ObservablePoint(this.velocityChanged,this),this.velocity=t,this.kernelSize=r,this.offset=o}e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t;var r={velocity:{configurable:!0},offset:{configurable:!0}};return t.prototype.apply=function(e,t,n,r){var o=this.velocity,i=o.x,l=o.y;this.uniforms.uKernelSize=0!==i||0!==l?this.kernelSize:0,e.applyFilter(this,t,n,r)},r.velocity.set=function(e){Array.isArray(e)?this._velocity.set(e[0],e[1]):(e instanceof n.Point||e instanceof n.ObservablePoint)&&this._velocity.copyFrom(e)},r.velocity.get=function(){return this._velocity},t.prototype.velocityChanged=function(){this.uniforms.uVelocity[0]=this._velocity.x,this.uniforms.uVelocity[1]=this._velocity.y},r.offset.set=function(e){this.uniforms.uOffset=e},r.offset.get=function(){return this.uniforms.uOffset},Object.defineProperties(t.prototype,r),t}(t.Filter),ge=a,ve="varying vec2 vTextureCoord;\nuniform sampler2D uSampler;\n\nuniform float epsilon;\n\nconst int MAX_COLORS = %maxColors%;\n\nuniform vec3 originalColors[MAX_COLORS];\nuniform vec3 targetColors[MAX_COLORS];\n\nvoid main(void)\n{\n    gl_FragColor = texture2D(uSampler, vTextureCoord);\n\n    float alpha = gl_FragColor.a;\n    if (alpha < 0.0001)\n    {\n      return;\n    }\n\n    vec3 color = gl_FragColor.rgb / alpha;\n\n    for(int i = 0; i < MAX_COLORS; i++)\n    {\n      vec3 origColor = originalColors[i];\n      if (origColor.r < 0.0)\n      {\n        break;\n      }\n      vec3 colorDiff = origColor - color;\n      if (length(colorDiff) < epsilon)\n      {\n        vec3 targetColor = targetColors[i];\n        gl_FragColor = vec4((targetColor + colorDiff) * alpha, alpha);\n        return;\n      }\n    }\n}\n",xe=function(e){function t(t,n,r){void 0===n&&(n=.05),void 0===r&&(r=null),r=r||t.length,e.call(this,ge,ve.replace(/%maxColors%/g,r)),this.epsilon=n,this._maxColors=r,this._replacements=null,this.uniforms.originalColors=new Float32Array(3*r),this.uniforms.targetColors=new Float32Array(3*r),this.replacements=t}e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t;var n={replacements:{configurable:!0},maxColors:{configurable:!0},epsilon:{configurable:!0}};return n.replacements.set=function(e){var t=this.uniforms.originalColors,n=this.uniforms.targetColors,r=e.length;if(r>this._maxColors)throw"Length of replacements ("+r+") exceeds the maximum colors length ("+this._maxColors+")";t[3*r]=-1;for(var i=0;i<r;i++){var l=e[i],s=l[0];"number"==typeof s?s=o.hex2rgb(s):l[0]=o.rgb2hex(s),t[3*i]=s[0],t[3*i+1]=s[1],t[3*i+2]=s[2];var a=l[1];"number"==typeof a?a=o.hex2rgb(a):l[1]=o.rgb2hex(a),n[3*i]=a[0],n[3*i+1]=a[1],n[3*i+2]=a[2]}this._replacements=e},n.replacements.get=function(){return this._replacements},t.prototype.refresh=function(){this.replacements=this._replacements},n.maxColors.get=function(){return this._maxColors},n.epsilon.set=function(e){this.uniforms.epsilon=e},n.epsilon.get=function(){return this.uniforms.epsilon},Object.defineProperties(t.prototype,n),t}(t.Filter),ye=a,_e="varying vec2 vTextureCoord;\nuniform sampler2D uSampler;\nuniform vec4 filterArea;\nuniform vec2 dimensions;\n\nuniform float sepia;\nuniform float noise;\nuniform float noiseSize;\nuniform float scratch;\nuniform float scratchDensity;\nuniform float scratchWidth;\nuniform float vignetting;\nuniform float vignettingAlpha;\nuniform float vignettingBlur;\nuniform float seed;\n\nconst float SQRT_2 = 1.414213;\nconst vec3 SEPIA_RGB = vec3(112.0 / 255.0, 66.0 / 255.0, 20.0 / 255.0);\n\nfloat rand(vec2 co) {\n    return fract(sin(dot(co.xy, vec2(12.9898, 78.233))) * 43758.5453);\n}\n\nvec3 Overlay(vec3 src, vec3 dst)\n{\n    // if (dst <= 0.5) then: 2 * src * dst\n    // if (dst > 0.5) then: 1 - 2 * (1 - dst) * (1 - src)\n    return vec3((dst.x <= 0.5) ? (2.0 * src.x * dst.x) : (1.0 - 2.0 * (1.0 - dst.x) * (1.0 - src.x)),\n                (dst.y <= 0.5) ? (2.0 * src.y * dst.y) : (1.0 - 2.0 * (1.0 - dst.y) * (1.0 - src.y)),\n                (dst.z <= 0.5) ? (2.0 * src.z * dst.z) : (1.0 - 2.0 * (1.0 - dst.z) * (1.0 - src.z)));\n}\n\n\nvoid main()\n{\n    gl_FragColor = texture2D(uSampler, vTextureCoord);\n    vec3 color = gl_FragColor.rgb;\n\n    if (sepia > 0.0)\n    {\n        float gray = (color.x + color.y + color.z) / 3.0;\n        vec3 grayscale = vec3(gray);\n\n        color = Overlay(SEPIA_RGB, grayscale);\n\n        color = grayscale + sepia * (color - grayscale);\n    }\n\n    vec2 coord = vTextureCoord * filterArea.xy / dimensions.xy;\n\n    if (vignetting > 0.0)\n    {\n        float outter = SQRT_2 - vignetting * SQRT_2;\n        vec2 dir = vec2(vec2(0.5, 0.5) - coord);\n        dir.y *= dimensions.y / dimensions.x;\n        float darker = clamp((outter - length(dir) * SQRT_2) / ( 0.00001 + vignettingBlur * SQRT_2), 0.0, 1.0);\n        color.rgb *= darker + (1.0 - darker) * (1.0 - vignettingAlpha);\n    }\n\n    if (scratchDensity > seed && scratch != 0.0)\n    {\n        float phase = seed * 256.0;\n        float s = mod(floor(phase), 2.0);\n        float dist = 1.0 / scratchDensity;\n        float d = distance(coord, vec2(seed * dist, abs(s - seed * dist)));\n        if (d < seed * 0.6 + 0.4)\n        {\n            highp float period = scratchDensity * 10.0;\n\n            float xx = coord.x * period + phase;\n            float aa = abs(mod(xx, 0.5) * 4.0);\n            float bb = mod(floor(xx / 0.5), 2.0);\n            float yy = (1.0 - bb) * aa + bb * (2.0 - aa);\n\n            float kk = 2.0 * period;\n            float dw = scratchWidth / dimensions.x * (0.75 + seed);\n            float dh = dw * kk;\n\n            float tine = (yy - (2.0 - dh));\n\n            if (tine > 0.0) {\n                float _sign = sign(scratch);\n\n                tine = s * tine / period + scratch + 0.1;\n                tine = clamp(tine + 1.0, 0.5 + _sign * 0.5, 1.5 + _sign * 0.5);\n\n                color.rgb *= tine;\n            }\n        }\n    }\n\n    if (noise > 0.0 && noiseSize > 0.0)\n    {\n        vec2 pixelCoord = vTextureCoord.xy * filterArea.xy;\n        pixelCoord.x = floor(pixelCoord.x / noiseSize);\n        pixelCoord.y = floor(pixelCoord.y / noiseSize);\n        // vec2 d = pixelCoord * noiseSize * vec2(1024.0 + seed * 512.0, 1024.0 - seed * 512.0);\n        // float _noise = snoise(d) * 0.5;\n        float _noise = rand(pixelCoord * noiseSize * seed) - 0.5;\n        color += _noise * noise;\n    }\n\n    gl_FragColor.rgb = color;\n}\n",be=function(e){function t(t,n){void 0===n&&(n=0),e.call(this,ye,_e),this.uniforms.dimensions=new Float32Array(2),"number"==typeof t?(this.seed=t,t=null):this.seed=n,Object.assign(this,{sepia:.3,noise:.3,noiseSize:1,scratch:.5,scratchDensity:.3,scratchWidth:1,vignetting:.3,vignettingAlpha:1,vignettingBlur:.3},t)}e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t;var n={sepia:{configurable:!0},noise:{configurable:!0},noiseSize:{configurable:!0},scratch:{configurable:!0},scratchDensity:{configurable:!0},scratchWidth:{configurable:!0},vignetting:{configurable:!0},vignettingAlpha:{configurable:!0},vignettingBlur:{configurable:!0}};return t.prototype.apply=function(e,t,n,r){this.uniforms.dimensions[0]=t.filterFrame.width,this.uniforms.dimensions[1]=t.filterFrame.height,this.uniforms.seed=this.seed,e.applyFilter(this,t,n,r)},n.sepia.set=function(e){this.uniforms.sepia=e},n.sepia.get=function(){return this.uniforms.sepia},n.noise.set=function(e){this.uniforms.noise=e},n.noise.get=function(){return this.uniforms.noise},n.noiseSize.set=function(e){this.uniforms.noiseSize=e},n.noiseSize.get=function(){return this.uniforms.noiseSize},n.scratch.set=function(e){this.uniforms.scratch=e},n.scratch.get=function(){return this.uniforms.scratch},n.scratchDensity.set=function(e){this.uniforms.scratchDensity=e},n.scratchDensity.get=function(){return this.uniforms.scratchDensity},n.scratchWidth.set=function(e){this.uniforms.scratchWidth=e},n.scratchWidth.get=function(){return this.uniforms.scratchWidth},n.vignetting.set=function(e){this.uniforms.vignetting=e},n.vignetting.get=function(){return this.uniforms.vignetting},n.vignettingAlpha.set=function(e){this.uniforms.vignettingAlpha=e},n.vignettingAlpha.get=function(){return this.uniforms.vignettingAlpha},n.vignettingBlur.set=function(e){this.uniforms.vignettingBlur=e},n.vignettingBlur.get=function(){return this.uniforms.vignettingBlur},Object.defineProperties(t.prototype,n),t}(t.Filter),Ce=a,Se="varying vec2 vTextureCoord;\nuniform sampler2D uSampler;\n\nuniform vec2 thickness;\nuniform vec4 outlineColor;\nuniform vec4 filterClamp;\n\nconst float DOUBLE_PI = 3.14159265358979323846264 * 2.;\n\nvoid main(void) {\n    vec4 ownColor = texture2D(uSampler, vTextureCoord);\n    vec4 curColor;\n    float maxAlpha = 0.;\n    vec2 displaced;\n    for (float angle = 0.; angle <= DOUBLE_PI; angle += ${angleStep}) {\n        displaced.x = vTextureCoord.x + thickness.x * cos(angle);\n        displaced.y = vTextureCoord.y + thickness.y * sin(angle);\n        curColor = texture2D(uSampler, clamp(displaced, filterClamp.xy, filterClamp.zw));\n        maxAlpha = max(maxAlpha, curColor.a);\n    }\n    float resultAlpha = max(maxAlpha, ownColor.a);\n    gl_FragColor = vec4((ownColor.rgb + outlineColor.rgb * (1. - ownColor.a)) * resultAlpha, resultAlpha);\n}\n",Fe=function(e){function t(n,r,o){void 0===n&&(n=1),void 0===r&&(r=0),void 0===o&&(o=.1);var i=Math.max(o*t.MAX_SAMPLES,t.MIN_SAMPLES),l=(2*Math.PI/i).toFixed(7);e.call(this,Ce,Se.replace(/\$\{angleStep\}/,l)),this.uniforms.thickness=new Float32Array([0,0]),this.thickness=n,this.uniforms.outlineColor=new Float32Array([0,0,0,1]),this.color=r,this.quality=o}e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t;var n={color:{configurable:!0}};return t.prototype.apply=function(e,t,n,r){this.uniforms.thickness[0]=this.thickness/t._frame.width,this.uniforms.thickness[1]=this.thickness/t._frame.height,e.applyFilter(this,t,n,r)},n.color.get=function(){return o.rgb2hex(this.uniforms.outlineColor)},n.color.set=function(e){o.hex2rgb(e,this.uniforms.outlineColor)},Object.defineProperties(t.prototype,n),t}(t.Filter);Fe.MIN_SAMPLES=1,Fe.MAX_SAMPLES=100;var ze=a,Ae="precision mediump float;\n\nvarying vec2 vTextureCoord;\n\nuniform vec2 size;\nuniform sampler2D uSampler;\n\nuniform vec4 filterArea;\n\nvec2 mapCoord( vec2 coord )\n{\n    coord *= filterArea.xy;\n    coord += filterArea.zw;\n\n    return coord;\n}\n\nvec2 unmapCoord( vec2 coord )\n{\n    coord -= filterArea.zw;\n    coord /= filterArea.xy;\n\n    return coord;\n}\n\nvec2 pixelate(vec2 coord, vec2 size)\n{\n\treturn floor( coord / size ) * size;\n}\n\nvoid main(void)\n{\n    vec2 coord = mapCoord(vTextureCoord);\n\n    coord = pixelate(coord, size);\n\n    coord = unmapCoord(coord);\n\n    gl_FragColor = texture2D(uSampler, coord);\n}\n",we=function(e){function t(t){void 0===t&&(t=10),e.call(this,ze,Ae),this.size=t}e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t;var n={size:{configurable:!0}};return n.size.get=function(){return this.uniforms.size},n.size.set=function(e){"number"==typeof e&&(e=[e,e]),this.uniforms.size=e},Object.defineProperties(t.prototype,n),t}(t.Filter),Te=a,Oe="varying vec2 vTextureCoord;\nuniform sampler2D uSampler;\nuniform vec4 filterArea;\n\nuniform float uRadian;\nuniform vec2 uCenter;\nuniform float uRadius;\nuniform int uKernelSize;\n\nconst int MAX_KERNEL_SIZE = 2048;\n\nvoid main(void)\n{\n    vec4 color = texture2D(uSampler, vTextureCoord);\n\n    if (uKernelSize == 0)\n    {\n        gl_FragColor = color;\n        return;\n    }\n\n    float aspect = filterArea.y / filterArea.x;\n    vec2 center = uCenter.xy / filterArea.xy;\n    float gradient = uRadius / filterArea.x * 0.3;\n    float radius = uRadius / filterArea.x - gradient * 0.5;\n    int k = uKernelSize - 1;\n\n    vec2 coord = vTextureCoord;\n    vec2 dir = vec2(center - coord);\n    float dist = length(vec2(dir.x, dir.y * aspect));\n\n    float radianStep = uRadian;\n    if (radius >= 0.0 && dist > radius) {\n        float delta = dist - radius;\n        float gap = gradient;\n        float scale = 1.0 - abs(delta / gap);\n        if (scale <= 0.0) {\n            gl_FragColor = color;\n            return;\n        }\n        radianStep *= scale;\n    }\n    radianStep /= float(k);\n\n    float s = sin(radianStep);\n    float c = cos(radianStep);\n    mat2 rotationMatrix = mat2(vec2(c, -s), vec2(s, c));\n\n    for(int i = 0; i < MAX_KERNEL_SIZE - 1; i++) {\n        if (i == k) {\n            break;\n        }\n\n        coord -= center;\n        coord.y *= aspect;\n        coord = rotationMatrix * coord;\n        coord.y /= aspect;\n        coord += center;\n\n        vec4 sample = texture2D(uSampler, coord);\n\n        // switch to pre-multiplied alpha to correctly blur transparent images\n        // sample.rgb *= sample.a;\n\n        color += sample;\n    }\n\n    gl_FragColor = color / float(uKernelSize);\n}\n",De=function(e){function t(t,n,r,o){void 0===t&&(t=0),void 0===n&&(n=[0,0]),void 0===r&&(r=5),void 0===o&&(o=-1),e.call(this,Te,Oe),this._angle=0,this.angle=t,this.center=n,this.kernelSize=r,this.radius=o}e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t;var n={angle:{configurable:!0},center:{configurable:!0},radius:{configurable:!0}};return t.prototype.apply=function(e,t,n,r){this.uniforms.uKernelSize=0!==this._angle?this.kernelSize:0,e.applyFilter(this,t,n,r)},n.angle.set=function(e){this._angle=e,this.uniforms.uRadian=e*Math.PI/180},n.angle.get=function(){return this._angle},n.center.get=function(){return this.uniforms.uCenter},n.center.set=function(e){this.uniforms.uCenter=e},n.radius.get=function(){return this.uniforms.uRadius},n.radius.set=function(e){(e<0||e===1/0)&&(e=-1),this.uniforms.uRadius=e},Object.defineProperties(t.prototype,n),t}(t.Filter),Pe=a,Me="varying vec2 vTextureCoord;\nuniform sampler2D uSampler;\n\nuniform vec4 filterArea;\nuniform vec4 filterClamp;\nuniform vec2 dimensions;\n\nuniform bool mirror;\nuniform float boundary;\nuniform vec2 amplitude;\nuniform vec2 waveLength;\nuniform vec2 alpha;\nuniform float time;\n\nfloat rand(vec2 co) {\n    return fract(sin(dot(co.xy, vec2(12.9898, 78.233))) * 43758.5453);\n}\n\nvoid main(void)\n{\n    vec2 pixelCoord = vTextureCoord.xy * filterArea.xy;\n    vec2 coord = pixelCoord / dimensions;\n\n    if (coord.y < boundary) {\n        gl_FragColor = texture2D(uSampler, vTextureCoord);\n        return;\n    }\n\n    float k = (coord.y - boundary) / (1. - boundary + 0.0001);\n    float areaY = boundary * dimensions.y / filterArea.y;\n    float v = areaY + areaY - vTextureCoord.y;\n    float y = mirror ? v : vTextureCoord.y;\n\n    float _amplitude = ((amplitude.y - amplitude.x) * k + amplitude.x ) / filterArea.x;\n    float _waveLength = ((waveLength.y - waveLength.x) * k + waveLength.x) / filterArea.y;\n    float _alpha = (alpha.y - alpha.x) * k + alpha.x;\n\n    float x = vTextureCoord.x + cos(v * 6.28 / _waveLength - time) * _amplitude;\n    x = clamp(x, filterClamp.x, filterClamp.z);\n\n    vec4 color = texture2D(uSampler, vec2(x, y));\n\n    gl_FragColor = color * _alpha;\n}\n",Re=function(e){function t(t){e.call(this,Pe,Me),this.uniforms.amplitude=new Float32Array(2),this.uniforms.waveLength=new Float32Array(2),this.uniforms.alpha=new Float32Array(2),this.uniforms.dimensions=new Float32Array(2),Object.assign(this,{mirror:!0,boundary:.5,amplitude:[0,20],waveLength:[30,100],alpha:[1,1],time:0},t)}e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t;var n={mirror:{configurable:!0},boundary:{configurable:!0},amplitude:{configurable:!0},waveLength:{configurable:!0},alpha:{configurable:!0}};return t.prototype.apply=function(e,t,n,r){this.uniforms.dimensions[0]=t.filterFrame.width,this.uniforms.dimensions[1]=t.filterFrame.height,this.uniforms.time=this.time,e.applyFilter(this,t,n,r)},n.mirror.set=function(e){this.uniforms.mirror=e},n.mirror.get=function(){return this.uniforms.mirror},n.boundary.set=function(e){this.uniforms.boundary=e},n.boundary.get=function(){return this.uniforms.boundary},n.amplitude.set=function(e){this.uniforms.amplitude[0]=e[0],this.uniforms.amplitude[1]=e[1]},n.amplitude.get=function(){return this.uniforms.amplitude},n.waveLength.set=function(e){this.uniforms.waveLength[0]=e[0],this.uniforms.waveLength[1]=e[1]},n.waveLength.get=function(){return this.uniforms.waveLength},n.alpha.set=function(e){this.uniforms.alpha[0]=e[0],this.uniforms.alpha[1]=e[1]},n.alpha.get=function(){return this.uniforms.alpha},Object.defineProperties(t.prototype,n),t}(t.Filter),ke=a,je="precision mediump float;\n\nvarying vec2 vTextureCoord;\n\nuniform sampler2D uSampler;\nuniform vec4 filterArea;\nuniform vec2 red;\nuniform vec2 green;\nuniform vec2 blue;\n\nvoid main(void)\n{\n   gl_FragColor.r = texture2D(uSampler, vTextureCoord + red/filterArea.xy).r;\n   gl_FragColor.g = texture2D(uSampler, vTextureCoord + green/filterArea.xy).g;\n   gl_FragColor.b = texture2D(uSampler, vTextureCoord + blue/filterArea.xy).b;\n   gl_FragColor.a = texture2D(uSampler, vTextureCoord).a;\n}\n",Ee=function(e){function t(t,n,r){void 0===t&&(t=[-10,0]),void 0===n&&(n=[0,10]),void 0===r&&(r=[0,0]),e.call(this,ke,je),this.red=t,this.green=n,this.blue=r}e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t;var n={red:{configurable:!0},green:{configurable:!0},blue:{configurable:!0}};return n.red.get=function(){return this.uniforms.red},n.red.set=function(e){this.uniforms.red=e},n.green.get=function(){return this.uniforms.green},n.green.set=function(e){this.uniforms.green=e},n.blue.get=function(){return this.uniforms.blue},n.blue.set=function(e){this.uniforms.blue=e},Object.defineProperties(t.prototype,n),t}(t.Filter),Le=a,Ie="varying vec2 vTextureCoord;\nuniform sampler2D uSampler;\nuniform vec4 filterArea;\nuniform vec4 filterClamp;\n\nuniform vec2 center;\n\nuniform float amplitude;\nuniform float wavelength;\n// uniform float power;\nuniform float brightness;\nuniform float speed;\nuniform float radius;\n\nuniform float time;\n\nconst float PI = 3.14159;\n\nvoid main()\n{\n    float halfWavelength = wavelength * 0.5 / filterArea.x;\n    float maxRadius = radius / filterArea.x;\n    float currentRadius = time * speed / filterArea.x;\n\n    float fade = 1.0;\n\n    if (maxRadius > 0.0) {\n        if (currentRadius > maxRadius) {\n            gl_FragColor = texture2D(uSampler, vTextureCoord);\n            return;\n        }\n        fade = 1.0 - pow(currentRadius / maxRadius, 2.0);\n    }\n\n    vec2 dir = vec2(vTextureCoord - center / filterArea.xy);\n    dir.y *= filterArea.y / filterArea.x;\n    float dist = length(dir);\n\n    if (dist <= 0.0 || dist < currentRadius - halfWavelength || dist > currentRadius + halfWavelength) {\n        gl_FragColor = texture2D(uSampler, vTextureCoord);\n        return;\n    }\n\n    vec2 diffUV = normalize(dir);\n\n    float diff = (dist - currentRadius) / halfWavelength;\n\n    float p = 1.0 - pow(abs(diff), 2.0);\n\n    // float powDiff = diff * pow(p, 2.0) * ( amplitude * fade );\n    float powDiff = 1.25 * sin(diff * PI) * p * ( amplitude * fade );\n\n    vec2 offset = diffUV * powDiff / filterArea.xy;\n\n    // Do clamp :\n    vec2 coord = vTextureCoord + offset;\n    vec2 clampedCoord = clamp(coord, filterClamp.xy, filterClamp.zw);\n    vec4 color = texture2D(uSampler, clampedCoord);\n    if (coord != clampedCoord) {\n        color *= max(0.0, 1.0 - length(coord - clampedCoord));\n    }\n\n    // No clamp :\n    // gl_FragColor = texture2D(uSampler, vTextureCoord + offset);\n\n    color.rgb *= 1.0 + (brightness - 1.0) * p * fade;\n\n    gl_FragColor = color;\n}\n",Xe=function(e){function t(t,n,r){void 0===t&&(t=[0,0]),void 0===n&&(n={}),void 0===r&&(r=0),e.call(this,Le,Ie),this.center=t,Array.isArray(n)&&(console.warn("Deprecated Warning: ShockwaveFilter params Array has been changed to options Object."),n={}),n=Object.assign({amplitude:30,wavelength:160,brightness:1,speed:500,radius:-1},n),this.amplitude=n.amplitude,this.wavelength=n.wavelength,this.brightness=n.brightness,this.speed=n.speed,this.radius=n.radius,this.time=r}e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t;var n={center:{configurable:!0},amplitude:{configurable:!0},wavelength:{configurable:!0},brightness:{configurable:!0},speed:{configurable:!0},radius:{configurable:!0}};return t.prototype.apply=function(e,t,n,r){this.uniforms.time=this.time,e.applyFilter(this,t,n,r)},n.center.get=function(){return this.uniforms.center},n.center.set=function(e){this.uniforms.center=e},n.amplitude.get=function(){return this.uniforms.amplitude},n.amplitude.set=function(e){this.uniforms.amplitude=e},n.wavelength.get=function(){return this.uniforms.wavelength},n.wavelength.set=function(e){this.uniforms.wavelength=e},n.brightness.get=function(){return this.uniforms.brightness},n.brightness.set=function(e){this.uniforms.brightness=e},n.speed.get=function(){return this.uniforms.speed},n.speed.set=function(e){this.uniforms.speed=e},n.radius.get=function(){return this.uniforms.radius},n.radius.set=function(e){this.uniforms.radius=e},Object.defineProperties(t.prototype,n),t}(t.Filter),Be=a,Ne="varying vec2 vTextureCoord;\nuniform sampler2D uSampler;\nuniform sampler2D uLightmap;\nuniform vec4 filterArea;\nuniform vec2 dimensions;\nuniform vec4 ambientColor;\nvoid main() {\n    vec4 diffuseColor = texture2D(uSampler, vTextureCoord);\n    vec2 lightCoord = (vTextureCoord * filterArea.xy) / dimensions;\n    vec4 light = texture2D(uLightmap, lightCoord);\n    vec3 ambient = ambientColor.rgb * ambientColor.a;\n    vec3 intensity = ambient + light.rgb;\n    vec3 finalColor = diffuseColor.rgb * intensity;\n    gl_FragColor = vec4(finalColor, diffuseColor.a);\n}\n",Ge=function(e){function t(t,n,r){void 0===n&&(n=0),void 0===r&&(r=1),e.call(this,Be,Ne),this.uniforms.dimensions=new Float32Array(2),this.uniforms.ambientColor=new Float32Array([0,0,0,r]),this.texture=t,this.color=n}e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t;var n={texture:{configurable:!0},color:{configurable:!0},alpha:{configurable:!0}};return t.prototype.apply=function(e,t,n,r){this.uniforms.dimensions[0]=t.filterFrame.width,this.uniforms.dimensions[1]=t.filterFrame.height,e.applyFilter(this,t,n,r)},n.texture.get=function(){return this.uniforms.uLightmap},n.texture.set=function(e){this.uniforms.uLightmap=e},n.color.set=function(e){var t=this.uniforms.ambientColor;"number"==typeof e?(o.hex2rgb(e,t),this._color=e):(t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],this._color=o.rgb2hex(t))},n.color.get=function(){return this._color},n.alpha.get=function(){return this.uniforms.ambientColor[3]},n.alpha.set=function(e){this.uniforms.ambientColor[3]=e},Object.defineProperties(t.prototype,n),t}(t.Filter),qe=a,We="varying vec2 vTextureCoord;\n\nuniform sampler2D uSampler;\nuniform float blur;\nuniform float gradientBlur;\nuniform vec2 start;\nuniform vec2 end;\nuniform vec2 delta;\nuniform vec2 texSize;\n\nfloat random(vec3 scale, float seed)\n{\n    return fract(sin(dot(gl_FragCoord.xyz + seed, scale)) * 43758.5453 + seed);\n}\n\nvoid main(void)\n{\n    vec4 color = vec4(0.0);\n    float total = 0.0;\n\n    float offset = random(vec3(12.9898, 78.233, 151.7182), 0.0);\n    vec2 normal = normalize(vec2(start.y - end.y, end.x - start.x));\n    float radius = smoothstep(0.0, 1.0, abs(dot(vTextureCoord * texSize - start, normal)) / gradientBlur) * blur;\n\n    for (float t = -30.0; t <= 30.0; t++)\n    {\n        float percent = (t + offset - 0.5) / 30.0;\n        float weight = 1.0 - abs(percent);\n        vec4 sample = texture2D(uSampler, vTextureCoord + delta / texSize * percent * radius);\n        sample.rgb *= sample.a;\n        color += sample * weight;\n        total += weight;\n    }\n\n    color /= total;\n    color.rgb /= color.a + 0.00001;\n\n    gl_FragColor = color;\n}\n",Ke=function(e){function t(t,r,o,i){void 0===t&&(t=100),void 0===r&&(r=600),void 0===o&&(o=null),void 0===i&&(i=null),e.call(this,qe,We),this.uniforms.blur=t,this.uniforms.gradientBlur=r,this.uniforms.start=o||new n.Point(0,window.innerHeight/2),this.uniforms.end=i||new n.Point(600,window.innerHeight/2),this.uniforms.delta=new n.Point(30,30),this.uniforms.texSize=new n.Point(window.innerWidth,window.innerHeight),this.updateDelta()}e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t;var r={blur:{configurable:!0},gradientBlur:{configurable:!0},start:{configurable:!0},end:{configurable:!0}};return t.prototype.updateDelta=function(){this.uniforms.delta.x=0,this.uniforms.delta.y=0},r.blur.get=function(){return this.uniforms.blur},r.blur.set=function(e){this.uniforms.blur=e},r.gradientBlur.get=function(){return this.uniforms.gradientBlur},r.gradientBlur.set=function(e){this.uniforms.gradientBlur=e},r.start.get=function(){return this.uniforms.start},r.start.set=function(e){this.uniforms.start=e,this.updateDelta()},r.end.get=function(){return this.uniforms.end},r.end.set=function(e){this.uniforms.end=e,this.updateDelta()},Object.defineProperties(t.prototype,r),t}(t.Filter),Ye=function(e){function t(){e.apply(this,arguments)}return e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t,t.prototype.updateDelta=function(){var e=this.uniforms.end.x-this.uniforms.start.x,t=this.uniforms.end.y-this.uniforms.start.y,n=Math.sqrt(e*e+t*t);this.uniforms.delta.x=e/n,this.uniforms.delta.y=t/n},t}(Ke),Ze=function(e){function t(){e.apply(this,arguments)}return e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t,t.prototype.updateDelta=function(){var e=this.uniforms.end.x-this.uniforms.start.x,t=this.uniforms.end.y-this.uniforms.start.y,n=Math.sqrt(e*e+t*t);this.uniforms.delta.x=-t/n,this.uniforms.delta.y=e/n},t}(Ke),Qe=function(e){function t(t,n,r,o){void 0===t&&(t=100),void 0===n&&(n=600),void 0===r&&(r=null),void 0===o&&(o=null),e.call(this),this.tiltShiftXFilter=new Ye(t,n,r,o),this.tiltShiftYFilter=new Ze(t,n,r,o)}e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t;var n={blur:{configurable:!0},gradientBlur:{configurable:!0},start:{configurable:!0},end:{configurable:!0}};return t.prototype.apply=function(e,t,n){var r=e.getFilterTexture();this.tiltShiftXFilter.apply(e,t,r),this.tiltShiftYFilter.apply(e,r,n),e.returnFilterTexture(r)},n.blur.get=function(){return this.tiltShiftXFilter.blur},n.blur.set=function(e){this.tiltShiftXFilter.blur=this.tiltShiftYFilter.blur=e},n.gradientBlur.get=function(){return this.tiltShiftXFilter.gradientBlur},n.gradientBlur.set=function(e){this.tiltShiftXFilter.gradientBlur=this.tiltShiftYFilter.gradientBlur=e},n.start.get=function(){return this.tiltShiftXFilter.start},n.start.set=function(e){this.tiltShiftXFilter.start=this.tiltShiftYFilter.start=e},n.end.get=function(){return this.tiltShiftXFilter.end},n.end.set=function(e){this.tiltShiftXFilter.end=this.tiltShiftYFilter.end=e},Object.defineProperties(t.prototype,n),t}(t.Filter),Ue=a,Ve="varying vec2 vTextureCoord;\n\nuniform sampler2D uSampler;\nuniform float radius;\nuniform float angle;\nuniform vec2 offset;\nuniform vec4 filterArea;\n\nvec2 mapCoord( vec2 coord )\n{\n    coord *= filterArea.xy;\n    coord += filterArea.zw;\n\n    return coord;\n}\n\nvec2 unmapCoord( vec2 coord )\n{\n    coord -= filterArea.zw;\n    coord /= filterArea.xy;\n\n    return coord;\n}\n\nvec2 twist(vec2 coord)\n{\n    coord -= offset;\n\n    float dist = length(coord);\n\n    if (dist < radius)\n    {\n        float ratioDist = (radius - dist) / radius;\n        float angleMod = ratioDist * ratioDist * angle;\n        float s = sin(angleMod);\n        float c = cos(angleMod);\n        coord = vec2(coord.x * c - coord.y * s, coord.x * s + coord.y * c);\n    }\n\n    coord += offset;\n\n    return coord;\n}\n\nvoid main(void)\n{\n\n    vec2 coord = mapCoord(vTextureCoord);\n\n    coord = twist(coord);\n\n    coord = unmapCoord(coord);\n\n    gl_FragColor = texture2D(uSampler, coord );\n\n}\n",He=function(e){function t(t,n,r){void 0===t&&(t=200),void 0===n&&(n=4),void 0===r&&(r=20),e.call(this,Ue,Ve),this.radius=t,this.angle=n,this.padding=r}e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t;var n={offset:{configurable:!0},radius:{configurable:!0},angle:{configurable:!0}};return n.offset.get=function(){return this.uniforms.offset},n.offset.set=function(e){this.uniforms.offset=e},n.radius.get=function(){return this.uniforms.radius},n.radius.set=function(e){this.uniforms.radius=e},n.angle.get=function(){return this.uniforms.angle},n.angle.set=function(e){this.uniforms.angle=e},Object.defineProperties(t.prototype,n),t}(t.Filter),$e=a,Je="varying vec2 vTextureCoord;\nuniform sampler2D uSampler;\nuniform vec4 filterArea;\n\nuniform vec2 uCenter;\nuniform float uStrength;\nuniform float uInnerRadius;\nuniform float uRadius;\n\nconst float MAX_KERNEL_SIZE = 32.0;\n\n// author: http://byteblacksmith.com/improvements-to-the-canonical-one-liner-glsl-rand-for-opengl-es-2-0/\nhighp float rand(vec2 co, float seed) {\n    const highp float a = 12.9898, b = 78.233, c = 43758.5453;\n    highp float dt = dot(co + seed, vec2(a, b)), sn = mod(dt, 3.14159);\n    return fract(sin(sn) * c + seed);\n}\n\nvoid main() {\n\n    float minGradient = uInnerRadius * 0.3;\n    float innerRadius = (uInnerRadius + minGradient * 0.5) / filterArea.x;\n\n    float gradient = uRadius * 0.3;\n    float radius = (uRadius - gradient * 0.5) / filterArea.x;\n\n    float countLimit = MAX_KERNEL_SIZE;\n\n    vec2 dir = vec2(uCenter.xy / filterArea.xy - vTextureCoord);\n    float dist = length(vec2(dir.x, dir.y * filterArea.y / filterArea.x));\n\n    float strength = uStrength;\n\n    float delta = 0.0;\n    float gap;\n    if (dist < innerRadius) {\n        delta = innerRadius - dist;\n        gap = minGradient;\n    } else if (radius >= 0.0 && dist > radius) { // radius < 0 means it's infinity\n        delta = dist - radius;\n        gap = gradient;\n    }\n\n    if (delta > 0.0) {\n        float normalCount = gap / filterArea.x;\n        delta = (normalCount - delta) / normalCount;\n        countLimit *= delta;\n        strength *= delta;\n        if (countLimit < 1.0)\n        {\n            gl_FragColor = texture2D(uSampler, vTextureCoord);\n            return;\n        }\n    }\n\n    // randomize the lookup values to hide the fixed number of samples\n    float offset = rand(vTextureCoord, 0.0);\n\n    float total = 0.0;\n    vec4 color = vec4(0.0);\n\n    dir *= strength;\n\n    for (float t = 0.0; t < MAX_KERNEL_SIZE; t++) {\n        float percent = (t + offset) / MAX_KERNEL_SIZE;\n        float weight = 4.0 * (percent - percent * percent);\n        vec2 p = vTextureCoord + dir * percent;\n        vec4 sample = texture2D(uSampler, p);\n\n        // switch to pre-multiplied alpha to correctly blur transparent images\n        // sample.rgb *= sample.a;\n\n        color += sample * weight;\n        total += weight;\n\n        if (t > countLimit){\n            break;\n        }\n    }\n\n    color /= total;\n    // switch back from pre-multiplied alpha\n    // color.rgb /= color.a + 0.00001;\n\n    gl_FragColor = color;\n}\n",et=function(e){function t(t){if(e.call(this,$e,Je),"object"!=typeof t){var n=arguments[0],r=arguments[1],o=arguments[2],i=arguments[3];t={},void 0!==n&&(t.strength=n),void 0!==r&&(t.center=r),void 0!==o&&(t.innerRadius=o),void 0!==i&&(t.radius=i)}Object.assign(this,{strength:.1,center:[0,0],innerRadius:0,radius:-1},t)}e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t;var n={center:{configurable:!0},strength:{configurable:!0},innerRadius:{configurable:!0},radius:{configurable:!0}};return n.center.get=function(){return this.uniforms.uCenter},n.center.set=function(e){this.uniforms.uCenter=e},n.strength.get=function(){return this.uniforms.uStrength},n.strength.set=function(e){this.uniforms.uStrength=e},n.innerRadius.get=function(){return this.uniforms.uInnerRadius},n.innerRadius.set=function(e){this.uniforms.uInnerRadius=e},n.radius.get=function(){return this.uniforms.uRadius},n.radius.set=function(e){(e<0||e===1/0)&&(e=-1),this.uniforms.uRadius=e},Object.defineProperties(t.prototype,n),t}(t.Filter);return e.AdjustmentFilter=c,e.AdvancedBloomFilter=y,e.AsciiFilter=C,e.BevelFilter=z,e.BloomFilter=A,e.BulgePinchFilter=O,e.CRTFilter=Z,e.ColorMapFilter=M,e.ColorOverlayFilter=j,e.ColorReplaceFilter=I,e.ConvolutionFilter=N,e.CrossHatchFilter=W,e.DotFilter=V,e.DropShadowFilter=J,e.EmbossFilter=ne,e.GlitchFilter=ie,e.GlowFilter=ae,e.GodrayFilter=he,e.KawaseBlurFilter=d,e.MotionBlurFilter=me,e.MultiColorReplaceFilter=xe,e.OldFilmFilter=be,e.OutlineFilter=Fe,e.PixelateFilter=we,e.RGBSplitFilter=Ee,e.RadialBlurFilter=De,e.ReflectionFilter=Re,e.ShockwaveFilter=Xe,e.SimpleLightmapFilter=Ge,e.TiltShiftAxisFilter=Ke,e.TiltShiftFilter=Qe,e.TiltShiftXFilter=Ye,e.TiltShiftYFilter=Ze,e.TwistFilter=He,e.ZoomBlurFilter=et,e}({},PIXI,PIXI,PIXI,PIXI.utils,PIXI,PIXI.filters,PIXI.filters);Object.assign(PIXI.filters,__filters);
//# sourceMappingURL=pixi-filters.js.map


// Regolith
//  2021 osk

//
// Regolith root object
//
const Regolith = (() => {
	return {

	};
})();



//
// A Particle manager. Particle managers allow you to emit particles in them, that automatically get their own ParticleContainers.
//
Regolith.ParticleManager = class RegolithParticleManager extends PIXI.Container {
	constructor() {
		super();

		this.containers = new Map();
		this.graveyards = new Map();
		this.spawners = new Set();

		PIXI.Ticker.shared.add(this.progress, this);
		this._rsz = () => { this._handleResize(); };
		window.addEventListener('resize', this._rsz, false);
	}

	destroy() {
		PIXI.Ticker.shared.remove(this);
		window.removeEventListener('resize', this._rsz, false);
		super.destroy();
	}

	_handleResize() {
		for (const [,c] of this.containers) {
			if (c._destroyed) { continue; }
			c.contextWidth = undefined;
			c.contextHeight = undefined;
		}
	}

	progress(dT) {
		if (dT <= 1.03 && dT >= 0.97) {
			dT = 1.0;
		}
		
		this.progressParticles(dT);
		this.progressSpawners(dT);
	}

	progressParticles(dT) {
		for (const [,c] of this.containers) {
			if (c._destroyed) { continue; }
			for (const p of c.children) {
				p.progress(dT);
			}
		}
	}

	progressSpawners(dT) {
		for (const s of this.spawners) {
			if (s.progress(dT)) {
				this.spawners.delete(s);
			}
		}
	}

	getOrCreateContainer(containerName, particleOptions) {
		let container = this.containers.get(containerName);

		if (container) {
			return container;
		}

		container = new Regolith.ParticleContainer(undefined, {
			vertices: particleOptions.needsVertices,
			position: true,
			rotation: particleOptions.needsRotation,
			uvs: false,
			tint: true
		}, undefined, true);
		container.blendMode = particleOptions.blendmode;
		container.interactive = false;
		this.addChild(container);	
		this.containers.set(containerName, container);
		this.graveyards.set(containerName, []);

		return container;
	}

	getZombie(containerName) {
		const graveyard = this.graveyards.get(containerName);
		if (graveyard) {
			return graveyard.shift();
		} else {
			return null;
		}
	}

	// Internal function to spawn a particle with given preformatted particle options
	spawnInternal(particleOptions) {
		const containerName = `${ particleOptions.texture }:${ particleOptions.blendmode }:${ particleOptions.needsVertices }:${ particleOptions.needsRotation }`;
		particleOptions.containerName = containerName;

		const container = this.getOrCreateContainer(containerName, particleOptions);
		const zombie = this.getZombie(containerName);

		const p = zombie || new Regolith.Particle(particleOptions, this);
		if (zombie) {
			zombie.init(particleOptions);
		}

		if (particleOptions.addinback) {
			container.addChildAt(p, 0);
		} else {
			container.addChild(p);		
		}
	}

	graveyard(particle, amtLeft) {
		const graveyard = this.graveyards.get(particle.options.containerName);

		graveyard.push(particle);

		while (graveyard.length > amtLeft) {
			graveyard.pop().destroy();
		}
	}

	spawnOne(simpleParticleOptions) {
		this.spawnInternal(Regolith.ParseSimpleParticleOptions(simpleParticleOptions));
	}

	spawnBurst(simpleParticleOptions, spawnerOptions) {
		// Options for spawners:
		// x (number): The spawner's X position.
		// y (number): The spawner's Y position.
		// amount (number): If 1, the amount of particles to spawn. If <1, the chance of a particle spawning.
		// shape (string): The spawner's shape; can be 'point', 'rectangle', 'box,' 'line', 'disk', 'circle'.
		// width (number): For shapes 'rectangle', 'box', 'circle', 'disk', the spawner's width.
		// height (number): For shapes 'rectangle', 'box', 'circle', 'disk', the spawner's height.
		// linePointA (number[2]): For shape 'line', the first point on the line's relative coordinates to the spawner.
		// linePointB (number[2]): For shape 'line', the second point on the line's relative coordinates to the spawner.
		// radius (number): For shapes 'disk', 'circle', the radius of the disk. Shorthand for width and height.
		// thickness (number): For shapes 'line', 'circle', 'box', the width of the stroke.
		// directionOverride (number): If set, overrides the particle's direction to the direction away from the spawner, plus this amount.
		// angleOverride (number): If set, overrides the particle's angle to the angle away from the spawner, plus this amount.

		let realAmount = spawnerOptions.amount;
		if (realAmount < 1) {
			realAmount = (Math.random() <= realAmount) ? 1 : 0;
		}
		if (!realAmount) { return; }
		if (spawnerOptions.shape === 'disc') { spawnerOptions.shape = 'disk'; }
		if (spawnerOptions.radius !== undefined) {
			const wh = spawnerOptions.radius * 2;
			spawnerOptions.width = wh;
			spawnerOptions.height = wh;
		}
		if (spawnerOptions.thickness === undefined) {
			spawnerOptions.thickness = 0;
		}

		for (let i = 0; i < realAmount; i++) {
			let particleX = spawnerOptions.x;
			let particleY = spawnerOptions.y;

			if (spawnerOptions.shape === 'rectangle') {
				particleX += (Math.random() - 0.5) * spawnerOptions.width;
				particleY += (Math.random() - 0.5) * spawnerOptions.height;
			} else if (spawnerOptions.shape === 'box') {
				const alignment = Math.random();
				const horizontalAligned = alignment < 0.5;
				const verticalAligned = !horizontalAligned;
				particleX += (horizontalAligned ? (Math.random() - 0.5 < 0 ? -0.5 : 0.5) : (Math.random() - 0.5)) * spawnerOptions.width + ((Math.random() - 0.5) * spawnerOptions.thickness);
				particleY += (verticalAligned ? (Math.random() - 0.5 < 0 ? -0.5 : 0.5) : (Math.random() - 0.5)) * spawnerOptions.height + ((Math.random() - 0.5) * spawnerOptions.thickness);
			} else if (spawnerOptions.shape === 'line') {
				const lineProgress = Math.random();
				particleX += lineProgress * (spawnerOptions.linePointB[0] - spawnerOptions.linePointA[0]) + spawnerOptions.linePointA[0] + ((Math.random() - 0.5) * spawnerOptions.thickness);
				particleY += lineProgress * (spawnerOptions.linePointB[1] - spawnerOptions.linePointA[1]) + spawnerOptions.linePointA[1] + ((Math.random() - 0.5) * spawnerOptions.thickness);
			} else if (spawnerOptions.shape === 'disk') {
				const angle = PIXI.PI_2 * Math.random();
				particleX += Math.random() * (spawnerOptions.width / 2) * Math.sin(angle);
				particleY += Math.random() * (spawnerOptions.height / 2) * Math.cos(angle);
			} else if (spawnerOptions.shape === 'circle') {
				const angle = PIXI.PI_2 * Math.random();
				particleX += (spawnerOptions.width / 2 + ((Math.random() - 0.5) * spawnerOptions.thickness)) * Math.sin(angle);
				particleY += (spawnerOptions.height / 2 + ((Math.random() - 0.5) * spawnerOptions.thickness)) * Math.cos(angle);
			}

			simpleParticleOptions.x = particleX;
			simpleParticleOptions.y = particleY;

			if (spawnerOptions.directionOverride !== undefined) {
				simpleParticleOptions.direction = Math.atan2(particleY - spawnerOptions.y, particleX - spawnerOptions.x) * PIXI.RAD_TO_DEG + spawnerOptions.directionOverride + 90;
			}
			if (spawnerOptions.angleOverride !== undefined) {
				simpleParticleOptions.angle = Math.atan2(particleY - spawnerOptions.y, particleX - spawnerOptions.x) * PIXI.RAD_TO_DEG + spawnerOptions.angleOverride + 90;
			}

			this.spawnOne(simpleParticleOptions);
		}
	}

	createSpawner(simpleParticleOptions, spawnerOptions) {
		const spawner = new Regolith.Spawner(this, simpleParticleOptions, spawnerOptions);
		this.spawners.add(spawner);
		return spawner;
	}
}



//
// A ParticleContainer. Only difference is that these store the size of their renderer.
//
Regolith.ParticleContainer = class RegolithParticleContainer extends PIXI.ParticleContainer {
	render(renderer) {
		if (!this.contextWidth) {
			this.contextWidth = renderer.width;
			this.contextHeight = renderer.height;
		}
		super.render(renderer);
	}
}



//
// A Spawner. These are essentially 0x0 containers that automatically spawn particles for their lifetimes.
//
Regolith.Spawner = class RegolithSpawner extends PIXI.Container {
	// Extra spawner options for spawners:
	// lifetime (number): How long, in seconds, this Spawner lasts until being destroyed. Set to -1 to spawn forever.
	// amount (number): Unlike the burst version, this denotes the amount of particles spawned per second.
	constructor(manager, simpleParticleOptions, spawnerOptions) {
		super();

		this.particleOptions = simpleParticleOptions;
		this.options = spawnerOptions;
		this.manager = manager;
		this.lifetime = 0;
		this.totalLifetime = spawnerOptions.lifetime;
		this.x = this.options.x;
		this.y = this.options.y;
		this.amount = this.options.amount / 60;
	}

	progressLifetime(dT) {
		if (this.totalLifetime === -1) { return false; }
		if (dT === 1) {
			this.lifetime += 1 / 60;
			if (this.lifetime >= this.totalLifetime) {
				this.destroy();
				return true;
			}
		} else {
			this.lifetime += dT / 60;
			if (this.lifetime >= this.totalLifetime) {
				this.destroy();
				return true;
			}
		}

		return false;
	}

	spawn(dT) {
		this.options.amount = this.amount * dT;
		const point = new PIXI.Point();
		this.getGlobalPosition(point, !!this.canSkipGlobalTransform);
		this.options.x = point.x;
		this.options.y = point.y;
		this.canSkipGlobalTransform = true;
		this.manager.spawnBurst(this.particleOptions, this.options);
	}

	progress(dT) {
		if (this._destroyed) { return true; }
		if (this.progressLifetime(dT)) { return true; }

		this.spawn(dT);
	}
}



//
// A Particle. Particles are updated by their managers with a delta time, and the Particle handles its movement.
//
Regolith.Particle = class RegolithParticle extends PIXI.Sprite {
	// Options:
	// texture (string): The texture of this particle.
	// lifetime (number): The lifetime of this particle.
	// wrap (boolean): Whether this particle wraps around screen edges.
	// x (number): The particle's starting X position.
	// y (number): The particle's starting Y position.
	// alpha ({start,inc}): The alpha of this particle.
	// alphamultiplier ({start,inc}): The alpha multiplier (max 1) of this particle. Main purpose being to allow a particle to fade in.
	// scale ({start,inc}): The scale of this particle.
	// scalemultiplier ({start,inc}): The scale multiplier (max 1) of this particle. Main purpose being to allow a particle to grow in.
	// tint ({r: {start,inc}, g: {start,inc}, b: {start,inc}}): The tint of this particle.
	// angle ({start,inc}): The angle of this particle.
	// xspeed ({start,inc}): The horizontal speed of this particle.
	// yspeed ({start,inc}): The vertical speed of this particle.
	// anglespeed ({start,inc}): The rotational speed of this particle.
	// direction ({start,inc}): The direction of this particle's vector.
	// speed ({start,inc}): The speed of this particle's vector.
	// flurryfrequency ({start,inc}): The frequency of this particle's vector's flurry.
	// flurryamplitude ({start,inc}): The amplitude of this particle's vector's flurry.
	// xflurry ({start,inc}): The amount of flurry on this particle's xspeed.
	// yflurry ({start,inc}): The amount of flurry on this particle's yspeed.
	// flickerfrequency ({start,inc}): The frequency of this particle's flicker.
	// flickeramplitude ({start,inc}): The amplitude of this particle's flicker.
	// blendmode (PIXI.BLEND_MODES): The blend mode of this particle. Not used by the particle itself, but by the manager.
	// addinback (boolean): Whether this particle gets added to the back of the container. Used by the manager.
	// needsVertices (boolean): Whether this particle's scaling is dynamic (not always 1). Used by the manager.
	// needsRotation (boolean): Whether this particle's rotation is dynamic (not always 0). Used by the manager.
	constructor(setoptions, manager) {
		super(Regolith.TextureCache.GetTexture(setoptions.texture));
		this.manager = manager;

		this.contextWidth = 0;
		this.contextHeight = 0;

		this.init(setoptions);
	}

	init(setoptions) {
		this.graveyarded = false;
		this.options = setoptions;
		this.lifetime = 0;

		this.x = setoptions.x;
		this.y = setoptions.y;

		this.hasDynamicAlpha = setoptions.alpha.inc || setoptions.alphamultiplier.inc;
		this.hasDynamicScale = setoptions.scale.inc || setoptions.scalemultiplier.inc;
		this.hasDynamicXYSpeed = setoptions.xspeed.inc || setoptions.yspeed.inc || setoptions.xflurry.inc || setoptions.yflurry.inc;
		this.hasXYSpeed = setoptions.xspeed.start || setoptions.yspeed.start || setoptions.xspeed.inc || setoptions.yspeed.inc || setoptions.xflurry.start || setoptions.yflurry.start || setoptions.xflurry.inc || setoptions.yflurry.inc;
		this.hasDynamicAngle = setoptions.angle.inc || setoptions.anglespeed.inc || setoptions.anglespeed.start;
		this.hasDynamicSpeed = setoptions.speed.inc || setoptions.direction.inc;
		this.hasSpeed = setoptions.speed.inc || setoptions.speed.start;
		this.hasDynamicFlurry = setoptions.flurryfrequency.inc || setoptions.flurryamplitude.inc;
		this.hasDynamicFlicker = setoptions.flickerfrequency.inc || setoptions.flickeramplitude.inc;
		this.hasDynamicAlphaOrFlicker = setoptions.alpha.inc || setoptions.alphamultiplier.inc || setoptions.flickeramplitude.inc || setoptions.flickeramplitude.start;
		this.hasDynamicTint = setoptions.tint.r.inc || setoptions.tint.g.inc || setoptions.tint.b.inc;

		this.alpha = setoptions.alpha.start * Math.min(1, setoptions.alphamultiplier.start);
		this.alphamultiplier = setoptions.alphamultiplier.start;
		this.truealpha = setoptions.alpha.start;
		this.xspeed = setoptions.xspeed.start;
		this.yspeed = setoptions.yspeed.start;
		this.angle = setoptions.angle.start;
		this.anglespeed = setoptions.anglespeed.start;
		this.scale.set(setoptions.scale.start * Math.min(1, setoptions.scalemultiplier.start));
		this.scalemultiplier = setoptions.scalemultiplier.start;
		this.truescale = setoptions.scale.start;
		this.direction = setoptions.direction.start;
		this.speed = setoptions.speed.start;
		this.flurryfrequency = setoptions.flurryfrequency.start;
		this.flurryamplitude = setoptions.flurryamplitude.start;
		this.xflurry = setoptions.xflurry.start;
		this.yflurry = setoptions.yflurry.start;
		this.flickerfrequency = setoptions.flickerfrequency.start;
		this.flickeramplitude = setoptions.flickeramplitude.start;

		this.explodedTintR = setoptions.tint.r.start;
		this.explodedTintG = setoptions.tint.g.start;
		this.explodedTintB = setoptions.tint.b.start;
		this.explodedTintRinc = setoptions.tint.r.inc;
		this.explodedTintGinc = setoptions.tint.g.inc;
		this.explodedTintBinc = setoptions.tint.b.inc;
		this.tint = Regolith.Utils.PackRGB(this.explodedTintR, this.explodedTintG, this.explodedTintB);

		this.totalLifetime = setoptions.lifetime;
		this.alphaInc = setoptions.alpha.inc;
		this.alphaMultiplierInc = setoptions.alphamultiplier.inc;
		this.scaleInc = setoptions.scale.inc;
		this.scaleMultiplierInc = setoptions.scalemultiplier.inc;

		this.xSpeedInc = setoptions.xspeed.inc;
		this.ySpeedInc = setoptions.yspeed.inc;
		this.xFlurryInc = setoptions.xflurry.inc;
		this.yFlurryInc = setoptions.yflurry.inc;

		this.angleInc = setoptions.angle.inc;
		this.angleSpeedInc = setoptions.anglespeed.inc;

		this.speedInc = setoptions.speed.inc;
		this.directionInc = setoptions.direction.inc;

		this.flurryFrequencyInc = setoptions.flurryfrequency.inc;
		this.flurryAmplitudeInc = setoptions.flurryamplitude.inc;
		this.flickerFrequencyInc = setoptions.flickerfrequency.inc;
		this.flickerAmplitudeInc = setoptions.flickeramplitude.inc;

		this.doWrap = setoptions.wrap;
	}

	graveyard() {
		if (this.manager === undefined) { this.destroy(); return; }
		this.manager.graveyard(this, this.parent.children.length);

		this.graveyarded = true;
		if (this.parent) {
			this.parent.removeChild(this);
			this.parent = null;
		}
	}

	progressLifetime(dT) {
		if (dT === 1) {
			this.lifetime += 1 / 60;
			if (this.lifetime >= this.totalLifetime) {
				this.graveyard();
				return true;
			}
		} else {
			this.lifetime += dT / 60;
			if (this.lifetime >= this.totalLifetime) {
				this.graveyard();
				return true;
			}
		}

		return false;
	}

	progressAlpha(dT) {
		if (!this.hasDynamicAlphaOrFlicker) { return; }

		if (dT === 1) {
			this.truealpha += this.alphaInc;
			this.alphamultiplier += this.alphaMultiplierInc;

			if (this.hasDynamicAlphaOrFlicker) {
				let alpha = this.truealpha * Math.min(1, this.alphamultiplier);

				if (this.flickeramplitude) {
					alpha = Math.max(0, Math.min(1, this.truealpha + Math.sin(this.lifetime * this.flickerfrequency) * this.flickeramplitude));
				}

				this.alpha = alpha;
			}
		} else {
			this.truealpha += this.alphaInc * dT;
			this.alphamultiplier += this.alphaMultiplierInc * dT;

			if (this.hasDynamicAlphaOrFlicker) {
				let alpha = this.truealpha * Math.min(1, this.alphamultiplier);

				if (this.flickeramplitude) {
					alpha = Math.max(0, Math.min(1, this.truealpha + Math.sin(this.lifetime * this.flickerfrequency) * this.flickeramplitude));
				}

				this.alpha = alpha;
			}
		}
	}

	progressScale(dT) {
		if (!this.hasDynamicScale) { return; }

		if (dT === 1) {
			this.truescale += this.scaleInc;
			this.scalemultiplier += this.scaleMultiplierInc;
			let s = this.truescale;
			if (this.scalemultiplier < 1) {
				s *= this.scalemultiplier;
			}
			this.scale.set(s);
		} else {
			this.truescale += this.scaleInc * dT;
			this.scalemultiplier += this.scaleMultiplierInc * dT;
			let s = this.truescale;
			if (this.scalemultiplier < 1) {
				s *= this.scalemultiplier;
			}
			this.scale.set(s);
		}
	}

	progressXYSpeed(dT) {
		if (!this.hasXYSpeed) { return; }

		if (dT === 1) {
			if (this.hasDynamicXYSpeed) {
				this.xspeed += this.xSpeedInc;
				this.yspeed += this.ySpeedInc;
				this.xflurry += this.xFlurryInc;
				this.yflurry += this.yFlurryInc;
			}

			let xspeed = this.xspeed + (2 * Math.random() - 1) * this.xflurry;
			let yspeed = this.yspeed + (2 * Math.random() - 1) * this.yflurry;
			this.x += (xspeed / 60);
			this.y += (yspeed / 60);
		} else {
			if (this.hasDynamicXYSpeed) {
				this.xspeed += this.xSpeedInc * dT;
				this.yspeed += this.ySpeedInc * dT;
				this.xflurry += this.xFlurryInc * dT;
				this.yflurry += this.yFlurryInc * dT;
			}

			let xspeed = this.xspeed + (2 * Math.random() - 1) * this.xflurry;
			let yspeed = this.yspeed + (2 * Math.random() - 1) * this.yflurry;
			this.x += (xspeed / 60) * dT;
			this.y += (yspeed / 60) * dT;
		}
	}

	progressAngle(dT) {
		if (!this.hasDynamicAngle) { return; }

		if (dT === 1) {
			this.angle += this.angleInc;
			this.anglespeed += this.angleSpeedInc;
			this.angle += (this.anglespeed / 60);
		} else {
			this.angle += this.angleInc * dT;
			this.anglespeed += this.angleSpeedInc * dT;
			this.angle += (this.anglespeed / 60) * dT;
		}
	}

	progressSpeed(dT) {
		if (dT === 1) {
			if (this.hasDynamicSpeed) {
				this.speed += this.speedInc;
				this.direction += this.directionInc;
			}
			if (this.hasSpeed) {
				let direction = this.direction;

				if (this.flurryamplitude) {
					direction += Math.sin(this.lifetime * this.flurryfrequency) * this.flurryamplitude;
				}

				const dir = direction * -PIXI.DEG_TO_RAD;

				this.x += Math.sin(Math.PI + dir) * (this.speed / 60);
				this.y += Math.cos(Math.PI + dir) * (this.speed / 60);
			}
		} else {
			if (this.hasDynamicSpeed) {
				this.speed += this.speedInc * dT;
				this.direction += this.directionInc * dT;
			}
			if (this.hasSpeed) {
				let direction = this.direction;

				if (this.flurryamplitude) {
					direction += Math.sin(this.lifetime * this.flurryfrequency) * this.flurryamplitude;
				}

				const dir = direction * -PIXI.DEG_TO_RAD;

				this.x += Math.sin(Math.PI + dir) * (this.speed / 60) * dT;
				this.y += Math.cos(Math.PI + dir) * (this.speed / 60) * dT;
			}
		}
	}

	progressFlurry(dT) {
		if (!this.hasDynamicFlurry) { return; }

		if (dT === 1) {
			this.flurryfrequency += this.flurryFrequencyInc;
			this.flurryamplitude += this.flurryAmplitudeInc;
		} else {
			this.flurryfrequency += this.flurryFrequencyInc * dT;
			this.flurryamplitude += this.flurryAmplitudeInc * dT;
		}
	}

	progressFlicker(dT) {
		if (!this.hasDynamicFlicker) { return; }

		if (dT === 1) {
			this.flickerfrequency += this.flickerFrequencyInc;
			this.flickeramplitude += this.flickerAmplitudeInc;
		} else {
			this.flickerfrequency += this.flickerFrequencyInc * dT;
			this.flickeramplitude += this.flickerAmplitudeInc * dT;
		}
	}

	progressTint(dT) {
		if (!this.hasDynamicTint) { return; }

		if (dT === 1) {
			this.explodedTintR += this.explodedTintRinc;
			this.explodedTintG += this.explodedTintGinc;
			this.explodedTintB += this.explodedTintBinc;
			this.tint = Regolith.Utils.PackRGB(this.explodedTintR, this.explodedTintG, this.explodedTintB);
		} else {
			this.explodedTintR += this.explodedTintRinc * dT;
			this.explodedTintG += this.explodedTintGinc * dT;
			this.explodedTintB += this.explodedTintBinc * dT;
			this.tint = Regolith.Utils.PackRGB(this.explodedTintR, this.explodedTintG, this.explodedTintB);
		}
	}

	progressWrap(dT) {
		if (!this.doWrap) { return; }

		if (!this.contextWidth) {
			this.contextWidth = this.parent.contextWidth;
			this.contextHeight = this.parent.contextHeight;
		}

		const size = Math.max(this.texture.width, this.texture.height) * this.scale.x * 1.5;
		const cW = this.contextWidth || window.innerWidth;
		const cH = this.contextHeight || window.innerHeight;
		if (this.x > (cW + size)) {
			this.x -= cW + size * 2;
		}
		if (this.x < -size) {
			this.x += cW + size * 2;
		}

		if (this.y > (cH + size)) {
			this.y -= cH + size * 2;
		}
		if (this.y < -size) {
			this.y += cH + size * 2;
		}
	}

	progress(dT) {
		if (this.progressLifetime(dT)) { return; }

		this.progressAlpha(dT);
		this.progressScale(dT);
		this.progressXYSpeed(dT);
		this.progressAngle(dT);
		this.progressSpeed(dT);
		this.progressFlurry(dT);
		this.progressFlicker(dT);
		this.progressTint(dT);
		this.progressWrap(dT);
	}

	_render(renderer) {
		if (!this.contextWidth) {
			this.contextWidth = renderer.width;
			this.contextHeight = renderer.height;
		}
		super._render(renderer);
	}
}



//
// Parse simple particle options into a properly formatted options object.
//
Regolith.ParseSimpleParticleOptions = function(simple) {
	const singles = ['x', 'y', 'lifetime'];
	const randoms = ['texture', 'blendmode', 'wrap', 'addinback'];
	const startincs = ['alpha', 'alphamultiplier', 'scale', 'scalemultiplier', 'angle', 'xspeed', 'yspeed',
					   'anglespeed', 'direction', 'speed', 'flurryfrequency', 'flurryamplitude',
					   'xflurry', 'yflurry', 'flickerfrequency', 'flickeramplitude'];
	const tintlikes = ['tint'];
	const defaults = {
		alpha: 1,
		scale: 1,
		scalemultiplier: 1,
		alphamultiplier: 1
	};

	const o = {
		x: 0,
		y: 0,
		lifetime: 1,
		blendmode: PIXI.BLEND_MODES.NORMAL,
		addinback: false
	};

	// Singles are either a number, or an array of 2 numbers to pick a random number between.
	for (const k of singles) {
		if (Array.isArray(simple[k])) {
			o[k] = simple[k][0] + Math.random() * (simple[k][1] - simple[k][0]);
		} else if (simple[k] !== undefined) {
			o[k] = simple[k];
		}
	}

	// Randoms are either a single item, or an array of random values to pick between
	for (const k of randoms) {
		if (Array.isArray(simple[k])) {
			o[k] = simple[k][Math.floor(Math.random() * simple[k].length)];
		} else if (simple[k] !== undefined) {
			o[k] = simple[k];
		}
	}

	// Startincs are handled by Regolith.ParseProgression
	for (const k of startincs) {
		o[k] = Regolith.ParseProgression(simple[k] || defaults[k], o);
	}

	// Tintlikes are handled by Regolith.ParseProgression
	for (const k of tintlikes) {
		const split = Regolith.SplitTints(simple[k]);
		o[k] = {
			r: Regolith.ParseProgression(split.r, o),
			g: Regolith.ParseProgression(split.g, o),
			b: Regolith.ParseProgression(split.b, o),
		};
	}

	// Check if we need vertices or rotation
	o.needsVertices = o.scale.start !== 1 || o.scale.inc !== 0 || o.scalemultiplier.start !== 1 || o.scalemultiplier.inc !== 0;
	o.needsRotation = o.angle.start !== 0 || o.angle.inc !== 0 || o.anglespeed.start !== 0 || o.anglespeed.inc !== 0;

	return o;
}



//
// Split a tint, set of tints, etc. into a value ready for Regolith.ParseProgression.
//
Regolith.SplitTints = function(tint) {
	if (tint === undefined) {
		return { r: 0xFF, g: 0xFF, b: 0xFF };
	}

	if (typeof tint === 'number') {
		return { r: tint >> 16, g: (tint >> 8) & 0xFF, b: tint & 0xFF };
	}

	if (Array.isArray(tint)) {
		return { r: [tint[0] >> 16, tint[1] >> 16],
				 g: [(tint[0] >> 8) & 0xFF, (tint[1] >> 8) & 0xFF],
				 b: [tint[0] & 0xFF, tint[1] & 0xFF] };
	}

	let rfrom;
	let gfrom;
	let bfrom;
	if (Array.isArray(tint.from)) {
		rfrom = [tint.from[0] >> 16, tint.from[1] >> 16];
		gfrom = [(tint.from[0] >> 8) & 0xFF, (tint.from[1] >> 8) & 0xFF];
		bfrom = [tint.from[0] & 0xFF, tint.from[1] & 0xFF];
	} else if (Array.isArray(tint.start)) {
		rfrom = [tint.start[0] >> 16, tint.start[1] >> 16];
		gfrom = [(tint.start[0] >> 8) & 0xFF, (tint.start[1] >> 8) & 0xFF];
		bfrom = [tint.start[0] & 0xFF, tint.start[1] & 0xFF];
	} else if (typeof tint.from === 'number') {
		rfrom = tint.from >> 16;
		gfrom = (tint.from >> 8) & 0xFF;
		bfrom = tint.from & 0xFF;
	} else if (typeof tint.start === 'number') {
		rfrom = tint.start >> 16;
		gfrom = (tint.start >> 8) & 0xFF;
		bfrom = tint.start & 0xFF;
	}

	if (tint.to !== undefined) {
		if (Array.isArray(tint.to)) {
			return {
				r: { from: rfrom, to: [tint.to[0] >> 16, tint.to[1] >> 16] },
				g: { from: gfrom, to: [(tint.to[0] >> 8) & 0xFF, (tint.to[1] >> 8) & 0xFF] },
				b: { from: bfrom, to: [tint.to[0] & 0xFF, tint.to[1] & 0xFF] }
			};
		} else {
			return {
				r: { from: rfrom, to: tint.to >> 16 },
				g: { from: gfrom, to: (tint.to >> 8) & 0xFF },
				b: { from: bfrom, to: tint.to & 0xFF }
			};
		}
	}

	if (tint.inc !== undefined) {
		if (Array.isArray(tint.inc)) {
			return {
				r: { from: rfrom, inc: [tint.inc[0] >> 16, tint.inc[1] >> 16] },
				g: { from: gfrom, inc: [(tint.inc[0] >> 8) & 0xFF, (tint.inc[1] >> 8) & 0xFF] },
				b: { from: bfrom, inc: [tint.inc[0] & 0xFF, tint.inc[1] & 0xFF] }
			};
		} else {
			return {
				r: { from: rfrom, inc: tint.inc >> 16 },
				g: { from: gfrom, inc: (tint.inc >> 8) & 0xFF },
				b: { from: bfrom, inc: tint.inc & 0xFF }
			};
		}
	}

	// fallback
	return { r: 0xFF, g: 0xFF, b: 0xFF };
}



//
// Parse a value, set of values, etc. into a progression.
//
Regolith.ParseProgression = function(simple, o) {
	// Startincs are:
	//  - Number x, which turns into { start: x, inc: 0 }
	//  - Number[2] x, which turns into { start: <random between the 2 xes>, inc: 0 }
	//  - { from: x, to: y }, which turns into { start: x, inc: (y-x)/lifetime/60 }
	//  - { from: x[2], to: y }, which turns into { start: <rand between x>, inc: (y-<rand between x>)/lifetime/60 }
	//  - { from: x, to: y[2] }, which turns into { start: x, inc: (<rand between y>-x)/lifetime/60 }
	//  - { from: x[2], to: y[2] }, which turns into { start: <rand between x>, inc: (<rand between y>-<rand between x>)/lifetime/60 }
	//  - { start: x, inc: y }, which turns into { start: x, inc: y }
	//  - { start: x[2], inc: y }, which turns into { start: <rand between x>, inc: y }
	//  - { start: x, inc: y[2] }, which turns into { start: x, inc: <rand between y> }
	//  - { start: x[2], inc: y[2] }, which turns into { start: <rand between x>, inc: <rand between y> }
	if (simple === undefined) {
		return { start: 0, inc: 0 };
	}

	if (typeof simple === 'number') {
		return { start: simple, inc: 0 };
	}

	if (Array.isArray(simple)) {
		return { start: simple[0] + Math.random() * (simple[1] - simple[0]), inc: 0 };
	}

	// complex
	let start = 0;
	if (simple.from !== undefined) {
		if (typeof simple.from === 'number') {
			start = simple.from;
		} else {
			start = simple.from[0] + Math.random() * (simple.from[1] - simple.from[0]);
		}
	} else if (simple.start !== undefined) {
		if (typeof simple.start === 'number') {
			start = simple.start;
		} else {
			start = simple.start[0] + Math.random() * (simple.start[1] - simple.start[0]);
		}
	}

	let inc = 0;
	if (simple.inc !== undefined) {
		if (typeof simple.inc === 'number') {
			inc = simple.inc;
		} else {
			inc = simple.inc[0] + Math.random() * (simple.inc[1] - simple.inc[0]);
		}
	} else if (simple.to !== undefined) {
		if (typeof simple.to === 'number') {
			inc = (simple.to - start) / (o.lifetime * 60);
		} else {
			const to = simple.to[0] + Math.random() * (simple.to[1] - simple.to[0]);
			inc = (to - start) / (o.lifetime * 60);
		}
	}

	return { start, inc };
}



//
// The Texture cache for particles.
//
Regolith.TextureCache = (() => {
	const cache = new Map();

	function GetTexture(texid) {
		if (cache.has(texid)) {
			return cache.get(texid);
		}

		const tex = PIXI.Texture.from(texid);
		tex.defaultAnchor.set(0.5, 0.5);
		cache.set(texid, tex);
		return tex;
	}

	return {
		GetTexture
	};
})();



//
// Regolith utilities
//
Regolith.Utils = (() => {
	function PackRGB(r, g, b) {
		return Math.min(0xFF, Math.max(0x00, Math.round(r))) << 16 | Math.min(0xFF, Math.max(0x00, Math.round(g))) << 8 | Math.min(0xFF, Math.max(0x00, Math.round(b)));
	}

	return {
		PackRGB
	};
})();

// Moonbeam
//  2021 osk

//
// Moonbeam root object
//
const Moonbeam = (() => {
	const beams = new Set();

	function Progress(dT) {
		for (const beam of beams) {
			if (beam._destroyed) { continue; }
			beam.progress(dT);
		}
	}

	function AddBeam(beam) {
		beams.add(beam);
	}

	function RemoveBeam(beam) {
		beams.delete(beam);
	}

	PIXI.Ticker.shared.add(Progress, this);

	return {
		add: AddBeam,
		remove: RemoveBeam
	};
})();



//
// A Beam. Beams are SimpleRopes (Pixi-managed meshes) that are automatically managed by Moonbeam, and follow a path, then die out.
//
Moonbeam.Beam = class MoonbeamBeam extends PIXI.SimpleRope {
	// Options:
	// texture (PIXI.Texture | string): The texture of this beam.
	// mode (string): Either 'path' (move along a path), 'follow' (tracer behind a point), or 'connect' (line connecting a path).
	// path (PIXI.Point[]): When using modes 'path' or 'connect', the points this beam will follow.
	// vertices (number): The amount of vertices in this beam. Increasing this makes the rope smoother, but uses more triangles.
	// length (number): When using modes 'path' or 'follow', the amount of history in this beam. Increasing this makes the rope longer.
	// duration (number): When using mode 'path', the amount of seconds it takes to follow the path.
	// tint (number): The tint to apply to the beam.
	// alpha (number): The alpha to apply to the beam.
	// scale (number): The scale to apply to the beam.
	// blendMode (PIXI.BLEND_MODES): The blend mode to apply to the beam.
	// onHit (callback): When using mode 'path', the callback to call when the beam's leader hits its target.
	// onDie (callback): When using mode 'path', the callback to call when the beam's last vertex hits its target.
	// leader (PIXI.DisplayObject | string): Object (a Sprite if a string is passed) that follows the beam's leader.
	// smoothVertices (boolean): Whether to smooth the vertices on the rope. Makes the rope smoother.
	// smoothPath (boolean): When using mode 'path', whether to smooth the path itself (as opposed to just the rope)
	// repeatTexture (boolean): Whether to repeat the rope's texture, instead of stretching it.
	// reverse (boolean): Whether to reverse the order of the rope's vertices.
	// followPoint (PIXI.Point): When using mode 'follow', the Point to follow.
	// jitter (number): The amount of jitter to add to the vertices.
	// pathBezier (BezierEasing): When using mode 'path', an easing function to add to the path movement.
	constructor(options) {
		if (typeof options.texture === 'string') {
			options.texture = PIXI.Texture.from(options.texture);
		}

		const scale = options.scale || 1;
		const pathX = [];
		const pathY = [];
		const points = [];

		if (options.mode === 'path' || options.mode === 'connect') {
			for (let i = 0; i < options.path.length; i++) {
				pathX.push(options.path[i].x / scale);
				pathY.push(options.path[i].y / scale);
			}
		} else if (options.mode === 'follow') {
			pathX.push(options.followPoint.x);
			pathY.push(options.followPoint.y);
		}

		for (let i = 0; i < (options.vertices || 100); i++) {
			points.push(new PIXI.Point(pathX[0], pathY[0]));
		}

		

		super(options.texture, points, options.repeatTexture ? 1 : 0);

		this.options = {
			vertices: 100,
			length: 20,
			duration: 1,
			tint: 0xFFFFFF,
			blendMode: PIXI.BLEND_MODES.NORMAL,
			alpha: 1,
			scale: 1,
			smoothVertices: true,
			smoothPath: false,
			repeatTexture: false,
			reverse: false,
			jitter: 0,
			...options
		};
		this.points = points;
		this.pathX = pathX;
		this.pathY = pathY;
		this.pathLength = pathX.length;
		this.historyX = [];
		this.historyY = [];
		this.mustInitializeHistory = true;
		this.leader = new PIXI.Point(pathX[0], pathY[0]);
		this.leaderObject = null;
		this.age = 0;
		this.tint = this.options.tint;
		this.blendMode = this.options.blendMode;
		this.alpha = this.options.alpha;
		this.realAlpha = this.options.alpha;
		this.scale.set(this.options.scale);
		this.hasHit = false;

		if (typeof this.options.leader === 'string') {
			this.leaderObject = PIXI.Sprite.from(this.options.leader);
			this.leaderObject.anchor.set(0.5, 0.5);
		} else if (this.options.leader) {
			this.leaderObject = this.options.leader;
		}

		if (this.leaderObject) {
			this.leaderObject.position.set(this.leader.x, this.leader.y);
			this.leaderObject.blendMode = this.options.blendMode;
			this.leaderObject.tint = this.options.tint;
			this.leaderObject.x = this.leader.x;
			this.leaderObject.y = this.leader.y;
			this.addChild(this.leaderObject);
		}

		Moonbeam.add(this);
	}

	destroy() {
		Moonbeam.remove(this);
		super.destroy();
	}

	hit() {
		if (this.options.onHit) {
			let pos = new PIXI.Point(this.leader.x * this.scale.x, this.leader.y * this.scale.y);
			if (this.leaderObject) {
				pos = this.leaderObject.getGlobalPosition(undefined, true); // higher quality, as this deals with transforms
			}
			this.options.onHit(this, pos);
		}
	}

	die() {
		if (this.options.onDie) {
			let pos = new PIXI.Point(this.leader.x * this.scale.x, this.leader.y * this.scale.y);
			if (this.leaderObject) {
				pos = this.leaderObject.getGlobalPosition(undefined, true); // higher quality, as this deals with transforms
			}
			this.options.onDie(this, pos);
		}
		this.destroy();
	}

	progressLeaderPath(dT) {
		let pathAge = (this.age / this.options.duration / 60) * (this.pathLength - 1);
		if (pathAge >= this.pathLength - 1) {
			this.alpha -= this.realAlpha / this.historyX.length;
			if (!this.hasHit) {
				this.hasHit = true;
				this.hit();
			}
			if (this.alpha <= 0) {
				this.die();
			}
		}

		if (this.hasHit) {
			return;
		}

		if (this.options.pathBezier) {
			pathAge = this.options.pathBezier(Math.max(0, Math.min(1, pathAge / (this.pathLength - 1)))) * (this.pathLength - 1);
		}

		if (this.options.smoothPath) {
			this.leader.x = Moonbeam.Utils.CubicInterpolation(this.pathX, pathAge);
			this.leader.y = Moonbeam.Utils.CubicInterpolation(this.pathY, pathAge);
		} else {
			this.leader.x = Moonbeam.Utils.LinearInterpolation(this.pathX, pathAge);
			this.leader.y = Moonbeam.Utils.LinearInterpolation(this.pathY, pathAge);
		}
	}

	progressLeaderFollow(dT) {
		this.leader.set(this.options.followPoint.x / this.options.scale, this.options.followPoint.y / this.options.scale);
	}

	progressLeaderConnect(dT) {
		if (this.age >= (this.options.duration * 60)) {
			this.die();
		}
	}

	progressLeader(dT) {
		switch (this.options.mode) {
			case 'path': return this.progressLeaderPath(dT);
			case 'follow': return this.progressLeaderFollow(dT);
			case 'connect': return this.progressLeaderConnect(dT);
		}
	}

	progressLeaderObject(dT) {
		if (!this.leaderObject || this.leaderObject._destroyed) { return; }

		this.leaderObject.x = this.leader.x;
		this.leaderObject.y = this.leader.y;
	}

	progressHistory(dT) {
		if (this.mustInitializeHistory) {
			for (let i = 0; i < (this.options.length / dT); i++) {
				this.historyX.push(this.pathX[0]);
				this.historyY.push(this.pathY[0]);
			}
			this.mustInitializeHistory = false;
		}

		this.historyX.push(this.leader.x);
		this.historyY.push(this.leader.y);
		this.historyX.shift();
		this.historyY.shift();
	}

	progressPoints(dT) {
		const additor = this.options.reverse ? 1 : 0;
		const factor = this.options.reverse ? -1 : 1;

		let pathingDataX = this.historyX;
		let pathingDataY = this.historyY;
		let offset = 0;
		if (this.options.mode === 'connect') {
			pathingDataX = this.pathX;
			pathingDataY = this.pathY;
			offset = -1;
		}

		const pathingFunction = this.options.smoothVertices ? Moonbeam.Utils.CubicInterpolation : Moonbeam.Utils.LinearInterpolation;

		for (let i = 0; i < this.options.vertices; i++) {
			let jitterX = 0.0;
			let jitterY = 0.0;
			if (this.options.jitter) {
				jitterX = (Math.random() - 0.5) * this.options.jitter;
				jitterY = (Math.random() - 0.5) * this.options.jitter;
			}

			this.points[i].set(
				jitterX + pathingFunction(pathingDataX, (additor + i / this.options.vertices * factor) * (pathingDataX.length + offset)),
				jitterY + pathingFunction(pathingDataY, (additor + i / this.options.vertices * factor) * (pathingDataY.length + offset))
			);
		}
	}

	progress(dT) {
		this.age += dT;

		this.progressLeader(dT);
		this.progressLeaderObject(dT);
		this.progressHistory(dT);
		this.progressPoints(dT);
	}
}



//
// Moonbeam utilities
//
Moonbeam.Utils = (() => {
	function ClipInput(k, arr) {
		return arr[Math.min(Math.max(k, 0), arr.length - 1)];
	}

	function GetTangent(k, factor, array) {
		return factor * (ClipInput(k + 1, array) - ClipInput(k - 1, array)) / 2;
	}

	function CubicInterpolation(array, t, tangentFactor = 1) {
		const k = Math.floor(t);
		const m = [GetTangent(k, tangentFactor, array), GetTangent(k + 1, tangentFactor, array)];
		const p = [ClipInput(k, array), ClipInput(k + 1, array)];

		t -= k;
		const t2 = t*t;
		const t3 = t*t2;
		return (2 * t3 - 3 * t2 + 1) * p[0] + (t3 - 2 * t2 + t) * m[0] + (-2 * t3 + 3 * t2) * p[1] + (t3 - t2) * m[1];
	}

	function LinearInterpolation(array, t) {
		const x1 = ClipInput(Math.floor(t), array);
		const x2 = ClipInput(Math.floor(t) + 1, array);

		return x1 + (x2 - x1) * (t % 1);
	}

	return {
		CubicInterpolation,
		LinearInterpolation
	};
})();

// TheoryType 2
//  2021 osk

//
// TheoryType root object
//
const TheoryType = (() => {
	return {

	};
})();


//
// A text element. This is a Container containing multiple TheoryType.TextMesh elements (which are Meshes)
//
TheoryType.Text = class TheoryTypeText extends PIXI.Container {
	constructor(text, setoptions) {
		super();

		this._text = text.toString() || ' ';
		this._options = {
			font: null, // The font to use.
			rasterize: false, // Whether we should try to rasterize if an SDF font is given.
			fontSize: 42, // The font size, in pixels.
			alpha: 1.0, // The text's alpha.
			tint: 0xFFFFFF, // The text's tint.
			weight: 500, // The text's weight.
			sharpness: 0.85, // The text's sharpness.
			letterSpacing: 0.0, // The text's additional letter spacing.
			lineSpacing: 0.0, // The text's additional line spacing.
			blendMode: PIXI.BLEND_MODES.NORMAL, // The text's blend mode.
			align: 'left', // The text's alignment.
			anchor: [0.0, 0.0], // The text's anchor point.
			outlineWeight: 900, // The text outline's weight.
			outlineAlpha: 0.0, // The text outline's alpha.
			outlineTint: 0x000000, // The text outline's tint.
			fillAlpha: 1.0, // The text fill's alpha.
			misalignment: 0.0, // The amount of misalignment on characters. Can either be a single float or a float[2].
			misalignmentSeed: Math.floor(Math.random() * 1000000), // The seed for character misalignment.
			invert: 0.0, // Whether to invert the SDF tests. Looks cool (sometimes)
			shadows: [], // Array of { x, y, scale, tint, weight[, blendMode, invert, alpha] }
			useProjection: false, // Whether to use the projection given in options.projection. Not very fast, but looks neat
			projection: [[0,0],[1,0],[0,1],[1,1]], // Four PIXI.ObservablePoints that are used for the projection.
			...setoptions
		};
		this._textMustRegenerate = false;
		this._textDirty = false;
		this._meshes = new Map();
		this._shadowMeshes = new Map();
		this._options.anchor = new PIXI.ObservablePoint(() => { this._textDirty = true; }, this, ...this._options.anchor);
		for (let i = 0; i < 4; i++) {
			this._options.projection[i] = new PIXI.ObservablePoint(() => { this._textDirty = true; }, this, ...this._options.projection[i]);
		}
		this._options.overrides = new TheoryType.CharacterOverrideMap(() => { this._textDirty = true; });
		this.alpha = this._options.alpha === undefined ? 1.0 : this._options.alpha;

		if (!this.font) { throw new Error('Could not create Text: config.font must be set'); }

		this.regenerateText();
	}

	declareType(update = false) {
		if (this.font.type === 'bitmap') {
			return 'bitmap';
		}

		if (this._options.rasterize) {
			if (!update) {
				return 'rasterized';
			}

			for (const m of this.declareAllMasters()) {
				if (!this.font.fontTextures.has(`p0.rasterized.${ m }`)) {
					// we need to create textures
					this.font.rasterize(m, (tex, master, pid) => {
						for (const [,mesh] of this._meshes) {
							if ((mesh.tt_mesh_id == pid) && (Math.round(mesh.weight / 100) * 100) == master) {
								mesh.texture = tex;
							}
						}

						for (const [,mesh] of this._shadowMeshes) {
							if ((mesh.tt_mesh_id.toString().split('_')[0] == pid) && (Math.round(mesh.weight / 100) * 100) == master) {
								mesh.texture = tex;
							}
						}
					});
				}
			}
			return 'rasterized';
		}

		return 'sdf';
	}

	declareMaster() {
		if (this.font.type === 'bitmap' || !this._options.rasterize) {
			return 'master';
		}

		return Math.round(this._options.weight / 100) * 100;
	}

	declareAllMasters() {
		const masters = new Set();
		masters.add(Math.round(this._options.weight / 100) * 100);

		if (this.font.type === 'bitmap' || !this._options.rasterize) {
			return masters;
		}

		for (const shadow of this._options.shadows) {
			masters.add(Math.round(shadow.weight / 100) * 100);
		}

		return masters;
	}

	createMesh(pageid, geometry, pregeometrized) {
		const mesh = new TheoryType.TextMesh(
			this.declareType(true),
			this.font.fontTextures.get(`p${ pageid }.${ this.declareType() }.${ this.declareMaster() }`) || PIXI.Texture.EMPTY,
			pregeometrized ? geometry : TheoryType.Geometrize(geometry),
			this);
		mesh.tint = this._options.tint;
		mesh.weight = this._options.weight;
		mesh.sharpness = this._options.sharpness;
		mesh.fontSize = this._options.fontSize;
		mesh.blendMode = this._options.blendMode;
		mesh.invert = this._options.invert;
		mesh.outlineWeight = this._options.outlineWeight;
		mesh.outlineAlpha = this._options.outlineAlpha;
		mesh.outlineTint = this._options.outlineTint;
		mesh.fillAlpha = this._options.fillAlpha;
		mesh.tt_mesh_id = pageid;
		this._meshes.set(pageid, mesh);
		this.addChild(mesh);

		return mesh;
	}

	createShadowMesh(pageid, geometry, pregeometrized, shadowStyle, shadowIndex) {
		const mesh = new TheoryType.TextMesh(
			this.declareType(true),
			this.font.fontTextures.get(`p${ pageid }.${ this.declareType() }.${ this.declareMaster() }`) || PIXI.Texture.EMPTY,
			pregeometrized ? geometry : TheoryType.Geometrize(geometry),
			this);
		mesh.tint = shadowStyle.tint;
		mesh.weight = shadowStyle.weight;
		mesh.sharpness = shadowStyle.sharpness === undefined ? this._options.sharpness : shadowStyle.sharpness;
		mesh.fontSize = this._options.fontSize;
		mesh.blendMode = shadowStyle.blendMode === undefined ? this._options.blendMode : shadowStyle.blendMode;
		mesh.invert = shadowStyle.invert === undefined ? this._options.invert : shadowStyle.invert;
		mesh.tt_mesh_id = `${ pageid }_s${ shadowIndex }`;
		mesh.position.x += shadowStyle.x || 0;
		mesh.position.y += shadowStyle.y || 0;
		mesh.alpha = shadowStyle.alpha === undefined ? 1 : shadowStyle.alpha;
		mesh.scale.set(shadowStyle.scale === undefined ? 1 : shadowStyle.scale);
		mesh.rotation = shadowStyle.rotation || 0;
		this._shadowMeshes.set(`${ pageid }_s${ shadowIndex }`, mesh);
		this.addChild(mesh);

		return mesh;
	}

	regenerateText() {
		this.removeChildren();
		this._meshes.clear();
		this._shadowMeshes.clear();

		const baseGeos = new Map();
		const scale = this.declareType() === 'sdf' ? 1 : this._options.fontSize / this.font.fontData.info.size;
		const layout = TheoryType.LayoutText(this._text, this._options, this.font, scale);

		let i = 0;
		for (const shadow of this._options.shadows) {
			for (const [pageid, geometry] of layout) {
				let geo = null;
				if (baseGeos.has(pageid)) {
					geo = baseGeos.get(pageid);
				} else {
					geo = TheoryType.Geometrize(geometry);
					baseGeos.set(pageid, geo);
				}

				this.createShadowMesh(pageid, geo, true, shadow, i);
			}
			i++;
		}

		for (const [pageid, geometry] of layout) {
			let geo = null;
			if (baseGeos.has(pageid)) {
				geo = baseGeos.get(pageid);
			} else {
				geo = TheoryType.Geometrize(geometry);
				baseGeos.set(pageid, geo);
			}

			this.createMesh(pageid, geo, true);
		}

		this._textMustRegenerate = false;
		this._textDirty = false;
	}

	updateText() {
		const scale = this.declareType() === 'sdf' ? 1 : this._options.fontSize / this.font.fontData.info.size;
		const layout = TheoryType.LayoutText(this._text, this._options, this.font, scale);
		const seenMeshes = [];

		for (const [pageid, geometry] of layout) {
			const existingMesh = this._meshes.get(pageid);

			if (existingMesh) {
				existingMesh.updateGeometry(geometry.vertices, geometry.uvs, geometry.indices);
			} else {
				this.createMesh(pageid, geometry);
			}

			seenMeshes.push(pageid);
		}

		for (const [k, m] of this._meshes) {
			if (!seenMeshes.includes(k)) {
				m.destroy();
			}
		}

		for (const [k, m] of this._shadowMeshes) {
			m.forceUploadGeometry();
		}

		this._textDirty = false;
	}

    _render(renderer) {
    	if (this._textMustRegenerate) {
    		this.regenerateText();
    	}

    	if (this._textDirty) {
    		this.updateText();
    	}

    	super._render(renderer);
    }

	get font() {
		return this._options.font;
	}

	get text() {
		return this._text;
	}

	set text(value) {
		value = value.toString() || ' ';
    	if (this._text === value) { return; }
		this._text = value;
		this._textDirty = true;
		this._options._cache = null;
	}

	get align() {
		return this._options.align;
	}

	set align(value) {
    	if (this._options.align === value) { return; }
		this._options.align = value;
		this._textDirty = true;
		this._options._cache = null;
	}

	get anchor() {
		return this._options.anchor;
	}

	get tint() {
		return this._options.tint;
	}

	set tint(value) {
    	if (this._options.tint === value) { return; }
		this._options.tint = value;
		for (const [,mesh] of this._meshes) {
			mesh.tint = value;
		}
	}

	get blendMode() {
		return this._options.blendMode;
	}

	set blendMode(value) {
    	if (this._options.blendMode === value) { return; }
		this._options.blendMode = value;
		for (const [,mesh] of this._meshes) {
			mesh.blendMode = value;
		}
	}

	get weight() {
		return this._options.weight;
	}

	set weight(value) {
    	if (this._options.weight === value) { return; }
		this._options.weight = value;
		for (const [,mesh] of this._meshes) {
			mesh.weight = value;

			if (this.declareType(true) === 'rasterized') {
				mesh.texture = this.font.fontTextures.get(`p${ mesh.tt_mesh_id.toString().split('_')[0] }.${ this.declareType() }.${ this.declareMaster() }`) || PIXI.Texture.EMPTY;
			}
		}
	}

	get sharpness() {
		return this._options.sharpness;
	}

	set sharpness(value) {
    	if (this._options.sharpness === value) { return; }
		this._options.sharpness = value;
		for (const [,mesh] of this._meshes) {
			mesh.sharpness = value;
		}
	}

	get invert() {
		return this._options.invert;
	}

	set invert(value) {
    	if (this._options.invert === value) { return; }
		this._options.invert = value;
		for (const [,mesh] of this._meshes) {
			mesh.invert = value;
		}
	}

	get fontSize() {
		return this._options.fontSize;
	}

	set fontSize(value) {
    	if (this._options.fontSize === value) { return; }
		this._options.fontSize = value;
		for (const [,mesh] of this._meshes) {
			mesh.fontSize = value;
		}
		for (const [,mesh] of this._shadowMeshes) {
			mesh.fontSize = value;
		}

		if (this.declareType() !== 'sdf') {
			// Cannot scale on the vertex shader, so we will need to reflow
			this._textDirty = true;
			this._options._cache = null;
		}
	}

	get letterSpacing() {
		return this._options.letterSpacing;
	}

	set letterSpacing(value) {
    	if (this._options.letterSpacing === value) { return; }
		this._options.letterSpacing = value;
		this._textDirty = true;
		this._options._cache = null;
	}

	get lineSpacing() {
		return this._options.lineSpacing;
	}

	set lineSpacing(value) {
    	if (this._options.lineSpacing === value) { return; }
		this._options.lineSpacing = value;
		this._textDirty = true;
		this._options._cache = null;
	}

	get outlineWeight() {
		return this._options.outlineWeight;
	}

	set outlineWeight(value) {
    	if (this._options.outlineWeight === value) { return; }
		this._options.outlineWeight = value;
		for (const [,mesh] of this._meshes) {
			mesh.outlineWeight = value;
		}
	}

	get outlineAlpha() {
		return this._options.outlineAlpha;
	}

	set outlineAlpha(value) {
    	if (this._options.outlineAlpha === value) { return; }
		this._options.outlineAlpha = value;
		for (const [,mesh] of this._meshes) {
			mesh.outlineAlpha = value;
		}
	}

	get fillAlpha() {
		return this._options.fillAlpha;
	}

	set fillAlpha(value) {
    	if (this._options.fillAlpha === value) { return; }
		this._options.fillAlpha = value;
		for (const [,mesh] of this._meshes) {
			mesh.fillAlpha = value;
		}
	}

	get outlineTint() {
		return this._options.outlineTint;
	}

	set outlineTint(value) {
    	if (this._options.outlineTint === value) { return; }
		this._options.outlineTint = value;
		for (const [,mesh] of this._meshes) {
			mesh.outlineTint = value;
		}
	}

	get misalignment() {
		return this._options.misalignment;
	}

	set misalignment(value) {
    	if (this._options.misalignment === value) { return; }
		this._options.misalignment = value;
		this._textDirty = true;
	}

	get misalignmentSeed() {
		return this._options.misalignmentSeed;
	}

	set misalignmentSeed(value) {
    	if (this._options.misalignmentSeed === value) { return; }
		this._options.misalignmentSeed = value;
		this._textDirty = true;
	}

	get shadows() {
		return this._options.shadows;
	}

	set shadows(value) {
    	if (this._options.shadows === value) { return; }
		this._options.shadows = value;
		this._textMustRegenerate = true;
	}

	get useProjection() {
		return this._options.useProjection;
	}

	set useProjection(value) {
    	if (this._options.useProjection === value) { return; }
		this._options.useProjection = value;
		this._textDirty = true;
	}

	get projection() {
		return this._options.projection;
	}

	get overrides() {
		return this._options.overrides;
	}

	get meshes() {
		return this._meshes;
	}

	get shadowMeshes() {
		return this._shadowMeshes;
	}

	findShadowMeshes(shadowIndex) {
		const m = new Map();
		for (const [mid, mesh] of this._shadowMeshes) {
			if (mid.endsWith(`_s${ shadowIndex }`)) {
				m.set(mid, mesh);
			}
		}
		return m;
	}

	setMustRegenerate() {
		this._textMustRegenerate = true;
	}

	setTextDirty() {
		this._textDirty = true;
	}
}


//
// A text mesh element. Handles drawing (but not positioning) characters from one specific texture.
// For multipage fonts, multiple of these will be instantiated by TheoryType.Text.
//
TheoryType.TextMesh = class TheoryTypeTextMesh extends PIXI.Mesh {
	constructor(type, texture, geometry, parent) {
		let shader;

        if (type === 'sdf') {
        	shader = new PIXI.Shader(TheoryType.Shader, {
        		uSampler: texture,
        		uAlpha: 1.0,
        		uTint: PIXI.utils.hex2rgb(0xFFFFFF),
        		uWeight: 0.5,
        		uSharpness: 0.15,
        		uScale: 1.0,
        		uOutlineWeight: 0.1,
        		uOutlineAlpha: 0.0,
        		uFillAlpha: 1.0,
        		uOutlineTint: PIXI.utils.hex2rgb(0x000000),
        		uInvert: 0.0,
        	});
        } else {
        	shader = new PIXI.MeshMaterial(texture);
        }

        super(geometry, shader);

        this._type = type;
        this._parent = parent;
        this._texture = texture;
        this._styleDirty = false;
        this._alpha = 1.0;
        this._lastWorldAlpha = 1.0;
        this._tint = 0xFFFFFF;
        this._weight = 500;
        this._sharpness = 0.85;
        this._fontSize = 52;
        this._outlineWeight = 900;
        this._outlineAlpha = 0.0;
        this._fillAlpha = 1.0;
        this._outlineTint = 0x000000;
        this._invert = false;
    }

    updateStyle() {
    	if (this._type === 'sdf') {
    		this.shader.uniforms.uAlpha = this.worldAlpha;
    		this.shader.uniforms.uTint = PIXI.utils.hex2rgb(this.tint);

    		const realScale = this.fontSize / this._parent.font.fontData.info.size;
    		const realWeight = Math.min(1.0, Math.max(0.0, this.invert ? (this.weight / 1000) : (1.0 - (this.weight / 1000))));
    		const realOutlineWeight = Math.min(1.0, Math.max(0.0, 1.0 - (this.outlineWeight / 1000)));
    		const realSharpness = Math.min((1.0 - this.sharpness) / realScale, realWeight, this.outlineAlpha > 0.0 ? realOutlineWeight : 1.0);

    		this.shader.uniforms.uWeight = realWeight;
    		this.shader.uniforms.uSharpness = realSharpness;

    		this.shader.uniforms.uScale = realScale;

    		this.shader.uniforms.uOutlineAlpha = this.outlineAlpha;
    		this.shader.uniforms.uOutlineTint = PIXI.utils.hex2rgb(this.outlineTint);
    		this.shader.uniforms.uOutlineWeight = realOutlineWeight;
    		this.shader.uniforms.uFillAlpha = this.fillAlpha;

    		this.shader.uniforms.uInvert = this.invert;
    	} else {
    		this.shader.alpha = this.worldAlpha;
    		this.shader.tint = this.tint;
    	}

    	this._styleDirty = false;
    }

    _renderDefault(renderer) {
    	// for SDF
    	if (this.worldAlpha !== this._lastWorldAlpha) {
    		this._styleDirty = true;
    	}

    	if (this._styleDirty) {
    		this.updateStyle();
    	}

    	super._renderDefault(renderer);
    }

    _render(renderer) {
    	// for non-SDF
    	if (this.worldAlpha !== this._lastWorldAlpha) {
    		this._styleDirty = true;
    	}

    	if (this._styleDirty) {
    		this.updateStyle();
    	}

    	super._render(renderer);
    }

    get texture() {
    	return this._texture;
    }

    set texture(value) {
    	if (this._texture === value) { return; }
    	this._texture = value;

    	if (this._type === 'sdf') {
    		this.shader.uniforms.uSampler = this._texture;
    	} else {
    		this.shader.texture = this._texture;
    	}
    }

    get alpha() {
    	return this._alpha;
    }

    set alpha(value) {
    	if (this._alpha === value) { return; }
    	this._alpha = value;
    	this._styleDirty = true;
    }

    get tint() {
    	return this._tint;
    }

    set tint(value) {
    	if (this._tint === value) { return; }
    	this._tint = value;
    	this._styleDirty = true;
    }

    get weight() {
    	return this._weight;
    }

    set weight(value) {
    	if (this._weight === value) { return; }
    	this._weight = value;
    	this._styleDirty = true;
    }

    get sharpness() {
    	return this._sharpness;
    }

    set sharpness(value) {
    	if (this._sharpness === value) { return; }
    	this._sharpness = value;
    	this._styleDirty = true;
    }

    get invert() {
    	return this._invert;
    }

    set invert(value) {
    	if (this._invert === value) { return; }
    	this._invert = value;
    	this._styleDirty = true;
    }

    get fontSize() {
    	return this._fontSize;
    }

    set fontSize(value) {
    	if (this._fontSize === value) { return; }
    	this._fontSize = value;
    	this._styleDirty = true;
    }

    get outlineWeight() {
    	return this._outlineWeight;
    }

    set outlineWeight(value) {
    	if (this._outlineWeight === value) { return; }
    	this._outlineWeight = value;
    	this._styleDirty = true;
    }

    get outlineAlpha() {
    	return this._outlineAlpha;
    }

    set outlineAlpha(value) {
    	if (this._outlineAlpha === value) { return; }
    	this._outlineAlpha = value;
    	this._styleDirty = true;
    }

    get fillAlpha() {
    	return this._fillAlpha;
    }

    set fillAlpha(value) {
    	if (this._fillAlpha === value) { return; }
    	this._fillAlpha = value;
    	this._styleDirty = true;
    }

    get outlineTint() {
    	return this._outlineTint;
    }

    set outlineTint(value) {
    	if (this._outlineTint === value) { return; }
    	this._outlineTint = value;
    	this._styleDirty = true;
    }

    updateGeometry(newVertices, newUVs, newIndices) {
    	if (newVertices) {
    		const view = this.geometry.getBuffer('aVertexPosition').data;
    		const buffer = view.buffer;

    		if ((newVertices.length * Float32Array.BYTES_PER_ELEMENT) > buffer.byteLength) {
    			// We need to create a new buffer
    			const nbuffer = new ArrayBuffer((newVertices.length + 16) * Float32Array.BYTES_PER_ELEMENT);
    			const nview = new Float32Array(nbuffer, 0, newVertices.length);
    			nview.set(newVertices);

    			this.geometry.getBuffer('aVertexPosition').update(nview);
    		} else if (newVertices.length === view.length) {
    			// Same length, we can just happily set
    			view.set(newVertices);
    			this.geometry.getBuffer('aVertexPosition').update();
    		} else {
    			// Longer or shorter, so we just create a new view for the same buffer then set
    			const nview = new Float32Array(buffer, 0, newVertices.length);
    			nview.set(newVertices);
    			this.geometry.getBuffer('aVertexPosition').update(nview);
    		}
    	}
    	
    	if (newUVs) {
    		const view = this.geometry.getBuffer('aTextureCoord').data;
    		const buffer = view.buffer;

    		if ((newUVs.length * Float32Array.BYTES_PER_ELEMENT) > buffer.byteLength) {
    			// We need to create a new buffer
    			const nbuffer = new ArrayBuffer((newUVs.length + 16) * Float32Array.BYTES_PER_ELEMENT);
    			const nview = new Float32Array(nbuffer, 0, newUVs.length);
    			nview.set(newUVs);

    			this.geometry.getBuffer('aTextureCoord').update(nview);
    		} else if (newUVs.length === view.length) {
    			// Same length, we can just happily set
    			view.set(newUVs);
    			this.geometry.getBuffer('aTextureCoord').update();
    		} else {
    			// Longer or shorter, so we just create a new view for the same buffer then set
    			const nview = new Float32Array(buffer, 0, newUVs.length);
    			nview.set(newUVs);
    			this.geometry.getBuffer('aTextureCoord').update(nview);
    		}
    	}
    	
    	if (newIndices) {
    		const view = this.geometry.getIndex().data;
    		const buffer = view.buffer;

    		if ((newIndices.length * Uint16Array.BYTES_PER_ELEMENT) > buffer.byteLength) {
    			// We need to create a new buffer
    			const nbuffer = new ArrayBuffer((newIndices.length + 16) * Uint16Array.BYTES_PER_ELEMENT);
    			const nview = new Uint16Array(nbuffer, 0, newIndices.length);
    			nview.set(newIndices);

    			this.geometry.getIndex().update(nview);
    		} else if (newIndices.length === view.length) {
    			// Little performance hack... Since we are always just drawing quads,
    			// if the amount of indices stays the same we really don't need a reupload
    		} else if (newIndices.length > view.length) {
    			// Longer, but we can update the same buffer
    			const nview = new Uint16Array(buffer, 0, newIndices.length);
    			nview.set(newIndices);
    			this.geometry.getIndex().update(nview);
    		} else {
    			// Shorter, so we just create a new view for the same buffer
    			const nview = new Uint16Array(buffer, 0, newIndices.length);
    			// We don't need to set these again, as once again we're just drawing quads
    			this.geometry.getIndex().update(nview);
    		}
    	}

    	this.forceUploadGeometry();
    }

    forceUploadGeometry() {
    	if (this._type === 'bitmap' || this._type === 'rasterized') {
    		// this is a dumb hack. this essentially forces pixiJS to upload the new buffers, as otherwise
    		// you may get messed up geometry due to how pixiJS batching works... this is a bit of a pain
    		// but it's not all too slow, as it pulls the element into its own little bubble
    		const transformRef = this.transform;
    		const parentRef = this.parent;
    		const wAlphaRef = this.worldAlpha;

    		this.parent = null;
    		this.transform = this._tempDisplayObjectParent.transform;
    		this.getBounds();

    		this.parent = parentRef;
    		this.transform = transformRef;
    		this.worldAlpha = wAlphaRef;
    	}
    }
}



//
// A font. Use one Font per font family (be it different fonts entirely, or different variations).
// While Fonts allow multiple weights to be rendered when an SDF atlas is used, doing so does not change the
// font's geometry. So, if you need different geometry per weight, you will want to use different Fonts.
//
TheoryType.Font = function(setoptions) {
	const options = {
		fnt: null, // A URL to a .fnt file describing the font geometries.
		type: null, // The type of atlas used. Either 'sdf' or 'bitmap'.
		rasterizeRenderer: null, // The renderer that will be used to rasterize.
		rasterizeSize: 2048, // The size this font will be rasterized to. Take caution with anything above 2048, and try to use pow2
		onload: ()=>{}, // The callback to be called when the .fnt file (not the atlases) is loaded.
		...setoptions
	};

	let fontData = {};
	const fontTextures = new Map();
	const rasterizationCallbacks = new Map();

	if (!options.fnt) { throw new Error('Could not create Font: options.fnt must be set'); }
	if (!options.type) { throw new Error('Could not create Font: options.type must be set'); }

	// Download the .fnt
	TheoryType.Utils.rawXhr(options.fnt).then((fntRaw) => {
		// Parse it
		Object.assign(fontData, TheoryType.ParseFont(fntRaw));

		// Create the necessary Textures
		for (const [pid, page] of fontData.pages) {
			const tex = PIXI.Texture.from(`${ TheoryType.Utils.getPathFromURL(options.fnt) }${ page.file }`);
			fontTextures.set(`p${ pid }.${ options.type }.master`, tex);
		}

		options.onload();
	}).catch((err) => {
		throw err;
	});

	function setRasterizeRenderer(renderer) {
		options.rasterizeRenderer = renderer;
	}

	function rasterizeAllPages(master, cb) {
		for (const [pid, page] of fontData.pages) {
			rasterizePage(fontTextures.get(`p${ pid }.sdf.master`), master, pid, cb);
		}
	}

	function rasterizePage(texture, master, pid, cb, force = false) {
		if (!options.rasterizeRenderer) { throw new Error('Could not rasterize Font: options.rasterizeRenderer must be set'); }
		if (!options.rasterizeSize) { throw new Error('Could not rasterize Font: options.rasterizeSize must be set'); }
		if (fontTextures.get(`p${ pid }.rasterized.${ master }`)) {
			// already rasterized
			cb(fontTextures.get(`p${ pid }.rasterized.${ master }`), master, pid);
			return;
		}
		
		if (!rasterizationCallbacks.has(`p${ pid }.rasterized.${ master }`)) {
			if (cb) {
				rasterizationCallbacks.set(`p${ pid }.rasterized.${ master }`, [cb]);
			}
		} else {
			if (cb) {
				rasterizationCallbacks.get(`p${ pid }.rasterized.${ master }`).push(cb);
			}
			if (!force) {
				return; // we are already rasterizing
			}
		}

		if (!texture.baseTexture.valid) {
			texture.baseTexture.once('loaded', () => {
				rasterizePage(texture, master, pid, undefined, true);
			});
			return;
		}

		const renderTexture = PIXI.RenderTexture.create(options.rasterizeSize, options.rasterizeSize);

		const geometry = new PIXI.Geometry();
		geometry.addAttribute('aVertexPosition', [0, 0, options.rasterizeSize, 0, 0, options.rasterizeSize, options.rasterizeSize, options.rasterizeSize], 2);
		geometry.addAttribute('aTextureCoord', [0, 0, 1, 0, 0, 1, 1, 1], 2);
		geometry.addIndex([0, 1, 2, 1, 3, 2]);
		const realWeight = Math.min(1.0, Math.max(0.0, 1.0 - (master / 1000)));
    	const realSharpness = Math.min(0.15 / (options.rasterizeSize / fontData.common.scaleW), realWeight);
		const shader = new PIXI.Shader(TheoryType.Shader, {
    		uSampler: texture,
    		uAlpha: 1.0,
    		uTint: PIXI.utils.hex2rgb(0xFFFFFF),
    		uWeight: realWeight,
    		uSharpness: realSharpness,
    		uScale: 1.0,
    		uOutlineWeight: 0.1,
    		uOutlineAlpha: 0.0,
    		uFillAlpha: 1.0,
    		uOutlineTint: PIXI.utils.hex2rgb(0x000000),
    		uInvert: 0.0
    	});
		const sdfMesh = new PIXI.Mesh(geometry, shader);
		options.rasterizeRenderer.render(sdfMesh, { renderTexture });

		fontTextures.set(`p${ pid }.rasterized.${ master }`, renderTexture);

		if (rasterizationCallbacks.has(`p${ pid }.rasterized.${ master }`)) {
			for (const cb of rasterizationCallbacks.get(`p${ pid }.rasterized.${ master }`)) {
				cb(renderTexture, master, pid);
			}
			rasterizationCallbacks.delete(`p${ pid }.rasterized.${ master }`);
		}
	}

	//////

	return {
		type: options.type,
		fontData,
		fontTextures,
		rasterize: rasterizeAllPages,
		setRasterizeRenderer
	}
};



//
// Parse .fnt files into proper formats.
//
TheoryType.ParseFont = function(fntRaw) {
	const fontData = {
		info: {},
		common: {},
		pages: new Map(),
		chars: new Map(),
		kernings: new Map()
	};

	// Parse the .fnt file itself
	const lines = fntRaw.split(/\r?\n/);
	for (let line of lines) {
		line = line.trim();
		if (!line) { continue; }

		// Get line type
		const lineType = line.split(' ')[0];
		line = line.substring(lineType.length + 1);

		// Get line content
		const regex = /([a-zA-Z]+)=(".*?"|\S*?)(?:\s|$)/g;
		const lineData = {};
		while (match = regex.exec(line)) {
			const key = match[1];
			let value = match[2];

			if (value.startsWith('"')) {
				value = value.substring(1, value.length - 1);
			} else if (value.includes(',')) {
				value = value.split(',').map(o => parseFloat(o));
			} else {
				value = parseFloat(value);
			}

			switch (lineType) {
				case 'info':
					fontData.info[key] = value;
					break;
				case 'common':
					fontData.common[key] = value;
					break;
				default:
					lineData[key] = value;
					break;
			}
		}

		// Attach it back into the font data if needed
		switch (lineType) {
			case 'page':
				fontData.pages.set(lineData.id, lineData);
				break;
			case 'char':
				fontData.chars.set(String.fromCharCode(lineData.id), lineData);
				break;
			case 'kerning':
				fontData.kernings.set(`${ String.fromCharCode(lineData.first) }${ String.fromCharCode(lineData.second) }`, lineData);
				break;
		}
	}

	return fontData;
};



//
// Layout text into a Map of <pageID, Object{ i, vertices, uvs, indices }> objects.
//
TheoryType.LayoutText = function(text, style, font, scale = 1) {
	let geometries = new Map();
	const fd = font.fontData;
	const lineWidths = [];
	const lineCounts = [];
	const lineOffsets = [];
	const lineJustifications = [];
	let xAnchorOffset = 0;
	let yAnchorOffset = 0;
	const prng = new TheoryType.Utils.PRNG(style.misalignmentSeed || 0);
	const misalignmentIsArray = Array.isArray(style.misalignment);

	if (style._cache) {
		geometries = TheoryType.CopyGeometry(style._cache);
	} else {
		// if align mode isn't 'left', or we are horizontally anchoring, then we need line width calculations
		if (style.align !== 'left' || style.anchor.x !== 0) {
			let x = 0;
			let count = 0;
			let line = 0;
			let previous = null;
			let scaleModifier = 1;
			let awaitingNewScale = false;
			for (const char of text) {
				if (awaitingNewScale) {
					switch (char) {
						case 't': break;
						case 'c': break;
						case 'b': break;
						default: {
							scaleModifier = TheoryType.Constants.modifierMapping[char] || 1.00;
							awaitingNewScale = false;
							break;
						}
					}
					continue;
				}
				if (char === '\n') {
					lineWidths[line] = x - style.letterSpacing;
					lineCounts[line] = count;
					x = 0;
					count = 0;
					previous = null;
					line++;
					continue;
				}
				if (char === '\f') {
					awaitingNewScale = true;
					continue;
				}
				let c = fd.chars.get(char);
				if (!c) { c = fd.chars.get(String.fromCharCode(0)); }
				if (!c) { continue; } // ignore invalid characters if no fallback exists
				if (previous) {
					let kerning = fd.kernings.get(`${ previous }${ char }`);
					if (kerning) {
						x += kerning.amount * scaleModifier;
					}
				}
				x += (c.xadvance + style.letterSpacing) * scaleModifier;
				count++;
				previous = char;
			}
			lineWidths[line] = x - style.letterSpacing * scaleModifier;
			lineCounts[line] = count;

			// now that we know the lines' widths, we can decide offsets or justifications
			const widestLine = Math.max(...lineWidths);
			switch (style.align) {
				case 'center': {
					for (const lineWidth of lineWidths) {
						lineOffsets.push((widestLine - lineWidth) / 2);
					}
					break;
				}
				case 'right': {
					for (const lineWidth of lineWidths) {
						lineOffsets.push(widestLine - lineWidth);
					}
					break;
				}
				case 'justify': {
					for (const lineWidth of lineWidths) {
						lineJustifications.push((widestLine - lineWidth) / Math.max(1, lineCounts.shift() - 1));
					}
					break;
				}
			}

			xAnchorOffset = -1 * widestLine * style.anchor.x;
			yAnchorOffset = -1 * (fd.common.lineHeight * lineWidths.length) * style.anchor.y;
		} else if (style.anchor.y !== 0) {
			// we haven't calculated this yet
			yAnchorOffset = -1 * (text.split('\n').length) * style.anchor.y;
		}

		// build geometries
		let x = 0;
		let y = 0;
		let line = 0;
		let previous = null;
		let scaleModifier = 1;
		let awaitingNewScale = false;
		let verticalAlignment = 'bottom';

		for (const char of text) {
			if (awaitingNewScale) {
				switch (char) {
					case 't': verticalAlignment = 'top'; break;
					case 'c': verticalAlignment = 'center'; break;
					case 'b': verticalAlignment = 'bottom'; break;
					default: {
						scaleModifier = TheoryType.Constants.modifierMapping[char] || 1.00;
						awaitingNewScale = false;
						break;
					}
				}
				continue;
			}
			if (char === '\n') {
				x = 0;
				y += fd.common.lineHeight + style.lineSpacing;
				previous = null;
				line++;
				continue;
			}
			if (char === '\f') {
				awaitingNewScale = true;
				continue;
			}
			let c = fd.chars.get(char);
			if (!c) { c = fd.chars.get(String.fromCharCode(0)); }
			if (!c) { continue; } // ignore invalid characters if no fallback exists
			if (previous) {
				let kerning = fd.kernings.get(`${ previous }${ char }`);
				if (kerning) {
					x += kerning.amount * scaleModifier;
				}
			}

			if (!geometries.has(c.page)) {
				geometries.set(c.page, {
					i: 0,
					vertices: [],
					uvs: [],
					indices: []
				});
			}
			const g = geometries.get(c.page);

			let baseOffsetX = ((lineOffsets[line] || 0) + xAnchorOffset) / scaleModifier;
			let baseOffsetY = yAnchorOffset / scaleModifier;

			if (scaleModifier !== 1.0) {
				if (verticalAlignment === 'bottom') {
					baseOffsetY += (fd.common.base - (scaleModifier * fd.common.base)) / scaleModifier;
				} else if (verticalAlignment === 'center') {
					baseOffsetY += ((fd.common.base - (scaleModifier * fd.common.base)) / scaleModifier) / 2;
				}
			}

			g.vertices.push(
				(x + (c.xoffset + baseOffsetX) * scaleModifier) * scale, (y + (c.yoffset + baseOffsetY) * scaleModifier) * scale, // top left vertex
				(x + (c.xoffset + c.width + baseOffsetX) * scaleModifier) * scale, (y + (c.yoffset + baseOffsetY) * scaleModifier) * scale, // top right vertex
				(x + (c.xoffset + baseOffsetX) * scaleModifier) * scale, (y + (c.yoffset + c.height + baseOffsetY) * scaleModifier) * scale, // bottom left vertex
				(x + (c.xoffset + c.width + baseOffsetX) * scaleModifier) * scale, (y + (c.yoffset + c.height + baseOffsetY) * scaleModifier) * scale, // bottom right vertex
			);
			g.uvs.push(
				c.x / fd.common.scaleW, c.y / fd.common.scaleH, // top left vertex
				(c.x + c.width) / fd.common.scaleW, c.y / fd.common.scaleH, // top right vertex
				c.x / fd.common.scaleW, (c.y + c.height) / fd.common.scaleH, // bottom left vertex
				(c.x + c.width) / fd.common.scaleW, (c.y + c.height) / fd.common.scaleH, // bottom right vertex
			);
			g.indices.push(
				0 + g.i * 4, // triangle 1, top left vertex
				1 + g.i * 4, // triangle 1, top right vertex
				2 + g.i * 4, // triangle 1, bottom left vertex
				1 + g.i * 4, // triangle 2, top right vertex
				3 + g.i * 4, // triangle 2, bottom right vertex
				2 + g.i * 4, // triangle 2, bottom left vertex
			);

			x += (c.xadvance + style.letterSpacing) * scaleModifier + (lineJustifications[line] || 0);

			g.i++;
			previous = char;
		}

		style._cache = TheoryType.CopyGeometry(geometries);
	}

	// Character transforms
	let charIndex = 0;
	for (const [,g] of geometries) {
		for (let i = 0; i < g.vertices.length; i += 8) {
			const cw = g.vertices[i+2] - g.vertices[i+0];
			const ch = g.vertices[i+5] - g.vertices[i+1];
			const mpx = (g.vertices[i+2] + g.vertices[i+0]) / 2;
			const mpy = (g.vertices[i+5] + g.vertices[i+1]) / 2;

			let theta = style.overrides.get(charIndex).theta;
			let offsetX = style.overrides.get(charIndex).x;
			let offsetY = style.overrides.get(charIndex).y;
			let offsetScale = style.overrides.get(charIndex).scale;
			let offsetUseProjection = style.overrides.get(charIndex).useProjection;
			let offsetProjection = style.overrides.get(charIndex).projection;
			if (misalignmentIsArray || style.misalignment !== 0.0) {
				offsetX += (misalignmentIsArray ? style.misalignment[0] : style.misalignment) * (prng.nextFloat() * 2 - 1);
				offsetY += (misalignmentIsArray ? style.misalignment[1] : style.misalignment) * (prng.nextFloat() * 2 - 1);
				if (!misalignmentIsArray || (style.misalignment[2] !== 0.0)) {
					theta += (misalignmentIsArray ? style.misalignment[2] : style.misalignment) * (prng.nextFloat() * 2 - 1);
				}
			}

			if (offsetUseProjection) {
				g.vertices[i+0] += cw * offsetProjection[0].x;         // top left, X
				g.vertices[i+1] += ch * offsetProjection[0].y;         // top left, Y
				g.vertices[i+2] += cw * (offsetProjection[1].x - 1.0); // top right, X
				g.vertices[i+3] += ch * offsetProjection[1].y;         // top right, Y
				g.vertices[i+4] += cw * offsetProjection[2].x;         // bottom left, X
				g.vertices[i+5] += ch * (offsetProjection[2].y - 1.0); // bottom left, Y
				g.vertices[i+6] += cw * (offsetProjection[3].x - 1.0); // bottom right, X
				g.vertices[i+7] += ch * (offsetProjection[3].y - 1.0); // bottom right, Y
			}

			if (offsetScale !== 1.0) {
				g.vertices[i+0] += ((cw / -2) * offsetScale - (cw / -2)); // top left, X
				g.vertices[i+1] += ((ch / -2) * offsetScale - (ch / -2)); // top left, Y
				g.vertices[i+2] += ((cw /  2) * offsetScale - (cw /  2)); // top right, X
				g.vertices[i+3] += ((ch / -2) * offsetScale - (ch / -2)); // top right, Y
				g.vertices[i+4] += ((cw / -2) * offsetScale - (cw / -2)); // bottom left, X
				g.vertices[i+5] += ((ch /  2) * offsetScale - (ch /  2)); // bottom left, Y
				g.vertices[i+6] += ((cw /  2) * offsetScale - (cw /  2)); // bottom right, X
				g.vertices[i+7] += ((ch /  2) * offsetScale - (ch /  2)); // bottom right, Y
			}

			if (theta !== 0.0) {
				g.vertices[i+0] += ((cw / -2) * Math.cos(theta) - (ch / -2) * Math.sin(theta) - cw / -2); // top left, X
				g.vertices[i+1] += ((cw / -2) * Math.sin(theta) + (ch / -2) * Math.cos(theta) - ch / -2); // top left, Y
				g.vertices[i+2] += ((cw /  2) * Math.cos(theta) - (ch / -2) * Math.sin(theta) - cw /  2); // top right, X
				g.vertices[i+3] += ((cw /  2) * Math.sin(theta) + (ch / -2) * Math.cos(theta) - ch / -2); // top right, Y
				g.vertices[i+4] += ((cw / -2) * Math.cos(theta) - (ch /  2) * Math.sin(theta) - cw / -2); // bottom left, X
				g.vertices[i+5] += ((cw / -2) * Math.sin(theta) + (ch /  2) * Math.cos(theta) - ch /  2); // bottom left, Y
				g.vertices[i+6] += ((cw /  2) * Math.cos(theta) - (ch /  2) * Math.sin(theta) - cw /  2); // bottom right, X
				g.vertices[i+7] += ((cw /  2) * Math.sin(theta) + (ch /  2) * Math.cos(theta) - ch /  2); // bottom right, Y
			}

			if (offsetX !== 0.0 || offsetY !== 0.0) {
				g.vertices[i+0] += scale * offsetX; // top left, X
				g.vertices[i+1] += scale * offsetY; // top left, Y
				g.vertices[i+2] += scale * offsetX; // top right, X
				g.vertices[i+3] += scale * offsetY; // top right, Y
				g.vertices[i+4] += scale * offsetX; // bottom left, X
				g.vertices[i+5] += scale * offsetY; // bottom left, Y
				g.vertices[i+6] += scale * offsetX; // bottom right, X
				g.vertices[i+7] += scale * offsetY; // bottom right, Y
			}

			charIndex++;
		}
	}
	
	// Entire element transforms
	if (style.useProjection) {
		let totalWidth = 0;
		let totalHeight = 0;
		for (const [,g] of geometries) {
			totalWidth = Math.max(totalWidth, g.vertices.reduce((acc, v, i) => { return Math.max(acc, i % 2 === 0 ? v : 0); }, 0));
			totalHeight = Math.max(totalHeight, g.vertices.reduce((acc, v, i) => { return Math.max(acc, i % 2 === 1 ? v : 0); }, 0));
		}
		const p = style.projection; // shorthand
		// ok, now adjust all these vertices with the projection
		for (const [,g] of geometries) {
			for (let i = 0; i < g.vertices.length; i += 2) {
				// normalize the vertices here
				let x = g.vertices[i] / totalWidth;
				let y = g.vertices[i + 1] / totalHeight;

				const top = p[0].x + (p[1].x - p[0].x) * x;
				const bottom = p[2].x + (p[3].x - p[2].x) * x;
				const finalX = top + (bottom - top) * y;

				const left = p[0].y + (p[2].y - p[0].y) * y;
				const right = p[1].y + (p[3].y - p[1].y) * y;
				const finalY = left + (right - left) * x;

				g.vertices[i] = finalX * totalWidth;
				g.vertices[i + 1] = finalY * totalHeight;
			}
		}
	}

	return geometries;
};



//
// A wrapper class for a Map meant to store character overrides, that alerts the owner Text object that its contents have changed.
//
TheoryType.CharacterOverrideMap = class TheoryTypeCharacterOverrideMap extends Map {
	constructor(onchange, ...args) {
		super(...args);
		this._onchange = onchange;
	}

	get(key) {
		if (!super.has(key)) {
			super.set(key, new TheoryType.CharacterOverride(this._onchange));
		}
        return super.get(key);
    }

    set(key, value) {
        const retv = super.set(key, value);
        this._onchange();
        return retv;
    }
}



//
// A simple container class that alerts its owner CharacterOverrideMap (and this its owner Text) that its contents have changed.
// Meant to store character override data.
//
TheoryType.CharacterOverride = class TheoryTypeCharacterOverride {
	constructor(onchange) {
		this._onchange = onchange;
		this._x = 0.0;
		this._y = 0.0;
		this._theta = 0.0;
		this._scale = 1.0;
		this._useProjection = false;
		this._projection = [[0,0],[1,0],[0,1],[1,1]];

		for (let i = 0; i < 4; i++) {
			this._projection[i] = new PIXI.ObservablePoint(() => { this._onchange(); }, this, ...this._projection[i]);
		}
	}

	get x() {
		return this._x;
    }
    set x(value) {
		this._x = value;
		this._onchange();
    }

	get y() {
		return this._y;
    }
    set y(value) {
		this._y = value;
		this._onchange();
    }

	get theta() {
		return this._theta;
    }
    set theta(value) {
		this._theta = value;
		this._onchange();
    }

	get scale() {
		return this._scale;
    }
    set scale(value) {
		this._scale = value;
		this._onchange();
    }

	get useProjection() {
		return this._useProjection;
    }
    set useProjection(value) {
		this._useProjection = !!value;
		this._onchange();
    }

	get projection() {
		return this._projection;
    }
}



//
// Copy a simple geometry, for inserting and taking from cache.
//
TheoryType.CopyGeometry = function(simple) {
	const geo = new Map();
	for (const [i,g] of simple) {
		geo.set(i, {
			i: g.i,
			vertices: [...g.vertices],
			uvs: [...g.uvs],
			indices: [...g.indices]
		});
	}
	return geo;
}



//
// Turn a simple object in a PIXI.Geometry.
//
TheoryType.Geometrize = function(simple) {
	const geo = new PIXI.Geometry();
	geo.addAttribute('aVertexPosition', simple.vertices, 2);
	geo.addAttribute('aTextureCoord', simple.uvs, 2);
	geo.addIndex(simple.indices);
	return geo;
}



//
// TheoryType constants
//
TheoryType.Constants = {
	modifierMapping: {
		'1': 0.20,
		'2': 0.40,
		'3': 0.60,
		'4': 0.80,
		'5': 1.00,
		'6': 1.25,
		'7': 1.50,
		'8': 1.75,
		'9': 2.00,
	}
};



//
// TheoryType utilities
//
TheoryType.Utils = (() => {
	function rawXhr(url) {
		return new Promise((resolve, reject) => {
			const request = new XMLHttpRequest();
			request.open('GET', url, true);

			request.onload = () => {
				if (request.readyState === 4) {
					resolve(request.responseText);
				}
			};
			request.onerror = () => {
				reject(new Error('Could not create Font: could not download .fnt file'));
			};

			request.send();
		});
	}

	function getPathFromURL(url) {
		if (!url.includes('/')) {
			return '';
		}
		return `${ url.split('/').slice(0, -1).join('/') }/`;
	}

	function PRNG(seed) {
		let _seed = parseInt(seed) % 2147483647;
	
		if (_seed <= 0) {
			_seed += 2147483646;
		}

		return {
			next: function() {
				return _seed = _seed * 16807 % 2147483647;
			},
			nextFloat: function(opt_minOrMax, opt_max) {
				return (this.next() - 1) / 2147483646;
			},
			shuffleArray: function(array) {
				let i = array.length;
				let j;

				if (i == 0) {
					return array;
				}

				while (--i) {
					j = Math.floor(this.nextFloat() * (i + 1));
					[array[i], array[j]] = [array[j], array[i]];
				}
				return array;
			},
			getCurrentSeed: function() {
				return _seed;
			}
		}
	}

	return {
		rawXhr,
		getPathFromURL,
		PRNG
	};
})();



//
// TheoryType shaders
//
TheoryType.ShaderSources = {
	vertex: `
	    attribute vec2 aVertexPosition;
		attribute vec2 aTextureCoord;

		uniform mat3 translationMatrix;
		uniform mat3 projectionMatrix;
		uniform float uScale;

		varying vec2 vTextureCoord;

		void main(void)
		{
		    vTextureCoord = aTextureCoord;
		    gl_Position = vec4((projectionMatrix * translationMatrix * vec3(aVertexPosition * uScale, 1.0)).xy, 0.0, 1.0);
		}`,
	fragment: `
		uniform sampler2D uSampler;
		uniform vec3 uTint;
		uniform float uAlpha;
		uniform float uWeight;
		uniform vec3 uOutlineTint;
		uniform float uOutlineAlpha;
		uniform float uFillAlpha;
		uniform float uOutlineWeight;
		uniform float uSharpness;
		uniform float uInvert;

	    varying vec2 vTextureCoord;

		void main(void)
		{
			vec4 color;
			float dist = texture2D(uSampler, vTextureCoord).a;
			dist = mix(dist, 1.0 - dist, uInvert);

			float innerAlpha = smoothstep(uWeight - uSharpness, uWeight + uSharpness, dist);

			if (uOutlineAlpha > 0.0) {
				float outerAlpha = smoothstep(uOutlineWeight - uSharpness, uOutlineWeight + uSharpness, dist) * uOutlineAlpha;
				vec4 outerColor = vec4(uOutlineTint, 1.0) * outerAlpha;
				vec4 innerColor = vec4(uTint, 1.0) * uFillAlpha;
				gl_FragColor = mix(outerColor, innerColor, innerAlpha) * uAlpha;
			} else {
				gl_FragColor = vec4(uTint, 1.0) * (innerAlpha) * uAlpha;
			}
		}`
};
TheoryType.Shader = new PIXI.Program(TheoryType.ShaderSources.vertex, TheoryType.ShaderSources.fragment, 'THEORYTYPE');

/*! howler.js v2.1.3 | (c) 2013-2019, James Simpson of GoldFire Studios | MIT License | howlerjs.com */
!function(){"use strict";var e=function(){this.init()};e.prototype={init:function(){var e=this||n;return e._counter=1e3,e._html5AudioPool=[],e.html5PoolSize=10,e._codecs={},e._howls=[],e._muted=!1,e._volume=1,e._canPlayEvent="canplaythrough",e._navigator="undefined"!=typeof window&&window.navigator?window.navigator:null,e.masterGain=null,e.noAudio=!1,e.usingWebAudio=!0,e.autoSuspend=!0,e.ctx=null,e.autoUnlock=!0,e._setup(),e},volume:function(e){var o=this||n;if(e=parseFloat(e),o.ctx||_(),void 0!==e&&e>=0&&e<=1){if(o._volume=e,o._muted)return o;o.usingWebAudio&&o.masterGain.gain.setValueAtTime(e,n.ctx.currentTime);for(var t=0;t<o._howls.length;t++)if(!o._howls[t]._webAudio)for(var r=o._howls[t]._getSoundIds(),a=0;a<r.length;a++){var u=o._howls[t]._soundById(r[a]);u&&u._node&&(u._node.volume=u._volume*e)}return o}return o._volume},mute:function(e){var o=this||n;o.ctx||_(),o._muted=e,o.usingWebAudio&&o.masterGain.gain.setValueAtTime(e?0:o._volume,n.ctx.currentTime);for(var t=0;t<o._howls.length;t++)if(!o._howls[t]._webAudio)for(var r=o._howls[t]._getSoundIds(),a=0;a<r.length;a++){var u=o._howls[t]._soundById(r[a]);u&&u._node&&(u._node.muted=!!e||u._muted)}return o},unload:function(){for(var e=this||n,o=e._howls.length-1;o>=0;o--)e._howls[o].unload();return e.usingWebAudio&&e.ctx&&void 0!==e.ctx.close&&(e.ctx.close(),e.ctx=null,_()),e},codecs:function(e){return(this||n)._codecs[e.replace(/^x-/,"")]},_setup:function(){var e=this||n;if(e.state=e.ctx?e.ctx.state||"suspended":"suspended",e._autoSuspend(),!e.usingWebAudio)if("undefined"!=typeof Audio)try{var o=new Audio;void 0===o.oncanplaythrough&&(e._canPlayEvent="canplay")}catch(n){e.noAudio=!0}else e.noAudio=!0;try{var o=new Audio;o.muted&&(e.noAudio=!0)}catch(e){}return e.noAudio||e._setupCodecs(),e},_setupCodecs:function(){var e=this||n,o=null;try{o="undefined"!=typeof Audio?new Audio:null}catch(n){return e}if(!o||"function"!=typeof o.canPlayType)return e;var t=o.canPlayType("audio/mpeg;").replace(/^no$/,""),r=e._navigator&&e._navigator.userAgent.match(/OPR\/([0-6].)/g),a=r&&parseInt(r[0].split("/")[1],10)<33;return e._codecs={mp3:!(a||!t&&!o.canPlayType("audio/mp3;").replace(/^no$/,"")),mpeg:!!t,opus:!!o.canPlayType('audio/ogg; codecs="opus"').replace(/^no$/,""),ogg:!!o.canPlayType('audio/ogg; codecs="vorbis"').replace(/^no$/,""),oga:!!o.canPlayType('audio/ogg; codecs="vorbis"').replace(/^no$/,""),wav:!!o.canPlayType('audio/wav; codecs="1"').replace(/^no$/,""),aac:!!o.canPlayType("audio/aac;").replace(/^no$/,""),caf:!!o.canPlayType("audio/x-caf;").replace(/^no$/,""),m4a:!!(o.canPlayType("audio/x-m4a;")||o.canPlayType("audio/m4a;")||o.canPlayType("audio/aac;")).replace(/^no$/,""),mp4:!!(o.canPlayType("audio/x-mp4;")||o.canPlayType("audio/mp4;")||o.canPlayType("audio/aac;")).replace(/^no$/,""),weba:!!o.canPlayType('audio/webm; codecs="vorbis"').replace(/^no$/,""),webm:!!o.canPlayType('audio/webm; codecs="vorbis"').replace(/^no$/,""),dolby:!!o.canPlayType('audio/mp4; codecs="ec-3"').replace(/^no$/,""),flac:!!(o.canPlayType("audio/x-flac;")||o.canPlayType("audio/flac;")).replace(/^no$/,"")},e},_unlockAudio:function(){var e=this||n;if(!e._audioUnlocked&&e.ctx){e._audioUnlocked=!1,e.autoUnlock=!1,e._mobileUnloaded||44100===e.ctx.sampleRate||(e._mobileUnloaded=!0,e.unload()),e._scratchBuffer=e.ctx.createBuffer(1,1,22050);var o=function(n){for(var t=0;t<e.html5PoolSize;t++)try{var r=new Audio;r._unlocked=!0,e._releaseHtml5Audio(r)}catch(n){e.noAudio=!0}for(var t=0;t<e._howls.length;t++)if(!e._howls[t]._webAudio)for(var a=e._howls[t]._getSoundIds(),u=0;u<a.length;u++){var i=e._howls[t]._soundById(a[u]);i&&i._node&&!i._node._unlocked&&(i._node._unlocked=!0,i._node.load())}e._autoResume();var d=e.ctx.createBufferSource();d.buffer=e._scratchBuffer,d.connect(e.ctx.destination),void 0===d.start?d.noteOn(0):d.start(0),"function"==typeof e.ctx.resume&&e.ctx.resume(),d.onended=function(){d.disconnect(0),e._audioUnlocked=!0,document.removeEventListener("touchstart",o,!0),document.removeEventListener("touchend",o,!0),document.removeEventListener("click",o,!0);for(var n=0;n<e._howls.length;n++)e._howls[n]._emit("unlock")}};return document.addEventListener("touchstart",o,!0),document.addEventListener("touchend",o,!0),document.addEventListener("click",o,!0),e}},_obtainHtml5Audio:function(){var e=this||n;if(e._html5AudioPool.length)return e._html5AudioPool.pop();var o=(new Audio).play();return o&&"undefined"!=typeof Promise&&(o instanceof Promise||"function"==typeof o.then)&&o.catch(function(){console.warn("HTML5 Audio pool exhausted, returning potentially locked audio object.")}),new Audio},_releaseHtml5Audio:function(e){var o=this||n;return e._unlocked&&o._html5AudioPool.push(e),o},_autoSuspend:function(){var e=this;if(e.autoSuspend&&e.ctx&&void 0!==e.ctx.suspend&&n.usingWebAudio){for(var o=0;o<e._howls.length;o++)if(e._howls[o]._webAudio)for(var t=0;t<e._howls[o]._sounds.length;t++)if(!e._howls[o]._sounds[t]._paused)return e;return e._suspendTimer&&clearTimeout(e._suspendTimer),e._suspendTimer=setTimeout(function(){e.autoSuspend&&(e._suspendTimer=null,e.state="suspending",e.ctx.suspend().then(function(){e.state="suspended",e._resumeAfterSuspend&&(delete e._resumeAfterSuspend,e._autoResume())}))},3e4),e}},_autoResume:function(){var e=this;if(e.ctx&&void 0!==e.ctx.resume&&n.usingWebAudio)return"running"===e.state&&e._suspendTimer?(clearTimeout(e._suspendTimer),e._suspendTimer=null):"suspended"===e.state?(e.ctx.resume().then(function(){e.state="running";for(var n=0;n<e._howls.length;n++)e._howls[n]._emit("resume")}),e._suspendTimer&&(clearTimeout(e._suspendTimer),e._suspendTimer=null)):"suspending"===e.state&&(e._resumeAfterSuspend=!0),e}};var n=new e,o=function(e){var n=this;if(!e.src||0===e.src.length)return void console.error("An array of source files must be passed with any new Howl.");n.init(e)};o.prototype={init:function(e){var o=this;return n.ctx||_(),o._autoplay=e.autoplay||!1,o._format="string"!=typeof e.format?e.format:[e.format],o._html5=e.html5||!1,o._muted=e.mute||!1,o._loop=e.loop||!1,o._pool=e.pool||5,o._preload="boolean"!=typeof e.preload||e.preload,o._rate=e.rate||1,o._sprite=e.sprite||{},o._src="string"!=typeof e.src?e.src:[e.src],o._volume=void 0!==e.volume?e.volume:1,o._xhrWithCredentials=e.xhrWithCredentials||!1,o._duration=0,o._state="unloaded",o._sounds=[],o._endTimers={},o._queue=[],o._playLock=!1,o._onend=e.onend?[{fn:e.onend}]:[],o._onfade=e.onfade?[{fn:e.onfade}]:[],o._onload=e.onload?[{fn:e.onload}]:[],o._onloaderror=e.onloaderror?[{fn:e.onloaderror}]:[],o._onplayerror=e.onplayerror?[{fn:e.onplayerror}]:[],o._onpause=e.onpause?[{fn:e.onpause}]:[],o._onplay=e.onplay?[{fn:e.onplay}]:[],o._onstop=e.onstop?[{fn:e.onstop}]:[],o._onmute=e.onmute?[{fn:e.onmute}]:[],o._onvolume=e.onvolume?[{fn:e.onvolume}]:[],o._onrate=e.onrate?[{fn:e.onrate}]:[],o._onseek=e.onseek?[{fn:e.onseek}]:[],o._onunlock=e.onunlock?[{fn:e.onunlock}]:[],o._onresume=[],o._webAudio=n.usingWebAudio&&!o._html5,void 0!==n.ctx&&n.ctx&&n.autoUnlock&&n._unlockAudio(),n._howls.push(o),o._autoplay&&o._queue.push({event:"play",action:function(){o.play()}}),o._preload&&o.load(),o},load:function(){var e=this,o=null;if(n.noAudio)return void e._emit("loaderror",null,"No audio support.");"string"==typeof e._src&&(e._src=[e._src]);for(var r=0;r<e._src.length;r++){var u,i;if(e._format&&e._format[r])u=e._format[r];else{if("string"!=typeof(i=e._src[r])){e._emit("loaderror",null,"Non-string found in selected audio sources - ignoring.");continue}u=/^data:audio\/([^;,]+);/i.exec(i),u||(u=/\.([^.]+)$/.exec(i.split("?",1)[0])),u&&(u=u[1].toLowerCase())}if(u||console.warn('No file extension was found. Consider using the "format" property or specify an extension.'),u&&n.codecs(u)){o=e._src[r];break}}return o?(e._src=o,e._state="loading","https:"===window.location.protocol&&"http:"===o.slice(0,5)&&(e._html5=!0,e._webAudio=!1),new t(e),e._webAudio&&a(e),e):void e._emit("loaderror",null,"No codec support for selected audio sources.")},play:function(e,o){var t=this,r=null;if("number"==typeof e)r=e,e=null;else{if("string"==typeof e&&"loaded"===t._state&&!t._sprite[e])return null;if(void 0===e&&(e="__default",!t._playLock)){for(var a=0,u=0;u<t._sounds.length;u++)t._sounds[u]._paused&&!t._sounds[u]._ended&&(a++,r=t._sounds[u]._id);1===a?e=null:r=null}}var i=r?t._soundById(r):t._inactiveSound();if(!i)return null;if(r&&!e&&(e=i._sprite||"__default"),"loaded"!==t._state){i._sprite=e,i._ended=!1;var d=i._id;return t._queue.push({event:"play",action:function(){t.play(d)}}),d}if(r&&!i._paused)return o||t._loadQueue("play"),i._id;t._webAudio&&n._autoResume();var _=Math.max(0,i._seek>0?i._seek:t._sprite[e][0]/1e3),s=Math.max(0,(t._sprite[e][0]+t._sprite[e][1])/1e3-_),l=1e3*s/Math.abs(i._rate),c=t._sprite[e][0]/1e3,f=(t._sprite[e][0]+t._sprite[e][1])/1e3;i._sprite=e,i._ended=!1;var p=function(){i._paused=!1,i._seek=_,i._start=c,i._stop=f,i._loop=!(!i._loop&&!t._sprite[e][2])};if(_>=f)return void t._ended(i);var m=i._node;if(t._webAudio){var v=function(){t._playLock=!1,p(),t._refreshBuffer(i);var e=i._muted||t._muted?0:i._volume;m.gain.setValueAtTime(e,n.ctx.currentTime),i._playStart=n.ctx.currentTime,void 0===m.bufferSource.start?i._loop?m.bufferSource.noteGrainOn(0,_,86400):m.bufferSource.noteGrainOn(0,_,s):i._loop?m.bufferSource.start(0,_,86400):m.bufferSource.start(0,_,s),l!==1/0&&(t._endTimers[i._id]=setTimeout(t._ended.bind(t,i),l)),o||setTimeout(function(){t._emit("play",i._id),t._loadQueue()},0)};"running"===n.state?v():(t._playLock=!0,t.once("resume",v),t._clearTimer(i._id))}else{var h=function(){m.currentTime=_,m.muted=i._muted||t._muted||n._muted||m.muted,m.volume=i._volume*n.volume(),m.playbackRate=i._rate;try{var r=m.play();if(r&&"undefined"!=typeof Promise&&(r instanceof Promise||"function"==typeof r.then)?(t._playLock=!0,p(),r.then(function(){t._playLock=!1,m._unlocked=!0,o||(t._emit("play",i._id),t._loadQueue())}).catch(function(){t._playLock=!1,t._emit("playerror",i._id,"Playback was unable to start. This is most commonly an issue on mobile devices and Chrome where playback was not within a user interaction."),i._ended=!0,i._paused=!0})):o||(t._playLock=!1,p(),t._emit("play",i._id),t._loadQueue()),m.playbackRate=i._rate,m.paused)return void t._emit("playerror",i._id,"Playback was unable to start. This is most commonly an issue on mobile devices and Chrome where playback was not within a user interaction.");"__default"!==e||i._loop?t._endTimers[i._id]=setTimeout(t._ended.bind(t,i),l):(t._endTimers[i._id]=function(){t._ended(i),m.removeEventListener("ended",t._endTimers[i._id],!1)},m.addEventListener("ended",t._endTimers[i._id],!1))}catch(e){t._emit("playerror",i._id,e)}};"data:audio/wav;base64,UklGRigAAABXQVZFZm10IBIAAAABAAEARKwAAIhYAQACABAAAABkYXRhAgAAAAEA"===m.src&&(m.src=t._src,m.load());var y=window&&window.ejecta||!m.readyState&&n._navigator.isCocoonJS;if(m.readyState>=3||y)h();else{t._playLock=!0;var g=function(){h(),m.removeEventListener(n._canPlayEvent,g,!1)};m.addEventListener(n._canPlayEvent,g,!1),t._clearTimer(i._id)}}return i._id},pause:function(e){var n=this;if("loaded"!==n._state||n._playLock)return n._queue.push({event:"pause",action:function(){n.pause(e)}}),n;for(var o=n._getSoundIds(e),t=0;t<o.length;t++){n._clearTimer(o[t]);var r=n._soundById(o[t]);if(r&&!r._paused&&(r._seek=n.seek(o[t]),r._rateSeek=0,r._paused=!0,n._stopFade(o[t]),r._node))if(n._webAudio){if(!r._node.bufferSource)continue;void 0===r._node.bufferSource.stop?r._node.bufferSource.noteOff(0):r._node.bufferSource.stop(0),n._cleanBuffer(r._node)}else isNaN(r._node.duration)&&r._node.duration!==1/0||r._node.pause();arguments[1]||n._emit("pause",r?r._id:null)}return n},stop:function(e,n){var o=this;if("loaded"!==o._state||o._playLock)return o._queue.push({event:"stop",action:function(){o.stop(e)}}),o;for(var t=o._getSoundIds(e),r=0;r<t.length;r++){o._clearTimer(t[r]);var a=o._soundById(t[r]);a&&(a._seek=a._start||0,a._rateSeek=0,a._paused=!0,a._ended=!0,o._stopFade(t[r]),a._node&&(o._webAudio?a._node.bufferSource&&(void 0===a._node.bufferSource.stop?a._node.bufferSource.noteOff(0):a._node.bufferSource.stop(0),o._cleanBuffer(a._node)):isNaN(a._node.duration)&&a._node.duration!==1/0||(a._node.currentTime=a._start||0,a._node.pause(),a._node.duration===1/0&&o._clearSound(a._node))),n||o._emit("stop",a._id))}return o},mute:function(e,o){var t=this;if("loaded"!==t._state||t._playLock)return t._queue.push({event:"mute",action:function(){t.mute(e,o)}}),t;if(void 0===o){if("boolean"!=typeof e)return t._muted;t._muted=e}for(var r=t._getSoundIds(o),a=0;a<r.length;a++){var u=t._soundById(r[a]);u&&(u._muted=e,u._interval&&t._stopFade(u._id),t._webAudio&&u._node?u._node.gain.setValueAtTime(e?0:u._volume,n.ctx.currentTime):u._node&&(u._node.muted=!!n._muted||e),t._emit("mute",u._id))}return t},volume:function(){var e,o,t=this,r=arguments;if(0===r.length)return t._volume;if(1===r.length||2===r.length&&void 0===r[1]){t._getSoundIds().indexOf(r[0])>=0?o=parseInt(r[0],10):e=parseFloat(r[0])}else r.length>=2&&(e=parseFloat(r[0]),o=parseInt(r[1],10));var a;if(!(void 0!==e&&e>=0&&e<=1))return a=o?t._soundById(o):t._sounds[0],a?a._volume:0;if("loaded"!==t._state||t._playLock)return t._queue.push({event:"volume",action:function(){t.volume.apply(t,r)}}),t;void 0===o&&(t._volume=e),o=t._getSoundIds(o);for(var u=0;u<o.length;u++)(a=t._soundById(o[u]))&&(a._volume=e,r[2]||t._stopFade(o[u]),t._webAudio&&a._node&&!a._muted?a._node.gain.setValueAtTime(e,n.ctx.currentTime):a._node&&!a._muted&&(a._node.volume=e*n.volume()),t._emit("volume",a._id));return t},fade:function(e,o,t,r){var a=this;if("loaded"!==a._state||a._playLock)return a._queue.push({event:"fade",action:function(){a.fade(e,o,t,r)}}),a;e=parseFloat(e),o=parseFloat(o),t=parseFloat(t),a.volume(e,r);for(var u=a._getSoundIds(r),i=0;i<u.length;i++){var d=a._soundById(u[i]);if(d){if(r||a._stopFade(u[i]),a._webAudio&&!d._muted){var _=n.ctx.currentTime,s=_+t/1e3;d._volume=e,d._node.gain.setValueAtTime(e,_),d._node.gain.linearRampToValueAtTime(o,s)}a._startFadeInterval(d,e,o,t,u[i],void 0===r)}}return a},_startFadeInterval:function(e,n,o,t,r,a){var u=this,i=n,d=o-n,_=Math.abs(d/.01),s=Math.max(4,_>0?t/_:t),l=Date.now();e._fadeTo=o,e._interval=setInterval(function(){var r=(Date.now()-l)/t;l=Date.now(),i+=d*r,i=Math.max(0,i),i=Math.min(1,i),i=Math.round(100*i)/100,u._webAudio?e._volume=i:u.volume(i,e._id,!0),a&&(u._volume=i),(o<n&&i<=o||o>n&&i>=o)&&(clearInterval(e._interval),e._interval=null,e._fadeTo=null,u.volume(o,e._id),u._emit("fade",e._id))},s)},_stopFade:function(e){var o=this,t=o._soundById(e);return t&&t._interval&&(o._webAudio&&t._node.gain.cancelScheduledValues(n.ctx.currentTime),clearInterval(t._interval),t._interval=null,o.volume(t._fadeTo,e),t._fadeTo=null,o._emit("fade",e)),o},loop:function(){var e,n,o,t=this,r=arguments;if(0===r.length)return t._loop;if(1===r.length){if("boolean"!=typeof r[0])return!!(o=t._soundById(parseInt(r[0],10)))&&o._loop;e=r[0],t._loop=e}else 2===r.length&&(e=r[0],n=parseInt(r[1],10));for(var a=t._getSoundIds(n),u=0;u<a.length;u++)(o=t._soundById(a[u]))&&(o._loop=e,t._webAudio&&o._node&&o._node.bufferSource&&(o._node.bufferSource.loop=e,e&&(o._node.bufferSource.loopStart=o._start||0,o._node.bufferSource.loopEnd=o._stop)));return t},rate:function(){var e,o,t=this,r=arguments;if(0===r.length)o=t._sounds[0]._id;else if(1===r.length){var a=t._getSoundIds(),u=a.indexOf(r[0]);u>=0?o=parseInt(r[0],10):e=parseFloat(r[0])}else 2===r.length&&(e=parseFloat(r[0]),o=parseInt(r[1],10));var i;if("number"!=typeof e)return i=t._soundById(o),i?i._rate:t._rate;if("loaded"!==t._state||t._playLock)return t._queue.push({event:"rate",action:function(){t.rate.apply(t,r)}}),t;void 0===o&&(t._rate=e),o=t._getSoundIds(o);for(var d=0;d<o.length;d++)if(i=t._soundById(o[d])){t.playing(o[d])&&(i._rateSeek=t.seek(o[d]),i._playStart=t._webAudio?n.ctx.currentTime:i._playStart),i._rate=e,t._webAudio&&i._node&&i._node.bufferSource?i._node.bufferSource.playbackRate.setValueAtTime(e,n.ctx.currentTime):i._node&&(i._node.playbackRate=e);var _=t.seek(o[d]),s=(t._sprite[i._sprite][0]+t._sprite[i._sprite][1])/1e3-_,l=1e3*s/Math.abs(i._rate);!t._endTimers[o[d]]&&i._paused||(t._clearTimer(o[d]),t._endTimers[o[d]]=setTimeout(t._ended.bind(t,i),l)),t._emit("rate",i._id)}return t},seek:function(){var e,o,t=this,r=arguments;if(0===r.length)o=t._sounds[0]._id;else if(1===r.length){var a=t._getSoundIds(),u=a.indexOf(r[0]);u>=0?o=parseInt(r[0],10):t._sounds.length&&(o=t._sounds[0]._id,e=parseFloat(r[0]))}else 2===r.length&&(e=parseFloat(r[0]),o=parseInt(r[1],10));if(void 0===o)return t;if("loaded"!==t._state||t._playLock)return t._queue.push({event:"seek",action:function(){t.seek.apply(t,r)}}),t;var i=t._soundById(o);if(i){if(!("number"==typeof e&&e>=0)){if(t._webAudio){var d=t.playing(o)?n.ctx.currentTime-i._playStart:0,_=i._rateSeek?i._rateSeek-i._seek:0;return i._seek+(_+d*Math.abs(i._rate))}return i._node.currentTime}var s=t.playing(o);s&&t.pause(o,!0),i._seek=e,i._ended=!1,t._clearTimer(o),t._webAudio||!i._node||isNaN(i._node.duration)||(i._node.currentTime=e);var l=function(){t._emit("seek",o),s&&t.play(o,!0)};if(s&&!t._webAudio){var c=function(){t._playLock?setTimeout(c,0):l()};setTimeout(c,0)}else l()}return t},playing:function(e){var n=this;if("number"==typeof e){var o=n._soundById(e);return!!o&&!o._paused}for(var t=0;t<n._sounds.length;t++)if(!n._sounds[t]._paused)return!0;return!1},duration:function(e){var n=this,o=n._duration,t=n._soundById(e);return t&&(o=n._sprite[t._sprite][1]/1e3),o},state:function(){return this._state},unload:function(){for(var e=this,o=e._sounds,t=0;t<o.length;t++)o[t]._paused||e.stop(o[t]._id),e._webAudio||(e._clearSound(o[t]._node),o[t]._node.removeEventListener("error",o[t]._errorFn,!1),o[t]._node.removeEventListener(n._canPlayEvent,o[t]._loadFn,!1),n._releaseHtml5Audio(o[t]._node)),delete o[t]._node,e._clearTimer(o[t]._id);var a=n._howls.indexOf(e);a>=0&&n._howls.splice(a,1);var u=!0;for(t=0;t<n._howls.length;t++)if(n._howls[t]._src===e._src||e._src.indexOf(n._howls[t]._src)>=0){u=!1;break}return r&&u&&delete r[e._src],n.noAudio=!1,e._state="unloaded",e._sounds=[],e=null,null},on:function(e,n,o,t){var r=this,a=r["_on"+e];return"function"==typeof n&&a.push(t?{id:o,fn:n,once:t}:{id:o,fn:n}),r},off:function(e,n,o){var t=this,r=t["_on"+e],a=0;if("number"==typeof n&&(o=n,n=null),n||o)for(a=0;a<r.length;a++){var u=o===r[a].id;if(n===r[a].fn&&u||!n&&u){r.splice(a,1);break}}else if(e)t["_on"+e]=[];else{var i=Object.keys(t);for(a=0;a<i.length;a++)0===i[a].indexOf("_on")&&Array.isArray(t[i[a]])&&(t[i[a]]=[])}return t},once:function(e,n,o){var t=this;return t.on(e,n,o,1),t},_emit:function(e,n,o){for(var t=this,r=t["_on"+e],a=r.length-1;a>=0;a--)r[a].id&&r[a].id!==n&&"load"!==e||(setTimeout(function(e){e.call(this,n,o)}.bind(t,r[a].fn),0),r[a].once&&t.off(e,r[a].fn,r[a].id));return t._loadQueue(e),t},_loadQueue:function(e){var n=this;if(n._queue.length>0){var o=n._queue[0];o.event===e&&(n._queue.shift(),n._loadQueue()),e||o.action()}return n},_ended:function(e){var o=this,t=e._sprite;if(!o._webAudio&&e._node&&!e._node.paused&&!e._node.ended&&e._node.currentTime<e._stop)return setTimeout(o._ended.bind(o,e),100),o;var r=!(!e._loop&&!o._sprite[t][2]);if(o._emit("end",e._id),!o._webAudio&&r&&o.stop(e._id,!0).play(e._id),o._webAudio&&r){o._emit("play",e._id),e._seek=e._start||0,e._rateSeek=0,e._playStart=n.ctx.currentTime;var a=1e3*(e._stop-e._start)/Math.abs(e._rate);o._endTimers[e._id]=setTimeout(o._ended.bind(o,e),a)}return o._webAudio&&!r&&(e._paused=!0,e._ended=!0,e._seek=e._start||0,e._rateSeek=0,o._clearTimer(e._id),o._cleanBuffer(e._node),n._autoSuspend()),o._webAudio||r||o.stop(e._id,!0),o},_clearTimer:function(e){var n=this;if(n._endTimers[e]){if("function"!=typeof n._endTimers[e])clearTimeout(n._endTimers[e]);else{var o=n._soundById(e);o&&o._node&&o._node.removeEventListener("ended",n._endTimers[e],!1)}delete n._endTimers[e]}return n},_soundById:function(e){for(var n=this,o=0;o<n._sounds.length;o++)if(e===n._sounds[o]._id)return n._sounds[o];return null},_inactiveSound:function(){var e=this;e._drain();for(var n=0;n<e._sounds.length;n++)if(e._sounds[n]._ended)return e._sounds[n].reset();return new t(e)},_drain:function(){var e=this,n=e._pool,o=0,t=0;if(!(e._sounds.length<n)){for(t=0;t<e._sounds.length;t++)e._sounds[t]._ended&&o++;for(t=e._sounds.length-1;t>=0;t--){if(o<=n)return;e._sounds[t]._ended&&(e._webAudio&&e._sounds[t]._node&&e._sounds[t]._node.disconnect(0),e._sounds.splice(t,1),o--)}}},_getSoundIds:function(e){var n=this;if(void 0===e){for(var o=[],t=0;t<n._sounds.length;t++)o.push(n._sounds[t]._id);return o}return[e]},_refreshBuffer:function(e){var o=this;return e._node.bufferSource=n.ctx.createBufferSource(),e._node.bufferSource.buffer=r[o._src],e._panner?e._node.bufferSource.connect(e._panner):e._node.bufferSource.connect(e._node),e._node.bufferSource.loop=e._loop,e._loop&&(e._node.bufferSource.loopStart=e._start||0,e._node.bufferSource.loopEnd=e._stop||0),e._node.bufferSource.playbackRate.setValueAtTime(e._rate,n.ctx.currentTime),o},_cleanBuffer:function(e){var o=this,t=n._navigator&&n._navigator.vendor.indexOf("Apple")>=0;if(n._scratchBuffer&&e.bufferSource&&(e.bufferSource.onended=null,e.bufferSource.disconnect(0),t))try{e.bufferSource.buffer=n._scratchBuffer}catch(e){}return e.bufferSource=null,o},_clearSound:function(e){/MSIE |Trident\//.test(n._navigator&&n._navigator.userAgent)||(e.src="data:audio/wav;base64,UklGRigAAABXQVZFZm10IBIAAAABAAEARKwAAIhYAQACABAAAABkYXRhAgAAAAEA")}};var t=function(e){this._parent=e,this.init()};t.prototype={init:function(){var e=this,o=e._parent;return e._muted=o._muted,e._loop=o._loop,e._volume=o._volume,e._rate=o._rate,e._seek=0,e._paused=!0,e._ended=!0,e._sprite="__default",e._id=++n._counter,o._sounds.push(e),e.create(),e},create:function(){var e=this,o=e._parent,t=n._muted||e._muted||e._parent._muted?0:e._volume;return o._webAudio?(e._node=void 0===n.ctx.createGain?n.ctx.createGainNode():n.ctx.createGain(),e._node.gain.setValueAtTime(t,n.ctx.currentTime),e._node.paused=!0,e._node.connect(n.masterGain)):n.noAudio||(e._node=n._obtainHtml5Audio(),e._errorFn=e._errorListener.bind(e),e._node.addEventListener("error",e._errorFn,!1),e._loadFn=e._loadListener.bind(e),e._node.addEventListener(n._canPlayEvent,e._loadFn,!1),e._node.src=o._src,e._node.preload="auto",e._node.volume=t*n.volume(),e._node.load()),e},reset:function(){var e=this,o=e._parent;return e._muted=o._muted,e._loop=o._loop,e._volume=o._volume,e._rate=o._rate,e._seek=0,e._rateSeek=0,e._paused=!0,e._ended=!0,e._sprite="__default",e._id=++n._counter,e},_errorListener:function(){var e=this;e._parent._emit("loaderror",e._id,e._node.error?e._node.error.code:0),e._node.removeEventListener("error",e._errorFn,!1)},_loadListener:function(){var e=this,o=e._parent;o._duration=Math.ceil(10*e._node.duration)/10,0===Object.keys(o._sprite).length&&(o._sprite={__default:[0,1e3*o._duration]}),"loaded"!==o._state&&(o._state="loaded",o._emit("load"),o._loadQueue()),e._node.removeEventListener(n._canPlayEvent,e._loadFn,!1)}};var r={},a=function(e){var n=e._src;if(r[n])return e._duration=r[n].duration,void d(e);if(/^data:[^;]+;base64,/.test(n)){for(var o=atob(n.split(",")[1]),t=new Uint8Array(o.length),a=0;a<o.length;++a)t[a]=o.charCodeAt(a);i(t.buffer,e)}else{var _=new XMLHttpRequest;_.open("GET",n,!0),_.withCredentials=e._xhrWithCredentials,_.responseType="arraybuffer",_.onload=function(){var n=(_.status+"")[0];if("0"!==n&&"2"!==n&&"3"!==n)return void e._emit("loaderror",null,"Failed loading audio file with status: "+_.status+".");i(_.response,e)},_.onerror=function(){e._webAudio&&(e._html5=!0,e._webAudio=!1,e._sounds=[],delete r[n],e.load())},u(_)}},u=function(e){try{e.send()}catch(n){e.onerror()}},i=function(e,o){var t=function(){o._emit("loaderror",null,"Decoding audio data failed.")},a=function(e){e&&o._sounds.length>0?(r[o._src]=e,d(o,e)):t()};"undefined"!=typeof Promise&&1===n.ctx.decodeAudioData.length?n.ctx.decodeAudioData(e).then(a).catch(t):n.ctx.decodeAudioData(e,a,t)},d=function(e,n){n&&!e._duration&&(e._duration=n.duration),0===Object.keys(e._sprite).length&&(e._sprite={__default:[0,1e3*e._duration]}),"loaded"!==e._state&&(e._state="loaded",e._emit("load"),e._loadQueue())},_=function(){if(n.usingWebAudio){try{"undefined"!=typeof AudioContext?n.ctx=new AudioContext:"undefined"!=typeof webkitAudioContext?n.ctx=new webkitAudioContext:n.usingWebAudio=!1}catch(e){n.usingWebAudio=!1}n.ctx||(n.usingWebAudio=!1);var e=/iP(hone|od|ad)/.test(n._navigator&&n._navigator.platform),o=n._navigator&&n._navigator.appVersion.match(/OS (\d+)_(\d+)_?(\d+)?/),t=o?parseInt(o[1],10):null;if(e&&t&&t<9){var r=/safari/.test(n._navigator&&n._navigator.userAgent.toLowerCase());(n._navigator&&n._navigator.standalone&&!r||n._navigator&&!n._navigator.standalone&&!r)&&(n.usingWebAudio=!1)}n.usingWebAudio&&(n.masterGain=void 0===n.ctx.createGain?n.ctx.createGainNode():n.ctx.createGain(),n.masterGain.gain.setValueAtTime(n._muted?0:n._volume,n.ctx.currentTime),n.masterGain.connect(n.ctx.destination)),n._setup()}};"function"==typeof define&&define.amd&&define([],function(){return{Howler:n,Howl:o}}),"undefined"!=typeof exports&&(exports.Howler=n,exports.Howl=o),"undefined"!=typeof window?(window.HowlerGlobal=e,window.Howler=n,window.Howl=o,window.Sound=t):"undefined"!=typeof global&&(global.HowlerGlobal=e,global.Howler=n,global.Howl=o,global.Sound=t)}();
/*! Spatial Plugin */
!function(){"use strict";HowlerGlobal.prototype._pos=[0,0,0],HowlerGlobal.prototype._orientation=[0,0,-1,0,1,0],HowlerGlobal.prototype.stereo=function(e){var n=this;if(!n.ctx||!n.ctx.listener)return n;for(var t=n._howls.length-1;t>=0;t--)n._howls[t].stereo(e);return n},HowlerGlobal.prototype.pos=function(e,n,t){var r=this;return r.ctx&&r.ctx.listener?(n="number"!=typeof n?r._pos[1]:n,t="number"!=typeof t?r._pos[2]:t,"number"!=typeof e?r._pos:(r._pos=[e,n,t],void 0!==r.ctx.listener.positionX?(r.ctx.listener.positionX.setTargetAtTime(r._pos[0],Howler.ctx.currentTime,.1),r.ctx.listener.positionY.setTargetAtTime(r._pos[1],Howler.ctx.currentTime,.1),r.ctx.listener.positionZ.setTargetAtTime(r._pos[2],Howler.ctx.currentTime,.1)):r.ctx.listener.setPosition(r._pos[0],r._pos[1],r._pos[2]),r)):r},HowlerGlobal.prototype.orientation=function(e,n,t,r,o,i){var a=this;if(!a.ctx||!a.ctx.listener)return a;var s=a._orientation;return n="number"!=typeof n?s[1]:n,t="number"!=typeof t?s[2]:t,r="number"!=typeof r?s[3]:r,o="number"!=typeof o?s[4]:o,i="number"!=typeof i?s[5]:i,"number"!=typeof e?s:(a._orientation=[e,n,t,r,o,i],void 0!==a.ctx.listener.forwardX?(a.ctx.listener.forwardX.setTargetAtTime(e,Howler.ctx.currentTime,.1),a.ctx.listener.forwardY.setTargetAtTime(n,Howler.ctx.currentTime,.1),a.ctx.listener.forwardZ.setTargetAtTime(t,Howler.ctx.currentTime,.1),a.ctx.listener.upX.setTargetAtTime(r,Howler.ctx.currentTime,.1),a.ctx.listener.upY.setTargetAtTime(o,Howler.ctx.currentTime,.1),a.ctx.listener.upZ.setTargetAtTime(i,Howler.ctx.currentTime,.1)):a.ctx.listener.setOrientation(e,n,t,r,o,i),a)},Howl.prototype.init=function(e){return function(n){var t=this;return t._orientation=n.orientation||[1,0,0],t._stereo=n.stereo||null,t._pos=n.pos||null,t._pannerAttr={coneInnerAngle:void 0!==n.coneInnerAngle?n.coneInnerAngle:360,coneOuterAngle:void 0!==n.coneOuterAngle?n.coneOuterAngle:360,coneOuterGain:void 0!==n.coneOuterGain?n.coneOuterGain:0,distanceModel:void 0!==n.distanceModel?n.distanceModel:"inverse",maxDistance:void 0!==n.maxDistance?n.maxDistance:1e4,panningModel:void 0!==n.panningModel?n.panningModel:"HRTF",refDistance:void 0!==n.refDistance?n.refDistance:1,rolloffFactor:void 0!==n.rolloffFactor?n.rolloffFactor:1},t._onstereo=n.onstereo?[{fn:n.onstereo}]:[],t._onpos=n.onpos?[{fn:n.onpos}]:[],t._onorientation=n.onorientation?[{fn:n.onorientation}]:[],e.call(this,n)}}(Howl.prototype.init),Howl.prototype.stereo=function(n,t){var r=this;if(!r._webAudio)return r;if("loaded"!==r._state)return r._queue.push({event:"stereo",action:function(){r.stereo(n,t)}}),r;var o=void 0===Howler.ctx.createStereoPanner?"spatial":"stereo";if(void 0===t){if("number"!=typeof n)return r._stereo;r._stereo=n,r._pos=[n,0,0]}for(var i=r._getSoundIds(t),a=0;a<i.length;a++){var s=r._soundById(i[a]);if(s){if("number"!=typeof n)return s._stereo;s._stereo=n,s._pos=[n,0,0],s._node&&(s._pannerAttr.panningModel="equalpower",s._panner&&s._panner.pan||e(s,o),"spatial"===o?void 0!==s._panner.positionX?(s._panner.positionX.setValueAtTime(n,Howler.ctx.currentTime),s._panner.positionY.setValueAtTime(0,Howler.ctx.currentTime),s._panner.positionZ.setValueAtTime(0,Howler.ctx.currentTime)):s._panner.setPosition(n,0,0):s._panner.pan.setValueAtTime(n,Howler.ctx.currentTime)),r._emit("stereo",s._id)}}return r},Howl.prototype.pos=function(n,t,r,o){var i=this;if(!i._webAudio)return i;if("loaded"!==i._state)return i._queue.push({event:"pos",action:function(){i.pos(n,t,r,o)}}),i;if(t="number"!=typeof t?0:t,r="number"!=typeof r?-.5:r,void 0===o){if("number"!=typeof n)return i._pos;i._pos=[n,t,r]}for(var a=i._getSoundIds(o),s=0;s<a.length;s++){var p=i._soundById(a[s]);if(p){if("number"!=typeof n)return p._pos;p._pos=[n,t,r],p._node&&(p._panner&&!p._panner.pan||e(p,"spatial"),void 0!==p._panner.positionX?(p._panner.positionX.setValueAtTime(n,Howler.ctx.currentTime),p._panner.positionY.setValueAtTime(t,Howler.ctx.currentTime),p._panner.positionZ.setValueAtTime(r,Howler.ctx.currentTime)):p._panner.setPosition(n,t,r)),i._emit("pos",p._id)}}return i},Howl.prototype.orientation=function(n,t,r,o){var i=this;if(!i._webAudio)return i;if("loaded"!==i._state)return i._queue.push({event:"orientation",action:function(){i.orientation(n,t,r,o)}}),i;if(t="number"!=typeof t?i._orientation[1]:t,r="number"!=typeof r?i._orientation[2]:r,void 0===o){if("number"!=typeof n)return i._orientation;i._orientation=[n,t,r]}for(var a=i._getSoundIds(o),s=0;s<a.length;s++){var p=i._soundById(a[s]);if(p){if("number"!=typeof n)return p._orientation;p._orientation=[n,t,r],p._node&&(p._panner||(p._pos||(p._pos=i._pos||[0,0,-.5]),e(p,"spatial")),void 0!==p._panner.orientationX?(p._panner.orientationX.setValueAtTime(n,Howler.ctx.currentTime),p._panner.orientationY.setValueAtTime(t,Howler.ctx.currentTime),p._panner.orientationZ.setValueAtTime(r,Howler.ctx.currentTime)):p._panner.setOrientation(n,t,r)),i._emit("orientation",p._id)}}return i},Howl.prototype.pannerAttr=function(){var n,t,r,o=this,i=arguments;if(!o._webAudio)return o;if(0===i.length)return o._pannerAttr;if(1===i.length){if("object"!=typeof i[0])return r=o._soundById(parseInt(i[0],10)),r?r._pannerAttr:o._pannerAttr;n=i[0],void 0===t&&(n.pannerAttr||(n.pannerAttr={coneInnerAngle:n.coneInnerAngle,coneOuterAngle:n.coneOuterAngle,coneOuterGain:n.coneOuterGain,distanceModel:n.distanceModel,maxDistance:n.maxDistance,refDistance:n.refDistance,rolloffFactor:n.rolloffFactor,panningModel:n.panningModel}),o._pannerAttr={coneInnerAngle:void 0!==n.pannerAttr.coneInnerAngle?n.pannerAttr.coneInnerAngle:o._coneInnerAngle,coneOuterAngle:void 0!==n.pannerAttr.coneOuterAngle?n.pannerAttr.coneOuterAngle:o._coneOuterAngle,coneOuterGain:void 0!==n.pannerAttr.coneOuterGain?n.pannerAttr.coneOuterGain:o._coneOuterGain,distanceModel:void 0!==n.pannerAttr.distanceModel?n.pannerAttr.distanceModel:o._distanceModel,maxDistance:void 0!==n.pannerAttr.maxDistance?n.pannerAttr.maxDistance:o._maxDistance,refDistance:void 0!==n.pannerAttr.refDistance?n.pannerAttr.refDistance:o._refDistance,rolloffFactor:void 0!==n.pannerAttr.rolloffFactor?n.pannerAttr.rolloffFactor:o._rolloffFactor,panningModel:void 0!==n.pannerAttr.panningModel?n.pannerAttr.panningModel:o._panningModel})}else 2===i.length&&(n=i[0],t=parseInt(i[1],10));for(var a=o._getSoundIds(t),s=0;s<a.length;s++)if(r=o._soundById(a[s])){var p=r._pannerAttr;p={coneInnerAngle:void 0!==n.coneInnerAngle?n.coneInnerAngle:p.coneInnerAngle,coneOuterAngle:void 0!==n.coneOuterAngle?n.coneOuterAngle:p.coneOuterAngle,coneOuterGain:void 0!==n.coneOuterGain?n.coneOuterGain:p.coneOuterGain,distanceModel:void 0!==n.distanceModel?n.distanceModel:p.distanceModel,maxDistance:void 0!==n.maxDistance?n.maxDistance:p.maxDistance,refDistance:void 0!==n.refDistance?n.refDistance:p.refDistance,rolloffFactor:void 0!==n.rolloffFactor?n.rolloffFactor:p.rolloffFactor,panningModel:void 0!==n.panningModel?n.panningModel:p.panningModel};var c=r._panner;c?(c.coneInnerAngle=p.coneInnerAngle,c.coneOuterAngle=p.coneOuterAngle,c.coneOuterGain=p.coneOuterGain,c.distanceModel=p.distanceModel,c.maxDistance=p.maxDistance,c.refDistance=p.refDistance,c.rolloffFactor=p.rolloffFactor,c.panningModel=p.panningModel):(r._pos||(r._pos=o._pos||[0,0,-.5]),e(r,"spatial"))}return o},Sound.prototype.init=function(e){return function(){var n=this,t=n._parent;n._orientation=t._orientation,n._stereo=t._stereo,n._pos=t._pos,n._pannerAttr=t._pannerAttr,e.call(this),n._stereo?t.stereo(n._stereo):n._pos&&t.pos(n._pos[0],n._pos[1],n._pos[2],n._id)}}(Sound.prototype.init),Sound.prototype.reset=function(e){return function(){var n=this,t=n._parent;return n._orientation=t._orientation,n._stereo=t._stereo,n._pos=t._pos,n._pannerAttr=t._pannerAttr,n._stereo?t.stereo(n._stereo):n._pos?t.pos(n._pos[0],n._pos[1],n._pos[2],n._id):n._panner&&(n._panner.disconnect(0),n._panner=void 0,t._refreshBuffer(n)),e.call(this)}}(Sound.prototype.reset);var e=function(e,n){n=n||"spatial","spatial"===n?(e._panner=Howler.ctx.createPanner(),e._panner.coneInnerAngle=e._pannerAttr.coneInnerAngle,e._panner.coneOuterAngle=e._pannerAttr.coneOuterAngle,e._panner.coneOuterGain=e._pannerAttr.coneOuterGain,e._panner.distanceModel=e._pannerAttr.distanceModel,e._panner.maxDistance=e._pannerAttr.maxDistance,e._panner.refDistance=e._pannerAttr.refDistance,e._panner.rolloffFactor=e._pannerAttr.rolloffFactor,e._panner.panningModel=e._pannerAttr.panningModel,void 0!==e._panner.positionX?(e._panner.positionX.setValueAtTime(e._pos[0],Howler.ctx.currentTime),e._panner.positionY.setValueAtTime(e._pos[1],Howler.ctx.currentTime),e._panner.positionZ.setValueAtTime(e._pos[2],Howler.ctx.currentTime)):e._panner.setPosition(e._pos[0],e._pos[1],e._pos[2]),void 0!==e._panner.orientationX?(e._panner.orientationX.setValueAtTime(e._orientation[0],Howler.ctx.currentTime),e._panner.orientationY.setValueAtTime(e._orientation[1],Howler.ctx.currentTime),e._panner.orientationZ.setValueAtTime(e._orientation[2],Howler.ctx.currentTime)):e._panner.setOrientation(e._orientation[0],e._orientation[1],e._orientation[2])):(e._panner=Howler.ctx.createStereoPanner(),e._panner.pan.setValueAtTime(e._stereo,Howler.ctx.currentTime)),e._panner.connect(e._node),e._paused||e._parent.pause(e._id,!0).play(e._id,!0)}}();

/*! howler.js v2.1.3 | Spatial Plugin | (c) 2013-2019, James Simpson of GoldFire Studios | MIT License | howlerjs.com */
!function(){"use strict";HowlerGlobal.prototype._pos=[0,0,0],HowlerGlobal.prototype._orientation=[0,0,-1,0,1,0],HowlerGlobal.prototype.stereo=function(e){var n=this;if(!n.ctx||!n.ctx.listener)return n;for(var t=n._howls.length-1;t>=0;t--)n._howls[t].stereo(e);return n},HowlerGlobal.prototype.pos=function(e,n,t){var r=this;return r.ctx&&r.ctx.listener?(n="number"!=typeof n?r._pos[1]:n,t="number"!=typeof t?r._pos[2]:t,"number"!=typeof e?r._pos:(r._pos=[e,n,t],void 0!==r.ctx.listener.positionX?(r.ctx.listener.positionX.setTargetAtTime(r._pos[0],Howler.ctx.currentTime,.1),r.ctx.listener.positionY.setTargetAtTime(r._pos[1],Howler.ctx.currentTime,.1),r.ctx.listener.positionZ.setTargetAtTime(r._pos[2],Howler.ctx.currentTime,.1)):r.ctx.listener.setPosition(r._pos[0],r._pos[1],r._pos[2]),r)):r},HowlerGlobal.prototype.orientation=function(e,n,t,r,o,i){var a=this;if(!a.ctx||!a.ctx.listener)return a;var s=a._orientation;return n="number"!=typeof n?s[1]:n,t="number"!=typeof t?s[2]:t,r="number"!=typeof r?s[3]:r,o="number"!=typeof o?s[4]:o,i="number"!=typeof i?s[5]:i,"number"!=typeof e?s:(a._orientation=[e,n,t,r,o,i],void 0!==a.ctx.listener.forwardX?(a.ctx.listener.forwardX.setTargetAtTime(e,Howler.ctx.currentTime,.1),a.ctx.listener.forwardY.setTargetAtTime(n,Howler.ctx.currentTime,.1),a.ctx.listener.forwardZ.setTargetAtTime(t,Howler.ctx.currentTime,.1),a.ctx.listener.upX.setTargetAtTime(r,Howler.ctx.currentTime,.1),a.ctx.listener.upY.setTargetAtTime(o,Howler.ctx.currentTime,.1),a.ctx.listener.upZ.setTargetAtTime(i,Howler.ctx.currentTime,.1)):a.ctx.listener.setOrientation(e,n,t,r,o,i),a)},Howl.prototype.init=function(e){return function(n){var t=this;return t._orientation=n.orientation||[1,0,0],t._stereo=n.stereo||null,t._pos=n.pos||null,t._pannerAttr={coneInnerAngle:void 0!==n.coneInnerAngle?n.coneInnerAngle:360,coneOuterAngle:void 0!==n.coneOuterAngle?n.coneOuterAngle:360,coneOuterGain:void 0!==n.coneOuterGain?n.coneOuterGain:0,distanceModel:void 0!==n.distanceModel?n.distanceModel:"inverse",maxDistance:void 0!==n.maxDistance?n.maxDistance:1e4,panningModel:void 0!==n.panningModel?n.panningModel:"HRTF",refDistance:void 0!==n.refDistance?n.refDistance:1,rolloffFactor:void 0!==n.rolloffFactor?n.rolloffFactor:1},t._onstereo=n.onstereo?[{fn:n.onstereo}]:[],t._onpos=n.onpos?[{fn:n.onpos}]:[],t._onorientation=n.onorientation?[{fn:n.onorientation}]:[],e.call(this,n)}}(Howl.prototype.init),Howl.prototype.stereo=function(n,t){var r=this;if(!r._webAudio)return r;if("loaded"!==r._state)return r._queue.push({event:"stereo",action:function(){r.stereo(n,t)}}),r;var o=void 0===Howler.ctx.createStereoPanner?"spatial":"stereo";if(void 0===t){if("number"!=typeof n)return r._stereo;r._stereo=n,r._pos=[n,0,0]}for(var i=r._getSoundIds(t),a=0;a<i.length;a++){var s=r._soundById(i[a]);if(s){if("number"!=typeof n)return s._stereo;s._stereo=n,s._pos=[n,0,0],s._node&&(s._pannerAttr.panningModel="equalpower",s._panner&&s._panner.pan||e(s,o),"spatial"===o?void 0!==s._panner.positionX?(s._panner.positionX.setValueAtTime(n,Howler.ctx.currentTime),s._panner.positionY.setValueAtTime(0,Howler.ctx.currentTime),s._panner.positionZ.setValueAtTime(0,Howler.ctx.currentTime)):s._panner.setPosition(n,0,0):s._panner.pan.setValueAtTime(n,Howler.ctx.currentTime)),r._emit("stereo",s._id)}}return r},Howl.prototype.pos=function(n,t,r,o){var i=this;if(!i._webAudio)return i;if("loaded"!==i._state)return i._queue.push({event:"pos",action:function(){i.pos(n,t,r,o)}}),i;if(t="number"!=typeof t?0:t,r="number"!=typeof r?-.5:r,void 0===o){if("number"!=typeof n)return i._pos;i._pos=[n,t,r]}for(var a=i._getSoundIds(o),s=0;s<a.length;s++){var p=i._soundById(a[s]);if(p){if("number"!=typeof n)return p._pos;p._pos=[n,t,r],p._node&&(p._panner&&!p._panner.pan||e(p,"spatial"),void 0!==p._panner.positionX?(p._panner.positionX.setValueAtTime(n,Howler.ctx.currentTime),p._panner.positionY.setValueAtTime(t,Howler.ctx.currentTime),p._panner.positionZ.setValueAtTime(r,Howler.ctx.currentTime)):p._panner.setPosition(n,t,r)),i._emit("pos",p._id)}}return i},Howl.prototype.orientation=function(n,t,r,o){var i=this;if(!i._webAudio)return i;if("loaded"!==i._state)return i._queue.push({event:"orientation",action:function(){i.orientation(n,t,r,o)}}),i;if(t="number"!=typeof t?i._orientation[1]:t,r="number"!=typeof r?i._orientation[2]:r,void 0===o){if("number"!=typeof n)return i._orientation;i._orientation=[n,t,r]}for(var a=i._getSoundIds(o),s=0;s<a.length;s++){var p=i._soundById(a[s]);if(p){if("number"!=typeof n)return p._orientation;p._orientation=[n,t,r],p._node&&(p._panner||(p._pos||(p._pos=i._pos||[0,0,-.5]),e(p,"spatial")),void 0!==p._panner.orientationX?(p._panner.orientationX.setValueAtTime(n,Howler.ctx.currentTime),p._panner.orientationY.setValueAtTime(t,Howler.ctx.currentTime),p._panner.orientationZ.setValueAtTime(r,Howler.ctx.currentTime)):p._panner.setOrientation(n,t,r)),i._emit("orientation",p._id)}}return i},Howl.prototype.pannerAttr=function(){var n,t,r,o=this,i=arguments;if(!o._webAudio)return o;if(0===i.length)return o._pannerAttr;if(1===i.length){if("object"!=typeof i[0])return r=o._soundById(parseInt(i[0],10)),r?r._pannerAttr:o._pannerAttr;n=i[0],void 0===t&&(n.pannerAttr||(n.pannerAttr={coneInnerAngle:n.coneInnerAngle,coneOuterAngle:n.coneOuterAngle,coneOuterGain:n.coneOuterGain,distanceModel:n.distanceModel,maxDistance:n.maxDistance,refDistance:n.refDistance,rolloffFactor:n.rolloffFactor,panningModel:n.panningModel}),o._pannerAttr={coneInnerAngle:void 0!==n.pannerAttr.coneInnerAngle?n.pannerAttr.coneInnerAngle:o._coneInnerAngle,coneOuterAngle:void 0!==n.pannerAttr.coneOuterAngle?n.pannerAttr.coneOuterAngle:o._coneOuterAngle,coneOuterGain:void 0!==n.pannerAttr.coneOuterGain?n.pannerAttr.coneOuterGain:o._coneOuterGain,distanceModel:void 0!==n.pannerAttr.distanceModel?n.pannerAttr.distanceModel:o._distanceModel,maxDistance:void 0!==n.pannerAttr.maxDistance?n.pannerAttr.maxDistance:o._maxDistance,refDistance:void 0!==n.pannerAttr.refDistance?n.pannerAttr.refDistance:o._refDistance,rolloffFactor:void 0!==n.pannerAttr.rolloffFactor?n.pannerAttr.rolloffFactor:o._rolloffFactor,panningModel:void 0!==n.pannerAttr.panningModel?n.pannerAttr.panningModel:o._panningModel})}else 2===i.length&&(n=i[0],t=parseInt(i[1],10));for(var a=o._getSoundIds(t),s=0;s<a.length;s++)if(r=o._soundById(a[s])){var p=r._pannerAttr;p={coneInnerAngle:void 0!==n.coneInnerAngle?n.coneInnerAngle:p.coneInnerAngle,coneOuterAngle:void 0!==n.coneOuterAngle?n.coneOuterAngle:p.coneOuterAngle,coneOuterGain:void 0!==n.coneOuterGain?n.coneOuterGain:p.coneOuterGain,distanceModel:void 0!==n.distanceModel?n.distanceModel:p.distanceModel,maxDistance:void 0!==n.maxDistance?n.maxDistance:p.maxDistance,refDistance:void 0!==n.refDistance?n.refDistance:p.refDistance,rolloffFactor:void 0!==n.rolloffFactor?n.rolloffFactor:p.rolloffFactor,panningModel:void 0!==n.panningModel?n.panningModel:p.panningModel};var c=r._panner;c?(c.coneInnerAngle=p.coneInnerAngle,c.coneOuterAngle=p.coneOuterAngle,c.coneOuterGain=p.coneOuterGain,c.distanceModel=p.distanceModel,c.maxDistance=p.maxDistance,c.refDistance=p.refDistance,c.rolloffFactor=p.rolloffFactor,c.panningModel=p.panningModel):(r._pos||(r._pos=o._pos||[0,0,-.5]),e(r,"spatial"))}return o},Sound.prototype.init=function(e){return function(){var n=this,t=n._parent;n._orientation=t._orientation,n._stereo=t._stereo,n._pos=t._pos,n._pannerAttr=t._pannerAttr,e.call(this),n._stereo?t.stereo(n._stereo):n._pos&&t.pos(n._pos[0],n._pos[1],n._pos[2],n._id)}}(Sound.prototype.init),Sound.prototype.reset=function(e){return function(){var n=this,t=n._parent;return n._orientation=t._orientation,n._stereo=t._stereo,n._pos=t._pos,n._pannerAttr=t._pannerAttr,n._stereo?t.stereo(n._stereo):n._pos?t.pos(n._pos[0],n._pos[1],n._pos[2],n._id):n._panner&&(n._panner.disconnect(0),n._panner=void 0,t._refreshBuffer(n)),e.call(this)}}(Sound.prototype.reset);var e=function(e,n){n=n||"spatial","spatial"===n?(e._panner=Howler.ctx.createPanner(),e._panner.coneInnerAngle=e._pannerAttr.coneInnerAngle,e._panner.coneOuterAngle=e._pannerAttr.coneOuterAngle,e._panner.coneOuterGain=e._pannerAttr.coneOuterGain,e._panner.distanceModel=e._pannerAttr.distanceModel,e._panner.maxDistance=e._pannerAttr.maxDistance,e._panner.refDistance=e._pannerAttr.refDistance,e._panner.rolloffFactor=e._pannerAttr.rolloffFactor,e._panner.panningModel=e._pannerAttr.panningModel,void 0!==e._panner.positionX?(e._panner.positionX.setValueAtTime(e._pos[0],Howler.ctx.currentTime),e._panner.positionY.setValueAtTime(e._pos[1],Howler.ctx.currentTime),e._panner.positionZ.setValueAtTime(e._pos[2],Howler.ctx.currentTime)):e._panner.setPosition(e._pos[0],e._pos[1],e._pos[2]),void 0!==e._panner.orientationX?(e._panner.orientationX.setValueAtTime(e._orientation[0],Howler.ctx.currentTime),e._panner.orientationY.setValueAtTime(e._orientation[1],Howler.ctx.currentTime),e._panner.orientationZ.setValueAtTime(e._orientation[2],Howler.ctx.currentTime)):e._panner.setOrientation(e._orientation[0],e._orientation[1],e._orientation[2])):(e._panner=Howler.ctx.createStereoPanner(),e._panner.pan.setValueAtTime(e._stereo,Howler.ctx.currentTime)),e._panner.connect(e._node),e._paused||e._parent.pause(e._id,!0).play(e._id,!0)}}();

/**
 * BezierEasing - use bezier curve for transition easing function
 * by Gatan Renaudeau 2014  MIT License
 *
 * Credits: is based on Firefox's nsSMILKeySpline.cpp
 * Usage:
 * var spline = BezierEasing(0.25, 0.1, 0.25, 1.0)
 * spline(x) => returns the easing value | x must be in [0, 1] range
 *
 */
(function (definition) {
  if (typeof exports === "object") {
    module.exports = definition();
  } else if (typeof define === 'function' && define.amd) {
    define([], definition);
  } else {
    window.BezierEasing = definition();
  }
}(function () {
  var global = this;

  // These values are established by empiricism with tests (tradeoff: performance VS precision)
  var NEWTON_ITERATIONS = 4;
  var NEWTON_MIN_SLOPE = 0.001;
  var SUBDIVISION_PRECISION = 0.0000001;
  var SUBDIVISION_MAX_ITERATIONS = 10;

  var kSplineTableSize = 11;
  var kSampleStepSize = 1.0 / (kSplineTableSize - 1.0);

  var float32ArraySupported = 'Float32Array' in global;

  function A (aA1, aA2) { return 1.0 - 3.0 * aA2 + 3.0 * aA1; }
  function B (aA1, aA2) { return 3.0 * aA2 - 6.0 * aA1; }
  function C (aA1)      { return 3.0 * aA1; }

  // Returns x(t) given t, x1, and x2, or y(t) given t, y1, and y2.
  function calcBezier (aT, aA1, aA2) {
    return ((A(aA1, aA2)*aT + B(aA1, aA2))*aT + C(aA1))*aT;
  }

  // Returns dx/dt given t, x1, and x2, or dy/dt given t, y1, and y2.
  function getSlope (aT, aA1, aA2) {
    return 3.0 * A(aA1, aA2)*aT*aT + 2.0 * B(aA1, aA2) * aT + C(aA1);
  }

  function binarySubdivide (aX, aA, aB) {
    var currentX, currentT, i = 0;
    do {
      currentT = aA + (aB - aA) / 2.0;
      currentX = calcBezier(currentT, mX1, mX2) - aX;
      if (currentX > 0.0) {
        aB = currentT;
      } else {
        aA = currentT;
      }
    } while (Math.abs(currentX) > SUBDIVISION_PRECISION && ++i < SUBDIVISION_MAX_ITERATIONS);
    return currentT;
  }

  function BezierEasing (mX1, mY1, mX2, mY2) {
    // Validate arguments
    if (arguments.length !== 4) {
      throw new Error("BezierEasing requires 4 arguments.");
    }
    for (var i=0; i<4; ++i) {
      if (typeof arguments[i] !== "number" || isNaN(arguments[i]) || !isFinite(arguments[i])) {
        throw new Error("BezierEasing arguments should be integers.");
      }
    }
    if (mX1 < 0 || mX1 > 1 || mX2 < 0 || mX2 > 1) {
      throw new Error("BezierEasing x values must be in [0, 1] range.");
    }

    var mSampleValues = float32ArraySupported ? new Float32Array(kSplineTableSize) : new Array(kSplineTableSize);

    function newtonRaphsonIterate (aX, aGuessT) {
      for (var i = 0; i < NEWTON_ITERATIONS; ++i) {
        var currentSlope = getSlope(aGuessT, mX1, mX2);
        if (currentSlope === 0.0) return aGuessT;
        var currentX = calcBezier(aGuessT, mX1, mX2) - aX;
        aGuessT -= currentX / currentSlope;
      }
      return aGuessT;
    }

    function calcSampleValues () {
      for (var i = 0; i < kSplineTableSize; ++i) {
        mSampleValues[i] = calcBezier(i * kSampleStepSize, mX1, mX2);
      }
    }

    function getTForX (aX) {
      var intervalStart = 0.0;
      var currentSample = 1;
      var lastSample = kSplineTableSize - 1;

      for (; currentSample != lastSample && mSampleValues[currentSample] <= aX; ++currentSample) {
        intervalStart += kSampleStepSize;
      }
      --currentSample;

      // Interpolate to provide an initial guess for t
      var dist = (aX - mSampleValues[currentSample]) / (mSampleValues[currentSample+1] - mSampleValues[currentSample]);
      var guessForT = intervalStart + dist * kSampleStepSize;

      var initialSlope = getSlope(guessForT, mX1, mX2);
      if (initialSlope >= NEWTON_MIN_SLOPE) {
        return newtonRaphsonIterate(aX, guessForT);
      } else if (initialSlope === 0.0) {
        return guessForT;
      } else {
        return binarySubdivide(aX, intervalStart, intervalStart + kSampleStepSize);
      }
    }

    var _precomputed = false;
    function precompute() {
      _precomputed = true;
      if (mX1 != mY1 || mX2 != mY2)
        calcSampleValues();
    }

    var f = function (aX) {
      if (!_precomputed) precompute();
      if (mX1 === mY1 && mX2 === mY2) return aX; // linear
      // Because JavaScript number are imprecise, we should guarantee the extremes are right.
      if (aX === 0) return 0;
      if (aX === 1) return 1;
      return calcBezier(getTForX(aX), mY1, mY2);
    };

    f.getControlPoints = function() { return [{ x: mX1, y: mY1 }, { x: mX2, y: mY2 }]; };

    var args = [mX1, mY1, mX2, mY2];
    var str = "BezierEasing("+args+")";
    f.toString = function () { return str; };

    var css = "cubic-bezier("+args+")";
    f.toCSS = function () { return css; };

    return f;
  }

  // CSS mapping
  BezierEasing.css = {
    "ease":        BezierEasing(0.25, 0.1, 0.25, 1.0),
    "linear":      BezierEasing(0.00, 0.0, 1.00, 1.0),
    "ease-in":     BezierEasing(0.42, 0.0, 1.00, 1.0),
    "ease-out":    BezierEasing(0.00, 0.0, 0.58, 1.0),
    "ease-in-out": BezierEasing(0.42, 0.0, 0.58, 1.0)
  };

  return BezierEasing;

}));

function getSetDescendantProp(obj, desc, value) {
  var arr = desc ? desc.split(".") : [];

  while (arr.length && obj) {
    var comp = arr.shift();
    var match = new RegExp("(.+)\\[([0-9]*)\\]").exec(comp);

    // handle arrays
    if ((match !== null) && (match.length == 3)) {
      var arrayData = {
        arrName: match[1],
        arrIndex: match[2]
      };
      if (obj[arrayData.arrName] !== undefined) {
        if (typeof value !== 'undefined' && arr.length === 0) {
          obj[arrayData.arrName][arrayData.arrIndex] = value;
        }
        obj = obj[arrayData.arrName][arrayData.arrIndex];
      } else {
        obj = undefined;
      }

      continue;
    }

    // handle regular things
    if (typeof value !== 'undefined') {
      if (obj[comp] === undefined) {
        obj[comp] = {};
      }

      if (arr.length === 0) {
        obj[comp] = value;
      }
    }

    obj = obj[comp];
  }

  return obj;
}

// Feecof v1.1 - (C) osk 2020-2021
const Feecof = function(options, callback) {
	/*
		Options
			view		The canvas to render to.										Required
			speed		The speed at which to increase pressure.						1
			cutoff		The dT at which to stop.										1.5
			fails		The amount of slow frames allowed.								10
			img			The URL of the image to use.									./kagari.png
			font		The TheoryType font to use.								        Required
			maxcount	The max. amount of times to run the test.						1
			mincount	The min. amount of times to run the test.						1
			smartstop	Don't do additional tests if the last two results are similar	false


		Callback will receive an object:
			success		true if no error occured. If false, other keys are undefined!
			feecof		Number that is higher for better-performing devices.
			detail		Array of Numbers that is higher for better-performing devices.
			webglver	Either 1 or 2.
			cores		Amount of processing cores ready for use.
			memory		Amount of memory installed.
			renderer	Device handling rendering.
			duration	Amount of ms the test took.
	*/

	try {
		const texture = PIXI.Texture.from(options.img || './kagari.png');

		let mainPixi = new PIXI.Application({
			width: 640,
			height: 320,
			view: options.view,
			antialias: false,
			transparent: false,
			powerPreference: 'high-performance',
			forceFXAA: false
		});

		let kagariHolder;
		let particleHolder;
		let TTHolder;

		function SetupHolders() {
			kagariHolder = new PIXI.Container();
			TTHolder = new PIXI.Container();
			particleHolder = new PIXI.ParticleContainer(undefined, {
				vertices: false,
				position: true,
				rotation: false,
				uvs: false,
				tint: true
			}, undefined, true);
			particleHolder.blendMode = PIXI.BLEND_MODES.SCREEN;

			mainPixi.stage.addChild(kagariHolder);
			mainPixi.stage.addChild(particleHolder);
			mainPixi.stage.addChild(TTHolder);
		}

		function DestroyHolders() {
			kagariHolder.destroy();
			particleHolder.destroy();
			TTHolder.destroy();
		}

		SetupHolders();

		const startTime = Date.now();
		let rendererName = 'Unknown';
		const webglver = mainPixi.renderer.context.webGLVersion;
		const dat = mainPixi.renderer.gl.getExtension('WEBGL_debug_renderer_info');
		if (dat) {
			rendererName = mainPixi.renderer.gl.getParameter(dat.UNMASKED_RENDERER_WEBGL) || 'Unknown';
		}
		
		

		const pressures = [];
		let currentPressure = 0;
		let failures = 0;
		let frame = 0;
		let tts = [];
		mainPixi.ticker.add((dT) => {
			frame++;

			if (frame <= 0) { return; }

			if (frame !== 1 && dT >= ((options.cutoff || 1.5) * (frame % 2 !== 0 ? 1 : 4))) {
		    	failures += dT / (options.cutoff || 1.5);

		    	if (failures >= (options.fails || 4)) {
		    		pressures.push(currentPressure);

		    		let stop = (--options.maxcount <= 0);

		    		if (!stop && options.smartstop && pressures.length >= (options.mincount || 1) &&  pressures.length >= 2) {
		    			const proximity = pressures[pressures.length - 1] / pressures[pressures.length - 2];
		    			if (proximity >= 0.8 && proximity <= 1.25) {
		    				stop = true;
		    			}
		    		}

		    		if (stop) {
		    			mainPixi.ticker.stop();
		    			DestroyHolders();
			    		mainPixi.destroy(false, true);

			    		const highest = pressures.reduce(function(a, b) {
						    return Math.max(a, b);
						});

			    		let validCount = 0;
			    		let validTotal = 0;
						pressures.forEach((m) => {
							let proximity = Math.pow(m, 1.5) / Math.pow(highest, 1.5);
							validCount += proximity;
							validTotal += m * proximity;
						});

			    		callback({
			    			success: true,
			    			feecof: Math.floor(validTotal / validCount),
			    			detail: pressures,
							webglver,
							cores: navigator.hardwareConcurrency || 0,
							memory: navigator.deviceMemory || 0,
							renderer: rendererName,
							duration: Date.now() - startTime
			    		});
		    		} else {
		    			DestroyHolders();
		    			SetupHolders();
		    			currentPressure = 0;
		    			tts = [];
		    			failures = 0;
		    			frame = -3; // some breathing room
		    		}
		    		
		    		return;
		    	}
		    } else if (frame % 2 !== 0) {
		    	failures = Math.max(0, failures - 2);
		    }

		    currentPressure += ((50 * frame) / Math.max(1, dT)) * (options.speed || 1);

			if (frame % 2 === 1) {
				// Add normal Kagaris.
			    const kagariCount = (2 * frame) * (options.speed || 1);
			    for (let i = 0; i < kagariCount; i++) {
			    	const spr = new PIXI.Sprite(texture);
			    	spr.position.set(Math.random() * 640, Math.random() * 320);
			    	spr.angle = Math.random() * 360;
			    	kagariHolder.addChild(spr);
			    }

			    // Add particle Kagaris.
			    const particleCount = (5 * frame) * (options.speed || 1);
			    for (let i = 0; i < particleCount; i++) {
			    	const spr = new PIXI.Sprite(texture);
			    	spr.scale.set(0.2);
			    	spr.position.set(Math.random() * 640, Math.random() * 320);
			    	spr.tint = Math.random() * 0xFFFFFF;
			    	particleHolder.addChild(spr);
			    }

			    // Add TT elements.
			    const ttCount = (0.05 * frame) * (options.speed || 1);
			    for (let i = 0; i < ttCount; i++) {
			    	const spr = new TheoryType.Text('KAGARI 00000', {
						font: options.font,
						fontSize: 16,
						tint: Math.random() * 0xFFFFFF
				    });
			    	spr.position.set(Math.random() * 640, Math.random() * 320);
			    	spr.angle = Math.random() * 360;
			    	TTHolder.addChild(spr);

			    	if (i % 3 === 0) {
			    		tts.push(spr);
			    	}
			    }

			    for (const spr of tts) {
			    	spr.text = 'KAGARI ' + Math.floor(Math.random() * 100000).toString().padStart(5, '0');
			    }
			}
		});
	} catch (ex) {
		console.error(ex);
		callback({
			success: false
		});
	}	
};


/**
 * Identicon.js 2.3.3
 * http://github.com/stewartlord/identicon.js
 *
 * PNGLib required for PNG output
 * http://www.xarg.org/download/pnglib.js
 *
 * Copyright 2018, Stewart Lord
 * Released under the BSD license
 * http://www.opensource.org/licenses/bsd-license.php
 */

(function() {
    var PNGlib;
    if (typeof module !== 'undefined' && typeof module.exports !== 'undefined') {
        PNGlib = require('./pnglib');
    } else {
        PNGlib = window.PNGlib;
    }

    var Identicon = function(hash, options){
        if (typeof(hash) !== 'string' || hash.length < 15) {
            throw 'A hash of at least 15 characters is required.';
        }

        this.defaults = {
            background: [240, 240, 240, 255],
            margin:     0.08,
            size:       64,
            saturation: 0.7,
            brightness: 0.5,
            format:     'png'
        };

        this.options = typeof(options) === 'object' ? options : this.defaults;

        // backward compatibility with old constructor (hash, size, margin)
        if (typeof(arguments[1]) === 'number') { this.options.size   = arguments[1]; }
        if (arguments[2])                      { this.options.margin = arguments[2]; }

        this.hash        = hash
        this.background  = this.options.background || this.defaults.background;
        this.size        = this.options.size       || this.defaults.size;
        this.format      = this.options.format     || this.defaults.format;
        this.margin      = this.options.margin !== undefined ? this.options.margin : this.defaults.margin;

        // foreground defaults to last 7 chars as hue at 70% saturation, 50% brightness
        var hue          = parseInt(this.hash.substr(-7), 16) / 0xfffffff;
        var saturation   = this.options.saturation || this.defaults.saturation;
        var brightness   = this.options.brightness || this.defaults.brightness;
        this.foreground  = this.options.foreground || this.hsl2rgb(hue, saturation, brightness);
    };

    Identicon.prototype = {
        background: null,
        foreground: null,
        hash:       null,
        margin:     null,
        size:       null,
        format:     null,

        image: function(){
            return this.isSvg()
                ? new Svg(this.size, this.foreground, this.background)
                : new PNGlib(this.size, this.size, 256);
        },

        render: function(){
            var image      = this.image(),
                size       = this.size,
                baseMargin = Math.floor(size * this.margin),
                cell       = Math.floor((size - (baseMargin * 2)) / 5),
                margin     = Math.floor((size - cell * 5) / 2),
                bg         = image.color.apply(image, this.background),
                fg         = image.color.apply(image, this.foreground);

            // the first 15 characters of the hash control the pixels (even/odd)
            // they are drawn down the middle first, then mirrored outwards
            var i, color;
            for (i = 0; i < 15; i++) {
                color = parseInt(this.hash.charAt(i), 16) % 2 ? bg : fg;
                if (i < 5) {
                    this.rectangle(2 * cell + margin, i * cell + margin, cell, cell, color, image);
                } else if (i < 10) {
                    this.rectangle(1 * cell + margin, (i - 5) * cell + margin, cell, cell, color, image);
                    this.rectangle(3 * cell + margin, (i - 5) * cell + margin, cell, cell, color, image);
                } else if (i < 15) {
                    this.rectangle(0 * cell + margin, (i - 10) * cell + margin, cell, cell, color, image);
                    this.rectangle(4 * cell + margin, (i - 10) * cell + margin, cell, cell, color, image);
                }
            }

            return image;
        },

        rectangle: function(x, y, w, h, color, image){
            if (this.isSvg()) {
                image.rectangles.push({x: x, y: y, w: w, h: h, color: color});
            } else {
                var i, j;
                for (i = x; i < x + w; i++) {
                    for (j = y; j < y + h; j++) {
                        image.buffer[image.index(i, j)] = color;
                    }
                }
            }
        },

        // adapted from: https://gist.github.com/aemkei/1325937
        hsl2rgb: function(h, s, b){
            h *= 6;
            s = [
                b += s *= b < .5 ? b : 1 - b,
                b - h % 1 * s * 2,
                b -= s *= 2,
                b,
                b + h % 1 * s,
                b + s
            ];

            return[
                s[ ~~h    % 6 ] * 255, // red
                s[ (h|16) % 6 ] * 255, // green
                s[ (h|8)  % 6 ] * 255  // blue
            ];
        },

        toString: function(raw){
            // backward compatibility with old toString, default to base64
            if (raw) {
                return this.render().getDump();
            } else {
                return this.render().getBase64();
            }
        },

        isSvg: function(){
            return this.format.match(/svg/i)
        }
    };

    var Svg = function(size, foreground, background){
        this.size       = size;
        this.foreground = this.color.apply(this, foreground);
        this.background = this.color.apply(this, background);
        this.rectangles = [];
    };

    Svg.prototype = {
        size:       null,
        foreground: null,
        background: null,
        rectangles: null,

        color: function(r, g, b, a){
            var values = [r, g, b].map(Math.round);
            values.push((a >= 0) && (a <= 255) ? a/255 : 1);
            return 'rgba(' + values.join(',') + ')';
        },

        getDump: function(){
          var i,
                xml,
                rect,
                fg     = this.foreground,
                bg     = this.background,
                stroke = this.size * 0.005;

            xml = "<svg xmlns='http://www.w3.org/2000/svg'"
                + " width='" + this.size + "' height='" + this.size + "'"
                + " style='background-color:" + bg + ";'>"
                + "<g style='fill:" + fg + "; stroke:" + fg + "; stroke-width:" + stroke + ";'>";

            for (i = 0; i < this.rectangles.length; i++) {
                rect = this.rectangles[i];
                if (rect.color == bg) continue;
                xml += "<rect "
                    + " x='"      + rect.x + "'"
                    + " y='"      + rect.y + "'"
                    + " width='"  + rect.w + "'"
                    + " height='" + rect.h + "'"
                    + "/>";
            }
            xml += "</g></svg>"

            return xml;
        },

        getBase64: function(){
            if ('function' === typeof btoa) {
                return btoa(this.getDump());
            } else if (Buffer) {
                return new Buffer(this.getDump(), 'binary').toString('base64');
            } else {
                throw 'Cannot generate base64 output';
            }
        }
    };

    if (typeof module !== 'undefined' && typeof module.exports !== 'undefined') {
        module.exports = Identicon;
    } else {
        window.Identicon = Identicon;
    }
})();

MD5 = function(e) {
    function h(a, b) {
        var c, d, e, f, g;
        e = a & 2147483648;
        f = b & 2147483648;
        c = a & 1073741824;
        d = b & 1073741824;
        g = (a & 1073741823) + (b & 1073741823);
        return c & d ? g ^ 2147483648 ^ e ^ f : c | d ? g & 1073741824 ? g ^ 3221225472 ^ e ^ f : g ^ 1073741824 ^ e ^ f : g ^ e ^ f
    }

    function k(a, b, c, d, e, f, g) {
        a = h(a, h(h(b & c | ~b & d, e), g));
        return h(a << f | a >>> 32 - f, b)
    }

    function l(a, b, c, d, e, f, g) {
        a = h(a, h(h(b & d | c & ~d, e), g));
        return h(a << f | a >>> 32 - f, b)
    }

    function m(a, b, d, c, e, f, g) {
        a = h(a, h(h(b ^ d ^ c, e), g));
        return h(a << f | a >>> 32 - f, b)
    }

    function n(a, b, d, c, e, f, g) {
        a = h(a, h(h(d ^ (b | ~c), e), g));
        return h(a << f | a >>> 32 - f, b)
    }

    function p(a) {
        var b = "",
            d = "",
            c;
        for (c = 0; 3 >= c; c++) d = a >>> 8 * c & 255, d = "0" + d.toString(16), b += d.substr(d.length - 2, 2);
        return b
    }
    var f = [],
        q, r, s, t, a, b, c, d;
    e = function(a) {
        a = a.replace(/\r\n/g, "\n");
        for (var b = "", d = 0; d < a.length; d++) {
            var c = a.charCodeAt(d);
            128 > c ? b += String.fromCharCode(c) : (127 < c && 2048 > c ? b += String.fromCharCode(c >> 6 | 192) : (b += String.fromCharCode(c >> 12 | 224), b += String.fromCharCode(c >> 6 & 63 | 128)), b += String.fromCharCode(c & 63 | 128))
        }
        return b
    }(e);
    f = function(b) {
        var a, c = b.length;
        a = c + 8;
        for (var d = 16 * ((a - a % 64) / 64 + 1), e = Array(d - 1), f = 0, g = 0; g < c;) a = (g - g % 4) / 4, f = g % 4 * 8, e[a] |= b.charCodeAt(g) << f, g++;
        a = (g - g % 4) / 4;
        e[a] |= 128 << g % 4 * 8;
        e[d - 2] = c << 3;
        e[d - 1] = c >>> 29;
        return e
    }(e);
    a = 1732584193;
    b = 4023233417;
    c = 2562383102;
    d = 271733878;
    for (e = 0; e < f.length; e += 16) q = a, r = b, s = c, t = d, a = k(a, b, c, d, f[e + 0], 7, 3614090360), d = k(d, a, b, c, f[e + 1], 12, 3905402710), c = k(c, d, a, b, f[e + 2], 17, 606105819), b = k(b, c, d, a, f[e + 3], 22, 3250441966), a = k(a, b, c, d, f[e + 4], 7, 4118548399), d = k(d, a, b, c, f[e + 5], 12, 1200080426), c = k(c, d, a, b, f[e + 6], 17, 2821735955), b = k(b, c, d, a, f[e + 7], 22, 4249261313), a = k(a, b, c, d, f[e + 8], 7, 1770035416), d = k(d, a, b, c, f[e + 9], 12, 2336552879), c = k(c, d, a, b, f[e + 10], 17, 4294925233), b = k(b, c, d, a, f[e + 11], 22, 2304563134), a = k(a, b, c, d, f[e + 12], 7, 1804603682), d = k(d, a, b, c, f[e + 13], 12, 4254626195), c = k(c, d, a, b, f[e + 14], 17, 2792965006), b = k(b, c, d, a, f[e + 15], 22, 1236535329), a = l(a, b, c, d, f[e + 1], 5, 4129170786), d = l(d, a, b, c, f[e + 6], 9, 3225465664), c = l(c, d, a, b, f[e + 11], 14, 643717713), b = l(b, c, d, a, f[e + 0], 20, 3921069994), a = l(a, b, c, d, f[e + 5], 5, 3593408605), d = l(d, a, b, c, f[e + 10], 9, 38016083), c = l(c, d, a, b, f[e + 15], 14, 3634488961), b = l(b, c, d, a, f[e + 4], 20, 3889429448), a = l(a, b, c, d, f[e + 9], 5, 568446438), d = l(d, a, b, c, f[e + 14], 9, 3275163606), c = l(c, d, a, b, f[e + 3], 14, 4107603335), b = l(b, c, d, a, f[e + 8], 20, 1163531501), a = l(a, b, c, d, f[e + 13], 5, 2850285829), d = l(d, a, b, c, f[e + 2], 9, 4243563512), c = l(c, d, a, b, f[e + 7], 14, 1735328473), b = l(b, c, d, a, f[e + 12], 20, 2368359562), a = m(a, b, c, d, f[e + 5], 4, 4294588738), d = m(d, a, b, c, f[e + 8], 11, 2272392833), c = m(c, d, a, b, f[e + 11], 16, 1839030562), b = m(b, c, d, a, f[e + 14], 23, 4259657740), a = m(a, b, c, d, f[e + 1], 4, 2763975236), d = m(d, a, b, c, f[e + 4], 11, 1272893353), c = m(c, d, a, b, f[e + 7], 16, 4139469664), b = m(b, c, d, a, f[e + 10], 23, 3200236656), a = m(a, b, c, d, f[e + 13], 4, 681279174), d = m(d, a, b, c, f[e + 0], 11, 3936430074), c = m(c, d, a, b, f[e + 3], 16, 3572445317), b = m(b, c, d, a, f[e + 6], 23, 76029189), a = m(a, b, c, d, f[e + 9], 4, 3654602809), d = m(d, a, b, c, f[e + 12], 11, 3873151461), c = m(c, d, a, b, f[e + 15], 16, 530742520), b = m(b, c, d, a, f[e + 2], 23, 3299628645), a = n(a, b, c, d, f[e + 0], 6, 4096336452), d = n(d, a, b, c, f[e + 7], 10, 1126891415), c = n(c, d, a, b, f[e + 14], 15, 2878612391), b = n(b, c, d, a, f[e + 5], 21, 4237533241), a = n(a, b, c, d, f[e + 12], 6, 1700485571), d = n(d, a, b, c, f[e + 3], 10, 2399980690), c = n(c, d, a, b, f[e + 10], 15, 4293915773), b = n(b, c, d, a, f[e + 1], 21, 2240044497), a = n(a, b, c, d, f[e + 8], 6, 1873313359), d = n(d, a, b, c, f[e + 15], 10, 4264355552), c = n(c, d, a, b, f[e + 6], 15, 2734768916), b = n(b, c, d, a, f[e + 13], 21, 1309151649), a = n(a, b, c, d, f[e + 4], 6, 4149444226), d = n(d, a, b, c, f[e + 11], 10, 3174756917), c = n(c, d, a, b, f[e + 2], 15, 718787259), b = n(b, c, d, a, f[e + 9], 21, 3951481745), a = h(a, q), b = h(b, r), c = h(c, s), d = h(d, t);
    return (p(a) + p(b) + p(c) + p(d)).toLowerCase()
};


// @tensorflow/tfjs Copyright 2019 Google
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e(t.tf=t.tf||{})}(this,function(t){"use strict";var e=function(t,n){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n])})(t,n)};function n(t,n){function r(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}function r(t,e,n,r){return new(n||(n=Promise))(function(i,a){function o(t){try{u(r.next(t))}catch(t){a(t)}}function s(t){try{u(r.throw(t))}catch(t){a(t)}}function u(t){t.done?i(t.value):new n(function(e){e(t.value)}).then(o,s)}u((r=r.apply(t,e||[])).next())})}function i(t,e){var n,r,i,a,o={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return a={next:s(0),throw:s(1),return:s(2)},"function"==typeof Symbol&&(a[Symbol.iterator]=function(){return this}),a;function s(a){return function(s){return function(a){if(n)throw new TypeError("Generator is already executing.");for(;o;)try{if(n=1,r&&(i=2&a[0]?r.return:a[0]?r.throw||((i=r.return)&&i.call(r),0):r.next)&&!(i=i.call(r,a[1])).done)return i;switch(r=0,i&&(a=[2&a[0],i.value]),a[0]){case 0:case 1:i=a;break;case 4:return o.label++,{value:a[1],done:!1};case 5:o.label++,r=a[1],a=[0];continue;case 7:a=o.ops.pop(),o.trys.pop();continue;default:if(!(i=(i=o.trys).length>0&&i[i.length-1])&&(6===a[0]||2===a[0])){o=0;continue}if(3===a[0]&&(!i||a[1]>i[0]&&a[1]<i[3])){o.label=a[1];break}if(6===a[0]&&o.label<i[1]){o.label=i[1],i=a;break}if(i&&o.label<i[2]){o.label=i[2],o.ops.push(a);break}i[2]&&o.ops.pop(),o.trys.pop();continue}a=e.call(t,o)}catch(t){a=[6,t],r=0}finally{n=i=0}if(5&a[0])throw a[1];return{value:a[0]?a[1]:void 0,done:!0}}([a,s])}}}var a=function(){function t(t){this.global=t,this.flags={},this.flagRegistry={},this.urlFlags={},this.populateURLFlags()}return t.prototype.setPlatform=function(t,e){null!=this.platform&&console.warn("Platform "+this.platformName+" has already been set. Overwriting the platform with "+e+"."),this.platformName=t,this.platform=e},t.prototype.registerFlag=function(t,e,n){if(this.flagRegistry[t]={evaluationFn:e,setHook:n},null!=this.urlFlags[t]){var r=this.urlFlags[t];console.warn("Setting feature override from URL "+t+": "+r+"."),this.set(t,r)}},t.prototype.get=function(t){return t in this.flags?this.flags[t]:(this.flags[t]=this.evaluateFlag(t),this.flags[t])},t.prototype.getNumber=function(t){return this.get(t)},t.prototype.getBool=function(t){return this.get(t)},t.prototype.getFlags=function(){return this.flags},Object.defineProperty(t.prototype,"features",{get:function(){return this.flags},enumerable:!0,configurable:!0}),t.prototype.set=function(t,e){if(null==this.flagRegistry[t])throw new Error("Cannot set flag "+t+" as it has not been registered.");this.flags[t]=e,null!=this.flagRegistry[t].setHook&&this.flagRegistry[t].setHook(e)},t.prototype.evaluateFlag=function(t){if(null==this.flagRegistry[t])throw new Error("Cannot evaluate flag '"+t+"': no evaluation function found.");return this.flagRegistry[t].evaluationFn()},t.prototype.setFlags=function(t){this.flags=Object.assign({},t)},t.prototype.reset=function(){this.flags={},this.urlFlags={},this.populateURLFlags()},t.prototype.populateURLFlags=function(){var t=this;if(void 0!==this.global&&void 0!==this.global.location&&void 0!==this.global.location.search){var e=o(this.global.location.search);"tfjsflags"in e&&e.tfjsflags.split(",").forEach(function(e){var n=e.split(":"),r=n[0],i=n[1];t.urlFlags[r]=function(t,e){if("true"===(e=e.toLowerCase())||"false"===e)return"true"===e;if(""+ +e===e)return+e;throw new Error("Could not parse value flag value "+e+" for flag "+t+".")}(r,i)})}},t}();function o(t){var e={};return t.replace(/[?&]([^=?&]+)(?:=([^&]*))?/g,function(t){for(var n=[],r=1;r<arguments.length;r++)n[r-1]=arguments[r];return function(t,e,n){t[decodeURIComponent(e)]=decodeURIComponent(n||"")}(e,n[0],n[1]),n.join("=")}),e}function s(e){t.ENV=e}t.ENV=null;var u=Object.freeze({Environment:a,getQueryParams:o,get ENV(){return t.ENV},setEnvironmentGlobal:s});function l(t){for(var e=t.length,n=0,r=0;e>0;)r=Math.random()*e|0,n=t[--e],t[e]=t[r],t[r]=n}function c(t,e,n){return Math.max(t,Math.min(e,n))}function p(t){return t%2==0?t:t+1}function h(t){for(var e=0,n=0;n<t.length;n++)e+=t[n];return e}function f(t,e){if(!t)throw new Error("string"==typeof e?e:e())}function d(t,e,n){void 0===n&&(n=""),f(y(t,e),function(){return n+" Shapes "+t+" and "+e+" must match"})}function m(t){f(null!=t,function(){return"The input to the tensor constructor must be a non-null value."})}function g(t,e,n){if(void 0===e&&(e=[]),void 0===n&&(n=!1),null==e&&(e=[]),Array.isArray(t)||_(t)&&!n)for(var r=0;r<t.length;++r)g(t[r],e,n);else e.push(t);return e}function v(t){if(0===t.length)return 1;for(var e=t[0],n=1;n<t.length;n++)e*=t[n];return e}function y(t,e){if(t===e)return!0;if(null==t||null==e)return!1;if(t.length!==e.length)return!1;for(var n=0;n<t.length;n++)if(t[n]!==e[n])return!1;return!0}function b(t){return t%1==0}function x(t){if(null!=Math.tanh)return Math.tanh(t);if(t===1/0)return 1;if(t===-1/0)return-1;var e=Math.exp(2*t);return(e-1)/(e+1)}function w(t){var e=Math.ceil(Math.sqrt(t));return[e,Math.ceil(t/e)]}function N(t,e){return e<=t.length?t:t+" ".repeat(e-t.length)}function C(t,e,n){return void 0===e&&(e=function(t){return 0}),new Promise(function(r,i){var a=0,o=function(){if(t())r();else{var s=e(++a);null!=n&&a>=n?i():setTimeout(o,s)}};o()})}function E(t,e){for(var n=1,r=-1,i=0;i<t.length;++i)if(t[i]>=0)n*=t[i];else if(-1===t[i]){if(-1!==r)throw Error("Shapes can only have 1 implicit size. Found -1 at dim "+r+" and dim "+i);r=i}else if(t[i]<0)throw Error("Shapes can not be < 0. Found "+t[i]+" at dim "+i);if(-1===r){if(e>0&&e!==n)throw Error("Size("+e+") must match the product of shape "+t);return t}if(0===n)throw Error("Cannot infer the missing size in ["+t+"] when there are 0 elements");if(e%n!=0)throw Error("The implicit shape can't be a fractional number. Got "+e+" / "+n);var a=t.slice();return a[r]=e/n,a}function S(t,e){var n=e.length;return f((t=null==t?e.map(function(t,e){return e}):[].concat(t)).every(function(t){return t>=-n&&t<n}),function(){return"All values in axis param must be in range [-"+n+", "+n+") but got axis "+t}),f(t.every(function(t){return b(t)}),function(){return"All values in axis param must be integers but got axis "+t}),t.map(function(t){return t<0?n+t:t})}function k(t,e){for(var n=[],r=[],i=null==e?null:S(e,t).sort(),a=0,o=0;o<t.length;++o){if(null!=i){if(i[a]===o&&1!==t[o])throw new Error("Can't squeeze axis "+o+" since its dim '"+t[o]+"' is not 1");(null==i[a]||i[a]>o)&&1===t[o]&&(n.push(t[o]),r.push(o)),i[a]<=o&&a++}1!==t[o]&&(n.push(t[o]),r.push(o))}return{newShape:n,keptDims:r}}function I(t,e){var n=null;if(null==t||"float32"===t)n=new Float32Array(e);else if("int32"===t)n=new Int32Array(e);else{if("bool"!==t)throw new Error("Unknown data type "+t);n=new Uint8Array(e)}return n}function A(t,e){var n=null;if(null==t||"float32"===t)n=new Float32Array(e);else if("int32"===t)n=new Int32Array(e);else if("bool"===t)n=new Uint8Array(e);else{if("string"!==t)throw new Error("Unknown data type "+t);n=new Array(e)}return n}function R(t,e,n){if("float32"===e)for(var r=0;r<t.length;r++){var i=t[r];if(isNaN(i)||!isFinite(i))throw Error("The result of the '"+n+"' is "+i+".")}}function T(t,e){for(var n=0;n<t.length;n++){var r=t[n];if(isNaN(r)||!isFinite(r))throw Error("A tensor of type "+e+" being uploaded contains "+r+".")}}function D(t){return"bool"===t||"complex64"===t||"float32"===t||"int32"===t||"string"===t}function O(t,e){return!("complex64"===e||"float32"===e&&"complex64"!==t||"int32"===e&&"float32"!==t&&"complex64"!==t||"bool"===e&&"bool"===t)}function _(t){return t instanceof Float32Array||t instanceof Int32Array||t instanceof Uint8Array}function F(t){if("float32"===t||"int32"===t)return 4;if("complex64"===t)return 8;if("bool"===t)return 1;throw new Error("Unknown dtype "+t)}function M(t){if(null==t)return 0;var e=0;return t.forEach(function(t){return e+=t.length}),e}function z(t){return"string"==typeof t||t instanceof String}function L(t){return"boolean"==typeof t}function P(t){return"number"==typeof t}function B(t){return Array.isArray(t)?B(t[0]):t instanceof Float32Array?"float32":t instanceof Int32Array||t instanceof Uint8Array?"int32":P(t)?"float32":z(t)?"string":L(t)?"bool":"float32"}function V(t){return!!(t&&t.constructor&&t.call&&t.apply)}function W(t,e){for(var n=e;n<t;++n)if(t%n==0)return n;return t}function U(t){var e=t.length;if(e<2)return[];var n=new Array(e-1);n[e-2]=t[e-1];for(var r=e-3;r>=0;--r)n[r]=n[r+1]*t[r+1];return n}function j(t,e,n){if("string"===e)throw new Error("Cannot convert a string[] to a TypedArray");if(Array.isArray(t)&&(t=g(t)),n&&T(t,e),function(t,e){return t instanceof Float32Array&&"float32"===e||t instanceof Int32Array&&"int32"===e||t instanceof Uint8Array&&"bool"===e}(t,e))return t;if(null==e||"float32"===e||"complex64"===e)return new Float32Array(t);if("int32"===e)return new Int32Array(t);if("bool"===e){for(var r=new Uint8Array(t.length),i=0;i<r.length;++i)0!==Math.round(t[i])&&(r[i]=1);return r}throw new Error("Unknown data type "+e)}function q(t,e){if(0===t.length)return e[0];var n=t.reduce(function(t,e){return t*e});if(0===n)return[];if(n!==e.length)throw new Error("["+t+"] does not match the input size.");return function t(e,n,r){var i=new Array;if(1===n.length)for(var a=n[0],o=0;o<a;o++)i[o]=r[e+o];else{a=n[0];var s=n.slice(1),u=s.reduce(function(t,e){return t*e});for(o=0;o<a;o++)i[o]=t(e+o*u,s,r)}return i}(0,t,e)}function H(t,e){for(var n=G(t,e),r=0;r<n.length;r++)n[r]=1;return n}function G(t,e){if(null==e||"float32"===e||"complex64"===e)return new Float32Array(t);if("int32"===e)return new Int32Array(t);if("bool"===e)return new Uint8Array(t);throw new Error("Unknown data type "+e)}function K(){return t.ENV.platform.now()}function $(t){t.forEach(function(e){f(Number.isInteger(e)&&e>=0,function(){return"Tensor must have a shape comprised of positive integers but got shape ["+t+"]."})})}function X(e,n){return void 0===n&&(n="utf-8"),n=n||"utf-8",t.ENV.platform.encode(e,n)}function Y(e,n){return void 0===n&&(n="utf-8"),n=n||"utf-8",t.ENV.platform.decode(e,n)}var J=Object.freeze({shuffle:l,clamp:c,nearestLargerEven:p,sum:h,randUniform:function(t,e){var n=Math.random();return e*n+(1-n)*t},distSquared:function(t,e){for(var n=0,r=0;r<t.length;r++){var i=Number(t[r])-Number(e[r]);n+=i*i}return n},assert:f,assertShapesMatch:d,assertNonNull:m,flatten:g,sizeFromShape:v,isScalarShape:function(t){return 0===t.length},arraysEqual:y,isInt:b,tanh:x,sizeToSquarishShape:w,createShuffledIndices:function(t){for(var e=new Uint32Array(t),n=0;n<t;++n)e[n]=n;return l(e),e},rightPad:N,repeatedTry:C,inferFromImplicitShape:E,parseAxisParam:S,squeezeShape:k,getTypedArrayFromDType:I,getArrayFromDType:A,checkComputationForErrors:R,checkConversionForErrors:T,isValidDtype:D,hasEncodingLoss:O,isTypedArray:_,bytesPerElement:F,bytesFromStringArray:M,isString:z,isBoolean:L,isNumber:P,inferDtype:B,isFunction:V,nearestDivisor:W,computeStrides:U,toTypedArray:j,toNestedArray:q,makeOnesTypedArray:H,makeZerosTypedArray:G,now:K,assertNonNegativeIntegerDimensions:$,fetch:function(e,n){return t.ENV.platform.fetch(e,n)},encodeString:X,decodeString:Y}),Z=function(){function t(t,e){this.backendTimer=t,this.logger=e,null==e&&(this.logger=new Q)}return t.prototype.profileKernel=function(t,e,n){var r,i=this,a=this.backendTimer.time(function(){r=n()});return(Array.isArray(r)?r:[r]).forEach(function(n){var r=n.dataSync();R(r,n.dtype,t),a.then(function(a){var o="";null!=a.getExtraProfileInfo&&(o=a.getExtraProfileInfo()),i.logger.logKernelProfile(t,n,r,a.kernelMs,e,o)})}),r},t}(),Q=function(){function t(){}return t.prototype.logKernelProfile=function(t,e,n,r,i,a){var o=N(r+"ms",9),s=N(t,25),u=e.rank,l=e.size,c=N(e.shape.toString(),14),p="";for(var h in i){var f=i[h].shape,d=f.length;p+=h+": "+d+"D "+(d>0?f:"")+" "}console.log("%c"+s+"\t%c"+o+"\t%c"+u+"D "+c+"\t%c"+l+"\t%c"+p+"\t%c"+a,"font-weight:bold","color:red","color:blue","color: orange","color: green","color: steelblue")},t}(),tt=20,et=3,nt=7;function rt(t,e,n){return N(Array.isArray(t)?parseFloat(t[0].toFixed(nt))+" + "+parseFloat(t[1].toFixed(nt))+"j":z(t)?"'"+t+"'":"bool"===n?it(t):parseFloat(t.toFixed(nt)).toString(),e)}function it(t){return 0===t?"false":"true"}function at(t){for(var e=[],n=0;n<t.length;n+=2)e.push([t[n],t[n+1]]);return e}var ot=function(){function t(t,e,n){var r=this;if(this.dtype=e,this.shape=t.slice(),this.size=v(t),null!=n){var i=n.length;f(i===this.size,function(){return"Length of values '"+i+"' does not match the size inferred by the shape '"+r.size+"'."})}if("complex64"===e)throw new Error("complex64 dtype TensorBuffers are not supported. Please create a TensorBuffer for the real and imaginary parts separately and call tf.complex(real, imag).");this.values=n||A(e,this.size),this.strides=U(t)}return t.prototype.set=function(t){for(var e=this,n=[],r=1;r<arguments.length;r++)n[r-1]=arguments[r];0===n.length&&(n=[0]),f(n.length===this.rank,function(){return"The number of provided coordinates ("+n.length+") must match the rank ("+e.rank+")"});var i=this.locToIndex(n);this.values[i]=t},t.prototype.get=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];0===t.length&&(t=[0]);for(var n=0,r=0,i=t;r<i.length;r++){var a=i[r];if(a<0||a>=this.shape[n]){var o="Requested out of range element at "+t+".   Buffer shape="+this.shape;throw new Error(o)}n++}for(var s=t[t.length-1],u=0;u<t.length-1;++u)s+=this.strides[u]*t[u];return this.values[s]},t.prototype.locToIndex=function(t){if(0===this.rank)return 0;if(1===this.rank)return t[0];for(var e=t[t.length-1],n=0;n<t.length-1;++n)e+=this.strides[n]*t[n];return e},t.prototype.indexToLoc=function(t){if(0===this.rank)return[];if(1===this.rank)return[t];for(var e=new Array(this.shape.length),n=0;n<e.length-1;++n)e[n]=Math.floor(t/this.strides[n]),t-=e[n]*this.strides[n];return e[e.length-1]=t,e},Object.defineProperty(t.prototype,"rank",{get:function(){return this.shape.length},enumerable:!0,configurable:!0}),t.prototype.toTensor=function(){return ct.make(this.shape,{values:this.values},this.dtype)},t}(),st=null,ut=null,lt=null,ct=function(){function t(t,e,n,r,i){this.kept=!1,this.isDisposedInternal=!1,this.shape=t.slice(),this.dtype=e||"float32",this.size=v(t),this.strides=U(t),this.dataId=null!=r?r:{},this.id=st().nextTensorId(),this.rankType=this.rank<5?this.rank.toString():"higher",st().registerTensor(this,i),null!=n&&st().write(i,this.dataId,n)}return t.make=function(e,n,r,i){var a=n.values;return null!=n.values&&"string"===r&&z(n.values[0])&&(a=n.values.map(function(t){return X(t)})),new t(e,r,a,n.dataId,i)},t.prototype.flatten=function(){return this.throwIfDisposed(),this.as1D()},t.prototype.asScalar=function(){return this.throwIfDisposed(),f(1===this.size,function(){return"The array must have only 1 element."}),this.reshape([])},t.prototype.as1D=function(){return this.throwIfDisposed(),this.reshape([this.size])},t.prototype.as2D=function(t,e){return this.throwIfDisposed(),this.reshape([t,e])},t.prototype.as3D=function(t,e,n){return this.throwIfDisposed(),this.reshape([t,e,n])},t.prototype.as4D=function(t,e,n,r){return this.throwIfDisposed(),this.reshape([t,e,n,r])},t.prototype.as5D=function(t,e,n,r,i){return this.throwIfDisposed(),this.reshape([t,e,n,r,i])},t.prototype.asType=function(t){return this.throwIfDisposed(),ut.cast(this,t)},Object.defineProperty(t.prototype,"rank",{get:function(){return this.shape.length},enumerable:!0,configurable:!0}),t.prototype.buffer=function(){return r(this,void 0,void 0,function(){var t;return i(this,function(e){switch(e.label){case 0:return[4,this.data()];case 1:return t=e.sent(),[2,ut.buffer(this.shape,this.dtype,t)]}})})},t.prototype.bufferSync=function(){return ut.buffer(this.shape,this.dtype,this.dataSync())},t.prototype.array=function(){return r(this,void 0,void 0,function(){var t;return i(this,function(e){switch(e.label){case 0:return[4,this.data()];case 1:return t=e.sent(),[2,q(this.shape,t)]}})})},t.prototype.arraySync=function(){return q(this.shape,this.dataSync())},t.prototype.data=function(){return r(this,void 0,void 0,function(){var t,e;return i(this,function(n){switch(n.label){case 0:return this.throwIfDisposed(),t=st().read(this.dataId),"string"!==this.dtype?[3,2]:[4,t];case 1:e=n.sent();try{return[2,e.map(function(t){return Y(t)})]}catch(t){throw new Error("Failed to decode the string bytes into utf-8. To get the original bytes, call tensor.bytes().")}n.label=2;case 2:return[2,t]}})})},t.prototype.dataSync=function(){this.throwIfDisposed();var t=st().readSync(this.dataId);if("string"===this.dtype)try{return t.map(function(t){return Y(t)})}catch(t){throw new Error("Failed to decode the string bytes into utf-8. To get the original bytes, call tensor.bytes().")}return t},t.prototype.bytes=function(){return r(this,void 0,void 0,function(){var t;return i(this,function(e){switch(e.label){case 0:return this.throwIfDisposed(),[4,st().read(this.dataId)];case 1:return t=e.sent(),"string"===this.dtype?[2,t]:[2,new Uint8Array(t.buffer)]}})})},t.prototype.dispose=function(){this.isDisposed||(st().disposeTensor(this),this.isDisposedInternal=!0)},Object.defineProperty(t.prototype,"isDisposed",{get:function(){return this.isDisposedInternal},enumerable:!0,configurable:!0}),t.prototype.throwIfDisposed=function(){if(this.isDisposed)throw new Error("Tensor is disposed.")},t.prototype.toFloat=function(){return this.asType("float32")},t.prototype.toInt=function(){return this.asType("int32")},t.prototype.toBool=function(){return this.asType("bool")},t.prototype.print=function(t){return void 0===t&&(t=!1),ut.print(this,t)},t.prototype.reshape=function(t){return this.throwIfDisposed(),ut.reshape(this,t)},t.prototype.reshapeAs=function(t){return this.throwIfDisposed(),this.reshape(t.shape)},t.prototype.expandDims=function(t){return void 0===t&&(t=0),ut.expandDims(this,t)},t.prototype.cumsum=function(t,e,n){return void 0===t&&(t=0),void 0===e&&(e=!1),void 0===n&&(n=!1),ut.cumsum(this,t,e,n)},t.prototype.squeeze=function(t){return this.throwIfDisposed(),ut.squeeze(this,t)},t.prototype.clone=function(){return this.throwIfDisposed(),ut.clone(this)},t.prototype.oneHot=function(t,e,n){return this.throwIfDisposed(),ut.oneHot(this,t,e,n)},t.prototype.toString=function(t){return void 0===t&&(t=!1),function(t,e,n,r){var i=U(e),a=function(t,e,n,r){var i=v(e),a=r[r.length-1],o=new Array(a).fill(0),s=e.length,u="complex64"===n?at(t):t;if(s>1)for(var l=0;l<i/a;l++)for(var c=l*a,p=0;p<a;p++)o[p]=Math.max(o[p],rt(u[c+p],0,n).length);return o}(t,e,n,i),o=e.length,s=function t(e,n,r,i,a,o){void 0===o&&(o=!0);var s="complex64"===r?2:1,u=n[0],l=n.length;if(0===l)return"complex64"===r?[rt(at(e)[0],0,r)]:"bool"===r?[it(e[0])]:[e[0].toString()];if(1===l){if(u>tt){var c=et*s,p=Array.from(e.slice(0,c)),h=Array.from(e.slice(u-et*s,u));return"complex64"===r&&(p=at(p),h=at(h)),["["+p.map(function(t,e){return rt(t,a[e],r)}).join(", ")+", ..., "+h.map(function(t,e){return rt(t,a[u-et+e],r)}).join(", ")+"]"]}return["["+("complex64"===r?at(e):Array.from(e)).map(function(t,e){return rt(t,a[e],r)}).join(", ")+"]"]}var f=n.slice(1),d=i.slice(1),m=i[0]*s,g=[];if(u>tt){for(var v=0;v<et;v++){var y=(b=v*m)+m;g.push.apply(g,t(e.slice(b,y),f,r,d,a,!1))}for(g.push("..."),v=u-et;v<u;v++)y=(b=v*m)+m,g.push.apply(g,t(e.slice(b,y),f,r,d,a,v===u-1))}else for(v=0;v<u;v++){var b;y=(b=v*m)+m,g.push.apply(g,t(e.slice(b,y),f,r,d,a,v===u-1))}var x=2===l?",":"";for(g[0]="["+g[0]+x,v=1;v<g.length-1;v++)g[v]=" "+g[v]+x;var w=",\n";for(v=2;v<l;v++)w+="\n";return g[g.length-1]=" "+g[g.length-1]+"]"+(o?"":w),g}(t,e,n,i,a),u=["Tensor"];return r&&(u.push("  dtype: "+n),u.push("  rank: "+o),u.push("  shape: ["+e+"]"),u.push("  values:")),u.push(s.map(function(t){return"    "+t}).join("\n")),u.join("\n")}(this.dataSync(),this.shape,this.dtype,t)},t.prototype.tile=function(t){return this.throwIfDisposed(),ut.tile(this,t)},t.prototype.gather=function(t,e){return void 0===e&&(e=0),this.throwIfDisposed(),ut.gather(this,t,e)},t.prototype.matMul=function(t,e,n){return void 0===e&&(e=!1),void 0===n&&(n=!1),this.throwIfDisposed(),ut.matMul(this,t,e,n)},t.prototype.dot=function(t){return this.throwIfDisposed(),ut.dot(this,t)},t.prototype.norm=function(t,e,n){return void 0===t&&(t="euclidean"),void 0===e&&(e=null),void 0===n&&(n=!1),this.throwIfDisposed(),ut.norm(this,t,e,n)},t.prototype.slice=function(t,e){return this.throwIfDisposed(),ut.slice(this,t,e)},t.prototype.reverse=function(t){return this.throwIfDisposed(),ut.reverse(this,t)},t.prototype.concat=function(e,n){return void 0===n&&(n=0),this.throwIfDisposed(),e instanceof t&&(e=[e]),ut.concat([this].concat(e),n)},t.prototype.split=function(t,e){return void 0===e&&(e=0),this.throwIfDisposed(),ut.split(this,t,e)},t.prototype.stack=function(t,e){return void 0===e&&(e=0),ut.stack([this,t],e)},t.prototype.unstack=function(t){return void 0===t&&(t=0),ut.unstack(this,t)},t.prototype.pad=function(t,e){return void 0===e&&(e=0),ut.pad(this,t,e)},t.prototype.batchNormalization=function(t,e,n,r,i){return void 0===n&&(n=.001),lt("tf.batchNormalization() is going away. Use tf.batchNorm() instead, and note the positional argument change of scale, offset, and varianceEpsilon"),this.batchNorm(t,e,i,r,n)},t.prototype.batchNorm=function(t,e,n,r,i){return void 0===i&&(i=.001),this.throwIfDisposed(),ut.batchNorm(this,t,e,n,r,i)},t.prototype.all=function(t,e){return void 0===t&&(t=null),void 0===e&&(e=!1),this.throwIfDisposed(),ut.all(this,t,e)},t.prototype.any=function(t,e){return void 0===t&&(t=null),void 0===e&&(e=!1),this.throwIfDisposed(),ut.any(this,t,e)},t.prototype.logSumExp=function(t,e){return void 0===t&&(t=null),void 0===e&&(e=!1),this.throwIfDisposed(),ut.logSumExp(this,t,e)},t.prototype.sum=function(t,e){return void 0===t&&(t=null),void 0===e&&(e=!1),this.throwIfDisposed(),ut.sum(this,t,e)},t.prototype.prod=function(t,e){return void 0===t&&(t=null),void 0===e&&(e=!1),this.throwIfDisposed(),ut.prod(this,t,e)},t.prototype.mean=function(t,e){return void 0===t&&(t=null),void 0===e&&(e=!1),this.throwIfDisposed(),ut.mean(this,t,e)},t.prototype.min=function(t,e){return void 0===t&&(t=null),void 0===e&&(e=!1),this.throwIfDisposed(),ut.min(this,t,e)},t.prototype.max=function(t,e){return void 0===t&&(t=null),void 0===e&&(e=!1),this.throwIfDisposed(),ut.max(this,t,e)},t.prototype.argMin=function(t){return void 0===t&&(t=null),this.throwIfDisposed(),ut.argMin(this,t)},t.prototype.argMax=function(t){return void 0===t&&(t=null),this.throwIfDisposed(),ut.argMax(this,t)},t.prototype.cast=function(t){return this.throwIfDisposed(),ut.cast(this,t)},t.prototype.add=function(t){return this.throwIfDisposed(),ut.add(this,t)},t.prototype.addStrict=function(t){return this.throwIfDisposed(),ut.addStrict(this,t)},t.prototype.atan2=function(t){return this.throwIfDisposed(),ut.atan2(this,t)},t.prototype.sub=function(t){return this.throwIfDisposed(),ut.sub(this,t)},t.prototype.subStrict=function(t){return this.throwIfDisposed(),ut.subStrict(this,t)},t.prototype.pow=function(t){return this.throwIfDisposed(),ut.pow(this,t)},t.prototype.powStrict=function(t){return this.throwIfDisposed(),ut.powStrict(this,t)},t.prototype.mul=function(t){return this.throwIfDisposed(),ut.mul(this,t)},t.prototype.mulStrict=function(t){return this.throwIfDisposed(),ut.mulStrict(this,t)},t.prototype.div=function(t){return this.throwIfDisposed(),ut.div(this,t)},t.prototype.floorDiv=function(t){return this.throwIfDisposed(),ut.floorDiv(this,t)},t.prototype.divStrict=function(t){return this.throwIfDisposed(),ut.divStrict(this,t)},t.prototype.minimum=function(t){return this.throwIfDisposed(),ut.minimum(this,t)},t.prototype.minimumStrict=function(t){return this.throwIfDisposed(),ut.minimumStrict(this,t)},t.prototype.maximum=function(t){return this.throwIfDisposed(),ut.maximum(this,t)},t.prototype.maximumStrict=function(t){return this.throwIfDisposed(),ut.maximumStrict(this,t)},t.prototype.mod=function(t){return this.throwIfDisposed(),ut.mod(this,t)},t.prototype.modStrict=function(t){return this.throwIfDisposed(),ut.modStrict(this,t)},t.prototype.squaredDifference=function(t){return this.throwIfDisposed(),ut.squaredDifference(this,t)},t.prototype.squaredDifferenceStrict=function(t){return this.throwIfDisposed(),ut.squaredDifferenceStrict(this,t)},t.prototype.transpose=function(t){return this.throwIfDisposed(),ut.transpose(this,t)},t.prototype.notEqual=function(t){return this.throwIfDisposed(),ut.notEqual(this,t)},t.prototype.notEqualStrict=function(t){return this.throwIfDisposed(),ut.notEqualStrict(this,t)},t.prototype.less=function(t){return this.throwIfDisposed(),ut.less(this,t)},t.prototype.lessStrict=function(t){return this.throwIfDisposed(),ut.lessStrict(this,t)},t.prototype.equal=function(t){return this.throwIfDisposed(),ut.equal(this,t)},t.prototype.equalStrict=function(t){return this.throwIfDisposed(),ut.equalStrict(this,t)},t.prototype.lessEqual=function(t){return this.throwIfDisposed(),ut.lessEqual(this,t)},t.prototype.lessEqualStrict=function(t){return this.throwIfDisposed(),ut.lessEqualStrict(this,t)},t.prototype.greater=function(t){return this.throwIfDisposed(),ut.greater(this,t)},t.prototype.greaterStrict=function(t){return this.throwIfDisposed(),ut.greaterStrict(this,t)},t.prototype.greaterEqual=function(t){return this.throwIfDisposed(),ut.greaterEqual(this,t)},t.prototype.greaterEqualStrict=function(t){return this.throwIfDisposed(),ut.greaterEqualStrict(this,t)},t.prototype.logicalAnd=function(t){return this.throwIfDisposed(),ut.logicalAnd(this,t)},t.prototype.logicalOr=function(t){return this.throwIfDisposed(),ut.logicalOr(this,t)},t.prototype.logicalNot=function(){return this.throwIfDisposed(),ut.logicalNot(this)},t.prototype.logicalXor=function(t){return this.throwIfDisposed(),ut.logicalXor(this,t)},t.prototype.where=function(t,e){return this.throwIfDisposed(),ut.where(t,this,e)},t.prototype.neg=function(){return this.throwIfDisposed(),ut.neg(this)},t.prototype.ceil=function(){return this.throwIfDisposed(),ut.ceil(this)},t.prototype.floor=function(){return this.throwIfDisposed(),ut.floor(this)},t.prototype.sign=function(){return this.throwIfDisposed(),ut.sign(this)},t.prototype.isNaN=function(){return this.throwIfDisposed(),ut.isNaN(this)},t.prototype.isInf=function(){return this.throwIfDisposed(),ut.isInf(this)},t.prototype.isFinite=function(){return this.throwIfDisposed(),ut.isFinite(this)},t.prototype.exp=function(){return this.throwIfDisposed(),ut.exp(this)},t.prototype.expm1=function(){return this.throwIfDisposed(),ut.expm1(this)},t.prototype.log=function(){return this.throwIfDisposed(),ut.log(this)},t.prototype.log1p=function(){return this.throwIfDisposed(),ut.log1p(this)},t.prototype.sqrt=function(){return this.throwIfDisposed(),ut.sqrt(this)},t.prototype.rsqrt=function(){return this.throwIfDisposed(),ut.rsqrt(this)},t.prototype.square=function(){return this.throwIfDisposed(),ut.square(this)},t.prototype.reciprocal=function(){return this.throwIfDisposed(),ut.reciprocal(this)},t.prototype.abs=function(){return this.throwIfDisposed(),ut.abs(this)},t.prototype.clipByValue=function(t,e){return this.throwIfDisposed(),ut.clipByValue(this,t,e)},t.prototype.relu=function(){return this.throwIfDisposed(),ut.relu(this)},t.prototype.elu=function(){return this.throwIfDisposed(),ut.elu(this)},t.prototype.selu=function(){return this.throwIfDisposed(),ut.selu(this)},t.prototype.leakyRelu=function(t){return void 0===t&&(t=.2),this.throwIfDisposed(),ut.leakyRelu(this,t)},t.prototype.prelu=function(t){return this.throwIfDisposed(),ut.prelu(this,t)},t.prototype.sigmoid=function(){return this.throwIfDisposed(),ut.sigmoid(this)},t.prototype.logSigmoid=function(){return this.throwIfDisposed(),ut.logSigmoid(this)},t.prototype.softplus=function(){return this.throwIfDisposed(),ut.softplus(this)},t.prototype.zerosLike=function(){return this.throwIfDisposed(),ut.zerosLike(this)},t.prototype.onesLike=function(){return this.throwIfDisposed(),ut.onesLike(this)},t.prototype.sin=function(){return this.throwIfDisposed(),ut.sin(this)},t.prototype.cos=function(){return this.throwIfDisposed(),ut.cos(this)},t.prototype.tan=function(){return this.throwIfDisposed(),ut.tan(this)},t.prototype.asin=function(){return this.throwIfDisposed(),ut.asin(this)},t.prototype.acos=function(){return this.throwIfDisposed(),ut.acos(this)},t.prototype.atan=function(){return this.throwIfDisposed(),ut.atan(this)},t.prototype.sinh=function(){return this.throwIfDisposed(),ut.sinh(this)},t.prototype.cosh=function(){return this.throwIfDisposed(),ut.cosh(this)},t.prototype.tanh=function(){return this.throwIfDisposed(),ut.tanh(this)},t.prototype.asinh=function(){return this.throwIfDisposed(),ut.asinh(this)},t.prototype.acosh=function(){return this.throwIfDisposed(),ut.acosh(this)},t.prototype.atanh=function(){return this.throwIfDisposed(),ut.atanh(this)},t.prototype.erf=function(){return this.throwIfDisposed(),ut.erf(this)},t.prototype.round=function(){return this.throwIfDisposed(),ut.round(this)},t.prototype.step=function(t){return void 0===t&&(t=0),this.throwIfDisposed(),ut.step(this,t)},t.prototype.softmax=function(t){return void 0===t&&(t=-1),this.throwIfDisposed(),ut.softmax(this,t)},t.prototype.logSoftmax=function(t){return void 0===t&&(t=-1),this.throwIfDisposed(),ut.logSoftmax(this,t)},t.prototype.resizeBilinear=function(t,e){return void 0===e&&(e=!1),this.throwIfDisposed(),ut.image.resizeBilinear(this,t,e)},t.prototype.resizeNearestNeighbor=function(t,e){return void 0===e&&(e=!1),this.throwIfDisposed(),ut.image.resizeNearestNeighbor(this,t,e)},t.prototype.conv1d=function(t,e,n,r,i,a){return void 0===r&&(r="NWC"),void 0===i&&(i=1),this.throwIfDisposed(),ut.conv1d(this,t,e,n,r,i,a)},t.prototype.conv2d=function(t,e,n,r,i,a){return void 0===r&&(r="NHWC"),void 0===i&&(i=[1,1]),this.throwIfDisposed(),ut.conv2d(this,t,e,n,r,i,a)},t.prototype.conv2dTranspose=function(t,e,n,r,i){return this.throwIfDisposed(),ut.conv2dTranspose(this,t,e,n,r,i)},t.prototype.depthwiseConv2D=function(t,e,n,r,i,a){return void 0===r&&(r="NHWC"),void 0===i&&(i=[1,1]),this.throwIfDisposed(),ut.depthwiseConv2d(this,t,e,n,r,i,a)},t.prototype.separableConv2d=function(t,e,n,r,i,a){return void 0===i&&(i=[1,1]),void 0===a&&(a="NHWC"),this.throwIfDisposed(),ut.separableConv2d(this,t,e,n,r,i,a)},t.prototype.avgPool=function(t,e,n,r){return this.throwIfDisposed(),ut.avgPool(this,t,e,n,r)},t.prototype.maxPool=function(t,e,n,r){return this.throwIfDisposed(),ut.maxPool(this,t,e,n,r)},t.prototype.localResponseNormalization=function(t,e,n,r){return void 0===t&&(t=5),void 0===e&&(e=1),void 0===n&&(n=1),void 0===r&&(r=.5),ut.localResponseNormalization(this,t,e,n,r)},t.prototype.pool=function(t,e,n,r,i){return this.throwIfDisposed(),ut.pool(this,t,e,n,r,i)},t.prototype.variable=function(t,e,n){return void 0===t&&(t=!0),this.throwIfDisposed(),pt.variable(this,t,e,n)},t.prototype.unsortedSegmentSum=function(t,e){return this.throwIfDisposed(),ut.unsortedSegmentSum(this,t,e)},t.prototype.batchToSpaceND=function(t,e){return this.throwIfDisposed(),ut.batchToSpaceND(this,t,e)},t.prototype.spaceToBatchND=function(t,e){return this.throwIfDisposed(),ut.spaceToBatchND(this,t,e)},t.prototype.topk=function(t,e){return void 0===t&&(t=1),void 0===e&&(e=!0),this.throwIfDisposed(),ut.topk(this,t,e)},t.prototype.stridedSlice=function(t,e,n,r,i,a,o,s){return void 0===r&&(r=0),void 0===i&&(i=0),void 0===a&&(a=0),void 0===o&&(o=0),void 0===s&&(s=0),this.throwIfDisposed(),ut.stridedSlice(this,t,e,n,r,i,a,o,s)},t.prototype.depthToSpace=function(t,e){return this.throwIfDisposed(),ut.depthToSpace(this,t,e)},t.prototype.fft=function(){return this.throwIfDisposed(),ut.spectral.fft(this)},t.prototype.ifft=function(){return this.throwIfDisposed(),ut.spectral.ifft(this)},t.prototype.rfft=function(){return this.throwIfDisposed(),ut.spectral.rfft(this)},t.prototype.irfft=function(){return this.throwIfDisposed(),ut.spectral.irfft(this)},t}();Object.defineProperty(ct,Symbol.hasInstance,{value:function(t){return!!t&&null!=t.dataId&&null!=t.shape&&null!=t.dtype}});var pt=function(t){function e(e,n,r){void 0===n&&(n=!0);var i=t.call(this,e.shape,e.dtype,null,e.dataId)||this;i.trainable=n,i.name=r,null==i.name&&(i.name=st().nextVariableId().toString());try{st().registerVariable(i)}catch(t){throw st().disposeTensor(i),t}return i}return n(e,t),e.variable=function(t,n,r,i){return void 0===n&&(n=!0),null!=i&&i!==t.dtype&&(t=t.asType(i)),new e(t,n,r)},e.prototype.assign=function(t){if(t.dtype!==this.dtype)throw new Error("dtype of the new value ("+t.dtype+") and previous value ("+this.dtype+") must match");if(!y(t.shape,this.shape))throw new Error("shape of the new value ("+t.shape+") and previous value ("+this.shape+") must match");st().disposeTensor(this),this.dataId=t.dataId,st().registerTensor(this)},e.prototype.dispose=function(){st().disposeVariable(this),this.isDisposedInternal=!0},e}(ct);Object.defineProperty(pt,Symbol.hasInstance,{value:function(t){return t instanceof ct&&null!=t.assign&&t.assign instanceof Function}});var ht,ft,dt,mt,gt=pt.variable;!function(t){t.R0="R0",t.R1="R1",t.R2="R2",t.R3="R3",t.R4="R4",t.R5="R5",t.R6="R6"}(t.Rank||(t.Rank={})),function(t){t.float32="float32",t.int32="int32",t.bool="int32",t.complex64="complex64"}(ht||(ht={})),function(t){t.float32="float32",t.int32="int32",t.bool="bool",t.complex64="complex64"}(ft||(ft={})),function(t){t.float32="float32",t.int32="float32",t.bool="float32",t.complex64="complex64"}(dt||(dt={})),function(t){t.float32="complex64",t.int32="complex64",t.bool="complex64",t.complex64="complex64"}(mt||(mt={}));var vt={float32:dt,int32:ht,bool:ft,complex64:mt};function yt(t,e){if("string"===t||"string"===e){if("string"===t&&"string"===e)return"string";throw new Error("Can not upcast "+t+" with "+e)}return vt[t][e]}function bt(t){return yt(t,"int32")}function xt(t,e){if(t.dtype===e.dtype)return[t,e];var n=yt(t.dtype,e.dtype);return[t.cast(n),e.cast(n)]}function wt(t,e){f(t.dtype===e.dtype,function(){return"The dtypes of the first("+t.dtype+") and second("+e.dtype+") input must match"})}function Nt(t){var e=[];return function t(e,n,r){if(null!=e)if(e instanceof ct)n.push(e);else if(i=e,Array.isArray(i)||"object"==typeof i){var i,a=e;for(var o in a){var s=a[o];r.has(s)||(r.add(s),t(s,n,r))}}}(t,e,new Set),e}var Ct,Et=Object.freeze({makeTypesMatch:xt,assertTypesMatch:wt,isTensorInList:function(t,e){for(var n=0;n<e.length;n++)if(e[n].id===t.id)return!0;return!1},getTensorsInContainer:Nt}),St=function(){function t(){this.registeredVariables={},this.nextTapeNodeId=0,this.numBytes=0,this.numTensors=0,this.numStringTensors=0,this.numDataBuffers=0,this.gradientDepth=0,this.kernelDepth=0,this.scopeStack=[],this.nextScopeId=0,this.tensorInfo=new WeakMap,this.profiling=!1,this.activeProfile={newBytes:0,newTensors:0,peakBytes:0,kernels:[],result:null}}return t.prototype.dispose=function(){for(var t in this.registeredVariables)this.registeredVariables[t].dispose()},t}(),kt=function(){function t(t){this.ENV=t,this.registry={},this.registryFactory={},this.pendingBackendInitId=0,this.state=new St}return t.prototype.ready=function(){return r(this,void 0,void 0,function(){var t,e,n;return i(this,function(r){switch(r.label){case 0:if(null!=this.pendingBackendInit)return[2,this.pendingBackendInit.then(function(){})];if(null!=this.backendInstance)return[2];t=this.getSortedBackends(),e=0,r.label=1;case 1:return e<t.length?(n=t[e],[4,this.initializeBackend(n).success]):[3,5];case 2:return r.sent()?[4,this.setBackend(n)]:[3,4];case 3:return r.sent(),[2];case 4:return e++,[3,1];case 5:throw new Error("Could not initialize any backends, all backend initializations failed.")}})})},Object.defineProperty(t.prototype,"backend",{get:function(){if(null!=this.pendingBackendInit)throw new Error("Backend '"+this.backendName+"' has not yet been initialized. Make sure to await tf.ready() before calling other methods");if(null==this.backendInstance){var t=this.initializeBackendsAndReturnBest(),e=t.name;if(t.asyncInit)throw new Error("The highest priority backend '"+e+"' has not yet been initialized. Make sure to await tf.ready() before calling other methods");this.setBackend(e)}return this.backendInstance},enumerable:!0,configurable:!0}),t.prototype.backendNames=function(){return Object.keys(this.registryFactory)},t.prototype.findBackend=function(t){if(!(t in this.registry)){if(!(t in this.registryFactory))return null;if(this.initializeBackend(t).asyncInit)return null}return this.registry[t]},t.prototype.findBackendFactory=function(t){return t in this.registryFactory?this.registryFactory[t].factory:null},t.prototype.registerBackend=function(t,e,n){return void 0===n&&(n=1),t in this.registryFactory?(console.warn(t+" backend was already registered. Reusing existing backend factory."),!1):(this.registryFactory[t]={factory:e,priority:n},!0)},t.prototype.setBackend=function(t){return r(this,void 0,void 0,function(){var e,n,r;return i(this,function(i){switch(i.label){case 0:if(null==this.registryFactory[t])throw new Error("Backend name '"+t+"' not found in registry");return this.backendName=t,null!=this.registry[t]?[3,4]:(this.backendInstance=null,e=this.initializeBackend(t),n=e.success,e.asyncInit?[4,n]:[3,2]);case 1:return r=i.sent(),[3,3];case 2:r=n,i.label=3;case 3:if(!r)return[2,!1];i.label=4;case 4:return this.backendInstance=this.registry[t],this.profiler=new Z(this.backendInstance),[2,!0]}})})},t.prototype.initializeBackend=function(t){var e=this,n=this.registryFactory[t];if(null==n)throw new Error("Cannot initialize backend "+t+", no registration found.");try{var r=n.factory();if(Promise.resolve(r)===r){var i=++this.pendingBackendInitId,a=r.then(function(n){return!(i<e.pendingBackendInitId||(e.registry[t]=n,e.pendingBackendInit=null,0))}).catch(function(n){return!(i<e.pendingBackendInitId||(e.pendingBackendInit=null,console.warn("Initialization of backend "+t+" failed"),console.warn(n.stack||n.message),1))});return this.pendingBackendInit=a,{success:a,asyncInit:!0}}return this.registry[t]=r,{success:!0,asyncInit:!1}}catch(e){return console.warn("Initialization of backend "+t+" failed"),console.warn(e.stack||e.message),{success:!1,asyncInit:!1}}},t.prototype.removeBackend=function(t){if(!(t in this.registryFactory))throw new Error(t+" backend not found in registry");this.backendName===t&&null!=this.pendingBackendInit&&this.pendingBackendInitId++,t in this.registry&&(this.registry[t].dispose(),delete this.registry[t]),delete this.registryFactory[t],this.backendName===t&&(this.pendingBackendInit=null,this.backendName=null,this.backendInstance=null)},t.prototype.getSortedBackends=function(){var t=this;if(0===Object.keys(this.registryFactory).length)throw new Error("No backend found in registry.");return Object.keys(this.registryFactory).sort(function(e,n){return t.registryFactory[n].priority-t.registryFactory[e].priority})},t.prototype.initializeBackendsAndReturnBest=function(){for(var t=this.getSortedBackends(),e=0;e<t.length;e++){var n=t[e],r=this.initializeBackend(n),i=r.success,a=r.asyncInit;if(a||i)return{name:n,asyncInit:a}}throw new Error("Could not initialize any backends, all backend initializations failed.")},t.prototype.moveData=function(t,e){this.write(t,e,this.readSync(e))},t.prototype.tidy=function(t,e){var n,r=this,i=null;if(null==e){if("function"!=typeof t)throw new Error("Please provide a function to tidy()");e=t}else{if("string"!=typeof t&&!(t instanceof String))throw new Error("When calling with two arguments, the first argument to tidy() must be a string");if("function"!=typeof e)throw new Error("When calling with two arguments, the 2nd argument to tidy() must be a function");i=t}return this.scopedRun(function(){return r.startScope(i)},function(){return r.endScope(n)},function(){return(n=e())instanceof Promise&&console.error("Cannot return a Promise inside of tidy."),n})},t.prototype.scopedRun=function(t,e,n){t();try{var r=n();return e(),r}catch(t){throw e(),t}},t.prototype.nextTensorId=function(){return t.nextTensorId++},t.prototype.nextVariableId=function(){return t.nextVariableId++},t.prototype.clone=function(t){var e=ct.make(t.shape,{dataId:t.dataId},t.dtype);return this.addTapeNode([t],e,function(t){return[t.toFloat()]}),e},t.prototype.runKernel=function(t,e,n){var r,i=this,a=[],o=this.isTapeOn(),s=null!=this.state.activeScope?this.state.activeScope.name:"",u=function(t){o&&(a=t.map(function(t){return i.keep(i.clone(t))}))},l=this.state.numBytes,c=this.state.numTensors;if(this.scopedRun(function(){return i.state.kernelDepth++},function(){return i.state.kernelDepth--},function(){r=i.ENV.getBool("DEBUG")?i.profiler.profileKernel(s,e,function(){return t(i.backend,u)}):t(i.backend,u)}),o){var p={id:this.state.nextTapeNodeId++,name:s,inputs:e,outputs:Array.isArray(r)?r:[r],saved:a};null!=n&&(p.gradient=function(t){return n(t,a)}),this.state.activeTape.push(p)}return this.state.profiling&&this.state.activeProfile.kernels.push({name:s,bytesAdded:this.state.numBytes-l,totalBytesSnapshot:this.state.numBytes,tensorsAdded:this.state.numTensors-c,totalTensorsSnapshot:this.state.numTensors,inputShapes:Object.keys(e).map(function(t){return e[t].shape}),outputShape:Array.isArray(r)?r.map(function(t){return t.shape}):r.shape}),r},t.prototype.registerTensor=function(t,e){var n=this.state.tensorInfo.has(t.dataId)?this.state.tensorInfo.get(t.dataId).refCount:0;if(this.state.numTensors++,"string"===t.dtype&&this.state.numStringTensors++,0===n){this.state.numDataBuffers++;var r=0;"complex64"!==t.dtype&&"string"!==t.dtype&&(r=t.size*F(t.dtype)),this.state.tensorInfo.set(t.dataId,{backend:null!=e?e:this.backend,dtype:t.dtype,shape:t.shape,bytes:r,refCount:0}),this.state.numBytes+=r,null!=e?e.register(t.dataId,t.shape,t.dtype):this.backend.register(t.dataId,t.shape,t.dtype)}this.state.tensorInfo.get(t.dataId).refCount++,t instanceof pt||this.track(t)},t.prototype.registerVariable=function(t){if(null!=this.state.registeredVariables[t.name])throw new Error("Variable with name "+t.name+" was already registered");this.state.registeredVariables[t.name]=t},t.prototype.disposeTensor=function(t){if(this.state.tensorInfo.has(t.dataId)){this.state.numTensors--,"string"===t.dtype&&this.state.numStringTensors--;var e=this.state.tensorInfo.get(t.dataId);e.refCount<=1?("complex64"!==t.dtype&&(this.state.numBytes-=e.bytes),this.state.numDataBuffers--,e.backend.disposeData(t.dataId),this.state.tensorInfo.delete(t.dataId)):this.state.tensorInfo.get(t.dataId).refCount--}},t.prototype.disposeVariables=function(){for(var t in this.state.registeredVariables){var e=this.state.registeredVariables[t];this.disposeVariable(e)}},t.prototype.disposeVariable=function(t){this.disposeTensor(t),null!=this.state.registeredVariables[t.name]&&delete this.state.registeredVariables[t.name]},t.prototype.memory=function(){var t=this.backend.memory();return t.numTensors=this.state.numTensors,t.numDataBuffers=this.state.numDataBuffers,t.numBytes=this.state.numBytes,this.state.numStringTensors>0&&(t.unreliable=!0,null==t.reasons&&(t.reasons=[]),t.reasons.push("Memory usage by string tensors is approximate (2 bytes per character)")),t},t.prototype.profile=function(t){return r(this,void 0,void 0,function(){var e,n;return i(this,function(r){return this.state.profiling=!0,e=this.state.numBytes,n=this.state.numTensors,this.state.activeProfile.kernels=[],this.state.activeProfile.result=t(),this.state.profiling=!1,this.state.activeProfile.peakBytes=Math.max.apply(Math,this.state.activeProfile.kernels.map(function(t){return t.totalBytesSnapshot})),this.state.activeProfile.newBytes=this.state.numBytes-e,this.state.activeProfile.newTensors=this.state.numTensors-n,[2,this.state.activeProfile]})})},t.prototype.isTapeOn=function(){return this.state.gradientDepth>0&&0===this.state.kernelDepth},t.prototype.addTapeNode=function(t,e,n){var r={};t.forEach(function(t,e){r[e]=t});var i={id:this.state.nextTapeNodeId++,name:this.state.activeScope.name,inputs:r,outputs:[e],gradient:function(t){var e={};return n(t).forEach(function(t,n){e[n]=function(){return t}}),e}};this.state.activeTape.push(i)},t.prototype.keep=function(t){return t.kept=!0,t},t.prototype.startTape=function(){0===this.state.gradientDepth&&(this.state.activeTape=[]),this.state.gradientDepth++},t.prototype.endTape=function(){this.state.gradientDepth--},t.prototype.startScope=function(t){var e={track:[],name:"unnamed scope",id:this.state.nextScopeId++};t&&(e.name=t),this.state.scopeStack.push(e),this.state.activeScope=e},t.prototype.endScope=function(t){for(var e=this,n=Nt(t),r=new Set(n.map(function(t){return t.id})),i=0;i<this.state.activeScope.track.length;i++){var a=this.state.activeScope.track[i];a.kept||r.has(a.id)||a.dispose()}var o=this.state.scopeStack.pop();this.state.activeScope=0===this.state.scopeStack.length?null:this.state.scopeStack[this.state.scopeStack.length-1],n.forEach(function(t){t.kept||t.scopeId!==o.id||e.track(t)})},t.prototype.gradients=function(t,e,n,r){var i=this;if(void 0===r&&(r=!1),f(e.length>0,function(){return"gradients() received an empty list of xs."}),null!=n&&"float32"!==n.dtype)throw new Error("dy must have 'float32' dtype, but has '"+n.dtype+"'");var a=this.scopedRun(function(){return i.startTape()},function(){return i.endTape()},function(){return i.tidy("forward",t)});f(a instanceof ct,function(){return"The result y returned by f() must be a tensor."});var o=function(t,e,n){for(var r={},i={},a=0;a<e.length;a++)r[e[a].id]=!0;for(a=0;a<t.length;a++){var o=(d=t[a]).inputs;for(var s in o){for(var u=o[s],l=!1,c=0;c<e.length;c++)if(r[u.id]){d.outputs.forEach(function(t){return r[t.id]=!0}),l=!0,i[d.id]=!0;break}if(l)break}}var p={};p[n.id]=!0;var h={};for(a=t.length-1;a>=0;a--)for(o=(d=t[a]).inputs,c=0;c<d.outputs.length;c++)if(p[d.outputs[c].id]){for(var s in o)p[o[s].id]=!0,h[d.id]=!0;break}var f=[];for(a=0;a<t.length;a++){var d;if(i[(d=t[a]).id]&&h[d.id]){var m={};for(var s in d.inputs){var g=d.inputs[s];r[g.id]&&(m[s]=g)}var v=Object.assign({},d);v.inputs=m,v.outputs=d.outputs,f.push(v)}}return f}(this.state.activeTape,e,a);if(!r&&0===o.length&&e.length>0)throw new Error("Cannot compute gradient of y=f(x) with respect to x. Make sure that the f you passed encloses all operations that lead from x to y.");return this.tidy("backward",function(){var t,r,s={};s[a.id]=null==n?(r=H(v(t=a.shape),"float32"),ct.make(t,{values:r})):n,function(t,e,n){for(var r=function(r){var i=e[r],a=[];if(i.outputs.forEach(function(e){var n=t[e.id];if(null!=n)a.push(n);else{var r=ct.make(e.shape,{values:G(e.size,e.dtype)},e.dtype);a.push(r)}}),null==i.gradient)throw new Error("Cannot compute gradient: gradient function not found for "+i.name+".");var o=i.gradient(1===i.outputs.length?a[0]:a),s=function(e){if(!(e in o))throw new Error("Cannot backprop through input "+e+". Available gradients found: "+Object.keys(o)+".");var r=n(function(){return o[e]()});if("float32"!==r.dtype)throw new Error("Error in gradient for op "+i.name+". The gradient of input "+e+" must have 'float32' dtype, but has '"+r.dtype+"'");var a=i.inputs[e];if(!y(r.shape,a.shape))throw new Error("Error in gradient for op "+i.name+". The gradient of input '"+e+"' has shape '"+r.shape+"', which does not match the shape of the input '"+a.shape+"'");if(null==t[a.id])t[a.id]=r;else{var s=t[a.id];t[a.id]=s.add(r),s.dispose()}};for(var u in i.inputs)s(u)},i=e.length-1;i>=0;i--)r(i)}(s,o,function(t){return i.tidy(t)});var u=e.map(function(t){return s[t.id]});return 0===i.state.gradientDepth&&(i.state.activeTape.forEach(function(t){for(var e in t.saved)t.saved[e].dispose()}),i.state.activeTape=null),{value:a,grads:u}})},t.prototype.customGrad=function(t){var e=this;return f(V(t),function(){return"The f passed in customGrad(f) must be a function."}),function(){for(var n,r=[],i=0;i<arguments.length;i++)r[i]=arguments[i];f(r.every(function(t){return t instanceof ct}),function(){return"The args passed in customGrad(f)(x1, x2,...) must all be tensors"});var a={};return r.forEach(function(t,e){a[e]=t}),e.runKernel(function(e,i){return f((n=t.apply(void 0,r.concat([i]))).value instanceof ct,function(){return"The function f passed in customGrad(f) must return an object where `obj.value` is a tensor"}),f(V(n.gradFunc),function(){return"The function f passed in customGrad(f) must return an object where `obj.gradFunc` is a function."}),n.value},a,function(t,e){var i=n.gradFunc(t,e),a=Array.isArray(i)?i:[i];f(a.length===r.length,function(){return"The function f passed in customGrad(f) must return an object where `obj.gradFunc` is a function that returns the same number of tensors as inputs passed to f(...)."}),f(a.every(function(t){return t instanceof ct}),function(){return"The function f passed in customGrad(f) must return an object where `obj.gradFunc` is a function that returns a list of only tensors."});var o={};return a.forEach(function(t,e){o[e]=function(){return t}}),o})}},t.prototype.write=function(t,e,n){var r=this.state.tensorInfo.get(e),i=r.backend;if(t=t||this.backend,"string"===r.dtype){var a=M(n);this.state.numBytes+=a-r.bytes,r.bytes=a}t!==i&&(i.disposeData(e),r.backend=t,t.register(e,r.shape,r.dtype)),t.write(e,n)},t.prototype.readSync=function(t){return this.state.tensorInfo.get(t).backend.readSync(t)},t.prototype.read=function(t){return this.state.tensorInfo.get(t).backend.read(t)},t.prototype.fromPixels=function(t,e){return this.backend.fromPixels(t,e)},t.prototype.time=function(t){return r(this,void 0,void 0,function(){var e,n;return i(this,function(r){switch(r.label){case 0:return e=K(),[4,this.backend.time(t)];case 1:return(n=r.sent()).wallMs=K()-e,[2,n]}})})},t.prototype.track=function(t){return null!=this.state.activeScope&&(t.scopeId=this.state.activeScope.id,this.state.activeScope.track.push(t)),t},Object.defineProperty(t.prototype,"registeredVariables",{get:function(){return this.state.registeredVariables},enumerable:!0,configurable:!0}),t.prototype.reset=function(){for(var t in this.pendingBackendInitId++,this.state.dispose(),this.ENV.reset(),this.state=new St,this.registry)this.registry[t].dispose(),delete this.registry[t];this.backendName=null,this.backendInstance=null,this.pendingBackendInit=null},t.nextTensorId=0,t.nextVariableId=0,t}(),It=function(){var t=function(){if(null==Ct){var t=void 0;if("undefined"!=typeof window)t=window;else if("undefined"!=typeof global)t=global;else if("undefined"!=typeof process)t=process;else{if("undefined"==typeof self)throw new Error("Could not find a global object");t=self}Ct=t}return Ct}();if(null==t._tfengine){var e=new a(t);t._tfengine=new kt(e)}return s(t._tfengine.ENV),st=function(){return t._tfengine},t._tfengine}();function At(){return"undefined"!=typeof window&&null!=window.document||"undefined"!=typeof WorkerGlobalScope}t.ENV.registerFlag("DEBUG",function(){return!1},function(t){t&&console.warn("Debugging mode is ON. The output of every math call will be downloaded to CPU and checked for NaNs. This significantly impacts performance.")}),t.ENV.registerFlag("IS_BROWSER",function(){return At()}),t.ENV.registerFlag("IS_NODE",function(){return"undefined"!=typeof process&&void 0!==process.versions&&void 0!==process.versions.node}),t.ENV.registerFlag("IS_CHROME",function(){return"undefined"!=typeof navigator&&null!=navigator&&null!=navigator.userAgent&&/Chrome/.test(navigator.userAgent)&&/Google Inc/.test(navigator.vendor)}),t.ENV.registerFlag("PROD",function(){return!1}),t.ENV.registerFlag("TENSORLIKE_CHECK_SHAPE_CONSISTENCY",function(){return t.ENV.getBool("DEBUG")}),t.ENV.registerFlag("DEPRECATION_WARNINGS_ENABLED",function(){return!0}),t.ENV.registerFlag("IS_TEST",function(){return!1});var Rt,Tt,Dt={},Ot={alpha:!1,antialias:!1,premultipliedAlpha:!1,preserveDrawingBuffer:!1,depth:!1,stencil:!1,failIfMajorPerformanceCaveat:!0};function _t(t,e){Dt[t]=e}function Ft(t){t in Dt||(Dt[t]=function(t){if(1!==t&&2!==t)throw new Error("Cannot get WebGL rendering context, WebGL is disabled.");var e=Mt(t);return e.addEventListener("webglcontextlost",function(e){e.preventDefault(),delete Dt[t]},!1),1===t?e.getContext("webgl",Ot)||e.getContext("experimental-webgl",Ot):e.getContext("webgl2",Ot)}(t));var e=Dt[t];return e.isContextLost()?(delete Dt[t],Ft(t)):(e.disable(e.DEPTH_TEST),e.disable(e.STENCIL_TEST),e.disable(e.BLEND),e.disable(e.DITHER),e.disable(e.POLYGON_OFFSET_FILL),e.disable(e.SAMPLE_COVERAGE),e.enable(e.SCISSOR_TEST),e.enable(e.CULL_FACE),e.cullFace(e.BACK),Dt[t])}function Mt(t){if("undefined"!=typeof OffscreenCanvas&&2===t)return new OffscreenCanvas(300,150);if("undefined"!=typeof document)return document.createElement("canvas");throw new Error("Cannot create a canvas in this context")}function zt(t,e){return[e,t]}function Lt(t){var e=v(t);return w(Math.ceil(e/4))}function Pt(t,e){return[Math.max(1,Math.ceil(e/2)),Math.max(1,Math.ceil(t/2))]}function Bt(e,n){var r,i,a,o,s,u,l,c,p,h=e;return 2===t.ENV.getNumber("WEBGL_VERSION")?(r=h.R32F,i=h.R16F,a=h.RGBA16F,o=h.RGBA32F,s=h.RED,u=4,l=1,c=h.HALF_FLOAT,p=h.FLOAT):(r=e.RGBA,i=e.RGBA,a=e.RGBA,o=h.RGBA,s=e.RGBA,u=4,l=4,c=null!=n?n.HALF_FLOAT_OES:null,p=e.FLOAT),{internalFormatFloat:r,internalFormatHalfFloat:i,internalFormatPackedHalfFloat:a,internalFormatPackedFloat:o,textureFormatFloat:s,downloadTextureFormat:e.RGBA,downloadUnpackNumChannels:u,defaultNumChannels:l,textureTypeHalfFloat:c,textureTypeFloat:p}}function Vt(t,e,n){var r=n();return e&&function(t){var e=t.getError();if(e!==t.NO_ERROR)throw new Error("WebGL Error: "+qt(t,e))}(t),r}!function(t){t[t.RENDER=0]="RENDER",t[t.UPLOAD=1]="UPLOAD",t[t.PIXELS=2]="PIXELS",t[t.DOWNLOAD=3]="DOWNLOAD"}(Rt||(Rt={})),function(t){t[t.UNPACKED_FLOAT16=0]="UNPACKED_FLOAT16",t[t.UNPACKED_FLOAT32=1]="UNPACKED_FLOAT32",t[t.PACKED_4X1_UNSIGNED_BYTE=2]="PACKED_4X1_UNSIGNED_BYTE",t[t.PACKED_2X2_FLOAT32=3]="PACKED_2X2_FLOAT32",t[t.PACKED_2X2_FLOAT16=4]="PACKED_2X2_FLOAT16"}(Tt||(Tt={}));var Wt=5.96e-8,Ut=65504;function jt(e){return!!(t.ENV.getBool("WEBGL_RENDER_FLOAT32_ENABLED")||0===e||Wt<Math.abs(e)&&Math.abs(e)<Ut)}function qt(t,e){switch(e){case t.NO_ERROR:return"NO_ERROR";case t.INVALID_ENUM:return"INVALID_ENUM";case t.INVALID_VALUE:return"INVALID_VALUE";case t.INVALID_OPERATION:return"INVALID_OPERATION";case t.INVALID_FRAMEBUFFER_OPERATION:return"INVALID_FRAMEBUFFER_OPERATION";case t.OUT_OF_MEMORY:return"OUT_OF_MEMORY";case t.CONTEXT_LOST_WEBGL:return"CONTEXT_LOST_WEBGL";default:return"Unknown error code "+e}}function Ht(t,e,n){return de(t,e,function(){return t.getExtension(n)},'Extension "'+n+'" not supported on this browser.')}function Gt(t,e,n){var r=de(t,e,function(){return t.createShader(t.VERTEX_SHADER)},"Unable to create vertex WebGLShader.");if(Vt(t,e,function(){return t.shaderSource(r,n)}),Vt(t,e,function(){return t.compileShader(r)}),!1===t.getShaderParameter(r,t.COMPILE_STATUS))throw console.log(t.getShaderInfoLog(r)),new Error("Failed to compile vertex shader.");return r}function Kt(t,e,n){var r=de(t,e,function(){return t.createShader(t.FRAGMENT_SHADER)},"Unable to create fragment WebGLShader.");if(Vt(t,e,function(){return t.shaderSource(r,n)}),Vt(t,e,function(){return t.compileShader(r)}),!1===t.getShaderParameter(r,t.COMPILE_STATUS))throw function(t,e){var n=Yt.exec(e);if(null==n)return console.log("Couldn't parse line number in error: "+e),void console.log(t);for(var r=+n[1],i=t.split("\n"),a=i.length.toString().length+2,o=i.map(function(t,e){return N((e+1).toString(),a)+t}),s=0,u=0;u<o.length;u++)s=Math.max(o[u].length,s);var l=o.slice(0,r-1),c=o.slice(r-1,r),p=o.slice(r);console.log(l.join("\n")),console.log(e.split("\n")[0]),console.log("%c "+N(c[0],s),"border:1px solid red; background-color:#e3d2d2; color:#a61717"),console.log(p.join("\n"))}(n,t.getShaderInfoLog(r)),new Error("Failed to compile fragment shader.");return r}var $t,Xt,Yt=/ERROR: [0-9]+:([0-9]+):/g;function Jt(t,e){return de(t,e,function(){return t.createProgram()},"Unable to create WebGLProgram.")}function Zt(t,e,n){if(Vt(t,e,function(){return t.linkProgram(n)}),!1===t.getProgramParameter(n,t.LINK_STATUS))throw console.log(t.getProgramInfoLog(n)),new Error("Failed to link vertex and fragment shaders.")}function Qt(t,e,n){if(Vt(t,e,function(){return t.validateProgram(n)}),!1===t.getProgramParameter(n,t.VALIDATE_STATUS))throw console.log(t.getProgramInfoLog(n)),new Error("Shader program validation failed.")}function te(t,e,n){var r=de(t,e,function(){return t.createBuffer()},"Unable to create WebGLBuffer");return Vt(t,e,function(){return t.bindBuffer(t.ARRAY_BUFFER,r)}),Vt(t,e,function(){return t.bufferData(t.ARRAY_BUFFER,n,t.STATIC_DRAW)}),r}function ee(t,e,n){var r=de(t,e,function(){return t.createBuffer()},"Unable to create WebGLBuffer");return Vt(t,e,function(){return t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,r)}),Vt(t,e,function(){return t.bufferData(t.ELEMENT_ARRAY_BUFFER,n,t.STATIC_DRAW)}),r}function ne(t,e){return de(t,e,function(){return t.createTexture()},"Unable to create WebGLTexture.")}function re(e,n){var r=t.ENV.getNumber("WEBGL_MAX_TEXTURE_SIZE");if(e<=0||n<=0){var i="["+e+"x"+n+"]";throw new Error("Requested texture size "+i+" is invalid.")}if(e>r||n>r)throw i="["+e+"x"+n+"]",new Error("Requested texture size "+i+" greater than WebGL maximum on this browser / GPU ["+r+"x"+r+"].")}function ie(t,e){return de(t,e,function(){return t.createFramebuffer()},"Unable to create WebGLFramebuffer.")}function ae(t,e,n,r,i,a,o,s){var u=t.getAttribLocation(n,r);return-1!==u&&(Vt(t,e,function(){return t.bindBuffer(t.ARRAY_BUFFER,i)}),Vt(t,e,function(){return t.vertexAttribPointer(u,a,t.FLOAT,!1,o,s)}),Vt(t,e,function(){return t.enableVertexAttribArray(u)}),!0)}function oe(t,e,n,r){me(t,r),Vt(t,e,function(){return t.activeTexture(t.TEXTURE0+r)}),Vt(t,e,function(){return t.bindTexture(t.TEXTURE_2D,n)})}function se(t,e,n,r){return de(t,e,function(){return t.getUniformLocation(n,r)},'uniform "'+r+'" not present in program.')}function ue(t,e,n){return t.getUniformLocation(e,n)}function le(t,e,n,r,i,a){Vt(t,e,function(){return oe(t,e,r,a)}),Vt(t,e,function(){return t.uniform1i(i,a)})}function ce(t,e,n,r){Vt(t,e,function(){return t.bindFramebuffer(t.FRAMEBUFFER,r)}),Vt(t,e,function(){return t.framebufferTexture2D(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.TEXTURE_2D,n,0)})}function pe(t,e,n){Vt(t,e,function(){return t.bindFramebuffer(t.FRAMEBUFFER,n)}),Vt(t,e,function(){return t.framebufferTexture2D(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.TEXTURE_2D,null,0)})}function he(t){var e=t.checkFramebufferStatus(t.FRAMEBUFFER);if(e!==t.FRAMEBUFFER_COMPLETE)throw new Error("Error binding framebuffer: "+fe(t,e))}function fe(t,e){switch(e){case t.FRAMEBUFFER_INCOMPLETE_ATTACHMENT:return"FRAMEBUFFER_INCOMPLETE_ATTACHMENT";case t.FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT:return"FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT";case t.FRAMEBUFFER_INCOMPLETE_DIMENSIONS:return"FRAMEBUFFER_INCOMPLETE_DIMENSIONS";case t.FRAMEBUFFER_UNSUPPORTED:return"FRAMEBUFFER_UNSUPPORTED";default:return"unknown error "+e}}function de(t,e,n,r){var i=Vt(t,e,function(){return n()});if(null==i)throw new Error(r);return i}function me(t,e){var n=t.MAX_COMBINED_TEXTURE_IMAGE_UNITS-1,r=e+t.TEXTURE0;if(r<t.TEXTURE0||r>n)throw new Error("textureUnit must be in [gl.TEXTURE0, gl.TEXTURE"+n+"].")}function ge(t,e){return void 0===e&&(e=2),v(t.slice(0,t.length-e))}function ve(t){if(0===t.length)throw Error("Cannot get rows and columns of an empty shape array.");return[t.length>1?t[t.length-2]:1,t[t.length-1]]}function ye(t){var e=[1,1,1];return 0===t.length||1===t.length&&1===t[0]||(e=[ge(t)].concat(ve(t))),e}function be(e,n){var r;void 0===n&&(n=!1);var i=t.ENV.getNumber("WEBGL_MAX_TEXTURE_SIZE");if(n&&(i*=2,1===(e=e.map(function(t,n){return n>=e.length-2?p(e[n]):e[n]})).length&&(e=[2,e[0]])),2!==e.length){var a=k(e);e=a.newShape}var o=v(e);if(e.length<=1&&o<=i)return[1,o];if(2===e.length&&e[0]<=i&&e[1]<=i)return e;if(3===e.length&&e[0]*e[1]<=i&&e[2]<=i)return[e[0]*e[1],e[2]];if(3===e.length&&e[0]<=i&&e[1]*e[2]<=i)return[e[0],e[1]*e[2]];if(4===e.length&&e[0]*e[1]*e[2]<=i&&e[3]<=i)return[e[0]*e[1]*e[2],e[3]];if(4===e.length&&e[0]<=i&&e[1]*e[2]*e[3]<=i)return[e[0],e[1]*e[2]*e[3]];if(n){var s=ge(e),u=2,l=2;return e.length&&(u=(r=ve(e))[0],l=r[1]),w(o=s*(u/2)*(l/2)).map(function(t){return 2*t})}return w(o)}function xe(t){return t%2==0}function we(t,e){if(y(t=t.slice(-2),e=e.slice(-2)))return!0;if(!t.length||!e.length)return!0;if(0===t[0]||0===t[1]||0===e[0]||0===e[1])return!0;if(t.length!==e.length){var n=t.slice(-1)[0],r=e.slice(-1)[0];if(n===r)return!0;if(xe(n)&&xe(r)&&(1===t[0]||1===e[0]))return!0}return t[1]===e[1]&&xe(t[0])&&xe(e[0])}function Ne(t){if(null==$t){var e=Ft(t);$t=e.getParameter(e.MAX_TEXTURE_SIZE)}return $t}function Ce(t){if(null==Xt){var e=Ft(t);Xt=e.getParameter(e.MAX_TEXTURE_IMAGE_UNITS)}return Math.min(16,Xt)}function Ee(t){if(0===t)return 0;var e=Ft(t);return Se(e,"EXT_disjoint_timer_query_webgl2")&&2===t?2:Se(e,"EXT_disjoint_timer_query")?1:0}function Se(t,e){return null!=t.getExtension(e)}function ke(t){try{if(null!=Ft(t))return!0}catch(t){return!1}return!1}function Ie(t){if(0===t)return!1;var e=Ft(t);if(1===t){if(!Se(e,"OES_texture_float"))return!1}else if(!Se(e,"EXT_color_buffer_float"))return!1;return Re(e)}function Ae(t){if(0===t)return!1;var e=Ft(t);return 1!==t?Se(e,"EXT_color_buffer_float")?Re(e):!!Se(e,"EXT_color_buffer_half_float")&&function(t,e){var n=Bt(t,e),r=t.createTexture();t.bindTexture(t.TEXTURE_2D,r),t.texImage2D(t.TEXTURE_2D,0,n.internalFormatHalfFloat,1,1,0,n.textureFormatFloat,n.textureTypeHalfFloat,null);var i=t.createFramebuffer();t.bindFramebuffer(t.FRAMEBUFFER,i),t.framebufferTexture2D(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.TEXTURE_2D,r,0);var a=t.checkFramebufferStatus(t.FRAMEBUFFER)===t.FRAMEBUFFER_COMPLETE;return t.bindTexture(t.TEXTURE_2D,null),t.bindFramebuffer(t.FRAMEBUFFER,null),t.deleteTexture(r),t.deleteFramebuffer(i),a}(e,e.getExtension("EXT_color_buffer_half_float")):!!Se(e,"OES_texture_float")&&!!Se(e,"WEBGL_color_buffer_float")&&Re(e)}function Re(t){var e=Bt(t),n=t.createTexture();t.bindTexture(t.TEXTURE_2D,n),t.texImage2D(t.TEXTURE_2D,0,e.internalFormatFloat,1,1,0,e.textureFormatFloat,e.textureTypeFloat,null);var r=t.createFramebuffer();t.bindFramebuffer(t.FRAMEBUFFER,r),t.framebufferTexture2D(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.TEXTURE_2D,n,0);var i=t.checkFramebufferStatus(t.FRAMEBUFFER)===t.FRAMEBUFFER_COMPLETE;return t.bindTexture(t.TEXTURE_2D,null),t.bindFramebuffer(t.FRAMEBUFFER,null),t.deleteTexture(n),t.deleteFramebuffer(r),i}function Te(t){return 2===t&&null!=Ft(t).fenceSync}var De=Object.freeze({callAndCheck:Vt,canBeRepresented:jt,getWebGLErrorMessage:qt,getExtensionOrThrow:Ht,createVertexShader:Gt,createFragmentShader:Kt,createProgram:Jt,linkProgram:Zt,validateProgram:Qt,createStaticVertexBuffer:te,createStaticIndexBuffer:ee,getNumChannels:function(){return 2===t.ENV.getNumber("WEBGL_VERSION")?1:4},createTexture:ne,validateTextureSize:re,createFramebuffer:ie,bindVertexBufferToProgramAttribute:ae,bindTextureUnit:oe,unbindTextureUnit:function(t,e,n){me(t,n),Vt(t,e,function(){return t.activeTexture(t.TEXTURE0+n)}),Vt(t,e,function(){return t.bindTexture(t.TEXTURE_2D,null)})},getProgramUniformLocationOrThrow:se,getProgramUniformLocation:ue,bindTextureToProgramUniformSampler:le,bindCanvasToFramebuffer:function(t,e){Vt(t,e,function(){return t.bindFramebuffer(t.FRAMEBUFFER,null)}),Vt(t,e,function(){return t.viewport(0,0,t.canvas.width,t.canvas.height)}),Vt(t,e,function(){return t.scissor(0,0,t.canvas.width,t.canvas.height)})},bindColorTextureToFramebuffer:ce,unbindColorTextureFromFramebuffer:pe,validateFramebuffer:he,getFramebufferErrorMessage:fe,getBatchDim:ge,getRowsCols:ve,getShapeAs3D:ye,getTextureShapeFromLogicalShape:be,isReshapeFree:we,getWebGLMaxTextureSize:Ne,resetMaxTextureSize:function(){$t=null},resetMaxTexturesInShader:function(){Xt=null},getMaxTexturesInShader:Ce,getWebGLDisjointQueryTimerVersion:Ee,hasExtension:Se,isWebGLVersionEnabled:ke,isRenderToFloatTextureEnabled:Ie,isDownloadFloatTextureEnabled:Ae,isWebGLFenceEnabled:Te});function Oe(e){t.ENV.getBool("DEPRECATION_WARNINGS_ENABLED")&&console.warn(e+" You can disable deprecation warnings with tf.disableDeprecationWarnings().")}function _e(){return It.memory()}function Fe(t,e){return It.tidy(t,e)}function Me(t){Nt(t).forEach(function(t){return t.dispose()})}function ze(t){return It.keep(t)}function Le(){return It.backend}function Pe(){for(var e=[],n=0;n<arguments.length;n++)e[n]=arguments[n];t.ENV.getBool("IS_TEST")||console.warn.apply(console,e)}function Be(e,n){var r=e;if(_(e))return"string"===n?[]:[e.length];if(!Array.isArray(e))return[];for(var i=[];Array.isArray(r)||_(r)&&"string"!==n;)i.push(r.length),r=r[0];return Array.isArray(e)&&t.ENV.getBool("TENSORLIKE_CHECK_SHAPE_CONSISTENCY")&&function t(e,n,r){if(r=r||[],Array.isArray(e)||_(e)){f(n.length>0,function(){return"Element arr["+r.join("][")+"] should be a primitive, but is an array of "+e.length+" elements"}),f(e.length===n[0],function(){return"Element arr["+r.join("][")+"] should have "+n[0]+" elements, but has "+e.length+" elements"});for(var i=n.slice(1),a=0;a<e.length;++a)t(e[a],i,r.concat(a))}else f(0===n.length,function(){return"Element arr["+r.join("][")+"] is a primitive, but should be an array/TypedArray of "+n[0]+" elements"})}(e,i,[]),i}function Ve(t,e,n,r){if(null!=t&&("numeric"!==t&&t!==e||"numeric"===t&&"string"===e))throw new Error("Argument '"+n+"' passed to '"+r+"' must be "+t+" tensor, but got "+e+" tensor")}function We(e,n,r,i){if(void 0===i&&(i="numeric"),e instanceof ct)return Ve(i,e.dtype,n,r),e;var a=B(e);if("string"!==a&&["bool","int32","float32"].indexOf(i)>=0&&(a=i),Ve(i,a,n,r),null==e||!_(e)&&!Array.isArray(e)&&"number"!=typeof e&&"boolean"!=typeof e&&"string"!=typeof e){var o=null==e?"null":e.constructor.name;throw new Error("Argument '"+n+"' passed to '"+r+"' must be a Tensor or TensorLike, but got '"+o+"'")}var s=Be(e,a);_(e)||Array.isArray(e)||(e=[e]);var u="string"!==a?j(e,a,t.ENV.getBool("DEBUG")):g(e,[],!0);return ct.make(s,{values:u},a)}function Ue(t,e,n,r){if(void 0===r&&(r="numeric"),!Array.isArray(t))throw new Error("Argument "+e+" passed to "+n+" must be a `Tensor[]` or `TensorLike[]`");return t.map(function(t,r){return We(t,e+"["+r+"]",n)},r)}function je(t,e){for(var n=0;n<t.length;++n)if(t[t.length-n-1]!==e-1-n)return!1;return!0}function qe(t,e,n){for(var r=t.length+e.length,i=[],a=0,o=0,s=0;s<r;s++)-1===n.indexOf(s)?i.push(t[a++]):i.push(e[o++]);return i}function He(t,e){for(var n=[],r=t.length,i=0;i<r;i++)-1===e.indexOf(i)&&n.push(t[i]);return[n,e.map(function(e){return t[e]})]}function Ge(t,e){return qe(t,e.map(function(t){return 1}),e)}function Ke(t,e,n){f(je(e,n),function(){return t+" supports only inner-most axes for now. Got axes "+e+" and rank-"+n+" input."})}function $e(t,e){if(je(t,e))return null;for(var n=[],r=0;r<e;++r)-1===t.indexOf(r)&&n.push(r);return t.forEach(function(t){return n.push(t)}),n}function Xe(t){return t.map(function(t,e){return[e,t]}).sort(function(t,e){return t[1]-e[1]}).map(function(t){return t[0]})}function Ye(t,e){for(var n=[],r=e-t;r<e;++r)n.push(r);return n}function Je(t,e){var n=t[0].length;t.forEach(function(t,e){f(t.length===n,function(){return"Error in concat"+n+"D: rank of tensors["+e+"] must be the same as the rank of the rest ("+n+")"})}),f(e>=0&&e<n,function(){return"Error in concat"+n+"D: axis must be between 0 and "+(n-1)+"."});var r=t[0];t.forEach(function(t,i){for(var a=0;a<n;a++)f(a===e||t[a]===r[a],function(){return"Error in concat"+n+"D: Shape of tensors["+i+"] ("+t+") does not match the shape of the rest ("+r+") along the non-concatenated axis "+i+"."})})}function Ze(t,e){for(var n=t[0].slice(),r=1;r<t.length;r++)n[e]+=t[r][e];return n}function Qe(t){var e=Object.keys(t);if(1!==e.length)throw new Error("Please provide an object with a single key (operation name) mapping to a function. Got an object with "+e.length+" keys.");var n=e[0],r=t[n];n.endsWith("_")&&(n=n.substring(0,n.length-1));var i=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];It.startScope(n);try{var i=r.apply(void 0,t);return i instanceof Promise&&console.error("Cannot return a Promise inside of tidy."),It.endScope(i),i}catch(t){throw It.endScope(null),t}};return Object.defineProperty(i,"name",{value:n,configurable:!0}),i}t.ENV.registerFlag("HAS_WEBGL",function(){return t.ENV.getNumber("WEBGL_VERSION")>0}),t.ENV.registerFlag("WEBGL_VERSION",function(){return ke(2)?2:ke(1)?1:0}),t.ENV.registerFlag("WEBGL_BUFFER_SUPPORTED",function(){return 2===t.ENV.get("WEBGL_VERSION")}),t.ENV.registerFlag("WEBGL_CPU_FORWARD",function(){return!0}),t.ENV.registerFlag("WEBGL_PACK",function(){return t.ENV.getBool("HAS_WEBGL")}),t.ENV.registerFlag("WEBGL_PACK_NORMALIZATION",function(){return t.ENV.getBool("WEBGL_PACK")}),t.ENV.registerFlag("WEBGL_PACK_CLIP",function(){return t.ENV.getBool("WEBGL_PACK")}),t.ENV.registerFlag("WEBGL_PACK_DEPTHWISECONV",function(){return!1}),t.ENV.registerFlag("WEBGL_PACK_BINARY_OPERATIONS",function(){return t.ENV.getBool("WEBGL_PACK")}),t.ENV.registerFlag("WEBGL_PACK_ARRAY_OPERATIONS",function(){return t.ENV.getBool("WEBGL_PACK")}),t.ENV.registerFlag("WEBGL_PACK_IMAGE_OPERATIONS",function(){return t.ENV.getBool("WEBGL_PACK")}),t.ENV.registerFlag("WEBGL_PACK_REDUCE",function(){return t.ENV.getBool("WEBGL_PACK")}),t.ENV.registerFlag("WEBGL_LAZILY_UNPACK",function(){return t.ENV.getBool("WEBGL_PACK")}),t.ENV.registerFlag("WEBGL_CONV_IM2COL",function(){return t.ENV.getBool("WEBGL_PACK")}),t.ENV.registerFlag("WEBGL_MAX_TEXTURE_SIZE",function(){return Ne(t.ENV.getNumber("WEBGL_VERSION"))}),t.ENV.registerFlag("WEBGL_MAX_TEXTURES_IN_SHADER",function(){return Ce(t.ENV.getNumber("WEBGL_VERSION"))}),t.ENV.registerFlag("WEBGL_DISJOINT_QUERY_TIMER_EXTENSION_VERSION",function(){var e=t.ENV.getNumber("WEBGL_VERSION");return 0===e?0:Ee(e)}),t.ENV.registerFlag("WEBGL_DISJOINT_QUERY_TIMER_EXTENSION_RELIABLE",function(){return t.ENV.getNumber("WEBGL_DISJOINT_QUERY_TIMER_EXTENSION_VERSION")>0&&(e=navigator.userAgent||navigator.vendor||window.opera,!(/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|lge |maemo|midp|mmp|mobile.+firefox|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows ce|xda|xiino/i.test(e)||/1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(e.substr(0,4))));var e}),t.ENV.registerFlag("WEBGL_RENDER_FLOAT32_ENABLED",function(){return Ie(t.ENV.getNumber("WEBGL_VERSION"))}),t.ENV.registerFlag("WEBGL_DOWNLOAD_FLOAT_ENABLED",function(){return Ae(t.ENV.getNumber("WEBGL_VERSION"))}),t.ENV.registerFlag("WEBGL_FENCE_API_ENABLED",function(){return Te(t.ENV.getNumber("WEBGL_VERSION"))}),t.ENV.registerFlag("WEBGL_SIZE_UPLOAD_UNIFORM",function(){return t.ENV.getBool("WEBGL_RENDER_FLOAT32_ENABLED")?4:0}),lt=Oe;var tn=Qe({complex_:function(t,e){var n=We(t,"real","complex"),r=We(e,"imag","complex");return d(n.shape,r.shape,"real and imag shapes, "+n.shape+" and "+r.shape+", must match in call to tf.complex()."),It.runKernel(function(t){return t.complex(n,r)},{$real:n,$imag:r})}}),en=Qe({real_:function(t){var e=We(t,"input","real");return It.runKernel(function(t){return t.real(e)},{$input:e})}}),nn=Qe({imag_:function(t){var e=We(t,"input","imag");return It.runKernel(function(t){return t.imag(e)},{$input:e})}});function rn(t,e,n){return an(t,e,Be(t,n),n)}function an(e,n,r,i){if(null==i&&(i=B(e)),"complex64"===i)throw new Error("Cannot construct a complex64 tensor directly. Please use tf.complex(real, imag).");if(!_(e)&&!Array.isArray(e)&&"number"!=typeof e&&"boolean"!=typeof e&&"string"!=typeof e)throw new Error("values passed to tensor(values) must be a number/boolean/string or an array of numbers/booleans/strings, or a TypedArray");if(null!=n){$(n);var a=v(n),o=v(r);f(a===o,function(){return"Based on the provided shape, ["+n+"], the tensor should have "+a+" values but has "+o});for(var s=0;s<r.length;++s){var u=r[s],l=s!==r.length-1||u!==v(n.slice(s));f(r[s]===n[s]||!l,function(){return"Error creating a new Tensor. Inferred shape ("+r+") does not match the provided shape ("+n+"). "})}}return _(e)||Array.isArray(e)||(e=[e]),n=n||r,e="string"!==i?j(e,i,t.ENV.getBool("DEBUG")):g(e,[],!0),ct.make(n,{values:e},i)}function on(t,e){if((_(t)&&"string"!==e||Array.isArray(t))&&"complex64"!==e)throw new Error("Error creating a new Scalar: value must be a primitive (number|boolean|string)");if("string"===e&&_(t)&&!(t instanceof Uint8Array))throw new Error("When making a scalar from encoded string, the value must be `Uint8Array`.");return an(t,[],[],e)}function sn(t,e){m(t);var n=Be(t,e);if(1!==n.length)throw new Error("tensor1d() requires values to be a flat/TypedArray");return an(t,null,n,e)}function un(t,e,n){if(m(t),null!=e&&2!==e.length)throw new Error("tensor2d() requires shape to have two numbers");var r=Be(t,n);if(2!==r.length&&1!==r.length)throw new Error("tensor2d() requires values to be number[][] or flat/TypedArray");if(1===r.length&&null==e)throw new Error("tensor2d() requires shape to be provided when `values` are a flat/TypedArray");return an(t,e,r,n)}function ln(t,e,n){if(m(t),null!=e&&3!==e.length)throw new Error("tensor3d() requires shape to have three numbers");var r=Be(t,n);if(3!==r.length&&1!==r.length)throw new Error("tensor3d() requires values to be number[][][] or flat/TypedArray");if(1===r.length&&null==e)throw new Error("tensor3d() requires shape to be provided when `values` are a flat array");return an(t,e,r,n)}function cn(t,e,n){if(m(t),null!=e&&4!==e.length)throw new Error("tensor4d() requires shape to have four numbers");var r=Be(t,n);if(4!==r.length&&1!==r.length)throw new Error("tensor4d() requires values to be number[][][][] or flat/TypedArray");if(1===r.length&&null==e)throw new Error("tensor4d() requires shape to be provided when `values` are a flat array");return an(t,e,r,n)}function pn(t,e,n){if(m(t),null!=e&&5!==e.length)throw new Error("tensor5d() requires shape to have five numbers");var r=Be(t,n);if(5!==r.length&&1!==r.length)throw new Error("tensor5d() requires values to be number[][][][][] or flat/TypedArray");if(1===r.length&&null==e)throw new Error("tensor5d() requires shape to be provided when `values` are a flat array");return an(t,e,r,n)}function hn(t,e,n){if(m(t),null!=e&&6!==e.length)throw new Error("tensor6d() requires shape to have six numbers");var r=Be(t,n);if(6!==r.length&&1!==r.length)throw new Error("tensor6d() requires values to be number[][][][][][] or flat/TypedArray");if(1===r.length&&null==e)throw new Error("tensor6d() requires shape to be provided when `values` are a flat array");return an(t,e=e||r,r,n)}function fn(t,e){if(void 0===e&&(e="float32"),"complex64"===e){var n=fn(t,"float32"),r=dn(t,"float32");return tn(n,r)}var i=H(v(t),e);return ct.make(t,{values:i},e)}function dn(t,e){if(void 0===e&&(e="float32"),"complex64"===e){var n=dn(t,"float32"),r=dn(t,"float32");return tn(n,r)}var i=G(v(t),e);return ct.make(t,{values:i},e)}function mn(t,e,n){return It.runKernel(function(r){return r.fill(t,e,n)},{})}function gn(t,e,n){if(n<=0)throw new Error("The number of values should be positive.");return It.runKernel(function(r){return r.linspace(t,e,n)},{})}function vn(t,e,n,r){if(void 0===n&&(n=1),void 0===r&&(r="float32"),0===n)throw new Error("Cannot have a step of zero");if(t===e||t<e&&n<0||e<t&&n>1)return dn([0],r);var i=G(Math.abs(Math.ceil((e-t)/n)),r);e<t&&1===n&&(n=-1),i[0]=t;for(var a=1;a<i.length;a++)i[a]=i[a-1]+n;return sn(i,r)}var yn=Qe({onesLike_:function(t){var e=We(t,"x","onesLike");if("complex64"===e.dtype){var n=yn(en(e)),r=bn(nn(e));return tn(n,r)}return It.runKernel(function(t){return t.onesLike(e)},{$x:e},function(t,e){return{$x:function(){return bn(t)}}})}}),bn=Qe({zerosLike_:function(t){var e=We(t,"x","zerosLike");return It.runKernel(function(t){return t.zerosLike(e)},{$x:e},function(t,e){return{$x:function(){return bn(t)}}})}}),xn=Qe({concat_:function(t,e){void 0===e&&(e=0),f(t.length>=1,function(){return"Pass at least one tensor to concat"});var n=Ue(t,"tensors","concat");"complex64"===n[0].dtype&&n.forEach(function(t){if("complex64"!==t.dtype)throw new Error("Cannot concatenate complex64 tensors with a tensor\n          with dtype "+t.dtype+". ")}),e=S(e,n[0].shape)[0];var r=Ze(n.map(function(t){return t.shape}),e);if(0===v(r))return rn([],r);if(1===(n=n.filter(function(t){return t.size>0})).length)return n[0];var i=n.map(function(t){return t.shape});Je(i,e);var a=n;return It.runKernel(function(t){return t.concat(n,e)},a,function(t){var n=i.map(function(t){return t[e]});return Sn(t,n,e).map(function(t){return function(){return t}})})}}),wn=Qe({concat1d_:function(t){return xn(t,0)}}),Nn=Qe({concat2d_:function(t,e){return xn(t,e)}}),Cn=Qe({concat3d_:function(t,e){return xn(t,e)}}),En=Qe({concat4d_:function(t,e){return xn(t,e)}}),Sn=Qe({split_:function(t,e,n){void 0===n&&(n=0);var r,i=We(t,"x","split");return n=S(n,i.shape)[0],"number"==typeof e?(f(i.shape[n]%e==0,function(){return"Number of splits must evenly divide the axis."}),r=new Array(e).fill(i.shape[n]/e)):(f(i.shape[n]===e.reduce(function(t,e){return t+e}),function(){return"The sum of sizes must match the size of the axis dimension."}),r=e),It.runKernel(function(t){return t.split(i,r,n)},{$x:i},function(t){return{$x:function(){return xn(t,n)}}})}});function kn(t,e){return t(e={exports:{}},e.exports),e.exports}var In=kn(function(t){!function(t,e,n){function r(t,e){return e.c=t.c,e.s0=t.s0,e.s1=t.s1,e.s2=t.s2,e}function i(t,e){var n=new function(t){var e,n=this,r=(e=4022871197,function(t){t=t.toString();for(var n=0;n<t.length;n++){var r=.02519603282416938*(e+=t.charCodeAt(n));r-=e=r>>>0,e=(r*=e)>>>0,e+=4294967296*(r-=e)}return 2.3283064365386963e-10*(e>>>0)});n.next=function(){var t=2091639*n.s0+2.3283064365386963e-10*n.c;return n.s0=n.s1,n.s1=n.s2,n.s2=t-(n.c=0|t)},n.c=1,n.s0=r(" "),n.s1=r(" "),n.s2=r(" "),n.s0-=r(t),n.s0<0&&(n.s0+=1),n.s1-=r(t),n.s1<0&&(n.s1+=1),n.s2-=r(t),n.s2<0&&(n.s2+=1),r=null}(t),i=e&&e.state,a=n.next;return a.int32=function(){return 4294967296*n.next()|0},a.double=function(){return a()+1.1102230246251565e-16*(2097152*a()|0)},a.quick=a,i&&("object"==typeof i&&r(i,n),a.state=function(){return r(n,{})}),a}e&&e.exports?e.exports=i:this.alea=i}(0,t)}),An=kn(function(t){!function(t,e,n){function r(t,e){return e.x=t.x,e.y=t.y,e.z=t.z,e.w=t.w,e}function i(t,e){var n=new function(t){var e=this,n="";e.x=0,e.y=0,e.z=0,e.w=0,e.next=function(){var t=e.x^e.x<<11;return e.x=e.y,e.y=e.z,e.z=e.w,e.w^=e.w>>>19^t^t>>>8},t===(0|t)?e.x=t:n+=t;for(var r=0;r<n.length+64;r++)e.x^=0|n.charCodeAt(r),e.next()}(t),i=e&&e.state,a=function(){return(n.next()>>>0)/4294967296};return a.double=function(){do{var t=((n.next()>>>11)+(n.next()>>>0)/4294967296)/(1<<21)}while(0===t);return t},a.int32=n.next,a.quick=a,i&&("object"==typeof i&&r(i,n),a.state=function(){return r(n,{})}),a}e&&e.exports?e.exports=i:this.xor128=i}(0,t)}),Rn=kn(function(t){!function(t,e,n){function r(t,e){return e.x=t.x,e.y=t.y,e.z=t.z,e.w=t.w,e.v=t.v,e.d=t.d,e}function i(t,e){var n=new function(t){var e=this,n="";e.next=function(){var t=e.x^e.x>>>2;return e.x=e.y,e.y=e.z,e.z=e.w,e.w=e.v,(e.d=e.d+362437|0)+(e.v=e.v^e.v<<4^t^t<<1)|0},e.x=0,e.y=0,e.z=0,e.w=0,e.v=0,t===(0|t)?e.x=t:n+=t;for(var r=0;r<n.length+64;r++)e.x^=0|n.charCodeAt(r),r==n.length&&(e.d=e.x<<10^e.x>>>4),e.next()}(t),i=e&&e.state,a=function(){return(n.next()>>>0)/4294967296};return a.double=function(){do{var t=((n.next()>>>11)+(n.next()>>>0)/4294967296)/(1<<21)}while(0===t);return t},a.int32=n.next,a.quick=a,i&&("object"==typeof i&&r(i,n),a.state=function(){return r(n,{})}),a}e&&e.exports?e.exports=i:this.xorwow=i}(0,t)}),Tn=kn(function(t){!function(t,e,n){function r(t,e){return e.x=t.x.slice(),e.i=t.i,e}function i(t,e){null==t&&(t=+new Date);var n=new function(t){var e=this;e.next=function(){var t,n,r=e.x,i=e.i;return t=r[i],n=(t^=t>>>7)^t<<24,n^=(t=r[i+1&7])^t>>>10,n^=(t=r[i+3&7])^t>>>3,n^=(t=r[i+4&7])^t<<7,t=r[i+7&7],n^=(t^=t<<13)^t<<9,r[i]=n,e.i=i+1&7,n},function(t,e){var n,r=[];if(e===(0|e))r[0]=e;else for(e=""+e,n=0;n<e.length;++n)r[7&n]=r[7&n]<<15^e.charCodeAt(n)+r[n+1&7]<<13;for(;r.length<8;)r.push(0);for(n=0;n<8&&0===r[n];++n);for(8==n?r[7]=-1:r[n],t.x=r,t.i=0,n=256;n>0;--n)t.next()}(e,t)}(t),i=e&&e.state,a=function(){return(n.next()>>>0)/4294967296};return a.double=function(){do{var t=((n.next()>>>11)+(n.next()>>>0)/4294967296)/(1<<21)}while(0===t);return t},a.int32=n.next,a.quick=a,i&&(i.x&&r(i,n),a.state=function(){return r(n,{})}),a}e&&e.exports?e.exports=i:this.xorshift7=i}(0,t)}),Dn=kn(function(t){!function(t,e,n){function r(t,e){return e.i=t.i,e.w=t.w,e.X=t.X.slice(),e}function i(t,e){null==t&&(t=+new Date);var n=new function(t){var e=this;e.next=function(){var t,n,r=e.w,i=e.X,a=e.i;return e.w=r=r+1640531527|0,n=i[a+34&127],t=i[a=a+1&127],n^=n<<13,t^=t<<17,n^=n>>>15,t^=t>>>12,n=i[a]=n^t,e.i=a,n+(r^r>>>16)|0},function(t,e){var n,r,i,a,o,s=[],u=128;for(e===(0|e)?(r=e,e=null):(e+="\0",r=0,u=Math.max(u,e.length)),i=0,a=-32;a<u;++a)e&&(r^=e.charCodeAt((a+32)%e.length)),0===a&&(o=r),r^=r<<10,r^=r>>>15,r^=r<<4,r^=r>>>13,a>=0&&(o=o+1640531527|0,i=0==(n=s[127&a]^=r+o)?i+1:0);for(i>=128&&(s[127&(e&&e.length||0)]=-1),i=127,a=512;a>0;--a)r=s[i+34&127],n=s[i=i+1&127],r^=r<<13,n^=n<<17,r^=r>>>15,n^=n>>>12,s[i]=r^n;t.w=o,t.X=s,t.i=i}(e,t)}(t),i=e&&e.state,a=function(){return(n.next()>>>0)/4294967296};return a.double=function(){do{var t=((n.next()>>>11)+(n.next()>>>0)/4294967296)/(1<<21)}while(0===t);return t},a.int32=n.next,a.quick=a,i&&(i.X&&r(i,n),a.state=function(){return r(n,{})}),a}e&&e.exports?e.exports=i:this.xor4096=i}(0,t)}),On=kn(function(t){!function(t,e,n){function r(t,e){return e.a=t.a,e.b=t.b,e.c=t.c,e.d=t.d,e}function i(t,e){var n=new function(t){var e=this,n="";e.next=function(){var t=e.b,n=e.c,r=e.d,i=e.a;return t=t<<25^t>>>7^n,n=n-r|0,r=r<<24^r>>>8^i,i=i-t|0,e.b=t=t<<20^t>>>12^n,e.c=n=n-r|0,e.d=r<<16^n>>>16^i,e.a=i-t|0},e.a=0,e.b=0,e.c=-1640531527,e.d=1367130551,t===Math.floor(t)?(e.a=t/4294967296|0,e.b=0|t):n+=t;for(var r=0;r<n.length+20;r++)e.b^=0|n.charCodeAt(r),e.next()}(t),i=e&&e.state,a=function(){return(n.next()>>>0)/4294967296};return a.double=function(){do{var t=((n.next()>>>11)+(n.next()>>>0)/4294967296)/(1<<21)}while(0===t);return t},a.int32=n.next,a.quick=a,i&&("object"==typeof i&&r(i,n),a.state=function(){return r(n,{})}),a}e&&e.exports?e.exports=i:this.tychei=i}(0,t)}),_n=kn(function(t){!function(e,n){var r,i=this,a=256,o=6,s="random",u=n.pow(a,o),l=n.pow(2,52),c=2*l,p=a-1;function h(t,p,h){var v=[],y=m(function t(e,n){var r,i=[],a=typeof e;if(n&&"object"==a)for(r in e)try{i.push(t(e[r],n-1))}catch(t){}return i.length?i:"string"==a?e:e+"\0"}((p=1==p?{entropy:!0}:p||{}).entropy?[t,g(e)]:null==t?function(){try{var t;return r&&(t=r.randomBytes)?t=t(a):(t=new Uint8Array(a),(i.crypto||i.msCrypto).getRandomValues(t)),g(t)}catch(t){var n=i.navigator,o=n&&n.plugins;return[+new Date,i,o,i.screen,g(e)]}}():t,3),v),b=new f(v),x=function(){for(var t=b.g(o),e=u,n=0;t<l;)t=(t+n)*a,e*=a,n=b.g(1);for(;t>=c;)t/=2,e/=2,n>>>=1;return(t+n)/e};return x.int32=function(){return 0|b.g(4)},x.quick=function(){return b.g(4)/4294967296},x.double=x,m(g(b.S),e),(p.pass||h||function(t,e,r,i){return i&&(i.S&&d(i,b),t.state=function(){return d(b,{})}),r?(n[s]=t,e):t})(x,y,"global"in p?p.global:this==n,p.state)}function f(t){var e,n=t.length,r=this,i=0,o=r.i=r.j=0,s=r.S=[];for(n||(t=[n++]);i<a;)s[i]=i++;for(i=0;i<a;i++)s[i]=s[o=p&o+t[i%n]+(e=s[i])],s[o]=e;(r.g=function(t){for(var e,n=0,i=r.i,o=r.j,s=r.S;t--;)e=s[i=p&i+1],n=n*a+s[p&(s[i]=s[o=p&o+e])+(s[o]=e)];return r.i=i,r.j=o,n})(a)}function d(t,e){return e.i=t.i,e.j=t.j,e.S=t.S.slice(),e}function m(t,e){for(var n,r=t+"",i=0;i<r.length;)e[p&i]=p&(n^=19*e[p&i])+r.charCodeAt(i++);return g(e)}function g(t){return String.fromCharCode.apply(0,t)}if(n["seed"+s]=h,m(n.random(),e),t.exports){t.exports=h;try{r=require("crypto")}catch(t){}}}([],Math)});_n.alea=In,_n.xor128=An,_n.xorwow=Rn,_n.xorshift7=Tn,_n.xor4096=Dn,_n.tychei=On;var Fn=_n.alea,Mn=function(){function t(t,e,n,r,i){this.mean=t,this.stdDev=e,this.dtype=n,this.nextVal=NaN,this.truncated=r,this.truncated&&(this.upper=this.mean+2*this.stdDev,this.lower=this.mean-2*this.stdDev);var a=i||Math.random();this.random=Fn(a.toString())}return t.prototype.nextValue=function(){if(!isNaN(this.nextVal)){var t=this.nextVal;return this.nextVal=NaN,t}for(var e,n,r=!1;!r;){var i=void 0,a=void 0,o=void 0;do{o=(i=2*this.random()-1)*i+(a=2*this.random()-1)*a}while(o>=1||0===o);var s=Math.sqrt(-2*Math.log(o)/o);e=this.mean+this.stdDev*i*s,n=this.mean+this.stdDev*a*s,this.truncated&&!this.isValidTruncated(e)||(r=!0)}return this.truncated&&!this.isValidTruncated(n)||(this.nextVal=this.convertValue(n)),this.convertValue(e)},t.prototype.convertValue=function(t){return null==this.dtype||"float32"===this.dtype?t:Math.round(t)},t.prototype.isValidTruncated=function(t){return t<=this.upper&&t>=this.lower},t}(),zn=function(){function t(t,e,n,r){this.alpha=t,this.beta=1/e,this.dtype=n;var i=r||Math.random();this.randu=Fn(i.toString()),this.randn=new Mn(0,1,n,!1,this.randu()),this.d=t<1?t+2/3:t-1/3,this.c=1/Math.sqrt(9*this.d)}return t.prototype.nextValue=function(){for(var t,e,n,r,i,a;;){do{r=this.randn.nextValue(),a=1+this.c*r}while(a<=0);if(a*=a*a,e=1-.331*(t=r*r)*t,n=.5*t+this.d*(1-a+Math.log(a)),(i=this.randu())<e||Math.log(i)<n)break}return a=1/this.beta*this.d*a,this.alpha<1&&(a*=Math.pow(this.randu(),1/this.alpha)),this.convertValue(a)},t.prototype.convertValue=function(t){return"float32"===this.dtype?t:Math.round(t)},t}(),Ln=function(){function t(t,e,n,r){void 0===t&&(t=0),void 0===e&&(e=1);var i=this;if(this.canReturnFloat=function(){return null==i.dtype||"float32"===i.dtype},this.min=t,this.range=e-t,this.dtype=n,null==r&&(r=Math.random()),"number"==typeof r&&(r=r.toString()),!this.canReturnFloat()&&this.range<=1)throw new Error("The difference between "+t+" - "+e+" <= 1 and dtype is not float");this.random=Fn(r)}return t.prototype.convertValue=function(t){return this.canReturnFloat()?t:Math.round(t)},t.prototype.nextValue=function(){return this.convertValue(this.min+this.range*this.random())},t}();function Pn(t,e,n){return void 0===e&&(e="float32"),e=e||"float32",$(t),new ot(t,e,n)}function Bn(t,e){void 0===e&&(e=!1),console.log(t.toString(e))}var Vn=Qe({batchToSpaceND_:function(t,e,n){var r=We(t,"x","batchToSpaceND"),i=e.reduce(function(t,e){return t*e});return f(r.rank>=1+e.length,function(){return"input rank is "+r.rank+" but should be > than blockShape.length "+e.length}),f(n.length===e.length,function(){return"crops.length is "+n.length+" but should be equal to blockShape.length  "+e.length}),f(r.shape[0]%i==0,function(){return"input tensor batch is "+r.shape[0]+" but is not divisible by the product of the elements of blockShape "+e.join(" * ")+" === "+i}),It.runKernel(function(t){return t.batchToSpaceND(r,e,n)},{$x:r},function(t){return{$x:function(){return t.spaceToBatchND(e,n)}}})}}),Wn=Qe({cast_:function(t,e){var n=We(t,"x","cast");if(!D(e))throw new Error("Failed to cast to unknown dtype "+e);if("string"===e&&"string"!==n.dtype||"string"!==e&&"string"===n.dtype)throw new Error("Only strings can be casted to strings");return It.runKernel(function(t){return t.cast(n,e)},{$x:n},function(t){return{$x:function(){return t.clone()}}})}}),Un=Qe({clone_:function(t){var e=We(t,"x","clone",null);return It.runKernel(function(t){return ct.make(e.shape,{dataId:e.dataId},e.dtype)},{$x:e},function(t){return{$x:function(){return t.toFloat()}}})}}),jn=Qe({cumsum_:function(t,e,n,r){void 0===e&&(e=0),void 0===n&&(n=!1),void 0===r&&(r=!1);var i=We(t,"x","cumsum"),a=$e([e|=0],i.rank),o=i;null!=a&&(o=i.transpose(a));var s=Ye(1,i.rank)[0],u=It.runKernel(function(t){return t.cumsum(o,s,n,r)},{permutedX:o},function(t){return{permutedX:function(){return t.cumsum(e,n,!r)}}});return null!=a&&(u=u.transpose(a)),u}}),qn=Qe({depthToSpace_:function(t,e,n){void 0===n&&(n="NHWC");var r=We(t,"x","depthToSpace"),i="NHWC"===n?r.shape[1]:r.shape[2],a="NHWC"===n?r.shape[2]:r.shape[3],o="NHWC"===n?r.shape[3]:r.shape[1];return f(i*e>=0,function(){return"Negative dimension size caused by overflow when multiplying\n      "+i+" and "+e+"  for depthToSpace with input shape\n      "+r.shape}),f(a*e>=0,function(){return"Negative dimension size caused by overflow when multiplying\n      "+a+" and "+e+" for depthToSpace with input shape\n          "+r.shape}),f(o%(e*e)==0,function(){return"Dimension size must be evenly divisible by "+e*e+" but is "+o+" for depthToSpace with input shape "+r.shape}),It.runKernel(function(t){return t.depthToSpace(r,e,n)},{$x:r})}}),Hn=Qe({expandDims_:function(t,e){void 0===e&&(e=0);var n=We(t,"x","expandDims",null);f(e<=n.rank,function(){return"Axis must be <= rank of the tensor"});var r=n.shape.slice();return e<0&&(f(-(n.rank+1)<=e,function(){return"Axis must be in the interval ["+-(n.rank+1)+", "+n.rank+"]"}),e=n.rank+e+1),r.splice(e,0,1),ir(n,r)}}),Gn=Qe({eye_:function(t,e,n,r){void 0===r&&(r="float32"),null==e&&(e=t);for(var i=Pn([t,e],r),a=t<=e?t:e,o=0;o<a;++o)i.set(1,o,o);var s=i.toTensor().as2D(t,e);if(null==n)return s;if(1===n.length)return ur(Hn(s,0),[n[0],1,1]);if(2===n.length)return ur(Hn(Hn(s,0),0),[n[0],n[1],1,1]);if(3===n.length)return ur(Hn(Hn(Hn(s,0),0),0),[n[0],n[1],n[2],1,1]);throw new Error("eye() currently supports only 1D and 2D batchShapes, but received "+n.length+"D.")}}),Kn=Qe({multinomial_:function(t,e,n,r){void 0===r&&(r=!1);var i=We(t,"logits","multinomial"),a=i.size,o=i.rank;if(a<2)throw new Error("Error in multinomial: you need at least 2 outcomes, but got "+a+".");if(o>2)throw new Error("Rank of probabilities must be 1 or 2, but is "+o);n=n||Math.random();var s=1===o?i.as2D(1,-1):i,u=It.runKernel(function(t){return t.multinomial(s,r,e,n)},{logits2D:s});return 1===o?u.as1D():u}}),$n=Qe({oneHot_:function(t,e,n,r){if(void 0===n&&(n=1),void 0===r&&(r=0),e<2)throw new Error("Error in oneHot: depth must be >=2, but it is "+e);var i=We(t,"indices","oneHot","int32"),a=i.shape.concat([e]);return i=i.flatten(),It.runKernel(function(t){return t.oneHot(i,e,n,r)},{$indices:i},function(t){return{$indices:function(){return dn(i.shape,"float32")}}}).reshape(a)}}),Xn=Qe({pad_:function(t,e,n){void 0===n&&(n=0);var r=We(t,"x","pad");if(0===r.rank)throw new Error("pad(scalar) is not defined. Pass non-scalar to pad");var i=e.map(function(t){return t[0]});return It.runKernel(function(t){return t.pad(r,e,n)},{$x:r},function(t){return{$x:function(){return t.slice(i,r.shape)}}})}}),Yn=Qe({pad1d_:function(t,e,n){return void 0===n&&(n=0),f(2===e.length,function(){return"Invalid number of paddings. Must be length of 2."}),Xn(t,[e],n)}}),Jn=Qe({pad2d_:function(t,e,n){return void 0===n&&(n=0),f(2===e.length&&2===e[0].length&&2===e[1].length,function(){return"Invalid number of paddings. Must be length of 2 each."}),Xn(t,e,n)}}),Zn=Qe({pad3d_:function(t,e,n){return void 0===n&&(n=0),f(3===e.length&&2===e[0].length&&2===e[1].length&&2===e[2].length,function(){return"Invalid number of paddings. Must be length of 2 each."}),Xn(t,e,n)}}),Qn=Qe({pad4d_:function(t,e,n){return void 0===n&&(n=0),f(4===e.length&&2===e[0].length&&2===e[1].length&&2===e[2].length&&2===e[3].length,function(){return"Invalid number of paddings. Must be length of 2 each."}),Xn(t,e,n)}}),tr=Qe({rand_:function(t,e,n){var r=v(t),i=null;if(null==n||"float32"===n)i=new Float32Array(r);else if("int32"===n)i=new Int32Array(r);else{if("bool"!==n)throw new Error("Unknown data type "+n);i=new Uint8Array(r)}for(var a=0;a<r;a++)i[a]=e();return ct.make(t,{values:i},n)}}),er=Qe({randomNormal_:function(t,e,n,r,i){if(void 0===e&&(e=0),void 0===n&&(n=1),null!=r&&"bool"===r)throw new Error("Unsupported data type "+r);for(var a=new Mn(e,n,r,!1,i),o=Pn(t,r),s=0;s<o.values.length;s++)o.values[s]=a.nextValue();return o.toTensor()}}),nr=Qe({randomGamma_:function(t,e,n,r,i){if(void 0===n&&(n=1),void 0===r&&(r="float32"),null==n&&(n=1),null==r&&(r="float32"),"float32"!==r&&"int32"!==r)throw new Error("Unsupported data type "+r);for(var a=new zn(e,n,r,i),o=Pn(t,r),s=0;s<o.values.length;s++)o.values[s]=a.nextValue();return o.toTensor()}}),rr=Qe({randomUniform_:function(t,e,n,r,i){void 0===e&&(e=0),void 0===n&&(n=1),void 0===r&&(r="float32");for(var a=Pn(t,r),o=new Ln(e,n,null,i),s=0;s<a.values.length;s++)a.values[s]=o.nextValue();return a.toTensor()}}),ir=Qe({reshape_:function(t,e){var n=We(t,"x","reshape",null);return e=E(e,n.size),f(n.size===v(e),function(){return"new shape and old shape must have the same number of elements."}),It.runKernel(function(t){return t.reshape(n,e)},{$x:n},function(t){return{$x:function(){return t.reshape(n.shape)}}})}}),ar=Qe({spaceToBatchND_:function(t,e,n){var r=We(t,"x","spaceToBatchND");return f(r.rank>=1+e.length,function(){return"input rank "+r.rank+" should be > than [blockShape] "+e.length}),f(n.length===e.length,function(){return"paddings.shape[0] "+n.length+" must be equal to [blockShape] "+e.length}),f(r.shape.reduce(function(t,r,i){return i>0&&i<=e.length?t&&(r+n[i-1][0]+n[i-1][1])%e[i-1]==0:t},!0),function(){return"input spatial dimensions "+r.shape.slice(1)+" with paddings "+n.toString()+" must be divisible by blockShapes "+e.toString()}),It.runKernel(function(t){return t.spaceToBatchND(r,e,n)},{$x:r},function(t){return{$x:function(){return t.batchToSpaceND(e,n)}}})}}),or=Qe({squeeze_:function(t,e){var n=We(t,"x","squeeze");return ir(n,k(n.shape,e).newShape)}}),sr=Qe({stack_:function(t,e){void 0===e&&(e=0);var n=Ue(t,"tensors","stack");if(f(n.length>=1,function(){return"Pass at least one tensor to tf.stack"}),1===n.length)return n[0].expandDims(e);var r=n[0].rank,i=n[0].shape,a=n[0].dtype;f(e<=r,function(){return"Axis must be <= rank of the tensor"}),n.forEach(function(t){d(i,t.shape,"All tensors passed to stack must have matching shapes")}),n.forEach(function(t){f(a===t.dtype,function(){return"All tensors passed to stack must have matching dtypes"})});var o=n.map(function(t){return t.expandDims(e)});return xn(o,e)}}),ur=Qe({tile_:function(t,e){var n=We(t,"x","tile",null);return f(n.rank===e.length,function(){return"Error in transpose: rank of input "+n.rank+" must match length of reps "+e+"."}),It.runKernel(function(t,r){var i=t.tile(n,e);return r([n]),i},{$x:n},function(t,n){var r=n[0];return{$x:function(){var n=bn(r);if(1===r.rank)for(var i=0;i<e[0];++i)n=n.add(t.slice([i*r.shape[0]],[r.shape[0]]));else if(2===r.rank)for(i=0;i<e[0];++i)for(var a=0;a<e[1];++a)n=n.add(t.slice([i*r.shape[0],a*r.shape[1]],[r.shape[0],r.shape[1]]));else if(3===r.rank)for(i=0;i<e[0];++i)for(a=0;a<e[1];++a)for(var o=0;o<e[2];++o)n=n.add(t.slice([i*r.shape[0],a*r.shape[1],o*r.shape[2]],[r.shape[0],r.shape[1],r.shape[2]]));else{if(4!==r.rank)throw new Error("Gradient for tile operation is not implemented for rank-"+r.rank+" tensors yet.");for(i=0;i<e[0];++i)for(a=0;a<e[1];++a)for(o=0;o<e[2];++o)for(var s=0;s<e[3];++s)n=n.add(t.slice([i*r.shape[0],a*r.shape[1],o*r.shape[2],s*r.shape[3]],[r.shape[0],r.shape[1],r.shape[2],r.shape[3]]))}return n}}})}}),lr=Qe({truncatedNormal_:function(t,e,n,r,i){if(void 0===e&&(e=0),void 0===n&&(n=1),null!=r&&"bool"===r)throw new Error("Unsupported data type "+r);for(var a=new Mn(e,n,r,!0,i),o=Pn(t,r),s=0;s<o.values.length;s++)o.values[s]=a.nextValue();return o.toTensor()}}),cr=Qe({unstack_:function(t,e){void 0===e&&(e=0),e=e||0;var n=We(t,"x","unstack");return f(e>=-n.shape.length&&e<n.shape.length,function(){return"Axis = "+e+" is not in [-"+n.shape.length+", "+n.shape.length+")"}),e<0&&(e+=n.shape.length),It.runKernel(function(t){return t.unstack(n,e)},{$x:n},function(t){return{$x:function(){return sr(t,e)}}})}}),pr=function(t,e){return r(this,void 0,void 0,function(){var n,r,a,o,s,u,l,c,p,h;return i(this,function(i){switch(i.label){case 0:return n=We(t,"x","setdiff1d"),r=We(e,"y","setdiff1d"),f(n.dtype===r.dtype,function(){return"x and y should have the same dtype, but got x ("+n.dtype+") and y ("+r.dtype+")."}),f(1===n.rank,function(){return"x should be 1D tensor, but got x ("+n.shape+")."}),f(1===r.rank,function(){return"y should be 1D tensor, but got y ("+r.shape+")."}),[4,n.data()];case 1:return a=i.sent(),[4,r.data()];case 2:for(o=i.sent(),s=new Set(o),u=0,p=0;p<a.length;p++)s.has(a[p])||u++;for(l=new ot([u],n.dtype),c=new ot([u],"int32"),p=0,h=0;p<a.length;p++)s.has(a[p])||(l.values[h]=a[p],c.values[h]=p,h++);return[2,[l.toTensor(),c.toTensor()]]}})})};function hr(t,e,n,r){void 0===r&&(r=!0);var i=[];if(r)(i=i.concat(e.slice(0))).push(t[0]/n),i=i.concat(t.slice(1));else{i=i.concat(t[0]);for(var a=e.length,o=0;o<a;++o)i=i.concat([t[o+1]/e[o],e[o]]);i=i.concat(t.slice(a+1))}return i}function fr(t,e,n){void 0===n&&(n=!0);var r=[];if(n){r.push(e);for(var i=e+1;i<t;++i)i<=2*e?(r.push(i),r.push(i-(e+1))):r.push(i)}else{var a=[],o=[];for(i=1;i<t;++i)i>=2*e+1||i%2==1?o.push(i):a.push(i);r.push.apply(r,a),r.push(0),r.push.apply(r,o)}return r}function dr(t,e,n,r){void 0===r&&(r=!0);var i=[];r?i.push(t[0]/n):i.push(t[0]*n);for(var a=1;a<t.length;++a)a<=e.length?r?i.push(e[a-1]*t[a]):i.push(t[a]/e[a-1]):i.push(t[a]);return i}function mr(t,e){for(var n=[0],r=0;r<e;++r)n.push(t[r][0]);return n}function gr(t,e,n){for(var r=t.slice(0,1),i=0;i<n;++i)r.push(t[i+1]-e[i][0]-e[i][1]);return r}function vr(t,e){if(t.rank<1)throw new Error("tf.gatherND() expects the input to be rank 1 or higher, but the rank was "+t.rank+".");if(e.rank<1)throw new Error("tf.gatherND() expects the indices to be rank 1 or higher, but the rank was "+e.rank+".");if("int32"!==e.dtype)throw new Error("tf.gatherND() expects the indices to be int32 type, but the dtype was "+e.dtype+".");if(e.shape[e.rank-1]>t.rank)throw new Error("index innermost dimension length must be <= tensor rank; saw: "+e.shape[e.rank-1]+" vs. "+t.rank);if(0===t.size)throw new Error("Requested more than 0 entries, but input is empty. Input shape: "+t.shape+".");for(var n=e.shape,r=n[n.length-1],i=1,a=0;a<n.length-1;++a)i*=n[a];var o=t.shape,s=n.slice();s.pop();var u=1;for(a=r;a<t.rank;++a)u*=o[a],s.push(o[a]);var l=U(t.shape).map(function(t){return t/u}).concat([1]).slice(0,r);return[s,i,u,l]}var yr=30;function br(t){return t<=yr?t:W(t,Math.floor(Math.sqrt(t)))}function xr(t,e,n){for(var r=e.rank>1?e.shape[e.rank-1]:1,i=n.length,a=1,o=r;o<i;++o)a*=n[o];var s=r<1?1:r;return{sliceRank:r,numUpdates:e.size/s,sliceSize:a,strides:U(n.slice(0,r)).concat([1]),outputSize:v(n)}}function wr(t,e,n,r,i,a,o,s,u){if(void 0===i&&(i=0),void 0===a&&(a=0),void 0===o&&(o=0),void 0===s&&(s=0),void 0===u&&(u=0),0!==o)throw new Error("ellipsis mask is not yet supported");if(0!==s)throw new Error("new axis mask is not yet supported");for(var l=[],c=[],p=[],h=0;h<t.length;h++)l[h]=Nr(i,e,r,t,h),c[h]=Cr(a,n,r,t,h),u&1<<h&&(c[h]=l[h]+1,p.push(h));var f=new Array(t.length).fill(0);return f=f.map(function(t,e){for(var n=0,i=r[e]||1,a=l[e];!(i>0?a>=c[e]:a<=c[e]);a+=i)n+=1;return n}),[l,f,p]}function Nr(t,e,n,r,i){var a=e[i],o=n[i]||1;(t&1<<i||null==a)&&(a=o>0?Number.MIN_SAFE_INTEGER:Number.MAX_SAFE_INTEGER);var s=r[i];return a<0&&(a+=s),c(0,a,s-1)}function Cr(t,e,n,r,i){var a=e[i],o=n[i]||1;(t&1<<i||null==a)&&(a=o>0?Number.MAX_SAFE_INTEGER:Number.MIN_SAFE_INTEGER);var s=r[i];return a<0&&(a+=s),o>0?c(0,a,s):c(-1,a,s-1)}function Er(t,e,n){for(var r=n.length,i=0;i<n.length;i++)if(n[i]>1){r=i;break}for(i=r+1;i<n.length;i++)if(e[i]>0||n[i]!==t[i])return!1;return!0}function Sr(t,e){for(var n=t.length>0?t[t.length-1]:1,r=0;r<t.length-1;r++)n+=t[r]*e[r];return n}function kr(t,e){f(V(t),function(){return"The f passed in variableGrads(f) must be a function"}),f(null==e||Array.isArray(e)&&e.every(function(t){return t instanceof pt}),function(){return"The varList passed in variableGrads(f, varList) must be an array of variables"});var n=null!=e;if(!n)for(var r in e=[],It.registeredVariables)e.push(It.registeredVariables[r]);var i=n?e.filter(function(t){return!t.trainable}):null,a=e.length;f((e=e.filter(function(t){return t.trainable})).length>0,function(){return"variableGrads() expects at least one of the input variables to be trainable, but none of the "+a+" variables is trainable."});var o=It.gradients(t,e,null,!0),s=o.value,u=o.grads;f(u.some(function(t){return null!=t}),function(){return"Cannot find a connection between any variable and the result of the loss function y=f(x). Please make sure the operations that use variables are inside the function f passed to minimize()."}),f(0===s.rank,function(){return"The f passed in variableGrads(f) must return a scalar, but it returned a rank-"+s.rank+" tensor"});var l={};return e.forEach(function(t,e){null!=u[e]&&(l[t.name]=u[e])}),null!=i&&i.forEach(function(t){return l[t.name]=null}),{value:s,grads:l}}function Ir(t){return It.customGrad(t)}function Ar(t){if(t.filter(function(t){return null==t}).length>0)throw new Error("Cannot compute gradient of y=f(x) with respect to x. Make sure that\n    the f you passed encloses all operations that lead from x to y.")}var Rr=Qe({softmax_:function(t,e){void 0===e&&(e=-1);var n=We(t,"logits","softmax");if(-1===e&&(e=n.rank-1),e!==n.rank-1)throw Error("Softmax along a non-last dimension is not yet supported. Logits was rank "+n.rank+" and dim was "+e);return Ir(function(t,n){var r=t.logSumExp([e],!0),i=t.toFloat().sub(r).exp();return n([i]),{value:i,gradFunc:function(t,n){var r=n[0],i=t.mul(r);return i.sub(i.sum([e],!0).mul(r))}}})(n)}}),Tr=Qe({logSoftmax_:function(t,e){void 0===e&&(e=-1);var n=We(t,"logits","logSoftmax");if(-1===e&&(e=n.rank-1),e!==n.rank-1)throw Error("Log Softmax along a non-last dimension is not yet supported. Logits was rank "+n.rank+" and axis was "+e);return Ir(function(t,n){var r=t.max(e,!0),i=t.sub(r),a=i.toFloat().sub(i.exp().sum(e,!0).log());return n([a]),{value:a,gradFunc:function(t,n){var r=n[0].exp();return t.sub(t.sum(e,!0).mul(r))}}})(n)}}),Dr=function(){function t(t,e){this.backend=t,this.dataMover=e,this.data=new WeakMap}return t.prototype.get=function(t){return this.data.has(t)||this.dataMover.moveData(this.backend,t),this.data.get(t)},t.prototype.set=function(t,e){this.data.set(t,e)},t.prototype.has=function(t){return this.data.has(t)},t.prototype.delete=function(t){return this.data.delete(t)},t}(),Or=function(){function t(){}return t.prototype.time=function(t){throw new Error("Not yet implemented.")},t.prototype.read=function(t){throw new Error("Not yet implemented.")},t.prototype.readSync=function(t){throw new Error("Not yet implemented.")},t.prototype.disposeData=function(t){throw new Error("Not yet implemented.")},t.prototype.write=function(t,e){throw new Error("Not yet implemented.")},t.prototype.fromPixels=function(t,e){throw new Error("Not yet implemented.")},t.prototype.register=function(t,e,n){throw new Error("Not yet implemented.")},t.prototype.memory=function(){throw new Error("Not yet implemented.")},t.prototype.floatPrecision=function(){throw new Error("Not yet implemented")},t.prototype.epsilon=function(){return 32===this.floatPrecision()?1e-7:1e-4},t.prototype.batchMatMul=function(t,e,n,r){throw new Error("Not yet implemented")},t.prototype.fusedBatchMatMul=function(t){throw t.a,t.b,t.transposeA,t.transposeB,t.bias,t.activation,t.preluActivationWeights,new Error("Not yet implemented")},t.prototype.slice=function(t,e,n){throw new Error("Not yet implemented")},t.prototype.stridedSlice=function(t,e,n,r,i,a,o,s,u){throw new Error("Not yet implemented")},t.prototype.unstack=function(t,e){throw new Error("Not yet implemented")},t.prototype.reverse=function(t,e){throw new Error("Not yet implemented")},t.prototype.concat=function(t,e){throw new Error("Not yet implemented")},t.prototype.neg=function(t){throw new Error("Not yet implemented")},t.prototype.add=function(t,e){throw new Error("Not yet implemented")},t.prototype.addN=function(t){throw new Error("Not yet implemented")},t.prototype.subtract=function(t,e){throw new Error("Not yet implemented")},t.prototype.multiply=function(t,e){throw new Error("Not yet implemented")},t.prototype.realDivide=function(t,e){throw new Error("Not yet implemented")},t.prototype.floorDiv=function(t,e){throw new Error("Not yet implemented")},t.prototype.sum=function(t,e){throw new Error("Not yet implemented")},t.prototype.prod=function(t,e){throw new Error("Not yet implemented")},t.prototype.unsortedSegmentSum=function(t,e,n){throw new Error("Not yet implemented")},t.prototype.argMin=function(t,e){throw new Error("Not yet implemented")},t.prototype.argMax=function(t,e){throw new Error("Not yet implemented")},t.prototype.equal=function(t,e){throw new Error("Not yet implemented")},t.prototype.notEqual=function(t,e){throw new Error("Not yet implemented")},t.prototype.less=function(t,e){throw new Error("Not yet implemented")},t.prototype.lessEqual=function(t,e){throw new Error("Not yet implemented")},t.prototype.greater=function(t,e){throw new Error("Not yet implemented")},t.prototype.greaterEqual=function(t,e){throw new Error("Not yet implemented")},t.prototype.logicalNot=function(t){throw new Error("Not yet implemented")},t.prototype.logicalAnd=function(t,e){throw new Error("Not yet implemented")},t.prototype.logicalOr=function(t,e){throw new Error("Not yet implemented")},t.prototype.where=function(t){throw new Error("Not yet implemented")},t.prototype.select=function(t,e,n){throw new Error("Not yet implemented")},t.prototype.topk=function(t,e,n){throw new Error("Not yet implemented")},t.prototype.min=function(t,e){throw new Error("Not yet implemented")},t.prototype.minimum=function(t,e){throw new Error("Not yet implemented")},t.prototype.mod=function(t,e){throw new Error("Not yet implemented")},t.prototype.max=function(t,e){throw new Error("Not yet implemented")},t.prototype.maximum=function(t,e){throw new Error("Not yet implemented")},t.prototype.all=function(t,e){throw new Error("Not yet implemented")},t.prototype.any=function(t,e){throw new Error("Not yet implemented")},t.prototype.squaredDifference=function(t,e){throw new Error("Not yet implemented")},t.prototype.ceil=function(t){throw new Error("Not yet implemented")},t.prototype.floor=function(t){throw new Error("Not yet implemented")},t.prototype.round=function(t){throw new Error("Not yet implemented")},t.prototype.sign=function(t){throw new Error("Not yet implemented")},t.prototype.isNaN=function(t){throw new Error("Not yet implemented")},t.prototype.isInf=function(t){throw new Error("Not yet implemented")},t.prototype.isFinite=function(t){throw new Error("Not yet implemented")},t.prototype.pow=function(t,e){throw new Error("Not yet implemented")},t.prototype.exp=function(t){throw new Error("Not yet implemented")},t.prototype.expm1=function(t){throw new Error("Not yet implemented")},t.prototype.log=function(t){throw new Error("Not yet implemented")},t.prototype.log1p=function(t){throw new Error("Not yet implemented")},t.prototype.sqrt=function(t){throw new Error("Not yet implemented")},t.prototype.rsqrt=function(t){throw new Error("Not yet implemented")},t.prototype.square=function(t){throw new Error("Not yet implemented")},t.prototype.reciprocal=function(t){throw new Error("Not yet implemented")},t.prototype.relu=function(t){throw new Error("Not yet implemented")},t.prototype.prelu=function(t,e){throw new Error("Not yet implemented")},t.prototype.elu=function(t){throw new Error("Not yet implemented")},t.prototype.eluDer=function(t,e){throw new Error("Not yet implemented")},t.prototype.selu=function(t){throw new Error("Not yet implemented")},t.prototype.int=function(t){throw new Error("Not yet implemented")},t.prototype.clip=function(t,e,n){throw new Error("Not yet implemented")},t.prototype.abs=function(t){throw new Error("Not yet implemented")},t.prototype.complexAbs=function(t){throw new Error("Not yet implemented")},t.prototype.sigmoid=function(t){throw new Error("Not yet implemented")},t.prototype.softplus=function(t){throw new Error("Not yet implemented")},t.prototype.sin=function(t){throw new Error("Not yet implemented")},t.prototype.cos=function(t){throw new Error("Not yet implemented")},t.prototype.tan=function(t){throw new Error("Not yet implemented")},t.prototype.asin=function(t){throw new Error("Not yet implemented")},t.prototype.acos=function(t){throw new Error("Not yet implemented")},t.prototype.atan=function(t){throw new Error("Not yet implemented")},t.prototype.atan2=function(t,e){throw new Error("Not yet implemented")},t.prototype.sinh=function(t){throw new Error("Not yet implemented")},t.prototype.cosh=function(t){throw new Error("Not yet implemented")},t.prototype.tanh=function(t){throw new Error("Not yet implemented")},t.prototype.asinh=function(t){throw new Error("Not yet implemented")},t.prototype.acosh=function(t){throw new Error("Not yet implemented")},t.prototype.atanh=function(t){throw new Error("Not yet implemented")},t.prototype.erf=function(t){throw new Error("Not yet implemented")},t.prototype.step=function(t,e){throw new Error("Not yet implemented")},t.prototype.fusedConv2d=function(t,e,n,r,i,a){throw new Error("Not yet implemented")},t.prototype.conv2d=function(t,e,n){throw new Error("Not yet implemented")},t.prototype.conv2dDerInput=function(t,e,n){throw new Error("Not yet implemented")},t.prototype.conv2dDerFilter=function(t,e,n){throw new Error("Not yet implemented")},t.prototype.depthwiseConv2D=function(t,e,n){throw new Error("Not yet implemented")},t.prototype.depthwiseConv2DDerInput=function(t,e,n){throw new Error("Not yet implemented")},t.prototype.depthwiseConv2DDerFilter=function(t,e,n){throw new Error("Not yet implemented")},t.prototype.conv3d=function(t,e,n){throw new Error("Not yet implemented")},t.prototype.conv3dDerInput=function(t,e,n){throw new Error("Not yet implemented")},t.prototype.conv3dDerFilter=function(t,e,n){throw new Error("Not yet implemented")},t.prototype.maxPool=function(t,e){throw new Error("Not yet implemented")},t.prototype.maxPoolBackprop=function(t,e,n,r){throw new Error("Not yet implemented")},t.prototype.avgPool=function(t,e){throw new Error("Not yet implemented")},t.prototype.avgPoolBackprop=function(t,e,n){throw new Error("Not yet implemented")},t.prototype.avgPool3d=function(t,e){throw new Error("Not yet implemented")},t.prototype.avgPool3dBackprop=function(t,e,n){throw new Error("Not yet implemented")},t.prototype.maxPool3d=function(t,e){throw new Error("Not yet implemented")},t.prototype.maxPool3dBackprop=function(t,e,n,r){throw new Error("Not yet implemented")},t.prototype.reshape=function(t,e){throw new Error("Not yet implemented")},t.prototype.cast=function(t,e){throw new Error("Not yet implemented")},t.prototype.tile=function(t,e){throw new Error("Not yet implemented")},t.prototype.pad=function(t,e,n){throw new Error("Not yet implemented")},t.prototype.transpose=function(t,e){throw new Error("Not yet implemented")},t.prototype.gather=function(t,e,n){throw new Error("Not yet implemented")},t.prototype.gatherND=function(t,e){throw new Error("Not yet implemented")},t.prototype.scatterND=function(t,e,n){throw new Error("Not yet implemented")},t.prototype.batchToSpaceND=function(t,e,n){throw new Error("Not yet implemented")},t.prototype.spaceToBatchND=function(t,e,n){throw new Error("Not yet implemented")},t.prototype.resizeBilinear=function(t,e,n,r){throw new Error("Not yet implemented")},t.prototype.resizeBilinearBackprop=function(t,e,n){throw new Error("Not yet implemented")},t.prototype.resizeNearestNeighbor=function(t,e,n,r){throw new Error("Not yet implemented")},t.prototype.resizeNearestNeighborBackprop=function(t,e,n){throw new Error("Not yet implemented")},t.prototype.batchNormalization=function(t,e,n,r,i,a){throw new Error("Not yet implemented")},t.prototype.localResponseNormalization4D=function(t,e,n,r,i){throw new Error("Not yet implemented")},t.prototype.LRNGrad=function(t,e,n,r,i,a,o){throw new Error("Not yet implemented")},t.prototype.multinomial=function(t,e,n,r){throw new Error("Not yet implemented")},t.prototype.oneHot=function(t,e,n,r){throw new Error("Not yet implemented")},t.prototype.cumsum=function(t,e,n,r){throw new Error("Not yet implemented")},t.prototype.nonMaxSuppression=function(t,e,n,r,i){throw new Error("Not yet implemented")},t.prototype.fft=function(t){throw new Error("Not yet implemented")},t.prototype.ifft=function(t){throw new Error("Not yet implemented")},t.prototype.complex=function(t,e){throw new Error("Not yet implemented")},t.prototype.real=function(t){throw new Error("Not yet implemented")},t.prototype.imag=function(t){throw new Error("Not yet implemented")},t.prototype.cropAndResize=function(t,e,n,r,i,a){throw new Error("Not yet implemented")},t.prototype.depthToSpace=function(t,e,n){throw new Error("Not yet implemented")},t.prototype.split=function(t,e,n){throw new Error("Not yet implemented")},t.prototype.sparseToDense=function(t,e,n,r){throw new Error("Not yet implemented")},t.prototype.diag=function(t){throw new Error("Not yet implemented")},t.prototype.fill=function(t,e,n){throw new Error("Not yet implemented.")},t.prototype.onesLike=function(t){throw new Error("Not yet implemented")},t.prototype.zerosLike=function(t){throw new Error("Not yet implemented")},t.prototype.linspace=function(t,e,n){throw new Error("Not yet implemented")},t.prototype.dispose=function(){throw new Error("Not yet implemented")},t}();function _r(t,e){for(var n=t.length,r=[],i=0;i<n;i++){var a=n-1-i,o=t[a]||1;(e[e.length-1-i]||1)>1&&1===o&&r.unshift(a)}return r}function Fr(t,e){for(var n=[],r=0;r<e.length;r++){var i=t[t.length-r-1],a=e.length-r-1,o=e[a];(null==i||1===i&&o>1)&&n.unshift(a)}return n}function Mr(t,e){for(var n=[],r=Math.max(t.length,e.length),i=0;i<r;i++){var a=t[t.length-i-1];null==a&&(a=1);var o=e[e.length-i-1];if(null==o&&(o=1),1===a)n.unshift(o);else if(1===o)n.unshift(a);else{if(a!==o)throw Error("Operands could not be broadcast together with shapes "+t+" and "+e+".");n.unshift(a)}}return n}function zr(t,e,n,r,i,a,o){void 0===o&&(o="channelsLast");var s,u=Wr(e),l=u[0],c=u[1];if("channelsLast"===o)s=[l,c,t[3],t[3]];else{if("channelsFirst"!==o)throw new Error("Unknown dataFormat "+o);s=[l,c,t[1],t[1]]}return Pr(t,s,n,r,i,a,!1,o)}function Lr(t,e,n,r,i,a,o){void 0===o&&(o="NDHWC");var s,u,l=Ur(e),c=l[0],p=l[1],h=l[2];if("NDHWC"===o)u="channelsLast",s=[c,p,h,t[4],t[4]];else{if("NCDHW"!==o)throw new Error("Unknown dataFormat "+o);u="channelsFirst",s=[c,p,h,t[1],t[1]]}return Br(t,s,n,r,i,!1,u,a)}function Pr(t,e,n,r,i,a,o,s){void 0===o&&(o=!1),void 0===s&&(s="channelsLast");var u=[-1,-1,-1,-1],l=u[0],c=u[1],p=u[2],h=u[3];if("channelsLast"===s)l=t[0],c=t[1],p=t[2],h=t[3];else{if("channelsFirst"!==s)throw new Error("Unknown dataFormat "+s);l=t[0],h=t[1],c=t[2],p=t[3]}var d,m=e[0],g=e[1],v=e[3],y=Wr(n),x=y[0],w=y[1],N=Wr(r),C=N[0],E=N[1],S=jr(m,C),k=jr(g,E),I=function(t,e,n,r,i,a,o,s){var u,l,c;if("number"==typeof t){u={top:t,bottom:t,left:t,right:t,type:0===t?"VALID":"NUMBER"};var p=function(t,e,n,r,i){null==r&&(r=Vr(t,e,n));var a=t[1],o=qr((t[0]-e+2*r)/n+1,i);f(b(o),function(){return"The output # of rows ("+o+") must be an integer. Change the stride and/or zero pad parameters"});var s=qr((a-e+2*r)/n+1,i);return f(b(s),function(){return"The output # of columns ("+s+") must be an integer. Change the stride and/or zero pad parameters"}),[o,s]}([e,n],a,r,t,s);l=p[0],c=p[1]}else if("same"===t){l=Math.ceil(e/r),c=Math.ceil(n/i);var h=Math.max(0,(l-1)*r+a-e),d=Math.max(0,(c-1)*i+o-n),m=Math.floor(h/2),g=h-m,v=Math.floor(d/2);u={top:m,bottom:g,left:v,right:d-v,type:"SAME"}}else{if("valid"!==t)throw Error("Unknown padding parameter: "+t);u={top:0,bottom:0,left:0,right:0,type:"VALID"},l=Math.ceil((e-a+1)/r),c=Math.ceil((n-o+1)/i)}return{padInfo:u,outHeight:l,outWidth:c}}(i,c,p,x,w,S,k,a),A=I.padInfo,R=I.outHeight,T=I.outWidth,D=o?v*h:v;return"channelsFirst"===s?d=[l,D,R,T]:"channelsLast"===s&&(d=[l,R,T,D]),{batchSize:l,dataFormat:s,inHeight:c,inWidth:p,inChannels:h,outHeight:R,outWidth:T,outChannels:D,padInfo:A,strideHeight:x,strideWidth:w,filterHeight:m,filterWidth:g,effectiveFilterHeight:S,effectiveFilterWidth:k,dilationHeight:C,dilationWidth:E,inShape:t,outShape:d,filterShape:e}}function Br(t,e,n,r,i,a,o,s){void 0===a&&(a=!1),void 0===o&&(o="channelsLast");var u=[-1,-1,-1,-1,-1],l=u[0],c=u[1],p=u[2],h=u[3],d=u[4];if("channelsLast"===o)l=t[0],c=t[1],p=t[2],h=t[3],d=t[4];else{if("channelsFirst"!==o)throw new Error("Unknown dataFormat "+o);l=t[0],d=t[1],c=t[2],p=t[3],h=t[4]}var m,g=e[0],v=e[1],y=e[2],x=e[4],w=Ur(n),N=w[0],C=w[1],E=w[2],S=Ur(r),k=S[0],I=S[1],A=S[2],R=jr(g,k),T=jr(v,I),D=jr(y,A),O=function(t,e,n,r,i,a,o,s,u,l,c){var p,h,d,m;if("number"==typeof t){p={top:t,bottom:t,left:t,right:t,front:t,back:t,type:0===t?"VALID":"NUMBER"};var g=function(t,e,n,r,i,a){null==i&&(i=Vr(t,e,r));var o=t[1],s=t[2],u=qr((t[0]-e+2*i)/r+1,a);f(b(u),function(){return"The output # of depths ("+u+") must be an integer. Change the stride and/or zero pad parameters"});var l=qr((o-e+2*i)/r+1,a);f(b(l),function(){return"The output # of rows ("+l+") must be an integer. Change the stride and/or zero pad parameters"});var c=qr((s-e+2*i)/r+1,a);return f(b(c),function(){return"The output # of columns ("+c+") must be an integer. Change the stride and/or zero pad parameters"}),[u,l,c,1]}([e,n,r,1],s,0,i,t,c);h=g[0],d=g[1],m=g[2]}else if("same"===t){var v=((h=Math.ceil(e/i))-1)*i+s-e,y=((d=Math.ceil(n/a))-1)*a+u-n,x=((m=Math.ceil(r/o))-1)*o+l-r,w=Math.floor(v/2),N=v-w,C=Math.floor(y/2),E=y-C,S=Math.floor(x/2);p={top:C,bottom:E,left:S,right:x-S,front:w,back:N,type:"SAME"}}else{if("valid"!==t)throw Error("Unknown padding parameter: "+t);p={top:0,bottom:0,left:0,right:0,front:0,back:0,type:"VALID"},h=Math.ceil((e-s+1)/i),d=Math.ceil((n-u+1)/a),m=Math.ceil((r-l+1)/o)}return{padInfo:p,outDepth:h,outHeight:d,outWidth:m}}(i,c,p,h,N,C,E,R,T,D,s),_=O.padInfo,F=O.outDepth,M=O.outHeight,z=O.outWidth,L=a?x*d:x;return"channelsFirst"===o?m=[l,L,F,M,z]:"channelsLast"===o&&(m=[l,F,M,z,L]),{batchSize:l,dataFormat:o,inDepth:c,inHeight:p,inWidth:h,inChannels:d,outDepth:F,outHeight:M,outWidth:z,outChannels:L,padInfo:_,strideDepth:N,strideHeight:C,strideWidth:E,filterDepth:g,filterHeight:v,filterWidth:y,effectiveFilterDepth:R,effectiveFilterHeight:T,effectiveFilterWidth:D,dilationDepth:k,dilationHeight:I,dilationWidth:A,inShape:t,outShape:m,filterShape:e}}function Vr(t,e,n,r){void 0===r&&(r=1);var i=jr(e,r);return Math.floor((t[0]*(n-1)-n+i)/2)}function Wr(t){return"number"==typeof t?[t,t,t]:2===t.length?[t[0],t[1],1]:t}function Ur(t){return"number"==typeof t?[t,t,t]:t}function jr(t,e){return e<=1?t:t+(t-1)*(e-1)}function qr(t,e){if(!e)return t;switch(e){case"round":return Math.round(t);case"ceil":return Math.ceil(t);case"floor":return Math.floor(t);default:throw new Error("Unknown roundingMode "+e)}}function Hr(t){var e=Wr(t),n=e[0],r=e[1],i=e[2];return 1===n&&1===r&&1===i}function Gr(t,e){return Hr(t)||Hr(e)}function Kr(t){if("NHWC"===t)return"channelsLast";if("NCHW"===t)return"channelsFirst";throw new Error("Unknown dataFormat "+t)}function $r(t,e,n){if("complex64"===e){if("complex64"===t.dtype)return t.clone();var r=dn(t.shape),i=t.toFloat(),a=n.complex(i,r);return r.dispose(),i.dispose(),a}if(!O(t.dtype,e))return ct.make(t.shape,{dataId:t.dataId},e);if("complex64"===t.dtype){var o=n.real(t);return a=o.cast(e),o.dispose(),a}if("int32"===e)return n.int(t);if("bool"===e){var s=on(0,t.dtype);return a=n.notEqual(t,s),s.dispose(),a}throw new Error("Error in Cast: failed to cast "+t.dtype+" to "+e)}function Xr(t,e){return ct.make(e,{dataId:t.dataId},t.dtype)}function Yr(t,e,n){var r=(e-t)/(n-1),i=G(n,"float32");i[0]=t;for(var a=1;a<i.length;a++)i[a]=i[a-1]+r;return sn(i,"float32")}var Jr=Object.freeze({castTensor:$r,reshapeTensor:Xr,linspaceImpl:Yr,upcastType:yt,axesAreInnerMostDims:je,combineLocations:qe,computeOutAndReduceShapes:He,expandShapeToKeepDim:Ge,assertAxesAreInnerMostDims:Ke,getAxesPermutation:$e,getUndoAxesPermutation:Xe,getInnerMostAxes:Ye,getBroadcastDims:_r,getReductionAxes:Fr,assertAndGetBroadcastShape:Mr,assertParamsConsistent:Je,computeOutShape:Ze,computePool2DInfo:zr,computePool3DInfo:Lr,computeConv2DInfo:Pr,computeConv3DInfo:Br,computeDefaultPad:Vr,tupleValuesAreOne:Hr,eitherStridesOrDilationsAreOne:Gr,convertConv2DDataFormat:Kr});function Zr(t,e){if(t.length!==e.length)throw new Error("Cannot merge real and imag arrays of different lengths. real:"+t.length+", imag: "+e.length+".");for(var n=new Float32Array(2*t.length),r=0;r<n.length;r+=2)n[r]=t[r/2],n[r+1]=e[r/2];return n}function Qr(t,e){return{real:t[2*e],imag:t[2*e+1]}}function ti(t,e,n,r){t[2*r]=e,t[2*r+1]=n}function ei(t,e,n){var r=(n?2:-2)*Math.PI*(t/e);return{real:Math.cos(r),imag:Math.sin(r)}}function ni(t,e,n,r,i){for(var a=Array.from(e).map(function(t,e){return{score:t,boxIndex:e}}).filter(function(t){return t.score>i}).sort(function(t,e){return e.score-t.score}),o=[],s=0;s<a.length;s++){var u=a[s],l=u.score,c=u.boxIndex;if(l<i)break;for(var p=!1,h=o.length-1;h>=0;--h)if(ri(t,c,o[h])>=r){p=!0;break}if(!p&&(o.push(c),o.length>=n))break}return sn(o,"int32")}function ri(t,e,n){var r=t.subarray(4*e,4*e+4),i=t.subarray(4*n,4*n+4),a=Math.min(r[0],r[2]),o=Math.min(r[1],r[3]),s=Math.max(r[0],r[2]),u=Math.max(r[1],r[3]),l=Math.min(i[0],i[2]),c=Math.min(i[1],i[3]),p=Math.max(i[0],i[2]),h=Math.max(i[1],i[3]),f=(s-a)*(u-o),d=(p-l)*(h-c);if(f<=0||d<=0)return 0;var m=Math.max(a,l),g=Math.max(o,c),v=Math.min(s,p),y=Math.min(u,h),b=Math.max(v-m,0)*Math.max(y-g,0);return b/(f+d-b)}function ii(t,e,n){var r=new Array(t.rank).fill(0),i=t.shape.slice();return e.map(function(e){i[n]=e;var a=t.slice(r,i);return r[n]+=e,a})}function ai(t,e){for(var n=new Array(t.rank),r=0;r<n.length;r++)n[r]=t.shape[r]*e[r];var i=Pn(n,t.dtype);for(r=0;r<i.values.length;++r){for(var a=i.indexToLoc(r),o=new Array(t.rank),s=0;s<o.length;s++)o[s]=a[s]%t.shape[s];var u=t.locToIndex(o);i.values[r]=t.values[u]}return i.toTensor()}function oi(t,e,n,r,i){for(var a=e[e.length-1],o=[t.length/a,a],s=o[0],u=o[1],l=I(n,s*r),c=I("int32",s*r),p=0;p<s;p++){for(var h=p*u,f=t.subarray(h,h+u),d=[],m=0;m<f.length;m++)d.push({value:f[m],index:m});d.sort(function(t,e){return e.value-t.value});var g=p*r,v=l.subarray(g,g+r),y=c.subarray(g,g+r);for(m=0;m<r;m++)v[m]=d[m].value,y[m]=d[m].index}var b=e.slice();return b[b.length-1]=r,[rn(l,b,n),rn(c,b,"int32")]}function si(t,e){for(var n=[],r=0;r<e.length;r++)e[r]&&n.push(r);var i=Pn(t,"int32"),a=Pn([n.length,t.length],"int32");for(r=0;r<n.length;r++){var o=i.indexToLoc(n[r]),s=r*t.length;a.values.set(o,s)}return a.toTensor()}var ui=function(t,e){this.outputShape=[],this.outputShape=t,this.variableNames=e.map(function(t,e){return"T"+e});var n=[];this.variableNames.forEach(function(t){n.push("float v"+t+" = get"+t+"AtOutCoords();")});var r=this.variableNames.map(function(t){return"v"+t}).join(" + ");this.userCode="\n      void main() {\n        "+n.join("\n        ")+"\n\n        float result = "+r+";\n        setOutput(result);\n      }\n    "},li=function(t,e){this.outputShape=[],this.usesPackedTextures=!0,this.outputShape=t,this.variableNames=e.map(function(t,e){return"T"+e});var n=[];this.variableNames.forEach(function(t){n.push("vec4 v"+t+" = get"+t+"AtOutCoords();")});var r=this.variableNames.map(function(t){return"v"+t}).join(" + ");this.userCode="\n      void main() {\n        "+n.join("\n        ")+"\n\n        vec4 result = "+r+";\n        setOutput(result);\n      }\n    "},ci=function(t,e,n){this.variableNames=["A"];var r=t.windowSize,i=t.batchSize,a=t.inSize,o=Math.ceil(a/r);n||this.variableNames.push("bestIndicesA"),this.outputShape=[i,o];var s="max"===e?">":"<",u=n?"inOffset + i;":"round(getBestIndicesA(batch, inOffset + i));";this.userCode="\n      void main() {\n        ivec2 coords = getOutputCoords();\n        int batch = coords[0];\n        int outIdx = coords[1];\n        int inOffset = outIdx * "+r+";\n\n        int bestIndex = inOffset;\n        float bestValue = getA(batch, bestIndex);\n\n        for (int i = 0; i < "+r+"; i++) {\n          int inIdx = "+u+";\n          float candidate = getA(batch, inIdx);\n          if (candidate "+s+" bestValue) {\n            bestValue = candidate;\n            bestIndex = inIdx;\n          }\n        }\n        setOutput(float(bestIndex));\n      }\n    "};function pi(t,e){return["x","y","z","w","u","v"].slice(0,e).map(function(e){return t+"."+e})}function hi(t,e){return 1===e?[t]:pi(t,e)}function fi(){var e,n,r,i,a,o,s,u,l,c;return 2===t.ENV.getNumber("WEBGL_VERSION")?(e="#version 300 es",n="in",r="out",i="in",a="texture",o="outputColor",s="out vec4 outputColor;",u="\n      bool isnan_custom(float val) {\n        return (val > 0. || val < 0. || val == 0.) ? false : true;\n      }\n    ",l="",c="\n      #define round(value) newRound(value)\n      int newRound(float value) {\n        return int(floor(value + 0.5));\n      }\n\n      ivec4 newRound(vec4 value) {\n        return ivec4(floor(value + vec4(0.5)));\n      }\n    "):(e="",n="attribute",r="varying",i="varying",a="texture2D",o="gl_FragColor",s="",u="\n      bool isnan_custom(float val) {\n        return (val > 0. || val < 1. || val == 0.) ? false : true;\n      }\n    ",l="\n      uniform float INFINITY;\n\n      bool isinf(float val) {\n        return abs(val) == INFINITY;\n      }\n      bvec4 isinf(vec4 val) {\n        return equal(abs(val), vec4(INFINITY));\n      }\n    ",c="\n      int round(float value) {\n        return int(floor(value + 0.5));\n      }\n\n      ivec4 round(vec4 value) {\n        return ivec4(floor(value + vec4(0.5)));\n      }\n    "),{version:e,attribute:n,varyingVs:r,varyingFs:i,texture2D:a,output:o,defineOutput:s,defineSpecialNaN:u,defineSpecialInf:l,defineRound:c}}function di(t,e,n){void 0===n&&(n="index");var r=U(e);return r.map(function(e,i){return"int "+t[i]+" = "+n+" / "+e+"; "+(i===r.length-1?"int "+t[i+1]+" = "+n+" - "+t[i]+" * "+e:"index -= "+t[i]+" * "+e)+";"}).join("")}function mi(t){var e=U(t).map(function(t){return t.toString()});return"\n  int getFlatIndex(ivec3 coords) {\n    return coords.x * "+e[0]+" + coords.y * "+e[1]+" + coords.z;\n  }\n"}var gi="\n  const float FLOAT_MAX = 1.70141184e38;\n  const float FLOAT_MIN = 1.17549435e-38;\n\n  lowp vec4 encode_float(highp float v) {\n    if (isnan(v)) {\n      return vec4(255, 255, 255, 255);\n    }\n\n    highp float av = abs(v);\n\n    if(av < FLOAT_MIN) {\n      return vec4(0.0, 0.0, 0.0, 0.0);\n    } else if(v > FLOAT_MAX) {\n      return vec4(0.0, 0.0, 128.0, 127.0) / 255.0;\n    } else if(v < -FLOAT_MAX) {\n      return vec4(0.0, 0.0,  128.0, 255.0) / 255.0;\n    }\n\n    highp vec4 c = vec4(0,0,0,0);\n\n    highp float e = floor(log2(av));\n    highp float m = exp2(fract(log2(av))) - 1.0;\n\n    c[2] = floor(128.0 * m);\n    m -= c[2] / 128.0;\n    c[1] = floor(32768.0 * m);\n    m -= c[1] / 32768.0;\n    c[0] = floor(8388608.0 * m);\n\n    highp float ebias = e + 127.0;\n    c[3] = floor(ebias / 2.0);\n    ebias -= c[3] * 2.0;\n    c[2] += floor(ebias) * 128.0;\n\n    c[3] += 128.0 * step(0.0, -v);\n\n    return c / 255.0;\n  }\n";function vi(t,e,n,r){var i=[];t.forEach(function(t){var e=v(t.shapeInfo.logicalShape);t.shapeInfo.isUniform?i.push("uniform float "+t.name+(e>1?"["+e+"]":"")+";"):(i.push("uniform sampler2D "+t.name+";"),i.push("uniform int offset"+t.name+";"))});var a,o,s=i.join("\n"),u=t.map(function(t){return function(t,e,n){void 0===n&&(n=!1);var r="";r+=n?function t(e){var n,r,i;switch(e.shapeInfo.logicalShape.length){case 0:return n=e.name,r="get"+n.charAt(0).toUpperCase()+n.slice(1),i=fi(),"\n    vec4 "+r+"() {\n      return "+i.texture2D+"("+n+", halfCR);\n    }\n  ";case 1:return function(t){var e=t.name,n="get"+e.charAt(0).toUpperCase()+e.slice(1),r=t.shapeInfo.texShape,i=[Math.ceil(r[0]/2),Math.ceil(r[1]/2)],a=fi();return"\n    vec4 "+n+"(int index) {\n      vec2 uv = packedUVfrom1D(\n        "+i[0]+", "+i[1]+", index);\n      return "+a.texture2D+"("+e+", uv);\n    }\n  "}(e);case 2:return function(t){var e=t.shapeInfo.logicalShape,n=t.name,r="get"+n.charAt(0).toUpperCase()+n.slice(1),i=t.shapeInfo.texShape,a=i[0],o=i[1],s=fi();if(null!=i&&y(e,i))return"\n      vec4 "+r+"(int row, int col) {\n        vec2 uv = (vec2(col, row) + halfCR) / vec2("+o+".0, "+a+".0);\n\n        return "+s.texture2D+"("+n+", uv);\n      }\n    ";var u=[Math.ceil(i[0]/2),Math.ceil(i[1]/2)],l=Math.ceil(e[1]/2);return"\n    vec4 "+r+"(int row, int col) {\n      vec2 uv = packedUVfrom2D("+l+", "+u[0]+", "+u[1]+", row, col);\n      return "+s.texture2D+"("+n+", uv);\n    }\n  "}(e);case 3:return function(e){var n=e.shapeInfo.logicalShape,r=e.name,i="get"+r.charAt(0).toUpperCase()+r.slice(1),a=e.shapeInfo.texShape,o=[Math.ceil(a[0]/2),Math.ceil(a[1]/2)];if(1===n[0]){var s=n.slice(1),u=Si(e,s);return"\n        "+t(u)+"\n        vec4 "+i+"(int b, int row, int col) {\n          return "+i+"("+ki(["b","row","col"],[1,2])+");\n        }\n      "}var l=o[0],c=o[1],p=Math.ceil(n[2]/2),h=p*Math.ceil(n[1]/2),f=fi();return"\n    vec4 "+i+"(int b, int row, int col) {\n      vec2 uv = packedUVfrom3D(\n        "+l+", "+c+", "+h+", "+p+", b, row, col);\n      return "+f.texture2D+"("+r+", uv);\n    }\n  "}(e);default:return function(t){for(var e=t.shapeInfo.logicalShape,n=e.length,r=t.name,i="get"+r.charAt(0).toUpperCase()+r.slice(1),a=t.shapeInfo.texShape,o=[Math.ceil(a[0]/2),Math.ceil(a[1]/2)],s=o[0],u=o[1],l=Math.ceil(e[n-1]/2),c=l*Math.ceil(e[n-2]/2),p="int b, int row, int col",h="b * "+c+" + (row / 2) * "+l+" + (col / 2)",f=2;f<n-1;f++)p="int b"+f+", "+p,c*=e[n-f-1],h="b"+f+" * "+c+" + "+h;var d=fi();return"\n    vec4 "+i+"("+p+") {\n      int index = "+h+";\n      int texR = index / "+u+";\n      int texC = index - texR * "+u+";\n      vec2 uv = (vec2(texC, texR) + halfCR) / vec2("+u+", "+s+");\n      return "+d.texture2D+"("+r+", uv);\n    }\n  "}(e)}}(t):function t(e){var n=e.shapeInfo.logicalShape;switch(n.length){case 0:return function(t){var e=t.name,n="get"+e.charAt(0).toUpperCase()+e.slice(1);if(t.shapeInfo.isUniform)return"float "+n+"() {return "+e+";}";var r=t.shapeInfo.texShape,i=r[0],a=r[1];if(1===i&&1===a)return"\n      float "+n+"() {\n        return sampleTexture("+e+", halfCR);\n      }\n    ";var o=t.shapeInfo.texShape,s=o[0],u=o[1],l=Ni(e);return"\n    float "+n+"() {\n      vec2 uv = uvFromFlat("+s+", "+u+", "+l+");\n      return sampleTexture("+e+", uv);\n    }\n  "}(e);case 1:return function(t){var e=t.name,n="get"+e.charAt(0).toUpperCase()+e.slice(1);if(t.shapeInfo.isUniform)return"\n      float "+n+"(int index) {\n        "+Ci(t)+"\n      }\n    ";var r=t.shapeInfo.texShape,i=r[0],a=r[1];if(1===a&&1===i)return"\n      float "+n+"(int index) {\n        return sampleTexture("+e+", halfCR);\n      }\n    ";var o=Ni(e);return 1===a?"\n      float "+n+"(int index) {\n        vec2 uv = vec2(0.5, (float(index + "+o+") + 0.5) / "+i+".0);\n        return sampleTexture("+e+", uv);\n      }\n    ":1===i?"\n      float "+n+"(int index) {\n        vec2 uv = vec2((float(index + "+o+") + 0.5) / "+a+".0, 0.5);\n        return sampleTexture("+e+", uv);\n      }\n    ":"\n    float "+n+"(int index) {\n      vec2 uv = uvFromFlat("+i+", "+a+", index + "+o+");\n      return sampleTexture("+e+", uv);\n    }\n  "}(e);case 2:return function(e){var n=e.shapeInfo.logicalShape,r=e.name,i="get"+r.charAt(0).toUpperCase()+r.slice(1),a=e.shapeInfo.texShape;if(null!=a&&y(n,a)){var o=a[0],s=a[1];return"\n    float "+i+"(int row, int col) {\n      vec2 uv = (vec2(col, row) + halfCR) / vec2("+s+".0, "+o+".0);\n      return sampleTexture("+r+", uv);\n    }\n  "}var u=k(n),l=u.newShape,c=u.keptDims,p=l;if(p.length<n.length){var h=Si(e,p);return"\n      "+t(h)+"\n      float "+i+"(int row, int col) {\n        return "+i+"("+ki(["row","col"],c)+");\n      }\n    "}if(e.shapeInfo.isUniform)return"\n      float "+i+"(int row, int col) {\n        int index = round(dot(vec2(row, col), vec2("+n[1]+", 1)));\n        "+Ci(e)+"\n      }\n    ";var f=a[0],d=a[1],m=Ni(r);return 1===d?"\n    float "+i+"(int row, int col) {\n      float index = dot(vec3(row, col, "+m+"), vec3("+n[1]+", 1, 1));\n      vec2 uv = vec2(0.5, (index + 0.5) / "+f+".0);\n      return sampleTexture("+r+", uv);\n    }\n  ":1===f?"\n    float "+i+"(int row, int col) {\n      float index = dot(vec3(row, col, "+m+"), vec3("+n[1]+", 1, 1));\n      vec2 uv = vec2((index + 0.5) / "+d+".0, 0.5);\n      return sampleTexture("+r+", uv);\n    }\n  ":"\n  float "+i+"(int row, int col) {\n    // Explicitly use integer operations as dot() only works on floats.\n    int index = row * "+n[1]+" + col + "+m+";\n    vec2 uv = uvFromFlat("+f+", "+d+", index);\n    return sampleTexture("+r+", uv);\n  }\n"}(e);case 3:return function(e){var n=e.shapeInfo.logicalShape,r=e.name,i="get"+r.charAt(0).toUpperCase()+r.slice(1),a=n[1]*n[2],o=n[2],s=k(n),u=s.newShape,l=s.keptDims,c=u;if(c.length<n.length){var p=Si(e,c);return"\n        "+t(p)+"\n        float "+i+"(int row, int col, int depth) {\n          return "+i+"("+ki(["row","col","depth"],l)+");\n        }\n      "}if(e.shapeInfo.isUniform)return"\n      float "+i+"(int row, int col, int depth) {\n        int index = round(dot(vec3(row, col, depth),\n                          vec3("+a+", "+o+", 1)));\n        "+Ci(e)+"\n      }\n    ";var h=e.shapeInfo.texShape,f=h[0],d=h[1],m=e.shapeInfo.flatOffset;if(d===a&&null==m)return"\n        float "+i+"(int row, int col, int depth) {\n          float texR = float(row);\n          float texC = dot(vec2(col, depth), vec2("+o+", 1));\n          vec2 uv = (vec2(texC, texR) + halfCR) /\n                     vec2("+d+".0, "+f+".0);\n          return sampleTexture("+r+", uv);\n        }\n      ";if(d===o&&null==m)return"\n    float "+i+"(int row, int col, int depth) {\n      float texR = dot(vec2(row, col), vec2("+n[1]+", 1));\n      float texC = float(depth);\n      vec2 uv = (vec2(texC, texR) + halfCR) / vec2("+d+".0, "+f+".0);\n      return sampleTexture("+r+", uv);\n    }\n  ";var g=Ni(r);return"\n      float "+i+"(int row, int col, int depth) {\n        // Explicitly use integer operations as dot() only works on floats.\n        int index = row * "+a+" + col * "+o+" + depth + "+g+";\n        vec2 uv = uvFromFlat("+f+", "+d+", index);\n        return sampleTexture("+r+", uv);\n      }\n  "}(e);case 4:return function(e){var n=e.shapeInfo.logicalShape,r=e.name,i="get"+r.charAt(0).toUpperCase()+r.slice(1),a=n[3],o=n[2]*a,s=n[1]*o,u=k(n),l=u.newShape,c=u.keptDims;if(l.length<n.length){var p=Si(e,l);return"\n      "+t(p)+"\n      float "+i+"(int row, int col, int depth, int depth2) {\n        return "+i+"("+ki(["row","col","depth","depth2"],c)+");\n      }\n    "}if(e.shapeInfo.isUniform)return"\n      float "+i+"(int row, int col, int depth, int depth2) {\n        int index = round(dot(vec4(row, col, depth, depth2),\n                          vec4("+s+", "+o+", "+a+", 1)));\n        "+Ci(e)+"\n      }\n    ";var h=e.shapeInfo.flatOffset,f=e.shapeInfo.texShape,d=f[0],m=f[1];if(m===s&&null==h)return"\n      float "+i+"(int row, int col, int depth, int depth2) {\n        float texR = float(row);\n        float texC =\n            dot(vec3(col, depth, depth2),\n                vec3("+o+", "+a+", 1));\n        vec2 uv = (vec2(texC, texR) + halfCR) /\n                   vec2("+m+".0, "+d+".0);\n        return sampleTexture("+r+", uv);\n      }\n    ";if(m===a&&null==h)return"\n      float "+i+"(int row, int col, int depth, int depth2) {\n        float texR = dot(vec3(row, col, depth),\n                         vec3("+n[1]*n[2]+", "+n[2]+", 1));\n        float texC = float(depth2);\n        vec2 uv = (vec2(texC, texR) + halfCR) /\n                  vec2("+m+".0, "+d+".0);\n        return sampleTexture("+r+", uv);\n      }\n    ";var g=Ni(r);return"\n    float "+i+"(int row, int col, int depth, int depth2) {\n      // Explicitly use integer operations as dot() only works on floats.\n      int index = row * "+s+" + col * "+o+" +\n          depth * "+a+" + depth2;\n      vec2 uv = uvFromFlat("+d+", "+m+", index + "+g+");\n      return sampleTexture("+r+", uv);\n    }\n  "}(e);case 5:return function(e){var n=e.shapeInfo.logicalShape,r=e.name,i="get"+r.charAt(0).toUpperCase()+r.slice(1),a=n[4],o=n[3]*a,s=n[2]*o,u=n[1]*s,l=k(n),c=l.newShape,p=l.keptDims;if(c.length<n.length){var h=Si(e,c);return"\n      "+t(h)+"\n      float "+i+"(int row, int col, int depth, int depth2, int depth3) {\n        return "+i+"("+ki(["row","col","depth","depth2","depth3"],p)+");\n      }\n    "}if(e.shapeInfo.isUniform)return"\n      float "+i+"(int row, int col, int depth, int depth2, int depth3) {\n        float index = dot(\n          vec4(row, col, depth, depth2),\n          vec4("+u+", "+s+", "+o+", "+a+")) +\n          depth3;\n        "+Ci(e)+"\n      }\n    ";var f=e.shapeInfo.flatOffset,d=e.shapeInfo.texShape,m=d[0],g=d[1];if(g===u&&null==f)return"\n      float "+i+"(int row, int col, int depth, int depth2, int depth3) {\n        int texR = row;\n        float texC = dot(vec4(col, depth, depth2, depth3),\n                         vec4("+s+", "+o+", "+a+", 1));\n        vec2 uv = (vec2(texC, texR) + halfCR) /\n                   vec2("+g+".0, "+m+".0);\n        return sampleTexture("+r+", uv);\n      }\n    ";if(g===a&&null==f)return"\n      float "+i+"(int row, int col, int depth, int depth2, int depth3) {\n        float texR = dot(\n          vec4(row, col, depth, depth2),\n          vec4("+n[1]*n[2]*n[3]+",\n               "+n[2]*n[3]+", "+n[3]+", 1));\n        int texC = depth3;\n        vec2 uv = (vec2(texC, texR) + halfCR) /\n                  vec2("+g+".0, "+m+".0);\n        return sampleTexture("+r+", uv);\n      }\n    ";var v=Ni(r);return"\n    float "+i+"(int row, int col, int depth, int depth2, int depth3) {\n      // Explicitly use integer operations as dot() only works on floats.\n      int index = row * "+u+" + col * "+s+" + depth * "+o+" +\n          depth2 * "+a+" + depth3 + "+v+";\n      vec2 uv = uvFromFlat("+m+", "+g+", index);\n      return sampleTexture("+r+", uv);\n    }\n  "}(e);case 6:return function(e){var n=e.shapeInfo.logicalShape,r=e.name,i="get"+r.charAt(0).toUpperCase()+r.slice(1),a=k(n),o=a.newShape,s=a.keptDims;if(o.length<n.length){var u=Si(e,o);return"\n      "+t(u)+"\n      float "+i+"(int row, int col, int depth,\n                    int depth2, int depth3, int depth4) {\n        return "+i+"("+ki(["row","col","depth","depth2","depth3","depth4"],s)+");\n      }\n    "}var l=n[5],c=n[4]*l,p=n[3]*c,h=n[2]*p,f=n[1]*h;if(e.shapeInfo.isUniform)return"\n      float "+i+"(int row, int col, int depth,\n                  int depth2, int depth3, int depth4) {\n        int index = round(dot(\n          vec4(row, col, depth, depth2),\n          vec4("+f+", "+h+", "+p+", "+c+")) +\n          dot(\n            vec2(depth3, depth4),\n            vec2("+l+", 1)));\n        "+Ci(e)+"\n      }\n    ";var d=e.shapeInfo.flatOffset,m=e.shapeInfo.texShape,g=m[0],v=m[1];if(v===f&&null==d)return"\n      float "+i+"(int row, int col, int depth,\n                    int depth2, int depth3, int depth4) {\n        int texR = row;\n        float texC = dot(vec4(col, depth, depth2, depth3),\n          vec4("+h+", "+p+", "+c+", "+l+")) +\n               float(depth4);\n        vec2 uv = (vec2(texC, texR) + halfCR) /\n                   vec2("+v+".0, "+g+".0);\n        return sampleTexture("+r+", uv);\n      }\n    ";if(v===l&&null==d)return"\n      float "+i+"(int row, int col, int depth,\n                    int depth2, int depth3, int depth4) {\n        float texR = dot(vec4(row, col, depth, depth2),\n          vec4("+n[1]*n[2]*n[3]*n[4]+",\n               "+n[2]*n[3]*n[4]+",\n               "+n[3]*n[4]+",\n               "+n[4]+")) + float(depth3);\n        int texC = depth4;\n        vec2 uv = (vec2(texC, texR) + halfCR) /\n                  vec2("+v+".0, "+g+".0);\n        return sampleTexture("+r+", uv);\n      }\n    ";var y=Ni(r);return"\n    float "+i+"(int row, int col, int depth,\n                  int depth2, int depth3, int depth4) {\n      // Explicitly use integer operations as dot() only works on floats.\n      int index = row * "+f+" + col * "+h+" + depth * "+p+" +\n          depth2 * "+c+" + depth3 * "+l+" + depth4 + "+y+";\n      vec2 uv = uvFromFlat("+g+", "+v+", index);\n      return sampleTexture("+r+", uv);\n    }\n  "}(e);default:throw new Error(n.length+"-D input sampling is not yet supported")}}(t);var i=t.shapeInfo.logicalShape,a=e.logicalShape;return i.length<=a.length&&(r+=n?function(t,e){var n,r=t.name,i=r.charAt(0).toUpperCase()+r.slice(1),a="get"+i+"AtOutCoords",o=t.shapeInfo.logicalShape.length,s=e.logicalShape.length,u=_r(t.shapeInfo.logicalShape,e.logicalShape),l=Ei(s),c=s-o,p=["x","y","z","w","u","v"];n=0===o?"":s<2&&u.length>=1?"coords = 0;":u.map(function(t){return"coords."+p[t+c]+" = 0;"}).join("\n");var h;h=s<2&&o>0?"coords":t.shapeInfo.logicalShape.map(function(t,e){return"coords."+p[e+c]}).join(", ");var f="return outputValue;",d=1===v(t.shapeInfo.logicalShape),m=1===v(e.logicalShape);if(1!==o||d||m){if(d&&!m)f=1===s?"\n        return vec4(outputValue.x, outputValue.x, 0., 0.);\n      ":"\n        return vec4(outputValue.x);\n      ";else if(u.length){var g=o-2,y=o-1;u.indexOf(g)>-1&&u.indexOf(y)>-1?f="return vec4(outputValue.x);":u.indexOf(g)>-1?f="return vec4(outputValue.x, outputValue.y, outputValue.x, outputValue.y);":u.indexOf(y)>-1&&(f="return vec4(outputValue.xx, outputValue.zz);")}}else f="\n      return vec4(outputValue.xy, outputValue.xy);\n    ";return"\n    vec4 "+a+"() {\n      "+l+" coords = getOutputCoords();\n      "+n+"\n      vec4 outputValue = get"+i+"("+h+");\n      "+f+"\n    }\n  "}(t,e):function(t,e){var n=t.name,r=n.charAt(0).toUpperCase()+n.slice(1),i="get"+r+"AtOutCoords",a=e.texShape,o=t.shapeInfo.texShape,s=t.shapeInfo.logicalShape.length,u=e.logicalShape.length;if(!t.shapeInfo.isUniform&&s===u&&null==t.shapeInfo.flatOffset&&y(o,a))return"\n      float "+i+"() {\n        return sampleTexture("+n+", resultUV);\n      }\n    ";var l=Ei(u),c=_r(t.shapeInfo.logicalShape,e.logicalShape),p=u-s,h=["x","y","z","w","u","v"];return"\n    float "+i+"() {\n      "+l+" coords = getOutputCoords();\n      "+(0===s?"":u<2&&c.length>=1?"coords = 0;":c.map(function(t){return"coords."+h[t+p]+" = 0;"}).join("\n"))+"\n      return get"+r+"("+(u<2&&s>0?"coords":t.shapeInfo.logicalShape.map(function(t,e){return"coords."+h[e+p]}).join(", "))+");\n    }\n  "}(t,e)),r}(t,e,r)}).join("\n"),l=e.texShape,c=fi(),p="\n    float sampleTexture(sampler2D textureSampler, vec2 uv) {\n      return "+c.texture2D+"(textureSampler, uv).r;\n    }\n  ",h=function(t){return t.version+"\n    precision highp float;\n    precision highp int;\n    precision highp sampler2D;\n    "+t.varyingFs+" vec2 resultUV;\n    "+t.defineOutput+"\n    const vec2 halfCR = vec2(0.5, 0.5);\n\n    struct ivec5\n    {\n      int x;\n      int y;\n      int z;\n      int w;\n      int u;\n    };\n\n    struct ivec6\n    {\n      int x;\n      int y;\n      int z;\n      int w;\n      int u;\n      int v;\n    };\n\n    uniform float NAN;\n    #define isnan(value) isnan_custom(value)\n    "+t.defineSpecialNaN+"\n    bvec4 isnan_custom(vec4 val) {\n      return bvec4(isnan(val.x), isnan(val.y), isnan(val.z), isnan(val.w));\n    }\n\n    "+t.defineSpecialInf+"\n    "+t.defineRound+"\n\n    int imod(int x, int y) {\n      return x - y * (x / y);\n    }\n\n    int idiv(int a, int b, float sign) {\n      int res = a / b;\n      int mod = imod(a, b);\n      if (sign < 0. && mod != 0) {\n        res -= 1;\n      }\n      return res;\n    }\n\n    //Based on the work of Dave Hoskins\n    //https://www.shadertoy.com/view/4djSRW\n    #define HASHSCALE1 443.8975\n    float random(float seed){\n      vec2 p = resultUV * seed;\n      vec3 p3  = fract(vec3(p.xyx) * HASHSCALE1);\n      p3 += dot(p3, p3.yzx + 19.19);\n      return fract((p3.x + p3.y) * p3.z);\n    }\n\n    "+yi+"\n    "+bi+"\n    "+xi+"\n  "}(c);return e.isPacked?(a=function(t,e){switch(t.length){case 0:return"\n    int getOutputCoords() {\n      return 0;\n    }\n  ";case 1:return function(t,e){var n=[Math.ceil(e[0]/2),Math.ceil(e[1]/2)];return 1===n[0]?"\n      int getOutputCoords() {\n        return 2 * int(resultUV.x * "+n[1]+".0);\n      }\n    ":1===n[1]?"\n      int getOutputCoords() {\n        return 2 * int(resultUV.y * "+n[0]+".0);\n      }\n    ":"\n    int getOutputCoords() {\n      ivec2 resTexRC = ivec2(resultUV.yx *\n                             vec2("+n[0]+", "+n[1]+"));\n      return 2 * (resTexRC.x * "+n[1]+" + resTexRC.y);\n    }\n  "}(0,e);case 2:return function(t,e){var n=[Math.ceil(e[0]/2),Math.ceil(e[1]/2)];if(y(t,e))return"\n      ivec2 getOutputCoords() {\n        return 2 * ivec2(resultUV.yx * vec2("+n[0]+", "+n[1]+"));\n      }\n    ";var r=Math.ceil(t[1]/2);return"\n    ivec2 getOutputCoords() {\n      ivec2 resTexRC = ivec2(resultUV.yx *\n                             vec2("+n[0]+", "+n[1]+"));\n\n      int index = resTexRC.x * "+n[1]+" + resTexRC.y;\n      int r = 2 * (index / "+r+");\n      int c = imod(index, "+r+") * 2;\n\n      return ivec2(r, c);\n    }\n  "}(t,e);case 3:return n=t,r=e,i=[Math.ceil(r[0]/2),Math.ceil(r[1]/2)],o=(a=Math.ceil(n[2]/2))*Math.ceil(n[1]/2),"\n    ivec3 getOutputCoords() {\n      ivec2 resTexRC = ivec2(resultUV.yx *\n                             vec2("+i[0]+", "+i[1]+"));\n      int index = resTexRC.x * "+i[1]+" + resTexRC.y;\n\n      int b = index / "+o+";\n      index -= b * "+o+";\n\n      int r = 2 * (index / "+a+");\n      int c = imod(index, "+a+") * 2;\n\n      return ivec3(b, r, c);\n    }\n  ";default:return function(t,e){for(var n=[Math.ceil(e[0]/2),Math.ceil(e[1]/2)],r=Math.ceil(t[t.length-1]/2),i=r*Math.ceil(t[t.length-2]/2),a=i,o="",s="b, r, c",u=2;u<t.length-1;u++)o="\n      int b"+u+" = index / "+(a*=t[t.length-u-1])+";\n      index -= b"+u+" * "+a+";\n    "+o,s="b"+u+", "+s;return"\n    ivec"+t.length+" getOutputCoords() {\n      ivec2 resTexRC = ivec2(resultUV.yx *\n                             vec2("+n[0]+", "+n[1]+"));\n      int index = resTexRC.x * "+n[1]+" + resTexRC.y;\n\n      "+o+"\n\n      int b = index / "+i+";\n      index -= b * "+i+";\n\n      int r = 2 * (index / "+r+");\n      int c = imod(index, "+r+") * 2;\n\n      return ivec"+t.length+"("+s+");\n    }\n  "}(t,e)}var n,r,i,a,o}(e.logicalShape,l),o="\n    void setOutput(vec4 val) {\n      "+c.output+" = val;\n    }\n  "):(a=function(t,e){switch(t.length){case 0:return"\n    int getOutputCoords() {\n      return 0;\n    }\n  ";case 1:return function(t,e){return 1===e[0]?"\n      int getOutputCoords() {\n        return int(resultUV.x * "+e[1]+".0);\n      }\n    ":1===e[1]?"\n      int getOutputCoords() {\n        return int(resultUV.y * "+e[0]+".0);\n      }\n    ":"\n    int getOutputCoords() {\n      ivec2 resTexRC = ivec2(resultUV.yx *\n                             vec2("+e[0]+", "+e[1]+"));\n      return resTexRC.x * "+e[1]+" + resTexRC.y;\n    }\n  "}(0,e);case 2:return function(t,e){return y(t,e)?"\n      ivec2 getOutputCoords() {\n        return ivec2(resultUV.yx * vec2("+e[0]+", "+e[1]+"));\n      }\n    ":1===t[1]?"\n      ivec2 getOutputCoords() {\n        ivec2 resTexRC = ivec2(resultUV.yx *\n                               vec2("+e[0]+", "+e[1]+"));\n        int index = resTexRC.x * "+e[1]+" + resTexRC.y;\n        return ivec2(index, 0);\n      }\n    ":1===t[0]?"\n      ivec2 getOutputCoords() {\n        ivec2 resTexRC = ivec2(resultUV.yx *\n                               vec2("+e[0]+", "+e[1]+"));\n        int index = resTexRC.x * "+e[1]+" + resTexRC.y;\n        return ivec2(0, index);\n      }\n    ":"\n    ivec2 getOutputCoords() {\n      ivec2 resTexRC = ivec2(resultUV.yx *\n                             vec2("+e[0]+", "+e[1]+"));\n      int index = resTexRC.x * "+e[1]+" + resTexRC.y;\n      int r = index / "+t[1]+";\n      int c = index - r * "+t[1]+";\n      return ivec2(r, c);\n    }\n  "}(t,e);case 3:return n=e,r=di(["r","c","d"],t),"\n    ivec3 getOutputCoords() {\n      ivec2 resTexRC = ivec2(resultUV.yx *\n                             vec2("+n[0]+", "+n[1]+"));\n      int index = resTexRC.x * "+n[1]+" + resTexRC.y;\n      "+r+"\n      return ivec3(r, c, d);\n    }\n  ";case 4:return function(t,e){var n=di(["r","c","d","d2"],t);return"\n    ivec4 getOutputCoords() {\n      ivec2 resTexRC = ivec2(resultUV.yx *\n        vec2("+e[0]+", "+e[1]+"));\n      int index = resTexRC.x * "+e[1]+" + resTexRC.y;\n      "+n+"\n      return ivec4(r, c, d, d2);\n    }\n  "}(t,e);case 5:return function(t,e){var n=di(["r","c","d","d2","d3"],t);return"\n    ivec5 getOutputCoords() {\n      ivec2 resTexRC = ivec2(resultUV.yx * vec2("+e[0]+",\n                             "+e[1]+"));\n\n      int index = resTexRC.x * "+e[1]+" + resTexRC.y;\n\n      "+n+"\n\n      ivec5 outShape = ivec5(r, c, d, d2, d3);\n      return outShape;\n    }\n  "}(t,e);case 6:return function(t,e){var n=di(["r","c","d","d2","d3","d4"],t);return"\n    ivec6 getOutputCoords() {\n      ivec2 resTexRC = ivec2(resultUV.yx *\n        vec2("+e[0]+", "+e[1]+"));\n      int index = resTexRC.x * "+e[1]+" + resTexRC.y;\n\n      "+n+"\n\n      ivec6 result = ivec6(r, c, d, d2, d3, d4);\n      return result;\n    }\n  "}(t,e);default:throw new Error(t.length+"-D output sampling is not yet supported")}var n,r}(e.logicalShape,l),o="\n    void setOutput(float val) {\n      "+c.output+" = vec4(val, 0, 0, 0);\n    }\n  "),r&&(h+=wi),[h,p,o,s,a,u,n].join("\n")}var yi="\nvec2 uvFromFlat(int texNumR, int texNumC, int index) {\n  int texR = index / texNumC;\n  int texC = index - texR * texNumC;\n  return (vec2(texC, texR) + halfCR) / vec2(texNumC, texNumR);\n}\nvec2 packedUVfrom1D(int texNumR, int texNumC, int index) {\n  int texelIndex = index / 2;\n  int texR = texelIndex / texNumC;\n  int texC = texelIndex - texR * texNumC;\n  return (vec2(texC, texR) + halfCR) / vec2(texNumC, texNumR);\n}\n",bi="\nvec2 packedUVfrom2D(int texelsInLogicalRow, int texNumR,\n  int texNumC, int row, int col) {\n  int texelIndex = (row / 2) * texelsInLogicalRow + (col / 2);\n  int texR = texelIndex / texNumC;\n  int texC = texelIndex - texR * texNumC;\n  return (vec2(texC, texR) + halfCR) / vec2(texNumC, texNumR);\n}\n",xi="\nvec2 packedUVfrom3D(int texNumR, int texNumC,\n    int texelsInBatch, int texelsInLogicalRow, int b,\n    int row, int col) {\n  int index = b * texelsInBatch + (row / 2) * texelsInLogicalRow + (col / 2);\n  int texR = index / texNumC;\n  int texC = index - texR * texNumC;\n  return (vec2(texC, texR) + halfCR) / vec2(texNumC, texNumR);\n}\n",wi="\n  float getChannel(vec4 frag, vec2 innerDims) {\n    vec2 modCoord = mod(innerDims, 2.);\n    return modCoord.x == 0. ?\n      (modCoord.y == 0. ? frag.r : frag.g) :\n      (modCoord.y == 0. ? frag.b : frag.a);\n  }\n  float getChannel(vec4 frag, int dim) {\n    float modCoord = mod(float(dim), 2.);\n    return modCoord == 0. ? frag.r : frag.g;\n  }\n";function Ni(t){return"offset"+t}function Ci(t){var e=t.name,n=v(t.shapeInfo.logicalShape);return n<2?"return "+e+";":"\n    for (int i = 0; i < "+n+"; i++) {\n      if (i == index) {\n        return "+e+"[i];\n      }\n    }\n  "}function Ei(t){if(t<=1)return"int";if(2===t)return"ivec2";if(3===t)return"ivec3";if(4===t)return"ivec4";if(5===t)return"ivec5";if(6===t)return"ivec6";throw Error("GPU for rank "+t+" is not yet supported")}function Si(t,e){var n=JSON.parse(JSON.stringify(t));return n.shapeInfo.logicalShape=e,n}function ki(t,e){return e.map(function(e){return t[e]}).join(", ")}var Ii=function(t,e,n,r){this.variableNames=["A"],this.usesPackedTextures=!0,f(t.length>2,function(){return"Packed arg"+(n.charAt(0).toUpperCase()+n.slice(1))+" supports only inputs with rank above 2."});var i=t[t.length-1],a=Math.ceil(i/e);this.outputShape=t.slice(0,-1),a>1&&this.outputShape.push(a),r||this.variableNames.push("bestIndicesA");var o,s,u=this.outputShape,l=u.length,c=Ei(l),p=hi("coords",l);if(1===a){var h=Ei(s=l+1);o="\n        "+h+" sourceLocR = "+h+"("+p.join()+", 0);\n        ++"+p[l-1]+";\n        "+h+" sourceLocG = "+h+"("+p.join()+", 0);\n        ++"+p[l-2]+";\n        "+h+" sourceLocA = "+h+"("+p.join()+", 0);\n        --"+p[l-1]+";\n        "+h+" sourceLocB = "+h+"("+p.join()+", 0);\n        --"+p[l-2]+";"}else s=l,o="\n        "+c+" sourceLocR = coords;\n        ++"+p[l-1]+";\n        "+c+" sourceLocG = coords;\n        ++"+p[l-2]+";\n        "+c+" sourceLocA = coords;\n        --"+p[l-1]+";\n        "+c+" sourceLocB = coords;\n        --"+p[l-2]+";";var d=["x","y","z","w","u","v"].slice(0,s),m="."+d[s-1],g=d.map(function(t){return"int "+t}),v=hi("sourceLocR",s-1).concat("inIdx.r"),y=hi("sourceLocG",s-1).concat("inIdx.g"),b=hi("sourceLocB",s-1).concat("inIdx.b"),x=hi("sourceLocA",s-1).concat("inIdx.a"),w="max"===n?"greaterThan":"lessThan",N=r?"":"\n          inIdx = round(vec4(getBestIndicesAChannel("+v.join()+"),\n                             getBestIndicesAChannel("+y.join()+"),\n                             getBestIndicesAChannel("+b.join()+"),\n                             getBestIndicesAChannel("+x.join()+")));",C="vec4(\n            getAChannel("+v.join()+"),\n            hasNextCol ? getAChannel("+y.join()+") : 0.,\n            hasNextRow ? getAChannel("+b.join()+") : 0.,\n            hasNextRow && hasNextCol ? getAChannel("+x.join()+") : 0.)",E=r?"":"\n      float getBestIndicesAChannel("+g.join()+") {\n        return getChannel(getBestIndicesA("+d.join()+"),\n                                          vec2("+d.slice(-2).join()+"));\n      }";this.userCode="\n      float getAChannel("+g.join()+") {\n        return getChannel(getA("+d.join()+"),\n                               vec2("+d.slice(-2).join()+"));\n      }\n      "+E+"\n      void main() {\n        "+c+" coords = getOutputCoords();\n        bool hasNextCol = "+p[l-1]+" < "+(u[l-1]-1)+";\n        bool hasNextRow = "+p[l-2]+" < "+(u[l-2]-1)+";\n        "+o+"\n        ivec4 srcIdx = ivec4(sourceLocR"+m+", sourceLocG"+m+",\n          sourceLocB"+m+", sourceLocA"+m+") * "+e+";\n        ivec4 inIdx = srcIdx;\n        vec4 bestIndex = vec4(inIdx);\n        vec4 bestValue = "+C+";\n\n        for (int i = 0; i < "+e+"; i++) {\n          inIdx = srcIdx;\n          "+N+"\n          vec4 candidate = "+C+";\n          bvec4 nan = isnan(candidate);\n          bvec4 replace = bvec4(\n            vec4("+w+"(candidate, bestValue)) * (vec4(1.0) - vec4(nan)));\n\n          bestValue = vec4(replace.x  ? candidate.x : bestValue.x,\n                           replace.y  ? candidate.y : bestValue.y,\n                           replace.z  ? candidate.z : bestValue.z,\n                           replace.w  ? candidate.w : bestValue.w);\n          bestIndex = mix(bestIndex, vec4(inIdx), vec4(replace));\n          srcIdx++;\n        }\n        setOutput(bestIndex);\n      }\n    "},Ai=function(t){this.variableNames=["dy"],this.outputShape=t.inShape;var e=t.filterHeight,n=t.filterWidth,r=t.strideHeight,i=t.strideWidth,a=t.dilationHeight,o=t.dilationWidth,s=t.effectiveFilterHeight,u=t.effectiveFilterWidth,l=s-1-t.padInfo.top,c=u-1-t.padInfo.left,p=1/(e*n);this.userCode="\n      const ivec2 pads = ivec2("+l+", "+c+");\n      const float avgMultiplier = float("+p+");\n\n      void main() {\n        ivec4 coords = getOutputCoords();\n        int b = coords[0];\n        int d = coords[3];\n\n        ivec2 dyRCCorner = coords.yz - pads;\n        int dyRCorner = dyRCCorner.x;\n        int dyCCorner = dyRCCorner.y;\n\n        // Convolve dy(?, ?, d) with pos mask(:, :, d) to get dx(xR, xC, d).\n        // ? = to be determined. : = across all values in that axis.\n        float dotProd = 0.0;\n        for (int wR = 0; wR < "+s+";\n            wR += "+a+") {\n          float dyR = float(dyRCorner + wR) / "+r+".0;\n\n          if (dyR < 0.0 || dyR >= "+t.outHeight+".0 || fract(dyR) > 0.0) {\n            continue;\n          }\n          int idyR = int(dyR);\n\n          for (int wC = 0; wC < "+u+";\n            wC+= "+o+") {\n            float dyC = float(dyCCorner + wC) / "+i+".0;\n\n            if (dyC < 0.0 || dyC >= "+t.outWidth+".0 ||\n                fract(dyC) > 0.0) {\n              continue;\n            }\n            int idyC = int(dyC);\n\n            float dyValue = getDy(b, idyR, idyC, d);\n\n            dotProd += dyValue * avgMultiplier;\n          }\n        }\n        setOutput(dotProd);\n      }\n    "},Ri=function(t){this.variableNames=["dy"],this.outputShape=t.inShape;var e=t.filterDepth,n=t.filterHeight,r=t.filterWidth,i=t.strideDepth,a=t.strideHeight,o=t.strideWidth,s=t.dilationDepth,u=t.dilationHeight,l=t.dilationWidth,c=t.effectiveFilterDepth,p=t.effectiveFilterHeight,h=t.effectiveFilterWidth,f=c-1-t.padInfo.front,d=p-1-t.padInfo.top,m=h-1-t.padInfo.left,g=1/(e*n*r);this.userCode="\n      const ivec3 pads = ivec3("+f+", "+d+", "+m+");\n      const float avgMultiplier = float("+g+");\n\n      void main() {\n        ivec5 coords = getOutputCoords();\n        int batch = coords.x;\n        int ch = coords.u;\n\n        ivec3 dyCorner = ivec3(coords.y, coords.z, coords.w) - pads;\n        int dyDCorner = dyCorner.x;\n        int dyRCorner = dyCorner.y;\n        int dyCCorner = dyCorner.z;\n\n        // Convolve dy(?, ?, ?, d) with pos mask(:, :, :, ch) to get\n        // dx(xD, xR, xC, ch).\n        // ? = to be determined. : = across all values in that axis.\n        float dotProd = 0.0;\n\n        for (int wD = 0; wD < "+c+";\n            wD += "+s+") {\n          float dyD = float(dyDCorner + wD) / "+i+".0;\n\n          if (dyD < 0.0 || dyD >= "+t.outDepth+".0 || fract(dyD) > 0.0) {\n            continue;\n          }\n          int idyD = int(dyD);\n\n          for (int wR = 0; wR < "+p+";\n              wR += "+u+") {\n            float dyR = float(dyRCorner + wR) / "+a+".0;\n\n            if (dyR < 0.0 || dyR >= "+t.outHeight+".0 ||\n                fract(dyR) > 0.0) {\n              continue;\n            }\n            int idyR = int(dyR);\n\n            for (int wC = 0; wC < "+h+";\n                wC += "+l+") {\n              float dyC = float(dyCCorner + wC) / "+o+".0;\n\n              if (dyC < 0.0 || dyC >= "+t.outWidth+".0 ||\n                  fract(dyC) > 0.0) {\n                continue;\n              }\n              int idyC = int(dyC);\n\n              float dyValue = getDy(batch, idyD, idyR, idyC, ch);\n\n              dotProd += dyValue * avgMultiplier;\n            }\n          }\n        }\n        setOutput(dotProd);\n      }\n    "},Ti=function(t,e,n,r,i,a){this.outputShape=[],this.variableNames=["x","mean","variance"],Mr(t,e),Mr(t,n);var o="0.0";null!=r&&(Mr(t,r),this.variableNames.push("offset"),o="getOffsetAtOutCoords()");var s="1.0";null!=i&&(Mr(t,i),this.variableNames.push("scale"),s="getScaleAtOutCoords()"),this.outputShape=t,this.userCode="\n      void main() {\n        float x = getXAtOutCoords();\n        float mean = getMeanAtOutCoords();\n        float variance = getVarianceAtOutCoords();\n        float offset = "+o+";\n        float scale = "+s+";\n        float inv = scale * inversesqrt(variance + float("+a+"));\n        setOutput(dot(vec3(x, -mean, offset), vec3(inv, inv, 1)));\n      }\n    "},Di=function(t,e,n,r,i,a){this.usesPackedTextures=!0,this.variableNames=["x","mean","variance"],Mr(t,e),Mr(t,n);var o="vec4(0.0)";null!=r&&(Mr(t,r),this.variableNames.push("offset"),o="getOffsetAtOutCoords()");var s="vec4(1.0)";null!=i&&(Mr(t,i),this.variableNames.push("scale"),s="getScaleAtOutCoords()"),this.outputShape=t,this.userCode="\n      void main() {\n        vec4 offset = "+o+";\n        vec4 scale = "+s+";\n\n        vec4 x = getXAtOutCoords();\n        vec4 mean = getMeanAtOutCoords();\n        vec4 variance = getVarianceAtOutCoords();\n\n        vec4 inv = scale * inversesqrt(variance + vec4("+a+"));\n\n        setOutput((x - mean) * inv + offset);\n      }\n    "},Oi=function(t,e,n){this.variableNames=["AReal","AImag","BReal","BImag"],this.outputShape=Mr(e,n),this.userCode="\n      float binaryOpComplex(\n          float areal, float aimag, float breal, float bimag) {\n        "+t+"\n      }\n\n      void main() {\n        float areal = getARealAtOutCoords();\n        float aimag = getAImagAtOutCoords();\n        float breal = getBRealAtOutCoords();\n        float bimag = getBImagAtOutCoords();\n        setOutput(binaryOpComplex(areal, aimag, breal, bimag));\n      }\n    "},_i="return a + b;",Fi="return a - b;",Mi="return a * b;",zi="return (a < 0.) ? b * a : a;",Li=function(t,e,n){this.variableNames=["A","B"],this.outputShape=Mr(e,n),this.userCode="\n      float binaryOperation(float a, float b) {\n        "+t+"\n      }\n\n      void main() {\n        float a = getAAtOutCoords();\n        float b = getBAtOutCoords();\n        setOutput(binaryOperation(a, b));\n      }\n    "},Pi="\n  vec4 aLessThanZero = vec4(lessThan(a, vec4(0.)));\n  return (aLessThanZero * (b * a)) + ((vec4(1.0) - aLessThanZero) * a);\n",Bi=function(t,e,n,r){void 0===r&&(r=!1),this.variableNames=["A","B"],this.supportsBroadcasting=!0,this.usesPackedTextures=!0,this.outputShape=Mr(e,n);var i=this.outputShape.length,a="";if(r)if(0===i||1===v(this.outputShape))a="\n          result.y = 0.;\n          result.z = 0.;\n          result.w = 0.;\n        ";else if(a="\n          "+Ei(i)+" coords = getOutputCoords();\n        ",1===i)a+="\n            result.y = (coords + 1) >= "+this.outputShape[0]+" ? 0. : result.y;\n            result.z = 0.;\n            result.w = 0.;\n          ";else{var o=hi("coords",i);a+="\n            bool nextRowOutOfBounds =\n              ("+o[i-2]+" + 1) >= "+this.outputShape[i-2]+";\n            bool nextColOutOfBounds =\n              ("+o[i-1]+" + 1) >= "+this.outputShape[i-1]+";\n            result.y = nextColOutOfBounds ? 0. : result.y;\n            result.z = nextRowOutOfBounds ? 0. : result.z;\n            result.w = nextColOutOfBounds || nextRowOutOfBounds ? 0. : result.w;\n          "}this.userCode="\n      vec4 binaryOperation(vec4 a, vec4 b) {\n        "+t+"\n      }\n\n      void main() {\n        vec4 a = getAAtOutCoords();\n        vec4 b = getBAtOutCoords();\n\n        vec4 result = binaryOperation(a, b);\n        "+a+"\n\n        setOutput(result);\n      }\n    "},Vi=function(){function t(t){this.variableNames=["A"],this.outputShape=t,this.userCode="\n      uniform float minVal;\n      uniform float maxVal;\n\n      void main() {\n        float value = getAAtOutCoords();\n        if (isnan(value)) {\n          setOutput(value);\n          return;\n        }\n\n        setOutput(clamp(value, minVal, maxVal));\n      }\n    "}return t.prototype.getCustomSetupFunc=function(t,e){var n=this;return function(r,i){null==n.minLoc&&(n.minLoc=r.getUniformLocationNoThrow(i,"minVal"),n.maxLoc=r.getUniformLocationNoThrow(i,"maxVal")),r.gl.uniform1f(n.minLoc,t),r.gl.uniform1f(n.maxLoc,e)}},t}(),Wi=function(){function t(t){this.variableNames=["A"],this.usesPackedTextures=!0,this.outputShape=t,this.userCode="\n      uniform float minVal;\n      uniform float maxVal;\n\n      void main() {\n        vec4 value = getAAtOutCoords();\n\n        if (any(isnan(value))) {\n          setOutput(value);\n          return;\n        }\n\n        setOutput(clamp(value, vec4(minVal), vec4(maxVal)));\n      }\n    "}return t.prototype.getCustomSetupFunc=function(t,e){var n=this;return function(r,i){null==n.minLoc&&(n.minLoc=r.getUniformLocationNoThrow(i,"minVal"),n.maxLoc=r.getUniformLocationNoThrow(i,"maxVal")),r.gl.uniform1f(n.minLoc,t),r.gl.uniform1f(n.maxLoc,e)}},t}(),Ui=function(t){this.variableNames=["real","imag"],this.outputShape=t,this.userCode="\n      void main() {\n        float re = abs(getRealAtOutCoords());\n        float im = abs(getImagAtOutCoords());\n        float mx = max(re, im);\n\n        // sadly the length function in glsl is not underflow-safe\n        // (at least not on Intel GPUs). So the safe solution is\n        // to ensure underflow-safety in all cases.\n        setOutput(\n          mx == 0.0 ? 0.0 : mx * length(vec2(1, min(re, im)/mx))\n        );\n      }\n    "},ji=function(t){this.outputShape=[],this.outputShape=Ze(t,1),this.variableNames=t.map(function(t,e){return"T"+e});var e=new Array(t.length-1);e[0]=t[0][1];for(var n=1;n<e.length;n++)e[n]=e[n-1]+t[n][1];var r=["if (yC < "+e[0]+") setOutput(getT0(yR, yC));"];for(n=1;n<e.length;n++){var i=e[n-1];r.push("else if (yC < "+e[n]+") setOutput(getT"+n+"(yR, yC-"+i+"));")}var a=e.length,o=e[e.length-1];r.push("else setOutput(getT"+a+"(yR, yC-"+o+"));"),this.userCode="\n      void main() {\n        ivec2 coords = getOutputCoords();\n        int yR = coords.x;\n        int yC = coords.y;\n\n        "+r.join("\n        ")+"\n      }\n    "},qi=function(t,e){this.usesPackedTextures=!0,this.outputShape=[],this.outputShape=Ze(t,e);var n=this.outputShape,r=n.length,i=Ei(r),a=hi("coords",r),o=["x","y","z","w","u","v"].slice(0,r);this.variableNames=t.map(function(t,e){return"T"+e});var s=new Array(t.length-1);s[0]=t[0][e];for(var u=1;u<s.length;u++)s[u]=s[u-1]+t[u][e];var l=o[e],c="vec2("+o.slice(-2).join()+")",p=o.join(),h="if ("+l+" < "+s[0]+")\n          return getChannel(getT0("+p+"), "+c+");";for(u=1;u<s.length;u++){var f=s[u-1];h+="\n        else if ("+l+" < "+s[u]+") {\n          "+l+" -= "+f+";\n          return getChannel(getT"+u+"("+p+"), "+c+");\n        }"}var d=s.length;h+="\n        else {\n          "+l+" -= "+s[s.length-1]+";\n          return getChannel(getT"+d+"("+p+"), "+c+");\n        }",this.userCode="\n      float getValue("+o.map(function(t){return"int "+t})+") {\n        "+h+"\n      }\n\n      void main() {\n        "+i+" coords = getOutputCoords();\n        vec4 result = vec4(getValue("+a+"), 0., 0., 0.);\n        if (++"+a[r-1]+" < "+n[r-1]+") {\n          result.g = getValue("+a+");\n        }\n        if (++"+a[r-2]+" < "+n[r-2]+") {\n          result.a = getValue("+a+");\n        }\n        if ("+a[r-2]+" < "+n[r-2]+" &&\n            --"+a[r-1]+" < "+n[r-1]+") {\n          result.b = getValue("+a+");\n        }\n        setOutput(result);\n      }\n    "},Hi=function(t){this.variableNames=["x","dy"],this.outputShape=t.filterShape;var e=t.strideHeight,n=t.strideWidth,r=t.padInfo.top,i=t.padInfo.left,a="channelsLast"===t.dataFormat;this.userCode="\n      void main() {\n        ivec4 coords = getOutputCoords();\n        int wR = coords.x;\n        int wC = coords.y;\n        int d1 = coords.z;\n        int d2 = coords.w;\n\n        // Convolve x(?, ?, d1) with dy(:, :, d2) to get dw(wR, wC, d1, d2).\n        // ? = to be determined. : = across all values in that axis.\n        float dotProd = 0.0;\n\n        for (int b = 0; b < "+t.batchSize+"; b++) {\n          for (int yR = 0; yR < "+t.outHeight+"; yR++) {\n            int xR = wR + yR * "+e+" - "+r+";\n\n            if (xR < 0 || xR >= "+t.inHeight+") {\n              continue;\n            }\n\n            for (int yC = 0; yC < "+t.outWidth+"; yC++) {\n              int xC = wC + yC * "+n+" - "+i+";\n\n              if (xC < 0 || xC >= "+t.inWidth+") {\n                continue;\n              }\n\n              if ("+a+") {\n                float dyValue = getDy(b, yR, yC, d2);\n                float xValue = getX(b, xR, xC, d1);\n                dotProd += (xValue * dyValue);\n              } else {\n                float dyValue = getDy(b, d2, yR, yC);\n                float xValue = getX(b, d1, xR, xC);\n                dotProd += (xValue * dyValue);\n              }\n\n            }\n          }\n        }\n        setOutput(dotProd);\n      }\n    "},Gi=function(t){this.variableNames=["dy","W"],this.outputShape=t.inShape;var e=t.filterHeight,n=t.filterWidth,r=t.strideHeight,i=t.strideWidth,a="channelsLast"===t.dataFormat,o=e-1-t.padInfo.top,s=n-1-t.padInfo.left,u=a?1:2,l=a?2:3,c=a?3:1;this.userCode="\n      const ivec2 pads = ivec2("+o+", "+s+");\n\n      void main() {\n        ivec4 coords = getOutputCoords();\n        int batch = coords[0];\n        int d1 = coords["+c+"];\n\n        ivec2 dyCorner = ivec2(coords["+u+"], coords["+l+"]) - pads;\n        int dyRCorner = dyCorner.x;\n        int dyCCorner = dyCorner.y;\n\n        // Convolve dy(?, ?, d2) with w(:, :, d1, d2) to compute dx(xR, xC, d1).\n        // ? = to be determined. : = across all values in that axis.\n        float dotProd = 0.0;\n        for (int wR = 0; wR < "+e+"; wR++) {\n          float dyR = float(dyRCorner + wR) / "+r+".0;\n\n          if (dyR < 0.0 || dyR >= "+t.outHeight+".0 || fract(dyR) > 0.0) {\n            continue;\n          }\n          int idyR = int(dyR);\n\n          int wRPerm = "+e+" - 1 - wR;\n\n          for (int wC = 0; wC < "+n+"; wC++) {\n            float dyC = float(dyCCorner + wC) / "+i+".0;\n\n            if (dyC < 0.0 || dyC >= "+t.outWidth+".0 ||\n                fract(dyC) > 0.0) {\n              continue;\n            }\n            int idyC = int(dyC);\n\n            int wCPerm = "+n+" - 1 - wC;\n\n            for (int d2 = 0; d2 < "+t.outChannels+"; d2++) {\n\n              if ("+a+") {\n                float xValue = getDy(batch, idyR, idyC, d2);\n                float wValue = getW(wRPerm, wCPerm, d1, d2);\n                dotProd += xValue * wValue;\n              } else {\n                float xValue = getDy(batch, d2, idyR, idyC);\n                float wValue = getW(wRPerm, wCPerm, d1, d2);\n                dotProd += xValue * wValue;\n              }\n\n            }\n          }\n        }\n        setOutput(dotProd);\n      }\n    "},Ki=function(t){this.variableNames=["x","dy"],this.outputShape=t.filterShape;var e=t.strideDepth,n=t.strideHeight,r=t.strideWidth,i=t.padInfo.front,a=t.padInfo.top,o=t.padInfo.left;this.userCode="\n      void main() {\n        ivec5 coords = getOutputCoords();\n        int wF = coords.x;\n        int wR = coords.y;\n        int wC = coords.z;\n        int d1 = coords.w;\n        int d2 = coords.u;\n\n        float dotProd = 0.0;\n\n        for (int b = 0; b < "+t.batchSize+"; b++) {\n          for (int yF = 0; yF < "+t.outDepth+"; yF++) {\n            int xF = wF + yF * "+e+" - "+i+";\n\n            if (xF < 0 || xF >= "+t.inDepth+") {\n              continue;\n            }\n\n            for (int yR = 0; yR < "+t.outHeight+"; yR++) {\n              int xR = wR + yR * "+n+" - "+a+";\n\n              if (xR < 0 || xR >= "+t.inHeight+") {\n                continue;\n              }\n\n              for (int yC = 0; yC < "+t.outWidth+"; yC++) {\n                int xC = wC + yC * "+r+" - "+o+";\n\n                if (xC < 0 || xC >= "+t.inWidth+") {\n                  continue;\n                }\n\n                float dyValue = getDy(b, yF, yR, yC, d2);\n                float xValue = getX(b, xF, xR, xC, d1);\n                dotProd += (xValue * dyValue);\n              }\n            }\n          }\n        }\n        setOutput(dotProd);\n      }\n    "},$i=function(t){this.variableNames=["dy","W"],this.outputShape=t.inShape;var e=t.filterDepth,n=t.filterHeight,r=t.filterWidth,i=t.strideDepth,a=t.strideHeight,o=t.strideWidth,s=e-1-t.padInfo.front,u=n-1-t.padInfo.top,l=r-1-t.padInfo.left;this.userCode="\n      const ivec3 pads = ivec3("+s+", "+u+", "+l+");\n\n      void main() {\n        ivec5 coords = getOutputCoords();\n        int batch = coords.x;\n        int d1 = coords.u;\n\n\n        ivec3 dyCorner = ivec3(coords.y, coords.z, coords.w) - pads;\n        int dyFCorner = dyCorner.x;\n        int dyRCorner = dyCorner.y;\n        int dyCCorner = dyCorner.z;\n\n        float dotProd = 0.0;\n        for (int wF = 0; wF < "+e+"; wF++) {\n          float dyF = float(dyFCorner + wF) / "+i+".0;\n\n          if (dyF < 0.0 || dyF >= "+t.outDepth+".0 || fract(dyF) > 0.0) {\n            continue;\n          }\n          int idyF = int(dyF);\n\n          int wFPerm = "+e+" - 1 - wF;\n\n          for (int wR = 0; wR < "+n+"; wR++) {\n            float dyR = float(dyRCorner + wR) / "+a+".0;\n\n            if (dyR < 0.0 || dyR >= "+t.outHeight+".0 ||\n              fract(dyR) > 0.0) {\n              continue;\n            }\n            int idyR = int(dyR);\n\n            int wRPerm = "+n+" - 1 - wR;\n\n            for (int wC = 0; wC < "+r+"; wC++) {\n              float dyC = float(dyCCorner + wC) / "+o+".0;\n\n              if (dyC < 0.0 || dyC >= "+t.outWidth+".0 ||\n                  fract(dyC) > 0.0) {\n                continue;\n              }\n              int idyC = int(dyC);\n\n              int wCPerm = "+r+" - 1 - wC;\n\n              for (int d2 = 0; d2 < "+t.outChannels+"; d2++) {\n                float xValue = getDy(batch, idyF, idyR, idyC, d2);\n                float wValue = getW(wFPerm, wRPerm, wCPerm, d1, d2);\n                dotProd += xValue * wValue;\n              }\n            }\n          }\n        }\n        setOutput(dotProd);\n      }\n    "},Xi=function(t){this.variableNames=["x","dy"],this.outputShape=t.filterShape;var e=t.strideHeight,n=t.strideWidth,r=t.padInfo.top,i=t.padInfo.left,a=t.outChannels/t.inChannels;this.userCode="\n      void main() {\n        ivec4 coords = getOutputCoords();\n        int wR = coords.x;\n        int wC = coords.y;\n        int d1 = coords.z;\n        int dm = coords.w;\n        int d2 = d1 * "+a+" + dm;\n\n        float dotProd = 0.0;\n\n        // TODO: Vec4 over the batch size\n        for (int b = 0; b < "+t.batchSize+"; b++) {\n          for (int yR = 0; yR < "+t.outHeight+"; yR++) {\n            int xR = wR + yR * "+e+" - "+r+";\n\n            if (xR < 0 || xR >= "+t.inHeight+") {\n              continue;\n            }\n\n            for (int yC = 0; yC < "+t.outWidth+"; yC++) {\n              int xC = wC + yC * "+n+" - "+i+";\n\n              if (xC < 0 || xC >= "+t.inWidth+") {\n                continue;\n              }\n\n              float dyValue = getDy(b, yR, yC, d2);\n              float xValue = getX(b, xR, xC, d1);\n              dotProd += (xValue * dyValue);\n            }\n          }\n        }\n        setOutput(dotProd);\n      }\n    "},Yi=function(t){this.variableNames=["dy","W"],this.outputShape=t.inShape;var e=t.filterHeight,n=t.filterWidth,r=t.strideHeight,i=t.strideWidth,a=e-1-t.padInfo.top,o=n-1-t.padInfo.left,s=t.outChannels/t.inChannels;this.userCode="\n      const ivec2 pads = ivec2("+a+", "+o+");\n\n      void main() {\n        ivec4 coords = getOutputCoords();\n        int batch = coords[0];\n        int d1 = coords[3];\n        ivec2 dyCorner = coords.yz - pads;\n        int dyRCorner = dyCorner.x;\n        int dyCCorner = dyCorner.y;\n\n        float dotProd = 0.0;\n\n        for (int wR = 0; wR < "+e+"; wR++) {\n          float dyR = float(dyRCorner + wR) / "+r+".0;\n\n          if (dyR < 0.0 || dyR >= "+t.outHeight+".0 || fract(dyR) > 0.0) {\n            continue;\n          }\n          int idyR = int(dyR);\n\n          int wRPerm = "+e+" - 1 - wR;\n\n          for (int wC = 0; wC < "+n+"; wC++) {\n            float dyC = float(dyCCorner + wC) / "+i+".0;\n\n            if (dyC < 0.0 || dyC >= "+t.outWidth+".0 ||\n                fract(dyC) > 0.0) {\n              continue;\n            }\n            int idyC = int(dyC);\n\n            int wCPerm = "+n+" - 1 - wC;\n\n            // TODO: Vec4 over the channelMul\n            for (int dm = 0; dm < "+s+"; dm++) {\n              int d2 = d1 * "+s+" + dm;\n              float xValue = getDy(batch, idyR, idyC, d2);\n              float wValue = getW(wRPerm, wCPerm, d1, dm);\n              dotProd += xValue * wValue;\n            }\n          }\n        }\n        setOutput(dotProd);\n      }\n    "},Ji=function(t,e,n,r){void 0===e&&(e=!1),void 0===n&&(n=null),void 0===r&&(r=!1),this.variableNames=["x","W"],this.outputShape=t.outShape;var i=t.padInfo.top,a=t.padInfo.left,o=t.strideHeight,s=t.strideWidth,u=t.dilationHeight,l=t.dilationWidth,c=t.filterHeight,p=t.filterWidth,h=4*Math.floor(t.inChannels/4),f=t.inChannels%4,d="channelsLast"===t.dataFormat,m=d?1:2,g=d?2:3,v=d?3:1,y="",b="";n&&(y=r?"float activation(float a) {\n          float b = getPreluActivationWeightsAtOutCoords();\n          "+n+"\n        }":"\n          float activation(float x) {\n            "+n+"\n          }\n        ",b="result = activation(result);");var x=e?"result += getBiasAtOutCoords();":"";e&&this.variableNames.push("bias"),r&&this.variableNames.push("preluActivationWeights"),this.userCode="\n      "+y+"\n\n      const ivec2 strides = ivec2("+o+", "+s+");\n      const ivec2 pads = ivec2("+i+", "+a+");\n\n      void main() {\n        ivec4 coords = getOutputCoords();\n        int batch = coords[0];\n        int d2 = coords["+v+"];\n\n        ivec2 xRCCorner =\n            ivec2(coords["+m+"], coords["+g+"]) * strides - pads;\n        int xRCorner = xRCCorner.x;\n        int xCCorner = xRCCorner.y;\n\n        // Convolve x(?, ?, d1) with w(:, :, d1, d2) to get y(yR, yC, d2).\n        // ? = to be determined. : = across all values in that axis.\n        float dotProd = 0.0;\n        for (int wR = 0; wR < "+c+"; wR++) {\n          int xR = xRCorner + wR * "+u+";\n\n          if (xR < 0 || xR >= "+t.inHeight+") {\n            continue;\n          }\n\n          for (int wC = 0; wC < "+p+"; wC++) {\n            int xC = xCCorner + wC * "+l+";\n\n            if (xC < 0 || xC >= "+t.inWidth+") {\n              continue;\n            }\n\n            for (int d1 = 0; d1 < "+h+"; d1 += 4) {\n              vec4 wValues = vec4(\n                getW(wR, wC, d1, d2),\n                getW(wR, wC, d1 + 1, d2),\n                getW(wR, wC, d1 + 2, d2),\n                getW(wR, wC, d1 + 3, d2)\n              );\n\n              if ("+d+") {\n                vec4 xValues = vec4(\n                  getX(batch, xR, xC, d1),\n                  getX(batch, xR, xC, d1 + 1),\n                  getX(batch, xR, xC, d1 + 2),\n                  getX(batch, xR, xC, d1 + 3)\n                );\n                dotProd += dot(xValues, wValues);\n              } else {\n                vec4 xValues = vec4(\n                  getX(batch, d1, xR, xC),\n                  getX(batch, d1 + 1, xR, xC),\n                  getX(batch, d1 + 2, xR, xC),\n                  getX(batch, d1 + 3, xR, xC)\n                );\n                dotProd += dot(xValues, wValues);\n              }\n            }\n\n            if ("+(1===f)+") {\n\n              if ("+d+") {\n                dotProd +=\n                    getX(batch, xR, xC, "+h+") *\n                    getW(wR, wC, "+h+", d2);\n              } else {\n                dotProd +=\n                    getX(batch, "+h+", xR, xC) *\n                    getW(wR, wC, "+h+", d2);\n              }\n\n            } else if ("+(2===f)+") {\n              vec2 wValues = vec2(\n                getW(wR, wC, "+h+", d2),\n                getW(wR, wC, "+h+" + 1, d2)\n              );\n\n              if ("+d+") {\n                vec2 xValues = vec2(\n                  getX(batch, xR, xC, "+h+"),\n                  getX(batch, xR, xC, "+h+" + 1)\n                );\n                dotProd += dot(xValues, wValues);\n              } else {\n                vec2 xValues = vec2(\n                  getX(batch, "+h+", xR, xC),\n                  getX(batch, "+h+" + 1, xR, xC)\n                );\n                dotProd += dot(xValues, wValues);\n              }\n\n            } else if ("+(3===f)+") {\n              vec3 wValues = vec3(\n                getW(wR, wC, "+h+", d2),\n                getW(wR, wC, "+h+" + 1, d2),\n                getW(wR, wC, "+h+" + 2, d2)\n              );\n\n              if ("+d+") {\n                vec3 xValues = vec3(\n                  getX(batch, xR, xC, "+h+"),\n                  getX(batch, xR, xC, "+h+" + 1),\n                  getX(batch, xR, xC, "+h+" + 2)\n                );\n                dotProd += dot(xValues, wValues);\n              } else {\n                vec3 xValues = vec3(\n                  getX(batch, "+h+", xR, xC),\n                  getX(batch, "+h+" + 1, xR, xC),\n                  getX(batch, "+h+" + 2, xR, xC)\n                );\n                dotProd += dot(xValues, wValues);\n              }\n\n            }\n          }\n        }\n\n        float result = dotProd;\n        "+x+"\n        "+b+"\n        setOutput(result);\n      }\n    "},Zi=function(t){this.variableNames=["x","W"],this.outputShape=t.outShape;var e=t.padInfo.front,n=t.padInfo.top,r=t.padInfo.left,i=t.strideDepth,a=t.strideHeight,o=t.strideWidth,s=t.dilationDepth,u=t.dilationHeight,l=t.dilationWidth,c=t.filterDepth,p=t.filterHeight,h=t.filterWidth,f=4*Math.floor(t.inChannels/4),d=t.inChannels%4;this.userCode="\n      const ivec3 strides = ivec3("+i+", "+a+", "+o+");\n      const ivec3 pads = ivec3("+e+", "+n+", "+r+");\n\n      void main() {\n        ivec5 coords = getOutputCoords();\n        int batch = coords.x;\n        int d2 = coords.u;\n\n        ivec3 xFRCCorner = ivec3(coords.y, coords.z, coords.w) * strides - pads;\n        int xFCorner = xFRCCorner.x;\n        int xRCorner = xFRCCorner.y;\n        int xCCorner = xFRCCorner.z;\n\n        // Convolve x(?, ?, ?, d1) with w(:, :, :, d1, d2) to get\n        // y(yF, yR, yC, d2). ? = to be determined. : = across all\n        // values in that axis.\n        float dotProd = 0.0;\n        for (int wF = 0; wF < "+c+"; wF++) {\n          int xF = xFCorner + wF * "+s+";\n\n          if (xF < 0 || xF >= "+t.inDepth+") {\n            continue;\n          }\n\n          for (int wR = 0; wR < "+p+"; wR++) {\n            int xR = xRCorner + wR * "+u+";\n\n            if (xR < 0 || xR >= "+t.inHeight+") {\n              continue;\n            }\n\n            for (int wC = 0; wC < "+h+"; wC++) {\n              int xC = xCCorner + wC * "+l+";\n\n              if (xC < 0 || xC >= "+t.inWidth+") {\n                continue;\n              }\n\n              for (int d1 = 0; d1 < "+f+"; d1 += 4) {\n                vec4 xValues = vec4(\n                  getX(batch, xF, xR, xC, d1),\n                  getX(batch, xF, xR, xC, d1 + 1),\n                  getX(batch, xF, xR, xC, d1 + 2),\n                  getX(batch, xF, xR, xC, d1 + 3)\n                );\n                vec4 wValues = vec4(\n                  getW(wF, wR, wC, d1, d2),\n                  getW(wF, wR, wC, d1 + 1, d2),\n                  getW(wF, wR, wC, d1 + 2, d2),\n                  getW(wF, wR, wC, d1 + 3, d2)\n                );\n\n                dotProd += dot(xValues, wValues);\n              }\n\n              if ("+(1===d)+") {\n                dotProd +=\n                  getX(batch, xF, xR, xC, "+f+") *\n                  getW(wF, wR, wC, "+f+", d2);\n              } else if ("+(2===d)+") {\n                vec2 xValues = vec2(\n                  getX(batch, xF, xR, xC, "+f+"),\n                  getX(batch, xF, xR, xC, "+f+" + 1)\n                );\n                vec2 wValues = vec2(\n                  getW(wF, wR, wC, "+f+", d2),\n                  getW(wF, wR, wC, "+f+" + 1, d2)\n                );\n                dotProd += dot(xValues, wValues);\n              } else if ("+(3===d)+") {\n                vec3 xValues = vec3(\n                  getX(batch, xF, xR, xC, "+f+"),\n                  getX(batch, xF, xR, xC, "+f+" + 1),\n                  getX(batch, xF, xR, xC, "+f+" + 2)\n                );\n                vec3 wValues = vec3(\n                  getW(wF, wR, wC, "+f+", d2),\n                  getW(wF, wR, wC, "+f+" + 1, d2),\n                  getW(wF, wR, wC, "+f+" + 2, d2)\n                );\n                dotProd += dot(xValues, wValues);\n              }\n            }\n          }\n        }\n        setOutput(dotProd);\n      }\n    "},Qi=function(t){this.variableNames=["x","W"],this.outputShape=t.outShape;var e=t.inHeight,n=t.inWidth,r=t.padInfo.top,i=t.padInfo.left,a=t.strideHeight,o=t.strideWidth,s=t.dilationHeight,u=t.dilationWidth,l=t.filterHeight,c=t.filterWidth,p=t.outChannels/t.inChannels;this.userCode="\n      const ivec2 strides = ivec2("+a+", "+o+");\n      const ivec2 pads = ivec2("+r+", "+i+");\n\n      void main() {\n        ivec4 coords = getOutputCoords();\n        int batch = coords.x;\n        ivec2 xRCCorner = coords.yz * strides - pads;\n        int d2 = coords.w;\n        int d1 = d2 / "+p+";\n        int q = d2 - d1 * "+p+";\n\n        int xRCorner = xRCCorner.x;\n        int xCCorner = xRCCorner.y;\n\n        // Convolve x(?, ?, d1) with w(:, :, d1, q) to get y(yR, yC, d2).\n        // ? = to be determined. : = across all values in that axis.\n        float dotProd = 0.0;\n        // TODO(dsmilkov): Flatten the two for loops and vec4 the operations.\n        for (int wR = 0; wR < "+l+"; wR++) {\n          int xR = xRCorner + wR * "+s+";\n\n          if (xR < 0 || xR >= "+e+") {\n            continue;\n          }\n\n          for (int wC = 0; wC < "+c+"; wC++) {\n            int xC = xCCorner + wC * "+u+";\n\n            if (xC < 0 || xC >= "+n+") {\n              continue;\n            }\n\n            float xVal = getX(batch, xR, xC, d1);\n            float wVal = getW(wR, wC, d1, q);\n            dotProd += xVal * wVal;\n          }\n        }\n        setOutput(dotProd);\n      }\n    "},ta=function(t){this.variableNames=["x","W"],this.usesPackedTextures=!0,this.outputShape=t.outShape;for(var e=t.inHeight,n=t.inWidth,r=t.padInfo.top,i=t.padInfo.left,a=t.strideHeight,o=t.strideWidth,s=t.dilationHeight,u=t.dilationWidth,l=t.filterHeight,c=t.filterWidth,h=c,f="int xR; int xC; int xCOffset;",d=0;d<l;d++)for(var m=0;m<c;m++)f+="\n          vec4 xTexelR"+d+"C"+2*m+" = vec4(0.);\n          vec4 wR"+d+"C"+m+" = vec4(0.);\n          vec4 xR"+d+"C"+m+" = vec4(0.);";for(d=0;d<l;d++)for(var g=0;g<h;g++){if(f+="\n          xR = xRCorner + "+d*s+";\n          xC = xCCorner + "+(m=2*g)*u+";\n        ",1===o){if(m<c&&(f+=i%2==1?"\n                xCOffset = xC + 1;\n                if(xR >= 0 && xR < "+e+" && xCOffset >= 0 && xCOffset < "+n+") {\n                  xTexelR"+d+"C"+m+" = getX(batch, xR, xCOffset, d1);\n                } else {\n                  xTexelR"+d+"C"+m+" = vec4(0.);\n                }\n\n                xCOffset = xC + 1 - 2;\n                if(xR >= 0 && xR < "+e+" && xCOffset >= 0 && xCOffset < "+n+") {\n                  vec4 previous = getX(batch, xR, xCOffset, d1);\n                  xR"+d+"C"+m+" = vec4(previous.zw, xTexelR"+d+"C"+m+".xy);\n                } else {\n                  xR"+d+"C"+m+" = vec4(0, 0, xTexelR"+d+"C"+m+".xy);\n                }\n              ":"\n                if(xR >= 0 && xR < "+e+" && xC >= 0 && xC < "+n+") {\n                  xTexelR"+d+"C"+m+" = getX(batch, xR, xC, d1);\n                } else {\n                  xTexelR"+d+"C"+m+" = vec4(0.);\n                }\n\n                xR"+d+"C"+m+" = xTexelR"+d+"C"+m+";\n              ",m+1<c)){var v=i%2==0?p(u):u;u%2==0&&i%2==1||u%2!=0&&i%2!=1?(f+="\n                  xCOffset = xC + "+i%2+" + "+v+";\n\n                  if(xR >= 0 && xR < "+e+" &&\n                    xCOffset >= 0 && xCOffset < "+n+") {\n                    xTexelR"+d+"C"+(m+2)+" = getX(batch, xR, xCOffset, d1);\n                  }\n                ",u>1&&(f+="\n                    xCOffset -= 2;\n                    if(xR >= 0 && xR < "+e+" &&\n                      xCOffset >= 0 && xCOffset < "+n+") {\n                      xTexelR"+d+"C"+m+" = getX(batch, xR, xCOffset, d1);\n                    } else {\n                      xTexelR"+d+"C"+m+" = vec4(0.);\n                    }\n                  "),f+="\n                  xR"+d+"C"+(m+1)+" = vec4(\n                    xTexelR"+d+"C"+m+".zw, xTexelR"+d+"C"+(m+2)+".xy);\n                "):f+="\n                  xCOffset = xC + "+v+";\n\n                  if(xR >= 0 && xR < "+e+" &&\n                    xCOffset >= 0 && xCOffset < "+n+") {\n                    xTexelR"+d+"C"+(m+2)+" = getX(batch, xR, xCOffset, d1);\n                  }\n\n                  xR"+d+"C"+(m+1)+" = xTexelR"+d+"C"+(m+2)+";\n                "}}else m<c&&(f+="\n              if(xR >= 0 && xR < "+e+") {\n            ",i%2==1?(f+="\n                xCOffset = xC + 1 - "+o+";\n                if(xCOffset >= 0 && xCOffset < "+n+") {\n                  xTexelR"+d+"C"+m+" = getX(batch, xR, xCOffset, d1);\n                } else {\n                  xTexelR"+d+"C"+m+" = vec4(0.);\n                }\n\n                if(xC + 1 >= 0 && xC + 1 < "+n+") {\n                  xTexelR"+d+"C"+(m+2)+" = getX(batch, xR, xC + 1, d1);\n                } else {\n                  xTexelR"+d+"C"+(m+2)+" = vec4(0.);\n                }\n\n                xR"+d+"C"+m+" = vec4(\n                  xTexelR"+d+"C"+m+".zw, xTexelR"+d+"C"+(m+2)+".zw);\n              ",m+1<c&&(f+="\n                  vec4 final = vec4(0.);\n                  xCOffset = xC + 1 + "+o+";\n                  if(xCOffset >= 0 && xCOffset < "+n+") {\n                    final = getX(batch, xR, xCOffset, d1);\n                  }\n                  xR"+d+"C"+(m+1)+" = vec4(xTexelR"+d+"C"+(m+2)+".xy, final.xy);\n                ")):(f+="\n                if(xC >= 0 && xC < "+n+") {\n                  xTexelR"+d+"C"+m+" = getX(batch, xR, xC, d1);\n                } else {\n                  xTexelR"+d+"C"+m+" = vec4(0.);\n                }\n\n                xCOffset = xC + "+o+";\n                if(xCOffset >= 0 && xCOffset < "+n+") {\n                  xTexelR"+d+"C"+(m+2)+" = getX(batch, xR, xCOffset, d1);\n                } else {\n                  xTexelR"+d+"C"+(m+2)+" = vec4(0.);\n                }\n\n                xR"+d+"C"+m+" = vec4(\n                  xTexelR"+d+"C"+m+".xy, xTexelR"+d+"C"+(m+2)+".xy);\n              ",m+1<c&&(f+="\n                  xR"+d+"C"+(m+1)+" = vec4(\n                    xTexelR"+d+"C"+m+".zw, xTexelR"+d+"C"+(m+2)+".zw);\n                ")),f+="}");m<c&&(f+="\n            vec4 wTexelR"+d+"C"+m+" = getW("+d+", "+m+", d1, q);\n            wR"+d+"C"+m+" = vec4(wTexelR"+d+"C"+m+".xz, wTexelR"+d+"C"+m+".xz);\n          ",m+1<c&&(f+="\n              vec4 wTexelR"+d+"C"+(m+1)+" = getW("+d+", "+(m+1)+", d1, q);\n              wR"+d+"C"+(m+1)+" =\n                vec4(wTexelR"+d+"C"+(m+1)+".xz, wTexelR"+d+"C"+(m+1)+".xz);"))}for(d=0;d<l;d++)for(m=0;m<c;m++)f+="result += xR"+d+"C"+m+" * wR"+d+"C"+m+";";this.userCode="\n      const ivec2 strides = ivec2("+a+", "+o+");\n      const ivec2 pads = ivec2("+r+", "+i+");\n\n      void main() {\n\n        ivec4 coords = getOutputCoords();\n        int batch = coords.x;\n        ivec2 xRCCorner = coords.yz * strides - pads;\n        int d2 = coords.w;\n        int d1 = d2;\n        int q = 0;\n        int xRCorner = xRCCorner.x;\n        int xCCorner = xRCCorner.y;\n\n        vec4 result = vec4(0.);\n\n        "+f+"\n\n        setOutput(result);\n      }\n    "},ea=function(t,e,n,r,i){this.variableNames=["Image","Boxes","BoxInd"],this.outputShape=[];var a=t[0],o=t[1],s=t[2],u=t[3],l=e[0],c=n[0],p=n[1];this.outputShape=[l,c,p,u];var h="bilinear"===r?1:0,f=[o-1+".0",s-1+".0"],d=f[0],m=f[1],g=c>1?[""+(o-1)/(c-1),"(y2-y1) * height_ratio","y1*"+d+" + float(y)*(height_scale)"]:["0.0","0.0","0.5 * (y1+y2) * "+d],v=g[0],y=g[1],b=g[2],x=p>1?[""+(s-1)/(p-1),"(x2-x1) * width_ratio","x1*"+m+" + float(x)*(width_scale)"]:["0.0","0.0","0.5 * (x1+x2) * "+m],w=x[0],N=x[1],C=x[2];this.userCode="\n      const float height_ratio = float("+v+");\n      const float width_ratio = float("+w+");\n      void main() {\n        ivec4 coords = getOutputCoords();\n        int b = coords[0];\n        int y = coords[1];\n        int x = coords[2];\n        int d = coords[3];\n\n        // get box vals\n        float y1 = getBoxes(b,0);\n        float x1 = getBoxes(b,1);\n        float y2 = getBoxes(b,2);\n        float x2 = getBoxes(b,3);\n\n        // get image in batch index\n        int bInd = round(getBoxInd(b));\n        if(bInd < 0 || bInd >= "+a+") {\n          return;\n        }\n\n        float height_scale = "+y+";\n        float width_scale = "+N+";\n\n        float in_y = "+b+";\n        if( in_y < 0.0 || in_y > "+d+" ) {\n          setOutput(float("+i+"));\n          return;\n        }\n        float in_x = "+C+";\n        if( in_x < 0.0 || in_x > "+m+" ) {\n          setOutput(float("+i+"));\n          return;\n        }\n\n        vec2 sourceFracIndexCR = vec2(in_x,in_y);\n        if("+h+" == 1) {\n          // Compute the four integer indices.\n          ivec2 sourceFloorCR = ivec2(sourceFracIndexCR);\n          ivec2 sourceCeilCR = ivec2(ceil(sourceFracIndexCR));\n\n          float topLeft = getImage(b, sourceFloorCR.y, sourceFloorCR.x, d);\n          float bottomLeft = getImage(b, sourceCeilCR.y, sourceFloorCR.x, d);\n          float topRight = getImage(b, sourceFloorCR.y, sourceCeilCR.x, d);\n          float bottomRight = getImage(b, sourceCeilCR.y, sourceCeilCR.x, d);\n\n          vec2 fracCR = sourceFracIndexCR - vec2(sourceFloorCR);\n\n          float top = topLeft + (topRight - topLeft) * fracCR.x;\n          float bottom = bottomLeft + (bottomRight - bottomLeft) * fracCR.x;\n          float newValue = top + (bottom - top) * fracCR.y;\n          setOutput(newValue);\n        } else {\n          // Compute the coordinators of nearest neighbor point.\n          ivec2 sourceNearestCR = ivec2(floor(\n            sourceFracIndexCR + vec2(0.5,0.5)));\n          float newValue = getImage(b, sourceNearestCR.y, sourceNearestCR.x, d);\n          setOutput(newValue);\n        }\n      }\n    "},na=function(t,e,n){this.variableNames=["x"],this.outputShape=t;var r=t.length,i=t[t.length-1],a=n?"<":">";this.userCode="\n      int getIndex(int i) {\n        "+(n?"return "+i+" -i - 1;":"return i;")+"\n      }\n\n      void main() {\n        "+Ei(r)+" coords = getOutputCoords();\n        int end = "+ra(r,"coords")+";\n        float val = 0.0;\n        for (int i = "+i+" - 1; i >= 0; i -= 1) {\n          int idx = getIndex(i);\n          if (idx "+a+" end) {\n            continue;\n          }\n          if (idx == end && "+e+") {\n            continue;\n          }\n          "+ra(r,"coords")+" = idx;\n          val += getX("+function(t,e){if(1===t)return""+e;if(2===t)return e+".x, "+e+".y";if(3===t)return e+".x, "+e+".y, "+e+".z";if(4===t)return e+".x, "+e+".y, "+e+".z, "+e+".w";throw Error("Cumulative sum for rank "+t+" is not yet supported")}(r,"coords")+");\n        }\n        setOutput(val);\n      }\n    "};function ra(t,e){if(1===t)return""+e;if(2===t)return e+".y";if(3===t)return e+".z";if(4===t)return e+".w";throw Error("Cumulative sum for rank "+t+" is not yet supported")}var ia=function(t,e){this.variableNames=["A"];var n=fi();this.outputShape=t,this.userCode="\n      ivec3 outCoordsFromFlatIndex(int index) {\n        "+di(["r","c","d"],t)+"\n        return ivec3(r, c, d);\n      }\n\n      void main() {\n        ivec2 resTexRC = ivec2(resultUV.yx *\n          vec2("+e[0]+", "+e[1]+"));\n        int index = 4 * (resTexRC.x * "+e[1]+" + resTexRC.y);\n\n        vec4 result = vec4(0.);\n\n        for (int i=0; i<4; i++) {\n          int flatIndex = index + i;\n          ivec3 rc = outCoordsFromFlatIndex(flatIndex);\n          result[i] = getA(rc.x, rc.y, rc.z);\n        }\n\n        "+n.output+" = result;\n      }\n    "},aa=function(t,e){this.variableNames=["A"],this.usesPackedTextures=!0;var n=fi();this.outputShape=t,this.userCode="\n      ivec3 outCoordsFromFlatIndex(int index) {\n        "+di(["r","c","d"],t)+"\n        return ivec3(r, c, d);\n      }\n\n      void main() {\n        ivec2 resTexRC = ivec2(resultUV.yx *\n          vec2("+e[0]+", "+e[1]+"));\n        int index = 4 * (resTexRC.x * "+e[1]+" + resTexRC.y);\n\n        vec4 result = vec4(0.);\n\n        for (int i=0; i<4; i++) {\n          int flatIndex = index + i;\n          ivec3 rc = outCoordsFromFlatIndex(flatIndex);\n          result[i] = getChannel(getA(rc.x, rc.y, rc.z), vec2(rc.y, rc.z));\n        }\n\n        "+n.output+" = result;\n      }\n    "},oa=function(){function t(t,e,n){this.variableNames=["x"],this.outputShape=[],this.outputShape=t,this.blockSize=e,this.dataFormat=n,this.userCode="\n    void main() {\n      ivec4 coords = getOutputCoords();\n      int b = coords[0];\n      int h = "+this.getHeightCoordString()+";\n      int w = "+this.getWidthCoordString()+";\n      int d = "+this.getDepthCoordString()+";\n\n      int in_h = h / "+e+";\n      int offset_h = imod(h, "+e+");\n      int in_w = w / "+e+";\n      int offset_w = imod(w, "+e+");\n      int offset_d = (offset_h * "+e+" + offset_w) *\n        "+this.getOutputDepthSize()+";\n      int in_d = d + offset_d;\n\n      float result = "+this.getInputSamplingString()+";\n      setOutput(result);\n    }\n  "}return t.prototype.getHeightCoordString=function(){return"NHWC"===this.dataFormat?"coords[1]":"coords[2]"},t.prototype.getWidthCoordString=function(){return"NHWC"===this.dataFormat?"coords[2]":"coords[3]"},t.prototype.getDepthCoordString=function(){return"NHWC"===this.dataFormat?"coords[3]":"coords[1]"},t.prototype.getOutputDepthSize=function(){return"NHWC"===this.dataFormat?this.outputShape[3]:this.outputShape[1]},t.prototype.getInputSamplingString=function(){return"NHWC"===this.dataFormat?"getX(b, in_h, in_w, in_d)":"getX(b, in_d, in_h, in_w)"},t}(),sa=function(t){this.variableNames=["X"],this.outputShape=[t,t],this.userCode="\n      void main() {\n          ivec2 coords = getOutputCoords();\n          float val = coords[0] == coords[1] ? getX(coords[0]) : 0.0;\n          setOutput(val);\n      }\n    "},ua=function(t){this.variableNames=["A"];var e=fi();this.outputShape=t,this.userCode="\n      "+gi+"\n\n      void main() {\n        float x = getAAtOutCoords();\n        "+e.output+" = encode_float(x);\n      }\n    "},la=function(t){this.variableNames=["A"],this.usesPackedTextures=!0;var e=fi();this.outputShape=t,this.userCode="\n      "+gi+"\n\n      void main() {\n        ivec3 coords = getOutputCoords();\n        float x = getChannel(getAAtOutCoords(), vec2(coords.y, coords.z));\n        "+e.output+" = encode_float(x);\n      }\n    "},ca=function(t,e,n){void 0===n&&(n=!1),this.variableNames=["A"];var r=fi(),i=e[0],a=e[1];this.outputShape=t;var o="result";n&&(o="floor(result * 255. + 0.5)"),this.userCode="\n      "+mi(t)+"\n\n      void main() {\n        ivec3 coords = getOutputCoords();\n\n        int flatIndex = getFlatIndex(coords);\n        int offset = imod(flatIndex, 4);\n\n        flatIndex = idiv(flatIndex, 4, 1.);\n        \n        int r = flatIndex / "+a+";\n        int c = imod(flatIndex, "+a+");\n        vec2 uv = (vec2(c, r) + halfCR) / vec2("+a+".0, "+i+".0);\n        vec4 values = "+r.texture2D+"(A, uv);\n\n        float result;\n\n        if(offset == 0) {\n          result = values[0];\n        } else if(offset == 1) {\n          result = values[1];\n        } else if(offset == 2) {\n          result = values[2];\n        } else {\n          result = values[3];\n        }\n\n        "+r.output+" = vec4("+o+", 0., 0., 0.);\n      }\n    "},pa=function(t,e,n){void 0===n&&(n=!1),this.variableNames=["A"];var r=fi(),i=e[0],a=e[1];this.outputShape=t;var o="",s="result";n&&(s="floor(result * 255. + 0.5)");for(var u=0;u<=1;u++)for(var l=0;l<=1;l++){var c=2*u+l;o+="\n          localCoords = coords;\n          if(localCoords[2] + "+l+" < "+t[2]+") {\n            localCoords[2] += "+l+";\n            if(localCoords[1] + "+u+" < "+t[1]+") {\n              localCoords[1] += "+u+";\n\n              flatIndex = getFlatIndex(localCoords);\n              offset = imod(flatIndex, 4);\n    \n              flatIndex = idiv(flatIndex, 4, 1.);\n\n              r = flatIndex / "+a+";\n              c = imod(flatIndex, "+a+");\n              uv = (vec2(c, r) + halfCR) / vec2("+a+".0, "+i+".0);\n              values = "+r.texture2D+"(A, uv);\n\n              if(offset == 0) {\n                result["+c+"] = values[0];\n              } else if(offset == 1) {\n                result["+c+"] = values[1];\n              } else if(offset == 2) {\n                result["+c+"] = values[2];\n              } else {\n                result["+c+"] = values[3];\n              }\n            }\n          }\n        "}this.userCode="\n      "+mi(t)+"\n\n      void main() {\n        ivec3 coords = getOutputCoords();\n\n        vec4 result = vec4(0.);\n        int flatIndex, r, c, offset;\n        ivec3 localCoords;\n        vec2 uv;\n        vec4 values;\n        \n        "+o+"\n\n        "+r.output+" = "+s+";\n      }\n    "},ha=function(t,e,n){this.variableNames=["real","imag"];var r=e[1];this.outputShape=e;var i=n?"2.0 * "+Math.PI:"-2.0 * "+Math.PI,a=n?r+".0":"1.0";this.userCode="\n      const float exponentMultiplier = "+i+";\n\n      float unaryOpComplex(float real, float expR, float imag, float expI) {\n        "+t+"\n      }\n\n      float mulMatDFT(int batch, int index) {\n        float indexRatio = float(index) / float("+r+");\n        float exponentMultiplierTimesIndexRatio =\n            exponentMultiplier * indexRatio;\n\n        float result = 0.0;\n\n        for (int i = 0; i < "+r+"; i++) {\n          // x = (-2|2 * PI / N) * index * i;\n          float x = exponentMultiplierTimesIndexRatio * float(i);\n          float expR = cos(x);\n          float expI = sin(x);\n          float real = getReal(batch, i);\n          float imag = getImag(batch, i);\n\n          result +=\n              unaryOpComplex(real, expR, imag, expI) / "+a+";\n        }\n\n        return result;\n      }\n\n      void main() {\n        ivec2 coords = getOutputCoords();\n        setOutput(mulMatDFT(coords[0], coords[1]));\n      }\n    "},fa=function(){function t(t,e){this.outputShape=[],this.variableNames=["x"],this.outputShape=t,this.userCode="\n      uniform float value;\n      void main() {\n        // Input can be obtained from uniform value.\n        setOutput(value);\n      }\n    "}return t.prototype.getCustomSetupFunc=function(t){var e=this;return function(n,r){null==e.valueLoc&&(e.valueLoc=n.getUniformLocationNoThrow(r,"value")),n.gl.uniform1f(e.valueLoc,t)}},t}(),da=function(t){this.variableNames=["A"];var e=fi(),n=t[0],r=t[1];this.outputShape=t,this.userCode="\n      void main() {\n        ivec3 coords = getOutputCoords();\n        int texR = coords[0];\n        int texC = coords[1];\n        int depth = coords[2];\n        vec2 uv = (vec2(texC, texR) + halfCR) / vec2("+r+".0, "+n+".0);\n\n        vec4 values = "+e.texture2D+"(A, uv);\n        float value;\n        if (depth == 0) {\n          value = values.r;\n        } else if (depth == 1) {\n          value = values.g;\n        } else if (depth == 2) {\n          value = values.b;\n        } else if (depth == 3) {\n          value = values.a;\n        }\n\n        setOutput(floor(value * 255.0 + 0.5));\n      }\n    "},ma=function(t){this.variableNames=["A"];var e=fi(),n=t[0],r=t[1];this.outputShape=t,this.userCode="\n      void main() {\n        ivec3 coords = getOutputCoords();\n        int texR = coords[0];\n        int texC = coords[1];\n        int depth = coords[2];\n\n        vec4 result = vec4(0.);\n\n        for(int row=0; row<=1; row++) {\n          for(int col=0; col<=1; col++) {\n            texC = coords[1] + row;\n            depth = coords[2] + col;\n\n            vec2 uv = (vec2(texC, texR) + halfCR) / vec2("+r+".0, "+n+".0);\n            vec4 values = "+e.texture2D+"(A, uv);\n            float value;\n            if (depth == 0) {\n              value = values.r;\n            } else if (depth == 1) {\n              value = values.g;\n            } else if (depth == 2) {\n              value = values.b;\n            } else if (depth == 3) {\n              value = values.a;\n            }\n\n            result[row * 2 + col] = floor(value * 255.0 + 0.5);\n          }\n        }\n\n        "+e.output+" = result;\n      }\n    "},ga=function(t,e,n){this.variableNames=["A","indices"];var r=t.slice();r[n]=e,this.outputShape=r,this.rank=r.length;var i=Ei(this.rank),a=function(t,e){var n=t.length;if(n>4)throw Error("Gather for rank "+n+" is not yet supported");if(1===n)return"int(getIndices(resRC))";for(var r=["resRC.x","resRC.y","resRC.z","resRC.w"],i=[],a=0;a<t.length;a++)a===e?i.push("int(getIndices("+r[a]+"))"):i.push(""+r[a]);return i.join()}(t,n);this.userCode="\n      void main() {\n        "+i+" resRC = getOutputCoords();\n        setOutput(getA("+a+"));\n      }\n    "},va=function(t,e,n){this.sliceDim=t,this.strides=e,this.variableNames=["x","indices"],this.outputShape=n;var r=Ei(e.length),i=Ei(n.length),a=this.sliceDim>1?"strides[j]":"strides";this.userCode="\n        "+r+" strides = "+r+"("+this.strides+");\n         void main() {\n          "+i+" coords = getOutputCoords();\n          int flattenIndex = 0;\n          for (int j = 0; j < "+this.sliceDim+"; j++) {\n            int index = round(getIndices(coords[0], j));\n            flattenIndex += index * "+a+";\n          }\n          setOutput(getX(flattenIndex, coords[1]));\n        }\n      "};function ya(t,e){var n=fi();return Gt(t,e,n.version+"\n    precision highp float;\n    "+n.attribute+" vec3 clipSpacePos;\n    "+n.attribute+" vec2 uv;\n    "+n.varyingVs+" vec2 resultUV;\n\n    void main() {\n      gl_Position = vec4(clipSpacePos, 1);\n      resultUV = uv;\n    }")}function ba(t,e){return te(t,e,new Float32Array([-1,1,0,0,1,-1,-1,0,0,0,1,1,0,1,1,1,-1,0,1,0]))}function xa(t,e){return ee(t,e,new Uint16Array([0,1,2,2,1,3]))}function wa(t,e,n,r,i,a,o){re(n,r);var s=ne(t,e),u=t.TEXTURE_2D;return Vt(t,e,function(){return t.bindTexture(u,s)}),Vt(t,e,function(){return t.texParameteri(u,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE)}),Vt(t,e,function(){return t.texParameteri(u,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE)}),Vt(t,e,function(){return t.texParameteri(u,t.TEXTURE_MIN_FILTER,t.NEAREST)}),Vt(t,e,function(){return t.texParameteri(u,t.TEXTURE_MAG_FILTER,t.NEAREST)}),Vt(t,e,function(){return t.texImage2D(u,0,i,n,r,0,a,o,null)}),Vt(t,e,function(){return t.bindTexture(t.TEXTURE_2D,null)}),s}function Na(t,e,n,r,i){var a=zt(n,r);return wa(t,e,a[0],a[1],i.internalFormatFloat,i.textureFormatFloat,t.FLOAT)}function Ca(t,e,n,r,i){var a=zt(n,r);return wa(t,e,a[0],a[1],i.internalFormatHalfFloat,i.textureFormatFloat,i.textureTypeHalfFloat)}function Ea(t,e,n,r,i){var a=zt(n,r);return wa(t,e,a[0],a[1],t.RGBA,t.RGBA,t.UNSIGNED_BYTE)}function Sa(t,e,n,r,i){var a=Pt(n,r);return wa(t,e,a[0],a[1],i.internalFormatPackedFloat,t.RGBA,t.FLOAT)}function ka(t,e,n,r,i){var a=Pt(n,r);return wa(t,e,a[0],a[1],i.internalFormatPackedHalfFloat,t.RGBA,i.textureTypeHalfFloat)}function Ia(t,e,n,r){return Vt(t,e,function(){return t.bindBuffer(t.ARRAY_BUFFER,r)}),ae(t,e,n,"clipSpacePos",r,3,20,0)&&ae(t,e,n,"uv",r,2,20,12)}function Aa(t,e,n,r,i,a,o){var s,u,l;Vt(t,e,function(){return t.bindTexture(t.TEXTURE_2D,n)}),a instanceof Uint8Array?(s=new Uint8Array(r*i*4),u=t.UNSIGNED_BYTE,l=t.RGBA):(s=new Float32Array(r*i*4),u=t.FLOAT,l=o.internalFormatPackedFloat),s.set(a),Vt(t,e,function(){return t.texImage2D(t.TEXTURE_2D,0,l,r,i,0,t.RGBA,u,s)}),Vt(t,e,function(){return t.bindTexture(t.TEXTURE_2D,null)})}function Ra(t,e,n,r){Vt(t,e,function(){return t.bindTexture(t.TEXTURE_2D,n)}),r.data instanceof Uint8Array?Vt(t,e,function(){return t.texImage2D(t.TEXTURE_2D,0,t.RGBA,r.width,r.height,0,t.RGBA,t.UNSIGNED_BYTE,r.data)}):Vt(t,e,function(){return t.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,r)}),Vt(t,e,function(){return t.bindTexture(t.TEXTURE_2D,null)})}function Ta(t,e,n,r,i){var a=t.createBuffer();Vt(t,e,function(){return t.bindBuffer(t.PIXEL_PACK_BUFFER,a)});var o=16*n*r;return Vt(t,e,function(){return t.bufferData(t.PIXEL_PACK_BUFFER,o,t.STREAM_READ)}),Vt(t,e,function(){return t.readPixels(0,0,r,n,t.RGBA,t.FLOAT,0)}),Vt(t,e,function(){return t.bindBuffer(t.PIXEL_PACK_BUFFER,null)}),a}function Da(t,e,n){var r=t,i=new Float32Array(n);return r.bindBuffer(r.PIXEL_PACK_BUFFER,e),r.getBufferSubData(r.PIXEL_PACK_BUFFER,0,i),r.bindBuffer(r.PIXEL_PACK_BUFFER,null),i}function Oa(t,e,n,r,i){var a=zt(n,r),o=a[0],s=a[1],u=new Uint8Array(n*r*4);return Vt(t,e,function(){return t.readPixels(0,0,o,s,i.downloadTextureFormat,t.UNSIGNED_BYTE,u)}),new Float32Array(u.buffer)}function _a(t,e,n,r,i,a,o,s){var u=t,l=new Float32Array(function(t,e){var n=Pt(a,o);return n[0]*n[1]*4}());return u.bindBuffer(u.PIXEL_PACK_BUFFER,e),u.getBufferSubData(u.PIXEL_PACK_BUFFER,0,l),u.bindBuffer(u.PIXEL_PACK_BUFFER,null),l}function Fa(t,e,n,r){var i=new Float32Array(n*r*4);return Vt(t,e,function(){return t.readPixels(0,0,r,n,t.RGBA,t.FLOAT,i)}),i}var Ma=Object.freeze({createVertexShader:ya,createVertexBuffer:ba,createIndexBuffer:xa,createFloat32MatrixTexture:Na,createFloat16MatrixTexture:Ca,createUnsignedBytesMatrixTexture:Ea,createPackedMatrixTexture:Sa,createFloat16PackedMatrixTexture:ka,bindVertexProgramAttributeStreams:Ia,uploadDenseMatrixToTexture:Aa,uploadPixelDataToTexture:Ra,createBufferFromOutputTexture:Ta,downloadFloat32MatrixFromBuffer:Da,downloadByteEncodedFloatMatrixFromOutputTexture:Oa,downloadPackedMatrixFromBuffer:_a,downloadMatrixFromPackedOutputTexture:Fa}),za=function(){function e(e){this.outputTexture=null,this.program=null,this.disposed=!1,this.vertexAttrsAreBound=!1,this.itemsToPoll=[];var n=t.ENV.getNumber("WEBGL_VERSION");if(null!=e?(this.gl=e,_t(n,e)):this.gl=Ft(n),1===t.ENV.getNumber("WEBGL_VERSION"))this.textureFloatExtension=Ht(this.gl,this.debug,"OES_texture_float"),this.colorBufferFloatExtension=this.gl.getExtension("WEBGL_color_buffer_float"),t.ENV.getBool("WEBGL_RENDER_FLOAT32_ENABLED")||(this.textureHalfFloatExtension=Ht(this.gl,this.debug,"OES_texture_half_float"),this.colorBufferHalfFloatExtension=this.gl.getExtension("EXT_color_buffer_half_float"));else if(Se(this.gl,"EXT_color_buffer_float"))this.colorBufferFloatExtension=this.gl.getExtension("EXT_color_buffer_float");else{if(!Se(this.gl,"EXT_color_buffer_half_float"))throw new Error("GL context does not support color renderable floats");this.colorBufferHalfFloatExtension=this.gl.getExtension("EXT_color_buffer_half_float")}this.vertexBuffer=ba(this.gl,this.debug),this.indexBuffer=xa(this.gl,this.debug),this.framebuffer=ie(this.gl,this.debug),this.textureConfig=Bt(this.gl,this.textureHalfFloatExtension)}return Object.defineProperty(e.prototype,"debug",{get:function(){return t.ENV.getBool("DEBUG")},enumerable:!0,configurable:!0}),e.prototype.dispose=function(){var t=this;if(!this.disposed){null!=this.program&&console.warn("Disposing a GPGPUContext that still has a bound WebGLProgram. This is probably a resource leak, delete the program with GPGPUContext.deleteProgram before disposing."),null!=this.outputTexture&&console.warn("Disposing a GPGPUContext that still has a bound output matrix texture.  This is probably a resource leak, delete the output matrix texture with GPGPUContext.deleteMatrixTexture before disposing.");var e=this.gl;Vt(e,this.debug,function(){return e.finish()}),Vt(e,this.debug,function(){return e.bindFramebuffer(e.FRAMEBUFFER,null)}),Vt(e,this.debug,function(){return e.deleteFramebuffer(t.framebuffer)}),Vt(e,this.debug,function(){return e.bindBuffer(e.ARRAY_BUFFER,null)}),Vt(e,this.debug,function(){return e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,null)}),Vt(e,this.debug,function(){return e.deleteBuffer(t.indexBuffer)}),this.disposed=!0}},e.prototype.createFloat32MatrixTexture=function(t,e){return this.throwIfDisposed(),Na(this.gl,this.debug,t,e,this.textureConfig)},e.prototype.createFloat16MatrixTexture=function(t,e){return this.throwIfDisposed(),Ca(this.gl,this.debug,t,e,this.textureConfig)},e.prototype.createUnsignedBytesMatrixTexture=function(t,e){return this.throwIfDisposed(),Ea(this.gl,this.debug,t,e,this.textureConfig)},e.prototype.uploadPixelDataToTexture=function(t,e){this.throwIfDisposed(),Ra(this.gl,this.debug,t,e)},e.prototype.uploadDenseMatrixToTexture=function(t,e,n,r){this.throwIfDisposed(),Aa(this.gl,this.debug,t,e,n,r,this.textureConfig)},e.prototype.createFloat16PackedMatrixTexture=function(t,e){return this.throwIfDisposed(),ka(this.gl,this.debug,t,e,this.textureConfig)},e.prototype.createPackedMatrixTexture=function(t,e){return this.throwIfDisposed(),Sa(this.gl,this.debug,t,e,this.textureConfig)},e.prototype.deleteMatrixTexture=function(t){var e=this;this.throwIfDisposed(),this.outputTexture===t&&(pe(this.gl,this.debug,this.framebuffer),this.outputTexture=null),Vt(this.gl,this.debug,function(){return e.gl.deleteTexture(t)})},e.prototype.downloadByteEncodedFloatMatrixFromOutputTexture=function(t,e,n){var r=this;return this.downloadMatrixDriver(t,function(){return Oa(r.gl,r.debug,e,n,r.textureConfig)})},e.prototype.downloadPackedMatrixFromBuffer=function(t,e,n,r,i,a){return _a(this.gl,t,0,0,0,i,a,this.textureConfig)},e.prototype.downloadFloat32MatrixFromBuffer=function(t,e){return Da(this.gl,t,e)},e.prototype.createBufferFromTexture=function(t,e,n){this.bindTextureToFrameBuffer(t);var r=Ta(this.gl,this.debug,e,n,this.textureConfig);return this.unbindTextureToFrameBuffer(),r},e.prototype.createAndWaitForFence=function(){var t=this.createFence(this.gl);return this.pollFence(t)},e.prototype.createFence=function(e){var n,r,i=this;if(t.ENV.getBool("WEBGL_FENCE_API_ENABLED")){var a=e,o=a.fenceSync(a.SYNC_GPU_COMMANDS_COMPLETE,0);e.flush(),r=function(){var t=a.clientWaitSync(o,0,0);return t===a.ALREADY_SIGNALED||t===a.CONDITION_SATISFIED},n=o}else t.ENV.getNumber("WEBGL_DISJOINT_QUERY_TIMER_EXTENSION_VERSION")>0?(n=this.beginQuery(),this.endQuery(),r=function(){return i.isQueryAvailable(n,t.ENV.getNumber("WEBGL_DISJOINT_QUERY_TIMER_EXTENSION_VERSION"))}):r=function(){return!0};return{query:n,isFencePassed:r}},e.prototype.downloadMatrixFromPackedTexture=function(t,e,n){var r=this;return this.downloadMatrixDriver(t,function(){return Fa(r.gl,r.debug,e,n)})},e.prototype.createProgram=function(t){this.throwIfDisposed();var e=this.gl,n=Kt(e,this.debug,t),r=ya(e,this.debug),i=Jt(e,this.debug);return Vt(e,this.debug,function(){return e.attachShader(i,r)}),Vt(e,this.debug,function(){return e.attachShader(i,n)}),Zt(e,this.debug,i),this.debug&&Qt(e,this.debug,i),this.vertexAttrsAreBound||(this.setProgram(i),this.vertexAttrsAreBound=Ia(e,this.debug,this.program,this.vertexBuffer)),i},e.prototype.deleteProgram=function(t){var e=this;this.throwIfDisposed(),t===this.program&&(this.program=null),null!=t&&Vt(this.gl,this.debug,function(){return e.gl.deleteProgram(t)})},e.prototype.setProgram=function(t){var e=this;this.throwIfDisposed(),this.program=t,null!=this.program&&this.debug&&Qt(this.gl,this.debug,this.program),Vt(this.gl,this.debug,function(){return e.gl.useProgram(t)})},e.prototype.getUniformLocation=function(t,e,n){return void 0===n&&(n=!0),this.throwIfDisposed(),n?se(this.gl,this.debug,t,e):ue(this.gl,t,e)},e.prototype.getAttributeLocation=function(t,e){var n=this;return this.throwIfDisposed(),Vt(this.gl,this.debug,function(){return n.gl.getAttribLocation(t,e)})},e.prototype.getUniformLocationNoThrow=function(t,e){return this.throwIfDisposed(),this.gl.getUniformLocation(t,e)},e.prototype.setInputMatrixTexture=function(t,e,n){this.throwIfDisposed(),this.throwIfNoProgram(),le(this.gl,this.debug,this.program,t,e,n)},e.prototype.setOutputMatrixTexture=function(t,e,n){this.setOutputMatrixTextureDriver(t,n,e)},e.prototype.setOutputPackedMatrixTexture=function(t,e,n){this.throwIfDisposed();var r=Pt(e,n),i=r[0],a=r[1];this.setOutputMatrixTextureDriver(t,i,a)},e.prototype.setOutputMatrixWriteRegion=function(t,e,n,r){this.setOutputMatrixWriteRegionDriver(n,t,r,e)},e.prototype.setOutputPackedMatrixWriteRegion=function(t,e,n,r){throw new Error("setOutputPackedMatrixWriteRegion not implemented.")},e.prototype.debugValidate=function(){null!=this.program&&Qt(this.gl,this.debug,this.program),he(this.gl)},e.prototype.executeProgram=function(){this.throwIfDisposed(),this.throwIfNoProgram();var t=this.gl;this.debug&&this.debugValidate(),Vt(t,this.debug,function(){return t.drawElements(t.TRIANGLES,6,t.UNSIGNED_SHORT,0)})},e.prototype.blockUntilAllProgramsCompleted=function(){var t=this;this.throwIfDisposed(),Vt(this.gl,this.debug,function(){return t.gl.finish()})},e.prototype.getQueryTimerExtension=function(){return null==this.disjointQueryTimerExtension&&(this.disjointQueryTimerExtension=Ht(this.gl,this.debug,2===t.ENV.getNumber("WEBGL_DISJOINT_QUERY_TIMER_EXTENSION_VERSION")?"EXT_disjoint_timer_query_webgl2":"EXT_disjoint_timer_query")),this.disjointQueryTimerExtension},e.prototype.getQueryTimerExtensionWebGL2=function(){return this.getQueryTimerExtension()},e.prototype.getQueryTimerExtensionWebGL1=function(){return this.getQueryTimerExtension()},e.prototype.beginQuery=function(){if(2===t.ENV.getNumber("WEBGL_DISJOINT_QUERY_TIMER_EXTENSION_VERSION")){var e=this.gl,n=this.getQueryTimerExtensionWebGL2(),r=e.createQuery();return e.beginQuery(n.TIME_ELAPSED_EXT,r),r}var i=this.getQueryTimerExtensionWebGL1(),a=i.createQueryEXT();return i.beginQueryEXT(i.TIME_ELAPSED_EXT,a),a},e.prototype.endQuery=function(){if(2!==t.ENV.getNumber("WEBGL_DISJOINT_QUERY_TIMER_EXTENSION_VERSION")){var e=this.getQueryTimerExtensionWebGL1();e.endQueryEXT(e.TIME_ELAPSED_EXT)}else{var n=this.gl,r=this.getQueryTimerExtensionWebGL2();n.endQuery(r.TIME_ELAPSED_EXT)}},e.prototype.waitForQueryAndGetTime=function(e){return r(this,void 0,void 0,function(){var n=this;return i(this,function(r){switch(r.label){case 0:return[4,C(function(){return n.disposed||n.isQueryAvailable(e,t.ENV.getNumber("WEBGL_DISJOINT_QUERY_TIMER_EXTENSION_VERSION"))})];case 1:return r.sent(),[2,this.getQueryTime(e,t.ENV.getNumber("WEBGL_DISJOINT_QUERY_TIMER_EXTENSION_VERSION"))]}})})},e.prototype.getQueryTime=function(t,e){if(0===e)return null;if(2===e){var n=this.gl;return n.getQueryParameter(t,n.QUERY_RESULT)/1e6}var r=this.getQueryTimerExtensionWebGL1();return r.getQueryObjectEXT(t,r.QUERY_RESULT_EXT)/1e6},e.prototype.isQueryAvailable=function(t,e){if(0===e)return!0;if(2===e){var n=this.gl,r=this.getQueryTimerExtensionWebGL2(),i=n.getQueryParameter(t,n.QUERY_RESULT_AVAILABLE);return null==this.disjoint&&(this.disjoint=this.gl.getParameter(r.GPU_DISJOINT_EXT)),i&&!this.disjoint}return i=(r=this.getQueryTimerExtensionWebGL1()).getQueryObjectEXT(t,r.QUERY_RESULT_AVAILABLE_EXT),null==this.disjoint&&(this.disjoint=this.gl.getParameter(r.GPU_DISJOINT_EXT)),i&&!this.disjoint},e.prototype.pollFence=function(t){var e=this;return new Promise(function(n){e.addItemToPoll(function(){return t.isFencePassed()},function(){return n()})})},e.prototype.pollItems=function(){for(var t=function(t){for(var e=0;e<t.length;++e){if(!t[e]())break}return e-1}(this.itemsToPoll.map(function(t){return t.isDoneFn})),e=0;e<=t;++e)(0,this.itemsToPoll[e].resolveFn)();this.itemsToPoll=this.itemsToPoll.slice(t+1)},e.prototype.addItemToPoll=function(t,e){var n=this;this.itemsToPoll.push({isDoneFn:t,resolveFn:e}),this.itemsToPoll.length>1||C(function(){return n.pollItems(),0===n.itemsToPoll.length})},e.prototype.bindTextureToFrameBuffer=function(t){this.throwIfDisposed(),ce(this.gl,this.debug,t,this.framebuffer),this.debug&&he(this.gl)},e.prototype.unbindTextureToFrameBuffer=function(){null!=this.outputTexture?(ce(this.gl,this.debug,this.outputTexture,this.framebuffer),this.debug&&he(this.gl)):pe(this.gl,this.debug,this.framebuffer)},e.prototype.downloadMatrixDriver=function(t,e){this.bindTextureToFrameBuffer(t);var n=e();return this.unbindTextureToFrameBuffer(),n},e.prototype.setOutputMatrixTextureDriver=function(t,e,n){this.throwIfDisposed();var r=this.gl;ce(r,this.debug,t,this.framebuffer),this.debug&&he(r),this.outputTexture=t,Vt(r,this.debug,function(){return r.viewport(0,0,e,n)}),Vt(r,this.debug,function(){return r.scissor(0,0,e,n)})},e.prototype.setOutputMatrixWriteRegionDriver=function(t,e,n,r){var i=this;this.throwIfDisposed(),Vt(this.gl,this.debug,function(){return i.gl.scissor(t,e,n,r)})},e.prototype.throwIfDisposed=function(){if(this.disposed)throw new Error("Attempted to use disposed GPGPUContext.")},e.prototype.throwIfNoProgram=function(){if(null==this.program)throw new Error("No GPU program is currently set.")},e}();function La(t,e){if(t.length!==e.length)throw Error("Binary was compiled with "+t.length+" inputs, but was executed with "+e.length+" inputs");t.forEach(function(t,n){var r=t.logicalShape,i=e[n],a=i.shape;if(!y(r,a))throw Error("Binary was compiled with different shapes than the current args. Shapes "+r+" and "+a+" must match");if(!t.isUniform||!i.isUniform){var o=t.texShape,s=i.isUniform?null:i.texData.texShape;if(!y(o,s))throw Error("Binary was compiled with different texture shapes than the current args. Shape "+o+" and "+s+" must match")}})}var Pa=function(t,e,n){this.variableNames=["A"],this.usesPackedTextures=!0,this.outputShape=t;for(var r=n.filterWidth,i=n.inChannels,a=n.strideWidth,o=n.strideHeight,s=n.padInfo,u=n.outWidth,l=n.dilationWidth,c=n.dilationHeight,p=n.dataFormat,h=s.left,f=s.top,d=i*r,m=fi(),g="channelsLast"===p,v=g?0:1,y=g?1:2,b="",x=0;x<=1;x++)for(var w=0;w<=1;w++)b+="\n          blockIndex = rc.y + "+w+";\n          pos = rc.x + "+x+";\n\n          if(blockIndex < "+t[1]+" && pos < "+t[0]+") {\n            offsetY = int(blockIndex / ("+u+")) * "+o+" - "+f+";\n            d0 = offsetY + "+c+" * (pos / "+d+");\n\n            if(d0 < "+e[v]+" && d0 >= 0) {\n\n              offsetX = int(mod(float(blockIndex), "+u+".) * "+a+". - "+h+".);\n              d1 = offsetX + "+l+" * (int(mod(float(pos), "+d+".) / "+i+".));\n\n              if(d1 < "+e[y]+" && d1 >= 0) {\n\n                ch = int(mod(float(pos), "+i+".));\n\n                if ("+g+") {\n                  innerDims = vec2(d1, ch);\n                  result["+(2*x+w)+"] = getChannel(\n                    getA(d0, int(innerDims.x),\n                    int(innerDims.y)), innerDims);\n                } else {\n                  innerDims = vec2(d0, d1);\n                  result["+(2*x+w)+"] = getChannel(\n                    getA(ch, int(innerDims.x),\n                    int(innerDims.y)), innerDims);\n                }\n              }\n            }\n          }\n        ";this.userCode="\n      void main() {\n        ivec2 rc = getOutputCoords();\n\n        vec4 result = vec4(0);\n\n        int blockIndex, pos, offsetY, d0, offsetX, d1, ch;\n        vec2 innerDims;\n\n        "+b+"\n\n        "+m.output+" = result;\n      }\n    "},Ba=function(t,e,n,r,i){this.variableNames=["x"],this.outputShape=[];var a,o=e,s=t[3]-1;this.outputShape=t;var u="float("+n+") + float("+r+") * sum";a=.5===i?"inversesqrt("+u+")":1===i?"1.0/("+u+")":"exp(log("+u+") * float(-"+i+"));",this.userCode="\n      void main() {\n        ivec4 coords = getOutputCoords();\n        int b = coords[0];\n        int r = coords[1];\n        int c = coords[2];\n        int d = coords[3];\n        float x = getX(b, r, c, d);\n        float sum = 0.0;\n        for (int j = -"+o+"; j <= "+o+"; j++) {\n          int idx = d + j;\n          if (idx >= 0 && idx <=  "+s+") {\n            float z = getX(b, r, c, idx);\n            sum += z * z;\n          }\n        }\n        float val = x * "+a+";\n        setOutput(val);\n      }\n    "},Va=function(t,e,n,r,i){this.variableNames=["inputImage","outputImage","dy"],this.outputShape=[],this.outputShape=t,this.depth=t[3],this.depthRadius=e,this.bias=n,this.alpha=r,this.beta=i,this.userCode="\n      void main() {\n        ivec4 coords = getOutputCoords();\n        int b = coords[0];\n        int r = coords[1];\n        int c = coords[2];\n\n        float result = 0.0;\n        for (int d = 0; d < "+this.depth+"; ++d) {\n          int depthBegin = int(max(0.0, float(d - "+e+")));\n          int depthEnd = int(min(float("+this.depth+"),\n              float(d + "+e+" + 1)));\n\n          const int MIN_DEPTH_BEGIN = 0;\n          const int MAX_DEPTH_END = "+this.depth+";\n\n          float norm = 0.0;\n          for (int k = MIN_DEPTH_BEGIN; k < MAX_DEPTH_END; ++k) {\n            if (k < depthBegin){\n              continue;\n            }\n            else if (k >= depthBegin && k < depthEnd) {\n              norm += getInputImage(b, r, c, k) * getInputImage(b, r, c, k);\n            }\n            else {\n              break;\n            }\n          }\n\n          norm = float("+r+") * norm + float("+n+");\n\n          for(int k = MIN_DEPTH_BEGIN; k < MAX_DEPTH_END; ++k){\n            if (k < depthBegin){\n              continue;\n            }\n            else if (k >= depthBegin && k < depthEnd){\n              float dyi = -2.0 * float("+r+")\n                * float("+i+")\n                * getInputImage(b ,r ,c, k) * getOutputImage(b, r, c, d)\n                / norm;\n              if (k == d) {\n                dyi += pow(norm, -1.0 * "+i+");\n              }\n              if (k == coords[3]) {\n                dyi *= getDy(b, r, c, d);\n                result += dyi;\n              }\n            }\n            else {\n              break;\n            }\n          }\n      }\n      setOutput(result);\n      }\n    "},Wa=function(t,e,n,r,i){this.variableNames=["x"],this.outputShape=[],this.usesPackedTextures=!0;var a,o=e,s=t[3]-1;this.outputShape=t;var u="float("+n+") + float("+r+") * sum";a=.5===i?"inversesqrt("+u+")":1===i?"1.0/("+u+")":"exp(log("+u+") * float(-"+i+"));",this.userCode="\n      void main() {\n        ivec4 coords = getOutputCoords();\n        int b = coords.x;\n        int r = coords.y;\n        int c = coords.z;\n        int d = coords.w;\n\n        bool hasNextCol = d < "+this.outputShape[3]+";\n        bool hasNextRow = c < "+this.outputShape[2]+";\n\n        vec4 sum = vec4(0.);\n        vec4 xFragAtOutputCoords = getX(b, r, c, d);\n\n        vec4 xAtOutputCoords = vec4(\n          getChannel(xFragAtOutputCoords, vec2(c, d)),\n          hasNextCol ?\n            getChannel(xFragAtOutputCoords, vec2(c, d + 1)) : 0.0,\n          hasNextRow ?\n            getChannel(xFragAtOutputCoords , vec2(c + 1, d)) : 0.0,\n          (hasNextRow && hasNextCol) ?\n            getChannel(xFragAtOutputCoords, vec2(c + 1, d + 1)) : 0.0\n        );\n\n        int firstChannel = d - "+o+";\n        vec2 cache = vec2(0.);\n        if(firstChannel >= 0){\n          vec4 firstChannelFrag = getX(b, r, c, firstChannel);\n          cache.x = getChannel(firstChannelFrag, vec2(c, firstChannel));\n            if(hasNextRow){\n              cache.y = getChannel(firstChannelFrag, vec2(c + 1, firstChannel));\n            }\n        }\n\n        ivec2 depth = ivec2(d, d + 1);\n        for (int j = - "+o+"; j <= "+o+"; j++) {\n          ivec2 idx = depth + j;\n          bvec2 aboveLowerBound = greaterThanEqual(idx, ivec2(0));\n          bvec2 belowUpperBound = lessThanEqual(idx, ivec2("+s+"));\n\n          bool depthInRange = aboveLowerBound.x && belowUpperBound.x;\n          bool depthPlusOneInRange = aboveLowerBound.y && belowUpperBound.y;\n\n          if(depthInRange || depthPlusOneInRange){\n            vec4 z = vec4(0.);\n            vec4 xFragAtCurrentDepth;\n            z.xz = cache.xy;\n            if(depthPlusOneInRange && hasNextCol){\n              xFragAtCurrentDepth = idx.y != d ?\n                getX(b, r, c, idx.y) : xFragAtOutputCoords;\n              z.y = getChannel(xFragAtCurrentDepth, vec2(c, idx.y));\n              if(hasNextRow){\n                z.w = getChannel(xFragAtCurrentDepth, vec2(c + 1, idx.y));\n              }\n            }\n            cache.xy = z.yw;\n            sum += z * z;\n          }\n        }\n        vec4 result = xAtOutputCoords * "+a+";\n        setOutput(result);\n      }\n    "},Ua=function(t){this.variableNames=["dy","maxPos"],this.outputShape=t.inShape;var e=t.strideHeight,n=t.strideWidth,r=t.dilationHeight,i=t.effectiveFilterHeight,a=t.effectiveFilterWidth,o=i-1-t.padInfo.top,s=a-1-t.padInfo.left,u=i*a-1;this.userCode="\n      const ivec2 pads = ivec2("+o+", "+s+");\n\n      void main() {\n        ivec4 coords = getOutputCoords();\n        int b = coords[0];\n        int d = coords[3];\n\n        ivec2 dyRCCorner = coords.yz - pads;\n        int dyRCorner = dyRCCorner.x;\n        int dyCCorner = dyRCCorner.y;\n\n        // Convolve dy(?, ?, d) with pos mask(:, :, d) to get dx(xR, xC, d).\n        // ? = to be determined. : = across all values in that axis.\n        float dotProd = 0.0;\n        for (int wR = 0; wR < "+i+";\n          wR += "+r+") {\n          float dyR = float(dyRCorner + wR) / "+e+".0;\n\n          if (dyR < 0.0 || dyR >= "+t.outHeight+".0 || fract(dyR) > 0.0) {\n            continue;\n          }\n          int idyR = int(dyR);\n\n          for (int wC = 0; wC < "+a+"; wC++) {\n            float dyC = float(dyCCorner + wC) / "+n+".0;\n\n            if (dyC < 0.0 || dyC >= "+t.outWidth+".0 ||\n                fract(dyC) > 0.0) {\n              continue;\n            }\n            int idyC = int(dyC);\n\n            float dyValue = getDy(b, idyR, idyC, d);\n            int maxPosValue = "+u+" - int(getMaxPos(b, idyR, idyC, d));\n\n            // Get the current value, check it against the value from the\n            // position matrix.\n            int curPosValue = wR * "+a+" + wC;\n            float mask = float(maxPosValue == curPosValue ? 1.0 : 0.0);\n\n            dotProd += dyValue * mask;\n          }\n        }\n        setOutput(dotProd);\n      }\n    "},ja=function(t){this.variableNames=["dy","maxPos"],this.outputShape=t.inShape;var e=t.strideDepth,n=t.strideHeight,r=t.strideWidth,i=t.dilationDepth,a=t.dilationHeight,o=t.dilationWidth,s=t.effectiveFilterDepth,u=t.effectiveFilterHeight,l=t.effectiveFilterWidth,c=s-1-t.padInfo.front,p=u-1-t.padInfo.top,h=l-1-t.padInfo.left,f=s*u*l-1;this.userCode="\n      const ivec3 pads = ivec3("+c+", "+p+", "+h+");\n\n      void main() {\n        ivec5 coords = getOutputCoords();\n        int batch = coords.x;\n        int ch = coords.u;\n\n        ivec3 dyCorner = ivec3(coords.y, coords.z, coords.w) - pads;\n        int dyDCorner = dyCorner.x;\n        int dyRCorner = dyCorner.y;\n        int dyCCorner = dyCorner.z;\n\n        // Convolve dy(?, ?, ?, ch) with pos mask(:, :, :, d) to get\n        // dx(xD, xR, xC, ch).\n        // ? = to be determined. : = across all values in that axis.\n        float dotProd = 0.0;\n\n        for (int wD = 0; wD < "+s+";\n           wD += "+i+") {\n          float dyD = float(dyDCorner + wD) / "+e+".0;\n\n          if (dyD < 0.0 || dyD >= "+t.outDepth+".0 || fract(dyD) > 0.0) {\n            continue;\n          }\n          int idyD = int(dyD);\n\n          for (int wR = 0; wR < "+u+";\n              wR += "+a+") {\n            float dyR = float(dyRCorner + wR) / "+n+".0;\n\n            if (dyR < 0.0 || dyR >= "+t.outHeight+".0 ||\n                fract(dyR) > 0.0) {\n              continue;\n            }\n            int idyR = int(dyR);\n\n            for (int wC = 0; wC < "+l+";\n                wC += "+o+") {\n              float dyC = float(dyCCorner + wC) / "+r+".0;\n\n              if (dyC < 0.0 || dyC >= "+t.outWidth+".0 ||\n                  fract(dyC) > 0.0) {\n                continue;\n              }\n              int idyC = int(dyC);\n\n              float dyValue = getDy(batch, idyD, idyR, idyC, ch);\n              int maxPosValue = "+f+" -\n                  int(getMaxPos(batch, idyD, idyR, idyC, ch));\n\n              // Get the current value, check it against the value from the\n              // position matrix.\n              int curPosValue =\n                  wD * "+u+" * "+l+" +\n                  wR * "+l+" + wC;\n              float mask = float(maxPosValue == curPosValue ? 1.0 : 0.0);\n\n              dotProd += dyValue * mask;\n            }\n          }\n        }\n        setOutput(dotProd);\n      }\n    "},qa=function(t,e,n,r,i,a,o){void 0===n&&(n=!1),void 0===r&&(r=!1),void 0===i&&(i=!1),void 0===a&&(a=null),void 0===o&&(o=!1),this.variableNames=["matrixA","matrixB"],this.usesPackedTextures=!0,this.outputShape=e;var s=n?t[1]:t[2],u=Math.ceil(s/2),l=n?"i * 2, rc.y":"rc.y, i * 2",c=r?"rc.z, i * 2":"i * 2, rc.z",p=n?["a.xxyy","a.zzww"]:["a.xxzz","a.yyww"],h=r?["b.xzxz","b.ywyw"]:["b.xyxy","b.zwzw"],f="",d="";a&&(f=o?"vec4 activation(vec4 a) {\n          vec4 b = getPreluActivationWeightsAtOutCoords();\n          "+a+"\n        }":"vec4 activation(vec4 x) {\n          "+a+"\n        }",d="result = activation(result);");var m=i?"result += getBiasAtOutCoords();":"";i&&this.variableNames.push("bias"),o&&this.variableNames.push("preluActivationWeights"),this.userCode="\n      "+f+"\n\n      const float sharedDimension = "+u+".0;\n\n      vec4 dot2x2ARowBCol(ivec3 rc) {\n        vec4 result = vec4(0);\n        for (int i = 0; i < "+u+"; i++) {\n          vec4 a = getMatrixA(rc.x, "+l+");\n          vec4 b = getMatrixB(rc.x, "+c+");\n\n          // These swizzled products need to be separately added.\n          // See: https://github.com/tensorflow/tfjs/issues/1735\n          result += ("+p[0]+" * "+h[0]+");\n          result += ("+p[1]+" * "+h[1]+");\n        }\n        return result;\n      }\n\n      void main() {\n        ivec3 rc = getOutputCoords();\n        vec4 result = dot2x2ARowBCol(rc);\n\n        "+m+"\n\n        "+d+"\n\n        setOutput(result);\n      }\n    "},Ha=function(){function t(t,e,n){this.variableNames=["probs"],this.outputShape=[t,n],this.userCode="\n      uniform float seed;\n\n      void main() {\n        ivec2 coords = getOutputCoords();\n        int batch = coords[0];\n\n        float r = random(seed);\n        float cdf = 0.0;\n\n        for (int i = 0; i < "+(e-1)+"; i++) {\n          cdf += getProbs(batch, i);\n\n          if (r < cdf) {\n            setOutput(float(i));\n            return;\n          }\n        }\n\n        // If no other event happened, last event happened.\n        setOutput(float("+(e-1)+"));\n      }\n    "}return t.prototype.getCustomSetupFunc=function(t){var e=this;return function(n,r){null==e.seedLoc&&(e.seedLoc=n.getUniformLocation(r,"seed")),n.gl.uniform1f(e.seedLoc,t)}},t}(),Ga=function(t,e,n,r){this.variableNames=["indices"],this.outputShape=[t,e],this.userCode="\n      void main() {\n        ivec2 coords = getOutputCoords();\n        int index = round(getIndices(coords.x));\n        setOutput(mix(float("+r+"), float("+n+"),\n                      float(index == coords.y)));\n      }\n    "},Ka=function(t){this.variableNames=["A"],this.outputShape=t;var e=t.length;if(0===e)this.userCode="\n        void main() {\n          setOutput(vec4(getA(), 0., 0., 0.));\n        }\n      ";else{var n=hi("rc",e),r=Ei(e),i=function(t,e,n){if(1===t)return"rc > "+e[0];for(var r="",i=t-2;i<t;i++)r+=n[i]+" >= "+e[i],i<t-1&&(r+="||");return r}(e,t,n),a=function(t,e,n,r){if(1===t)return"";var i=r.slice(-2);return"\n    int r = "+i[0]+";\n    int c = "+i[1]+";\n    int rp1 = r + 1;\n    int cp1 = c + 1;\n\n    bool cEdge = cp1 >= "+e+";\n    bool rEdge = rp1 >= "+n+";\n  "}(e,t[t.length-1],t[t.length-2],n),o=function(t,e){var n=t.length,r=function(t,e){for(var n=[],r=0;r<=1;r++)for(var i=0;i<=1;i++){for(var a=(0===r?"r":"rp1")+", "+(0===i?"c":"cp1"),o=2;o<t;o++)a=e[e.length-1-o]+","+a;n.push(a)}return n}(n,e);return 1===n?"getA(rc),\n            rc + 1 >= "+t[0]+" ? 0. : getA(rc + 1),\n            0, 0":"getA("+r[0]+"),\n          cEdge ? 0. : getA("+r[1]+"),\n          rEdge ? 0. : getA("+r[2]+"),\n          rEdge || cEdge ? 0. : getA("+r[3]+")"}(t,n);this.userCode="\n        void main() {\n          "+r+" rc = getOutputCoords();\n\n          if("+i+") {\n            setOutput(vec4(0));\n          } else {\n            "+a+"\n\n            setOutput(vec4("+o+"));\n          }\n        }\n      "}},$a=function(t,e,n){this.variableNames=["x"],this.outputShape=e.map(function(e,n){return e[0]+t[n]+e[1]});var r=t.length,i=Ei(r),a=e.map(function(t){return t[0]}).join(","),o=e.map(function(e,n){return e[0]+t[n]}).join(","),s=["coords[0]","coords[1]","coords[2]","coords[3]"].slice(0,r);this.userCode=1!==r?"\n      "+i+" start = "+i+"("+a+");\n      "+i+" end = "+i+"("+o+");\n\n      void main() {\n        "+i+" outC = getOutputCoords();\n        if (any(lessThan(outC, start)) || any(greaterThanEqual(outC, end))) {\n          setOutput(float("+n+"));\n        } else {\n          "+i+" coords = outC - start;\n          setOutput(getX("+s+"));\n        }\n      }\n    ":"\n        int start = "+a+";\n        int end = "+o+";\n\n        void main() {\n          int outC = getOutputCoords();\n          if (outC < start || outC >= end) {\n            setOutput(float("+n+"));\n          } else {\n            setOutput(getX(outC - start));\n          }\n        }\n      "},Xa=function(t,e,n){this.variableNames=["x"],this.usesPackedTextures=!0,this.outputShape=e.map(function(e,n){return e[0]+t[n]+e[1]});for(var r=t.length,i=Ei(r),a=e.map(function(t){return t[0]}).join(","),o=e.map(function(e,n){return e[0]+t[n]}).join(","),s=hi("rc",r),u=hi("source",r),l=s[r-1]+" < "+this.outputShape[r-1],c=1===r?"source":"vec2("+u.slice(-2).join()+")",p=[i+" rc = outputLoc;",s[r-1]+" += 1;\n       if("+l+") {\n      ",1===r?"":"}\n       rc = outputLoc;\n       "+s[r-2]+" += 1;\n       if("+s[r-2]+" < "+this.outputShape[r-2]+") {",1===r?"":"  "+s[r-1]+" += 1;\n         if("+l+") {"],h=1===r?"rc < start || rc >= end":"any(lessThan(rc, start)) || any(greaterThanEqual(rc, end))",f="",d=0,m=1===r?2:4;d<m;d++)f+="\n        "+p[d]+"\n        if ("+h+") {\n          result["+d+"] = float("+n+");\n        } else {\n          "+i+" source = rc - start;\n          result["+d+"] = getChannel(getX("+u.join()+"), "+c+");\n        }\n      ";f+=1===r?"} ":"}}",this.userCode="\n      const "+i+" start = "+i+"("+a+");\n      const "+i+" end = "+i+"("+o+");\n\n      void main() {\n        "+i+" outputLoc = getOutputCoords();\n        vec4 result = vec4(0.);\n        "+f+"\n        setOutput(result);\n      }\n    "},Ya=function(t,e,n){if(this.variableNames=["x"],"avg"===e&&n)throw new Error("Cannot compute positions for average pool.");var r=t.filterWidth,i=t.strideHeight,a=t.strideWidth,o=t.dilationHeight,s=t.dilationWidth,u=t.effectiveFilterHeight,l=t.effectiveFilterWidth,c=t.padInfo.top,p=t.padInfo.left;this.outputShape=t.outShape;var h="avg"===e,f="0.0";if(h||(f="-1.0 / 1e-20"),n)this.userCode="\n        const ivec2 strides = ivec2("+i+", "+a+");\n        const ivec2 pads = ivec2("+c+", "+p+");\n\n        void main() {\n          ivec4 coords = getOutputCoords();\n          int batch = coords[0];\n          int d = coords[3];\n\n          ivec2 xRCCorner = coords.yz * strides - pads;\n          int xRCorner = xRCCorner.x;\n          int xCCorner = xRCCorner.y;\n\n          // max/min x(?, ?, d) to get y(yR, yC, d).\n          // ? = to be determined\n          float minMaxValue = 0.0;\n          float minMaxValueFound = 0.0;\n          int minMaxPosition = 0;\n          float avgValue = 0.0;\n\n          for (int wR = 0; wR < "+u+";\n              wR += "+o+") {\n            int xR = xRCorner + wR;\n\n            if (xR < 0 || xR >= "+t.inHeight+") {\n              continue;\n            }\n\n            for (int wC = 0; wC < "+l+";\n                wC += "+s+") {\n              int xC = xCCorner + wC;\n\n              if (xC < 0 || xC >= "+t.inWidth+") {\n                continue;\n              }\n\n              float value = getX(batch, xR, xC, d);\n\n              // If a min / max value has already been found, use it. If not,\n              // use the current value.\n              float currMinMaxValue = mix(\n                  value, minMaxValue, minMaxValueFound);\n              if (value >= currMinMaxValue) {\n                minMaxValue = value;\n                minMaxValueFound = 1.0;\n                minMaxPosition = wR * "+l+" + wC;\n              }\n            }\n          }\n          setOutput(float(minMaxPosition));\n        }\n      ";else{var d=e+"("+e+"("+e+"(minMaxValue[0], minMaxValue[1]), minMaxValue[2]), minMaxValue[3])";"avg"===e&&(d="avgValue / count");var m=4*Math.floor(r/4),g=r%4,v="\n      if ("+h+") {\n        avgValue += dot(values, ones);\n      } else {\n        minMaxValue = max(values, minMaxValue);\n      }\n    ";this.userCode="\n      const ivec2 strides = ivec2("+i+", "+a+");\n      const ivec2 pads = ivec2("+c+", "+p+");\n      const float initializationValue = "+f+";\n      const vec4 ones = vec4(1.0, 1.0, 1.0, 1.0);\n\n      float count = 0.0;\n\n      float getValue(int batch, int xR, int xC, int d) {\n        if (xC < 0 || xC >= "+t.inWidth+") {\n          return initializationValue;\n        }\n        count += 1.0;\n        return getX(batch, xR, xC, d);\n      }\n\n      void main() {\n        ivec4 coords = getOutputCoords();\n        int batch = coords[0];\n        int d = coords[3];\n\n        ivec2 xRCCorner = coords.yz * strides - pads;\n        int xRCorner = xRCCorner.x;\n        int xCCorner = xRCCorner.y;\n\n        // max/min x(?, ?, d) to get y(yR, yC, d).\n        // ? = to be determined\n        vec4 minMaxValue = vec4("+f+");\n        float avgValue = 0.0;\n        count = 0.0;\n\n        for (int wR = 0; wR < "+u+";\n            wR += "+o+") {\n          int xR = xRCorner + wR;\n\n          if (xR < 0 || xR >= "+t.inHeight+") {\n            continue;\n          }\n\n          for (int wC = 0; wC < "+m+"; wC += 4) {\n            int xC = xCCorner + wC * "+s+";\n\n            vec4 values = vec4(\n              getValue(batch, xR, xC, d),\n              getValue(batch, xR, xC + "+s+", d),\n              getValue(batch, xR, xC + 2 * "+s+", d),\n              getValue(batch, xR, xC + 3 * "+s+", d)\n            );\n\n            "+v+"\n          }\n\n          int xC = xCCorner + "+m+";\n          if ("+(1===g)+") {\n            vec4 values = vec4(\n              getValue(batch, xR, xC, d),\n              initializationValue,\n              initializationValue,\n              initializationValue\n            );\n\n            "+v+"\n          } else if ("+(2===g)+") {\n            vec4 values = vec4(\n              getValue(batch, xR, xC, d),\n              getValue(batch, xR, xC + "+s+", d),\n              initializationValue,\n              initializationValue\n            );\n\n            "+v+"\n          } else if ("+(3===g)+") {\n            vec4 values = vec4(\n              getValue(batch, xR, xC, d),\n              getValue(batch, xR, xC + "+s+", d),\n              getValue(batch, xR, xC + 2 * "+s+", d),\n              initializationValue\n            );\n\n            "+v+"\n          }\n        }\n        setOutput("+d+");\n      }\n    "}},Ja=function(t,e,n){if(this.variableNames=["x"],"avg"===e&&n)throw new Error("Cannot compute positions for average pool.");var r=t.filterWidth,i=t.strideDepth,a=t.strideHeight,o=t.strideWidth,s=t.dilationDepth,u=t.dilationHeight,l=t.dilationWidth,c=t.effectiveFilterDepth,p=t.effectiveFilterHeight,h=t.effectiveFilterWidth,f=t.padInfo.front,d=t.padInfo.top,m=t.padInfo.left;this.outputShape=t.outShape;var g="avg"===e,v="0.0";if(g||(v="-1.0 / 1e-20"),n)this.userCode="\n        const ivec3 strides =\n            ivec3("+i+", "+a+", "+o+");\n        const ivec3 pads = ivec3("+f+", "+d+", "+m+");\n\n        void main() {\n          ivec5 coords = getOutputCoords();\n          int batch = coords.x;\n          int ch = coords.u;\n\n          ivec3 xCorner = ivec3(coords.y, coords.z, coords.w) * strides - pads;\n          int xDCorner = xCorner.x;\n          int xRCorner = xCorner.y;\n          int xCCorner = xCorner.z;\n\n          // max/min x(?, ?, ?, ch) to get y(yD, yR, yC, ch).\n          // ? = to be determined\n          float minMaxValue = 0.0;\n          float minMaxValueFound = 0.0;\n          int minMaxPosition = 0;\n\n          for (int wD = 0; wD < "+c+";\n              wD += "+s+") {\n            int xD = xDCorner + wD;\n\n            if (xD < 0 || xD >= "+t.inDepth+") {\n              continue;\n            }\n\n            for (int wR = 0; wR < "+p+";\n                wR += "+u+") {\n              int xR = xRCorner + wR;\n\n              if (xR < 0 || xR >= "+t.inHeight+") {\n                continue;\n              }\n\n              for (int wC = 0; wC < "+h+";\n                  wC += "+l+") {\n                int xC = xCCorner + wC;\n\n                if (xC < 0 || xC >= "+t.inWidth+") {\n                  continue;\n                }\n\n                float value = getX(batch, xD, xR, xC, ch);\n\n                // If a min / max value has already been found, use it. If not,\n                // use the current value.\n                float currMinMaxValue = mix(\n                    value, minMaxValue, minMaxValueFound);\n                if (value >= currMinMaxValue) {\n                  minMaxValue = value;\n                  minMaxValueFound = 1.0;\n                  minMaxPosition =\n                      wD * "+p+" * "+h+" +\n                      wR * "+h+" + wC;;\n                }\n              }\n            }\n          }\n          setOutput(float(minMaxPosition));\n        }\n      ";else{var y=e+"("+e+"("+e+"(minMaxValue[0], minMaxValue[1]), minMaxValue[2]), minMaxValue[3])";"avg"===e&&(y="avgValue / count");var b=4*Math.floor(r/4),x=r%4,w="\n      if ("+g+") {\n        avgValue += dot(values, ones);\n      } else {\n        minMaxValue = max(values, minMaxValue);\n      }\n    ";this.userCode="\n      const ivec3 strides =\n        ivec3("+i+", "+a+", "+o+");\n      const ivec3 pads = ivec3("+f+", "+d+", "+m+");\n      const float initializationValue = "+v+";\n      const vec4 ones = vec4(1.0, 1.0, 1.0, 1.0);\n\n      float count = 0.0;\n\n      float getValue(int batch, int xD, int xR, int xC, int ch) {\n        if (xC < 0 || xC >= "+t.inWidth+") {\n          return initializationValue;\n        }\n        count += 1.0;\n        return getX(batch, xD, xR, xC, ch);\n      }\n\n      void main() {\n        ivec5 coords = getOutputCoords();\n        int batch = coords.x;\n        int ch = coords.u;\n\n        ivec3 xCorner = ivec3(coords.y, coords.z, coords.w) * strides - pads;\n        int xDCorner = xCorner.x;\n        int xRCorner = xCorner.y;\n        int xCCorner = xCorner.z;\n\n        // max/min x(?, ?, ?, d) to get y(yD, yR, yC, ch).\n        // ? = to be determined\n        vec4 minMaxValue = vec4("+v+");\n        float avgValue = 0.0;\n        count = 0.0;\n\n        for (int wD = 0; wD < "+c+";\n            wD += "+s+") {\n          int xD = xDCorner + wD;\n\n          if (xD < 0 || xD >= "+t.inDepth+") {\n            continue;\n          }\n\n          for (int wR = 0; wR < "+p+";\n            wR += "+u+") {\n            int xR = xRCorner + wR;\n\n            if (xR < 0 || xR >= "+t.inHeight+") {\n              continue;\n            }\n\n            for (int wC = 0; wC < "+b+"; wC += 4) {\n              int xC = xCCorner + wC * "+l+";\n\n              vec4 values = vec4(\n                getValue(batch, xD, xR, xC, ch),\n                getValue(batch, xD, xR, xC + "+l+", ch),\n                getValue(batch, xD, xR, xC + 2 * "+l+", ch),\n                getValue(batch, xD, xR, xC + 3 * "+l+", ch)\n              );\n\n              "+w+"\n            }\n\n            int xC = xCCorner + "+b+";\n            if ("+(1===x)+") {\n              vec4 values = vec4(\n                getValue(batch, xD, xR, xC, ch),\n                initializationValue,\n                initializationValue,\n                initializationValue\n              );\n\n              "+w+"\n            } else if ("+(2===x)+") {\n              vec4 values = vec4(\n                getValue(batch, xD, xR, xC, ch),\n                getValue(batch, xD, xR, xC + "+l+", ch),\n                initializationValue,\n                initializationValue\n              );\n\n              "+w+"\n            } else if ("+(3===x)+") {\n              vec4 values = vec4(\n                getValue(batch, xD, xR, xC, ch),\n                getValue(batch, xD, xR, xC + "+l+", ch),\n                getValue(batch, xD, xR, xC + 2 * "+l+", ch),\n                initializationValue\n              );\n\n              "+w+"\n            }\n          }\n          setOutput("+y+");\n        }\n      }\n    "}},Za=function(t,e){this.variableNames=["x"];var n=t.windowSize,r=t.batchSize,i=t.inSize,a=Math.ceil(i/n);this.outputShape=[r,a];var o="0.0",s="";"prod"===e?o="1.0":"min"===e?(o="1.0 / 1e-20",s="min"):"max"===e&&(o="-1.0 / 1e-20",s="max");var u=e+"("+e+"("+e+"(minMaxValue[0], minMaxValue[1]), minMaxValue[2]), minMaxValue[3])";"sum"===e?u="sumValue":"prod"===e?u="prodValue":"all"===e?u="allValue":"any"===e&&(u="anyValue");var l=4*Math.floor(n/4),c=n%4,p="\n      if ("+("sum"===e)+") {\n        sumValue += dot(values, ones);\n      } else if ("+("prod"===e)+") {\n        vec2 tmp = vec2(values[0], values[1]) * vec2(values[2], values[3]);\n        prodValue *= tmp[0] * tmp[1];\n      } else {\n        minMaxValue = "+s+"(values, minMaxValue);\n      }\n    ",h="vec4";"all"===e?(o="1.0",p="\n        bool reducedAllValue = all(values);\n        float floatedReducedAllValue = float(reducedAllValue);\n        allValue = float(allValue >= 1.0 && floatedReducedAllValue >= 1.0);\n      ",h="bvec4"):"any"===e&&(o="0.0",p="\n        bool reducedAnyValue = any(values);\n        float floatedReducedAnyValue = float(reducedAnyValue);\n        anyValue = float(anyValue >= 1.0 || floatedReducedAnyValue >= 1.0);\n      ",h="bvec4");var f="";i%n>0&&(f="\n        if (inIdx < 0 || inIdx >= "+i+") {\n          return initializationValue;\n        }\n      "),this.userCode="\n      const float initializationValue = "+o+";\n      const vec4 ones = vec4(1.0, 1.0, 1.0, 1.0);\n\n      float getValue(int batch, int inIdx) {\n        "+f+"\n        return getX(batch, inIdx);\n      }\n\n      void main() {\n        ivec2 coords = getOutputCoords();\n        int batch = coords[0];\n        int outIdx = coords[1];\n        int inOffset = outIdx * "+n+";\n\n        vec4 minMaxValue = vec4("+o+");\n        float prodValue = 1.0;\n        float sumValue = 0.0;\n        float allValue = 1.0;\n        float anyValue = 0.0;\n\n        for (int i = 0; i < "+l+"; i += 4) {\n          int inIdx = inOffset + i;\n          "+h+" values = "+h+"(\n            getValue(batch, inIdx),\n            getValue(batch, inIdx + 1),\n            getValue(batch, inIdx + 2),\n            getValue(batch, inIdx + 3)\n          );\n\n          "+p+"\n        }\n\n        int inIdx = inOffset + "+l+";\n        if ("+(1===c)+") {\n          "+h+" values = "+h+"(\n            getValue(batch, inIdx),\n            initializationValue,\n            initializationValue,\n            initializationValue\n          );\n\n          "+p+"\n        } else if ("+(2===c)+") {\n          "+h+" values = "+h+"(\n            getValue(batch, inIdx),\n            getValue(batch, inIdx + 1),\n            initializationValue,\n            initializationValue\n          );\n\n          "+p+"\n        } else if ("+(3===c)+") {\n          "+h+" values = "+h+"(\n            getValue(batch, inIdx),\n            getValue(batch, inIdx + 1),\n            getValue(batch, inIdx + 2),\n            initializationValue\n          );\n\n          "+p+"\n        }\n        setOutput("+u+");\n      }\n    "},Qa=function(t,e){this.variableNames=["A"],this.usesPackedTextures=!0,this.outputShape=t;for(var n="",r=0;r<4;r++){var i="thisRC = rc;";r%2==1&&(i+="thisRC.z += 1;"),r>1&&(i+="thisRC.y += 1;"),n+="\n        "+i+"\n        "+(r>0?"if(thisRC.y < rows && thisRC.z < cols){":"")+"\n          int flatIndex = getFlatIndex(thisRC);\n\n          ivec3 inputRC = inputCoordsFromReshapedOutCoords(flatIndex);\n          vec2 inputRCInnerDims = vec2(float(inputRC.y),float(inputRC.z));\n\n          result["+r+"] =\n            getChannel(getA(inputRC.x, inputRC.y, inputRC.z), inputRCInnerDims);\n        "+(r>0?"}":"")+"\n      "}this.userCode="\n      \n    ivec3 inputCoordsFromReshapedOutCoords(int index) {\n      "+di(["r","c","d"],e)+"\n      return ivec3(r, c, d);\n    }\n  \n      "+mi(t)+"\n\n      void main() {\n        ivec3 rc = getOutputCoords();\n\n        vec4 result = vec4(0.);\n\n        ivec3 thisRC;\n        int rows = "+t[1]+";\n        int cols = "+t[2]+";\n\n        "+n+"\n\n        setOutput(result);\n      }\n    "},to=function(t,e,n){this.variableNames=["dy"],this.outputShape=[],this.outputShape=e.shape;var r=e.shape,i=r[1],a=r[2],o=t.shape,s=o[1],u=o[2],l=[n&&s>1?i-1:i,n&&u>1?a-1:a],c=[n&&s>1?s-1:s,n&&u>1?u-1:u],p=l[0]/c[0],h=l[1]/c[1],f=1/p,d=1/h,m=2*Math.ceil(f)+2,g=2*Math.ceil(d)+2;this.userCode="\n      void main() {\n        ivec4 coords = getOutputCoords();\n        int b = coords[0];\n        int d = coords[3];\n        int r = coords[1];\n        int c = coords[2];\n\n        float accumulator = 0.0;\n\n        const float heightScale = float("+p+");\n        const float widthScale = float("+h+");\n\n        const float invHeightScale = float("+f+");\n        const float invWidthScale = float("+d+");\n\n        const int winHeight = int("+m+");\n        const int winWidth = int("+g+");\n\n        // Compute bounds for where in dy we will look\n        float startRLerp = floor(float(r) * invHeightScale);\n        int startDyR = int(startRLerp - float(winHeight / 2));\n\n        float startCLerp = floor(float(c) * invWidthScale);\n        int startDyC = int(startCLerp - float(winWidth / 2));\n\n        // Loop over dy\n        for (int dyROffset = 0; dyROffset < winHeight; dyROffset++) {\n          int dyR = dyROffset + startDyR;\n\n          // Guard against the window exceeding the bounds of dy\n          if (dyR < 0 || dyR >= "+s+") {\n            continue;\n          }\n\n          for (int dyCOffset = 0; dyCOffset < winWidth; dyCOffset++) {\n            int dyC = dyCOffset + startDyC;\n\n            // Guard against the window exceeding the bounds of dy\n            if (dyC < 0 || dyC >= "+u+") {\n              continue;\n            }\n\n            float dxR = float(dyR) * heightScale;\n            int topDxRIndex = int(floor(dxR));\n            int bottomDxRIndex = int(min(ceil(dxR), "+(i-1)+".0));\n            float dxRLerp = dxR - float(topDxRIndex);\n            float inverseDxRLerp = 1.0 - dxRLerp;\n\n            float dxC = float(dyC) * widthScale;\n            int leftDxCIndex = int(floor(dxC));\n            int rightDxCIndex = int(min(ceil(dxC), "+(a-1)+".0));\n            float dxCLerp = dxC - float(leftDxCIndex);\n            float inverseDxCLerp = 1.0 - dxCLerp;\n\n            if (r == topDxRIndex && c == leftDxCIndex) {\n              // topLeft\n              accumulator +=\n                getDy(b, dyR, dyC, d) * inverseDxRLerp * inverseDxCLerp;\n            }\n\n            if (r == topDxRIndex && c == rightDxCIndex) {\n              // topRight\n              accumulator += getDy(b, dyR, dyC, d) * inverseDxRLerp * dxCLerp;\n            }\n\n            if (r == bottomDxRIndex && c == leftDxCIndex) {\n              // bottomLeft\n              accumulator += getDy(b, dyR, dyC, d) * dxRLerp * inverseDxCLerp;\n            }\n\n            if (r == bottomDxRIndex && c == rightDxCIndex) {\n              // bottomRight\n              accumulator += getDy(b, dyR, dyC, d) * dxRLerp * dxCLerp;\n            }\n          }\n        }\n        // End loop over dy\n\n        setOutput(accumulator);\n      }\n    "},eo=function(t,e,n,r){this.variableNames=["A"],this.outputShape=[];var i=t[0],a=t[1],o=t[2],s=t[3];this.outputShape=[i,e,n,s];var u=[r&&e>1?a-1:a,r&&n>1?o-1:o],l=[r&&e>1?e-1:e,r&&n>1?n-1:n];this.userCode="\n      const vec2 effectiveInputOverOutputRatioRC = vec2(\n          "+u[0]/l[0]+",\n          "+u[1]/l[1]+");\n      const vec2 inputShapeRC = vec2("+a+".0, "+o+".0);\n\n      void main() {\n        ivec4 coords = getOutputCoords();\n        int b = coords[0];\n        int d = coords[3];\n        ivec2 yRC = coords.yz;\n\n        // Fractional source index.\n        vec2 sourceFracIndexRC = vec2(yRC) * effectiveInputOverOutputRatioRC;\n\n        // Compute the four integer indices.\n        ivec2 sourceFloorRC = ivec2(sourceFracIndexRC);\n        ivec2 sourceCeilRC = ivec2(\n          min(inputShapeRC - 1.0, ceil(sourceFracIndexRC)));\n\n        float topLeft = getA(b, sourceFloorRC.x, sourceFloorRC.y, d);\n        float bottomLeft = getA(b, sourceCeilRC.x, sourceFloorRC.y, d);\n        float topRight = getA(b, sourceFloorRC.x, sourceCeilRC.y, d);\n        float bottomRight = getA(b, sourceCeilRC.x, sourceCeilRC.y, d);\n\n        vec2 fracRC = sourceFracIndexRC - vec2(sourceFloorRC);\n\n        float top = topLeft + (topRight - topLeft) * fracRC.y;\n        float bottom = bottomLeft + (bottomRight - bottomLeft) * fracRC.y;\n        float newValue = top + (bottom - top) * fracRC.x;\n\n        setOutput(newValue);\n      }\n    "},no=function(t,e,n,r){this.variableNames=["A"],this.usesPackedTextures=!0,this.outputShape=[];var i=t[0],a=t[1],o=t[2],s=t[3];this.outputShape=[i,e,n,s];var u=[r&&e>1?a-1:a,r&&n>1?o-1:o],l=[r&&e>1?e-1:e,r&&n>1?n-1:n];this.userCode="\n      const vec3 effectiveInputOverOutputRatioRC = vec3(\n          "+u[0]/l[0]+",\n          "+u[1]/l[1]+",\n          "+u[1]/l[1]+");\n      const vec3 inputShapeRC = vec3("+a+".0, "+o+".0,\n                                     "+o+".0);\n\n      float getAValue(int b, int r, int c, int d) {\n        return getChannel(getA(b, r, c, d), vec2(c, d));\n      }\n\n      void main() {\n        ivec4 coords = getOutputCoords();\n        int b = coords[0];\n        int d = coords[3];\n        // Calculate values for next column in yRC.z.\n        ivec3 yRC = coords.yzz + ivec3(0, 0, 1);\n\n        // Fractional source index.\n        vec3 sourceFracIndexRC = vec3(yRC) * effectiveInputOverOutputRatioRC;\n\n        // Compute the four integer indices.\n        ivec3 sourceFloorRC = ivec3(sourceFracIndexRC);\n        ivec3 sourceCeilRC = ivec3(\n          min(inputShapeRC - 1.0, ceil(sourceFracIndexRC)));\n        \n        // Should we calculate next column and row elements in 2x2 packed cell.\n        bool hasNextCol = d < "+(s-1)+"; \n        bool hasNextRow = coords.z < "+(n-1)+";\n\n        // In parallel, construct four corners for all four components in\n        // packed 2x2 cell.\n        vec4 topLeft = vec4(\n          getAValue(b, sourceFloorRC.x, sourceFloorRC.y, d),\n          hasNextCol ? getAValue(b, sourceFloorRC.x, sourceFloorRC.y, d + 1)\n                     : 0.0,\n          hasNextRow ? getAValue(b, sourceFloorRC.x, sourceFloorRC.z, d)\n                     : 0.0,\n          (hasNextRow && hasNextCol) ?\n            getAValue(b, sourceFloorRC.x, sourceFloorRC.z, d + 1) : 0.0);\n\n        vec4 bottomLeft = vec4(\n          getAValue(b, sourceCeilRC.x, sourceFloorRC.y, d),\n          hasNextCol ? getAValue(b, sourceCeilRC.x, sourceFloorRC.y, d + 1)\n                     : 0.0,\n          hasNextRow ? getAValue(b, sourceCeilRC.x, sourceFloorRC.z, d)\n                     : 0.0,\n          (hasNextRow && hasNextCol) ?\n            getAValue(b, sourceCeilRC.x, sourceFloorRC.z, d + 1) : 0.0);\n\n        vec4 topRight = vec4(\n          getAValue(b, sourceFloorRC.x, sourceCeilRC.y, d),\n          hasNextCol ? getAValue(b, sourceFloorRC.x, sourceCeilRC.y, d + 1)\n                     : 0.0,\n          hasNextRow ? getAValue(b, sourceFloorRC.x, sourceCeilRC.z, d)\n                     : 0.0,\n          (hasNextRow && hasNextCol) ?\n            getAValue(b, sourceFloorRC.x, sourceCeilRC.z, d + 1) : 0.0);\n\n        vec4 bottomRight = vec4(\n          getAValue(b, sourceCeilRC.x, sourceCeilRC.y, d),\n          hasNextCol ? getAValue(b, sourceCeilRC.x, sourceCeilRC.y, d + 1)\n                     : 0.0,\n          hasNextRow ? getAValue(b, sourceCeilRC.x, sourceCeilRC.z, d)\n                     : 0.0,\n          (hasNextRow && hasNextCol) ?\n            getAValue(b, sourceCeilRC.x, sourceCeilRC.z, d + 1) : 0.0);\n\n        vec3 fracRC = sourceFracIndexRC - vec3(sourceFloorRC);\n\n        vec4 top = mix(topLeft, topRight, fracRC.yyzz);\n        vec4 bottom = mix(bottomLeft, bottomRight, fracRC.yyzz);\n        vec4 newValue = mix(top, bottom, fracRC.x);\n\n        setOutput(newValue);\n      }\n    "},ro=function(t,e,n){this.variableNames=["dy"],this.outputShape=[],this.outputShape=e.shape;var r=e.shape,i=r[1],a=r[2],o=t.shape,s=o[1],u=o[2],l=[n&&s>1?i-1:i,n&&u>1?a-1:a],c=[n&&s>1?s-1:s,n&&u>1?u-1:u],p=l[0]/c[0],h=l[1]/c[1],f=1/p,d=1/h,m=2*Math.ceil(f)+2,g=2*Math.ceil(d)+2;this.userCode="\n      void main() {\n        ivec4 coords = getOutputCoords();\n        int b = coords[0];\n        int d = coords[3];\n        int r = coords[1];\n        int c = coords[2];\n\n        float accumulator = 0.0;\n\n        const float heightScale = float("+p+");\n        const float widthScale = float("+h+");\n\n        const float invHeightScale = float("+f+");\n        const float invWidthScale = float("+d+");\n\n        const int winHeight = int("+m+");\n        const int winWidth = int("+g+");\n\n        // Compute bounds for where in dy we will look\n        float startRLerp = floor(float(r) * invHeightScale);\n        int startDyR = int(floor(startRLerp - float(winHeight / 2)));\n\n        float startCLerp = floor(float(c) * invWidthScale);\n        int startDyC = int(floor(startCLerp - float(winWidth / 2)));\n\n        // Loop over dy\n        for (int dyROffset = 0; dyROffset < winHeight; dyROffset++) {\n          int dyR = dyROffset + startDyR;\n\n          // Guard against the window exceeding the bounds of dy\n          if (dyR < 0 || dyR >= "+s+") {\n            continue;\n          }\n\n          for (int dyCOffset = 0; dyCOffset < winWidth; dyCOffset++) {\n            int dyC = dyCOffset + startDyC;\n\n            // Guard against the window exceeding the bounds of dy\n            if (dyC < 0 || dyC >= "+u+") {\n              continue;\n            }\n\n            float sourceFracRow =\n              float("+l[0]+") *\n                (float(dyR) / float("+c[0]+"));\n\n            float sourceFracCol =\n                float("+l[1]+") *\n                  (float(dyC) / float("+c[1]+"));\n\n            int sourceNearestRow = int(min(\n                float(int("+i+") - 1),\n                "+n+" ? float(round(sourceFracRow)) :\n                                  float(floor(sourceFracRow))));\n\n            int sourceNearestCol = int(min(\n                float(int("+a+") - 1),\n                "+n+" ? float(round(sourceFracCol)) :\n                                  float(floor(sourceFracCol))));\n\n            if (r == sourceNearestRow && c == sourceNearestCol) {\n              accumulator += getDy(b, dyR, dyC, d);\n            }\n          }\n        }\n        // End loop over dy\n\n        setOutput(accumulator);\n      }\n    "},io=function(t,e,n,r){this.variableNames=["A"],this.outputShape=[];var i=t[0],a=t[1],o=t[2],s=t[3];this.outputShape=[i,e,n,s];var u=[r&&e>1?a-1:a,r&&n>1?o-1:o],l=[r&&e>1?e-1:e,r&&n>1?n-1:n],c=r?"0.5":"0.0";this.userCode="\n      const vec2 effectiveInputOverOutputRatioRC = vec2(\n          "+u[0]/l[0]+",\n          "+u[1]/l[1]+");\n      const vec2 inputShapeRC = vec2("+a+".0, "+o+".0);\n\n      void main() {\n        ivec4 coords = getOutputCoords();\n        int b = coords[0];\n        int d = coords[3];\n        ivec2 yRC = coords.yz;\n\n        // Fractional source index.\n        vec2 sourceFracIndexRC = vec2(yRC) * effectiveInputOverOutputRatioRC;\n\n        // Compute the coordinators of nearest neighbor point.\n        ivec2 sourceNearestRC = ivec2(\n          min(inputShapeRC - 1.0, floor(sourceFracIndexRC + "+c+")));\n\n        float newValue = getA(b, sourceNearestRC.x, sourceNearestRC.y, d);\n\n        setOutput(newValue);\n      }\n    "},ao=function(t,e){this.variableNames=["x"];var n=t.length;if(n>4)throw new Error("WebGL backend: Reverse of rank-"+n+" tensor is not yet supported");if(this.outputShape=t,1!==n){var r=t.map(function(n,r){return function(n){return-1!==e.indexOf(n)&&1!==t[n]?t[n]+" - coords["+n+"] - 1":"coords["+n+"]"}(r)}).join(","),i=Ei(n);this.userCode="\n      void main() {\n        "+i+" coords = getOutputCoords();\n        setOutput(getX("+r+"));\n      }\n    "}else this.userCode="\n        void main() {\n          int coord = getOutputCoords();\n          setOutput(getX("+t[0]+" - coord - 1));\n        }\n      "},oo=function(t,e){this.variableNames=["x"],this.usesPackedTextures=!0;var n=t.length;if(n>4)throw new Error("WebGL backend: Reverse of rank-"+n+" tensor is not yet supported");this.outputShape=t;var r=hi("rc",n),i=r[n-1]+" + 1 < "+this.outputShape[n-1],a=r[n-2]+" + 1 < "+this.outputShape[n-2],o=Ei(n);function s(n){var r=t.map(function(r,i){return function(n,r){return-1!==e.indexOf(n)&&1!==t[n]?t[n]+" - "+r[n]+" - 1":""+r[n]}(i,n)});return"getChannel(getX("+r.join(",")+"), vec2("+r.slice(-2).join(",")+"))"}this.userCode=1===n?"\n        void main(){\n          int rc = getOutputCoords();\n          vec4 result = vec4(0.);\n          result.r = getChannel(getX("+t[0]+" - rc - 1),\n            "+t[0]+" - rc - 1);\n          if("+i+"){\n              result.g = getChannel(getX("+t[0]+" - (rc  + 1) - 1),\n                "+t[0]+" - (rc  + 1) - 1);\n          }\n          setOutput(result);\n        }\n      ":"\n        void main() {\n          "+o+" rc = getOutputCoords();\n          vec4 result = vec4(0.);\n          result.r = "+s(r.slice())+";\n          if("+i+"){\n            result.g = "+function(t){return t[n-1]="("+t[n-1]+" + 1)",s(t)}(r.slice())+";\n          }\n          if("+a+") {\n            result.b = "+function(t){return t[n-2]="("+t[n-2]+" + 1)",s(t)}(r.slice())+";\n            if("+i+") {\n              result.a = "+function(t){return t[n-1]="("+t[n-1]+" + 1)",t[n-2]="("+t[n-2]+" + 1)",s(t)}(r.slice())+";\n            }\n          }\n          setOutput(result);\n        }\n    "},so=function(t,e,n,r,i,a,o){void 0===o&&(o=!0),this.variableNames=["updates","indices","defaultValue"],this.outputShape=a;var s=Ei(i.length),u=Ei(a.length),l="";1===n?l="i":2===n&&(l="i, j");var c="getIndices("+l+")",p="";1===r?p="i":2===r&&(p="i, coords[1]");var h="getUpdates("+p+")",f=e>1?"strides[j]":"strides";this.userCode="\n        "+s+" strides = "+s+"("+i+");\n\n        void main() {\n          "+u+" coords = getOutputCoords();\n          float sum = 0.0;\n          bool found = false;\n          for (int i = 0; i < "+t+"; i++) {\n            int flattenedIndex = 0;\n            for (int j = 0; j < "+e+"; j++) {\n              int index = round("+c+");\n              flattenedIndex += index * "+f+";\n            }\n            if (flattenedIndex == coords[0]) {\n              sum += "+h+";\n              found = true;\n            }\n          }\n          setOutput(mix(getDefaultValue(), sum, float(found)));\n        }\n      "},uo=function(t,e){this.variableNames=["x","segmentIds"];var n=t.windowSize,r=t.batchSize,i=t.inSize,a=t.numSegments,o=a*Math.ceil(i/n);this.outputShape=[r,o];var s=4*Math.floor(n/4),u=n%4,l="\n        sumValue += dot(values, segFilter);\n    ",c="";i%n>0&&(c="\n        if (inIdx < 0 || inIdx >= "+i+") {\n          return initializationValue;\n        }\n      ");var p="";i%n>0&&(p="\n        if (inIdx < 0 || inIdx >= "+i+") {\n          return -1.0;\n        }\n      "),this.userCode="\n      const float initializationValue = 0.0;\n\n      float getValue(int batch, int inIdx) {\n        "+c+"\n        return getX(batch, inIdx);\n      }\n\n      float getSegmentIdAtIndex(int inIdx) {\n        "+p+"\n        return getSegmentIds(inIdx);\n      }\n\n      void main() {\n        ivec2 coords = getOutputCoords();\n        int batch = coords[0];\n        int outIdx = coords[1];\n        int inOffset = int(floor(float(outIdx) / float(\n          "+a+")) * float("+n+"));\n        int currentSeg = int(mod(float(outIdx), float("+a+")));\n\n        float sumValue = 0.0;\n\n        for (int i = 0; i < "+s+"; i += 4) {\n          int inIdx = inOffset + i;\n          vec4 values = vec4(\n            getValue(batch, inIdx),\n            getValue(batch, inIdx + 1),\n            getValue(batch, inIdx + 2),\n            getValue(batch, inIdx + 3)\n          );\n\n          vec4 segFilter = vec4(\n            int(getSegmentIdAtIndex(inIdx)) == currentSeg ? 1 : 0,\n            int(getSegmentIdAtIndex(inIdx + 1)) == currentSeg ? 1 : 0,\n            int(getSegmentIdAtIndex(inIdx + 2)) == currentSeg ? 1 : 0,\n            int(getSegmentIdAtIndex(inIdx + 3)) == currentSeg ? 1 : 0\n          );\n\n          "+l+"\n        }\n\n        int inIdx = inOffset + "+s+";\n        if ("+(1===u)+") {\n          vec4 values = vec4(\n            getValue(batch, inIdx),\n            initializationValue,\n            initializationValue,\n            initializationValue\n          );\n\n          int inIdxSeg = int(getSegmentIdAtIndex(inIdx));\n\n          vec4 segFilter = vec4(\n            int(getSegmentIdAtIndex(inIdx)) == currentSeg ? 1 : 0,\n            0,\n            0,\n            0\n          );\n\n          "+l+"\n        } else if ("+(2===u)+") {\n          vec4 values = vec4(\n            getValue(batch, inIdx),\n            getValue(batch, inIdx + 1),\n            initializationValue,\n            initializationValue\n          );\n\n          vec4 segFilter = vec4(\n            int(getSegmentIdAtIndex(inIdx)) == currentSeg ? 1 : 0,\n            int(getSegmentIdAtIndex(inIdx + 1)) == currentSeg ? 1 : 0,\n              0,\n              0\n          );\n\n          "+l+"\n        } else if ("+(3===u)+") {\n          vec4 values = vec4(\n            getValue(batch, inIdx),\n            getValue(batch, inIdx + 1),\n            getValue(batch, inIdx + 2),\n            initializationValue\n          );\n\n          vec4 segFilter = vec4(\n            int(getSegmentIdAtIndex(inIdx)) == currentSeg ? 1 : 0,\n            int(getSegmentIdAtIndex(inIdx + 1)) == currentSeg ? 1 : 0,\n            int(getSegmentIdAtIndex(inIdx + 2)) == currentSeg ? 1 : 0,\n            0\n          );\n\n          "+l+"\n        }\n        setOutput(sumValue);\n      }\n    "},lo=function(t,e,n){var r,i;if(this.variableNames=["c","a","b"],this.outputShape=e,n>4)throw Error("Where for rank "+n+" is not yet supported");if(1===n)i="resRC",r="resRC";else{for(var a=["resRC.x","resRC.y","resRC.z","resRC.w"],o=[],s=[],u=0;u<e.length;u++)s.push(""+a[u]),u<t&&o.push(""+a[u]);r=o.join(),i=s.join()}var l=Ei(n);this.userCode="\n      void main() {\n        "+l+" resRC = getOutputCoords();\n        float cVal = getC("+r+");\n        if (cVal >= 1.0) {\n          setOutput(getA("+i+"));\n        } else {\n          setOutput(getB("+i+"));\n        }\n      }\n    "},co=function(){function t(t){this.variableNames=["source"],this.outputShape=t,this.rank=t.length;var e,n=Ei(this.rank),r="uniform int start["+this.rank+"];",i=function(t){if(1===t)return"sourceLoc";if(t<=6)return po.slice(0,t).map(function(t){return"sourceLoc."+t}).join(",");throw Error("Slicing for rank "+t+" is not yet supported")}(this.rank);e="\n        "+n+" sourceLoc;\n        "+n+" coords = getOutputCoords();\n        "+t.map(function(t,e){return"sourceLoc."+po[e]+" = start["+e+"] + coords."+po[e]+";"}).join("\n")+"\n      ",this.userCode="\n      "+r+"\n      void main() {\n        "+e+"\n        setOutput(getSource("+i+"));\n      }\n    "}return t.prototype.getCustomSetupFunc=function(t){var e=this;if(t.length!==this.rank)throw Error("The rank ("+this.rank+") of the program must match the length of start ("+t.length+")");return function(n,r){null==e.startLoc&&(e.startLoc=n.getUniformLocationNoThrow(r,"start"),null==e.startLoc)||n.gl.uniform1iv(e.startLoc,t)}},t}(),po=["x","y","z","w","u","v"],ho=function(){function t(t){this.variableNames=["source"],this.usesPackedTextures=!0,this.outputShape=t,this.rank=t.length;var e=Ei(this.rank),n=hi("coords",this.rank),r=hi("sourceLoc",this.rank),i=1===this.rank?"sourceLoc":"vec2("+r.slice(-2).join()+")",a="getChannel(getSource("+r.join()+"), "+i+")",o="\n      result.x = "+a+";\n      if (++"+n[this.rank-1]+" < "+t[this.rank-1]+") {\n        ++"+r[this.rank-1]+";\n        result.y = "+a+";\n        --"+r[this.rank-1]+";\n      }\n    ",s=1===this.rank?"":"\n      --"+n[this.rank-1]+";\n      if (++"+n[this.rank-2]+" < "+t[this.rank-2]+") {\n        ++"+r[this.rank-2]+";\n        result.z = "+a+";\n        if (++"+n[this.rank-1]+" < "+t[this.rank-1]+") {\n          ++"+r[this.rank-1]+";\n          result.w = "+a+";\n        }\n      }\n    ",u=this.rank<=4?"sourceLoc = coords +\n            "+e+"("+t.map(function(t,e){return"start["+e+"]"}).join()+");":t.map(function(t,e){return r[e]+" = "+n[e]+" + start["+e+"];"}).join("\n");this.userCode="\n      uniform int start["+this.rank+"];\n      void main() {\n        "+e+" coords = getOutputCoords();\n        "+e+" sourceLoc;\n        "+u+" \n        vec4 result = vec4(0.);\n        "+o+"\n        "+s+"\n        setOutput(result);\n      }\n    "}return t.prototype.getCustomSetupFunc=function(t){var e=this;if(t.length!==this.rank)throw Error("The rank ("+this.rank+") of the program must match the length of start ("+t.length+")");return function(n,r){null==e.startLoc&&(e.startLoc=n.getUniformLocationNoThrow(r,"start"),null==e.startLoc)||n.gl.uniform1iv(e.startLoc,t)}},t}(),fo=function(t,e,n,r){this.variableNames=["x"];var i=n.filter(function(t,e){return-1===r.indexOf(e)});this.outputShape=i;var a=n.length,o=Ei(n.length),s=Ei(i.length),u="";if(1===a)u="coords * strides + begin";else{var l=0;u=n.map(function(t,e){return-1===r.indexOf(e)?(l++,1===i.length?"coords * strides["+e+"] + begin["+e+"]":"coords["+(l-1)+"] * strides["+e+"] + begin["+e+"]"):"begin["+e+"]"}).join(",")}this.userCode="\n      "+o+" begin = "+o+"("+t+");\n      "+o+" strides = "+o+"("+e+");\n\n      void main() {\n        "+s+" coords = getOutputCoords();\n        setOutput(getX("+u+"));\n      }\n    "},mo=function(){function t(t){this.gpgpu=t,this.numUsedTextures=0,this.numFreeTextures=0,this.freeTextures={},this.logEnabled=!1,this.usedTextures={}}return t.prototype.acquireTexture=function(t,e,n){var r,i=go(e,n),a=vo(t,i,n);if(a in this.freeTextures||(this.freeTextures[a]=[]),a in this.usedTextures||(this.usedTextures[a]=[]),this.freeTextures[a].length>0){this.numFreeTextures--,this.numUsedTextures++,this.log();var o=this.freeTextures[a].shift();return this.usedTextures[a].push(o),o}return this.numUsedTextures++,this.log(),i===Tt.PACKED_2X2_FLOAT32?r=this.gpgpu.createPackedMatrixTexture(t[0],t[1]):i===Tt.PACKED_2X2_FLOAT16?r=this.gpgpu.createFloat16PackedMatrixTexture(t[0],t[1]):i===Tt.UNPACKED_FLOAT32?r=this.gpgpu.createFloat32MatrixTexture(t[0],t[1]):i===Tt.UNPACKED_FLOAT16?r=this.gpgpu.createFloat16MatrixTexture(t[0],t[1]):i===Tt.PACKED_4X1_UNSIGNED_BYTE&&(r=this.gpgpu.createUnsignedBytesMatrixTexture(t[0],t[1])),this.usedTextures[a].push(r),r},t.prototype.releaseTexture=function(t,e,n,r){if(null!=this.freeTextures){var i=vo(e,go(n,r),r);i in this.freeTextures||(this.freeTextures[i]=[]),this.freeTextures[i].push(t),this.numFreeTextures++,this.numUsedTextures--;var a=this.usedTextures[i],o=a.indexOf(t);if(o<0)throw new Error("Cannot release a texture that was never provided by this texture manager");a.splice(o,1),this.log()}},t.prototype.log=function(){if(this.logEnabled){var t=this.numFreeTextures+this.numUsedTextures;console.log("Free/Used",this.numFreeTextures+" / "+this.numUsedTextures,"("+t+")")}},t.prototype.getNumUsedTextures=function(){return this.numUsedTextures},t.prototype.getNumFreeTextures=function(){return this.numFreeTextures},t.prototype.dispose=function(){var t=this;if(null!=this.freeTextures){for(var e in this.freeTextures)this.freeTextures[e].forEach(function(e){t.gpgpu.deleteMatrixTexture(e)});for(var e in this.usedTextures)this.usedTextures[e].forEach(function(e){t.gpgpu.deleteMatrixTexture(e)});this.freeTextures=null,this.usedTextures=null,this.numUsedTextures=0,this.numFreeTextures=0}},t}();function go(e,n){if(e===Rt.UPLOAD)return Tt.PACKED_2X2_FLOAT32;if(e===Rt.RENDER||null==e)return n?t.ENV.getBool("WEBGL_RENDER_FLOAT32_ENABLED")?Tt.PACKED_2X2_FLOAT32:Tt.PACKED_2X2_FLOAT16:t.ENV.getBool("WEBGL_RENDER_FLOAT32_ENABLED")?Tt.UNPACKED_FLOAT32:Tt.UNPACKED_FLOAT16;if(e===Rt.DOWNLOAD||e===Rt.PIXELS)return Tt.PACKED_4X1_UNSIGNED_BYTE;throw new Error("Unknown logical texture type "+e)}function vo(t,e,n){return t[0]+"_"+t[1]+"_"+e+"_"+n}var yo=function(t,e){this.variableNames=["A"];for(var n=new Array(t.length),r=0;r<n.length;r++)n[r]=t[r]*e[r];this.outputShape=n,this.rank=n.length;var i=Ei(this.rank),a=function(t){var e=t.length;if(e>5)throw Error("Tile for rank "+e+" is not yet supported");if(1===e)return"imod(resRC, "+t[0]+")";for(var n=["resRC.x","resRC.y","resRC.z","resRC.w","resRC.u"],r=[],i=0;i<t.length;i++)r.push("imod("+n[i]+", "+t[i]+")");return r.join()}(t);this.userCode="\n      void main() {\n        "+i+" resRC = getOutputCoords();\n        setOutput(getA("+a+"));\n      }\n    "},bo=function(t,e){this.variableNames=["A"];for(var n=new Array(t.length),r=0;r<n.length;r++)n[r]=t[e[r]];this.outputShape=n,this.rank=n.length;var i=Ei(this.rank),a=function(t){var e=t.length;if(e>6)throw Error("Transpose for rank "+e+" is not yet supported");for(var n=["resRC.x","resRC.y","resRC.z","resRC.w","resRC.u","resRC.v"],r=new Array(e),i=0;i<t.length;i++)r[t[i]]=n[i];return r.join()}(e);this.userCode="\n    void main() {\n      "+i+" resRC = getOutputCoords();\n      setOutput(getA("+a+"));\n    }\n    "},xo=function(t,e){this.variableNames=["A"],this.usesPackedTextures=!0;for(var n=new Array(t.length),r=0;r<n.length;r++)n[r]=t[e[r]];if(this.outputShape=n,this.rank=n.length,this.rank>6)throw Error("Packed transpose for rank "+this.rank+" is not yet supported.");var i=Ei(this.rank),a=pi("rc",this.rank),o=new Array(this.rank);for(r=0;r<e.length;r++)o[e[r]]=a[r];var s="vec2("+o.slice(-2).join()+")",u="++"+a[this.rank-1]+" < "+n[this.rank-1],l="getChannel(getA("+o.join()+"), "+s+")";this.userCode="\n    void main() {\n      "+i+" rc = getOutputCoords();\n      vec4 result = vec4(0.);\n      result[0] = "+l+";\n      if("+u+") {\n        result[1] = "+l+";\n      }\n      --"+a[this.rank-1]+";\n      if(++"+a[this.rank-2]+" < "+n[this.rank-2]+") {\n        result[2] = "+l+";\n        if("+u+") {\n          result[3] = "+l+";\n        }\n      }  \n      setOutput(result);\n    }\n    "},wo=1.7580993408473768,No=1.0507009873554805,Co=function(t,e){this.variableNames=["A"],this.outputShape=t,this.userCode="\n      float unaryOperation(float x) {\n        "+e+"\n      }\n\n      void main() {\n        float x = getAAtOutCoords();\n        float y = unaryOperation(x);\n\n        setOutput(y);\n      }\n    "},Eo="if (isnan(x)) return x;",So="return x;",ko=Eo+"\n  return (x < 0.0) ? 0.0 : x;\n",Io="return exp(x);",Ao="return x;",Ro="\n  vec4 result = x * vec4(greaterThanEqual(x, vec4(0.0)));\n  bvec4 isNaN = isnan(x);\n\n  result.r = isNaN.r ? x.r : result.r;\n  result.g = isNaN.g ? x.g : result.g;\n  result.b = isNaN.b ? x.b : result.b;\n  result.a = isNaN.a ? x.a : result.a;\n\n  return result;\n",To=function(t,e){this.variableNames=["A"],this.usesPackedTextures=!0,this.outputShape=t,this.userCode="\n      vec4 unaryOperation(vec4 x) {\n        "+e+"\n      }\n\n      void main() {\n        vec4 x = getAAtOutCoords();\n        vec4 y = unaryOperation(x);\n\n        setOutput(y);\n      }\n    "},Do=function(t){this.variableNames=["A"],this.usesPackedTextures=!0,this.outputShape=t;var e=t.length,n=hi("rc",e),r=Ei(e),i=function(t,e){if(1===t)return"rc";for(var n="",r=0;r<t;r++)n+=e[r],r<t-1&&(n+=",");return n}(e,n),a=n.slice(-2),o=e<=1?"rc":"vec2("+a.join(",")+")";this.userCode="\n      void main() {\n        "+r+" rc = getOutputCoords();\n        vec4 packedInput = getA("+i+");\n\n        setOutput(getChannel(packedInput, "+o+"));\n      }\n    "},Oo={};function _o(t,e){if(void 0===e&&(e=!1),"linear"===t)return e?Ao:So;if("relu"===t)return e?Ro:ko;if("prelu"===t)return e?Pi:zi;throw new Error("Activation "+t+" has not been implemented for the WebGL backend.")}var Fo=600,Mo=function(){function e(e){if(this.gpgpu=e,this.pendingRead=new WeakMap,this.pendingDisposal=new WeakSet,this.dataRefCount=new WeakMap,this.numBytesInGPU=0,this.uploadWaitMs=0,this.downloadWaitMs=0,this.warnedAboutMemory=!1,this.disposed=!1,!t.ENV.getBool("HAS_WEBGL"))throw new Error("WebGL is not supported on this device");if(null==e){var n=Ft(t.ENV.getNumber("WEBGL_VERSION"));this.binaryCache=(r=t.ENV.getNumber("WEBGL_VERSION"))in Oo?Oo[r]:(Oo[r]={},Oo[r]),this.gpgpu=new za(n),this.canvas=n.canvas,this.gpgpuCreatedLocally=!0}else this.binaryCache={},this.gpgpuCreatedLocally=!1,this.canvas=e.gl.canvas;var r;this.textureManager=new mo(this.gpgpu),this.numMBBeforeWarning=null==t.ENV.global.screen?1024:t.ENV.global.screen.height*t.ENV.global.screen.width*window.devicePixelRatio*Fo/1024/1024,this.texData=new Dr(this,It)}return e.prototype.register=function(t,e,n){if(this.texData.has(t))throw new Error("Data buffer is already registered");this.texData.set(t,{shape:e,dtype:n})},e.prototype.fromPixels=function(e,n){if(null==e)throw new Error("pixels passed to tf.browser.fromPixels() can not be null");var r=[e.height,e.width],i=[e.height,e.width,n],a="undefined"!=typeof OffscreenCanvas&&e instanceof OffscreenCanvas||"undefined"!=typeof HTMLCanvasElement&&e instanceof HTMLCanvasElement,o=e.data instanceof Uint8Array,s="undefined"!=typeof ImageData&&e instanceof ImageData,u="undefined"!=typeof HTMLVideoElement&&e instanceof HTMLVideoElement,l="undefined"!=typeof HTMLImageElement&&e instanceof HTMLImageElement;if(!(a||o||s||u||l))throw new Error("pixels passed to tf.browser.fromPixels() must be either an HTMLVideoElement, HTMLImageElement, HTMLCanvasElement, ImageData in browser, or OffscreenCanvas, ImageData in webworker or {data: Uint32Array, width: number, height: number}, but was "+e.constructor.name);if(l||u){if(null==this.fromPixels2DContext){if("complete"!==document.readyState)throw new Error("The DOM is not ready yet. Please call tf.browser.fromPixels() once the DOM is ready. One way to do that is to add an event listener for `DOMContentLoaded` on the document object");this.fromPixels2DContext=Mt(t.ENV.getNumber("WEBGL_VERSION")).getContext("2d")}this.fromPixels2DContext.canvas.width=e.width,this.fromPixels2DContext.canvas.height=e.height,this.fromPixels2DContext.drawImage(e,0,0,e.width,e.height),e=this.fromPixels2DContext.canvas}var c,p,h=this.makeTensorHandle(r,"int32");if(this.texData.get(h.dataId).usage=Rt.PIXELS,this.gpgpu.uploadPixelDataToTexture(this.getTexture(h.dataId),e),t.ENV.getBool("WEBGL_PACK")){c=new ma(i);var f=this.makePackedTensor(c.outputShape,h.dtype);p=this.compileAndRun(c,[h],f)}else c=new da(i),p=this.compileAndRun(c,[h]);return this.disposeData(h.dataId),p},e.prototype.makeTensorHandle=function(t,e){var n={};return this.register(n,t,e),{dataId:n,shape:t,dtype:e}},e.prototype.write=function(e,n){if(null==n)throw new Error("MathBackendWebGL.write(): values can not be null");if(t.ENV.getBool("DEBUG"))for(var r=0;r<n.length;r++){var i=n[r];if(!jt(i))throw Error("The value "+i+" cannot be represented on this device.")}var a=this.texData.get(e);if("complex64"===a.dtype)throw new Error("Cannot write to a complex64 dtype. Please use tf.complex(real, imag).");this.releaseGPUData(e),a.usage=Rt.UPLOAD,a.values=n},e.prototype.readSync=function(t){var e=this.texData.get(t),n=e.values,r=e.dtype,i=e.complexTensors,a=e.slice,o=e.shape;if(null!=a){var s=new Co(o,"return x;"),u=this.compileAndRun(s,[{dataId:t,shape:o,dtype:r}]),l=this.readSync(u.dataId);return u.dispose(),l}if(null!=n)return this.convertAndCacheOnCPU(t);if("string"===r)return n;var c,p,h=null!=this.activeTimers;return h&&(c=K()),p="complex64"===r?Zr(i.real.dataSync(),i.imag.dataSync()):this.getValuesFromTexture(t),h&&(this.downloadWaitMs+=K()-c),this.convertAndCacheOnCPU(t,p)},e.prototype.read=function(e){return r(this,void 0,void 0,function(){var n,r,a,o,s,u,l,c,p,h,f,d,m,g,y,b,x,w,N,C,E;return i(this,function(i){switch(i.label){case 0:if(this.pendingRead.has(e))return r=this.pendingRead.get(e),[2,new Promise(function(t){return r.push(t)})];if(a=this.texData.get(e),o=a.values,s=a.shape,u=a.slice,l=a.dtype,c=a.complexTensors,null!=u)return p=new Co(s,"return x;"),h=this.compileAndRun(p,[{dataId:e,shape:s,dtype:l}]),f=this.read(h.dataId),h.dispose(),[2,f];if(null!=o)return[2,this.convertAndCacheOnCPU(e)];if(!t.ENV.getBool("WEBGL_DOWNLOAD_FLOAT_ENABLED")&&2===t.ENV.getNumber("WEBGL_VERSION"))throw new Error("tensor.data() with WEBGL_DOWNLOAD_FLOAT_ENABLED=false and WEBGL_VERSION=2 not yet supported.");return d=null,"complex64"!==l&&t.ENV.get("WEBGL_BUFFER_SUPPORTED")&&(m=this.decode(e),e=m.dataId,g=this.texData.get(m.dataId),d=(n=this.gpgpu).createBufferFromTexture.apply(n,[g.texture].concat(Lt(s)))),this.pendingRead.set(e,[]),"complex64"===l?[3,2]:[4,this.gpgpu.createAndWaitForFence()];case 1:i.sent(),i.label=2;case 2:return"complex64"!==l?[3,4]:[4,Promise.all([c.real.data(),c.imag.data()])];case 3:return b=i.sent(),x=b[0],w=b[1],y=Zr(x,w),[3,5];case 4:null==d?y=this.getValuesFromTexture(e):(N=v(s),y=this.gpgpu.downloadFloat32MatrixFromBuffer(d,N),this.disposeData(e)),i.label=5;case 5:return C=this.convertAndCacheOnCPU(e,y),E=this.pendingRead.get(e),this.pendingRead.delete(e),E.forEach(function(t){return t(C)}),this.pendingDisposal.has(e)&&(this.pendingDisposal.delete(e),this.disposeData(e)),[2,C]}})})},e.prototype.getValuesFromTexture=function(e){var n,r=this,i=this.texData.get(e),a=i.shape,o=i.dtype,s=i.isPacked,u=v(a);if(t.ENV.getBool("WEBGL_DOWNLOAD_FLOAT_ENABLED")){var l=this.decode(e),c=this.texData.get(l.dataId),p=(n=this.gpgpu).downloadMatrixFromPackedTexture.apply(n,[c.texture].concat(Lt(a))).subarray(0,u);return this.disposeData(l.dataId),p}var h=t.ENV.getBool("WEBGL_PACK")&&!0===s,f=h?ye(a):a,d=this.makeTensorHandle(f,"float32");d.size=v(a),this.texData.get(d.dataId).usage=Rt.DOWNLOAD;var m=Fe(function(){var t=h?new la(f):new ua(f);return r.compileAndRun(t,[{shape:f,dtype:o,dataId:e}],d,null)}),g=this.texData.get(m.dataId),y=this.gpgpu.downloadByteEncodedFloatMatrixFromOutputTexture(g.texture,g.texShape[0],g.texShape[1]).subarray(0,u);return this.disposeData(d.dataId),y},e.prototype.time=function(t){return r(this,void 0,void 0,function(){var e,n,r,a,o,s,u;return i(this,function(i){switch(i.label){case 0:return e=this.activeTimers,n=[],r=!1,null==this.programTimersStack?(this.programTimersStack=n,r=!0):this.activeTimers.push(n),this.activeTimers=n,t(),a=g(this.activeTimers.map(function(t){return t.query})).filter(function(t){return null!=t}),o=g(this.activeTimers.map(function(t){return t.name})).filter(function(t){return null!=t}),this.activeTimers=e,r&&(this.programTimersStack=null),[4,Promise.all(a)];case 1:return s=i.sent(),u={uploadWaitMs:this.uploadWaitMs,downloadWaitMs:this.downloadWaitMs,kernelMs:h(s),getExtraProfileInfo:function(){return s.map(function(t,e){return{name:o[e],ms:t}}).map(function(t){return t.name+": "+t.ms}).join(", ")},wallMs:null},this.uploadWaitMs=0,this.downloadWaitMs=0,[2,u]}})})},e.prototype.memory=function(){return{unreliable:!1,numBytesInGPU:this.numBytesInGPU}},e.prototype.startTimer=function(){return t.ENV.getNumber("WEBGL_DISJOINT_QUERY_TIMER_EXTENSION_VERSION")>0?this.gpgpu.beginQuery():{startMs:K(),endMs:null}},e.prototype.endTimer=function(e){return t.ENV.getNumber("WEBGL_DISJOINT_QUERY_TIMER_EXTENSION_VERSION")>0?(this.gpgpu.endQuery(),e):(e.endMs=K(),e)},e.prototype.getQueryTime=function(e){return r(this,void 0,void 0,function(){var n;return i(this,function(r){return t.ENV.getNumber("WEBGL_DISJOINT_QUERY_TIMER_EXTENSION_VERSION")>0?[2,this.gpgpu.waitForQueryAndGetTime(e)]:[2,(n=e).endMs-n.startMs]})})},e.prototype.disposeData=function(t){if(!this.pendingDisposal.has(t))if(this.pendingRead.has(t))this.pendingDisposal.add(t);else if(this.texData.has(t)){this.releaseGPUData(t);var e=this.texData.get(t).complexTensors;null!=e&&(e.real.dispose(),e.imag.dispose()),this.texData.delete(t)}},e.prototype.releaseGPUData=function(t){var e=this.texData.get(t),n=e.texture,r=e.dtype,i=e.texShape,a=e.usage,o=e.isPacked,s=e.slice,u=s&&s.origDataId||t,l=this.dataRefCount.get(u);l>1?this.dataRefCount.set(u,l-1):(this.dataRefCount.delete(u),null!=n&&(this.numBytesInGPU-=this.computeBytes(i,r),this.textureManager.releaseTexture(n,i,a,o)));var c=this.texData.get(t);c.texture=null,c.texShape=null,c.isPacked=!1,c.slice=null},e.prototype.getTexture=function(t){return this.uploadToGPU(t),this.texData.get(t).texture},e.prototype.getCPUBackend=function(){return t.ENV.getBool("WEBGL_CPU_FORWARD")?(null==this.cpuBackend&&(this.cpuBackend=It.findBackend("cpu")),this.cpuBackend):null},e.prototype.shouldExecuteOnCPU=function(t,e){var n=this;return void 0===e&&(e=128),null!=this.getCPUBackend()&&t.every(function(t){return null==n.texData.get(t.dataId).texture&&t.size<e})},e.prototype.getGPGPUContext=function(){return this.gpgpu},e.prototype.complex=function(t,e){var n=this.makeOutputArray(t.shape,"complex64");return this.texData.get(n.dataId).complexTensors={real:It.keep(t.clone()),imag:It.keep(e.clone())},n},e.prototype.real=function(t){return this.texData.get(t.dataId).complexTensors.real.clone()},e.prototype.imag=function(t){return this.texData.get(t.dataId).complexTensors.imag.clone()},e.prototype.slice=function(e,n,r){if(this.shouldExecuteOnCPU([e]))return this.cpuBackend.slice(e,n,r);if(0===v(r))return rn([],r,e.dtype);var i=this.texData.get(e.dataId).isPacked,a=Er(e.shape,n,r);if(i||!a){var o=t.ENV.getBool("WEBGL_PACK_ARRAY_OPERATIONS")?new ho(r):new co(r),s=o.getCustomSetupFunc(n);return this.compileAndRun(o,[e],null,s)}return this.uploadToGPU(e.dataId),this.shallowSlice(e,n,r)},e.prototype.shallowSlice=function(t,e,n){var r=this.texData.get(t.dataId),i=ct.make(n,{},t.dtype,this),a=this.texData.get(i.dataId);Object.assign(a,r),a.shape=n,a.dtype=t.dtype;var o=Sr(e,t.strides);r.slice&&(o+=r.slice.flatOffset),a.slice={flatOffset:o,origDataId:r.slice&&r.slice.origDataId||t.dataId};var s=this.dataRefCount.get(a.slice.origDataId)||1;return this.dataRefCount.set(a.slice.origDataId,s+1),i},e.prototype.stridedSlice=function(t,e,n,r,i,a,o,s,u){if(this.shouldExecuteOnCPU([t]))return this.cpuBackend.stridedSlice(t,e,n,r,i,a,o,s,u);var l=wr(t.shape,e,n,r,i,a,o,s,u),c=l[0],p=l[1],h=l[2],f=p.filter(function(t,e){return-1===h.indexOf(e)});if(f.some(function(t){return 0===t}))return rn([],f);var d=new fo(c,r,p,h);return this.compileAndRun(d,[t])},e.prototype.reverse=function(e,n){var r=t.ENV.getBool("WEBGL_PACK_ARRAY_OPERATIONS")?new oo(e.shape,n):new ao(e.shape,n);return this.compileAndRun(r,[e])},e.prototype.concat=function(e,n){if("complex64"===e[0].dtype){var r=e.map(function(t){return en(t)}),i=e.map(function(t){return nn(t)});return tn(this.concat(r,n),this.concat(i,n))}if(this.shouldExecuteOnCPU(e))return this.cpuBackend.concat(e,n);if(1===e.length)return e[0];if(e.length>t.ENV.getNumber("WEBGL_MAX_TEXTURES_IN_SHADER")){var a=Math.floor(e.length/2),o=this.concat(e.slice(0,a),n),s=this.concat(e.slice(a),n);return this.concat([o,s],n)}if(t.ENV.getBool("WEBGL_PACK_ARRAY_OPERATIONS")&&e[0].rank>1){var u=new qi(e.map(function(t){return t.shape}),n);return this.compileAndRun(u,e)}var l=Ze(e.map(function(t){return t.shape}),n),c=e.map(function(t){return t.as2D(-1,v(t.shape.slice(n)))}),p=new ji(c.map(function(t){return t.shape}));return this.compileAndRun(p,c).reshape(l)},e.prototype.neg=function(t){var e=new Co(t.shape,"return -x;");return this.compileAndRun(e,[t])},e.prototype.batchMatMul=function(t,e,n,r){var i=n?t.shape[2]:t.shape[1],a=r?e.shape[1]:e.shape[2],o=n?t.shape[1]:t.shape[2],s=t.shape[0];if((1===i||1===a)&&o>1e3){n&&(t=t.transpose([0,2,1])),r&&(e=e.transpose([0,2,1]));var u=1===a?t:t.as3D(s,o,1),l=1===a?2:1,c=1===a?e.as3D(s,1,o):e;return this.multiply(u,c).sum(l,!0)}var p=yt(t.dtype,e.dtype),h=new qa(t.shape,[s,i,a],n,r),f=this.makePackedTensor(h.outputShape,p);return this.compileAndRun(h,[t,e],f)},e.prototype.fusedBatchMatMul=function(t){var e=t.a,n=t.b,r=t.transposeA,i=t.transposeB,a=t.bias,o=t.activation,s=t.preluActivationWeights,u=r?e.shape[2]:e.shape[1],l=i?n.shape[1]:n.shape[2],c=e.shape[0],p=yt(e.dtype,n.dtype),h=null!=a,f=null!=s,d=o?_o(o,!0):null,m=new qa(e.shape,[c,u,l],r,i,h,d,f),g=this.makePackedTensor(m.outputShape,p),v=[e,n];return a&&v.push(a),s&&v.push(s),this.compileAndRun(m,v,g)},e.prototype.multiply=function(e,n){if("complex64"===e.dtype){var r=this.texData.get(e.dataId),i=this.texData.get(n.dataId),a=new Oi("return areal * breal - aimag * bimag;",e.shape,n.shape),o=new Oi("return areal * bimag + aimag * breal;",e.shape,n.shape),s=[this.makeComplexComponentTensorHandle(e,r.complexTensors.real),this.makeComplexComponentTensorHandle(e,r.complexTensors.imag),this.makeComplexComponentTensorHandle(n,i.complexTensors.real),this.makeComplexComponentTensorHandle(n,i.complexTensors.imag)],u=this.compileAndRun(a,s),l=this.compileAndRun(o,s),c=this.complex(u,l);return u.dispose(),l.dispose(),c}if(this.shouldExecuteOnCPU([e,n]))return this.cpuBackend.multiply(e,n);if(t.ENV.getBool("WEBGL_PACK_BINARY_OPERATIONS"))return this.packedBinaryOp(e,n,Mi,e.dtype);var p=new Li(Mi,e.shape,n.shape),h=this.makeOutputArray(p.outputShape,e.dtype);return this.compileAndRun(p,[e,n],h)},e.prototype.batchNormalization=function(e,n,r,i,a,o){var s=[e,n,r],u=null;null!=o&&(u=o.shape,s.push(o));var l=null;if(null!=a&&(l=a.shape,s.push(a)),t.ENV.getBool("WEBGL_PACK_NORMALIZATION")){var c=new Di(e.shape,n.shape,r.shape,u,l,i);return this.compileAndRun(c,s)}var p=new Ti(e.shape,n.shape,r.shape,u,l,i);return this.compileAndRun(p,s)},e.prototype.localResponseNormalization4D=function(e,n,r,i,a){var o=t.ENV.getBool("WEBGL_PACK_NORMALIZATION")?new Wa(e.shape,n,r,i,a):new Ba(e.shape,n,r,i,a);return this.compileAndRun(o,[e])},e.prototype.LRNGrad=function(t,e,n,r,i,a,o){var s=new Va(e.shape,r,i,a,o);return this.compileAndRun(s,[e,n,t])},e.prototype.tile=function(t,e){if("string"===t.dtype){var n=this.readSync(t.dataId).map(function(t){return Y(t)});return ai(Pn(t.shape,t.dtype,n),e)}var r=new yo(t.shape,e);return this.compileAndRun(r,[t])},e.prototype.pad=function(e,n,r){var i=t.ENV.getBool("WEBGL_PACK_ARRAY_OPERATIONS")?new Xa(e.shape,n,r):new $a(e.shape,n,r);return this.compileAndRun(i,[e])},e.prototype.transpose=function(e,n){if(this.shouldExecuteOnCPU([e]))return this.cpuBackend.transpose(e,n);var r=t.ENV.getBool("WEBGL_PACK_ARRAY_OPERATIONS")?new xo(e.shape,n):new bo(e.shape,n);return this.compileAndRun(r,[e])},e.prototype.gather=function(t,e,n){if(this.shouldExecuteOnCPU([t,e]))return this.cpuBackend.gather(t,e,n);var r=new ga(t.shape,e.size,n);return this.compileAndRun(r,[t,e])},e.prototype.batchToSpaceND=function(t,e,n){f(t.rank<=4,function(){return"batchToSpaceND for rank > 4 with a WebGL backend not implemented yet"});var r=e.reduce(function(t,e){return t*e}),i=hr(t.shape,e,r),a=fr(i.length,e.length),o=dr(t.shape,e,r),s=mr(n,e.length),u=gr(o,n,e.length);return t.reshape(i).transpose(a).reshape(o).slice(s,u)},e.prototype.spaceToBatchND=function(t,e,n){f(t.rank<=4,function(){return"spaceToBatchND for rank > 4 with a WebGL backend not implemented yet"});var r=e.reduce(function(t,e){return t*e}),i=[[0,0]];i.push.apply(i,n);for(var a=1+e.length;a<t.shape.length;++a)i.push([0,0]);var o=t.pad(i),s=hr(o.shape,e,r,!1),u=fr(s.length,e.length,!1),l=dr(o.shape,e,r,!1);return o.reshape(s).transpose(u).reshape(l)},e.prototype.reduce=function(t,e,n){var r=t.shape[0],i=t.shape[1],a=br(i),o=new Za({windowSize:a,inSize:i,batchSize:r},e),s=o.outputShape,u=s[0],l=s[1],c=this.makeOutputArray([u,l],n);return this.compileAndRun(o,[t],c),1===c.shape[1]?c:this.reduce(c,e,n)},e.prototype.argReduce=function(t,e,n){void 0===n&&(n=null);var r=t.shape[0],i=t.shape[1];null!=n&&(r=n.shape[0],i=n.shape[1]);var a=br(i),o=new ci({windowSize:a,inSize:i,batchSize:r},e,null==n),s=o.outputShape,u=s[0],l=s[1],c=this.makeOutputArray([u,l],"int32"),p=[t];return null!=n&&p.push(n),this.compileAndRun(o,p,c),1===c.shape[1]?c:this.argReduce(t,e,c)},e.prototype.argReducePacked=function(t,e,n){void 0===n&&(n=null);var r=null!=n?n.shape:t.shape,i=br(r[r.length-1]),a=new Ii(r,i,e,null==n),o=this.makePackedTensor(a.outputShape,"int32"),s=null==n?[t]:[t,n];return this.compileAndRun(a,s,o),o.rank===t.rank?this.argReducePacked(t,e,o):o},e.prototype.sum=function(t,e){Ke("sum",e,t.rank);var n=He(t.shape,e),r=n[0],i=v(n[1]),a=t.as2D(-1,i),o=bt(t.dtype);return this.reduce(a,"sum",o).reshape(r)},e.prototype.prod=function(t,e){if(this.shouldExecuteOnCPU([t]))return this.cpuBackend.prod(t,e);var n=He(t.shape,e),r=n[0],i=v(n[1]),a=t.as2D(-1,i),o=bt(t.dtype);return this.reduce(a,"prod",o).reshape(r)},e.prototype.unsortedSegmentSum=function(t,e,n){var r=0,i=$e([r],t.rank),a=t;null!=i&&(a=t.transpose(i),r=Ye(1,t.rank)[0]);var o=function(t,e,n){for(var r=[],i=t.length,a=0;a<i;a++)a!==e?r.push(t[a]):r.push(n);return r}(a.shape,r,n),s=v([a.shape[r]]),u=a.as2D(-1,s),l=bt(t.dtype),c=this.segOpCompute(u,"unsortedSegmentSum",e,l,n).reshape(o);return null!=i&&(c=c.transpose(Xe(i))),c},e.prototype.segOpCompute=function(t,e,n,r,i){var a=t.shape[0],o=t.shape[1],s=function(t,e){var n,r=!1;for(t<=yr?(n=t,r=!0):n=W(t,Math.floor(Math.sqrt(t)));!r;)n>e||n===t?r=!0:n=W(t,n+1);return n}(o,i),u=new uo({windowSize:s,inSize:o,batchSize:a,numSegments:i},e),l=u.outputShape,c=l[0],p=l[1],h=this.makeOutputArray([c,p],r);return this.compileAndRun(u,[t,n],h),h.shape[1]===i?h:(n=vn(0,i).tile([o/s]),this.segOpCompute(h,e,n,r,i))},e.prototype.argMinMaxReduce=function(e,n,r){var i=[n];if(Ke("arg"+r.charAt(0).toUpperCase()+r.slice(1),i,e.rank),!t.ENV.getBool("WEBGL_PACK_REDUCE")||e.rank<=2){var a=He(e.shape,i),o=a[0],s=v(a[1]),u=e.as2D(-1,s);return this.argReduce(u,r).reshape(o)}return this.argReducePacked(e,r)},e.prototype.argMin=function(t,e){return this.argMinMaxReduce(t,e,"min")},e.prototype.argMax=function(t,e){return this.argMinMaxReduce(t,e,"max")},e.prototype.cumsum=function(t,e,n,r){if(e!==t.rank-1)throw new Error("WebGL cumsum shader expects an inner-most axis="+(t.rank-1)+" but got axis="+e);var i=new na(t.shape,n,r);return this.compileAndRun(i,[t])},e.prototype.equal=function(e,n){if(t.ENV.getBool("WEBGL_PACK_BINARY_OPERATIONS"))return this.packedBinaryOp(e,n,"\n  return vec4(equal(a, b));\n","bool");var r=new Li("return float(a == b);",e.shape,n.shape),i=this.makeOutputArray(r.outputShape,"bool");return this.compileAndRun(r,[e,n],i)},e.prototype.notEqual=function(e,n){if(t.ENV.getBool("WEBGL_PACK_BINARY_OPERATIONS"))return this.packedBinaryOp(e,n,"\n  return vec4(notEqual(a, b));\n","bool");var r=new Li("return float(a != b);",e.shape,n.shape),i=this.makeOutputArray(r.outputShape,"bool");return this.compileAndRun(r,[e,n],i)},e.prototype.less=function(e,n){if(this.shouldExecuteOnCPU([e,n]))return this.cpuBackend.less(e,n);if(t.ENV.getBool("WEBGL_PACK_BINARY_OPERATIONS"))return this.packedBinaryOp(e,n,"\n  return vec4(lessThan(a, b));\n","bool");var r=new Li("return float(a < b);",e.shape,n.shape),i=this.makeOutputArray(r.outputShape,"bool");return this.compileAndRun(r,[e,n],i)},e.prototype.lessEqual=function(e,n){if(t.ENV.getBool("WEBGL_PACK_BINARY_OPERATIONS"))return this.packedBinaryOp(e,n,"\n  return vec4(lessThanEqual(a, b));\n","bool");var r=new Li("return float(a <= b);",e.shape,n.shape),i=this.makeOutputArray(r.outputShape,"bool");return this.compileAndRun(r,[e,n],i)},e.prototype.greater=function(e,n){if(this.shouldExecuteOnCPU([e,n]))return this.cpuBackend.greater(e,n);if(t.ENV.getBool("WEBGL_PACK_BINARY_OPERATIONS"))return this.packedBinaryOp(e,n,"\n  return vec4(greaterThan(a, b));\n","bool");var r=new Li("return float(a > b);",e.shape,n.shape),i=this.makeOutputArray(r.outputShape,"bool");return this.compileAndRun(r,[e,n],i)},e.prototype.greaterEqual=function(e,n){if(t.ENV.getBool("WEBGL_PACK_BINARY_OPERATIONS"))return this.packedBinaryOp(e,n,"\n  return vec4(greaterThanEqual(a, b));\n","bool");var r=new Li("return float(a >= b);",e.shape,n.shape),i=this.makeOutputArray(r.outputShape,"bool");return this.compileAndRun(r,[e,n],i)},e.prototype.logicalNot=function(t){var e=new Co(t.shape,"return float(!(x >= 1.0));");return this.compileAndRun(e,[t])},e.prototype.logicalAnd=function(e,n){if(t.ENV.getBool("WEBGL_PACK_BINARY_OPERATIONS"))return this.packedBinaryOp(e,n,"\n  return vec4(\n    vec4(greaterThanEqual(a, vec4(1.0))) *\n    vec4(greaterThanEqual(b, vec4(1.0))));\n","bool");var r=new Li("return float(a >= 1.0 && b >= 1.0);",e.shape,n.shape),i=this.makeOutputArray(r.outputShape,"bool");return this.compileAndRun(r,[e,n],i)},e.prototype.logicalOr=function(e,n){if(t.ENV.getBool("WEBGL_PACK_BINARY_OPERATIONS"))return this.packedBinaryOp(e,n,"\n  return min(\n    vec4(greaterThanEqual(a, vec4(1.0))) +\n    vec4(greaterThanEqual(b, vec4(1.0))),\n    vec4(1.0));\n","bool");var r=new Li("return float(a >= 1.0 || b >= 1.0);",e.shape,n.shape),i=this.makeOutputArray(r.outputShape,"bool");return this.compileAndRun(r,[e,n],i)},e.prototype.select=function(t,e,n){var r=new lo(t.rank,e.shape,e.rank),i=this.makeOutputArray(r.outputShape,yt(e.dtype,n.dtype));return this.compileAndRun(r,[t,e,n],i)},e.prototype.where=function(t){Pe("tf.where() in webgl locks the UI thread. Call tf.whereAsync() instead");var e=t.dataSync();return si(t.shape,e)},e.prototype.topk=function(t,e,n){return oi(t.dataSync(),t.shape,t.dtype,e)},e.prototype.min=function(t,e){Ke("min",e,t.rank);var n=He(t.shape,e),r=n[0],i=v(n[1]),a=t.as2D(-1,i);return this.reduce(a,"min",a.dtype).reshape(r)},e.prototype.minimum=function(e,n){if(this.shouldExecuteOnCPU([e,n]))return this.cpuBackend.minimum(e,n);var r=t.ENV.getBool("WEBGL_PACK_BINARY_OPERATIONS")?new Bi("\n  vec4 result = vec4(min(a, b));\n  vec4 isNaN = min(vec4(isnan(a)) + vec4(isnan(b)), vec4(1.0));\n  \n  result.r = isNaN.r > 0. ? NAN : result.r;\n  result.g = isNaN.g > 0. ? NAN : result.g;\n  result.b = isNaN.b > 0. ? NAN : result.b;\n  result.a = isNaN.a > 0. ? NAN : result.a;\n\n  return result;\n",e.shape,n.shape):new Li("\n  if (isnan(a)) return a;\n  if (isnan(b)) return b;\n\n  return min(a, b);\n",e.shape,n.shape);return this.compileAndRun(r,[e,n])},e.prototype.mod=function(e,n){var r=t.ENV.getBool("WEBGL_PACK_BINARY_OPERATIONS")?new Bi("\n  vec4 result = mod(a, b);\n  vec4 isNaN = vec4(equal(b, vec4(0.0)));\n  \n  result.r = isNaN.r > 0. ? NAN : result.r;\n  result.g = isNaN.g > 0. ? NAN : result.g;\n  result.b = isNaN.b > 0. ? NAN : result.b;\n  result.a = isNaN.a > 0. ? NAN : result.a;\n\n  return result;\n",e.shape,n.shape):new Li("if (b == 0.0) return NAN;\n  return mod(a, b);",e.shape,n.shape);return this.compileAndRun(r,[e,n])},e.prototype.max=function(t,e){if(this.shouldExecuteOnCPU([t]))return this.cpuBackend.max(t,e);Ke("max",e,t.rank);var n=He(t.shape,e),r=n[0],i=v(n[1]),a=t.as2D(-1,i);return this.reduce(a,"max",a.dtype).reshape(r)},e.prototype.maximum=function(e,n){if(this.shouldExecuteOnCPU([e,n]))return this.cpuBackend.maximum(e,n);var r=t.ENV.getBool("WEBGL_PACK_BINARY_OPERATIONS")?new Bi("\n  vec4 result = vec4(max(a, b));\n  vec4 isNaN = min(vec4(isnan(a)) + vec4(isnan(b)), vec4(1.0));\n  \n  result.r = isNaN.r > 0. ? NAN : result.r;\n  result.g = isNaN.g > 0. ? NAN : result.g;\n  result.b = isNaN.b > 0. ? NAN : result.b;\n  result.a = isNaN.a > 0. ? NAN : result.a;\n\n  return result;\n",e.shape,n.shape):new Li("\n  if (isnan(a)) return a;\n  if (isnan(b)) return b;\n\n  return max(a, b);\n",e.shape,n.shape);return this.compileAndRun(r,[e,n])},e.prototype.all=function(t,e){Ke("all",e,t.rank);var n=He(t.shape,e),r=n[0],i=v(n[1]),a=t.as2D(-1,i);return this.reduce(a,"all",a.dtype).reshape(r)},e.prototype.any=function(t,e){Ke("any",e,t.rank);var n=He(t.shape,e),r=n[0],i=v(n[1]),a=t.as2D(-1,i);return this.reduce(a,"any",a.dtype).reshape(r)},e.prototype.squaredDifference=function(e,n){var r=t.ENV.getBool("WEBGL_PACK_BINARY_OPERATIONS")?new Bi("return (a - b) * (a - b);",e.shape,n.shape):new Li("return (a - b) * (a - b);",e.shape,n.shape);return this.compileAndRun(r,[e,n])},e.prototype.realDivide=function(e,n){if(t.ENV.getBool("WEBGL_PACK_BINARY_OPERATIONS"))return this.packedBinaryOp(e,n,"\n  // vec4 one = vec4(equal(a, b));\n  // return one + (vec4(1.0) - one) * a / b;\n  vec4 result = a / b;\n  if(b.x == 0.0) {\n    result.x = NAN;\n  } else if(a.x == b.x) {\n    result.x = 1.;\n  }\n  if(b.y == 0.0) {\n    result.y = NAN;\n  } else if(a.y == b.y) {\n    result.y = 1.;\n  }\n  if(b.z == 0.0) {\n    result.z = NAN;\n  } else if(a.z == b.z) {\n    result.z = 1.;\n  }\n  if(b.w == 0.0) {\n    result.w = NAN;\n  } else if(a.w == b.w) {\n    result.w = 1.;\n  }\n\n  return result;\n","float32",!0);var r=new Li("\nif (b == 0.0) {\n  return NAN;\n}\nif (a == b) {\n  return 1.0;\n};\nreturn a / b;",e.shape,n.shape),i=this.makeOutputArray(r.outputShape,"float32");return this.compileAndRun(r,[e,n],i)},e.prototype.floorDiv=function(e,n){if(t.ENV.getBool("WEBGL_PACK_BINARY_OPERATIONS"))return this.packedBinaryOp(e,n,"\n  ivec4 ia = round(a);\n  ivec4 ib = round(b);\n  bvec4 cond = notEqual(ib, ivec4(0));\n  ivec4 result = ivec4(0);\n  vec4 s = sign(a) * sign(b);\n\n  // Windows (D3D) wants guaranteed non-zero int division at compile-time.\n  if (cond[0]) {\n    result[0] = idiv(ia[0], ib[0], s[0]);\n  }\n  if (cond[1]) {\n    result[1] = idiv(ia[1], ib[1], s[1]);\n  }\n  if (cond[2]) {\n    result[2] = idiv(ia[2], ib[2], s[2]);\n  }\n  if (cond[3]) {\n    result[3] = idiv(ia[3], ib[3], s[3]);\n  }\n  return vec4(result);\n","int32");var r=new Li("\n  float s = sign(a) * sign(b);\n  int ia = round(a);\n  int ib = round(b);\n  if (ib != 0) {\n    // Windows (D3D) wants guaranteed non-zero int division at compile-time.\n    return float(idiv(ia, ib, s));\n  } else {\n    return NAN;\n  }\n",e.shape,n.shape),i=this.makeOutputArray(r.outputShape,"int32");return this.compileAndRun(r,[e,n],i)},e.prototype.add=function(e,n){if("complex64"===e.dtype&&"complex64"===n.dtype)return this.complexSeparableBinaryOp(e,n,_i);if(this.shouldExecuteOnCPU([e,n]))return this.cpuBackend.add(e,n);var r=yt(e.dtype,n.dtype);if(t.ENV.getBool("WEBGL_PACK_BINARY_OPERATIONS"))return this.packedBinaryOp(e,n,_i,r);var i=new Li(_i,e.shape,n.shape),a=this.makeOutputArray(i.outputShape,r);return this.compileAndRun(i,[e,n],a)},e.prototype.packedBinaryOp=function(t,e,n,r,i){void 0===i&&(i=!1);var a=new Bi(n,t.shape,e.shape,i),o=this.makePackedTensor(a.outputShape,r);return this.compileAndRun(a,[t,e],o)},e.prototype.complexSeparableBinaryOp=function(t,e,n){var r=this,i=this.texData.get(t.dataId),a=this.texData.get(e.dataId),o=[[i.complexTensors.real,a.complexTensors.real],[i.complexTensors.imag,a.complexTensors.imag]].map(function(i){var a=i[0],o=i[1],s=r.makeComplexComponentTensorHandle(t,a),u=r.makeComplexComponentTensorHandle(e,o),l=new Li(n,t.shape,e.shape),c=r.makeOutputArray(l.outputShape,yt(a.dtype,o.dtype));return r.compileAndRun(l,[s,u],c)}),s=o[0],u=o[1],l=this.complex(s,u);return s.dispose(),u.dispose(),l},e.prototype.makeComplexComponentTensorHandle=function(t,e){return{dataId:e.dataId,dtype:e.dtype,shape:t.shape}},e.prototype.addN=function(e){if(1===e.length)return e[0];if(e.length>t.ENV.get("WEBGL_MAX_TEXTURES_IN_SHADER")){var n=Math.floor(e.length/2),r=this.addN(e.slice(0,n)),i=this.addN(e.slice(n));return this.addN([r,i])}var a=e.map(function(t){return t.dtype}).reduce(function(t,e){return yt(t,e)}),o=e.map(function(t){return t.shape}),s=t.ENV.getBool("WEBGL_PACK"),u=s?new li(e[0].shape,o):new ui(e[0].shape,o),l=s?this.makePackedTensor(u.outputShape,a):this.makeOutputArray(u.outputShape,a);return this.compileAndRun(u,e,l)},e.prototype.subtract=function(e,n){if("complex64"===e.dtype&&"complex64"===n.dtype)return this.complexSeparableBinaryOp(e,n,Fi);if(this.shouldExecuteOnCPU([e,n]))return this.cpuBackend.subtract(e,n);var r=yt(e.dtype,n.dtype);if(t.ENV.getBool("WEBGL_PACK_BINARY_OPERATIONS"))return this.packedBinaryOp(e,n,Fi,e.dtype);var i=new Li(Fi,e.shape,n.shape),a=this.makeOutputArray(i.outputShape,r);return this.compileAndRun(i,[e,n],a)},e.prototype.pow=function(e,n){var r=t.ENV.getBool("WEBGL_PACK_BINARY_OPERATIONS"),i=r?new Bi("\n  // isModRound1 has 1 for components with round(mod(b, 2.0)) == 1, 0 otherwise.\n  vec4 isModRound1 = vec4(equal(round(mod(b, 2.0)), ivec4(1)));\n  vec4 multiplier = sign(a) * isModRound1 + (vec4(1.0) - isModRound1);\n  vec4 result = multiplier * pow(abs(a), b);\n\n  // Ensure that a^0 = 1, including 0^0 = 1 as this correspond to TF and JS\n  bvec4 isExpZero = equal(b, vec4(0.0));\n  result.r = isExpZero.r ? 1.0 : result.r;\n  result.g = isExpZero.g ? 1.0 : result.g;\n  result.b = isExpZero.b ? 1.0 : result.b;\n  result.a = isExpZero.a ? 1.0 : result.a;\n\n  vec4 isNaN = vec4(lessThan(a, vec4(0.0))) * vec4(lessThan(floor(b), b));\n  \n  result.r = isNaN.r > 0. ? NAN : result.r;\n  result.g = isNaN.g > 0. ? NAN : result.g;\n  result.b = isNaN.b > 0. ? NAN : result.b;\n  result.a = isNaN.a > 0. ? NAN : result.a;\n\n  return result;\n",e.shape,n.shape):new Li("\nif(a < 0.0 && floor(b) < b){\n  return NAN;\n}\nif (b == 0.0) {\n  return 1.0;\n}\nreturn (round(mod(b, 2.0)) != 1) ?\n    pow(abs(a), b) : sign(a) * pow(abs(a), b);\n",e.shape,n.shape),a=yt(e.dtype,n.dtype),o=r?this.makePackedTensor(i.outputShape,a):this.makeOutputArray(i.outputShape,a);return this.compileAndRun(i,[e,n],o)},e.prototype.ceil=function(t){var e=new Co(t.shape,"return ceil(x);");return this.compileAndRun(e,[t])},e.prototype.floor=function(t){var e=new Co(t.shape,"return floor(x);");return this.compileAndRun(e,[t])},e.prototype.sign=function(t){var e=new Co(t.shape,"\n  if (isnan(x)) { return 0.0; }\n  return sign(x);\n");return this.compileAndRun(e,[t])},e.prototype.isNaN=function(t){var e=new Co(t.shape,"return float(isnan(x));"),n=this.makeOutputArray(e.outputShape,"bool");return this.compileAndRun(e,[t],n)},e.prototype.isInf=function(t){var e=new Co(t.shape,"return float(isinf(x));"),n=this.makeOutputArray(e.outputShape,"bool");return this.compileAndRun(e,[t],n)},e.prototype.isFinite=function(t){var e=new Co(t.shape,"return float(!isnan(x) && !isinf(x));"),n=this.makeOutputArray(e.outputShape,"bool");return this.compileAndRun(e,[t],n)},e.prototype.round=function(t){var e=new Co(t.shape,"\n  // OpenGL ES does not support round function.\n  // The algorithm is based on banker's rounding.\n  float base = floor(x);\n  if ((x - base) < 0.5) {\n    return floor(x);\n  } else if ((x - base) > 0.5) {\n    return ceil(x);\n  } else {\n    if (mod(base, 2.0) == 0.0) {\n      return base;\n    } else {\n      return base + 1.0;\n    }\n  }\n");return this.compileAndRun(e,[t])},e.prototype.exp=function(e){var n;return n=t.ENV.getBool("WEBGL_PACK")?new To(e.shape,Io):new Co(e.shape,Io),this.compileAndRun(n,[e])},e.prototype.expm1=function(t){var e=new Co(t.shape,"return exp(x) - 1.0;");return this.compileAndRun(e,[t])},e.prototype.log=function(e){var n;return n=t.ENV.getBool("WEBGL_PACK")?new To(e.shape,"\n  vec4 result = log(x);\n  vec4 isNaN = vec4(lessThan(x, vec4(0.0)));\n  result.r = isNaN.r == 1.0 ? NAN : result.r;\n  result.g = isNaN.g == 1.0 ? NAN : result.g;\n  result.b = isNaN.b == 1.0 ? NAN : result.b;\n  result.a = isNaN.a == 1.0 ? NAN : result.a;\n\n  return result;\n"):new Co(e.shape,"if (x < 0.0) return NAN;\n  return log(x);"),this.compileAndRun(n,[e])},e.prototype.log1p=function(t){var e=new Co(t.shape,"return log(1.0 + x);");return this.compileAndRun(e,[t])},e.prototype.sqrt=function(t){var e=new Co(t.shape,"return sqrt(x);");return this.compileAndRun(e,[t])},e.prototype.rsqrt=function(t){if(this.shouldExecuteOnCPU([t]))return this.cpuBackend.rsqrt(t);var e=new Co(t.shape,"return inversesqrt(x);");return this.compileAndRun(e,[t])},e.prototype.square=function(t){var e=new Co(t.shape,"return x * x;");return this.compileAndRun(e,[t])},e.prototype.reciprocal=function(t){var e=new Co(t.shape,"return 1.0 / x;");return this.compileAndRun(e,[t])},e.prototype.relu=function(e){var n;return n=t.ENV.getBool("WEBGL_PACK")?new To(e.shape,Ro):new Co(e.shape,ko),this.compileAndRun(n,[e])},e.prototype.prelu=function(e,n){var r=t.ENV.getBool("WEBGL_PACK_BINARY_OPERATIONS")?new Bi(Pi,e.shape,n.shape):new Li(zi,e.shape,n.shape);return this.compileAndRun(r,[e,n])},e.prototype.elu=function(t){var e=new Co(t.shape,"return (x >= 0.0) ? x : (exp(x) - 1.0);");return this.compileAndRun(e,[t])},e.prototype.eluDer=function(e,n){var r=t.ENV.getBool("WEBGL_PACK_BINARY_OPERATIONS")?new Bi("\n  vec4 bGTEZero = vec4(greaterThanEqual(b, vec4(0.)));\n  return (bGTEZero * a) + ((vec4(1.0) - bGTEZero) * (a * (b + vec4(1.0))));\n",e.shape,n.shape):new Li("return (b >= 1.0) ? a : a * (b + 1.0);",e.shape,n.shape);return this.compileAndRun(r,[e,n])},e.prototype.selu=function(t){var e=new Co(t.shape,"\n  // Stable and Attracting Fixed Point (0, 1) for Normalized Weights.\n  // see: https://arxiv.org/abs/1706.02515\n  float scaleAlpha = 1.7580993408473768;\n  float scale = 1.0507009873554805;\n  return (x >= 0.0) ? scale * x : scaleAlpha * (exp(x) - 1.0);\n");return this.compileAndRun(e,[t])},e.prototype.int=function(t){var e=new Co(t.shape,"return float(int(x));"),n=this.makeOutputArray(e.outputShape,"int32");return this.compileAndRun(e,[t],n)},e.prototype.clip=function(e,n,r){var i,a=(i=t.ENV.getBool("WEBGL_PACK_CLIP")?new Wi(e.shape):new Vi(e.shape)).getCustomSetupFunc(n,r);return this.compileAndRun(i,[e],null,a)},e.prototype.abs=function(t){var e=new Co(t.shape,"return abs(x);");return this.compileAndRun(e,[t])},e.prototype.complexAbs=function(t){var e=this.texData.get(t.dataId),n=new Ui(t.shape),r=[this.makeComplexComponentTensorHandle(t,e.complexTensors.real),this.makeComplexComponentTensorHandle(t,e.complexTensors.imag)];return this.compileAndRun(n,r)},e.prototype.sigmoid=function(t){var e=new Co(t.shape,"return 1.0 / (1.0 + exp(-1.0 * x));");return this.compileAndRun(e,[t])},e.prototype.softplus=function(t){var e=new Co(t.shape,"\n  float epsilon = 1.1920928955078125e-7;\n  float threshold = log(epsilon) + 2.0;\n\n  bool too_large = x > -threshold;\n  bool too_small = x < threshold;\n\n  float result;\n  float exp_x = exp(x);\n\n  if (too_large){\n    result = x;\n  }\n  else if (too_small){\n    result = exp_x;\n  }\n  else{\n    result = log(exp_x + 1.0);\n  }\n  return result;\n");return this.compileAndRun(e,[t])},e.prototype.sin=function(t){var e=new Co(t.shape,"if (isnan(x)) return x;\n  return sin(x);\n");return this.compileAndRun(e,[t])},e.prototype.cos=function(t){var e=new Co(t.shape,"if (isnan(x)) return x;\n  return cos(x);\n");return this.compileAndRun(e,[t])},e.prototype.tan=function(t){var e=new Co(t.shape,"return tan(x);");return this.compileAndRun(e,[t])},e.prototype.asin=function(t){var e=new Co(t.shape,"return asin(x);");return this.compileAndRun(e,[t])},e.prototype.acos=function(t){var e=new Co(t.shape,"return acos(x);");return this.compileAndRun(e,[t])},e.prototype.atan=function(t){var e=new Co(t.shape,"if (isnan(x)) return x;\n  return atan(x);\n");return this.compileAndRun(e,[t])},e.prototype.atan2=function(e,n){var r=t.ENV.getBool("WEBGL_PACK_BINARY_OPERATIONS")?new Bi("\n  vec4 result = atan(a, b);\n  vec4 isNaN = min(vec4(isnan(a)) + vec4(isnan(b)), vec4(1.0));\n  \n  result.r = isNaN.r > 0. ? NAN : result.r;\n  result.g = isNaN.g > 0. ? NAN : result.g;\n  result.b = isNaN.b > 0. ? NAN : result.b;\n  result.a = isNaN.a > 0. ? NAN : result.a;\n\n  return result;\n",e.shape,n.shape):new Li("\n  if (isnan(a)) return a;\n  if (isnan(b)) return b;\n\n  return atan(a, b);\n",e.shape,n.shape);return this.compileAndRun(r,[e,n])},e.prototype.sinh=function(t){var e=new Co(t.shape,"\n  float e2x = exp(x);\n  return (e2x - 1.0 / e2x) / 2.0;\n");return this.compileAndRun(e,[t])},e.prototype.cosh=function(t){var e=new Co(t.shape,"\n  float e2x = exp(-x);\n  return (e2x + 1.0 / e2x) / 2.0;\n");return this.compileAndRun(e,[t])},e.prototype.tanh=function(t){var e=new Co(t.shape,"\n  float e2x = exp(-2.0 * abs(x));\n  return sign(x) * (1.0 - e2x) / (1.0 + e2x);\n");return this.compileAndRun(e,[t])},e.prototype.asinh=function(t){var e=new Co(t.shape,"return log(x + sqrt(x * x + 1.0));");return this.compileAndRun(e,[t])},e.prototype.acosh=function(t){var e=new Co(t.shape,"if (isnan(x)) return x;\n  if (x < 1.0) return NAN;\n  return log(x + sqrt(x * x - 1.0));");return this.compileAndRun(e,[t])},e.prototype.atanh=function(t){var e=new Co(t.shape,"if (isnan(x)) return x;\n  if ((x < -1.0) || (x > 1.0)) return NAN;\n  return (log(1.0 + x) - log(1.0 - x)) / 2.0;");return this.compileAndRun(e,[t])},e.prototype.erf=function(t){var e=new Co(t.shape,'\n  // Error function is calculated approximately with elementary function.\n  // See "Handbook of Mathematical Functions with Formulas,\n  // Graphs, and Mathematical Tables", Abramowitz and Stegun.\n  float p = 0.3275911;\n  float a1 = 0.254829592;\n  float a2 = -0.284496736;\n  float a3 = 1.421413741;\n  float a4 = -1.453152027;\n  float a5 = 1.061405429;\n\n  float t = 1.0 / (1.0 + p * x);\n  return 1.0 - (((((a5*t + a4)*t) + a3)*t + a2)*t + a1)*t*exp(-x*x);\n');return this.compileAndRun(e,[t])},e.prototype.step=function(t,e){var n=new Co(t.shape,function(t){return void 0===t&&(t=0),Eo+"\n    return x > 0.0 ? 1.0 : float("+t+");\n  "}(e));return this.compileAndRun(n,[t])},e.prototype.conv2dByMatMul=function(e,n,r,i,a,o){var s=e.shape,u=this.texData.get(e.dataId),l=r.inChannels,c=s[0]*s[1]*s[2],p=r.outChannels,h="channelsLast"===r.dataFormat,d=(1===c||1===p)&&l>1e3,m=s[2]%2!=0&&!!u.isPacked;if(d||!t.ENV.getBool("WEBGL_LAZILY_UNPACK")||!t.ENV.getBool("WEBGL_PACK_BINARY_OPERATIONS")||!m){var g=h?s[0]*s[1]*s[2]:s[0]*s[2]*s[3],v=this.reshape(e,[1,g,r.inChannels]),y=this.reshape(n,[1,r.inChannels,r.outChannels]);return this.reshape(this.fusedBatchMatMul({a:v,b:y,transposeA:!1,transposeB:!1,bias:i,activation:a,preluActivationWeights:o}),r.outShape)}var b=h?s[0]*s[1]*(s[2]+1):s[0]*s[2]*(s[3]+1),x=ct.make([1,b,r.inChannels],{dataId:e.dataId},e.dtype,this),w=u.shape;u.shape=u.shape.slice(),u.shape[u.shape.length-2]++,f(we(u.shape,x.shape),function(){return"packed reshape "+u.shape+" to "+x.shape+" isn't free"});var N=this.reshape(n,[1,r.inChannels,r.outChannels]),C=this.fusedBatchMatMul({a:x,b:N,transposeA:!1,transposeB:!1,bias:i,activation:a,preluActivationWeights:o}),E=this.texData.get(C.dataId);return f(E.isPacked,function(){return"batchMatMul result is expected to be packed"}),u.shape=w,E.shape=r.outShape,ct.make(r.outShape,{dataId:C.dataId},C.dtype,this)},e.prototype.conv2dWithIm2Row=function(t,e,n,r,i,a){var o=n.filterWidth,s=n.filterHeight,u=n.inChannels,l=n.outWidth,c=n.outHeight,p="channelsLast"===n.dataFormat,h=o*s*u,f=c*l,d=[h,f],m=t.squeeze([0]),g=e.reshape([1,h,-1]),v=new Pa(d,m.shape,n),y=this.compileAndRun(v,[m]).reshape([1,d[0],d[1]]),b=null!=r,x=null!=a,w=i?_o(i,!0):null,N=new qa(y.shape,[1,f,n.outChannels],!0,!1,b,w,x),C=[y,g];r&&C.push(r),x&&C.push(a);var E=this.compileAndRun(N,C);return p?E.reshape([1,c,l,n.outChannels]):E.reshape([1,n.outChannels,c,l])},e.prototype.fusedConv2d=function(e,n,r,i,a,o){if(1===r.filterHeight&&1===r.filterWidth&&1===r.dilationHeight&&1===r.dilationWidth&&1===r.strideHeight&&1===r.strideWidth&&("SAME"===r.padInfo.type||"VALID"===r.padInfo.type))return this.conv2dByMatMul(e,n,r,i,a,o);if(t.ENV.getBool("WEBGL_CONV_IM2COL")&&1===e.shape[0])return this.conv2dWithIm2Row(e,n,r,i,a,o);var s=null!=i,u=null!=o,l=a?_o(a,!1):null,c=new Ji(r,s,l,u),p=[e,n];return i&&p.push(i),o&&p.push(o),this.compileAndRun(c,p)},e.prototype.conv2d=function(e,n,r){if(1===r.filterHeight&&1===r.filterWidth&&1===r.dilationHeight&&1===r.dilationWidth&&1===r.strideHeight&&1===r.strideWidth&&("SAME"===r.padInfo.type||"VALID"===r.padInfo.type))return this.conv2dByMatMul(e,n,r);if(t.ENV.getBool("WEBGL_CONV_IM2COL")&&1===e.shape[0])return this.conv2dWithIm2Row(e,n,r);var i=new Ji(r);return this.compileAndRun(i,[e,n])},e.prototype.conv2dDerInput=function(t,e,n){var r=new Gi(n);return this.compileAndRun(r,[t,e])},e.prototype.conv2dDerFilter=function(t,e,n){var r=new Hi(n);return this.compileAndRun(r,[t,e])},e.prototype.depthwiseConv2D=function(e,n,r){var i;return t.ENV.getBool("WEBGL_PACK_DEPTHWISECONV")&&r.strideWidth<=2&&r.outChannels/r.inChannels==1?(i=new ta(r),this.compileAndRun(i,[e,n],this.makePackedTensor(r.outShape,e.dtype))):(i=new Qi(r),this.compileAndRun(i,[e,n]))},e.prototype.depthwiseConv2DDerInput=function(t,e,n){var r=new Yi(n);return this.compileAndRun(r,[t,e])},e.prototype.depthwiseConv2DDerFilter=function(t,e,n){var r=new Xi(n);return this.compileAndRun(r,[t,e])},e.prototype.conv3d=function(t,e,n){var r=new Zi(n);return this.compileAndRun(r,[t,e])},e.prototype.conv3dDerInput=function(t,e,n){var r=new $i(n);return this.compileAndRun(r,[t,e])},e.prototype.conv3dDerFilter=function(t,e,n){var r=new Ki(n);return this.compileAndRun(r,[t,e])},e.prototype.maxPool=function(t,e){var n=new Ya(e,"max",!1),r=this.makeOutputArray(n.outputShape,t.dtype);return this.compileAndRun(n,[t],r)},e.prototype.avgPool=function(t,e){var n=new Ya(e,"avg",!1),r=this.makeOutputArray(n.outputShape,"float32");return this.compileAndRun(n,[t],r)},e.prototype.maxPoolBackprop=function(t,e,n,r){var i=new Ya(r,"max",!0),a=this.compileAndRun(i,[e]),o=new Ua(r),s=this.makeOutputArray(o.outputShape,e.dtype),u=this.compileAndRun(o,[t,a],s);return a.dispose(),u},e.prototype.avgPoolBackprop=function(t,e,n){var r=new Ai(n),i=this.makeOutputArray(r.outputShape,e.dtype);return this.compileAndRun(r,[t],i)},e.prototype.cast=function(t,e){return $r(t,e,this)},e.prototype.unstack=function(t,e){for(var n=t.shape[e],r=new Array(t.rank-1),i=0,a=0;a<t.rank;a++)a!==e&&(r[i++]=t.shape[a]);var o=new Array(t.rank).fill(0),s=t.shape.slice();s[e]=1;var u=new Array(n);for(a=0;a<u.length;a++)o[e]=a,u[a]=this.slice(t,o,s).reshape(r);return u},e.prototype.avgPool3d=function(t,e){var n=new Ja(e,"avg",!1),r=this.makeOutputArray(n.outputShape,"float32");return this.compileAndRun(n,[t],r)},e.prototype.avgPool3dBackprop=function(t,e,n){var r=new Ri(n),i=this.makeOutputArray(r.outputShape,e.dtype);return this.compileAndRun(r,[t],i)},e.prototype.maxPool3d=function(t,e){var n=new Ja(e,"max",!1),r=this.makeOutputArray(n.outputShape,"float32");return this.compileAndRun(n,[t],r)},e.prototype.maxPool3dBackprop=function(t,e,n,r){var i=new Ja(r,"max",!0),a=this.compileAndRun(i,[e]),o=new ja(r),s=this.makeOutputArray(o.outputShape,e.dtype),u=this.compileAndRun(o,[t,a],s);return a.dispose(),u},e.prototype.reshape=function(t,e){var n=this.texData.get(t.dataId);return!n.isPacked||we(t.shape,e)||null!==n.texture&&we(n.shape,e)?Xr(t,e):this.packedReshape(t,e)},e.prototype.resizeBilinear=function(e,n,r,i){var a=t.ENV.getBool("WEBGL_PACK_IMAGE_OPERATIONS")?new no(e.shape,n,r,i):new eo(e.shape,n,r,i);return this.compileAndRun(a,[e])},e.prototype.resizeBilinearBackprop=function(t,e,n){var r=new to(t,e,n);return this.compileAndRun(r,[t])},e.prototype.resizeNearestNeighbor=function(t,e,n,r){var i=new io(t.shape,e,n,r);return this.compileAndRun(i,[t])},e.prototype.resizeNearestNeighborBackprop=function(t,e,n){var r=new ro(t,e,n);return this.compileAndRun(r,[t])},e.prototype.multinomial=function(t,e,n,r){var i=e?t:Rr(t),a=i.shape[0],o=i.shape[1],s=new Ha(a,o,n),u=this.makeOutputArray(s.outputShape,"int32"),l=s.getCustomSetupFunc(r);return this.compileAndRun(s,[i],u,l)},e.prototype.oneHot=function(t,e,n,r){var i=new Ga(t.size,e,n,r);return this.compileAndRun(i,[t])},e.prototype.diag=function(t){var e=new sa(t.size);return this.compileAndRun(e,[t])},e.prototype.nonMaxSuppression=function(t,e,n,r,i){return Pe("tf.nonMaxSuppression() in webgl locks the UI thread. Call tf.nonMaxSuppressionAsync() instead"),ni(t.dataSync(),e.dataSync(),n,r,i)},e.prototype.cropAndResize=function(t,e,n,r,i,a){var o=new ea(t.shape,e.shape,r,i,a);return this.compileAndRun(o,[t,e,n])},e.prototype.depthToSpace=function(t,e,n){f(e>1,function(){return"blockSize should be > 1 for depthToSpace, but was: "+e});var r=t.shape[0],i="NHWC"===n?t.shape[1]:t.shape[2],a="NHWC"===n?t.shape[2]:t.shape[3],o="NHWC"===n?t.shape[3]:t.shape[1],s=i*e,u=a*e,l=o/(e*e),c=new oa("NHWC"===n?[r,s,u,l]:[r,l,s,u],e,n);return this.compileAndRun(c,[t])},e.prototype.split=function(t,e,n){return ii(t,e,n)},e.prototype.scatterND=function(t,e,n){var r=xr(0,t,n),i=r.sliceRank,a=r.numUpdates,o=r.sliceSize,s=r.strides,u=r.outputSize,l=[u/o,o],c=t.reshape([a,i]),p=e.reshape([a,o]);if(0===u)return Xr(rn([]),n);var h=on(0),f=new so(a,i,c.rank,p.rank,s,l);return this.compileAndRun(f,[p,c,h]).reshape(n)},e.prototype.sparseToDense=function(t,e,n,r){var i=xr(0,t,n),a=i.sliceRank,o=i.numUpdates,s=i.strides,u=i.outputSize,l=new so(o,a,t.rank,e.rank,s,[u,1],!1);return this.compileAndRun(l,[e,t,r]).reshape(n)},e.prototype.fft=function(t){return this.fftImpl(t,!1)},e.prototype.ifft=function(t){return this.fftImpl(t,!0)},e.prototype.fftImpl=function(t,e){var n=this.texData.get(t.dataId),r=new ha("return real * expR - imag * expI;",t.shape,e),i=new ha("return real * expI + imag * expR;",t.shape,e),a=[this.makeComplexComponentTensorHandle(t,n.complexTensors.real),this.makeComplexComponentTensorHandle(t,n.complexTensors.imag)],o=this.compileAndRun(r,a),s=this.compileAndRun(i,a),u=this.complex(o,s).as2D(t.shape[0],t.shape[1]);return o.dispose(),s.dispose(),u},e.prototype.gatherND=function(t,e){var n=e.shape,r=n[n.length-1],i=vr(t,e),a=i[0],o=i[1],s=i[2],u=i[3],l=e.reshape([o,r]),c=t.reshape([t.size/s,s]),p=new va(r,u,[o,s]);return this.compileAndRun(p,[c,l]).reshape(a)},e.prototype.fill=function(t,e,n){if("string"===(n=n||B(e))){var r=A(n,v(t));return r.fill(e),ct.make(t,{values:r},n)}var i=new fa(t,e),a=i.getCustomSetupFunc(e),o=this.makeOutputArray(t,n);return this.compileAndRun(i,[],o,a)},e.prototype.onesLike=function(t){if("string"===t.dtype)throw new Error("onesLike is not supported under string dtype");return this.fill(t.shape,1,t.dtype)},e.prototype.zerosLike=function(t){return this.fill(t.shape,"string"===t.dtype?"":0,t.dtype)},e.prototype.linspace=function(t,e,n){return Yr(t,e,n)},e.prototype.makeOutputArray=function(t,e){return ct.make(t,{},e,this)},e.prototype.makePackedTensor=function(t,e){var n=ct.make(t,{},e,this);return this.texData.get(n.dataId).isPacked=!0,n},e.prototype.unpackTensor=function(t){var e=new Do(t.shape);return this.compileAndRun(e,[t],ct.make(e.outputShape,{},t.dtype,this))},e.prototype.packTensor=function(t){var e=new Ka(t.shape);return this.compileAndRun(e,[t],this.makePackedTensor(t.shape,t.dtype),null,!0)},e.prototype.packedReshape=function(t,e){var n=t.reshape([ge(t.shape)].concat(ve(t.shape))),r=[ge(e)].concat(ve(e)),i=new Qa(r,n.shape);return this.compileAndRun(i,[n]).reshape(e)},e.prototype.decode=function(t){var e,n=this.texData.get(t),r=n.isPacked,i=n.shape,a=n.dtype,o=ye(i),s=Lt(i),u=this.makeTensorHandle(i,"float32");return this.texData.get(u.dataId).isPacked=!0,this.texData.get(u.dataId).dtype=a,this.texData.get(u.dataId).texShape=s.map(function(t){return 2*t}),e=r?new aa(o,s):new ia(o,s),this.compileAndRun(e,[{shape:o,dtype:a,dataId:t}],u,null,!0),u},e.prototype.compileAndRun=function(e,n,r,i,a){var o=this;if(void 0===a&&(a=!1),null==r&&(r=e.usesPackedTextures?this.makePackedTensor(e.outputShape,n[0].dtype):this.makeOutputArray(e.outputShape,n[0].dtype)),0===r.size)return this.texData.get(r.dataId).values=I(r.dtype,0),r;var s=n.map(function(n){if("complex64"===n.dtype)throw new Error("GPGPUProgram does not support complex64 input. For complex64 dtypes, please separate the program into real and imaginary parts.");var r=o.texData.get(n.dataId);if(null==r.texture){if(!e.usesPackedTextures&&v(n.shape)<=t.ENV.getNumber("WEBGL_SIZE_UPLOAD_UNIFORM"))return{shape:n.shape,texData:null,isUniform:!0,uniformValues:r.values};e.usesPackedTextures&&(r.isPacked=!0,r.shape=n.shape)}else if(!!r.isPacked!=!!e.usesPackedTextures)n=r.isPacked?o.unpackTensor(n):o.packTensor(n),r=o.texData.get(n.dataId);else if(r.isPacked&&!we(r.shape,n.shape)){var i=n,a=n.shape;n.shape=r.shape,n=o.packedReshape(n,a),r=o.texData.get(n.dataId),i.shape=a}return o.uploadToGPU(n.dataId),{shape:n.shape,texData:r,isUniform:!1}});this.uploadToGPU(r.dataId);var u,l={shape:r.shape,texData:this.texData.get(r.dataId),isUniform:!1},c=function(t,e,n){var r="";s.concat(n).forEach(function(t){var e=null!=t.texData&&null!=t.texData.slice&&t.texData.slice.flatOffset>0,n=t.isUniform?"uniform":t.texData.texShape;r+=t.shape+"_"+n+"_"+e});var i=t.userCode;return t.constructor.name+"_"+r+"_"+i}(e,0,l),p=this.getAndSaveBinary(c,function(){return function(e,n,r,i){var a=n.userCode,o=r.map(function(t,e){var r={logicalShape:t.shape,texShape:t.isUniform?null:t.texData.texShape,isUniform:t.isUniform,isPacked:!t.isUniform&&t.texData.isPacked,flatOffset:null};return null!=t.texData&&null!=t.texData.slice&&t.texData.slice.flatOffset>0&&(r.flatOffset=t.texData.slice.flatOffset),{name:n.variableNames[e],shapeInfo:r}}),s=o.map(function(t){return t.shapeInfo}),u={logicalShape:i.shape,texShape:i.texData.texShape,isUniform:!1,isPacked:i.texData.isPacked,flatOffset:null},l=vi(o,u,a,n.usesPackedTextures),c=e.createProgram(l),p=null,h=e.getUniformLocation(c,"NAN",!1);1===t.ENV.getNumber("WEBGL_VERSION")&&(p=e.getUniformLocation(c,"INFINITY",!1));for(var f={},d=0;d<n.variableNames.length;d++){var m=n.variableNames[d];f[m]=e.getUniformLocation(c,m,!1),f["offset"+m]=e.getUniformLocation(c,"offset"+m,!1)}return{program:n,source:l,webGLProgram:c,uniformLocations:f,inShapeInfos:s,outShapeInfo:u,infLoc:p,nanLoc:h}}(o.gpgpu,e,s,l)}),h=null!=this.activeTimers;return h&&(u=this.startTimer()),function(e,n,r,i,a){La(n.inShapeInfos,r),La([n.outShapeInfo],[i]);var o=i.texData.texture,s=i.texData.texShape;i.texData.isPacked?e.setOutputPackedMatrixTexture(o,s[0],s[1]):e.setOutputMatrixTexture(o,s[0],s[1]),e.setProgram(n.webGLProgram),1===t.ENV.getNumber("WEBGL_VERSION")&&null!==n.infLoc&&e.gl.uniform1f(n.infLoc,1/0),null!==n.nanLoc&&e.gl.uniform1f(n.nanLoc,NaN),r.forEach(function(t,r){var i=n.program.variableNames[r],a=n.uniformLocations[i],o=n.uniformLocations["offset"+i];if(null!=a)if(t.isUniform)if(v(t.shape)<2)e.gl.uniform1f(a,t.uniformValues[0]);else{var s=t.uniformValues;s instanceof Float32Array||(s=new Float32Array(s)),e.gl.uniform1fv(a,s)}else null!=t.texData.slice&&null!=o&&e.gl.uniform1i(o,t.texData.slice.flatOffset),e.setInputMatrixTexture(t.texData.texture,a,r)}),null!=a&&a(e,n.webGLProgram),e.executeProgram()}(this.gpgpu,p,s,l,i),h&&(u=this.endTimer(u),this.activeTimers.push({name:e.constructor.name,query:this.getQueryTime(u)})),!t.ENV.getBool("WEBGL_LAZILY_UNPACK")&&this.texData.get(r.dataId).isPacked&&!1===a?this.unpackTensor(r):r},e.prototype.getAndSaveBinary=function(t,e){return t in this.binaryCache||(this.binaryCache[t]=e()),this.binaryCache[t]},e.prototype.getTextureManager=function(){return this.textureManager},e.prototype.dispose=function(){this.disposed||(this.textureManager.dispose(),null!=this.canvas&&null!=this.canvas.remove?this.canvas.remove():this.canvas=null,null!=this.fromPixels2DContext&&this.fromPixels2DContext.canvas.remove&&this.fromPixels2DContext.canvas.remove(),this.gpgpuCreatedLocally&&(this.gpgpu.program=null,this.gpgpu.dispose()),this.disposed=!0)},e.prototype.floatPrecision=function(){var e=this;return null==this.floatPrecisionValue&&(this.floatPrecisionValue=Fe(function(){var n=t.ENV.getBool("DEBUG");t.ENV.set("DEBUG",!1);var r=e.abs(on(1e-8)).dataSync()[0];return t.ENV.set("DEBUG",n),r>0?32:16})),this.floatPrecisionValue},e.prototype.epsilon=function(){return 32===this.floatPrecision()?1e-7:1e-4},e.prototype.uploadToGPU=function(t){var e,n=this.texData.get(t),r=n.shape,i=n.dtype,a=n.values,o=n.texture,s=n.usage,u=n.isPacked;if(null==o){var l,c=null!=this.activeTimers;c&&(l=K());var p=n.texShape;if(null==p&&(p=be(r,u),n.texShape=p),null!=a){var h=ye(r),f=void 0,d=p[1],m=p[0],g=a instanceof Uint8Array;u?(d=(e=Pt(p[0],p[1]))[0],m=e[1],f=new pa(h,[m,d],g)):f=new ca(h,[m,d],g);var y=this.makeTensorHandle([m,d],i);this.texData.get(y.dataId).usage=g?Rt.PIXELS:Rt.UPLOAD,this.gpgpu.uploadDenseMatrixToTexture(this.getTexture(y.dataId),d,m,a);var b=this.makeTensorHandle(f.outputShape,y.dtype);b.size=v(f.outputShape),this.texData.get(b.dataId).isPacked=u,this.compileAndRun(f,[y],b);var x=this.texData.get(b.dataId);n.texture=x.texture,n.texShape=x.texShape,n.isPacked=x.isPacked,n.usage=x.usage,this.disposeData(y.dataId),this.texData.delete(b.dataId),n.values=null,c&&(this.uploadWaitMs+=K()-l)}else{var w=this.acquireTexture(p,s,i,u);n.texture=w}}},e.prototype.convertAndCacheOnCPU=function(t,e){var n=this.texData.get(t),r=n.dtype;return this.releaseGPUData(t),null!=e&&(n.values=function(t,e){if("float32"===e||"complex64"===e)return t;if("int32"===e||"bool"===e){for(var n="int32"===e?new Int32Array(t.length):new Uint8Array(t.length),r=0;r<n.length;++r)n[r]=Math.round(t[r]);return n}throw new Error("Unknown dtype "+e)}(e,r)),n.values},e.prototype.acquireTexture=function(t,e,n,r){if(this.numBytesInGPU+=this.computeBytes(t,n),!this.warnedAboutMemory&&this.numBytesInGPU>1024*this.numMBBeforeWarning*1024){var i=(this.numBytesInGPU/1024/1024).toFixed(2);this.warnedAboutMemory=!0,console.warn("High memory usage in GPU: "+i+" MB, most likely due to a memory leak")}return this.textureManager.acquireTexture(t,e,r)},e.prototype.computeBytes=function(t,e){return t[0]*t[1]*F(e)},e}();At()&&It.registerBackend("webgl",function(){return new Mo},2);var zo=Qe({abs_:function(t){var e=We(t,"x","abs");return"complex64"===e.dtype?It.runKernel(function(t){return t.complexAbs(e)},{$x:e}):It.runKernel(function(t,n){var r=t.abs(e);return n([e]),r},{$x:e},function(t,e){var n=e[0];return{$x:function(){return t.mul(n.toFloat().step(-1))}}})}}),Lo=Qe({acos_:function(t){var e=We(t,"x","acos");return It.runKernel(function(t,n){var r=t.acos(e);return n([e]),r},{$x:e},function(t,e){var n=e[0];return{$x:function(){return t.divStrict(on(1).sub(n.toFloat().square()).sqrt()).neg()}}})}}),Po=Qe({acosh_:function(t){var e=We(t,"x","acosh");return It.runKernel(function(t,n){var r=t.acosh(e);return n([e]),r},{$x:e},function(t,e){var n=e[0];return{$x:function(){return t.divStrict(n.toFloat().square().sub(1).sqrt())}}})}}),Bo=Qe({asin_:function(t){var e=We(t,"x","asin");return It.runKernel(function(t,n){var r=t.asin(e);return n([e]),r},{$x:e},function(t,e){var n=e[0];return{$x:function(){return t.divStrict(on(1).sub(n.toFloat().square()).sqrt())}}})}}),Vo=Qe({asinh_:function(t){var e=We(t,"x","asinh");return It.runKernel(function(t,n){var r=t.asinh(e);return n([e]),r},{$x:e},function(t,e){var n=e[0];return{$x:function(){return t.divStrict(on(1).add(n.toFloat().square()).sqrt())}}})}}),Wo=Qe({atan_:function(t){var e=We(t,"x","atan");return It.runKernel(function(t,n){var r=t.atan(e);return n([e]),r},{$x:e},function(t,e){var n=e[0];return{$x:function(){return t.div(n.toFloat().square().add(1))}}})}}),Uo=Qe({atanh_:function(t){var e=We(t,"x","atanh");return It.runKernel(function(t,n){var r=t.atanh(e);return n([e]),r},{$x:e},function(t,e){var n=e[0];return{$x:function(){return t.div(on(1).sub(n.toFloat().square()))}}})}}),jo=Qe({ceil_:function(t){var e=We(t,"x","ceil");return It.runKernel(function(t){return t.ceil(e)},{$x:e},function(t){return{$x:function(){return bn(t)}}})}}),qo=Qe({clipByValue_:function(t,e,n){var r=We(t,"x","clipByValue");return f(e<=n,function(){return"Error in clip: min ("+e+") must be less than or equal to max ("+n+")."}),It.runKernel(function(t,i){var a=t.clip(r,e,n);return i([r]),a},{$x:r},function(t,r){var i=r[0];return{$x:function(){return t.where(i.greaterEqual(e).logicalAnd(i.lessEqual(n)),bn(t))}}})}}),Ho=Qe({cos_:function(t){var e=We(t,"x","cos");return It.runKernel(function(t,n){var r=t.cos(e);return n([e]),r},{$x:e},function(t,e){var n=e[0];return{$x:function(){return n.toFloat().sin().neg().mul(t)}}})}}),Go=Qe({cosh_:function(t){var e=We(t,"x","cosh");return It.runKernel(function(t,n){var r=t.cosh(e);return n([e]),r},{$x:e},function(t,e){var n=e[0];return{$x:function(){return n.toFloat().sinh().mulStrict(t)}}})}}),Ko=Qe({erf_:function(t){var e=We(t,"x","erf");return f("int32"===e.dtype||"float32"===e.dtype,function(){return"Input dtype must be `int32` or `float32`."}),"int32"===e.dtype&&(e=e.toFloat()),It.runKernel(function(t,n){var r=t.erf(e);return n([e]),r},{$x:e},function(t,e){var n=e[0];return{$x:function(){return t.mul(n.square().neg().exp().mul(2/Math.sqrt(Math.PI)))}}})}}),$o=Qe({exp_:function(t){var e=We(t,"x","exp");return It.runKernel(function(t,n){var r=t.exp(e);return n([r]),r},{$x:e},function(t,e){return{$x:function(){return t.mulStrict(e[0])}}})}}),Xo=Qe({expm1_:function(t){var e=We(t,"x","expm1");return It.runKernel(function(t,n){var r=t.expm1(e);return n([e]),r},{$x:e},function(t,e){var n=e[0];return{$x:function(){return t.mul(n.exp())}}})}}),Yo=Qe({floor_:function(t){var e=We(t,"x","floor");return It.runKernel(function(t){return t.floor(e)},{$x:e},function(t){return{$x:function(){return bn(t)}}})}}),Jo=Qe({log_:function(t){var e=We(t,"x","log");return It.runKernel(function(t,n){var r=t.log(e);return n([e]),r},{$x:e},function(t,e){var n=e[0];return{$x:function(){return t.div(n.toFloat())}}})}}),Zo=Qe({log1p_:function(t){var e=We(t,"x","log1p");return It.runKernel(function(t,n){var r=t.log1p(e);return n([e]),r},{$x:e},function(t,e){var n=e[0];return{$x:function(){return t.div(n.add(1))}}})}}),Qo=Qe({logSigmoid_:function(t){var e=We(t,"x","logSigmoid");return It.runKernel(function(t,n){var r=t.softplus(e.neg()).neg();return n([e]),r},{$x:e},function(t,e){var n=e[0];return{$x:function(){return t.mul(n.neg().sigmoid())}}})}}),ts=Qe({neg_:function(t){var e=We(t,"x","neg");return It.runKernel(function(t){return t.neg(e)},{$x:e},function(t){return{$x:function(){return t.neg()}}})}}),es=Qe({reciprocal_:function(t){var e=We(t,"x","reciprocal");return It.runKernel(function(t,n){var r=t.reciprocal(e);return n([e]),r},{$x:e},function(t,e){var n=e[0];return{$x:function(){return t.div(n.square().neg())}}})}}),ns=Qe({round_:function(t){var e=We(t,"x","round");return It.runKernel(function(t){return t.round(e)},{$x:e},function(t){return{$x:function(){return bn(t)}}})}}),rs=Qe({rsqrt_:function(t){var e=We(t,"x","rsqrt");return It.runKernel(function(t,n){var r=t.rsqrt(e);return n([e]),r},{$x:e},function(t,e){var n=e[0];return{$x:function(){return t.div(n.pow(1.5).mul(2)).neg()}}})}}),is=Qe({sigmoid_:function(t){var e=We(t,"x","sigmoid");return It.runKernel(function(t,n){var r=t.sigmoid(e);return n([r]),r},{$x:e},function(t,e){var n=e[0];return{$x:function(){return t.mul(n.mul(on(1).sub(n)))}}})}}),as=Qe({sign_:function(t){var e=We(t,"x","sign");return It.runKernel(function(t){return t.sign(e)},{$x:e},function(t){return{$x:function(){return bn(t)}}})}}),os=Qe({isNaN_:function(t){var e=We(t,"x","isNaN");return It.runKernel(function(t){return t.isNaN(e)},{$x:e},function(t){return{$x:function(){return bn(t)}}})}}),ss=Qe({isInf_:function(t){var e=We(t,"x","isInf");return It.runKernel(function(t){return t.isInf(e)},{$x:e},function(t){return{$x:function(){return bn(t)}}})}}),us=Qe({isFinite_:function(t){var e=We(t,"x","isFinite");return It.runKernel(function(t){return t.isFinite(e)},{$x:e},function(t){return{$x:function(){return bn(t)}}})}}),ls=Qe({sin_:function(t){var e=We(t,"x","sin");return It.runKernel(function(t,n){var r=t.sin(e);return n([e]),r},{$x:e},function(t,e){var n=e[0];return{$x:function(){return n.toFloat().cos().mul(t)}}})}}),cs=Qe({sinh_:function(t){var e=We(t,"x","sinh");return It.runKernel(function(t,n){var r=t.sinh(e);return n([e]),r},{$x:e},function(t,e){var n=e[0];return{$x:function(){return n.toFloat().cosh().mulStrict(t)}}})}}),ps=Qe({softplus_:function(t){var e=We(t,"x","softplus");return It.runKernel(function(t,n){var r=t.softplus(e);return n([e]),r},{$x:e},function(t,e){var n=e[0];return{$x:function(){return t.mul(n.sigmoid())}}})}}),hs=Qe({sqrt_:function(t){var e=We(t,"x","sqrt");return It.runKernel(function(t,n){var r=t.sqrt(e);return n([e]),r},{$x:e},function(t,e){var n=e[0];return{$x:function(){return t.div(n.toFloat().sqrt().mul(2))}}})}}),fs=Qe({square_:function(t){var e=We(t,"x","square");return It.runKernel(function(t,n){return n([e]),t.square(e)},{$x:e},function(t,e){var n=e[0];return{$x:function(){return t.mul(n.toFloat().mul(2))}}})}}),ds=Qe({step_:function(t,e){void 0===e&&(e=0);var n=We(t,"x","step");return It.runKernel(function(t){return t.step(n,e)},{$x:n},function(t){return{$x:function(){return bn(t)}}})}}),ms=Qe({tan_:function(t){var e=We(t,"x","tan");return It.runKernel(function(t,n){var r=t.tan(e);return n([e]),r},{$x:e},function(t,e){var n=e[0];return{$x:function(){return t.div(n.cos().square())}}})}}),gs=Qe({tanh_:function(t){var e=We(t,"x","tanh");return It.runKernel(function(t,n){var r=t.tanh(e);return n([r]),r},{$x:e},function(t,e){var n=e[0];return{$x:function(){return on(1).sub(n.square()).mulStrict(t)}}})}});function vs(t,e,n,r,i,a){var o,s,u=We(t,"x","batchNorm"),l=We(e,"mean","batchNorm"),c=We(n,"variance","batchNorm");return null!=i&&(o=We(i,"scale","batchNorm")),null!=r&&(s=We(r,"offset","batchNorm")),f(2===u.rank,function(){return"Error in batchNorm3D: x must be rank 3 but got rank "+u.rank+"."}),f(2===l.rank||1===l.rank,function(){return"Error in batchNorm2D: mean must be rank 2 or rank 1 but got rank "+l.rank+"."}),f(2===c.rank||1===c.rank,function(){return"Error in batchNorm2D: variance must be rank 2 or rank 1 but got rank "+c.rank+"."}),null!=o&&f(2===o.rank||1===o.rank,function(){return"Error in batchNorm2D: scale must be rank 2 or rank 1 but got rank "+o.rank+"."}),null!=s&&f(2===s.rank||1===s.rank,function(){return"Error in batchNorm2D: offset must be rank 2 or rank 1 but got rank "+s.rank+"."}),xs(u,l,c,s,o,a)}function ys(t,e,n,r,i,a){var o,s,u=We(t,"x","batchNorm"),l=We(e,"mean","batchNorm"),c=We(n,"variance","batchNorm");return null!=i&&(o=We(i,"scale","batchNorm")),null!=r&&(s=We(r,"offset","batchNorm")),f(3===u.rank,function(){return"Error in batchNorm3D: x must be rank 3 but got rank "+u.rank+"."}),f(3===l.rank||1===l.rank,function(){return"Error in batchNorm3D: mean must be rank 3 or rank 1 but got rank "+l.rank+"."}),f(3===c.rank||1===c.rank,function(){return"Error in batchNorm3D: variance must be rank 3 or rank 1 but got rank "+c.rank+"."}),null!=o&&f(3===o.rank||1===o.rank,function(){return"Error in batchNorm3D: scale must be rank 3 or rank 1 but got rank "+o.rank+"."}),null!=s&&f(3===s.rank||1===s.rank,function(){return"Error in batchNorm3D: offset must be rank 3 or rank 1 but got rank "+s.rank+"."}),xs(u,l,c,s,o,a)}function bs(t,e,n,r,i,a){var o,s,u=We(t,"x","batchNorm"),l=We(e,"mean","batchNorm"),c=We(n,"variance","batchNorm");return null!=i&&(o=We(i,"scale","batchNorm")),null!=r&&(s=We(r,"offset","batchNorm")),f(4===u.rank,function(){return"Error in batchNorm4D: x must be rank 4 but got rank "+u.rank+"."}),f(4===l.rank||1===l.rank,function(){return"Error in batchNorm4D: mean must be rank 4 or rank 1 but got rank "+l.rank+"."}),f(4===c.rank||1===c.rank,function(){return"Error in batchNorm4D: variance must be rank 4 or rank 1 but got rank "+c.rank+"."}),null!=o&&f(4===o.rank||1===o.rank,function(){return"Error in batchNorm4D: scale must be rank 4 or rank 1 but got rank "+o.rank+"."}),null!=s&&f(4===s.rank||1===s.rank,function(){return"Error in batchNorm4D: offset must be rank 4 or rank 1 but got rank "+s.rank+"."}),xs(u,l,c,s,o,a)}function xs(t,e,n,r,i,a){null==a&&(a=.001);var o,s,u,l=We(t,"x","batchNorm"),c=We(e,"mean","batchNorm"),p=We(n,"variance","batchNorm");return null!=i&&(o=We(i,"scale","batchNorm")),null!=r&&(s=We(r,"offset","batchNorm")),f(c.rank===p.rank,function(){return"Batch normalization gradient requires mean and variance to have equal ranks."}),f(null==s||c.rank===s.rank,function(){return"Batch normalization gradient requires mean and offset to have equal ranks."}),f(null==o||c.rank===o.rank,function(){return"Batch normalization gradient requires mean and scale to have equal ranks."}),u=0===l.rank||1===l.rank?l.as4D(1,1,1,l.size):2===l.rank?l.as4D(1,1,l.shape[0],l.shape[1]):3===l.rank?l.as4D(1,l.shape[0],l.shape[1],l.shape[2]):l,It.runKernel(function(t,e){var n=t.batchNormalization(u,ws(c),ws(p),a,ws(o),ws(s));return e([l,c,p,o]),n},{$x:l,$mean:c,$variance:p,$scale:o,$offset:s},function(t,e){var n=e,r=n[0],i=n[1],o=n[2],s=n[3],l=null==s?on(1):s,c=Fr(i.shape,u.shape),p=[];if(1===i.rank){for(var h=0;h<u.shape.length-1;++h)p.push(u.shape[h]);p.push(1)}var f=r.sub(i),d=t.mul(l),m=rs(o.add(on(a))),g=m.mul(m).mul(m).mul(on(-.5));return{$x:function(){return 1===i.rank?t.mul(ur(m.as4D(1,1,1,i.shape[0]),p)).mul(l).reshape(r.shape):t.mul(m).mul(l).reshape(r.shape)},$mean:function(){var t=m.mul(on(-1)).mul(d);return 1===i.rank&&(t=t.sum(c)),t.reshape(i.shape)},$variance:function(){var t=g.mul(f).mul(d);return 1===i.rank&&(t=t.sum(c)),t.reshape(i.shape)},$scale:function(){var e=f.mul(m),n=t.mul(e);return 1===i.rank&&(n=n.sum(c)),n.reshape(i.shape)},$offset:function(){var e=t;return 1===i.rank&&(e=e.sum(c)),e.reshape(i.shape)}}}).reshape(l.shape)}function ws(t){return null==t?null:0===t.rank?t.as1D():1===t.rank?t:2===t.rank?t.as4D(1,1,t.shape[0],t.shape[1]):3===t.rank?t.as4D(1,t.shape[0],t.shape[1],t.shape[2]):t}function Ns(){Oe("tf.batchNormalization() is going away. Use tf.batchNorm() instead, and note the positional argument change of scale, offset, and varianceEpsilon")}var Cs=Qe({batchNormalization2d_:function(t,e,n,r,i,a){return void 0===r&&(r=.001),Ns(),vs(t,e,n,a,i,r)}}),Es=Qe({batchNormalization3d_:function(t,e,n,r,i,a){return void 0===r&&(r=.001),Ns(),ys(t,e,n,a,i,r)}}),Ss=Qe({batchNormalization4d_:function(t,e,n,r,i,a){return void 0===r&&(r=.001),Ns(),bs(t,e,n,a,i,r)}}),ks=Qe({batchNormalization_:function(t,e,n,r,i,a){return void 0===r&&(r=.001),Ns(),xs(t,e,n,a,i,r)}}),Is=Qe({batchNorm_:xs}),As=Qe({batchNorm2d_:vs}),Rs=Qe({batchNorm3d_:ys}),Ts=Qe({batchNorm4d_:bs}),Ds=Qe({logicalAnd_:function(t,e){var n=We(t,"a","logicalAnd","bool"),r=We(e,"b","logicalAnd","bool");return Mr(n.shape,r.shape),It.runKernel(function(t){return t.logicalAnd(n,r)},{$a:n,$b:r})}}),Os=Qe({logicalNot_:function(t){var e=We(t,"x","logicalNot","bool");return It.runKernel(function(t){return t.logicalNot(e)},{$x:e})}}),_s=Qe({logicalOr_:function(t,e){var n=We(t,"a","logicalOr","bool"),r=We(e,"b","logicalOr","bool");return Mr(n.shape,r.shape),It.runKernel(function(t){return t.logicalOr(n,r)},{$a:n,$b:r})}}),Fs=Qe({logicalXor_:function(t,e){var n=We(t,"a","logicalXor","bool"),r=We(e,"b","logicalXor","bool");return Mr(n.shape,r.shape),_s(t,e).logicalAnd(Ds(t,e).logicalNot())}}),Ms=Qe({where_:function(t,e,n){var r=We(e,"a","where"),i=We(n,"b","where"),a=We(t,"condition","where","bool");return d(r.shape,i.shape,"Error in where: "),1===a.rank?f(a.shape[0]===r.shape[0],function(){return"The first dimension of `a` must match the size of `condition`."}):d(a.shape,i.shape,"Error in where: "),It.runKernel(function(t,e){var n=t.select(a,r,i);return e([a]),n},{$condition:a,$a:r,$b:i},function(t,e){var n=e[0];return{$condition:function(){return bn(n).toFloat()},$a:function(){return t.mul(n.cast(t.dtype))},$b:function(){return t.mul(n.logicalNot().cast(t.dtype))}}})}}),zs=function(t){return r(this,void 0,void 0,function(){var e,n,r;return i(this,function(i){switch(i.label){case 0:return[4,(e=We(t,"condition","whereAsync","bool")).data()];case 1:return n=i.sent(),r=si(e.shape,n),t!==e&&e.dispose(),[2,r]}})})},Ls=Qe({add_:function(t,e){var n,r=We(t,"a","add"),i=We(e,"b","add");n=xt(r,i),r=n[0],i=n[1];var a=Mr(r.shape,i.shape);return It.runKernel(function(t){return t.add(r,i)},{$a:r,$b:i},function(t){return{$a:function(){var e=t,n=Fr(r.shape,a);return n.length>0&&(e=e.sum(n)),e.reshape(r.shape)},$b:function(){var e=t,n=Fr(i.shape,a);return n.length>0&&(e=e.sum(n)),e.reshape(i.shape)}}})}}),Ps=Qe({addN_:function(t){f(Array.isArray(t),function(){return"The argument passed to tf.addN() must be a list of tensors"}),f(t.length>=1,function(){return"Must pass at least one tensor to tf.addN(), but got "+t.length});var e=t.map(function(t,e){return We(t,"tensors"+e,"addN")}),n=e[0];e.forEach(function(t){if(t.dtype!==n.dtype)throw new Error("All tensors passed to tf.addN() must have the same dtype")}),e.forEach(function(t){if(!y(t.shape,n.shape))throw new Error("All tensors passed to tf.addN() must have the same shape")});var r=e;return It.runKernel(function(t){return t.addN(e)},r,function(t){var n={};return e.forEach(function(e,r){n[r]=function(){return t.clone()}}),n})}}),Bs=Qe({addStrict_:function(t,e){var n=We(t,"a","addStrict"),r=We(e,"b","addStrict");return d(n.shape,r.shape,"Error in addStrict: "),n.add(r)}}),Vs=Qe({atan2_:function(t,e){var n,r=We(t,"a","atan2"),i=We(e,"b","atan2");n=xt(r,i),r=n[0],i=n[1];var a=Mr(r.shape,i.shape);return It.runKernel(function(t,e){var n=t.atan2(r,i);return e([r,i]),n},{$a:r,$b:i},function(t,e){var n=e[0],r=e[1];return{$a:function(){var e=Ls(n.square(),r.square()),i=t.mul(r.div(e)),o=Fr(n.shape,a);return o.length>0&&(i=i.sum(o)),i.reshape(n.shape)},$b:function(){var e=Ls(n.square(),r.square()),i=ts(t.mul(n.div(e))),o=Fr(r.shape,a);return o.length>0&&(i=i.sum(o)),i.reshape(r.shape)}}})}}),Ws=Qe({div_:function(t,e){var n,r=We(t,"a","div"),i=We(e,"b","div");if(n=xt(r,i),r=n[0],i=n[1],"int32"===r.dtype&&"int32"===i.dtype)return js(r,i);var a=Mr(r.shape,i.shape);return It.runKernel(function(t,e){var n=t.realDivide(r,i);return e([r,i]),n},{$a:r,$b:i},function(t,e){var n=e[0],r=e[1];return{$a:function(){var e=t.div(r.toFloat()),i=Fr(n.shape,a);return i.length>0?e.sum(i).reshape(n.shape):e},$b:function(){var e=t.mul(n.toFloat()),i=Fr(r.shape,a);i.length>0&&(e=e.sum(i).reshape(r.shape));var o=r.square();return e.div(o.toFloat()).neg()}}})}}),Us=Qe({divStrict_:function(t,e){var n=We(t,"a","div"),r=We(e,"b","div");return d(n.shape,r.shape,"Error in divideStrict: "),n.div(r)}}),js=Qe({floorDiv_:function(t,e){var n,r=We(t,"a","floorDiv"),i=We(e,"b","floorDiv");n=xt(r,i),r=n[0],i=n[1];var a=Mr(r.shape,i.shape);return It.runKernel(function(t,e){var n=t.floorDiv(r,i);return e([r,i]),n},{$a:r,$b:i},function(t,e){var n=e[0],r=e[1];return{$a:function(){var e=t.div(r.toFloat()),i=Fr(n.shape,a);return i.length>0?e.sum(i).reshape(n.shape):e},$b:function(){var e=t.mul(n.toFloat()),i=Fr(r.shape,a);i.length>0&&(e=e.sum(i).reshape(r.shape));var o=r.square();return e.div(o.toFloat()).neg()}}})}}),qs=Qe({maximum_:function(t,e){var n,r=We(t,"a","maximum"),i=We(e,"b","maximum");return n=xt(r,i),r=n[0],i=n[1],"bool"===r.dtype&&(r=r.toInt(),i=i.toInt()),Mr(r.shape,i.shape),It.runKernel(function(t,e){var n=t.maximum(r,i);return e([r,i]),n},{$a:r,$b:i},function(t,e){var n=e[0],r=e[1];return{$a:function(){return t.mul(n.greaterEqual(r).toFloat())},$b:function(){return t.mul(n.less(r).toFloat())}}})}}),Hs=Qe({maximumStrict_:function(t,e){var n=We(t,"a","maximumStrict"),r=We(e,"b","maximumStrict");return d(n.shape,r.shape,"Error in maximumStrict: "),n.maximum(r)}}),Gs=Qe({minimum_:function(t,e){var n,r=We(t,"a","minimum"),i=We(e,"b","minimum");return n=xt(r,i),r=n[0],i=n[1],"bool"===r.dtype&&(r=r.toInt(),i=i.toInt()),Mr(r.shape,i.shape),It.runKernel(function(t,e){var n=t.minimum(r,i);return e([r,i]),n},{$a:r,$b:i},function(t,e){var n=e[0],r=e[1];return{$a:function(){return t.mul(n.lessEqual(r).toFloat())},$b:function(){return t.mul(n.greater(r).toFloat())}}})}}),Ks=Qe({minimumStrict_:function(t,e){var n=We(t,"a","minimumStrict"),r=We(e,"b","minimumStrict");return d(n.shape,r.shape,"Error in minimumStrict: "),n.minimum(r)}}),$s=Qe({mod_:function(t,e){var n,r=We(t,"a","mod"),i=We(e,"b","mod");n=xt(r,i),r=n[0],i=n[1];var a=Mr(r.shape,i.shape);return It.runKernel(function(t,e){var n=t.mod(r,i);return e([r,i]),n},{$a:r,$b:i},function(t,e){var n=e[0],r=e[1];return{$a:function(){var e=Fr(n.shape,a);return e.length>0?t.sum(e).reshape(n.shape):t},$b:function(){var e=t.mul(n.div(r).floor().neg()),i=Fr(r.shape,a);return i.length>0?e.sum(i).reshape(r.shape):e}}})}}),Xs=Qe({modStrict_:function(t,e){var n=We(t,"a","modStrict"),r=We(e,"b","modStrict");return d(n.shape,r.shape,"Error in modStrict: "),n.mod(r)}}),Ys=Qe({mul_:function(t,e){var n,r=We(t,"a","mul"),i=We(e,"b","mul");n=xt(r,i),r=n[0],i=n[1];var a=Mr(r.shape,i.shape);return It.runKernel(function(t,e){var n=t.multiply(r,i);return e([r,i]),n},{$a:r,$b:i},function(t,e){var n=e[0],r=e[1];return{$a:function(){var e=t.mul(r.toFloat()),i=Fr(n.shape,a);return i.length>0?e.sum(i).reshape(n.shape):e},$b:function(){var e=t.mul(n.toFloat()),i=Fr(r.shape,a);return i.length>0?e.sum(i).reshape(r.shape):e}}})}}),Js=Qe({mulStrict_:function(t,e){var n=We(t,"a","mul"),r=We(e,"b","mul");return d(n.shape,r.shape,"Error in multiplyStrict: "),n.mul(r)}}),Zs=Qe({pow_:function(t,e){var n=We(t,"base","pow"),r=We(e,"exp","pow"),i=Mr(n.shape,r.shape);return t=n.cast(yt(n.dtype,r.dtype)),e=r.cast(yt(n.dtype,r.dtype)),It.runKernel(function(t,e){var i=t.pow(n,r);return e([n,r,i]),i},{$base:n,$exp:r},function(t,e){var n=e[0],r=e[1],a=e[2];return{$base:function(){var e=r.toFloat(),a=t.mul(e.mul(n.pow(e.sub(on(1))))),o=Fr(n.shape,i);return o.length>0&&(a=a.sum(o)),a.reshape(n.shape)},$exp:function(){var e=n.greater(0),o=n.log().where(e,bn(n)),s=t.mul(a.mul(o)),u=Fr(r.shape,i);return u.length>0&&(s=s.sum(u)),s.reshape(r.shape)}}})}}),Qs=Qe({powStrict_:function(t,e){return d(t.shape,e.shape,"Error in powStrict: "),t.pow(e)}}),tu=Qe({squaredDifference_:function(t,e){var n,r=We(t,"a","squaredDifference"),i=We(e,"b","squaredDifference");return n=xt(r,i),r=n[0],i=n[1],Mr(r.shape,i.shape),It.runKernel(function(t,e){var n=t.squaredDifference(r,i);return e([r,i]),n},{$a:r,$b:i},function(t,e){var n=e[0],r=e[1],i=on(2);return{$a:function(){return t.mul(n.sub(r).mul(i))},$b:function(){return t.mul(r.sub(n).mul(i))}}})}}),eu=Qe({squaredDifferenceStrict_:function(t,e){var n=We(t,"a","squaredDifferenceStrict"),r=We(e,"b","squaredDifferenceStrict");return d(n.shape,r.shape,"Error in squaredDifferenceStrict: "),n.squaredDifference(r)}}),nu=Qe({sub_:function(t,e){var n,r=We(t,"a","sub"),i=We(e,"b","sub");n=xt(r,i),r=n[0],i=n[1];var a=Mr(r.shape,i.shape);return It.runKernel(function(t){return t.subtract(r,i)},{$a:r,$b:i},function(t){return{$a:function(){var e=t,n=Fr(r.shape,a);return n.length>0&&(e=e.sum(n)),e.reshape(r.shape)},$b:function(){var e=t,n=Fr(i.shape,a);return n.length>0&&(e=e.sum(n)),e.neg().reshape(i.shape)}}})}}),ru=Qe({subStrict_:function(t,e){var n=We(t,"a","subStrict"),r=We(e,"b","subStrict");return d(n.shape,r.shape,"Error in subStrict: "),n.sub(r)}}),iu=Qe({equal_:function(t,e){var n,r=We(t,"a","equal"),i=We(e,"b","equal");return n=xt(r,i),r=n[0],i=n[1],Mr(r.shape,i.shape),It.runKernel(function(t){return t.equal(r,i)},{$a:r,$b:i})}}),au=Qe({equalStrict_:function(t,e){var n=We(t,"a","equalStrict"),r=We(e,"b","equalStrict");return d(n.shape,r.shape,"Error in equalStrict: "),n.equal(r)}}),ou=Qe({greater_:function(t,e){var n,r=We(t,"a","greater"),i=We(e,"b","greater");return n=xt(r,i),r=n[0],i=n[1],Mr(r.shape,i.shape),It.runKernel(function(t){return t.greater(r,i)},{$a:r,$b:i})}}),su=Qe({greaterEqual_:function(t,e){var n,r=We(t,"a","greaterEqual"),i=We(e,"b","greaterEqual");return n=xt(r,i),r=n[0],i=n[1],Mr(r.shape,i.shape),It.runKernel(function(t,e){var n=t.greaterEqual(r,i);return e([r,i]),n},{$a:r,$b:i},function(t,e){var n=e[0],r=e[1];return{$a:function(){return bn(n)},$b:function(){return bn(r)}}})}}),uu=Qe({greaterEqualStrict_:function(t,e){var n=We(t,"a","greaterEqualStrict"),r=We(e,"b","greaterEqualStrict");return d(n.shape,r.shape,"Error in greaterEqualStrict: "),n.greaterEqual(r)}}),lu=Qe({greaterStrict_:function(t,e){var n=We(t,"a","greaterStrict"),r=We(e,"b","greaterStrict");return d(n.shape,r.shape,"Error in greaterStrict: "),n.greater(r)}}),cu=Qe({less_:function(t,e){var n,r=We(t,"a","less"),i=We(e,"b","less");return n=xt(r,i),r=n[0],i=n[1],Mr(r.shape,i.shape),It.runKernel(function(t){return t.less(r,i)},{$a:r,$b:i})}}),pu=Qe({lessEqual_:function(t,e){var n,r=We(t,"a","lessEqual"),i=We(e,"b","lessEqual");return n=xt(r,i),r=n[0],i=n[1],Mr(r.shape,i.shape),It.runKernel(function(t){return t.lessEqual(r,i)},{$a:r,$b:i})}}),hu=Qe({lessEqualStrict_:function(t,e){var n=We(t,"a","lessEqualStrict"),r=We(e,"b","lessEqualStrict");return d(n.shape,r.shape,"Error in lessEqualStrict: "),n.lessEqual(r)}}),fu=Qe({lessStrict_:function(t,e){var n=We(t,"a","lessStrict"),r=We(e,"b","lessStrict");return d(n.shape,r.shape,"Error in lessStrict: "),n.less(r)}}),du=Qe({notEqual_:function(t,e){var n,r=We(t,"a","notEqual"),i=We(e,"b","notEqual");return n=xt(r,i),r=n[0],i=n[1],Mr(r.shape,i.shape),It.runKernel(function(t){return t.notEqual(r,i)},{$a:r,$b:i})}}),mu=Qe({notEqualStrict_:function(t,e){var n=We(t,"a","notEqualStrict"),r=We(e,"b","notEqualStrict");return d(n.shape,r.shape,"Error in notEqualStrict: "),n.notEqual(r)}});function gu(t,e){for(var n=[],r=t;r<e;++r)n.push(r);return n}function vu(t){for(var e=[],n=0;n<t.length;++n)for(var r=0;r<t[n].length;++r)e.push(t[n][r]);return e}var yu=Qe({gather_:function(t,e,n){void 0===n&&(n=0);var r=We(t,"x","gather"),i=We(e,"indices","gather","int32");n=S(n,r.shape)[0];var a=function(t,e,n){for(var r=t.shape[n],i=[],a=1,o=1,s=0;s<n;s++)i.push(t.shape[s]),a*=t.shape[s];for(s=0;s<e.rank;s++)i.push(e.shape[s]);for(s=n+1;s<t.rank;s++)i.push(t.shape[s]),o*=t.shape[s];return{batchSize:a,sliceSize:o,dimSize:r,outputShape:i}}(r,i,n);return It.runKernel(function(t,e){var a=t.gather(r,i.flatten(),n);return e([i]),a},{$x:r},function(t,e){var i=e[0];return{$x:function(){var e=r.shape,a=i.size,o=e.slice(0,n),s=o.length,u=e.slice(n,e.length).slice(1),l=u.length,c=gu(0,s),p=gu(s+1,s+1+l),h=vu([o,[a],u]),f=t.reshape(h),d=i.reshape([a]),m=vu([[s],c,p]),g=f.transpose(m),v=bu(g,d,r.shape[n]),y=Xe(m);return v.transpose(y)}}}).reshape(a.outputShape)}}),bu=Qe({unsortedSegmentSum_:function(t,e,n){var r=We(t,"x","unsortedSegmentSum"),i=We(e,"segmentIds","unsortedSegmentSum","int32");return f(b(n),function(){return"numSegments must be of dtype int"}),It.runKernel(function(t,e){var a=t.unsortedSegmentSum(r,i,n);return e([i]),a},{$x:r},function(t,e){var n=e[0];return{$x:function(){return function(t,e){for(var n=qs(e,bn(e)),r=yu(t,n),i=su(e,on(0,"int32")),a=r.rank-i.rank,o=0;o<a;++o)i=Hn(i,o+1);i=Ds(i,fn(r.shape,"bool"));var s=bn(r);return Ms(i,r,s)}(t,n)}}})}}),xu=function(t,e,n){return r(this,void 0,void 0,function(){var r,a,o,s,u,l,c,p,h,m,g,v,y;return i(this,function(i){switch(i.label){case 0:for(r=We(t,"tensor","boolMask"),a=We(e,"mask","boolMask","bool"),o=null==n?0:n,s=a.rank,u=r.shape,f(s>0,function(){return"mask cannot be scalar"}),d(u.slice(o,o+s),a.shape,"mask's shape must match the first K dimensions of tensor's shape,"),l=1,c=o;c<o+s;c++)l*=u[c];return p=u.slice(0,o).concat([l],u.slice(o+s)),h=r.reshape(p),m=a.reshape([-1]),[4,zs(m)];case 1:return g=i.sent(),v=g.squeeze([1]),y=yu(h,v,o),t!==r&&r.dispose(),e!==a&&a.dispose(),v.dispose(),h.dispose(),m.dispose(),g.dispose(),[2,y]}})})};function wu(t,e,n,r,i,a,o){void 0===a&&(a="NHWC"),f(t.length===e.rank,function(){return"Length of inShape ("+t.length+") and rank of dy ("+e.rank+") must match"});var s=t,u=e,l=!1;3===e.rank&&(l=!0,u=e.as4D(1,e.shape[0],e.shape[1],e.shape[2]),s=[1,t[0],t[1],t[2]]),f(4===s.length,function(){return"Error in conv2dDerInput: inShape must be length 4, but got length "+s.length+"."}),f(4===u.rank,function(){return"Error in conv2dDerInput: dy must be rank 4, but got rank "+u.rank}),f(4===n.rank,function(){return"Error in conv2dDerInput: filter must be rank 4, but got rank "+n.rank});var c="NHWC"===a?s[3]:s[1],p="NHWC"===a?u.shape[3]:u.shape[1];f(c===n.shape[2],function(){return"Error in conv2dDerInput: depth of input ("+c+") must match input depth for filter "+n.shape[2]+"."}),f(p===n.shape[3],function(){return"Error in conv2dDerInput: depth of output ("+p+") must match output depth for filter "+n.shape[3]+"."}),null!=o&&f(b(i),function(){return"Error in conv2dDerInput: pad must be an integer when using, dimRoundingMode "+o+" but got pad "+i+"."});var h=Kr(a),d=Pr(s,n.shape,r,1,i,o,!1,h),m=It.runKernel(function(t,e){var r=t.conv2dDerInput(u,n,d);return e([n,u]),r},{dy4D:u,filter:n},function(t,e){var n=e[0],s=e[1];return{dy4D:function(){return ku(t,n,r,i,a,1,o)},filter:function(){return Au(t,s,n.shape,r,i,a,o)}}});return l?m.as3D(m.shape[1],m.shape[2],m.shape[3]):m}function Nu(t,e,n,r,i,a,o){void 0===a&&(a="NHWC");var s=t;3===t.rank&&(s=t.as4D(1,t.shape[0],t.shape[1],t.shape[2]));var u=e;3===u.rank&&(u=e.as4D(1,e.shape[0],e.shape[1],e.shape[2])),f(4===s.rank,function(){return"Error in conv2dDerFilter: input must be rank 4, but got shape "+s.shape+"."}),f(4===u.rank,function(){return"Error in conv2dDerFilter: dy must be rank 4, but got shape "+u.shape+"."}),f(4===n.length,function(){return"Error in conv2dDerFilter: filterShape must be length 4, but got "+n+"."});var l="NHWC"===a?s.shape[3]:s.shape[1],c="NHWC"===a?u.shape[3]:u.shape[1];f(l===n[2],function(){return"Error in conv2dDerFilter: depth of input "+l+") must match input depth in filter ("+n[2]+"."}),f(c===n[3],function(){return"Error in conv2dDerFilter: depth of dy ("+c+") must match output depth for filter ("+n[3]+")."}),null!=o&&f(b(i),function(){return"Error in conv2dDerFilter: pad must be an integer when using, dimRoundingMode "+o+" but got pad "+i+"."});var p=Kr(a),h=Pr(s.shape,n,r,1,i,o,!1,p);return It.runKernel(function(t){return t.conv2dDerFilter(s,u,h)},{x4D:s,dy4D:u})}function Cu(t){var e=function(t){return"number"==typeof t?[t,t,t]:2===t.length?[t[0],t[1],1]:t}(t),n=e[0],r=e[1],i=e[2];return 1===n&&1===r&&1===i}function Eu(t,e,n,r,i){f(t.length===e.rank,function(){return"Length of inShape ("+t.length+") and rank of dy ("+e.rank+") must match"});var a=t,o=e,s=!1;4===e.rank&&(s=!0,o=e.as5D(1,e.shape[0],e.shape[1],e.shape[2],e.shape[3]),a=[1,t[0],t[1],t[2],t[3]]);var u=a[4],l=o.shape[4];f(5===a.length,function(){return"Error in conv3dDerInput: inShape must be length 5, but got length "+a.length+"."}),f(5===o.rank,function(){return"Error in conv3dDerInput: dy must be rank 5, but got rank "+o.rank}),f(5===n.rank,function(){return"Error in conv3dDerInput: filter must be rank 5, but got rank "+n.rank}),f(u===n.shape[3],function(){return"Error in conv3dDerInput: depth of input ("+u+") must match input depth for filter "+n.shape[3]+"."}),f(l===n.shape[4],function(){return"Error in conv3dDerInput: depth of output ("+l+") must match output depth for filter "+n.shape[4]+"."});var c=Br(a,n.shape,r,1,i),p=It.runKernel(function(t){return t.conv3dDerInput(o,n,c)},{dy5D:o});return s?p.as4D(p.shape[1],p.shape[2],p.shape[3],p.shape[4]):p}var Su=Qe({conv1d_:function(t,e,n,r,i,a,o){void 0===i&&(i="NWC"),void 0===a&&(a=1);var s=We(t,"x","conv1d"),u=We(e,"filter","conv1d"),l=s,c=!1;2===s.rank&&(c=!0,l=s.as3D(1,s.shape[0],s.shape[1])),f(3===l.rank,function(){return"Error in conv1d: input must be rank 3, but got rank "+l.rank+"."}),f(3===u.rank,function(){return"Error in conv1d: filter must be rank 3, but got rank "+u.rank+"."}),null!=o&&f(b(r),function(){return"Error in conv1d: pad must be an integer when using, dimRoundingMode "+o+" but got pad "+r+"."}),f(l.shape[2]===u.shape[1],function(){return"Error in conv1d: depth of input ("+l.shape[2]+") must match input depth for filter "+u.shape[1]+"."}),f(Gr(n,a),function(){return"Error in conv1D: Either stride or dilation must be 1. Got stride "+n+" and dilation '"+a+"'"}),f("NWC"===i,function(){return"Error in conv1d: got dataFormat of "+i+" but only NWC is currently supported."});var p=u.as4D(1,u.shape[0],u.shape[1],u.shape[2]),h=l.as4D(l.shape[0],1,l.shape[1],l.shape[2]),d=ku(h,p,[1,n],r,"NHWC",[1,a],o);return c?d.as2D(d.shape[2],d.shape[3]):d.as3D(d.shape[0],d.shape[2],d.shape[3])}}),ku=Qe({conv2d_:function(t,e,n,r,i,a,o){void 0===i&&(i="NHWC"),void 0===a&&(a=[1,1]);var s=We(t,"x","conv2d"),u=We(e,"filter","conv2d"),l=s,c=!1;3===s.rank&&(c=!0,l=s.as4D(1,s.shape[0],s.shape[1],s.shape[2])),f(4===l.rank,function(){return"Error in conv2d: input must be rank 4, but got rank "+l.rank+"."}),f(4===u.rank,function(){return"Error in conv2d: filter must be rank 4, but got rank "+u.rank+"."}),null!=o&&f(b(r),function(){return"Error in conv2d: pad must be an integer when using, dimRoundingMode "+o+" but got pad "+r+"."});var p="NHWC"===i?l.shape[3]:l.shape[1];f(p===u.shape[2],function(){return"Error in conv2d: depth of input ("+p+") must match input depth for filter "+u.shape[2]+"."}),f(Gr(n,a),function(){return"Error in conv2D: Either strides or dilations must be 1. Got strides "+n+" and dilations '"+a+"'"});var h=Kr(i),d=Pr(l.shape,u.shape,n,a,r,o,!1,h),m=It.runKernel(function(t,e){var n=t.conv2d(l,u,d);return e([u,l]),n},{x:l,$filter:u},function(t,e){var o=e,s=o[0],u=o[1];return f(Hr(a),function(){return"Error in gradient of conv2D: dilation rates greater than 1 are not yet supported in gradients. Got dilations '"+a+"'"}),{x:function(){return wu(u.shape,t,s,n,r,i)},$filter:function(){return Nu(u,t,s.shape,n,r,i)}}});return c?m.as3D(m.shape[1],m.shape[2],m.shape[3]):m}}),Iu=Qe({conv3d_:function(t,e,n,r,i,a){void 0===i&&(i="NDHWC"),void 0===a&&(a=[1,1,1]);var o=We(t,"x","conv3d"),s=We(e,"filter","conv3d"),u=o,l=!1;4===o.rank&&(l=!0,u=o.as5D(1,o.shape[0],o.shape[1],o.shape[2],o.shape[3])),f(5===u.rank,function(){return"Error in conv3d: input must be rank 5, but got rank "+u.rank+"."}),f(5===s.rank,function(){return"Error in conv3d: filter must be rank 5, but got rank "+s.rank+"."}),f(u.shape[4]===s.shape[3],function(){return"Error in conv3d: depth of input ("+u.shape[4]+") must match input depth for filter "+s.shape[3]+"."}),f(function(t,e){return Cu(n)||Cu(e)}(0,a),function(){return"Error in conv3D: Either strides or dilations must be 1. Got strides "+n+" and dilations '"+a+"'"}),f("NDHWC"===i,function(){return"Error in conv3d: got dataFormat of "+i+" but only NDHWC is currently supported."});var c=Br(u.shape,s.shape,n,a,r),p=It.runKernel(function(t,e){var n=t.conv3d(u,s,c);return e([u,s]),n},{x:u,$filter:s},function(t,e){f(Cu(a),function(){return"Error in gradient of conv3D: dilation rates greater than 1 are not yet supported in gradients. Got dilations '"+a+"'"});var i=e[0],o=e[1];return{x:function(){return Eu(i.shape,t,o,n,r)},$filter:function(){return function(t,e,n,r,i){var a=t;4===t.rank&&(a=t.as5D(1,t.shape[0],t.shape[1],t.shape[2],t.shape[3]));var o=e;4===o.rank&&(o=e.as5D(1,e.shape[0],e.shape[1],e.shape[2],e.shape[3])),f(5===a.rank,function(){return"Error in conv3dDerFilter: input must be rank 5, but got shape "+a.shape+"."}),f(5===o.rank,function(){return"Error in conv3dDerFilter: dy must be rank 5, but got shape "+o.shape+"."}),f(5===n.length,function(){return"Error in conv3dDerFilter: filterShape must be length 5, but got "+n+"."}),f(a.shape[4]===n[3],function(){return"Error in conv3dDerFilter: depth of input "+a.shape[4]+") must match input depth in filter ("+n[3]+"."}),f(o.shape[4]===n[4],function(){return"Error in conv3dDerFilter: depth of dy ("+o.shape[4]+") must match output depth for filter ("+n[4]+")."});var s=Br(a.shape,n,r,1,i);return It.runKernel(function(t){return t.conv3dDerFilter(a,o,s)},{x5D:a,dy5D:o})}(i,t,o.shape,n,r)}}});return l?p.as4D(p.shape[1],p.shape[2],p.shape[3],p.shape[4]):p}}),Au=Qe({conv2dDerFilter_:Nu}),Ru=Qe({conv2dDerInput_:wu}),Tu=Qe({depthwiseConv2d_:function(t,e,n,r,i,a,o){void 0===i&&(i="NHWC"),void 0===a&&(a=[1,1]);var s=We(t,"x","depthwiseConv2d"),u=We(e,"filter","depthwiseConv2d"),l=s,c=!1;3===s.rank&&(c=!0,l=s.as4D(1,s.shape[0],s.shape[1],s.shape[2])),f(4===l.rank,function(){return"Error in depthwiseConv2d: input must be rank 4, but got rank "+l.rank+"."}),f(4===u.rank,function(){return"Error in depthwiseConv2d: filter must be rank 4, but got rank "+u.rank+"."}),f(l.shape[3]===u.shape[2],function(){return"Error in depthwiseConv2d: number of input channels ("+l.shape[3]+") must match the inChannels dimension in filter "+u.shape[2]+"."}),null==a&&(a=[1,1]),f(Gr(n,a),function(){return"Error in depthwiseConv2d: Either strides or dilations must be 1. Got strides "+n+" and dilations '"+a+"'"}),null!=o&&f(b(r),function(){return"Error in depthwiseConv2d: pad must be an integer when using, dimRoundingMode "+o+" but got pad "+r+"."});var p=Pr(l.shape,u.shape,n,a,r,o,!0),h=It.runKernel(function(t,e){var n=t.depthwiseConv2D(l,u,p);return e([l,u]),n},{x:l,$filter:u},function(t,e){f(Hr(a),function(){return"Error in gradient of depthwiseConv2d: dilation rates greater than 1 are not yet supported. Got dilations '"+a+"'"});var n=e[0],r=e[1];return{x:function(){return function(t,e,n,r){var i=e,a=!1;3===e.rank&&(a=!0,i=e.as4D(1,e.shape[0],e.shape[1],e.shape[2]));var o=It.runKernel(function(t){return t.depthwiseConv2DDerInput(i,n,r)},{dy4D:i});return a?o.as3D(o.shape[1],o.shape[2],o.shape[3]):o}(n.shape,t,r,p)},$filter:function(){return function(t,e,n,r){var i=t;3===t.rank&&(i=t.as4D(1,t.shape[0],t.shape[1],t.shape[2]));var a=e;return 3===a.rank&&(a=e.as4D(1,e.shape[0],e.shape[1],e.shape[2])),It.runKernel(function(t){return t.depthwiseConv2DDerFilter(i,a,r)},{x4D:i,dy4D:a})}(n,t,r.shape,p)}}});return c?h.as3D(h.shape[1],h.shape[2],h.shape[3]):h}}),Du=Qe({separableConv2d_:function(t,e,n,r,i,a,o){void 0===a&&(a=[1,1]),void 0===o&&(o="NHWC");var s=We(t,"x","separableConv2d"),u=We(e,"depthwiseFilter","separableConv2d"),l=We(n,"pointwiseFilter","separableConv2d"),c=s,p=!1;if(3===s.rank&&(p=!0,c=s.as4D(1,s.shape[0],s.shape[1],s.shape[2])),"NCHW"===o)throw new Error("separableConv2d currently does not support dataFormat NCHW; only NHWC is supported");f(4===c.rank,function(){return"Error in separableConv2d: input must be rank 4, but got rank "+c.rank+"."}),f(4===u.rank,function(){return"Error in separableConv2d: depthwise filter must be rank 4, but got rank "+u.rank+"."}),f(4===l.rank,function(){return"Error in separableConv2d: pointwise filter must be rank 4, but got rank "+u.rank+"."}),f(1===l.shape[0],function(){return"Error in separableConv2d: the first dimension of pointwise filter  must be 1, but got "+l.shape[0]+"."}),f(1===l.shape[1],function(){return"Error in separableConv2d: the second dimension of pointwise filter must be 1, but got "+l.shape[1]+"."});var h=u.shape[2],d=u.shape[3];f(l.shape[2]===h*d,function(){return"Error in separableConv2d: the third dimension of pointwise filter must be "+h*d+", but got "+l.shape[2]+"."});var m=Tu(c,u,r,i,o,a),g=ku(m,l,1,"valid",o);return p?g.as3D(g.shape[1],g.shape[2],g.shape[3]):g}}),Ou=Qe({conv2dTranspose_:function(t,e,n,r,i,a){return wu(n,We(t,"x","conv2dTranspose"),We(e,"filter","conv2dTranspose"),r,i,"NHWC",a)}}),_u=Qe({conv3dTranspose_:function(t,e,n,r,i){return Eu(n,We(t,"x","conv3dTranspose"),We(e,"filter","conv3dTranspose"),r,i)}}),Fu=Qe({matMul_:function(t,e,n,r){var i;void 0===n&&(n=!1),void 0===r&&(r=!1);var a=We(t,"a","matMul"),o=We(e,"b","matMul");i=xt(a,o),a=i[0],o=i[1];var s=n?a.shape[a.rank-2]:a.shape[a.rank-1],u=r?o.shape[o.rank-1]:o.shape[o.rank-2],l=n?a.shape[a.rank-1]:a.shape[a.rank-2],c=r?o.shape[o.rank-2]:o.shape[o.rank-1],p=a.shape.slice(0,-2),h=o.shape.slice(0,-2),d=v(p),m=v(h);f(a.rank>=2&&o.rank>=2&&a.rank===o.rank,function(){return"Error in matMul: inputs must have the same rank of at least 2, got ranks "+a.rank+" and "+o.rank+"."}),f(y(p,h),function(){return"Error in matMul: outer dimensions ("+p+") and ("+h+") of Tensors with shapes "+a.shape+" and "+o.shape+" must match."}),f(s===u,function(){return"Error in matMul: inner shapes ("+s+") and ("+u+") of Tensors with shapes "+a.shape+" and "+o.shape+" and transposeA="+n+" and transposeB="+r+" must match."});var g=a.shape.slice(0,-2).concat([l,c]),b=n?a.as3D(d,s,l):a.as3D(d,l,s),x=r?o.as3D(m,c,u):o.as3D(m,u,c);return It.runKernel(function(t,e){var i=t.batchMatMul(b,x,n,r);return e([b,x]),i},{$a:b,$b:x},function(t,e){var i=e,a=i[0],o=i[1];return n||r?!n&&r?{$a:function(){return t.matMul(o,!1,!1)},$b:function(){return t.matMul(a,!0,!1)}}:n&&!r?{$a:function(){return o.matMul(t,!1,!0)},$b:function(){return a.matMul(t,!1,!1)}}:{$a:function(){return o.matMul(t,!0,!0)},$b:function(){return t.matMul(a,!0,!0)}}:{$a:function(){return t.matMul(o,!1,!0)},$b:function(){return a.matMul(t,!0,!1)}}}).reshape(g)}}),Mu=Qe({dot_:function(t,e){var n=We(t,"t1","dot"),r=We(e,"t2","dot");f(!(1!==n.rank&&2!==n.rank||1!==r.rank&&2!==r.rank),function(){return"Error in dot: inputs must all be rank 1 or 2, but got ranks "+n.rank+" and "+r.rank+"."});var i=1===n.rank?n.size:n.shape[1],a=1===r.rank?r.size:r.shape[0];return f(i===a,function(){return"Error in dot: inner dimensions of inputs must match, but got "+i+" and "+a+"."}),1===n.rank&&1===r.rank?n.as2D(1,-1).matMul(r.as2D(-1,1)).asScalar():1===n.rank&&2===r.rank?n.as2D(1,-1).matMul(r.as2D(r.shape[0],r.shape[1])).as1D():2===n.rank&&1===r.rank?n.matMul(r.as2D(-1,1)).as1D():n.matMul(r.as2D(r.shape[0],r.shape[1]))}}),zu=Qe({outerProduct_:function(t,e){var n=We(t,"v1","outerProduct"),r=We(e,"v2","outerProduct");return f(1===n.rank&&1===r.rank,function(){return"Error in outerProduct: inputs must be rank 1, but got ranks "+n.rank+" and "+r.rank+"."}),n.as2D(-1,1).matMul(r.as2D(1,-1))}}),Lu=Qe({reverse_:function(t,e){var n=We(t,"x","reverse");if(0===n.rank)return n.clone();var r=S(e,n.shape);return It.runKernel(function(t){return t.reverse(n,r)},{$x:n},function(t){return{$x:function(){return t.reverse(r)}}}).reshapeAs(n)}}),Pu=Qe({reverse1d_:function(t){var e=We(t,"x","reverse");return f(1===e.rank,function(){return"Error in reverse1D: x must be rank 1 but got rank "+e.rank+"."}),Lu(e,0)}}),Bu=Qe({reverse2d_:function(t,e){var n=We(t,"x","reverse");return f(2===n.rank,function(){return"Error in reverse2D: x must be rank 2 but got rank "+n.rank+"."}),Lu(n,e)}}),Vu=Qe({reverse3d_:function(t,e){var n=We(t,"x","reverse");return f(3===n.rank,function(){return"Error in reverse3D: x must be rank 3 but got rank "+n.rank+"."}),Lu(n,e)}}),Wu=Qe({reverse4d_:function(t,e){var n=We(t,"x","reverse");return f(4===n.rank,function(){return"Error in reverse4D: x must be rank 4 but got rank "+n.rank+"."}),Lu(n,e)}});function Uu(t,e,n,r,i,a){var o=We(t,"x","maxPool"),s=o,u=!1;3===o.rank&&(u=!0,s=o.as4D(1,o.shape[0],o.shape[1],o.shape[2])),null==r&&(r=[1,1]),f(4===s.rank,function(){return"Error in maxPool: input must be rank 4 but got rank "+s.rank+"."}),f(Gr(n,r),function(){return"Error in maxPool: Either strides or dilations must be 1. Got strides "+n+" and dilations '"+r+"'"}),null!=a&&f(b(i),function(){return"Error in maxPool: pad must be an integer when using, dimRoundingMode "+a+" but got pad "+i+"."});var l=zr(s.shape,e,n,r,i,a),c=It.runKernel(function(t,e){var n=t.maxPool(s,l);return e([s,n]),n},{x:s},function(t,a){var o=a[0],s=a[1];return{x:function(){return function(t,e,n,r,i,a,o,s){var u=We(t,"dy","maxPoolBackprop"),l=We(e,"input","maxPoolBackprop"),c=We(n,"output","maxPoolBackprop");f(l.rank===u.rank,function(){return"Rank of input ("+l.rank+") does not match rank of dy ("+u.rank+")"}),null==a&&(a=[1,1]),f(Gr(i,a),function(){return"Error in maxPoolBackProp: Either strides or dilations must be 1. Got strides "+i+" and dilations '"+a+"'"}),f(4===u.rank,function(){return"Error in maxPoolBackprop: dy must be rank 4 but got rank "+u.rank+"."}),f(4===l.rank,function(){return"Error in maxPoolBackprop: input must be rank 4 but got rank "+l.rank+"."});var p=zr(l.shape,r,i,a,o,s);return It.runKernel(function(t){return t.maxPoolBackprop(u,l,c,p)},{$dy:u,$input:l})}(t,o,s,e,n,r,i)}}});return u?c.as3D(c.shape[1],c.shape[2],c.shape[3]):c}function ju(t,e,n,r,i,a){var o=We(t,"x","avgPool","float32");null==r&&(r=[1,1]),f(Gr(n,r),function(){return"Error in avgPool: Either strides or dilations must be 1. Got strides "+n+" and dilations '"+r+"'"});var s=o,u=!1;3===o.rank&&(u=!0,s=o.as4D(1,o.shape[0],o.shape[1],o.shape[2])),f(4===s.rank,function(){return"Error in avgPool: x must be rank 4 but got rank "+s.rank+"."}),null!=a&&f(b(i),function(){return"Error in avgPool: pad must be an integer when using, dimRoundingMode "+a+" but got pad "+i+"."});var l=zr(s.shape,e,n,r,i,a),c=It.runKernel(function(t){return t.avgPool(s,l)},{x:s},function(t){return{x:function(){return function(t,e,n,r,i,a){var o=We(t,"dy","avgPoolBackprop"),s=We(e,"input","avgPoolBackprop");f(s.rank===o.rank,function(){return"Rank of input ("+s.rank+") does not match rank of dy ("+o.rank+")"}),null==i&&(i=[1,1]),f(Gr(r,i),function(){return"Error in avgPoolBackprop: Either strides or dilations must be 1. Got strides "+r+" and dilations '"+i+"'"});var u=s,l=o,c=!1;3===s.rank&&(c=!0,u=s.as4D(1,s.shape[0],s.shape[1],s.shape[2]),l=o.as4D(1,o.shape[0],o.shape[1],o.shape[2])),f(4===l.rank,function(){return"Error in avgPoolBackprop: dy must be rank 4 but got rank "+l.rank+"."}),f(4===u.rank,function(){return"Error in avgPoolBackprop: input must be rank 4 but got rank "+u.rank+"."});var p=zr(u.shape,n,r,i,a),h=It.runKernel(function(t){return t.avgPoolBackprop(l,u,p)},{dy4D:l,input4D:u});return c?h.as3D(h.shape[1],h.shape[2],h.shape[3]):h}(t,s,e,n,r,i)}}});return c=c.cast(o.dtype),u?c.as3D(c.shape[1],c.shape[2],c.shape[3]):c}var qu=Qe({maxPool_:function(t,e,n,r,i){return Uu(t,e,n,1,r,i)}}),Hu=Qe({avgPool_:function(t,e,n,r,i){return ju(t,e,n,1,r,i)}}),Gu=Qe({pool_:function(t,e,n,r,i,a){null==i&&(i=[1,1]),null==a&&(a=1),0===r&&(r="valid");var o=We(t,"x","maxPool"),s=o,u=!1;3===o.rank&&(u=!0,s=o.as4D(1,o.shape[0],o.shape[1],o.shape[2])),f(Gr(a,i),function(){return"Error in pool: Either strides or dilations must be 1. Got strides "+a+" and dilations '"+i+"'"});var l,c=zr(s.shape,e,a,i,r),p=[c.dilationHeight,c.dilationWidth];l="same"===r?function(t,e){var n=t.map(function(t,n){return t+(t-1)*(e[n]-1)}).map(function(t){return t-1}),r=n.map(function(t){return Math.floor(t/2)}),i=n.map(function(t,e){return t-r[e]});return n.map(function(t,e){return[r[e],i[e]]})}([c.filterHeight,c.filterWidth],p):[[0,0],[0,0]];var h=1===p[0]&&1===p[1],d=function(t,e,n){var r=n.map(function(t){return t[0]}),i=n.map(function(t){return t[1]}),a=t.concat(r,i),o=e.map(function(t,e){return(t-a[e]%t)%t}),s=i.map(function(t,e){return t+o[e]});return[e.map(function(t,e){return[r[e],s[e]]}),e.map(function(t,e){return[0,o[e]]})]}([c.inHeight,c.inWidth],p,l),m=d[0],g=d[1],v=h?r:"valid",y=h?s:ar(s,p,m),b=("avg"===n?function(){return ju(y,e,a,1,v)}:function(){return Uu(y,e,a,1,v)})(),x=h?b:Vn(b,p,g);return u?x.as3D(x.shape[1],x.shape[2],x.shape[3]):x}}),Ku=Qe({maxPool3d_:function(t,e,n,r,i,a,o){void 0===a&&(a="NDHWC");var s=We(t,"x","maxPool3d"),u=s,l=!1;4===s.rank&&(l=!0,u=s.as5D(1,s.shape[0],s.shape[1],s.shape[2],s.shape[3])),null==o&&(o=[1,1,1]),f(5===u.rank,function(){return"Error in maxPool3d: x must be rank 5 but got rank "+u.rank+"."}),f("NDHWC"===a,function(){return"Error in maxPool3d: Only NDHWC is currently supported, but got dataFormat of "+a}),f(Gr(n,o),function(){return"Error in maxPool3d: Either strides or dilations must be 1. Got strides "+n+" and dilations '"+o+"'"}),null!=i&&f(b(r),function(){return"Error in maxPool3d: pad must be an integer when using, dimRoundingMode "+i+" but got pad "+r+"."});var c=Lr(u.shape,e,n,o,r,i,a),p=It.runKernel(function(t,e){var n=t.maxPool3d(u,c);return e([u,n]),n},{x:u},function(t,a){var s=a[0],u=a[1];return{x:function(){return function(t,e,n,r,i,a,o,s){var u=We(t,"dy","maxPool3dBackprop"),l=We(e,"input","maxPool3dBackprop"),c=We(n,"output","maxPool3dBackprop"),p=u,h=l,d=c,m=!1;4===l.rank&&(m=!0,p=u.as5D(1,u.shape[0],u.shape[1],u.shape[2],u.shape[3]),h=l.as5D(1,l.shape[0],l.shape[1],l.shape[2],l.shape[3]),d=c.as5D(1,c.shape[0],c.shape[1],c.shape[2],c.shape[3])),f(5===p.rank,function(){return"Error in maxPool3dBackprop: dy must be rank 5 but got rank "+p.rank+"."}),f(5===h.rank,function(){return"Error in maxPool3dBackprop: input must be rank 5 but got rank "+h.rank+"."}),f(5===d.rank,function(){return"Error in maxPool3dBackprop: output must be rank 5 but got rank "+d.rank+"."}),null==a&&(a=[1,1,1]),f(Gr(i,a),function(){return"Error in maxPool3dBackprop: Either strides or dilations must be 1. Got strides "+i+" and dilations '"+a+"'"}),null!=s&&f(b(o),function(){return"Error in maxPool3dBackprop: pad must be an integer when using, dimRoundingMode "+s+" but got pad "+o+"."});var g=Lr(h.shape,r,i,a,o,s),v=It.runKernel(function(t){return t.maxPool3dBackprop(p,h,d,g)},{dy5D:p,input5D:h});return m?v.as4D(v.shape[1],v.shape[2],v.shape[3],v.shape[4]):v}(t,s,u,e,n,o,r,i)}}});return l?p.as4D(p.shape[1],p.shape[2],p.shape[3],p.shape[4]):p}}),$u=Qe({avgPool3d_:function(t,e,n,r,i,a,o){void 0===a&&(a="NDHWC");var s=We(t,"x","avgPool3d","float32"),u=s,l=!1;4===s.rank&&(l=!0,u=s.as5D(1,s.shape[0],s.shape[1],s.shape[2],s.shape[3])),null==o&&(o=[1,1,1]),f(5===u.rank,function(){return"Error in avgPool3d: x must be rank 5 but got rank "+u.rank+"."}),f("NDHWC"===a,function(){return"Error in avgPool3d: Only NDHWC is currently supported, but got dataFormat of "+a}),f(Gr(n,o),function(){return"Error in avgPool3d: Either strides or dilations must be 1. Got strides "+n+" and dilations '"+o+"'"}),null!=i&&f(b(r),function(){return"Error in avgPool3d: pad must be an integer when using, dimRoundingMode "+i+" but got pad "+r+"."});var c=Lr(u.shape,e,n,o,r,i,a),p=It.runKernel(function(t){return t.avgPool3d(u,c)},{x:u},function(t){return{x:function(){return function(t,e,n,r,i,a,o){var s=We(t,"dy","avgPool3dBackprop"),u=We(e,"input","avgPool3dBackprop"),l=s,c=u,p=!1;4===u.rank&&(p=!0,l=s.as5D(1,s.shape[0],s.shape[1],s.shape[2],s.shape[3]),c=u.as5D(1,u.shape[0],u.shape[1],u.shape[2],u.shape[3])),f(5===l.rank,function(){return"Error in avgPool3dBackprop: dy must be rank 5 but got rank "+l.rank+"."}),f(5===c.rank,function(){return"Error in avgPool3dBackprop: input must be rank 5 but got rank "+c.rank+"."}),null==i&&(i=[1,1,1]),f(Gr(r,i),function(){return"Error in avgPool3dBackprop: Either strides or dilations must be 1. Got strides "+r+" and dilations '"+i+"'"}),null!=o&&f(b(a),function(){return"Error in maxPool3dBackprop: pad must be an integer when using, dimRoundingMode "+o+" but got pad "+a+"."});var h=Lr(c.shape,n,r,i,a,o),d=It.runKernel(function(t){return t.avgPool3dBackprop(l,c,h)},{dy5D:l,input5D:c});return p?d.as4D(d.shape[1],d.shape[2],d.shape[3],d.shape[4]):d}(t,u,e,n,o,r,i)}}});return p=p.cast(u.dtype),l?p.as4D(p.shape[1],p.shape[2],p.shape[3],p.shape[4]):p}}),Xu=Qe({slice_:function(t,e,n){var r,i,a=We(t,"x","slice");if(0===a.rank)throw new Error("Slicing scalar is not possible");r="number"==typeof e?[e].concat(new Array(a.rank-1).fill(0)):e.length<a.rank?e.concat(new Array(a.rank-e.length).fill(0)):e.slice(),i=(i=null==n?new Array(a.rank).fill(-1):"number"==typeof n?[n].concat(new Array(a.rank-1).fill(-1)):n.length<a.rank?n.concat(new Array(a.rank-n.length).fill(-1)):n).map(function(t,e){return t>=0?t:(f(-1===t,function(){return"Bad value in size"}),a.shape[e]-r[e])}),function(t,e,n){f(t.rank===e.length,function(){return"Error in slice"+t.rank+"D: Length of begin "+e+" must match the rank of the array ("+t.rank+")."}),f(t.rank===n.length,function(){return"Error in slice"+t.rank+"D: Length of size "+n+" must match the rank of the array ("+t.rank+")."});for(var r=function(r){f(e[r]+n[r]<=t.shape[r],function(){return"Error in slice"+t.rank+"D: begin["+r+"] + size["+r+"] ("+(e[r]+n[r])+") would overflow input.shape["+r+"] ("+t.shape[r]+")"})},i=0;i<t.rank;++i)r(i)}(a,r,i);var o=a.shape;return It.runKernel(function(t){return t.slice(a,r,i)},{$x:a},function(t){for(var e=[],n=0;n<t.rank;n++)e.push([r[n],o[n]-r[n]-i[n]]);return{$x:function(){return t.pad(e)}}})}}),Yu=Qe({slice1d_:function(t,e,n){var r=We(t,"x","slice1d");return f(1===r.rank,function(){return"slice1d expects a rank-1 tensor, but got a rank-"+r.rank+" tensor"}),Xu(r,[e],[n])}}),Ju=Qe({slice2d_:function(t,e,n){var r=We(t,"x","slice2d");return f(2===r.rank,function(){return"slice2d expects a rank-2 tensor, but got a rank-"+r.rank+" tensor"}),Xu(r,e,n)}}),Zu=Qe({slice3d_:function(t,e,n){var r=We(t,"x","slice3d");return f(3===r.rank,function(){return"slice3d expects a rank-3 tensor, but got a rank-"+r.rank+" tensor"}),Xu(r,e,n)}}),Qu=Qe({slice4d_:function(t,e,n){var r=We(t,"x","slice4d");return f(4===r.rank,function(){return"slice4d expects a rank-4 tensor, but got a rank-"+r.rank+" tensor"}),Xu(r,e,n)}});function tl(t,e,n,r,i){return e.rank<n.rank&&(e=e.reshape(Ge(e.shape,r))),t.rank<n.rank&&(t=t.reshape(Ge(t.shape,r))),{$x:function(){var r=t.mul(n.equal(e).cast(t.dtype));return null==i?r:r.transpose(i)}}}var el=Qe({all_:function(t,e,n){void 0===e&&(e=null),void 0===n&&(n=!1);var r=We(t,"x","all","bool"),i=S(e,r.shape),a=i,o=$e(a,r.rank);null!=o&&(r=r.transpose(o),a=Ye(a.length,r.rank));var s=It.runKernel(function(t){return t.all(r,a)},{$x:r});if(n){var u=Ge(s.shape,i);return s.reshape(u)}return s}}),nl=Qe({any_:function(t,e,n){void 0===e&&(e=null),void 0===n&&(n=!1);var r=We(t,"x","any","bool"),i=S(e,r.shape),a=i,o=$e(a,r.rank);null!=o&&(r=r.transpose(o),a=Ye(a.length,r.rank));var s=It.runKernel(function(t){return t.any(r,a)},{$x:r});if(n){var u=Ge(s.shape,i);return s.reshape(u)}return s}}),rl=Qe({argMax_:function(t,e){void 0===e&&(e=0);var n=We(t,"x","argMax");null==e&&(e=0);var r=S(e,n.shape),i=$e(r,n.rank);return null!=i&&(n=n.transpose(i),r=Ye(r.length,n.rank)),It.runKernel(function(t,e){var i=t.argMax(n,r[0]);return e([n]),i},{$x:n},function(t,e){var n=e[0];return{$x:function(){return bn(n)}}})}}),il=Qe({argMin_:function(t,e){void 0===e&&(e=0);var n=We(t,"x","argMin");null==e&&(e=0);var r=S(e,n.shape),i=$e(r,n.rank);return null!=i&&(n=n.transpose(i),r=Ye(r.length,n.rank)),It.runKernel(function(t,e){var i=t.argMin(n,r[0]);return e([n]),i},{$x:n},function(t,e){var n=e[0];return{$x:function(){return bn(n)}}})}}),al=Qe({logSumExp_:function(t,e,n){void 0===e&&(e=null),void 0===n&&(n=!1);var r=We(t,"x","logSumExp"),i=S(e,r.shape),a=r.max(i,!0),o=r.sub(a).exp().sum(i).log(),s=a.reshape(o.shape).add(o);if(n){var u=Ge(s.shape,i);return s.reshape(u)}return s}}),ol=Qe({max_:function(t,e,n){void 0===e&&(e=null),void 0===n&&(n=!1);var r=We(t,"x","max"),i=r,a=S(e,r.shape),o=a,s=$e(o,r.rank);null!=s&&(r=r.transpose(s),o=Ye(o.length,r.rank));var u=It.runKernel(function(t,e){var n=t.max(r,o);return e([i,n]),n},{$x:r},function(t,e){return tl(t,e[1],e[0],a,s)});if(n){var l=Ge(u.shape,a);u=u.reshape(l)}return u}}),sl=Qe({mean_:function(t,e,n){void 0===e&&(e=null),void 0===n&&(n=!1);var r=We(t,"x","mean"),i=S(e,r.shape),a=v(He(r.shape,i)[1]);return Ir(function(t){var r=on(a);return{value:(r.dtype===t.dtype?t:t.cast(r.dtype)).div(r).sum(e,n),gradFunc:function(e){var n=t.shape.slice();return i.forEach(function(t){n[t]=1}),e.reshape(n).mul(fn(t.shape,"float32")).div(a)}}})(r)}}),ul=Qe({min_:function(t,e,n){void 0===e&&(e=null),void 0===n&&(n=!1);var r=We(t,"x","min"),i=r,a=S(e,r.shape),o=a,s=$e(o,r.rank);null!=s&&(r=r.transpose(s),o=Ye(o.length,r.rank));var u=It.runKernel(function(t,e){var n=t.min(r,o);return e([i,n]),n},{$x:r},function(t,e){return tl(t,e[1],e[0],a,s)});if(n){var l=Ge(u.shape,a);u=u.reshape(l)}return u}}),ll=Qe({moments_:function(t,e,n){void 0===e&&(e=null),void 0===n&&(n=!1);var r=S(e,(t=We(t,"x","moments")).shape),i=t.mean(r,n),a=i.shape;return n||(a=Ge(i.shape,r)),{mean:i,variance:t.toFloat().sub(i.reshape(a)).square().mean(r,n)}}}),cl=Qe({sum_:function(t,e,n){void 0===e&&(e=null),void 0===n&&(n=!1);var r=We(t,"x","sum");"bool"===r.dtype&&(r=r.toInt());var i=S(e,r.shape);return Ir(function(t){var e=$e(i,t.rank),r=i,a=t;null!=e&&(a=t.transpose(e),r=Ye(r.length,t.rank));var o=It.runKernel(function(t){return t.sum(a,r)},{permutedX:a});if(n){var s=Ge(o.shape,i);o=o.reshape(s)}return{value:o,gradFunc:function(e){var n=t.shape.slice();return i.forEach(function(t){n[t]=1}),e.reshape(n).mul(fn(t.shape,"float32"))}}})(r)}}),pl=Qe({prod_:function(t,e,n){void 0===e&&(e=null),void 0===n&&(n=!1);var r=We(t,"x","prod");"bool"===r.dtype&&(r=r.toInt());var i=S(e,r.shape),a=$e(i,r.rank),o=i,s=r;null!=a&&(s=r.transpose(a),o=Ye(o.length,r.rank));var u=It.runKernel(function(t){return t.prod(s,o)},{permutedX:s});if(n){var l=Ge(u.shape,i);u=u.reshape(l)}return u}}),hl=Qe({elu_:function(t){var e=We(t,"x","elu");return It.runKernel(function(t,n){var r=t.elu(e);return n([r]),r},{$x:e},function(t,e){var n=e[0];return{$x:function(){return It.runKernel(function(e){return e.eluDer(t,n)},{dy:t,y:n})}}})}}),fl=Qe({leakyRelu_:function(t,e){void 0===e&&(e=.2);var n=We(t,"x","leakyRelu");return qs(on(e).mul(n),n)}}),dl=Qe({prelu_:function(t,e){var n=We(t,"x","prelu"),r=We(e,"alpha","prelu");return It.runKernel(function(t,e){var i=t.prelu(n,r);return e([n,r]),i},{$x:n,$alpha:r},function(t,e){var n=e[0],r=e[1],i=n.greater(0);return{$x:function(){return Ms(i,t,t.mul(r))},$alpha:function(){var e=Ms(i,bn(t),t.mul(n)),a=Fr(r.shape,t.shape);return a.length>0&&(e=e.sum(a)),e.reshape(r.shape)}}})}}),ml=Qe({relu_:function(t){var e=We(t,"x","relu");return"bool"===e.dtype?e.toInt():It.runKernel(function(t,n){var r=t.relu(e);return n([e]),r},{$x:e},function(t,e){var n=e[0];return{$x:function(){return t.mulStrict(n.step().toFloat())}}})}}),gl=Qe({selu_:function(t){var e=We(t,"x","selu");return It.runKernel(function(t,n){var r=t.selu(e);return n([e]),r},{$x:e},function(t,e){var n=e[0];return{$x:function(){var e=n.greater(on(0)),r=on(wo),i=on(No),a=t.mul(i),o=t.mul(r).mul(n.toFloat().exp());return Ms(e,a,o)}}})}}),vl=Qe({transpose_:function(t,e){var n=We(t,"x","transpose");return null==e&&(e=n.shape.map(function(t,e){return e}).reverse()),f(n.rank===e.length,function(){return"Error in transpose: rank of input "+n.rank+" must match length of perm "+e+"."}),e.forEach(function(t){f(t>=0&&t<n.rank,function(){return"All entries in 'perm' must be between 0 and "+(n.rank-1)+" but got "+e})}),n.rank<=1?n.clone():It.runKernel(function(t){return t.transpose(n,e)},{$x:n},function(t){var n=Xe(e);return{$x:function(){return t.transpose(n)}}})}}),yl=Qe({localResponseNormalization_:function(t,e,n,r,i){void 0===e&&(e=5),void 0===n&&(n=1),void 0===r&&(r=1),void 0===i&&(i=.5);var a=We(t,"x","localResponseNormalization");f(4===a.rank||3===a.rank,function(){return"Error in localResponseNormalization: x must be rank 3 or 4 but got\n               rank "+a.rank+"."}),f(b(e),function(){return"Error in localResponseNormalization: depthRadius must be an integer but got depthRadius "+e+"."});var o=a,s=!1;3===a.rank&&(s=!0,o=a.as4D(1,a.shape[0],a.shape[1],a.shape[2]));var u=It.runKernel(function(t,a){var s=t.localResponseNormalization4D(o,e,n,r,i);return a([o,s]),s},{x4D:o},function(t,a){var o=a[0],s=a[1];return{x4D:function(){return It.runKernel(function(a){return a.LRNGrad(t,o,s,e,n,r,i)},{})}}});return s?u.as3D(u.shape[1],u.shape[2],u.shape[3]):u}}),bl=Qe({norm_:function(t,e,n,r){void 0===e&&(e="euclidean"),void 0===n&&(n=null),void 0===r&&(r=!1);var i=function t(e,n,r){if(void 0===r&&(r=null),0===e.rank)return e.abs();if(1!==e.rank&&null===r)return t(e.reshape([-1]),n,r);if(1===e.rank||"number"==typeof r||Array.isArray(r)&&1===r.length){if(1===n)return e.abs().sum(r);if(n===1/0)return e.abs().max(r);if(n===-1/0)return e.abs().min(r);if("euclidean"===n||2===n)return e.abs().pow(on(2,"int32")).sum(r).sqrt();throw new Error("Error in norm: invalid ord value: "+n)}if(Array.isArray(r)&&2===r.length){if(1===n)return e.abs().sum(r[0]).max(r[1]-1);if(n===1/0)return e.abs().sum(r[1]).max(r[0]);if(n===-1/0)return e.abs().sum(r[1]).min(r[0]);if("fro"===n||"euclidean"===n)return e.square().sum(r).sqrt();throw new Error("Error in norm: invalid ord value: "+n)}throw new Error("Error in norm: invalid axis: "+r)}(t=We(t,"x","norm"),e,n),a=i.shape;if(r){var o=S(n,t.shape);a=Ge(i.shape,o)}return i.reshape(a)}}),xl=Qe({basicLSTMCell_:function(t,e,n,r,i,a){var o=We(t,"forgetBias","basicLSTMCell"),s=We(e,"lstmKernel","basicLSTMCell"),u=We(n,"lstmBias","basicLSTMCell"),l=We(r,"data","basicLSTMCell"),c=We(i,"c","basicLSTMCell"),p=We(a,"h","basicLSTMCell"),h=l.concat(p,1).matMul(s).add(u),f=h.shape[0],d=h.shape[1]/4,m=[f,d],g=h.slice([0,0],m),v=h.slice([0,d],m),y=h.slice([0,2*d],m),b=h.slice([0,3*d],m),x=g.sigmoid().mulStrict(v.tanh()).addStrict(c.mulStrict(o.add(y).sigmoid()));return[x,x.tanh().mulStrict(b.sigmoid())]}}),wl=Qe({multiRNNCell_:function(t,e,n,r){for(var i=We(e,"data","multiRNNCell"),a=Ue(n,"c","multiRNNCell"),o=Ue(r,"h","multiRNNCell"),s=i,u=[],l=0;l<t.length;l++){var c=t[l](s,a[l],o[l]);u.push(c[0]),u.push(c[1]),s=c[1]}var p=[],h=[];for(l=0;l<u.length;l+=2)p.push(u[l]),h.push(u[l+1]);return[p,h]}}),Nl=Qe({movingAverage_:function(t,e,n,r,i){void 0===i&&(i=!0);var a=We(t,"v","movingAverage"),o=We(e,"x","movingAverage"),s=We(n,"decay","movingAverage");wt(a,o),f(y(a.shape,o.shape),function(){return"Shape mismatch in v and x"});var u=on(1),l=u.sub(s),c=o.sub(a).mul(l);if(i){f(null!=r,function(){return"When using zeroDebias: true, step is required."});var p=We(r,"step","movingAverage");c=c.div(u.sub(Zs(s,p)))}return a.add(c)}}),Cl=Qe({stridedSlice_:function(t,e,n,r,i,a,o,s,u){if(void 0===i&&(i=0),void 0===a&&(a=0),void 0===o&&(o=0),void 0===s&&(s=0),void 0===u&&(u=0),0!==o)throw new Error("ellipsis mask is not yet supported");if(0!==s)throw new Error("new axis mask is not yet supported");var l=We(t,"x","stridedSlice");if(r.every(function(t){return 1===t})){var c=wr(l.shape,e,n,r,i,a,o,s,u),p=c[0],h=c[1],f=c[2],d=h.filter(function(t,e){return-1===f.indexOf(e)});return Xu(l,p,h).reshape(d)}return It.runKernel(function(t){return t.stridedSlice(l,e,n,r,i,a,o,s,u)},{$x:l})}}),El=Qe({topk_:function(t,e,n){void 0===e&&(e=1),void 0===n&&(n=!0);var r=We(t,"x","topk");if(0===r.rank)throw new Error("topk() expects the input to be of rank 1 or higher");var i=r.shape[r.shape.length-1];if(e>i)throw new Error("'k' passed to topk() must be <= the last dimension ("+i+") but got "+e);var a=It.runKernel(function(t){return t.topk(r,e,n)},{$x:r});return{values:a[0],indices:a[1]}}}),Sl=Qe({scatterND_:function(t,e,n){var r=We(t,"indices","scatterND","int32"),i=We(e,"updates","scatterND");return function(t,e,n){if(e.rank<1)throw new Error("tf.scatterND() expects the indices to be rank 1 or higher, but the rank was "+e.rank+".");if(t.rank<1)throw new Error("tf.scatterND() expects the updates to be rank 1 or higher, but the rank was "+t.rank+".");if("int32"!==e.dtype)throw new Error("The dtype of 'indices' should be int32, but got dtype: "+e.dtype);if(n.length<1)throw new Error("Output rank must be greater or equal to 1, but got shape: "+n);if(0===n.length){if(0===e.size)throw new Error("Indices specified for empty output. indices shape: "+e.shape);if(0===t.size)throw new Error("Updates specified for empty output. updates shape: "+t.shape)}!function(t,e,n){var r=e.rank>1?e.shape[e.rank-1]:1,i=e.rank>1?e.rank-1:1,a="Must have updates.shape = indices.shape[:batchDim] + shape[sliceDim:], got updates.shape: "+n.shape+", indices.shape: "+e.shape+", shape: "+t+", sliceDim: "+r+", and batchDim: "+i+".";if(n.rank<i)throw new Error(a+" update.rank < "+i+". ");if(t.length<r+(n.rank-i))throw new Error(a+" Output shape length < "+(r+(n.rank-i)));if(n.rank!==i+t.length-r)throw new Error(a+" update.rank != "+(i+t.length-r));for(var o=0;o<i;++o)if(n.shape[o]!==e.shape[o])throw new Error(a+" updates.shape["+o+"] ("+n.shape[o]+") != indices.shape["+o+"] ("+e.shape[o]+").");for(o=0;o<n.rank-i;++o)if(n.shape[o+i]!==t[o+r])throw new Error(a+" updates.shape["+(o+i)+"] ("+n.shape[o+i]+") != shape["+(o+i)+"] ("+t[o+i]+")")}(n,e,t)}(i,r,n),It.runKernel(function(t){return t.scatterND(r,i,n)},{$indices:r,$updates:i})}}),kl=Qe({fft_:function(t){f("complex64"===t.dtype,function(){return"The dtype for tf.spectral.fft() must be complex64 but got "+t.dtype+"."});var e=t.shape[t.shape.length-1],n=t.size/e,r=t.as2D(n,e);return It.runKernel(function(t){return t.fft(r)},{input:t}).reshape(t.shape)}}),Il=Qe({ifft_:function(t){f("complex64"===t.dtype,function(){return"The dtype for tf.spectral.ifft() must be complex64 but got "+t.dtype+"."});var e=t.shape[t.shape.length-1],n=t.size/e,r=t.as2D(n,e);return It.runKernel(function(t){return t.ifft(r)},{input:t}).reshape(t.shape)}}),Al=Qe({rfft_:function(t,e){f("float32"===t.dtype,function(){return"The dtype for rfft() must be real value but got "+t.dtype});var n,r=t.shape[t.shape.length-1],i=t.size/r;if(null!=e&&e<r){var a=t.shape.map(function(t){return 0}),o=t.shape.map(function(t){return t});o[t.shape.length-1]=e,n=t.slice(a,o),r=e}else if(null!=e&&e>r){var s=t.shape.map(function(t){return t});s[t.shape.length-1]=e-r,n=t.concat(dn(s),t.shape.length-1),r=e}else n=t;var u=n.zerosLike(),l=tn(n,u).as2D(i,r),c=kl(l),p=Math.floor(r/2)+1,h=en(c),d=nn(c),m=h.split([p,r-p],h.shape.length-1),g=d.split([p,r-p],d.shape.length-1),v=n.shape.slice();return v[n.shape.length-1]=p,tn(m[0],g[0]).reshape(v)}}),Rl=Qe({irfft_:function(t){var e=t.shape[t.shape.length-1],n=t.size/e;if(e<=2){var r=t.as2D(n,e),i=Il(r);return en(i)}var a=[n,2*(e-1)],o=en(t).as2D(n,e),s=nn(t).as2D(n,e),u=o.slice([0,1],[n,e-2]).reverse(1),l=s.slice([0,1],[n,e-2]).reverse(1).mul(on(-1)),c=o.concat(u,1),p=s.concat(l,1);return r=tn(c,p).as2D(a[0],a[1]),i=Il(r),en(i)}}),Tl=Object.freeze({fft:kl,ifft:Il,rfft:Al,irfft:Rl}),Dl=Qe({sparseToDense_:function(t,e,n,r){void 0===r&&(r=0);var i=We(t,"sparseIndices","sparseToDense","int32"),a=We(e,"sparseValues","sparseToDense"),o=We(r,"defaultValue","sparseToDense",a.dtype);return function(t,e,n,r){if("int32"!==t.dtype)throw new Error("tf.sparseToDense() expects the indices to be int32 type, but the dtype was "+t.dtype+".");if(t.rank>2)throw new Error("sparseIndices should be a scalar, vector, or matrix, but got shape "+t.shape+".");var i=t.rank>0?t.shape[0]:1,a=t.rank>1?t.shape[1]:1;if(n.length!==a)throw new Error("outputShape has incorrect number of elements:, "+n.length+", should be: "+a+".");var o=e.size;if(0!==e.rank&&(1!==e.rank||o!==i))throw new Error("sparseValues has incorrect shape "+e.shape+", should be [] or ["+i+"]");if(e.dtype!==r.dtype)throw new Error("sparseValues.dtype must match defaultValues.dtype")}(i,a,n,o),It.runKernel(function(t){return t.sparseToDense(i,a,n,o)},{$sparseIndices:i,$sparseValues:a,$defaultValue:o})}}),Ol=Qe({gatherND_:function(t,e){var n=We(e,"indices","gatherND","int32"),r=We(t,"x","gatherND");return It.runKernel(function(t){return t.gatherND(r,n)},{$x:r,$indices:n})}}),_l=Qe({diag_:function(t){var e=We(t,"x","diag").flatten(),n=t.shape.concat(t.shape);return It.runKernel(function(t){return t.diag(e)},{$x:e}).reshape(n)}}),Fl=Qe({dropout_:function(t,e,n,r){var i=We(t,"x","dropout");if(f("float32"===i.dtype,function(){return"x has to be a floating point tensor since it's going to be scaled, but got a "+i.dtype+" tensor instead."}),f(e>=0&&e<1,function(){return"rate must be a float in the range [0, 1), but got "+e+"."}),0===e)return t instanceof ct?i.clone():i;var a=function(t,e){if(null==e)return t.shape.slice();if(y(t.shape,e))return e;if(t.shape.length===e.length){for(var n=[],r=0;r<t.shape.length;r++)null==e[r]&&null!=t.shape[r]?n.push(t.shape[r]):n.push(e[r]);return n}return e}(i,n),o=1-e,s=rr(a,0,1,"float32",r).add(o).floor().div(o);return i.mul(s)}});function Ml(t,e,n){for(var r=1-t%2,i=new Float32Array(t),a=0;a<t;++a){var o=2*Math.PI*a/(t+r-1);i[a]=e-n*Math.cos(o)}return sn(i,"float32")}var zl=Qe({hannWindow_:function(t){return Ml(t,.5,.5)}}),Ll=Qe({hammingWindow_:function(t){return Ml(t,.54,.46)}}),Pl=Qe({frame_:function(t,e,n,r,i){void 0===r&&(r=!1),void 0===i&&(i=0);for(var a=0,o=[];a+e<=t.size;)o.push(Xu(t,a,e)),a+=n;if(r){var s=a+e-t.size,u=xn([Xu(t,a,e-s),mn([s],i)]);o.push(u)}return 0===o.length?un([],[0,e]):xn(o).as2D(o.length,e)}}),Bl=Qe({stft_:function(t,e,n,r,i){var a;void 0===i&&(i=zl),null==r&&(a=e,r=Math.floor(Math.pow(2,Math.ceil(Math.log(a)/Math.log(2)))));for(var o=Pl(t,e,n),s=Ys(o,i(e)),u=[],l=0;l<o.shape[0];l++)u.push(Al(s.slice([l,0],[1,e]),r));return xn(u)}}),Vl=Object.freeze({hannWindow:zl,hammingWindow:Ll,frame:Pl,stft:Bl}),Wl=function(t,e,n){return void 0===n&&(n=1),r(this,void 0,void 0,function(){var r,a,o,s,u,l,c,p,h,m,g,v,y,b;return i(this,function(i){switch(i.label){case 0:return r=We(t,"predictions","inTopK"),a=We(e,"targets","inTopK"),f(r.rank>1,function(){return"inTopK() expects the predictions to be of rank 2 or higher, but got "+r.rank}),f(r.rank-1===a.rank,function(){return"predictions rank should be 1 larger than targets rank, but got predictions rank "+r.rank+" and targets rank "+a.rank}),d(r.shape.slice(0,r.shape.length-1),a.shape,"predictions's shape should be align with the targets' shape, except the last dimension."),o=r.shape[r.shape.length-1],f(n>0&&n<=o,function(){return"'k' passed to inTopK() must be > 0 && <= the predictions last dimension ("+o+"), but got "+n}),[4,r.data()];case 1:return s=i.sent(),[4,a.data()];case 2:for(u=i.sent(),l=[s.length/o,o],p=l[1],h=I("bool",c=l[0]),m=0;m<c;m++){for(g=m*p,v=s.subarray(g,g+p),y=[],b=0;b<v.length;b++)y.push({value:v[b],index:b});for(y.sort(function(t,e){return e.value-t.value}),h[m]=0,b=0;b<n;b++)if(y[b].index===u[m]){h[m]=1;break}}return t!==r&&r.dispose(),e!==a&&a.dispose(),[2,rn(h,a.shape,"bool")]}})})};!function(t){t[t.NONE=0]="NONE",t[t.MEAN=1]="MEAN",t[t.SUM=2]="SUM",t[t.SUM_BY_NONZERO_WEIGHTS=3]="SUM_BY_NONZERO_WEIGHTS"}(t.Reduction||(t.Reduction={}));var Ul=Qe({absoluteDifference_:function(e,n,r,i){void 0===i&&(i=t.Reduction.SUM_BY_NONZERO_WEIGHTS);var a=We(e,"labels","absoluteDifference"),o=We(n,"predictions","absoluteDifference"),s=null;null!=r&&(s=We(r,"weights","absoluteDifference")),d(a.shape,o.shape,"Error in absoluteDifference: ");var u=a.sub(o).abs();return jl(u,s,i)}}),jl=Qe({computeWeightedLoss_:function(e,n,r){void 0===r&&(r=t.Reduction.SUM_BY_NONZERO_WEIGHTS);var i=We(e,"losses","computeWeightedLoss"),a=null;null!=n&&(a=We(n,"weights","computeWeightedLoss"));var o=null==a?i:i.mul(a);if(r===t.Reduction.NONE)return o;if(r===t.Reduction.SUM)return o.sum();if(r===t.Reduction.MEAN){if(null==a)return o.mean();var s=i.size/a.size,u=o.sum().div(a.sum());return s>1?u.div(on(s)):u}if(r===t.Reduction.SUM_BY_NONZERO_WEIGHTS){if(null==a)return o.sum().div(on(i.size));var l=a.mul(fn(i.shape)).notEqual(on(0)).sum().toFloat();return o.sum().div(l)}throw Error("Unknown reduction: "+r)}}),ql=Qe({cosineDistance_:function(e,n,r,i,a){void 0===a&&(a=t.Reduction.SUM_BY_NONZERO_WEIGHTS);var o=We(e,"labels","cosineDistance"),s=We(n,"predictions","cosineDistance"),u=null;null!=i&&(u=We(i,"weights","cosineDistance")),d(o.shape,s.shape,"Error in cosineDistance: ");var l=on(1).sub(o.mul(s).sum(r,!0));return jl(l,u,a)}}),Hl=Qe({hingeLoss_:function(e,n,r,i){void 0===i&&(i=t.Reduction.SUM_BY_NONZERO_WEIGHTS);var a=We(e,"labels","hingeLoss"),o=We(n,"predictions","hingeLoss"),s=null;null!=r&&(s=We(r,"weights","hingeLoss")),d(a.shape,o.shape,"Error in hingeLoss: ");var u=on(1);a=on(2).mul(a).sub(u);var l=u.sub(a.mul(o)).relu();return jl(l,s,i)}}),Gl=Qe({huberLoss_:function(e,n,r,i,a){void 0===i&&(i=1),void 0===a&&(a=t.Reduction.SUM_BY_NONZERO_WEIGHTS);var o=We(e,"labels","huberLoss"),s=We(n,"predictions","huberLoss"),u=null;null!=r&&(u=We(r,"weights","huberLoss")),d(o.shape,s.shape,"Error in huberLoss: ");var l=on(i),c=s.sub(o).abs(),p=Gs(c,l),h=c.sub(p),f=on(.5).mul(p.square()).add(l.mul(h));return jl(f,u,a)}}),Kl=Qe({logLoss_:function(e,n,r,i,a){void 0===i&&(i=1e-7),void 0===a&&(a=t.Reduction.SUM_BY_NONZERO_WEIGHTS);var o=We(e,"labels","logLoss"),s=We(n,"predictions","logLoss"),u=null;null!=r&&(u=We(r,"weights","logLoss")),d(o.shape,s.shape,"Error in logLoss: ");var l=on(1),c=on(i),p=o.mul(s.add(c).log()).neg().sub(l.sub(o).mul(l.sub(s).add(c).log()));return jl(p,u,a)}}),$l=Qe({meanSquaredError_:function(e,n,r,i){void 0===i&&(i=t.Reduction.SUM_BY_NONZERO_WEIGHTS);var a=We(e,"labels","meanSquaredError"),o=We(n,"predictions","meanSquaredError"),s=null;null!=r&&(s=We(r,"weights","meanSquaredError")),d(a.shape,o.shape,"Error in meanSquaredError: ");var u=a.squaredDifference(o);return jl(u,s,i)}}),Xl=Qe({sigmoidCrossEntropy_:function(e,n,r,i,a){void 0===i&&(i=0),void 0===a&&(a=t.Reduction.SUM_BY_NONZERO_WEIGHTS);var o=We(e,"multiClassLabels","sigmoidCrossEntropy"),s=We(n,"logits","sigmoidCrossEntropy"),u=null;if(null!=r&&(u=We(r,"weights","sigmoidCrossEntropy")),d(o.shape,s.shape,"Error in sigmoidCrossEntropy: "),i>0){var l=on(i),c=on(1),p=on(.5);o=o.mul(c.sub(l)).add(p.mul(l))}var h=function(t,e){var n=We(t,"labels","sigmoidCrossEntropyWithLogits"),r=We(e,"logits","sigmoidCrossEntropyWithLogits");d(n.shape,r.shape,"Error in sigmoidCrossEntropyWithLogits: ");var i=r.relu(),a=r.mul(n),o=r.abs().neg().exp().log1p();return i.sub(a).add(o)}(o,s);return jl(h,u,a)}}),Yl=Qe({softmaxCrossEntropy_:function(e,n,r,i,a){void 0===i&&(i=0),void 0===a&&(a=t.Reduction.SUM_BY_NONZERO_WEIGHTS);var o=We(e,"onehotLabels","softmaxCrossEntropy"),s=We(n,"logits","softmaxCrossEntropy"),u=null;if(null!=r&&(u=We(r,"weights","softmaxCrossEntropy")),d(o.shape,s.shape,"Error in softmaxCrossEntropy: "),i>0){var l=on(i),c=on(1),p=on(o.shape[1]);o=o.mul(c.sub(l)).add(l.div(p))}var h=function(t,e,n){if(void 0===n&&(n=-1),-1===n&&(n=e.rank-1),n!==e.rank-1)throw Error("Softmax cross entropy along a non-last dimension is not yet supported. Labels / logits was rank "+e.rank+" and dim was "+n);return Ir(function(t,e,r){var i=e.logSumExp([n],!0),a=e.toFloat().sub(i);return r([t,a]),{value:a.mul(t).neg().sum([n]),gradFunc:function(t,e){var r=e[0],i=e[1],a=Ge(t.shape,[n]);return[t.reshape(a).mul(r.toFloat().sub(i.exp())),t.reshape(a).mul(i.exp().sub(r.toFloat()))]}}})(t,e)}(o,s);return jl(h,u,a)}}),Jl=Object.freeze({get Reduction(){return t.Reduction},absoluteDifference:Ul,computeWeightedLoss:jl,cosineDistance:ql,hingeLoss:Hl,huberLoss:Gl,logLoss:Kl,meanSquaredError:$l,sigmoidCrossEntropy:Xl,softmaxCrossEntropy:Yl});function Zl(t,e){return void 0===e&&(e=!1),It.tidy(function(){if(2!==t.shape.length)throw new Error("qr2d() requires a 2D Tensor, but got a "+t.shape.length+"D Tensor.");for(var n=t.shape[0],r=t.shape[1],i=Gn(n),a=t.clone(),o=un([[1]],[1,1]),s=o.clone(),u=n>=r?r:n,l=function(t){var e,u=a,l=s,c=i;e=It.tidy(function(){var e=a.slice([t,t],[n-t,1]),u=e.norm(),l=a.slice([t,t],[1,1]),c=un([[-1]]).where(l.greater(0),un([[1]])),p=l.sub(c.mul(u)),h=e.div(p);s=1===h.shape[0]?o.clone():o.concat(h.slice([1,0],[h.shape[0]-1,h.shape[1]]),0);var f=c.matMul(p).div(u).neg(),d=a.slice([t,0],[n-t,r]),m=f.mul(s);a=0===t?d.sub(m.matMul(s.transpose().matMul(d))):a.slice([0,0],[t,r]).concat(d.sub(m.matMul(s.transpose().matMul(d))),0);var g=i.slice([0,t],[n,i.shape[1]-t]);return i=0===t?g.sub(g.matMul(s).matMul(m.transpose())):i.slice([0,0],[n,t]).concat(g.sub(g.matMul(s).matMul(m.transpose())),1),[s,a,i]}),s=e[0],a=e[1],i=e[2],Me([u,l,c])},c=0;c<u;++c)l(c);return!e&&n>r&&(i=i.slice([0,0],[n,r]),a=a.slice([0,0],[r,r])),[i,a]})}var Ql=Qe({gramSchmidt_:function(t){var e;if(Array.isArray(t)){e=!1,f(null!=t&&t.length>0,function(){return"Gram-Schmidt process: input must not be null, undefined, or empty"});for(var n=t[0].shape[0],r=function(e){f(t[e].shape[0]===n,function(){return"Gram-Schmidt: Non-unique lengths found in the input vectors: ("+t[e].shape[0]+" vs. "+n+")"})},i=1;i<t.length;++i)r(i)}else e=!0,t=Sn(t,t.shape[0],0).map(function(t){return or(t,[0])});f(t.length<=t[0].shape[0],function(){return"Gram-Schmidt: Number of vectors ("+t.length+") exceeds number of dimensions ("+t[0].shape[0]+")."});var a=[],o=t,s=function(t){a.push(It.tidy(function(){var e=o[t];if(t>0)for(var n=0;n<t;++n){var r=cl(a[n].mulStrict(e)).mul(a[n]);e=e.sub(r)}return e.div(bl(e,"euclidean"))}))};for(i=0;i<t.length;++i)s(i);return e?sr(a,0):a}}),tc=Qe({qr_:function(t,e){if(void 0===e&&(e=!1),t.rank<2)throw new Error("qr() requires input tensor to have a rank >= 2, but got rank "+t.rank);if(2===t.rank)return Zl(t,e);var n=t.shape.slice(0,t.shape.length-2).reduce(function(t,e){return t*e}),r=[],i=[];return cr(t.reshape([n,t.shape[t.shape.length-2],t.shape[t.shape.length-1]]),0).forEach(function(t){var n=Zl(t,e),a=n[0],o=n[1];r.push(a),i.push(o)}),[sr(r,0).reshape(t.shape),sr(i,0).reshape(t.shape)]}}),ec=Object.freeze({gramSchmidt:Ql,qr:tc});function nc(t,e,n,r,i){null==r&&(r=.5),null==i&&(i=Number.NEGATIVE_INFINITY);var a=t.shape[0];return n=Math.min(n,a),f(0<=r&&r<=1,function(){return"iouThreshold must be in [0, 1], but was '"+r+"'"}),f(2===t.rank,function(){return"boxes must be a 2D tensor, but was of rank '"+t.rank+"'"}),f(4===t.shape[1],function(){return"boxes must have 4 columns, but 2nd dimension was "+t.shape[1]}),f(1===e.rank,function(){return"scores must be a 1D tensor"}),f(e.shape[0]===a,function(){return"scores has incompatible shape with boxes. Expected "+a+", but was "+e.shape[0]}),{maxOutputSize:n,iouThreshold:r,scoreThreshold:i}}var rc=Qe({resizeBilinear_:function(t,e,n){void 0===n&&(n=!1);var r=We(t,"images","resizeBilinear");f(3===r.rank||4===r.rank,function(){return"Error in resizeBilinear: x must be rank 3 or 4, but got rank "+r.rank+"."}),f(2===e.length,function(){return"Error in resizeBilinear: new shape must 2D, but got shape "+e+"."});var i=r,a=!1;3===r.rank&&(a=!0,i=r.as4D(1,r.shape[0],r.shape[1],r.shape[2]));var o=e[0],s=e[1],u=It.runKernel(function(t,e){return e([i]),t.resizeBilinear(i,o,s,n)},{batchImages:i},function(t,e){return{batchImages:function(){return It.runKernel(function(r){return r.resizeBilinearBackprop(t,e[0],n)},{})}}});return a?u.as3D(u.shape[1],u.shape[2],u.shape[3]):u}}),ic=Qe({resizeNearestNeighbor_:function(t,e,n){void 0===n&&(n=!1);var r=We(t,"images","resizeNearestNeighbor");f(3===r.rank||4===r.rank,function(){return"Error in resizeNearestNeighbor: x must be rank 3 or 4, but got rank "+r.rank+"."}),f(2===e.length,function(){return"Error in resizeNearestNeighbor: new shape must 2D, but got shape "+e+"."}),f("float32"===r.dtype||"int32"===r.dtype,function(){return"`images` must have `int32` or `float32` as dtype"});var i=r,a=!1;3===r.rank&&(a=!0,i=r.as4D(1,r.shape[0],r.shape[1],r.shape[2]));var o=e[0],s=e[1],u=It.runKernel(function(t,e){return e([i]),t.resizeNearestNeighbor(i,o,s,n)},{batchImages:i},function(t,e){return{batchImages:function(){return It.runKernel(function(r){return r.resizeNearestNeighborBackprop(t,e[0],n)},{})}}});return a?u.as3D(u.shape[1],u.shape[2],u.shape[3]):u}}),ac=Qe({nonMaxSuppression_:function(t,e,n,r,i){void 0===r&&(r=.5),void 0===i&&(i=Number.NEGATIVE_INFINITY);var a=We(t,"boxes","nonMaxSuppression"),o=We(e,"scores","nonMaxSuppression"),s=nc(a,o,n,r,i);return n=s.maxOutputSize,r=s.iouThreshold,i=s.scoreThreshold,It.runKernel(function(t){return t.nonMaxSuppression(a,o,n,r,i)},{$boxes:a})}}),oc=Qe({cropAndResize_:function(t,e,n,r,i,a){var o=We(t,"image","cropAndResize","float32"),s=We(e,"boxes","cropAndResize","float32"),u=We(n,"boxInd","cropAndResize","int32");i=i||"bilinear",a=a||0;var l=s.shape[0];return f(4===o.rank,function(){return"Error in cropAndResize: image must be rank 4,but got rank "+o.rank+"."}),f(2===s.rank&&4===s.shape[1],function(){return"Error in cropAndResize: boxes must be have size ["+l+",4] but had shape "+s.shape+"."}),f(1===u.rank&&u.shape[0]===l,function(){return"Error in cropAndResize: boxInd must be have size ["+l+"] but had shape "+s.shape+"."}),f(2===r.length,function(){return"Error in cropAndResize: cropSize must be of length 2, but got length "+r.length+"."}),f(r[0]>=1&&r[1]>=1,function(){return"cropSize must be atleast [1,1], but was "+r}),f("bilinear"===i||"nearest"===i,function(){return"method must be bilinear or nearest, but was "+i}),It.runKernel(function(t,e){return t.cropAndResize(o,s,u,r,i,a)},{$image:o,$boxes:s})}}),sc=Object.freeze({resizeBilinear:rc,resizeNearestNeighbor:ic,nonMaxSuppression:ac,nonMaxSuppressionAsync:function(t,e,n,a,o){return void 0===a&&(a=.5),void 0===o&&(o=Number.NEGATIVE_INFINITY),r(this,void 0,void 0,function(){var r,s,u,l,c,p;return i(this,function(i){switch(i.label){case 0:return r=We(t,"boxes","nonMaxSuppressionAsync"),s=We(e,"scores","nonMaxSuppressionAsync"),u=nc(r,s,n,a,o),n=u.maxOutputSize,a=u.iouThreshold,o=u.scoreThreshold,[4,r.data()];case 1:return l=i.sent(),[4,s.data()];case 2:return c=i.sent(),p=ni(l,c,n,a,o),r!==t&&r.dispose(),s!==e&&s.dispose(),[2,p]}})})},cropAndResize:oc}),uc=Qe({matMul_:function(t){var e,n=t.a,r=t.b,i=t.transposeA,a=void 0!==i&&i,o=t.transposeB,s=void 0!==o&&o,u=t.bias,l=t.activation,c=void 0===l?"linear":l,p=t.preluActivationWeights,h=We(n,"a","fused matMul"),d=We(r,"b","fused matMul");e=xt(h,d),h=e[0],d=e[1];var m=a?h.shape[h.rank-2]:h.shape[h.rank-1],g=s?d.shape[d.rank-1]:d.shape[d.rank-2],b=a?h.shape[h.rank-1]:h.shape[h.rank-2],x=s?d.shape[d.rank-2]:d.shape[d.rank-1],w=h.shape.slice(0,-2),N=d.shape.slice(0,-2),C=v(w),E=v(N);f(h.rank>=2&&d.rank>=2&&h.rank===d.rank,function(){return"Error in fused matMul: inputs must have the same rank of at least 2, got ranks "+h.rank+" and "+d.rank+"."}),f(y(w,N),function(){return"Error in fused matMul: outer dimensions ("+w+") and ("+N+") of Tensors with shapes "+h.shape+" and "+d.shape+" must match."}),f(m===g,function(){return"Error in fused matMul: inner shapes ("+m+") and ("+g+") of Tensors with shapes "+h.shape+" and "+d.shape+" and transposeA="+a+" and transposeB="+s+" must match."});var S,k,I=h.shape.slice(0,-2).concat([b,x]),A=a?h.as3D(C,m,b):h.as3D(C,b,m),R=s?d.as3D(E,x,g):d.as3D(E,g,x);null!=u&&Mr(I,(S=xt(S=We(u,"bias","fused matMul"),h)[0]).shape),null!=p&&(k=We(p,"prelu weights","fused matMul"));var T={$a:A,$b:R};return null!=u&&(T.$bias=S),null!=p&&(T.$preluActivationWeights=k),It.runKernel(function(t,e){var n=t.fusedBatchMatMul({a:A,b:R,transposeA:a,transposeB:s,bias:S,activation:c,preluActivationWeights:k});return e([A,R,n]),n},T,function(t,e){var n,r=e[0],i=e[1],o=e[2];if(null==c||"linear"===c)n=t;else{if("relu"!==c)throw new Error("Gradient for activation "+c+" has not been implemented yet.");n=t.mul(o.step())}var l={};return null!=u&&(l={$bias:function(){var t=n,e=Fr(S.shape,n.shape);return e.length>0&&(t=t.sum(e)),t.reshape(S.shape)}}),a||s?!a&&s?Object.assign({$a:function(){return n.matMul(i,!1,!1)},$b:function(){return n.matMul(r,!0,!1)}},l):a&&!s?Object.assign({$a:function(){return i.matMul(n,!1,!0)},$b:function(){return r.matMul(n,!1,!1)}},l):Object.assign({$a:function(){return i.matMul(n,!0,!0)},$b:function(){return n.matMul(r,!0,!0)}},l):Object.assign({$a:function(){return n.matMul(i,!1,!0)},$b:function(){return r.matMul(n,!0,!1)}},l)}).reshape(I)}}),lc=Qe({conv2d_:function(t){var e=t.x,n=t.filter,r=t.strides,i=t.pad,a=t.dataFormat,o=void 0===a?"NHWC":a,s=t.dilations,u=void 0===s?[1,1]:s,l=t.dimRoundingMode,c=t.bias,p=t.activation,h=void 0===p?"linear":p,d=t.preluActivationWeights,m=We(e,"x","conv2d"),g=We(n,"filter","conv2d"),v=m,y=!1;3===m.rank&&(y=!0,v=m.as4D(1,m.shape[0],m.shape[1],m.shape[2])),f(4===v.rank,function(){return"Error in fused conv2d: input must be rank 4, but got rank "+v.rank+"."}),f(4===g.rank,function(){return"Error in fused conv2d: filter must be rank 4, but got rank "+g.rank+"."}),null!=l&&f(b(i),function(){return"Error in fused conv2d: pad must be an integer when using, dimRoundingMode "+l+" but got pad "+i+"."}),f(v.shape[3]===g.shape[2],function(){return"Error in conv2d: depth of input ("+v.shape[3]+") must match input depth for filter "+g.shape[2]+"."}),f(Gr(r,u),function(){return"Error in conv2D: Either strides or dilations must be 1. Got strides "+r+" and dilations '"+u+"'"}),f("NHWC"===o,function(){return"Error in conv2d: got dataFormat of "+o+" but only NHWC is currently supported."});var x,w,N=Pr(v.shape,g.shape,r,u,i,l);null!=c&&(x=xt(x=We(c,"bias","fused conv2d"),m)[0],Mr(N.outShape,x.shape)),null!=d&&(w=We(d,"prelu weights","fused conv2d"));var C={x:v,$filter:g};null!=c&&(C.$bias=x),null!=d&&(C.$preluActivationWeights=w);var E=It.runKernel(function(t,e){var n=t.fusedConv2d(v,g,N,x,h,w);return e([g,v,n]),n},C,function(t,e){var n,a=e,o=a[0],s=a[1],l=a[2];if(null==h||"linear"===h)n=t;else{if("relu"!==h)throw new Error("Gradient for activation "+h+" has not been implemented yet.");n=t.mul(l.step())}f(Hr(u),function(){return"Error in gradient of fused conv2D: dilation rates greater than 1 are not yet supported in gradients. Got dilations '"+u+"'"});var p={};return null!=c&&(p={$bias:function(){var t=n,e=Fr(x.shape,n.shape);return e.length>0&&(t=t.sum(e)),t.reshape(x.shape)}}),Object.assign({x:function(){return Ru(s.shape,n,o,r,i)},$filter:function(){return Au(s,n,o.shape,r,i)}},p)});return y?E.as3D(E.shape[1],E.shape[2],E.shape[3]):E}}),cc=Object.freeze({matMul:uc,conv2d:lc}),pc=Object.freeze({image:sc,linalg:ec,losses:Jl,spectral:Tl,fused:cc,signal:Vl,op:Qe,batchNormalization2d:Cs,batchNormalization3d:Es,batchNormalization4d:Ss,batchNormalization:ks,batchNorm:Is,batchNorm2d:As,batchNorm3d:Rs,batchNorm4d:Ts,booleanMaskAsync:xu,complex:tn,real:en,imag:nn,concat:xn,concat1d:wn,concat2d:Nn,concat3d:Cn,concat4d:En,split:Sn,conv1d:Su,conv2d:ku,conv3d:Iu,conv2dDerFilter:Au,conv2dDerInput:Ru,depthwiseConv2d:Tu,separableConv2d:Du,conv2dTranspose:Ou,conv3dTranspose:_u,matMul:Fu,dot:Mu,outerProduct:zu,reverse:Lu,reverse1d:Pu,reverse2d:Bu,reverse3d:Vu,reverse4d:Wu,maxPool:qu,avgPool:Hu,pool:Gu,maxPool3d:Ku,avgPool3d:$u,slice:Xu,slice1d:Yu,slice2d:Ju,slice3d:Zu,slice4d:Qu,abs:zo,acos:Lo,acosh:Po,asin:Bo,asinh:Vo,atan:Wo,atanh:Uo,ceil:jo,clipByValue:qo,cos:Ho,cosh:Go,erf:Ko,exp:$o,expm1:Xo,floor:Yo,log:Jo,log1p:Zo,logSigmoid:Qo,neg:ts,reciprocal:es,round:ns,rsqrt:rs,sigmoid:is,sign:as,isNaN:os,isInf:ss,isFinite:us,sin:ls,sinh:cs,softplus:ps,sqrt:hs,square:fs,step:ds,tan:ms,tanh:gs,all:el,any:nl,argMax:rl,argMin:il,logSumExp:al,max:ol,mean:sl,min:ul,moments:ll,sum:cl,prod:pl,equal:iu,equalStrict:au,greater:ou,greaterEqual:su,greaterEqualStrict:uu,greaterStrict:lu,less:cu,lessEqual:pu,lessEqualStrict:hu,lessStrict:fu,notEqual:du,notEqualStrict:mu,add:Ls,addN:Ps,addStrict:Bs,atan2:Vs,div:Ws,divStrict:Us,floorDiv:js,maximum:qs,maximumStrict:Hs,minimum:Gs,minimumStrict:Ks,mod:$s,modStrict:Xs,mul:Ys,mulStrict:Js,pow:Zs,powStrict:Qs,squaredDifference:tu,squaredDifferenceStrict:eu,sub:nu,subStrict:ru,elu:hl,leakyRelu:fl,prelu:dl,relu:ml,selu:gl,logicalAnd:Ds,logicalNot:Os,logicalOr:_s,logicalXor:Fs,where:Ms,whereAsync:zs,buffer:Pn,print:Bn,batchToSpaceND:Vn,cast:Wn,clone:Un,cumsum:jn,depthToSpace:qn,expandDims:Hn,eye:Gn,multinomial:Kn,oneHot:$n,pad:Xn,pad1d:Yn,pad2d:Jn,pad3d:Zn,pad4d:Qn,rand:tr,randomNormal:er,randomGamma:nr,randomUniform:rr,reshape:ir,spaceToBatchND:ar,squeeze:or,stack:sr,tile:ur,truncatedNormal:lr,unstack:cr,setdiff1dAsync:pr,fill:mn,linspace:gn,ones:fn,range:vn,scalar:on,tensor:rn,tensor1d:sn,tensor2d:un,tensor3d:ln,tensor4d:cn,tensor5d:pn,tensor6d:hn,zeros:dn,onesLike:yn,zerosLike:bn,transpose:vl,softmax:Rr,logSoftmax:Tr,localResponseNormalization:yl,norm:bl,gather:yu,unsortedSegmentSum:bu,basicLSTMCell:xl,multiRNNCell:wl,movingAverage:Nl,stridedSlice:Cl,topk:El,scatterND:Sl,fft:kl,ifft:Il,rfft:Al,irfft:Rl,sparseToDense:Dl,gatherND:Ol,diag:_l,dropout:Fl,hannWindow:zl,hammingWindow:Ll,frame:Pl,stft:Bl,inTopKAsync:Wl});function hc(t,e,n,r){if("linear"===n)return t.linear(e);if("relu"===n)return t.relu(e);if("prelu"===n)return t.prelu(e,r);throw new Error("Activation "+n+" has not been implemented for the CPU backend.")}var fc=function(){function e(){if(this.blockSize=48,this.firstUse=!0,t.ENV.get("IS_BROWSER")){var e="undefined"!=typeof OffscreenCanvas?new OffscreenCanvas(300,150):"undefined"!=typeof document?document.createElement("canvas"):null;null!==e&&(this.fromPixels2DContext=e.getContext("2d"))}this.data=new Dr(this,It)}return e.prototype.register=function(e,n,r){if(this.firstUse&&(this.firstUse=!1,t.ENV.get("IS_NODE")&&Pe("\n============================\nHi there . Looks like you are running TensorFlow.js in Node.js. To speed things up dramatically, install our node backend, which binds to TensorFlow C++, by running npm i @tensorflow/tfjs-node, or npm i @tensorflow/tfjs-node-gpu if you have CUDA. Then call require('@tensorflow/tfjs-node'); (-gpu suffix for CUDA) at the start of your program. Visit https://github.com/tensorflow/tfjs-node for more details.\n============================\n")),this.data.has(e))throw new Error("Data buffer is already registered");this.data.set(e,{dtype:r})},e.prototype.write=function(t,e){if(null==e)throw new Error("MathBackendCPU.write(): values can not be null");this.data.get(t).values=e},e.prototype.fromPixels=function(e,n){if(null==e)throw new Error("pixels passed to tf.browser.fromPixels() can not be null");var r,i,a=e.data instanceof Uint8Array,o="undefined"!=typeof ImageData&&e instanceof ImageData,s="undefined"!=typeof HTMLVideoElement&&e instanceof HTMLVideoElement,u="undefined"!=typeof HTMLImageElement&&e instanceof HTMLImageElement;if(t.ENV.get("IS_NODE")&&null==e.getContext)throw new Error("When running in node, pixels must be an HTMLCanvasElement like the one returned by the `canvas` npm package");if(null!=e.getContext)r=e.getContext("2d").getImageData(0,0,e.width,e.height).data;else if(o||a)r=e.data;else{if(!u&&!s)throw new Error("pixels passed to tf.browser.fromPixels() must be either an HTMLVideoElement, HTMLImageElement, HTMLCanvasElement, ImageData or {data: Uint32Array, width: number, height: number}, but was "+e.constructor.name);if(null==this.fromPixels2DContext)throw new Error("Can't read pixels from HTMLImageElement outside the browser.");this.fromPixels2DContext.canvas.width=e.width,this.fromPixels2DContext.canvas.height=e.height,this.fromPixels2DContext.drawImage(e,0,0,e.width,e.height),r=this.fromPixels2DContext.getImageData(0,0,e.width,e.height).data}if(4===n)i=new Int32Array(r);else{var l=e.width*e.height;i=new Int32Array(l*n);for(var c=0;c<l;c++)for(var p=0;p<n;++p)i[c*n+p]=r[4*c+p]}return ln(i,[e.height,e.width,n],"int32")},e.prototype.read=function(t){return r(this,void 0,void 0,function(){return i(this,function(e){return[2,this.readSync(t)]})})},e.prototype.readSync=function(t){var e=this.data.get(t),n=e.dtype,r=e.complexTensors;return"complex64"===n?Zr(this.readSync(r.real.dataId),this.readSync(r.imag.dataId)):this.data.get(t).values},e.prototype.bufferSync=function(t){var e=this.readSync(t.dataId),n=e;if("string"===t.dtype)try{n=e.map(function(t){return Y(t)})}catch(t){throw new Error("Failed to decode encoded string bytes into utf-8")}return Pn(t.shape,t.dtype,n)},e.prototype.disposeData=function(t){if(this.data.has(t)){var e=this.data.get(t).complexTensors;null!=e&&(e.real.dispose(),e.imag.dispose()),this.data.delete(t)}},e.prototype.time=function(t){return r(this,void 0,void 0,function(){var e;return i(this,function(n){return e=K(),t(),[2,{kernelMs:K()-e}]})})},e.prototype.memory=function(){return{unreliable:!0,reasons:["The reported memory is an upper bound. Due to automatic garbage collection, the true allocated memory may be less."]}},e.prototype.complex=function(t,e){var n=ct.make(t.shape,{},"complex64");return this.data.get(n.dataId).complexTensors={real:It.keep(t.clone()),imag:It.keep(e.clone())},n},e.prototype.real=function(t){return this.data.get(t.dataId).complexTensors.real.clone()},e.prototype.imag=function(t){return this.data.get(t.dataId).complexTensors.imag.clone()},e.prototype.assertNotComplex=function(t,e){Array.isArray(t)||(t=[t]),t.forEach(function(t){null!=t&&f("complex64"!==t.dtype,function(){return e+" does not support complex64 tensors."})})},e.prototype.slice=function(t,e,n){if(this.assertNotComplex(t,"slice"),Er(t.shape,e,n)){var r=Sr(e,t.strides),i=v(n);return rn(this.readSync(t.dataId).subarray(r,r+i),n,t.dtype)}for(var a=Pn(n,t.dtype),o=this.bufferSync(t),s=0;s<a.size;++s){var u=a.indexToLoc(s).map(function(t,n){return t+e[n]});a.values[s]=o.get.apply(o,u)}return a.toTensor()},e.prototype.stridedSlice=function(t,e,n,r,i,a,o,s,u){this.assertNotComplex(t,"stridedSlice");var l=wr(t.shape,e,n,r,i,a,o,s,u),c=l[0],p=l[1],h=l[2],f=p.filter(function(t,e){return-1===h.indexOf(e)});if(f.some(function(t){return 0===t}))return rn([],f);for(var d=Pn(p,t.dtype),m=this.bufferSync(t),g=0;g<d.size;g++){for(var v=d.indexToLoc(g),y=new Array(v.length),b=0;b<y.length;b++)y[b]=v[b]*r[b]+c[b];d.set.apply(d,[m.get.apply(m,y)].concat(v))}return d.toTensor().reshape(f)},e.prototype.diag=function(t){for(var e=this.readSync(t.dataId),n=Pn([t.size,t.size],t.dtype),r=n.values,i=0;i<e.length;i++)r[i*t.size+i]=e[i];return n.toTensor()},e.prototype.unstack=function(t,e){for(var n=t.shape[e],r=new Array(t.rank-1),i=0,a=0;a<t.rank;a++)a!==e&&(r[i++]=t.shape[a]);var o=new Array(t.rank).fill(0),s=t.shape.slice();s[e]=1;var u=new Array(n);for(a=0;a<u.length;a++)o[e]=a,u[a]=this.slice(t,o,s).reshape(r);return u},e.prototype.reverse=function(t,e){this.assertNotComplex(t,"reverse");for(var n=Pn(t.shape,t.dtype),r=this.bufferSync(t),i=function(i){var a=n.indexToLoc(i),o=a.slice();e.forEach(function(e){return o[e]=t.shape[e]-1-o[e]}),n.set.apply(n,[r.get.apply(r,o)].concat(a))},a=0;a<n.size;a++)i(a);return n.toTensor()},e.prototype.concat=function(t,e){var n=this;if("complex64"===t[0].dtype){var r=t.map(function(t){return en(t)}),i=t.map(function(t){return nn(t)});return tn(this.concat(r,e),this.concat(i,e))}var a=t.map(function(t){var n=v(t.shape.slice(e));return t.as2D(-1,n)}),o=Ze(a.map(function(t){return t.shape}),1),s=Pn(o,t[0].dtype).values;if(1===a[0].shape[0]){var u=0;a.forEach(function(t){s.set(n.readSync(t.dataId),u),u+=t.size})}else{var l=0;a.forEach(function(t){for(var e=n.readSync(t.dataId),r=0,i=0;i<t.shape[0];++i)for(var a=i*o[1]+l,u=0;u<t.shape[1];++u)s[a+u]=e[r++];l+=t.shape[1]})}var c=Ze(t.map(function(t){return t.shape}),e);return rn(s,c,t[0].dtype)},e.prototype.neg=function(t){return this.assertNotComplex(t,"neg"),this.multiply(on(-1),t)},e.prototype.add=function(t,e){return"complex64"===t.dtype||"complex64"===e.dtype?this.broadcastedBinaryComplexOp(t.cast("complex64"),e.cast("complex64"),function(t,e,n,r){return{real:t+n,imag:e+r}}):this.broadcastedBinaryOp(t,e,yt(t.dtype,e.dtype),function(t,e){return t+e})},e.prototype.addN=function(t){var e=this;this.assertNotComplex(t,"addN");for(var n=t.map(function(t){return e.readSync(t.dataId)}),r=Pn(t[0].shape,t[0].dtype),i=r.values,a=0;a<t.length;a++)for(var o=n[a],s=0;s<i.length;s++)i[s]+=o[s];return r.toTensor()},e.prototype.subtract=function(t,e){return"complex64"===t.dtype||"complex64"===e.dtype?this.broadcastedBinaryComplexOp(t.cast("complex64"),e.cast("complex64"),function(t,e,n,r){return{real:t-n,imag:e-r}}):this.broadcastedBinaryOp(t,e,yt(t.dtype,e.dtype),function(t,e){return t-e})},e.prototype.pow=function(t,e){return this.assertNotComplex([t,e],"pow"),this.broadcastedBinaryOp(t,e,t.dtype,function(t,e){return Math.pow(t,e)})},e.prototype.batchMatMul=function(t,e,n,r){this.assertNotComplex([t,e],"matMul");for(var i=n?t.shape[1]:t.shape[2],a=n?t.shape[2]:t.shape[1],o=r?e.shape[1]:e.shape[2],s=t.shape[0],u=this.readSync(t.dataId),l=this.readSync(e.dataId),c=n?[t.strides[0],1,t.strides[1]]:[t.strides[0],t.strides[1],1],p=c[0],h=c[1],f=c[2],d=r?[1,e.strides[1],e.strides[0]]:[e.strides[1],1,e.strides[0]],m=d[0],g=d[1],v=d[2],y=a*o,b=Pn([s,a,o],t.dtype),x=b.values,w=this.blockSize,N=0;N<s;N++)for(var C=0;C<a;C+=w)for(var E=0;E<o;E+=w)for(var S=0;S<i;S+=w)for(var k=Math.min(C+w,a),I=Math.min(E+w,o),A=Math.min(S+w,i),R=C;R<k;R++)for(var T=E;T<I;T++){for(var D=0,O=S;O<A;O++)D+=u[N*p+R*h+O*f]*l[O*m+T*g+N*v];x[N*y+(R*o+T)]+=D}return b.toTensor()},e.prototype.fusedBatchMatMul=function(t){var e=t.a,n=t.b,r=t.transposeA,i=t.transposeB,a=t.bias,o=t.activation,s=t.preluActivationWeights,u=this.batchMatMul(e,n,r,i);return a&&(u=this.add(u,a)),o&&(u=hc(this,u,o,s)),u},e.prototype.multiply=function(t,e){return"complex64"===t.dtype||"complex64"===e.dtype?this.broadcastedBinaryComplexOp(t.cast("complex64"),e.cast("complex64"),function(t,e,n,r){return{real:t*n-e*r,imag:t*r+e*n}}):this.broadcastedBinaryOp(t,e,yt(t.dtype,e.dtype),function(t,e){return t*e})},e.prototype.realDivide=function(t,e){return this.assertNotComplex([t,e],"realDivide"),this.broadcastedBinaryOp(t,e,"float32",function(t,e){return t/e})},e.prototype.floorDiv=function(t,e){return this.assertNotComplex([t,e],"floorDiv"),this.broadcastedBinaryOp(t,e,"int32",function(t,e){return Math.floor(t/e)})},e.prototype.sum=function(t,e){this.assertNotComplex(t,"sum"),Ke("sum",e,t.rank);for(var n=He(t.shape,e),r=n[0],i=n[1],a=dn(r,yt(t.dtype,"int32")),o=v(i),s=this.readSync(a.dataId),u=this.readSync(t.dataId),l=0;l<s.length;++l){for(var c=l*o,p=0,h=0;h<o;++h)p+=u[c+h];s[l]=p}return a},e.prototype.prod=function(t,e){this.assertNotComplex(t,"sum");for(var n=He(t.shape,e),r=n[0],i=n[1],a=dn(r,yt(t.dtype,"int32")),o=v(i),s=this.readSync(a.dataId),u=this.readSync(t.dataId),l=0;l<s.length;++l){for(var c=l*o,p=1,h=0;h<o;++h)p*=u[c+h];s[l]=p}return a},e.prototype.unsortedSegmentSum=function(t,e,n){this.assertNotComplex(t,"unsortedSegmentSum");for(var r=[],i=t.rank-e.rank,a=0;a<i;++a)e=e.expandDims(a+1);for(a=0;a<n;++a){var o=on(a,"int32"),s=iu(o,e).asType("float32").mul(t).sum(0);r.push(s)}return sr(r)},e.prototype.argMin=function(t,e){this.assertNotComplex(t,"argMin");var n=[e];Ke("argMin",n,t.rank);for(var r=He(t.shape,n),i=r[0],a=r[1],o=dn(i,"int32"),s=v(a),u=this.readSync(o.dataId),l=this.readSync(t.dataId),c=0;c<u.length;++c){for(var p=c*s,h=l[p],f=0,d=0;d<s;++d){var m=l[p+d];m<h&&(h=m,f=d)}u[c]=f}return o},e.prototype.argMax=function(t,e){this.assertNotComplex(t,"argMax");var n=[e];Ke("argMax",n,t.rank);for(var r=He(t.shape,n),i=r[0],a=r[1],o=dn(i,"int32"),s=v(a),u=this.readSync(o.dataId),l=this.readSync(t.dataId),c=0;c<u.length;++c){for(var p=c*s,h=l[p],f=0,d=0;d<s;++d){var m=l[p+d];m>h&&(h=m,f=d)}u[c]=f}return o},e.prototype.cumsum=function(t,e,n,r){if(this.assertNotComplex(t,"cumsum"),e!==t.rank-1)throw new Error("backend.cumsum in CPU expects an inner-most axis="+(t.rank-1)+" but got axis="+e);for(var i=yt(t.dtype,"int32"),a=dn(t.shape,i),o=this.readSync(a.dataId),s=this.readSync(t.dataId),u=t.shape[t.rank-1],l=r?function(t,e){return t+u-e-1}:function(t,e){return t+e},c=0;c<s.length;c+=u)for(var p=0;p<u;p++){var h=l(c,p);if(0===p)o[h]=n?0:s[h];else{var f=l(c,p-1);o[h]=n?s[f]+o[f]:s[h]+o[f]}}return a},e.prototype.equal=function(t,e){return this.assertNotComplex([t,e],"equal"),this.broadcastedBinaryOp(t,e,"bool",function(t,e){return t===e?1:0})},e.prototype.notEqual=function(t,e){return this.assertNotComplex([t,e],"notEqual"),this.broadcastedBinaryOp(t,e,"bool",function(t,e){return t!==e?1:0})},e.prototype.less=function(t,e){return this.assertNotComplex([t,e],"less"),this.broadcastedBinaryOp(t,e,"bool",function(t,e){return t<e?1:0})},e.prototype.lessEqual=function(t,e){return this.assertNotComplex([t,e],"lessEqual"),this.broadcastedBinaryOp(t,e,"bool",function(t,e){return t<=e?1:0})},e.prototype.greater=function(t,e){return this.assertNotComplex([t,e],"greater"),this.broadcastedBinaryOp(t,e,"bool",function(t,e){return t>e?1:0})},e.prototype.greaterEqual=function(t,e){return this.assertNotComplex([t,e],"greaterEqual"),this.broadcastedBinaryOp(t,e,"bool",function(t,e){return t>=e?1:0})},e.prototype.logicalNot=function(t){this.assertNotComplex(t,"logicalNot");for(var e=this.readSync(t.dataId),n=new Uint8Array(e.length),r=0;r<e.length;++r)n[r]=e[r]?0:1;return ct.make(t.shape,{values:n},"bool")},e.prototype.logicalAnd=function(t,e){return this.assertNotComplex([t,e],"logicalAnd"),this.broadcastedBinaryOp(t,e,"bool",function(t,e){return t&&e})},e.prototype.logicalOr=function(t,e){return this.assertNotComplex([t,e],"logicalOr"),this.broadcastedBinaryOp(t,e,"bool",function(t,e){return t||e})},e.prototype.select=function(t,e,n){this.assertNotComplex([t,e,n],"select");for(var r=this.readSync(t.dataId),i=this.readSync(e.dataId),a=this.readSync(n.dataId),o=dn(e.shape,yt(e.dtype,n.dtype)),s=this.readSync(o.dataId),u=0,l=0===t.rank||t.rank>1||1===e.rank?1:e.shape[1],c=0;c<r.length;c++)for(var p=0;p<l;p++)1===r[c]?s[u++]=i[c]:s[u++]=a[c];return o},e.prototype.where=function(t){this.assertNotComplex([t],"where");var e=this.readSync(t.dataId);return si(t.shape,e)},e.prototype.topk=function(t,e,n){return this.assertNotComplex(t,"topk"),oi(this.readSync(t.dataId),t.shape,t.dtype,e)},e.prototype.min=function(t,e){this.assertNotComplex(t,"min"),Ke("min",e,t.rank);for(var n=He(t.shape,e),r=n[0],i=n[1],a=dn(r,t.dtype),o=v(i),s=this.readSync(a.dataId),u=this.readSync(t.dataId),l=0;l<s.length;++l){for(var c=l*o,p=u[c],h=0;h<o;++h){var f=u[c+h];f<p&&(p=f)}s[l]=p}return a},e.prototype.minimum=function(t,e){return this.assertNotComplex([t,e],"minimum"),this.broadcastedBinaryOp(t,e,t.dtype,function(t,e){return Math.min(t,e)})},e.prototype.mod=function(t,e){return this.assertNotComplex([t,e],"mod"),this.broadcastedBinaryOp(t,e,t.dtype,function(t,e){var n=t%e;return t<0&&e<0||t>=0&&e>=0?n:(n+e)%e})},e.prototype.max=function(t,e){this.assertNotComplex(t,"max"),Ke("max",e,t.rank);for(var n=He(t.shape,e),r=n[0],i=n[1],a=dn(r,t.dtype),o=v(i),s=this.readSync(a.dataId),u=this.readSync(t.dataId),l=0;l<s.length;++l){for(var c=l*o,p=u[c],h=0;h<o;++h){var f=u[c+h];f>p&&(p=f)}s[l]=p}return a},e.prototype.maximum=function(t,e){return this.assertNotComplex([t,e],"maximum"),this.broadcastedBinaryOp(t,e,t.dtype,function(t,e){return Math.max(t,e)})},e.prototype.all=function(t,e){this.assertNotComplex(t,"all"),Ke("all",e,t.rank);for(var n=He(t.shape,e),r=n[0],i=n[1],a=dn(r,t.dtype),o=v(i),s=this.readSync(a.dataId),u=this.readSync(t.dataId),l=0;l<s.length;++l){for(var c=l*o,p=u[c],h=0;h<o;++h){var f=u[c+h];p=p&&f}s[l]=p}return a},e.prototype.any=function(t,e){this.assertNotComplex(t,"any"),Ke("any",e,t.rank);for(var n=He(t.shape,e),r=n[0],i=n[1],a=dn(r,t.dtype),o=v(i),s=this.readSync(a.dataId),u=this.readSync(t.dataId),l=0;l<s.length;++l){for(var c=l*o,p=u[c],h=0;h<o;++h){var f=u[c+h];p=p||f}s[l]=p}return a},e.prototype.squaredDifference=function(t,e){return this.assertNotComplex([t,e],"squaredDifference"),this.broadcastedBinaryOp(t,e,t.dtype,function(t,e){var n=t-e;return n*n})},e.prototype.ceil=function(t){this.assertNotComplex(t,"ceil");for(var e=this.readSync(t.dataId),n=new Float32Array(e.length),r=0;r<e.length;++r)n[r]=Math.ceil(e[r]);return ct.make(t.shape,{values:n})},e.prototype.floor=function(t){this.assertNotComplex(t,"floor");for(var e=this.readSync(t.dataId),n=new Float32Array(e.length),r=0;r<e.length;++r)n[r]=Math.floor(e[r]);return ct.make(t.shape,{values:n})},e.prototype.sign=function(t){this.assertNotComplex(t,"x");for(var e=this.readSync(t.dataId),n=new Float32Array(e.length),r=0;r<e.length;++r)e[r]<0?n[r]=-1:e[r]>0?n[r]=1:n[r]=0;return ct.make(t.shape,{values:n})},e.prototype.isNaN=function(t){this.assertNotComplex(t,"x");for(var e=this.readSync(t.dataId),n=new Uint8Array(e.length),r=0;r<e.length;++r)Number.isNaN(e[r])&&(n[r]=1);return ct.make(t.shape,{values:n},"bool")},e.prototype.isInf=function(t){this.assertNotComplex(t,"x");for(var e=this.readSync(t.dataId),n=new Uint8Array(e.length),r=0;r<e.length;++r)Math.abs(e[r])===1/0&&(n[r]=1);return ct.make(t.shape,{values:n},"bool")},e.prototype.isFinite=function(t){this.assertNotComplex(t,"x");for(var e=this.readSync(t.dataId),n=new Uint8Array(e.length),r=0;r<e.length;++r)Number.isFinite(e[r])&&(n[r]=1);return ct.make(t.shape,{values:n},"bool")},e.prototype.round=function(t){this.assertNotComplex(t,"round");for(var e=this.readSync(t.dataId),n=new Float32Array(e.length),r=0;r<e.length;++r){var i=Math.floor(e[r]);e[r]-i<.5?n[r]=Math.floor(e[r]):e[r]-i>.5?n[r]=Math.ceil(e[r]):n[r]=i%2==0?i:i+1}return ct.make(t.shape,{values:n})},e.prototype.exp=function(t){this.assertNotComplex(t,"exp");for(var e=this.readSync(t.dataId),n=new Float32Array(e.length),r=0;r<e.length;++r)n[r]=Math.exp(e[r]);return ct.make(t.shape,{values:n})},e.prototype.expm1=function(t){this.assertNotComplex(t,"expm1");for(var e=this.readSync(t.dataId),n=new Float32Array(e.length),r=0;r<e.length;++r)n[r]=Math.expm1(e[r]);return ct.make(t.shape,{values:n})},e.prototype.log=function(t){this.assertNotComplex(t,"log");for(var e=this.readSync(t.dataId),n=new Float32Array(e.length),r=0;r<e.length;++r){var i=e[r];n[r]=Math.log(i)}return ct.make(t.shape,{values:n})},e.prototype.log1p=function(t){this.assertNotComplex(t,"log1p");for(var e=this.readSync(t.dataId),n=new Float32Array(e.length),r=0;r<e.length;++r){var i=e[r];n[r]=Math.log1p(i)}return ct.make(t.shape,{values:n})},e.prototype.sqrt=function(t){this.assertNotComplex(t,"sqrt");for(var e=this.readSync(t.dataId),n=new Float32Array(e.length),r=0;r<e.length;++r){var i=e[r];n[r]=Math.sqrt(i)}return ct.make(t.shape,{values:n})},e.prototype.rsqrt=function(t){this.assertNotComplex(t,"rsqrt");for(var e=this.readSync(t.dataId),n=new Float32Array(e.length),r=0;r<e.length;++r){var i=e[r];n[r]=1/Math.sqrt(i)}return ct.make(t.shape,{values:n})},e.prototype.square=function(t){this.assertNotComplex(t,"square");for(var e=this.readSync(t.dataId),n=new Float32Array(e.length),r=0;r<e.length;++r){var i=e[r];n[r]=i*i}return ct.make(t.shape,{values:n})},e.prototype.reciprocal=function(t){this.assertNotComplex(t,"reciprocal");for(var e=this.readSync(t.dataId),n=new Float32Array(e.length),r=0;r<e.length;++r)n[r]=1/e[r];return ct.make(t.shape,{values:n})},e.prototype.linear=function(t){return t},e.prototype.relu=function(t){this.assertNotComplex(t,"relu");for(var e=dn(t.shape,t.dtype),n=this.readSync(e.dataId),r=this.readSync(t.dataId),i=0;i<r.length;++i)n[i]=Math.max(0,r[i]);return e},e.prototype.prelu=function(t,e){return this.assertNotComplex([t,e],"prelu"),this.broadcastedBinaryOp(t,e,t.dtype,function(t,e){return t<0?e*t:t})},e.prototype.elu=function(t){this.assertNotComplex(t,"elu");for(var e=new Float32Array(t.size),n=this.readSync(t.dataId),r=0;r<n.length;++r){var i=n[r];e[r]=i>=0?i:Math.exp(i)-1}return ct.make(t.shape,{values:e})},e.prototype.eluDer=function(t,e){this.assertNotComplex([t,e],"eluDer");for(var n=new Float32Array(e.size),r=this.readSync(e.dataId),i=this.readSync(t.dataId),a=0;a<r.length;++a){var o=r[a];n[a]=o>=1?i[a]:i[a]*(o+1)}return ct.make(e.shape,{values:n})},e.prototype.selu=function(t){this.assertNotComplex(t,"selu");for(var e=new Float32Array(t.size),n=this.readSync(t.dataId),r=0;r<n.length;++r){var i=n[r];e[r]=i>=0?1.0507009873554805*i:1.7580993408473768*(Math.exp(i)-1)}return ct.make(t.shape,{values:e})},e.prototype.clip=function(t,e,n){this.assertNotComplex(t,"clip");for(var r=new Float32Array(t.size),i=this.readSync(t.dataId),a=0;a<i.length;++a){var o=i[a];r[a]=o>n?n:o<e?e:o}return ct.make(t.shape,{values:r})},e.prototype.abs=function(t){for(var e=new Float32Array(t.size),n=this.readSync(t.dataId),r=0;r<n.length;++r)e[r]=Math.abs(n[r]);return ct.make(t.shape,{values:e})},e.prototype.complexAbs=function(t){for(var e=new Float32Array(t.size),n=this.readSync(t.dataId),r=0;r<t.size;++r){var i=n[2*r],a=n[2*r+1];e[r]=Math.hypot(i,a)}return ct.make(t.shape,{values:e})},e.prototype.int=function(t){this.assertNotComplex(t,"int");for(var e=new Int32Array(t.size),n=this.readSync(t.dataId),r=0;r<n.length;++r)e[r]=n[r];return ct.make(t.shape,{values:e},"int32")},e.prototype.sigmoid=function(t){this.assertNotComplex(t,"sigmoid");for(var e=new Float32Array(t.size),n=this.readSync(t.dataId),r=0;r<n.length;++r)e[r]=1/(1+Math.exp(-n[r]));return ct.make(t.shape,{values:e})},e.prototype.softplus=function(t){this.assertNotComplex(t,"softplus");for(var e=Math.log(1.1920928955078125e-7)+2,n=new Float32Array(t.size),r=this.readSync(t.dataId),i=0;i<r.length;++i){var a,o=r[i]>-e,s=r[i]<e,u=Math.exp(r[i]);a=s?u:o?r[i]:Math.log(1+u),n[i]=a}return ct.make(t.shape,{values:n})},e.prototype.sin=function(t){this.assertNotComplex(t,"sin");for(var e=new Float32Array(t.size),n=this.readSync(t.dataId),r=0;r<n.length;++r)e[r]=Math.sin(n[r]);return ct.make(t.shape,{values:e})},e.prototype.cos=function(t){this.assertNotComplex(t,"cos");for(var e=new Float32Array(t.size),n=this.readSync(t.dataId),r=0;r<n.length;++r)e[r]=Math.cos(n[r]);return ct.make(t.shape,{values:e})},e.prototype.tan=function(t){this.assertNotComplex(t,"tan");for(var e=new Float32Array(t.size),n=this.readSync(t.dataId),r=0;r<n.length;++r)e[r]=Math.tan(n[r]);return ct.make(t.shape,{values:e})},e.prototype.asin=function(t){this.assertNotComplex(t,"asin");for(var e=new Float32Array(t.size),n=this.readSync(t.dataId),r=0;r<n.length;++r)e[r]=Math.asin(n[r]);return ct.make(t.shape,{values:e})},e.prototype.acos=function(t){this.assertNotComplex(t,"acos");for(var e=new Float32Array(t.size),n=this.readSync(t.dataId),r=0;r<n.length;++r)e[r]=Math.acos(n[r]);return ct.make(t.shape,{values:e})},e.prototype.atan=function(t){this.assertNotComplex(t,"atan");for(var e=new Float32Array(t.size),n=this.readSync(t.dataId),r=0;r<n.length;++r)e[r]=Math.atan(n[r]);return ct.make(t.shape,{values:e})},e.prototype.atan2=function(t,e){return this.assertNotComplex([t,e],"atan2"),this.broadcastedBinaryOp(t,e,t.dtype,function(t,e){return Math.atan2(t,e)})},e.prototype.sinh=function(t){this.assertNotComplex(t,"sinh");for(var e=new Float32Array(t.size),n=this.readSync(t.dataId),r=0;r<n.length;++r)e[r]=Math.sinh(n[r]);return ct.make(t.shape,{values:e})},e.prototype.cosh=function(t){this.assertNotComplex(t,"cosh");for(var e=new Float32Array(t.size),n=this.readSync(t.dataId),r=0;r<n.length;++r)e[r]=Math.cosh(n[r]);return ct.make(t.shape,{values:e})},e.prototype.tanh=function(t){this.assertNotComplex(t,"tanh");for(var e=new Float32Array(t.size),n=this.readSync(t.dataId),r=0;r<n.length;++r)e[r]=x(n[r]);return ct.make(t.shape,{values:e})},e.prototype.asinh=function(t){this.assertNotComplex(t,"asinh");for(var e=new Float32Array(t.size),n=this.readSync(t.dataId),r=0;r<n.length;++r)e[r]=Math.asinh(n[r]);return ct.make(t.shape,{values:e})},e.prototype.acosh=function(t){this.assertNotComplex(t,"acosh");for(var e=new Float32Array(t.size),n=this.readSync(t.dataId),r=0;r<n.length;++r)e[r]=Math.acosh(n[r]);return ct.make(t.shape,{values:e})},e.prototype.atanh=function(t){this.assertNotComplex(t,"atanh");for(var e=new Float32Array(t.size),n=this.readSync(t.dataId),r=0;r<n.length;++r)e[r]=Math.atanh(n[r]);return ct.make(t.shape,{values:e})},e.prototype.erf=function(t){this.assertNotComplex(t,"erf");for(var e=new Float32Array(t.size),n=this.readSync(t.dataId),r=0;r<n.length;++r){var i=n[r],a=1/(1+.3275911*i);e[r]=1-((((1.061405429*a-1.453152027)*a+1.421413741)*a-.284496736)*a+.254829592)*a*Math.exp(-i*i)}return ct.make(t.shape,{values:e})},e.prototype.step=function(t,e){void 0===e&&(e=0),this.assertNotComplex(t,"step");for(var n=new Float32Array(t.size),r=this.readSync(t.dataId),i=0;i<r.length;++i){var a=r[i];isNaN(a)?n[i]=NaN:n[i]=a>0?1:e}return ct.make(t.shape,{values:n})},e.prototype.fusedConv2d=function(t,e,n,r,i,a){var o=this.conv2d(t,e,n);return r&&(o=this.add(o,r)),i&&(o=hc(this,o,i,a)),o},e.prototype.conv2d=function(t,e,n){this.assertNotComplex([t,e],"conv2d");for(var r=n.filterHeight,i=n.filterWidth,a=n.dilationHeight,o=n.dilationWidth,s=n.padInfo.left,u=n.padInfo.top,l="channelsLast"===n.dataFormat,c=Pn(n.outShape,t.dtype),p=t.strides[0],h=l?t.strides[1]:t.strides[2],f=l?t.strides[2]:1,d=l?1:t.strides[1],m=c.strides[0],g=l?c.strides[1]:c.strides[2],v=l?c.strides[2]:1,y=l?1:c.strides[1],b=this.readSync(t.dataId),x=this.readSync(e.dataId),w=c.values,N=0;N<n.batchSize;++N)for(var C=N*p,E=N*m,S=0;S<n.outHeight;++S)for(var k=E+S*g,I=S*n.strideHeight-u,A=0;A<r;A++){var R=I+A*a;if(!(R<0||R>=n.inHeight))for(var T=A*e.strides[0],D=C+R*h,O=0;O<n.outWidth;++O)for(var _=k+O*v,F=O*n.strideWidth-s,M=0;M<i;M++){var z=F+M*o;if(!(z<0||z>=n.inWidth))for(var L=D+z*f,P=T+M*e.strides[1],B=0;B<n.inChannels;++B){for(var V=b[L+B*d],W=0;W<n.outChannels;++W)w[_+W*y]+=V*x[P+W];P+=n.outChannels}}}return c.toTensor()},e.prototype.conv3d=function(t,e,n){for(var r=n.filterDepth,i=n.filterHeight,a=n.filterWidth,o=n.dilationDepth,s=n.dilationHeight,u=n.dilationWidth,l=n.padInfo.front,c=n.padInfo.left,p=n.padInfo.top,h=Pn(n.outShape,t.dtype),f=this.readSync(t.dataId),d=this.readSync(e.dataId),m=h.values,g=0;g<n.batchSize;++g)for(var v=g*t.strides[0],y=g*h.strides[0],b=0;b<n.outDepth;++b)for(var x=y+b*h.strides[1],w=b*n.strideDepth-l,N=0;N<r;N++){var C=w+N*o;if(!(C<0||C>=n.inDepth))for(var E=N*e.strides[0],S=v+C*t.strides[1],k=0;k<n.outHeight;++k)for(var I=x+k*h.strides[2],A=k*n.strideHeight-p,R=0;R<i;R++){var T=A+R*s;if(!(T<0||T>=n.inHeight))for(var D=E+R*e.strides[1],O=S+T*t.strides[2],_=0;_<n.outWidth;++_)for(var F=I+_*n.outChannels,M=_*n.strideWidth-c,z=0;z<a;z++){var L=M+z*u;if(!(L<0||L>=n.inWidth))for(var P=D+z*e.strides[2],B=O+L*n.inChannels,V=P,W=0;W<n.inChannels;++W){for(var U=f[B+W],j=0;j<n.outChannels;++j)m[F+j]+=U*d[V+j];V+=n.outChannels}}}}return h.toTensor()},e.prototype.conv2dDerInput=function(t,e,n){this.assertNotComplex([t,e],"conv2dDerInput");for(var r=Pn(n.inShape,"float32"),i=r.values,a=this.readSync(t.dataId),o=this.readSync(e.dataId),s=e.strides,u=s[0],l=s[1],c=s[2],p=n.batchSize,h=n.filterHeight,f=n.filterWidth,d=n.inChannels,m=n.inHeight,g=n.inWidth,v=n.outChannels,y=n.outHeight,b=n.outWidth,x=n.strideHeight,w=n.strideWidth,N=n.dataFormat,C=h-1-n.padInfo.top,E=f-1-n.padInfo.left,S="channelsLast"===N,k=r.strides[0],I=S?r.strides[1]:r.strides[2],A=S?r.strides[2]:1,R=S?1:r.strides[1],T=t.strides[0],D=S?t.strides[1]:t.strides[2],O=S?t.strides[2]:1,_=S?1:t.strides[1],F=0;F<p;++F)for(var M=0;M<d;++M)for(var z=0;z<m;++z)for(var L=z-C,P=Math.max(0,Math.ceil(L/x)),B=Math.min(y,(h+L)/x),V=0;V<g;++V){for(var W=V-E,U=Math.max(0,Math.ceil(W/w)),j=Math.min(b,(f+W)/w),q=0,H=P;H<B;++H)for(var G=H*x-L,K=U;K<j;++K)for(var $=T*F+D*H+O*K,X=u*(h-1-G)+l*(f-1-(K*w-W))+c*M,Y=0;Y<v;++Y)q+=a[$+_*Y]*o[X+Y];i[k*F+I*z+A*V+R*M]=q}return r.toTensor()},e.prototype.conv3dDerInput=function(t,e,n){for(var r=Pn(n.inShape,"float32"),i=r.values,a=r.strides,o=a[0],s=a[1],u=a[2],l=a[3],c=this.readSync(t.dataId),p=t.strides,h=p[0],f=p[1],d=p[2],m=p[3],g=this.readSync(e.dataId),v=e.strides,y=v[0],b=v[1],x=v[2],w=v[3],N=n.batchSize,C=n.filterDepth,E=n.filterHeight,S=n.filterWidth,k=n.inChannels,I=n.inDepth,A=n.inHeight,R=n.inWidth,T=n.outChannels,D=n.outDepth,O=n.outHeight,_=n.outWidth,F=n.strideDepth,M=n.strideHeight,z=n.strideWidth,L=C-1-n.padInfo.front,P=E-1-n.padInfo.top,B=S-1-n.padInfo.left,V=0;V<N;++V)for(var W=0;W<k;++W)for(var U=0;U<I;++U)for(var j=U-L,q=Math.max(0,Math.ceil(j/F)),H=Math.min(D,(C+j)/F),G=0;G<A;++G)for(var K=G-P,$=Math.max(0,Math.ceil(K/M)),X=Math.min(O,(E+K)/M),Y=0;Y<R;++Y){for(var J=Y-B,Z=Math.max(0,Math.ceil(J/z)),Q=Math.min(_,(S+J)/z),tt=0,et=q;et<H;++et)for(var nt=et*F-j,rt=$;rt<X;++rt)for(var it=rt*M-K,at=Z;at<Q;++at)for(var ot=h*V+f*et+d*rt+m*at,st=y*(C-1-nt)+b*(E-1-it)+x*(S-1-(at*z-J))+w*W,ut=0;ut<T;++ut)tt+=c[ot+ut]*g[st+ut];i[o*V+s*U+u*G+l*Y+W]=tt}return r.toTensor()},e.prototype.conv2dDerFilter=function(t,e,n){this.assertNotComplex([t,e],"conv2dDerFilter");for(var r=n.strideHeight,i=n.strideWidth,a=n.filterHeight,o=n.filterWidth,s="channelsLast"===n.dataFormat,u=Pn(n.filterShape,"float32"),l=n.padInfo.left,c=n.padInfo.top,p=this.bufferSync(t),h=this.bufferSync(e),f=0;f<a;++f)for(var d=Math.max(0,Math.ceil((c-f)/r)),m=Math.min(n.outHeight,(n.inHeight+c-f)/r),g=0;g<o;++g)for(var v=Math.max(0,Math.ceil((l-g)/i)),y=Math.min(n.outWidth,(n.inWidth+l-g)/i),b=0;b<n.inChannels;++b)for(var x=0;x<n.outChannels;++x){for(var w=0,N=0;N<n.batchSize;++N)for(var C=d;C<m;++C)for(var E=f+C*r-c,S=v;S<y;++S){var k=g+S*i-l;w+=s?p.get(N,E,k,b)*h.get(N,C,S,x):p.get(N,b,E,k)*h.get(N,x,C,S)}u.set(w,f,g,b,x)}return u.toTensor()},e.prototype.conv3dDerFilter=function(t,e,n){for(var r=n.strideDepth,i=n.strideHeight,a=n.strideWidth,o=n.filterDepth,s=n.filterHeight,u=n.filterWidth,l=Pn(n.filterShape,"float32"),c=l.values,p=l.strides,h=p[0],f=p[1],d=p[2],m=p[3],g=this.readSync(e.dataId),v=e.strides,y=v[0],b=v[1],x=v[2],w=v[3],N=this.readSync(t.dataId),C=t.strides,E=C[0],S=C[1],k=C[2],I=C[3],A=n.padInfo.front,R=n.padInfo.left,T=n.padInfo.top,D=0;D<o;++D)for(var O=Math.max(0,Math.ceil((A-D)/r)),_=Math.min(n.outDepth,(n.inDepth+A-D)/r),F=D*h,M=0;M<s;++M)for(var z=Math.max(0,Math.ceil((T-M)/i)),L=Math.min(n.outHeight,(n.inHeight+T-M)/i),P=M*f+F,B=0;B<u;++B)for(var V=Math.max(0,Math.ceil((R-B)/a)),W=Math.min(n.outWidth,(n.inWidth+R-B)/a),U=B*d+P,j=0;j<n.inChannels;++j)for(var q=j*m+U,H=0;H<n.outChannels;++H){for(var G=0,K=0;K<n.batchSize;++K)for(var $=K*E,X=K*y,Y=O;Y<_;++Y)for(var J=(D+Y*r-A)*S+$,Z=Y*b+X,Q=z;Q<L;++Q)for(var tt=(M+Q*i-T)*k+J,et=Q*x+Z,nt=V;nt<W;++nt){var rt=nt*w+et;G+=N[(B+nt*a-R)*I+tt+j]*g[rt+H]}c[q+H]=G}return l.toTensor()},e.prototype.depthwiseConv2D=function(t,e,n){this.assertNotComplex([t,e],"depthwiseConv2D");for(var r=n.filterHeight,i=n.filterWidth,a=n.dilationHeight,o=n.dilationWidth,s=n.padInfo.left,u=n.padInfo.top,l=n.outChannels/n.inChannels,c=Pn(n.outShape,t.dtype),p=this.readSync(t.dataId),h=this.readSync(e.dataId),f=c.values,d=0;d<n.batchSize;++d)for(var m=d*t.strides[0],g=d*c.strides[0],v=0;v<n.outHeight;++v)for(var y=g+v*c.strides[1],b=v*n.strideHeight-s,x=0;x<r;++x){var w=b+x*a;if(!(w<0||w>=n.inHeight))for(var N=x*e.strides[0],C=m+w*t.strides[1],E=0;E<n.outWidth;++E)for(var S=y+E*c.strides[2],k=E*n.strideWidth-u,I=0;I<i;++I){var A=k+I*o;if(!(A<0||A>=n.inWidth))for(var R=N+I*e.strides[1],T=C+A*n.inChannels,D=S,O=R,_=0;_<n.inChannels;++_){for(var F=p[T+_],M=0;M<l;++M)f[D+M]+=F*h[O+M];D+=l,O+=l}}}return c.toTensor()},e.prototype.depthwiseConv2DDerInput=function(t,e,n){this.assertNotComplex([t,e],"depthwiseConv2DDerInput");for(var r=Pn(n.inShape,"float32"),i=r.values,a=r.strides,o=a[0],s=a[1],u=a[2],l=this.readSync(t.dataId),c=t.strides,p=c[0],h=c[1],f=c[2],d=this.readSync(e.dataId),m=e.strides,g=m[0],v=m[1],y=m[2],b=n.batchSize,x=n.filterHeight,w=n.filterWidth,N=n.inChannels,C=n.inHeight,E=n.inWidth,S=n.outChannels,k=n.outHeight,I=n.outWidth,A=n.strideHeight,R=n.strideWidth,T=x-1-n.padInfo.top,D=w-1-n.padInfo.left,O=S/N,_=0;_<b;++_)for(var F=0;F<N;++F)for(var M=0;M<C;++M)for(var z=M-T,L=Math.max(0,Math.ceil(z/A)),P=Math.min(k,(x+z)/A),B=0;B<E;++B){for(var V=B-D,W=Math.max(0,Math.ceil(V/R)),U=Math.min(I,(w+V)/R),j=0,q=L;q<P;++q)for(var H=q*A-z,G=W;G<U;++G)for(var K=p*_+h*q+f*G,$=g*(x-1-H)+v*(w-1-(G*R-V))+y*F,X=0;X<O;++X)j+=l[K+(F*O+X)]*d[$+X];i[o*_+s*M+u*B+F]=j}return r.toTensor()},e.prototype.depthwiseConv2DDerFilter=function(t,e,n){this.assertNotComplex([t,e],"depthwiseConv2DDerFilter");for(var r=n.strideHeight,i=n.strideWidth,a=n.filterHeight,o=n.filterWidth,s=Pn(n.filterShape,"float32"),u=n.padInfo.left,l=n.padInfo.top,c=n.outChannels/n.inChannels,p=this.bufferSync(t),h=this.bufferSync(e),f=0;f<a;++f)for(var d=Math.max(0,Math.ceil((l-f)/r)),m=Math.min(n.outHeight,(n.inHeight+l-f)/r),g=0;g<o;++g)for(var v=Math.max(0,Math.ceil((u-g)/i)),y=Math.min(n.outWidth,(n.inWidth+u-g)/i),b=0;b<n.outChannels;++b){for(var x=Math.trunc(b/c),w=b%c,N=0,C=0;C<n.batchSize;++C)for(var E=d;E<m;++E)for(var S=f+E*r-l,k=v;k<y;++k){var I=g+k*i-u;N+=p.get(C,S,I,x)*h.get(C,E,k,b)}s.set(N,f,g,x,w)}return s.toTensor()},e.prototype.tile=function(t,e){return this.assertNotComplex(t,"tile"),ai(this.bufferSync(t),e)},e.prototype.pad=function(t,e,n){this.assertNotComplex(t,"pad");var r=e.map(function(e,n){return e[0]+t.shape[n]+e[1]}),i=e.map(function(t){return t[0]}),a=this.bufferSync(t),o=Pn(r,t.dtype);0!==n&&o.values.fill(n);for(var s=0;s<t.size;s++){var u=a.indexToLoc(s),l=u.map(function(t,e){return t+i[e]});o.set.apply(o,[a.get.apply(a,u)].concat(l))}return o.toTensor()},e.prototype.transpose=function(t,e){this.assertNotComplex(t,"transpose");for(var n=new Array(t.rank),r=0;r<n.length;r++)n[r]=t.shape[e[r]];var i=this.readSync(t.dataId),a=Pn(n,t.dtype),o=this.bufferSync(t);for(r=0;r<t.size;++r){for(var s=o.indexToLoc(r),u=new Array(s.length),l=0;l<u.length;l++)u[l]=s[e[l]];var c=a.locToIndex(u);a.values[c]=i[r]}return a.toTensor()},e.prototype.gather=function(t,e,n){this.assertNotComplex([t,e],"gather");var r=t.shape.slice(),i=this.readSync(e.dataId);r[n]=i.length;for(var a=Pn(r,t.dtype),o=this.bufferSync(t),s=0;s<a.size;++s){var u=a.indexToLoc(s),l=u.slice();l[n]=i[u[n]];var c=o.locToIndex(l);a.values[s]=o.values[c]}return a.toTensor()},e.prototype.batchToSpaceND=function(t,e,n){this.assertNotComplex([t],"batchToSpaceND");var r=e.reduce(function(t,e){return t*e}),i=hr(t.shape,e,r),a=fr(i.length,e.length),o=dr(t.shape,e,r),s=mr(n,e.length),u=gr(o,n,e.length);return t.reshape(i).transpose(a).reshape(o).slice(s,u)},e.prototype.spaceToBatchND=function(t,e,n){this.assertNotComplex([t],"spaceToBatchND");var r=e.reduce(function(t,e){return t*e}),i=[[0,0]];i.push.apply(i,n);for(var a=1+e.length;a<t.shape.length;++a)i.push([0,0]);var o=t.pad(i),s=hr(o.shape,e,r,!1),u=fr(s.length,e.length,!1),l=dr(o.shape,e,r,!1);return o.reshape(s).transpose(u).reshape(l)},e.prototype.pool=function(t,e,n){this.assertNotComplex(t,"pool");for(var r=e.strideHeight,i=e.strideWidth,a=e.dilationHeight,o=e.dilationWidth,s=e.effectiveFilterHeight,u=e.effectiveFilterWidth,l=e.padInfo.top,c=e.padInfo.left,p="max"===n?Number.NEGATIVE_INFINITY:Number.POSITIVE_INFINITY,h=this.readSync(t.dataId),f=Pn(e.outShape,t.dtype),d=f.values,m=e.outShape[1]*e.outShape[2]*e.outShape[3],g=e.outShape[2]*e.outShape[3],v=e.outShape[3],y=0;y<e.batchSize;++y)for(var b=y*m,x=y*t.strides[0],w=0;w<e.inChannels;++w)for(var N=0;N<e.outHeight;++N)for(var C=N*r-l,E=Math.max(0,C),S=Math.min(e.inHeight,s+C),k=b+N*g,I=0;I<e.outWidth;++I){for(var A=I*i-c,R=Math.max(0,A),T=Math.min(e.inWidth,u+A),D=p,O=0,_=0,F=E;F<S;F+=a){for(var M=x+F*t.strides[1],z=R;z<T;z+=o){var L=h[M+z*t.strides[2]+w];"max"===n&&L>D?D=L:"avg"===n&&(O+=L,_++)}if(isNaN(D))break}d[k+I*v+w]="avg"===n?O/_:D}return f.toTensor()},e.prototype.maxPool=function(t,e){return this.pool(t,e,"max")},e.prototype.maxPoolPositions=function(t,e){for(var n=Pn(e.outShape,"int32"),r=e.strideHeight,i=e.strideWidth,a=e.dilationHeight,o=e.dilationWidth,s=e.effectiveFilterHeight,u=e.effectiveFilterWidth,l=e.padInfo.top,c=e.padInfo.left,p=this.bufferSync(t),h=0;h<e.batchSize;++h)for(var f=0;f<e.inChannels;++f)for(var d=0;d<e.outHeight;++d){for(var m=d*r-l,g=m;g<0;)g+=a;for(var v=Math.min(e.inHeight,s+m),y=0;y<e.outWidth;++y){for(var b=y*i-c,x=b;x<0;)x+=o;for(var w=Math.min(e.inWidth,u+b),N=Number.NEGATIVE_INFINITY,C=-1,E=g;E<v;E+=a)for(var S=E-m,k=x;k<w;k+=o){var I=k-b,A=p.get(h,E,k,f);A>N&&(N=A,C=S*u+I)}n.set(C,h,d,y,f)}}return n.toTensor()},e.prototype.maxPoolBackprop=function(t,e,n,r){this.assertNotComplex([e,n],"maxPoolBackprop");for(var i=this.maxPoolPositions(e,r),a=r.strideHeight,o=r.strideWidth,s=r.dilationHeight,u=r.dilationWidth,l=r.effectiveFilterHeight,c=r.effectiveFilterWidth,p=c-1-r.padInfo.left,h=l-1-r.padInfo.top,f=Pn(e.shape,"float32"),d=this.bufferSync(i),m=this.bufferSync(t),g=0;g<r.batchSize;++g)for(var v=0;v<r.inChannels;++v)for(var y=0;y<r.inHeight;++y)for(var b=0;b<r.inWidth;++b){for(var x=y-h,w=b-p,N=0,C=0;C<l;C+=s){var E=(x+C)/a;if(!(E<0||E>=r.outHeight||Math.floor(E)!==E))for(var S=0;S<c;S+=u){var k=(w+S)/o;if(!(k<0||k>=r.outWidth||Math.floor(k)!==k)){var I=l*c-1-d.get(g,E,k,v)===C*c+S?1:0;0!==I&&(N+=m.get(g,E,k,v)*I)}}}f.set(N,g,y,b,v)}return f.toTensor()},e.prototype.avgPoolBackprop=function(t,e,n){this.assertNotComplex([t,e],"avgPoolBackprop");for(var r=n.strideHeight,i=n.strideWidth,a=n.filterHeight,o=n.filterWidth,s=n.dilationHeight,u=n.dilationWidth,l=n.effectiveFilterHeight,c=n.effectiveFilterWidth,p=c-1-n.padInfo.left,h=l-1-n.padInfo.top,f=Pn(e.shape,"float32"),d=1/(a*o),m=this.bufferSync(t),g=0;g<n.batchSize;++g)for(var v=0;v<n.inChannels;++v)for(var y=0;y<n.inHeight;++y)for(var b=0;b<n.inWidth;++b){for(var x=y-h,w=b-p,N=0,C=0;C<l;C+=s){var E=(x+C)/r;if(!(E<0||E>=n.outHeight||Math.floor(E)!==E))for(var S=0;S<c;S+=u){var k=(w+S)/i;k<0||k>=n.outWidth||Math.floor(k)!==k||(N+=m.get(g,E,k,v))}}f.set(N*d,g,y,b,v)}return f.toTensor()},e.prototype.pool3d=function(t,e,n){this.assertNotComplex(t,"pool3d");for(var r=e.strideDepth,i=e.strideHeight,a=e.strideWidth,o=e.dilationDepth,s=e.dilationHeight,u=e.dilationWidth,l=e.effectiveFilterDepth,c=e.effectiveFilterHeight,p=e.effectiveFilterWidth,h=e.padInfo.front,f=e.padInfo.top,d=e.padInfo.left,m="max"===n?Number.NEGATIVE_INFINITY:Number.POSITIVE_INFINITY,g=this.readSync(t.dataId),v=Pn(e.outShape,t.dtype),y=v.values,b=e.outShape[1]*e.outShape[2]*e.outShape[3]*e.outShape[4],x=e.outShape[2]*e.outShape[3]*e.outShape[4],w=e.outShape[3]*e.outShape[4],N=e.outShape[4],C=0;C<e.batchSize;++C)for(var E=C*b,S=C*t.strides[0],k=0;k<e.inChannels;++k)for(var I=0;I<e.outDepth;++I){for(var A=I*r-h,R=A;R<0;)R+=o;for(var T=Math.min(e.inDepth,l+A),D=E+I*x,O=0;O<e.outHeight;++O){for(var _=O*i-f,F=_;F<0;)F+=s;for(var M=Math.min(e.inHeight,c+_),z=D+O*w,L=0;L<e.outWidth;++L){for(var P=L*a-d,B=P;B<0;)B+=u;for(var V=Math.min(e.inWidth,p+P),W=z+L*N,U=m,j=0,q=0,H=R;H<T;H+=o){for(var G=S+H*t.strides[1],K=F;K<M;K+=s){for(var $=G+K*t.strides[2],X=B;X<V;X+=u){var Y=g[$+X*t.strides[3]+k];if("max"===n&&Y>U?U=Y:"avg"===n&&(j+=Y,q++),isNaN(U))break}if(isNaN(U))break}if(isNaN(U))break}y[W+k]="avg"===n?j/q:U}}}return v.toTensor()},e.prototype.avgPool3d=function(t,e){return this.assertNotComplex(t,"avgPool3d"),this.pool3d(t,e,"avg").toFloat()},e.prototype.avgPool3dBackprop=function(t,e,n){this.assertNotComplex([t,e],"avgPool3dBackprop");for(var r=n.strideDepth,i=n.strideHeight,a=n.strideWidth,o=n.filterDepth,s=n.filterHeight,u=n.filterWidth,l=n.dilationDepth,c=n.dilationHeight,p=n.dilationWidth,h=n.effectiveFilterDepth,f=n.effectiveFilterHeight,d=n.effectiveFilterWidth,m=h-1-n.padInfo.front,g=d-1-n.padInfo.left,v=f-1-n.padInfo.top,y=Pn(e.shape,"float32"),b=1/(o*s*u),x=this.bufferSync(t),w=0;w<n.batchSize;++w)for(var N=0;N<n.inChannels;++N)for(var C=0;C<n.inDepth;++C)for(var E=0;E<n.inHeight;++E)for(var S=0;S<n.inWidth;++S){for(var k=C-m,I=E-v,A=S-g,R=0,T=0;T<h;T+=l){var D=(k+T)/r;if(!(D<0||D>=n.outDepth||Math.floor(D)!==D))for(var O=0;O<f;O+=c){var _=(I+O)/i;if(!(_<0||_>=n.outHeight||Math.floor(_)!==_))for(var F=0;F<d;F+=p){var M=(A+F)/a;M<0||M>=n.outWidth||Math.floor(M)!==M||(R+=x.get(w,D,_,M,N))}}}y.set(R*b,w,C,E,S,N)}return y.toTensor()},e.prototype.maxPool3d=function(t,e){return this.assertNotComplex(t,"maxPool3d"),this.pool3d(t,e,"max").toFloat()},e.prototype.maxPool3dPositions=function(t,e){for(var n=Pn(e.outShape,"int32"),r=e.strideDepth,i=e.strideHeight,a=e.strideWidth,o=e.dilationDepth,s=e.dilationHeight,u=e.dilationWidth,l=e.effectiveFilterDepth,c=e.effectiveFilterHeight,p=e.effectiveFilterWidth,h=e.padInfo.front,f=e.padInfo.top,d=e.padInfo.left,m=this.bufferSync(t),g=0;g<e.batchSize;++g)for(var v=0;v<e.inChannels;++v)for(var y=0;y<e.outDepth;++y){for(var b=y*r-h,x=b;x<0;)x+=o;for(var w=Math.min(e.inDepth,l+b),N=0;N<e.outHeight;++N){for(var C=N*i-f,E=C;E<0;)E+=s;for(var S=Math.min(e.inHeight,c+C),k=0;k<e.outWidth;++k){for(var I=k*a-d,A=I;A<0;)A+=u;for(var R=Math.min(e.inWidth,p+I),T=Number.NEGATIVE_INFINITY,D=-1,O=x;O<w;O+=o)for(var _=O-b,F=E;F<S;F+=s)for(var M=F-C,z=A;z<R;z+=u){var L=z-I,P=m.get(g,O,F,z,v);P>=T&&(T=P,D=_*c*p+M*c+L)}n.set(D,g,y,N,k,v)}}}return n.toTensor()},e.prototype.maxPool3dBackprop=function(t,e,n,r){this.assertNotComplex([e,n],"maxPool3dBackprop");for(var i=this.maxPool3dPositions(e,r),a=r.strideDepth,o=r.strideHeight,s=r.strideWidth,u=r.dilationDepth,l=r.dilationHeight,c=r.dilationWidth,p=r.effectiveFilterDepth,h=r.effectiveFilterHeight,f=r.effectiveFilterWidth,d=p-1-r.padInfo.front,m=f-1-r.padInfo.left,g=h-1-r.padInfo.top,v=Pn(e.shape,"float32"),y=this.bufferSync(i),b=this.bufferSync(t),x=0;x<r.batchSize;++x)for(var w=0;w<r.inChannels;++w)for(var N=0;N<r.inDepth;++N)for(var C=0;C<r.inHeight;++C)for(var E=0;E<r.inWidth;++E){for(var S=N-d,k=C-g,I=E-m,A=0,R=0;R<p;R+=u){var T=(S+R)/a;if(!(T<0||T>=r.outDepth||Math.floor(T)!==T))for(var D=0;D<h;D+=l){var O=(k+D)/o;if(!(O<0||O>=r.outHeight||Math.floor(O)!==O))for(var _=0;_<f;_+=c){var F=(I+_)/s;if(!(F<0||F>=r.outWidth||Math.floor(F)!==F)){var M=p*h*f-1-y.get(x,T,O,F,w)===R*h*f+D*f+_?1:0;0!==M&&(A+=b.get(x,T,O,F,w)*M)}}}}v.set(A,x,N,C,E,w)}return v.toTensor()},e.prototype.cast=function(t,e){return $r(t,e,this)},e.prototype.reshape=function(t,e){return Xr(t,e)},e.prototype.avgPool=function(t,e){return this.assertNotComplex(t,"avgPool"),this.pool(t,e,"avg").toFloat()},e.prototype.resizeBilinear=function(t,e,n,r){this.assertNotComplex(t,"resizeBilinear");for(var i=t.shape,a=i[0],o=i[1],s=i[2],u=i[3],l=this.readSync(t.dataId),c=new Float32Array(v([a,e,n,u])),p=[r&&e>1?o-1:o,r&&n>1?s-1:s],h=[r&&e>1?e-1:e,r&&n>1?n-1:n],f=0,d=p[0]/h[0],m=p[1]/h[1],g=0;g<a;g++)for(var y=0;y<e;y++)for(var b=d*y,x=Math.floor(b),w=b-x,N=Math.min(o-1,Math.ceil(b)),C=g*t.strides[0]+x*t.strides[1],E=g*t.strides[0]+N*t.strides[1],S=0;S<n;S++)for(var k=m*S,I=Math.floor(k),A=k-I,R=Math.min(s-1,Math.ceil(k)),T=C+I*t.strides[2],D=E+I*t.strides[2],O=C+ +R*t.strides[2],_=E+R*t.strides[2],F=0;F<u;F++){var M=l[T+F],z=l[D+F],L=M+(l[O+F]-M)*A,P=L+(z+(l[_+F]-z)*A-L)*w;c[f++]=P}return rn(c,[a,e,n,u])},e.prototype.resizeBilinearBackprop=function(t,e,n){this.assertNotComplex([t,e],"resizeBilinearBackprop");for(var r=e.shape,i=r[0],a=r[1],o=r[2],s=r[3],u=t.shape,l=u[1],c=u[2],p=new Float32Array(i*a*o*s),h=[n&&l>1?a-1:a,n&&c>1?o-1:o],f=[n&&l>1?l-1:l,n&&c>1?c-1:c],d=h[0]/f[0],m=h[1]/f[1],g=this.readSync(t.dataId),v=0,y=0;y<i;y++)for(var b=y*e.strides[0],x=0;x<l;x++)for(var w=x*d,N=Math.floor(w),C=Math.min(Math.ceil(w),a-1),E=b+N*e.strides[1],S=b+C*e.strides[1],k=w-N,I=1-k,A=0;A<c;A++)for(var R=A*m,T=Math.floor(R),D=Math.min(Math.ceil(R),o-1),O=R-T,_=1-O,F=E+T*e.strides[2],M=E+D*e.strides[2],z=S+T*e.strides[2],L=S+D*e.strides[2],P=I*_,B=I*O,V=k*_,W=k*O,U=0;U<s;U++){var j=g[v++];p[F+U]+=j*P,p[M+U]+=j*B,p[z+U]+=j*V,p[L+U]+=j*W}return cn(p,[i,o,a,s],e.dtype)},e.prototype.resizeNearestNeighbor=function(t,e,n,r){this.assertNotComplex(t,"resizeNearestNeighbor");for(var i=t.shape,a=i[0],o=i[1],s=i[2],u=i[3],l=this.readSync(t.dataId),c=new Float32Array(a*e*n*u),p=[r&&e>1?o-1:o,r&&n>1?s-1:s],h=[r&&e>1?e-1:e,r&&n>1?n-1:n],f=p[0]/h[0],d=p[1]/h[1],m=0,g=0;g<a;g++)for(var v=g*t.strides[0],y=0;y<e;y++)for(var b=f*y,x=v+Math.min(o-1,r?Math.round(b):Math.floor(b))*t.strides[1],w=0;w<n;w++)for(var N=d*w,C=x+Math.min(s-1,r?Math.round(N):Math.floor(N))*t.strides[2],E=0;E<u;E++){var S=l[C+E];c[m++]=S}return rn(c,[a,e,n,u],t.dtype)},e.prototype.resizeNearestNeighborBackprop=function(t,e,n){this.assertNotComplex([t,e],"resizeNearestNeighborBackprop");for(var r=e.shape,i=r[0],a=r[1],o=r[2],s=r[3],u=t.shape,l=u[1],c=u[2],p=new Float32Array(i*a*o*s),h=this.readSync(t.dataId),f=[n&&l>1?a-1:a,n&&c>1?o-1:o],d=[n&&l>1?l-1:l,n&&c>1?c-1:c],m=f[0]/d[0],g=f[1]/d[1],v=1/m,y=1/g,b=2*Math.ceil(v)+2,x=2*Math.ceil(y)+2,w=0;w<i;w++)for(var N=w*e.strides[0],C=0;C<a;C++)for(var E=N+C*e.strides[1],S=Math.floor(C*v),k=Math.floor(S-b/2),I=0;I<o;I++)for(var A=E+I*e.strides[2],R=Math.floor(I*y),T=Math.floor(R-x/2),D=0;D<s;D++){for(var O=0,_=0;_<b;_++){var F=_+k;if(!(F<0||F>=l)){var M=N+F*t.strides[1],z=F*m;if(C===Math.min(a-1,n?Math.round(z):Math.floor(z)))for(var L=0;L<x;L++){var P=L+T;if(!(P<0||P>=c)){var B=M+P*t.strides[2],V=P*g;I===Math.min(o-1,n?Math.round(V):Math.floor(V))&&(O+=h[B+D])}}}}p[A+D]=O}return cn(p,e.shape,e.dtype)},e.prototype.batchNormalization=function(t,e,n,r,i,a){this.assertNotComplex([t,e,n,i,a],"batchNorm");for(var o=this.readSync(t.dataId),s=this.readSync(e.dataId),u=this.readSync(n.dataId),l=i?this.readSync(i.dataId):new Float32Array([1]),c=a?this.readSync(a.dataId):new Float32Array([0]),p=new Float32Array(o.length),h=c.length,f=l.length,d=u.length,m=s.length,g=0,v=0,y=0,b=0,x=0;x<o.length;++x)p[x]=c[g++]+(o[x]-s[v++])*l[y++]/Math.sqrt(u[b++]+r),g>=h&&(g=0),v>=m&&(v=0),y>=f&&(y=0),b>=d&&(b=0);return cn(p,t.shape)},e.prototype.localResponseNormalization4D=function(t,e,n,r,i){this.assertNotComplex(t,"localResponseNormalization4D");var a=t.shape[3],o=a-1,s=this.readSync(t.dataId),u=t.size,l=new Float32Array(u);function c(t){for(var n=t%a,r=t-n+Math.max(0,n-e),i=t-n+Math.min(n+e,o),u=0;r<=i;r++){var l=s[r];u+=l*l}return u}for(var p=0;p<u;p++){var h=c(p),f=s[p]*Math.pow(n+r*h,-i);l[p]=f}return cn(l,t.shape)},e.prototype.LRNGrad=function(t,e,n,r,i,a,o){this.assertNotComplex(t,"LRNGrad");for(var s=t.shape[3],u=this.readSync(t.dataId),l=this.readSync(e.dataId),c=this.readSync(n.dataId),p=new Float32Array(t.size),h=t.size,f=0;f<h;f++){for(var d=f%s,m=f-d+Math.max(0,d-r),g=f-d+Math.min(s,d+r+1),v=0,y=m;y<g;y++)v+=Math.pow(l[y],2);for(v=a*v+i,y=m;y<g;y++){var b=-2*a*o*l[y]*c[f]/v;f===y&&(b+=Math.pow(v,-o)),b*=u[f],p[y]+=b}}return cn(p,t.shape)},e.prototype.multinomial=function(t,e,n,r){this.assertNotComplex(t,"multinomial");for(var i=e?t:Rr(t),a=i.shape[0],o=i.shape[1],s=dn([a,n],"int32"),u=this.readSync(s.dataId),l=this.readSync(i.dataId),c=0;c<a;++c){var p=c*o,h=new Float32Array(o-1);h[0]=l[p];for(var f=1;f<h.length;++f)h[f]=h[f-1]+l[p+f];for(var d=Fn(r.toString()),m=c*n,g=0;g<n;++g){var v=d();u[m+g]=h.length;for(var y=0;y<h.length;y++)if(v<h[y]){u[m+g]=y;break}}}return s},e.prototype.oneHot=function(t,e,n,r){this.assertNotComplex(t,"oneHot");var i=new Float32Array(t.size*e);i.fill(r);for(var a=this.readSync(t.dataId),o=0;o<t.size;++o)a[o]>=0&&a[o]<e&&(i[o*e+a[o]]=n);return un(i,[t.size,e],"int32")},e.prototype.nonMaxSuppression=function(t,e,n,r,i){return this.assertNotComplex(t,"nonMaxSuppression"),ni(this.readSync(t.dataId),this.readSync(e.dataId),n,r,i)},e.prototype.fft=function(t){return this.fftBatch(t,!1)},e.prototype.ifft=function(t){return this.fftBatch(t,!0)},e.prototype.fftBatch=function(t,e){for(var n=t.shape[0],r=t.shape[1],i=Pn(t.shape,"float32"),a=Pn(t.shape,"float32"),o=en(t).as2D(n,r),s=nn(t).as2D(n,r),u=0;u<n;u++)for(var l=o.slice([u,0],[1,r]),c=s.slice([u,0],[1,r]),p=tn(l,c),h=this.readSync(this.fftImpl(p,e).dataId),f=0;f<r;f++){var d=Qr(h,f);i.values[u*r+f]=d.real,a.values[u*r+f]=d.imag}return tn(i.toTensor(),a.toTensor()).as2D(n,r)},e.prototype.fftImpl=function(t,e){var n=t.as1D(),r=n.size;if(this.isExponentOf2(r)){var i=this.fftRadix2(n,r,e).as2D(t.shape[0],t.shape[1]);return e&&(i=tn(en(i).div(on(r)),nn(i).div(on(r)))),i}var a=this.readSync(t.dataId),o=function(t){for(var e=new Float32Array(t.length/2),n=new Float32Array(t.length/2),r=0;r<t.length;r+=2)e[r/2]=t[r],n[r/2]=t[r+1];return{real:e,imag:n}}(this.fourierTransformByMatmul(a,r,e));return tn(o.real,o.imag).as2D(t.shape[0],t.shape[1])},e.prototype.isExponentOf2=function(t){return 0==(t&t-1)},e.prototype.fftRadix2=function(t,e,n){if(1===e)return t;var r=this.readSync(t.dataId),i=e/2,a=function(t){for(var e=Math.ceil(t.length/4),n=new Float32Array(e),r=new Float32Array(e),i=0;i<t.length;i+=4)n[Math.floor(i/4)]=t[i],r[Math.floor(i/4)]=t[i+1];return{real:n,imag:r}}(r),o=tn(a.real,a.imag).as1D(),s=function(t){for(var e=Math.floor(t.length/4),n=new Float32Array(e),r=new Float32Array(e),i=2;i<t.length;i+=4)n[Math.floor(i/4)]=t[i],r[Math.floor(i/4)]=t[i+1];return{real:n,imag:r}}(r),u=tn(s.real,s.imag).as1D();o=this.fftRadix2(o,i,n),u=this.fftRadix2(u,i,n);var l=function(t,e){for(var n=new Float32Array(t/2),r=new Float32Array(t/2),i=0;i<Math.ceil(t/2);i++){var a=(e?2:-2)*Math.PI*(i/t);n[i]=Math.cos(a),r[i]=Math.sin(a)}return{real:n,imag:r}}(e,n),c=tn(l.real,l.imag).mul(u),p=o.add(c),h=o.sub(c),f=en(p).concat(en(h)),d=nn(p).concat(nn(h));return tn(f,d).as1D()},e.prototype.fourierTransformByMatmul=function(t,e,n){for(var r=new Float32Array(2*e),i=0;i<e;i++){for(var a=0,o=0,s=0;s<e;s++){var u=ei(i*s,e,n),l=Qr(t,s);a+=l.real*u.real-l.imag*u.imag,o+=l.real*u.imag+l.imag*u.real}n&&(a/=e,o/=e),ti(r,a,o,i)}return r},e.prototype.depthToSpace=function(t,e,n){f("NHWC"===n,function(){return"Only NHWC dataFormat supported on CPU for depthToSpace. Got "+n}),f(e>1,function(){return"blockSize should be > 1 for depthToSpace, but was: "+e});for(var r=t.shape[0],i=t.shape[1],a=t.shape[2],o=t.shape[3],s=i*e,u=a*e,l=o/(e*e),c=this.readSync(t.dataId),p=new Float32Array(r*s*u*l),h=0,d=0;d<r;++d)for(var m=0;m<s;++m)for(var g=Math.floor(m/e),v=m%e,y=0;y<u;++y)for(var b=Math.floor(y/e),x=(v*e+y%e)*l,w=0;w<l;++w){var N=w+x+o*(b+a*(g+i*d));p[h++]=c[N]}return cn(p,[r,s,u,l])},e.prototype.broadcastedBinaryOp=function(t,e,n,r){var i=Mr(t.shape,e.shape),a=Pn(i,n),o=this.readSync(t.dataId),s=this.readSync(e.dataId),u=_r(t.shape,i),l=_r(e.shape,i),c=a.values;if(u.length+l.length===0)for(var p=0;p<c.length;++p)c[p]=r(o[p%o.length],s[p%s.length]);else{var h=this.bufferSync(t),f=this.bufferSync(e),d=function(n){var i=a.indexToLoc(n),p=i.slice(-t.rank);u.forEach(function(t){return p[t]=0});var d=h.locToIndex(p),m=i.slice(-e.rank);l.forEach(function(t){return m[t]=0});var g=f.locToIndex(m);c[n]=r(o[d],s[g])};for(p=0;p<c.length;++p)d(p)}return a.toTensor()},e.prototype.broadcastedBinaryComplexOp=function(t,e,n){var r=Mr(t.shape,e.shape),i=Pn(r,"float32"),a=Pn(r,"float32"),o=this.readSync(t.dataId),s=this.readSync(e.dataId),u=_r(t.shape,r),l=_r(e.shape,r),c=i.values,p=a.values;if(u.length+l.length===0)for(var h=0;h<c.length;h++){var f=h%o.length,d=h%s.length,m=n(o[2*f],o[2*f+1],s[2*d],s[2*d+1]);c[h]=m.real,p[h]=m.imag}else{var g=this.bufferSync(this.data.get(t.dataId).complexTensors.real),v=this.bufferSync(this.data.get(e.dataId).complexTensors.real),y=function(r){var a=i.indexToLoc(r),h=a.slice(-t.rank);u.forEach(function(t){return h[t]=0});var f=g.locToIndex(h),d=a.slice(-e.rank);l.forEach(function(t){return d[t]=0});var m=v.locToIndex(d),y=n(o[2*f],o[2*f+1],s[2*m],s[2*m+1]);c[r]=y.real,p[r]=y.imag};for(h=0;h<c.length;h++)y(h)}return this.complex(i.toTensor(),a.toTensor())},e.prototype.split=function(t,e,n){return ii(t,e,n)},e.prototype.dispose=function(){},e.prototype.floatPrecision=function(){return 32},e.prototype.epsilon=function(){return 1e-7},e.prototype.cropAndResize=function(t,e,n,r,i,a){for(var o=t.shape,s=o[0],u=o[1],l=o[2],c=o[3],p=e.shape[0],h=r[0],f=r[1],d=Pn([p,h,f,c],t.dtype),m=this.readSync(e.dataId),g=this.readSync(n.dataId),v=this.readSync(t.dataId),y=t.strides,b=d.strides,x=0;x<p;x++){var w=4*x,N=m[w],C=m[w+1],E=m[w+2],S=m[w+3],k=g[x];if(!(k>=s))for(var I=h>1?(E-N)*(u-1)/(h-1):0,A=f>1?(S-C)*(l-1)/(f-1):0,R=0;R<h;R++){var T=h>1?N*(u-1)+R*I:.5*(N+E)*(u-1);if(T<0||T>u-1)for(var D=0;D<f;D++)for(var O=0;O<c;O++){var _=O+D*b[2]+R*b[1]+x*b[0];d.values[_]=a}else if("bilinear"===i){var F=Math.floor(T),M=Math.ceil(T),z=T-F;for(D=0;D<f;D++)if((H=f>1?C*(l-1)+D*A:.5*(C+S)*(l-1))<0||H>l-1)for(O=0;O<c;O++)_=O+D*b[2]+R*b[1]+x*b[0],d.values[_]=a;else{var L=Math.floor(H),P=Math.ceil(H),B=H-L;for(O=0;O<c;O++){var V=v[_=O+L*y[2]+F*y[1]+k*y[0]],W=v[_=O+P*y[2]+F*y[1]+k*y[0]],U=v[_=O+L*y[2]+M*y[1]+k*y[0]],j=V+(W-V)*B,q=U+(v[_=O+P*y[2]+M*y[1]+k*y[0]]-U)*B;_=O+D*b[2]+R*b[1]+x*b[0],d.values[_]=j+(q-j)*z}}}else for(D=0;D<f;++D){var H;if((H=f>1?C*(l-1)+D*A:.5*(C+S)*(l-1))<0||H>l-1)for(O=0;O<c;O++)_=O+D*b[2]+R*b[1]+x*b[0],d.values[_]=a;else{var G=Math.round(H),K=Math.round(T);for(O=0;O<c;O++){var $=O+G*y[2]+K*y[1]+k*y[0],X=O+D*b[2]+R*b[1]+x*b[0];d.values[X]=v[$]}}}}}return d.toTensor()},e.prototype.sparseToDense=function(t,e,n,r){var i=xr(0,t,n),a=i.sliceRank,o=i.numUpdates,s=i.sliceSize,u=i.strides,l=i.outputSize;return this.scatter(t,e,n,l,s,o,a,u,r,!1)},e.prototype.gatherND=function(t,e){var n=e.shape,r=n[n.length-1],i=vr(t,e),a=i[0],o=i[1],s=i[2],u=i[3];if(0===o)return rn([],a,t.dtype);for(var l=new ot([o,s],t.dtype),c=this.readSync(e.dataId),p=this.readSync(t.dataId),h=0;h<o;h++){for(var f=[],d=0,m=0;m<r;m++){var g=c[h*r+m];d+=g*u[m],f.push(g)}if(d<0||d>=t.size/s)throw new Error("Invalid indices: "+f+" does not index into "+t.shape);for(var v=0;v<s;v++)l.values[h*s+v]=p[d*s+v]}return l.toTensor().reshape(a)},e.prototype.scatterND=function(t,e,n){var r=xr(0,t,n),i=r.sliceRank,a=r.numUpdates,o=r.sliceSize,s=r.strides,u=r.outputSize,l=on(0);return this.scatter(t,e,n,u,o,a,i,s,l,!0)},e.prototype.fill=function(t,e,n){var r=A(n=n||B(e),v(t));return r.fill(e),ct.make(t,{values:r},n)},e.prototype.onesLike=function(t){if("string"===t.dtype)throw new Error("onesLike is not supported for string tensors");return this.fill(t.shape,1,t.dtype)},e.prototype.zerosLike=function(t){var e=A(t.dtype,v(t.shape));return ct.make(t.shape,{values:e},t.dtype)},e.prototype.linspace=function(t,e,n){return Yr(t,e,n)},e.prototype.scatter=function(t,e,n,r,i,a,o,s,u,l){var c=[r/i,i],p=this.readSync(t.dataId),h=this.readSync(e.dataId);if(0===r)return rn([],n,e.dtype);var f=new ot(c,e.dtype);f.values.fill(this.readSync(u.dataId)[0]);for(var d=0;d<a;d++){for(var m=[],g=0,v=0;v<o;v++){var y=p[d*o+v];m.push(y),g+=y*s[v]}if(g<0||g>=r/i)throw new Error("Invalid indices: "+m+" does not index into "+n);for(var b=0;b<i;b++)l?f.values[g*i+b]+=h[d*i+b]:f.values[g*i+b]=0===e.rank?h[0]:h[d*i+b]}return f.toTensor().reshape(n)},e}();It.registerBackend("cpu",function(){return new fc},1);var dc=function(){function t(){this.textEncoder=new TextEncoder}return t.prototype.fetch=function(t,e){return fetch(t,e)},t.prototype.now=function(){return performance.now()},t.prototype.encode=function(t,e){if("utf-8"!==e&&"utf8"!==e)throw new Error("Browser's encoder only supports utf-8, but got "+e);return this.textEncoder.encode(t)},t.prototype.decode=function(t,e){return new TextDecoder(e).decode(t)},t}();t.ENV.get("IS_BROWSER")&&t.ENV.setPlatform("browser",new dc);var mc,gc=function(){function e(){this.util=require("util"),this.textEncoder=new this.util.TextEncoder}return e.prototype.fetch=function(e,n){return null!=t.ENV.global.fetch?t.ENV.global.fetch(e,n):(null==mc&&(mc=require("node-fetch")),mc(e,n))},e.prototype.now=function(){var t=process.hrtime();return 1e3*t[0]+t[1]/1e6},e.prototype.encode=function(t,e){if("utf-8"!==e&&"utf8"!==e)throw new Error("Node built-in encoder only supports utf-8, but got "+e);return this.textEncoder.encode(t)},e.prototype.decode=function(t,e){return 0===t.length?"":new this.util.TextDecoder(e).decode(t)},e}();t.ENV.get("IS_NODE")&&t.ENV.setPlatform("node",new gc);var vc={float32:4,int32:4,uint16:2,uint8:1,bool:1},yc=4;function bc(t,e){for(var n={},r=0,i=function(e){var i=e.name,a=e.dtype,o=e.shape,s=v(o),u=void 0;if("quantization"in e){var l=e.quantization;if("uint8"!==l.dtype&&"uint16"!==l.dtype)throw new Error("Weight "+e.name+" has unknown quantization dtype "+l.dtype+". Supported quantization dtypes are: 'uint8' and 'uint16'.");var c=vc[l.dtype],p=t.slice(r,r+s*c),h="uint8"===l.dtype?new Uint8Array(p):new Uint16Array(p);if("float32"===a)u=Float32Array.from(h,function(t){return t*l.scale+l.min});else{if("int32"!==a)throw new Error("Unsupported dtype in weight '"+i+"': "+a);u=Int32Array.from(h,function(t){return Math.round(t*l.scale+l.min)})}r+=s*c}else if("string"===a){var f=v(e.shape);u=[];for(var d=0;d<f;d++){var m=new Uint32Array(t.slice(r,r+yc))[0];r+=yc;var g=new Uint8Array(t.slice(r,r+m));u.push(g),r+=m}}else{var y=vc[a];if(p=t.slice(r,r+s*y),"float32"===a)u=new Float32Array(p);else if("int32"===a)u=new Int32Array(p);else{if("bool"!==a)throw new Error("Unsupported dtype in weight '"+i+"': "+a);u=new Uint8Array(p)}r+=s*y}n[i]=rn(u,o,a)},a=0,o=e;a<o.length;a++)i(o[a]);return n}var xc="undefined"!=typeof Buffer&&("undefined"==typeof Blob||"undefined"==typeof atob||"undefined"==typeof btoa);function wc(t){return xc?Buffer.byteLength(t):new Blob([t]).size}function Nc(t){var e=0;t.forEach(function(t){e+=t.byteLength});var n=new Uint8Array(e),r=0;return t.forEach(function(t){n.set(new Uint8Array(t),r),r+=t.byteLength}),n.buffer}function Cc(t){for(t=t.trim();t.endsWith("/");)t=t.slice(0,t.length-1);var e=t.split("/");return e[e.length-1]}function Ec(t){if(t.modelTopology instanceof ArrayBuffer)throw new Error("Expected JSON model topology, received ArrayBuffer.");return{dateSaved:new Date,modelTopologyType:"JSON",modelTopologyBytes:null==t.modelTopology?0:wc(JSON.stringify(t.modelTopology)),weightSpecsBytes:null==t.weightSpecs?0:wc(JSON.stringify(t.weightSpecs)),weightDataBytes:null==t.weightData?0:t.weightData.byteLength}}var Sc=function(){function t(){this.saveRouters=[],this.loadRouters=[]}return t.getInstance=function(){return null==t.instance&&(t.instance=new t),t.instance},t.registerSaveRouter=function(e){t.getInstance().saveRouters.push(e)},t.registerLoadRouter=function(e){t.getInstance().loadRouters.push(e)},t.getSaveHandlers=function(e){return t.getHandlers(e,"save")},t.getLoadHandlers=function(e,n){return t.getHandlers(e,"load",n)},t.getHandlers=function(e,n,r){var i=[];return("load"===n?t.getInstance().loadRouters:t.getInstance().saveRouters).forEach(function(t){var n=t(e,r);null!==n&&i.push(n)}),i},t}(),kc="://",Ic=function(){function t(){this.managers={}}return t.getInstance=function(){return null==t.instance&&(t.instance=new t),t.instance},t.registerManager=function(e,n){f(null!=e,function(){return"scheme must not be undefined or null."}),e.endsWith(kc)&&(e=e.slice(0,e.indexOf(kc))),f(e.length>0,function(){return"scheme must not be an empty string."});var r=t.getInstance();f(null==r.managers[e],function(){return"A model store manager is already registered for scheme '"+e+"'."}),r.managers[e]=n},t.getManager=function(t){var e=this.getInstance().managers[t];if(null==e)throw new Error("Cannot find model manager for scheme '"+t+"'");return e},t.getSchemes=function(){return Object.keys(this.getInstance().managers)},t}();function Ac(t){if(-1===t.indexOf(kc))throw new Error("The url string provided does not contain a scheme. Supported schemes are: "+Ic.getSchemes().join(","));return{scheme:t.split(kc)[0],path:t.split(kc)[1]}}function Rc(t,e,n){return void 0===n&&(n=!1),r(this,void 0,void 0,function(){var r,a,o,s,u,l,c,p,h;return i(this,function(i){switch(i.label){case 0:return f(t!==e,function(){return"Old path and new path are the same: '"+t+"'"}),f((r=Sc.getLoadHandlers(t)).length>0,function(){return"Copying failed because no load handler is found for source URL "+t+"."}),f(r.length<2,function(){return"Copying failed because more than one ("+r.length+") load handlers for source URL "+t+"."}),a=r[0],f((o=Sc.getSaveHandlers(e)).length>0,function(){return"Copying failed because no save handler is found for destination URL "+e+"."}),f(o.length<2,function(){return"Copying failed because more than one ("+r.length+") save handlers for destination URL "+e+"."}),s=o[0],u=Ac(t).scheme,l=Ac(t).path,c=u===Ac(t).scheme,[4,a.load()];case 1:return p=i.sent(),n&&c?[4,Ic.getManager(u).removeModel(l)]:[3,3];case 2:i.sent(),i.label=3;case 3:return[4,s.save(p)];case 4:return h=i.sent(),!n||c?[3,6]:[4,Ic.getManager(u).removeModel(l)];case 5:i.sent(),i.label=6;case 6:return[2,h.modelArtifactsInfo]}})})}var Tc="models_store",Dc="model_info_store";function Oc(){if(!t.ENV.getBool("IS_BROWSER"))throw new Error("Failed to obtain IndexedDB factory because the current environmentis not a web browser.");var e=window,n=e.indexedDB||e.mozIndexedDB||e.webkitIndexedDB||e.msIndexedDB||e.shimIndexedDB;if(null==n)throw new Error("The current browser does not appear to support IndexedDB.");return n}function _c(t){var e=t.result;e.createObjectStore(Tc,{keyPath:"modelPath"}),e.createObjectStore(Dc,{keyPath:"modelPath"})}var Fc=function(){function t(t){if(this.indexedDB=Oc(),null==t||!t)throw new Error("For IndexedDB, modelPath must not be null, undefined or empty.");this.modelPath=t}return t.prototype.save=function(t){return r(this,void 0,void 0,function(){return i(this,function(e){if(t.modelTopology instanceof ArrayBuffer)throw new Error("BrowserLocalStorage.save() does not support saving model topology in binary formats yet.");return[2,this.databaseAction(this.modelPath,t)]})})},t.prototype.load=function(){return r(this,void 0,void 0,function(){return i(this,function(t){return[2,this.databaseAction(this.modelPath)]})})},t.prototype.databaseAction=function(t,e){var n=this;return new Promise(function(t,r){var i=n.indexedDB.open("tensorflowjs",1);i.onupgradeneeded=function(){return _c(i)},i.onsuccess=function(){var a=i.result;if(null==e){var o=a.transaction(Tc,"readonly"),s=o.objectStore(Tc).get(n.modelPath);s.onsuccess=function(){if(null==s.result)return a.close(),r(new Error("Cannot find model with path '"+n.modelPath+"' in IndexedDB."));t(s.result.modelArtifacts)},s.onerror=function(t){return a.close(),r(s.error)},o.oncomplete=function(){return a.close()}}else{var u,l=Ec(e),c=a.transaction(Dc,"readwrite"),p=c.objectStore(Dc),h=p.put({modelPath:n.modelPath,modelArtifactsInfo:l});h.onsuccess=function(){var i=(u=a.transaction(Tc,"readwrite")).objectStore(Tc).put({modelPath:n.modelPath,modelArtifacts:e,modelArtifactsInfo:l});i.onsuccess=function(){return t({modelArtifactsInfo:l})},i.onerror=function(t){var e=(p=c.objectStore(Dc)).delete(n.modelPath);e.onsuccess=function(){return a.close(),r(i.error)},e.onerror=function(t){return a.close(),r(i.error)}}},h.onerror=function(t){return a.close(),r(h.error)},c.oncomplete=function(){null==u?a.close():u.oncomplete=function(){return a.close()}}}},i.onerror=function(t){return r(i.error)}})},t.URL_SCHEME="indexeddb://",t}(),Mc=function(e){return t.ENV.getBool("IS_BROWSER")&&!Array.isArray(e)&&e.startsWith(Fc.URL_SCHEME)?(n=e.slice(Fc.URL_SCHEME.length),new Fc(n)):null;var n};Sc.registerSaveRouter(Mc),Sc.registerLoadRouter(Mc);var zc=function(){function t(){this.indexedDB=Oc()}return t.prototype.listModels=function(){return r(this,void 0,void 0,function(){var t=this;return i(this,function(e){return[2,new Promise(function(e,n){var r=t.indexedDB.open("tensorflowjs",1);r.onupgradeneeded=function(){return _c(r)},r.onsuccess=function(){var t=r.result,i=t.transaction(Dc,"readonly"),a=i.objectStore(Dc).getAll();a.onsuccess=function(){for(var t={},n=0,r=a.result;n<r.length;n++){var i=r[n];t[i.modelPath]=i.modelArtifactsInfo}e(t)},a.onerror=function(e){return t.close(),n(a.error)},i.oncomplete=function(){return t.close()}},r.onerror=function(t){return n(r.error)}})]})})},t.prototype.removeModel=function(t){return r(this,void 0,void 0,function(){var e=this;return i(this,function(n){var r;return t=(r=t).startsWith(Fc.URL_SCHEME)?r.slice(Fc.URL_SCHEME.length):r,[2,new Promise(function(n,r){var i=e.indexedDB.open("tensorflowjs",1);i.onupgradeneeded=function(){return _c(i)},i.onsuccess=function(){var e,a=i.result,o=a.transaction(Dc,"readwrite"),s=o.objectStore(Dc),u=s.get(t);u.onsuccess=function(){if(null==u.result)return a.close(),r(new Error("Cannot find model with path '"+t+"' in IndexedDB."));var i=s.delete(t),o=function(){var i=(e=a.transaction(Tc,"readwrite")).objectStore(Tc).delete(t);i.onsuccess=function(){return n(u.result.modelArtifactsInfo)},i.onerror=function(t){return r(u.error)}};i.onsuccess=o,i.onerror=function(t){return o(),a.close(),r(u.error)}},u.onerror=function(t){return a.close(),r(u.error)},o.oncomplete=function(){null==e?a.close():e.oncomplete=function(){return a.close()}}},i.onerror=function(t){return r(i.error)}})]})})},t}();if(t.ENV.getBool("IS_BROWSER"))try{Ic.registerManager(Fc.URL_SCHEME,new zc)}catch(e){}var Lc="/",Pc="tensorflowjs_models",Bc="info",Vc="model_topology",Wc="weight_specs",Uc="weight_data",jc="model_metadata";function qc(t){return{info:[Pc,t,Bc].join(Lc),topology:[Pc,t,Vc].join(Lc),weightSpecs:[Pc,t,Wc].join(Lc),weightData:[Pc,t,Uc].join(Lc),modelMetadata:[Pc,t,jc].join(Lc)}}function Hc(t){var e=t.split(Lc);if(e.length<3)throw new Error("Invalid key format: "+t);return e.slice(1,e.length-1).join(Lc)}var Gc=function(){function e(e){if(!t.ENV.getBool("IS_BROWSER")||void 0===window.localStorage)throw new Error("The current environment does not support local storage.");if(this.LS=window.localStorage,null==e||!e)throw new Error("For local storage, modelPath must not be null, undefined or empty.");this.modelPath=e,this.keys=qc(this.modelPath)}return e.prototype.save=function(t){return r(this,void 0,void 0,function(){var e,n,r;return i(this,function(i){if(t.modelTopology instanceof ArrayBuffer)throw new Error("BrowserLocalStorage.save() does not support saving model topology in binary formats yet.");e=JSON.stringify(t.modelTopology),n=JSON.stringify(t.weightSpecs),r=Ec(t);try{return this.LS.setItem(this.keys.info,JSON.stringify(r)),this.LS.setItem(this.keys.topology,e),this.LS.setItem(this.keys.weightSpecs,n),this.LS.setItem(this.keys.weightData,(a=t.weightData,xc?Buffer.from(a).toString("base64"):btoa(String.fromCharCode.apply(null,new Uint8Array(a))))),this.LS.setItem(this.keys.modelMetadata,JSON.stringify({format:t.format,generatedBy:t.generatedBy,convertedBy:t.convertedBy})),[2,{modelArtifactsInfo:r}]}catch(t){throw this.LS.removeItem(this.keys.info),this.LS.removeItem(this.keys.topology),this.LS.removeItem(this.keys.weightSpecs),this.LS.removeItem(this.keys.weightData),this.LS.removeItem(this.keys.modelMetadata),new Error("Failed to save model '"+this.modelPath+"' to local storage: size quota being exceeded is a possible cause of this failure: modelTopologyBytes="+r.modelTopologyBytes+", weightSpecsBytes="+r.weightSpecsBytes+", weightDataBytes="+r.weightDataBytes+".")}var a;return[2]})})},e.prototype.load=function(){return r(this,void 0,void 0,function(){var t,e,n,r,a,o,s;return i(this,function(i){if(null==(t=JSON.parse(this.LS.getItem(this.keys.info))))throw new Error("In local storage, there is no model with name '"+this.modelPath+"'");if("JSON"!==t.modelTopologyType)throw new Error("BrowserLocalStorage does not support loading non-JSON model topology yet.");if(e={},null==(n=JSON.parse(this.LS.getItem(this.keys.topology))))throw new Error("In local storage, the topology of model '"+this.modelPath+"' is missing.");if(e.modelTopology=n,null==(r=JSON.parse(this.LS.getItem(this.keys.weightSpecs))))throw new Error("In local storage, the weight specs of model '"+this.modelPath+"' are missing.");if(e.weightSpecs=r,null!=(a=this.LS.getItem(this.keys.modelMetadata))&&(o=JSON.parse(a),e.format=o.format,e.generatedBy=o.generatedBy,e.convertedBy=o.convertedBy),null==(s=this.LS.getItem(this.keys.weightData)))throw new Error("In local storage, the binary weight values of model '"+this.modelPath+"' are missing.");return e.weightData=function(t){if(xc){var e=Buffer.from(t,"base64");return e.buffer.slice(e.byteOffset,e.byteOffset+e.byteLength)}for(var n=atob(t),r=new Uint8Array(n.length),i=0;i<n.length;++i)r.set([n.charCodeAt(i)],i);return r.buffer}(s),[2,e]})})},e.URL_SCHEME="localstorage://",e}(),Kc=function(e){return t.ENV.getBool("IS_BROWSER")&&!Array.isArray(e)&&e.startsWith(Gc.URL_SCHEME)?(n=e.slice(Gc.URL_SCHEME.length),new Gc(n)):null;var n};Sc.registerSaveRouter(Kc),Sc.registerLoadRouter(Kc);var $c=function(){function e(){f(t.ENV.getBool("IS_BROWSER"),function(){return"Current environment is not a web browser"}),f(void 0!==window.localStorage,function(){return"Current browser does not appear to support localStorage"}),this.LS=window.localStorage}return e.prototype.listModels=function(){return r(this,void 0,void 0,function(){var t,e,n,r,a,o;return i(this,function(i){for(t={},e=Pc+Lc,n=Lc+Bc,r=0;r<this.LS.length;++r)(a=this.LS.key(r)).startsWith(e)&&a.endsWith(n)&&(o=Hc(a),t[o]=JSON.parse(this.LS.getItem(a)));return[2,t]})})},e.prototype.removeModel=function(t){return r(this,void 0,void 0,function(){var e,n;return i(this,function(r){var i;if(t=(i=t).startsWith(Gc.URL_SCHEME)?i.slice(Gc.URL_SCHEME.length):i,e=qc(t),null==this.LS.getItem(e.info))throw new Error("Cannot find model at path '"+t+"'");return n=JSON.parse(this.LS.getItem(e.info)),this.LS.removeItem(e.info),this.LS.removeItem(e.topology),this.LS.removeItem(e.weightSpecs),this.LS.removeItem(e.weightData),[2,n]})})},e}();if(t.ENV.getBool("IS_BROWSER"))try{Ic.registerManager(Gc.URL_SCHEME,new $c)}catch(e){}var Xc="model",Yc=".json",Jc=".weights.bin";function Zc(t){return new Promise(function(t){return setTimeout(t)}).then(t)}var Qc=function(){function e(n){if(!t.ENV.getBool("IS_BROWSER"))throw new Error("browserDownloads() cannot proceed because the current environment is not a browser.");n.startsWith(e.URL_SCHEME)&&(n=n.slice(e.URL_SCHEME.length)),null!=n&&0!==n.length||(n=Xc),this.modelTopologyFileName=n+Yc,this.weightDataFileName=n+Jc}return e.prototype.save=function(t){return r(this,void 0,void 0,function(){var e,n,r,a,o,s;return i(this,function(i){switch(i.label){case 0:if("undefined"==typeof document)throw new Error("Browser downloads are not supported in this environment since `document` is not present");if(e=window.URL.createObjectURL(new Blob([t.weightData],{type:"application/octet-stream"})),!(t.modelTopology instanceof ArrayBuffer))return[3,1];throw new Error("BrowserDownloads.save() does not support saving model topology in binary formats yet.");case 1:return n=[{paths:["./"+this.weightDataFileName],weights:t.weightSpecs}],r={modelTopology:t.modelTopology,format:t.format,generatedBy:t.generatedBy,convertedBy:t.convertedBy,weightsManifest:n},a=window.URL.createObjectURL(new Blob([JSON.stringify(r)],{type:"application/json"})),(o=null==this.jsonAnchor?document.createElement("a"):this.jsonAnchor).download=this.modelTopologyFileName,o.href=a,[4,Zc(function(){return o.dispatchEvent(new MouseEvent("click"))})];case 2:return i.sent(),null==t.weightData?[3,4]:((s=null==this.weightDataAnchor?document.createElement("a"):this.weightDataAnchor).download=this.weightDataFileName,s.href=e,[4,Zc(function(){return s.dispatchEvent(new MouseEvent("click"))})]);case 3:i.sent(),i.label=4;case 4:return[2,{modelArtifactsInfo:Ec(t)}]}})})},e.URL_SCHEME="downloads://",e}(),tp=function(){function t(t){if(null==t||t.length<1)throw new Error("When calling browserFiles, at least 1 file is required, but received "+t);this.files=t}return t.prototype.load=function(){return r(this,void 0,void 0,function(){var t,e,n=this;return i(this,function(r){return t=this.files[0],e=this.files.slice(1),[2,new Promise(function(r,i){var a=new FileReader;a.onload=function(a){var o=JSON.parse(a.target.result),s=o.modelTopology;if(null!=s){0===e.length&&r({modelTopology:s});var u=o.weightsManifest;if(null!=u){var l;try{l=n.checkManifestAndWeightFiles(u,e)}catch(t){return void i(t)}var c=[],p=[],h=[];u.forEach(function(t){t.paths.forEach(function(t){p.push(t),h.push(null)}),c.push.apply(c,t.weights)}),u.forEach(function(t){t.paths.forEach(function(t){var e=new FileReader;e.onload=function(e){var n=e.target.result,i=p.indexOf(t);h[i]=n,-1===h.indexOf(null)&&r({modelTopology:s,weightSpecs:c,weightData:Nc(h)})},e.onerror=function(e){return i("Failed to weights data from file of path '"+t+"'.")},e.readAsArrayBuffer(l[t])})})}else i(new Error("weightManifest field is missing from file "+t.name))}else i(new Error("modelTopology field is missing from file "+t.name))},a.onerror=function(e){return i("Failed to read model topology and weights manifest JSON from file '"+t.name+"'. BrowserFiles supports loading Keras-style tf.Model artifacts only.")},a.readAsText(t)})]})})},t.prototype.checkManifestAndWeightFiles=function(t,e){for(var n=[],r=e.map(function(t){return Cc(t.name)}),i={},a=0,o=t;a<o.length;a++)o[a].paths.forEach(function(t){var a=Cc(t);if(-1!==n.indexOf(a))throw new Error("Duplicate file basename found in weights manifest: '"+a+"'");if(n.push(a),-1===r.indexOf(a))throw new Error("Weight file with basename '"+a+"' is not provided.");i[t]=e[r.indexOf(a)]});if(n.length!==e.length)throw new Error("Mismatch in the number of files in weights manifest ("+n.length+") and the number of weight files provided ("+e.length+").");return i},t}();function ep(t,e,n,r){!function(t){f(null!=t&&Array.isArray(t)&&t.length>0,function(){return"promises must be a none empty array"})}(t),function(t,e){f(t>=0&&t<=1,function(){return"Progress fraction must be in range [0, 1], but got startFraction "+t}),f(e>=0&&e<=1,function(){return"Progress fraction must be in range [0, 1], but got endFraction "+e}),f(e>=t,function(){return"startFraction must be no more than endFraction, but got startFraction "+t+" and endFraction "+e})}(n=null==n?0:n,r=null==r?1:r);var i=0;return Promise.all(t.map(function(a){return a.then(function(a){var o=n+ ++i/t.length*(r-n);return e(o),a}),a}))}function np(e,n){return r(this,void 0,void 0,function(){var r,a,o,s,u,l,c,p,h;return i(this,function(i){switch(i.label){case 0:return null==n&&(n={}),r=null==n.fetchFunc?t.ENV.platform.fetch:n.fetchFunc,a=e.map(function(t){return r(t,n.requestInit,{isBinary:!0})}),o=0,s=.5,null!=n.onProgress?[3,2]:[4,Promise.all(a)];case 1:return u=i.sent(),[3,4];case 2:return[4,ep(a,n.onProgress,o,s)];case 3:u=i.sent(),i.label=4;case 4:return l=u.map(function(t){return t.arrayBuffer()}),c=.5,p=1,null!=n.onProgress?[3,6]:[4,Promise.all(l)];case 5:return h=i.sent(),[3,8];case 6:return[4,ep(l,n.onProgress,c,p)];case 7:h=i.sent(),i.label=8;case 8:return[2,h]}})})}function rp(t){var e=this;return function(n,a,o){return void 0===a&&(a=""),r(e,void 0,void 0,function(){var e,r,s,u,l,c,p,h,f,d;return i(this,function(i){switch(i.label){case 0:if(e=n.map(function(){return!1}),r={},s=null!=o?o.map(function(){return!1}):[],u=[],n.forEach(function(t,n){var i=0;t.weights.forEach(function(t){var a="quantization"in t?t.quantization.dtype:t.dtype,l=vc[a]*v(t.shape),c=function(){e[n]=!0,null==r[n]&&(r[n]=[]),r[n].push({manifestEntry:t,groupOffset:i,sizeBytes:l})};null!=o?o.forEach(function(e,n){e===t.name&&(c(),s[n]=!0)}):c(),u.push(t.name),i+=l})}),!s.every(function(t){return t}))throw l=o.filter(function(t,e){return!s[e]}),new Error("Could not find weights in manifest with names: "+l.join(", ")+". \nManifest JSON has weights with names: "+u.join(", ")+".");return c=e.reduce(function(t,e,n){return e&&t.push(n),t},[]),p=[],c.forEach(function(t){n[t].paths.forEach(function(t){var e=a+(a.endsWith("/")?"":"/")+t;p.push(e)})}),[4,t(p)];case 1:return h=i.sent(),f={},d=0,c.forEach(function(t){for(var e=n[t].paths.length,i=0,a=0;a<e;a++)i+=h[d+a].byteLength;for(var o=new ArrayBuffer(i),s=new Uint8Array(o),u=0,l=0;l<e;l++){var c=new Uint8Array(h[d+l]);s.set(c,u),u+=c.byteLength}r[t].forEach(function(t){var e=bc(o.slice(t.groupOffset,t.groupOffset+t.sizeBytes),[t.manifestEntry]);for(var n in e)f[n]=e[n]}),d+=e}),[2,f]}})})}}Sc.registerSaveRouter(function(e){return t.ENV.getBool("IS_BROWSER")&&!Array.isArray(e)&&e.startsWith(Qc.URL_SCHEME)?(void 0===(n=e.slice(Qc.URL_SCHEME.length))&&(n="model"),new Qc(n)):null;var n});var ip=function(){function e(e,n){if(this.DEFAULT_METHOD="POST",null==n&&(n={}),this.weightPathPrefix=n.weightPathPrefix,this.onProgress=n.onProgress,null!=n.fetchFunc?(f("function"==typeof n.fetchFunc,function(){return"Must pass a function that matches the signature of `fetch` (see https://developer.mozilla.org/en-US/docs/Web/API/Fetch_API)"}),this.fetch=n.fetchFunc):this.fetch=t.ENV.platform.fetch,f(null!=e&&e.length>0,function(){return"URL path for http must not be null, undefined or empty."}),Array.isArray(e)&&f(2===e.length,function(){return"URL paths for http must have a length of 2, (actual length is "+e.length+")."}),this.path=e,null!=n.requestInit&&null!=n.requestInit.body)throw new Error("requestInit is expected to have no pre-existing body, but has one.");this.requestInit=n.requestInit||{}}return e.prototype.save=function(t){return r(this,void 0,void 0,function(){var e,n,r,a;return i(this,function(i){switch(i.label){case 0:if(t.modelTopology instanceof ArrayBuffer)throw new Error("BrowserHTTPRequest.save() does not support saving model topology in binary formats yet.");return(e=Object.assign({method:this.DEFAULT_METHOD},this.requestInit)).body=new FormData,n=[{paths:["./model.weights.bin"],weights:t.weightSpecs}],r={modelTopology:t.modelTopology,format:t.format,generatedBy:t.generatedBy,convertedBy:t.convertedBy,weightsManifest:n},e.body.append("model.json",new Blob([JSON.stringify(r)],{type:"application/json"}),"model.json"),null!=t.weightData&&e.body.append("model.weights.bin",new Blob([t.weightData],{type:"application/octet-stream"}),"model.weights.bin"),[4,this.fetch(this.path,e)];case 1:if((a=i.sent()).ok)return[2,{modelArtifactsInfo:Ec(t),responses:[a]}];throw new Error("BrowserHTTPRequest.save() failed due to HTTP response status "+a.status+".")}})})},e.prototype.load=function(){return r(this,void 0,void 0,function(){var t,e,n,r,a,o,s,u;return i(this,function(i){switch(i.label){case 0:return[4,this.fetch(this.path,this.requestInit)];case 1:if(!(t=i.sent()).ok)throw new Error("Request to "+this.path+" failed with status code "+t.status+". Please verify this URL points to the model JSON of the model to load.");i.label=2;case 2:return i.trys.push([2,4,,5]),[4,t.json()];case 3:return e=i.sent(),[3,5];case 4:throw i.sent(),n="Failed to parse model JSON of response from "+this.path+".",this.path.endsWith(".pb")?n+=" Your path contains a .pb file extension. Support for .pb models have been removed in TensorFlow.js 1.0 in favor of .json models. You can re-convert your Python TensorFlow model using the TensorFlow.js 1.0 conversion scripts or you can convert your.pb models with the 'pb2json'NPM script in the tensorflow/tfjs-converter repository.":n+=" Please make sure the server is serving valid JSON for this request.",new Error(n);case 5:if(r=e.modelTopology,a=e.weightsManifest,null==r&&null==a)throw new Error("The JSON from HTTP path "+this.path+" contains neither model topology or manifest for weights.");return null==a?[3,7]:[4,this.loadWeights(a)];case 6:u=i.sent(),o=u[0],s=u[1],i.label=7;case 7:return[2,{modelTopology:r,weightSpecs:o,weightData:s}]}})})},e.prototype.loadWeights=function(t){return r(this,void 0,void 0,function(){var e,n,r,a,o,s,u,l,c,p,h;return i(this,function(i){switch(i.label){case 0:for(e=Array.isArray(this.path)?this.path[1]:this.path,n=function(t){var e=t.lastIndexOf("/"),n=t.lastIndexOf("?");return[t.substring(0,e)+"/",n>e?t.substring(n):""]}(e),r=n[0],a=n[1],o=this.weightPathPrefix||r,s=[],u=0,l=t;u<l.length;u++)c=l[u],s.push.apply(s,c.weights);return p=[],t.forEach(function(t){t.paths.forEach(function(t){p.push(o+t+a)})}),[4,np(p,{requestInit:this.requestInit,fetchFunc:this.fetch,onProgress:this.onProgress})];case 1:return h=i.sent(),[2,[s,Nc(h)]]}})})},e.URL_SCHEME_REGEX=/^https?:\/\//,e}();function ap(t){return null!=t.match(ip.URL_SCHEME_REGEX)}var op=function(t,e){return"undefined"==typeof fetch?null:(Array.isArray(t)?t.every(function(t){return ap(t)}):ap(t))?sp(t,{onProgress:e}):null};function sp(t,e){return new ip(t,e)}Sc.registerSaveRouter(op),Sc.registerLoadRouter(op);var up=function(){function t(t){this.modelArtifacts=t}return t.prototype.load=function(){return r(this,void 0,void 0,function(){return i(this,function(t){return[2,this.modelArtifacts]})})},t}(),lp=function(){function t(t){this.saveHandler=t}return t.prototype.save=function(t){return r(this,void 0,void 0,function(){return i(this,function(e){return[2,this.saveHandler(t)]})})},t}(),cp=Object.freeze({browserFiles:function(t){return new tp(t)},browserHTTPRequest:function(t,e){return sp(t,e)},concatenateArrayBuffers:Nc,decodeWeights:bc,encodeWeights:function(t,e){return r(this,void 0,void 0,function(){var n,a,o,s,u,l=this;return i(this,function(c){switch(c.label){case 0:for(n=[],a=[],o=Array.isArray(t)?t.map(function(t){return t.name}):Object.keys(t),s=function(s){var u=o[s],c=Array.isArray(t)?t[s].tensor:t[u];if("float32"!==c.dtype&&"int32"!==c.dtype&&"bool"!==c.dtype&&"string"!==c.dtype)throw new Error("Unsupported dtype in weight '"+u+"': "+c.dtype);var p={name:u,shape:c.shape,dtype:c.dtype};if("string"===c.dtype){var h=new Promise(function(t){return r(l,void 0,void 0,function(){var e,n,r,a,o,s,u;return i(this,function(i){switch(i.label){case 0:return[4,c.bytes()];case 1:for(e=i.sent(),n=e.reduce(function(t,e){return t+e.length},0)+yc*e.length,r=new Uint8Array(n),a=0,o=0;o<e.length;o++)s=e[o],u=new Uint8Array(new Uint32Array([s.length]).buffer),r.set(u,a),a+=yc,r.set(s,a),a+=s.length;return t(r),[2]}})})});a.push(h)}else a.push(c.data());null!=e&&(p.group=e),n.push(p)},u=0;u<o.length;++u)s(u);return[4,Promise.all(a)];case 1:return[2,{data:function(t){if(null===t)throw new Error("Invalid input value: "+JSON.stringify(t));var e=0,n=[];t.forEach(function(t){if(e+=t.byteLength,n.push(t.byteLength===t.buffer.byteLength?t:new t.constructor(t)),!(t instanceof Float32Array||t instanceof Int32Array||t instanceof Uint8Array))throw new Error("Unsupported TypedArray subtype: "+t.constructor.name)});var r=new Uint8Array(e),i=0;return n.forEach(function(t){r.set(new Uint8Array(t.buffer),i),i+=t.byteLength}),r.buffer}(c.sent()),specs:n}]}})})},fromMemory:function(t,e,n,r){return 1===arguments.length?null!=t.modelTopology||null!=t.weightSpecs?new up(t):(console.warn("Please call tf.io.fromMemory() with only one argument. The argument should be of type ModelArtifacts. The multi-argument signature of tf.io.fromMemory() has been deprecated and will be removed in a future release."),new up({modelTopology:t})):(console.warn("Please call tf.io.fromMemory() with only one argument. The argument should be of type ModelArtifacts. The multi-argument signature of tf.io.fromMemory() has been deprecated and will be removed in a future release."),new up({modelTopology:t,weightSpecs:e,weightData:n,trainingConfig:r}))},getLoadHandlers:function(t,e){return Sc.getLoadHandlers(t,e)},getModelArtifactsInfoForJSON:Ec,getSaveHandlers:function(t){return Sc.getSaveHandlers(t)},http:sp,isHTTPScheme:ap,loadWeights:function(t,e,n,a){return void 0===e&&(e=""),r(this,void 0,void 0,function(){return i(this,function(r){return[2,rp(function(t){return np(t,{requestInit:a})})(t,e,n)]})})},registerLoadRouter:function(t){return Sc.registerLoadRouter(t)},registerSaveRouter:function(t){return Sc.registerSaveRouter(t)},weightsLoaderFactory:rp,withSaveHandler:function(t){return new lp(t)},copyModel:function(t,e){return r(this,void 0,void 0,function(){return i(this,function(n){return[2,Rc(t,e,!1)]})})},listModels:function(){return r(this,void 0,void 0,function(){var t,e,n,r,a,o,s;return i(this,function(i){switch(i.label){case 0:t=Ic.getSchemes(),e={},n=0,r=t,i.label=1;case 1:return n<r.length?(a=r[n],[4,Ic.getManager(a).listModels()]):[3,4];case 2:for(s in o=i.sent())e[a+kc+s]=o[s];i.label=3;case 3:return n++,[3,1];case 4:return[2,e]}})})},moveModel:function(t,e){return r(this,void 0,void 0,function(){return i(this,function(n){return[2,Rc(t,e,!0)]})})},removeModel:function(t){return r(this,void 0,void 0,function(){var e;return i(this,function(n){return e=Ac(t),[2,Ic.getManager(e.scheme).removeModel(e.path)]})})}}),pp=Qe({confusionMatrix_:function(t,e,n){var r=We(t,"labels","confusionMatrix"),i=We(e,"predictions","confusionMatrix");f(null==n||n>0&&Number.isInteger(n),function(){return"If provided, numClasses must be a positive integer, but got "+n}),f(1===r.rank,function(){return"Expected the rank of labels to be 1, but got "+r.rank}),f(1===i.rank,function(){return"Expected the rank of predictions to be 1, but got "+i.rank}),f(r.shape[0]===i.shape[0],function(){return"Mismatch in the number of examples: "+r.shape[0]+" vs. "+i.shape[0]+". Labels and predictions should have the same number of elements."}),f(n>0&&Number.isInteger(n),function(){return"numClasses is required to be a positive integer, but got "+n});var a=$n(r.asType("int32"),n),o=$n(i.asType("int32"),n);return a.transpose().matMul(o).asType("int32")}}),hp=Object.freeze({confusionMatrix:pp}),fp=Qe({fromPixels_:function(t,e){if(void 0===e&&(e=3),e>4)throw new Error("Cannot construct Tensor with more than 4 channels from pixels.");return It.fromPixels(t,e)}}),dp=Object.freeze({toPixels:function(t,e){return r(this,void 0,void 0,function(){var n,r,a,o,s,u,l,c,p,h,f,d,m,g,v,y,b,x,w,N,C,E,S;return i(this,function(i){switch(i.label){case 0:if(n=We(t,"img","toPixels"),t instanceof ct||(n=n.toInt()),2!==n.rank&&3!==n.rank)throw new Error("toPixels only supports rank 2 or 3 tensors, got rank "+n.rank+".");if(r=n.shape.slice(0,2),a=r[0],o=r[1],(s=2===n.rank?1:n.shape[2])>4||2===s)throw new Error("toPixels only supports depth of size 1, 3 or 4 but got "+s);return[4,n.data()];case 1:return u=i.sent(),l=n.min(),c=n.max(),[4,Promise.all([l.data(),c.data()])];case 2:if(p=i.sent(),h=p[0],f=p[1],d=h[0],m=f[0],l.dispose(),c.dispose(),"float32"===n.dtype){if(d<0||m>1)throw new Error("Tensor values for a float32 Tensor must be in the range [0 - 1] but got range ["+d+" - "+m+"].")}else{if("int32"!==n.dtype)throw new Error("Unsupported type for toPixels: "+n.dtype+". Please use float32 or int32 tensors.");if(d<0||m>255)throw new Error("Tensor values for a int32 Tensor must be in the range [0 - 255] but got range ["+d+" - "+m+"].")}for(g="float32"===n.dtype?255:1,v=new Uint8ClampedArray(o*a*4),y=0;y<a*o;++y)b=void 0,x=void 0,w=void 0,N=void 0,1===s?(b=u[y]*g,x=u[y]*g,w=u[y]*g,N=255):3===s?(b=u[3*y]*g,x=u[3*y+1]*g,w=u[3*y+2]*g,N=255):4===s&&(b=u[4*y]*g,x=u[4*y+1]*g,w=u[4*y+2]*g,N=u[4*y+3]*g),v[0+(C=4*y)]=Math.round(b),v[C+1]=Math.round(x),v[C+2]=Math.round(w),v[C+3]=Math.round(N);return null!=e&&(e.width=o,e.height=a,E=e.getContext("2d"),S=new ImageData(v,o,a),E.putImageData(S,0,0)),n!==t&&n.dispose(),[2,v]}})})},fromPixels:fp}),mp=function(){function t(){}return t.prototype.getClassName=function(){return this.constructor.className},t.fromConfig=function(t,e){return new t(e)},t}(),gp=function(){function t(){this.classNameMap={}}return t.getMap=function(){return null==t.instance&&(t.instance=new t),t.instance},t.register=function(e){t.getMap().classNameMap[e.className]=[e,e.fromConfig]},t}();function vp(t){f(null!=t.className,function(){return"Class being registered does not have the static className property defined."}),f("string"==typeof t.className,function(){return"className is required to be a string, but got type "+typeof t.className}),f(t.className.length>0,function(){return"Class being registered has an empty-string as its className, which is disallowed."}),gp.register(t)}var yp=Object.freeze({Serializable:mp,SerializationMap:gp,registerClass:vp}),bp=.001,xp=.1;function wp(){return 32===It.backend.floatPrecision()?bp:xp}function Np(t,e,n){var r=!0;if((_(t)||_(e))&&(r=!1),_(t)&&_(e)&&(r=!0),r){var i=t.constructor.name,a=e.constructor.name;if(i!==a)throw new Error("Arrays are of different type. Actual: "+i+". Expected: "+a)}if(Array.isArray(t)&&Array.isArray(e)){var o=Be(t),s=Be(e);if(!y(o,s))throw new Error("Arrays have different shapes. Actual: ["+o+"]. Expected: ["+s+"]")}var u=_(t)?t:g(t),l=_(e)?e:g(e);if(u.length!==l.length)throw new Error("Arrays have different lengths actual: "+u.length+" vs expected: "+l.length+".\nActual:   "+u+".\nExpected: "+l+".");for(var c=0;c<l.length;++c){var p=u[c],h=l[c];if(!n(p,h))throw new Error("Arrays differ: actual["+c+"] = "+p+", expected["+c+"] = "+h+".\nActual:   "+u+".\nExpected: "+l+".")}}function Cp(t,e,n){return!isFinite(t)&&!isFinite(e)||!(isNaN(t)||isNaN(e)||Math.abs(t-e)>n)}var Ep=Object.freeze({TEST_EPSILON_FLOAT16:xp,expectArraysClose:function(t,e,n){return null==n&&(n=wp()),Np(t,e,function(t,e){return Cp(t,e,n)})},testEpsilon:wp,expectPromiseToFail:function(t,e){t().then(function(){return e.fail()},function(){return e()})},expectArraysEqual:function(t,e){var n="string"==typeof e||"number"==typeof e||"boolean"==typeof e?[e]:e;return z(t)||z(t[0])||z(e)||z(e[0])?Np(t,n,function(t,e){return t==e}):Np(t,e,function(t,e){return Cp(t,e,0)})},expectNumbersClose:function(t,e,n){if(null==n&&(n=wp()),!Cp(t,e,n))throw new Error("Numbers differ: actual === "+t+", expected === "+e)},expectValuesInRange:function(t,e,n){for(var r=0;r<t.length;r++)if(t[r]<e||t[r]>n)throw new Error("Value out of range:"+t[r]+" low: "+e+", high: "+n)},expectArrayBuffersEqual:function(t,e){expect(new Float32Array(t)).toEqual(new Float32Array(e))}}),Sp=Object.freeze({gpgpu_util:Ma,webgl_util:De,MathBackendWebGL:Mo,setWebGLContext:_t,GPGPUContext:za}),kp=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return n(e,t),e.prototype.minimize=function(t,e,n){void 0===e&&(e=!1);var r=this.computeGradients(t,n),i=r.value,a=r.grads;if(null!=n){var o=n.map(function(t){return{name:t.name,tensor:a[t.name]}});this.applyGradients(o)}else this.applyGradients(a);return Me(a),e?i:(i.dispose(),null)},Object.defineProperty(e.prototype,"iterations",{get:function(){return null==this.iterations_&&(this.iterations_=0),this.iterations_},enumerable:!0,configurable:!0}),e.prototype.incrementIterations=function(){this.iterations_=this.iterations+1},e.prototype.computeGradients=function(t,e){return kr(t,e)},e.prototype.dispose=function(){null!=this.iterations_&&Me(this.iterations_)},e.prototype.saveIterations=function(){return r(this,void 0,void 0,function(){return i(this,function(t){return null==this.iterations_&&(this.iterations_=0),[2,{name:"iter",tensor:on(this.iterations_,"int32")}]})})},e.prototype.getWeights=function(){return r(this,void 0,void 0,function(){return i(this,function(t){throw new Error("getWeights() is not implemented for this optimizer yet.")})})},e.prototype.setWeights=function(t){return r(this,void 0,void 0,function(){return i(this,function(t){throw new Error("setWeights() is not implemented for this optimizer class "+this.getClassName())})})},e.prototype.extractIterations=function(t){return r(this,void 0,void 0,function(){var e;return i(this,function(n){switch(n.label){case 0:return e=this,[4,t[0].tensor.data()];case 1:return e.iterations_=n.sent()[0],[2,t.slice(1)]}})})},e}(mp);Object.defineProperty(kp,Symbol.hasInstance,{value:function(t){return null!=t.minimize&&null!=t.computeGradients&&null!=t.applyGradients}});var Ip=function(t){function e(e,n,r){void 0===r&&(r=null);var i=t.call(this)||this;return i.learningRate=e,i.rho=n,i.epsilon=r,i.accumulatedGrads=[],i.accumulatedUpdates=[],null==r&&(i.epsilon=It.backend.epsilon()),i}return n(e,t),e.prototype.applyGradients=function(t){var e=this;(Array.isArray(t)?t.map(function(t){return t.name}):Object.keys(t)).forEach(function(n,r){var i=It.registeredVariables[n];null==e.accumulatedGrads[r]&&(e.accumulatedGrads[r]={originalName:n+"/accum_grad",variable:Fe(function(){return bn(i).variable(!1)})}),null==e.accumulatedUpdates[r]&&(e.accumulatedUpdates[r]={originalName:n+"/accum_var",variable:Fe(function(){return bn(i).variable(!1)})});var a=Array.isArray(t)?t[r].tensor:t[n];if(null!=a){var o=e.accumulatedGrads[r].variable,s=e.accumulatedUpdates[r].variable;Fe(function(){var t=o.mul(e.rho).add(a.square().mul(1-e.rho)),n=s.add(e.epsilon).sqrt().div(o.add(e.epsilon).sqrt()).mul(a),r=s.mul(e.rho).add(n.square().mul(1-e.rho));o.assign(t),s.assign(r);var u=n.mul(-e.learningRate).add(i);i.assign(u)})}}),this.incrementIterations()},e.prototype.dispose=function(){null!=this.accumulatedUpdates&&(Me(this.accumulatedGrads.map(function(t){return t.variable})),Me(this.accumulatedUpdates.map(function(t){return t.variable})))},e.prototype.getWeights=function(){return r(this,void 0,void 0,function(){var t;return i(this,function(e){switch(e.label){case 0:return t=this.accumulatedGrads.concat(this.accumulatedUpdates),[4,this.saveIterations()];case 1:return[2,[e.sent()].concat(t.map(function(t){return{name:t.originalName,tensor:t.variable}}))]}})})},e.prototype.setWeights=function(t){return r(this,void 0,void 0,function(){var e;return i(this,function(n){switch(n.label){case 0:return[4,this.extractIterations(t)];case 1:return t=n.sent(),e=t.length/2,this.accumulatedGrads=t.slice(0,e).map(function(t){return{originalName:t.name,variable:t.tensor.variable(!1)}}),this.accumulatedUpdates=t.slice(e,2*e).map(function(t){return{originalName:t.name,variable:t.tensor.variable(!1)}}),[2]}})})},e.prototype.getConfig=function(){return{learningRate:this.learningRate,rho:this.rho,epsilon:this.epsilon}},e.fromConfig=function(t,e){return new t(e.learningRate,e.rho,e.epsilon)},e.className="Adadelta",e}(kp);vp(Ip);var Ap=function(t){function e(e,n){void 0===n&&(n=.1);var r=t.call(this)||this;return r.learningRate=e,r.initialAccumulatorValue=n,r.accumulatedGrads=[],r}return n(e,t),e.prototype.applyGradients=function(t){var e=this;(Array.isArray(t)?t.map(function(t){return t.name}):Object.keys(t)).forEach(function(n,r){var i=It.registeredVariables[n];null==e.accumulatedGrads[r]&&(e.accumulatedGrads[r]={originalName:n+"/accumulator",variable:Fe(function(){return mn(i.shape,e.initialAccumulatorValue).variable(!1)})});var a=Array.isArray(t)?t[r].tensor:t[n];if(null!=a){var o=e.accumulatedGrads[r].variable;Fe(function(){var t=o.add(a.square());o.assign(t);var n=a.div(t.add(It.backend.epsilon()).sqrt()).mul(-e.learningRate).add(i);i.assign(n)})}}),this.incrementIterations()},e.prototype.dispose=function(){null!=this.accumulatedGrads&&Me(this.accumulatedGrads.map(function(t){return t.variable}))},e.prototype.getWeights=function(){return r(this,void 0,void 0,function(){return i(this,function(t){switch(t.label){case 0:return[4,this.saveIterations()];case 1:return[2,[t.sent()].concat(this.accumulatedGrads.map(function(t){return{name:t.originalName,tensor:t.variable}}))]}})})},e.prototype.setWeights=function(t){return r(this,void 0,void 0,function(){return i(this,function(e){switch(e.label){case 0:return[4,this.extractIterations(t)];case 1:return t=e.sent(),this.accumulatedGrads=t.map(function(t){return{originalName:t.name,variable:t.tensor.variable(!1)}}),[2]}})})},e.prototype.getConfig=function(){return{learningRate:this.learningRate,initialAccumulatorValue:this.initialAccumulatorValue}},e.fromConfig=function(t,e){return new t(e.learningRate,e.initialAccumulatorValue)},e.className="Adagrad",e}(kp);vp(Ap);var Rp=function(t){function e(e,n,r,i){void 0===i&&(i=null);var a=t.call(this)||this;return a.learningRate=e,a.beta1=n,a.beta2=r,a.epsilon=i,a.accumulatedFirstMoment=[],a.accumulatedSecondMoment=[],Fe(function(){a.accBeta1=on(n).variable(),a.accBeta2=on(r).variable()}),null==i&&(a.epsilon=It.backend.epsilon()),a}return n(e,t),e.prototype.applyGradients=function(t){var e=this,n=Array.isArray(t)?t.map(function(t){return t.name}):Object.keys(t);Fe(function(){var r=nu(1,e.accBeta1),i=nu(1,e.accBeta2);n.forEach(function(n,a){var o=It.registeredVariables[n];null==e.accumulatedFirstMoment[a]&&(e.accumulatedFirstMoment[a]={originalName:n+"/m",variable:Fe(function(){return bn(o).variable(!1)})}),null==e.accumulatedSecondMoment[a]&&(e.accumulatedSecondMoment[a]={originalName:n+"/v",variable:Fe(function(){return bn(o).variable(!1)})});var s=Array.isArray(t)?t[a].tensor:t[n];if(null!=s){var u=e.accumulatedFirstMoment[a].variable,l=e.accumulatedSecondMoment[a].variable,c=u.mul(e.beta1).add(s.mul(1-e.beta1)),p=l.mul(e.beta2).add(s.square().mul(1-e.beta2)),h=c.div(r),f=p.div(i);u.assign(c),l.assign(p);var d=h.div(f.sqrt().add(e.epsilon)).mul(-e.learningRate).add(o);o.assign(d)}}),e.accBeta1.assign(e.accBeta1.mul(e.beta1)),e.accBeta2.assign(e.accBeta2.mul(e.beta2))}),this.incrementIterations()},e.prototype.dispose=function(){this.accBeta1.dispose(),this.accBeta2.dispose(),null!=this.accumulatedFirstMoment&&Me(this.accumulatedFirstMoment.map(function(t){return t.variable})),null!=this.accumulatedSecondMoment&&Me(this.accumulatedSecondMoment.map(function(t){return t.variable}))},e.prototype.getWeights=function(){return r(this,void 0,void 0,function(){var t;return i(this,function(e){switch(e.label){case 0:return t=this.accumulatedFirstMoment.concat(this.accumulatedSecondMoment),[4,this.saveIterations()];case 1:return[2,[e.sent()].concat(t.map(function(t){return{name:t.originalName,tensor:t.variable}}))]}})})},e.prototype.setWeights=function(t){return r(this,void 0,void 0,function(){var e,n=this;return i(this,function(r){switch(r.label){case 0:return[4,this.extractIterations(t)];case 1:return t=r.sent(),Fe(function(){n.accBeta1.assign(Zs(n.beta1,n.iterations_+1)),n.accBeta2.assign(Zs(n.beta2,n.iterations_+1))}),e=t.length/2,this.accumulatedFirstMoment=t.slice(0,e).map(function(t){return{originalName:t.name,variable:t.tensor.variable(!1)}}),this.accumulatedSecondMoment=t.slice(e,2*e).map(function(t){return{originalName:t.name,variable:t.tensor.variable(!1)}}),[2]}})})},e.prototype.getConfig=function(){return{learningRate:this.learningRate,beta1:this.beta1,beta2:this.beta2,epsilon:this.epsilon}},e.fromConfig=function(t,e){return new t(e.learningRate,e.beta1,e.beta2,e.epsilon)},e.className="Adam",e}(kp);vp(Rp);var Tp=function(t){function e(e,n,r,i,a){void 0===i&&(i=null),void 0===a&&(a=0);var o=t.call(this)||this;return o.learningRate=e,o.beta1=n,o.beta2=r,o.epsilon=i,o.decay=a,o.accumulatedFirstMoment=[],o.accumulatedWeightedInfNorm=[],Fe(function(){o.iteration=on(0).variable(),o.accBeta1=on(n).variable()}),null==i&&(o.epsilon=It.backend.epsilon()),o}return n(e,t),e.prototype.applyGradients=function(t){var e=this,n=Array.isArray(t)?t.map(function(t){return t.name}):Object.keys(t);Fe(function(){var r=nu(1,e.accBeta1),i=Ws(-e.learningRate,e.iteration.mul(e.decay).add(1));n.forEach(function(n,a){var o=It.registeredVariables[n];null==e.accumulatedFirstMoment[a]&&(e.accumulatedFirstMoment[a]={originalName:n+"/m",variable:bn(o).variable(!1)}),null==e.accumulatedWeightedInfNorm[a]&&(e.accumulatedWeightedInfNorm[a]={originalName:n+"/v",variable:bn(o).variable(!1)});var s=Array.isArray(t)?t[a].tensor:t[n];if(null!=s){var u=e.accumulatedFirstMoment[a].variable,l=e.accumulatedWeightedInfNorm[a].variable,c=u.mul(e.beta1).add(s.mul(1-e.beta1)),p=l.mul(e.beta2),h=s.abs(),f=p.maximum(h);u.assign(c),l.assign(f);var d=i.div(r).mul(c.div(f.add(e.epsilon))).add(o);o.assign(d)}}),e.iteration.assign(e.iteration.add(1)),e.accBeta1.assign(e.accBeta1.mul(e.beta1))}),this.incrementIterations()},e.prototype.dispose=function(){this.accBeta1.dispose(),this.iteration.dispose(),null!=this.accumulatedFirstMoment&&Me(this.accumulatedFirstMoment.map(function(t){return t.variable})),null!=this.accumulatedWeightedInfNorm&&Me(this.accumulatedWeightedInfNorm.map(function(t){return t.variable}))},e.prototype.getWeights=function(){return r(this,void 0,void 0,function(){return i(this,function(t){throw new Error("getWeights() is not implemented for Adamax yet.")})})},e.prototype.setWeights=function(t){return r(this,void 0,void 0,function(){return i(this,function(t){throw new Error("setWeights() is not implemented for Adamax yet.")})})},e.prototype.getConfig=function(){return{learningRate:this.learningRate,beta1:this.beta1,beta2:this.beta2,epsilon:this.epsilon,decay:this.decay}},e.fromConfig=function(t,e){return new t(e.learningRate,e.beta1,e.beta2,e.epsilon,e.decay)},e.className="Adamax",e}(kp);vp(Tp);var Dp=function(t){function e(e){var n=t.call(this)||this;return n.learningRate=e,n.setLearningRate(e),n}return n(e,t),e.prototype.applyGradients=function(t){var e=this;(Array.isArray(t)?t.map(function(t){return t.name}):Object.keys(t)).forEach(function(n,r){var i=Array.isArray(t)?t[r].tensor:t[n];if(null!=i){var a=It.registeredVariables[n];Fe(function(){var t=e.c.mul(i).add(a);a.assign(t)})}}),this.incrementIterations()},e.prototype.setLearningRate=function(t){this.learningRate=t,null!=this.c&&this.c.dispose(),this.c=ze(on(-t))},e.prototype.dispose=function(){this.c.dispose()},e.prototype.getWeights=function(){return r(this,void 0,void 0,function(){return i(this,function(t){switch(t.label){case 0:return[4,this.saveIterations()];case 1:return[2,[t.sent()]]}})})},e.prototype.setWeights=function(t){return r(this,void 0,void 0,function(){return i(this,function(e){switch(e.label){case 0:return[4,this.extractIterations(t)];case 1:if(0!==(t=e.sent()).length)throw new Error("SGD optimizer does not have settable weights.");return[2]}})})},e.prototype.getConfig=function(){return{learningRate:this.learningRate}},e.fromConfig=function(t,e){return new t(e.learningRate)},e.className="SGD",e}(kp);vp(Dp);var Op=function(t){function e(e,n,r){void 0===r&&(r=!1);var i=t.call(this,e)||this;return i.learningRate=e,i.momentum=n,i.useNesterov=r,i.accumulations=[],i.m=on(i.momentum),i}return n(e,t),e.prototype.applyGradients=function(t){var e=this;(Array.isArray(t)?t.map(function(t){return t.name}):Object.keys(t)).forEach(function(n,r){var i=It.registeredVariables[n];null==e.accumulations[r]&&(e.accumulations[r]={originalName:n+"/momentum",variable:Fe(function(){return bn(i).variable(!1)})});var a=e.accumulations[r].variable,o=Array.isArray(t)?t[r].tensor:t[n];null!=o&&Fe(function(){var t,n=e.m.mul(a).add(o);t=e.useNesterov?e.c.mul(o.add(n.mul(e.m))).add(i):e.c.mul(n).add(i),a.assign(n),i.assign(t)})}),this.incrementIterations()},e.prototype.dispose=function(){this.m.dispose(),null!=this.accumulations&&Me(this.accumulations.map(function(t){return t.variable}))},e.prototype.setMomentum=function(t){this.momentum=t},e.prototype.getWeights=function(){return r(this,void 0,void 0,function(){return i(this,function(t){switch(t.label){case 0:return[4,this.saveIterations()];case 1:return[2,[t.sent()].concat(this.accumulations.map(function(t){return{name:t.originalName,tensor:t.variable}}))]}})})},e.prototype.setWeights=function(t){return r(this,void 0,void 0,function(){return i(this,function(e){switch(e.label){case 0:return[4,this.extractIterations(t)];case 1:return t=e.sent(),this.accumulations=t.map(function(t){return{originalName:t.name,variable:t.tensor.variable(!1)}}),[2]}})})},e.prototype.getConfig=function(){return{learningRate:this.learningRate,momentum:this.momentum,useNesterov:this.useNesterov}},e.fromConfig=function(t,e){return new t(e.learningRate,e.momentum,e.useNesterov)},e.className="Momentum",e}(Dp);vp(Op);var _p=function(t){function e(e,n,r,i,a){void 0===n&&(n=.9),void 0===r&&(r=0),void 0===i&&(i=null),void 0===a&&(a=!1);var o=t.call(this)||this;return o.learningRate=e,o.decay=n,o.momentum=r,o.epsilon=i,o.accumulatedMeanSquares=[],o.accumulatedMoments=[],o.accumulatedMeanGrads=[],o.centered=a,null==i&&(o.epsilon=It.backend.epsilon()),o}return n(e,t),e.prototype.applyGradients=function(t){var e=this;(Array.isArray(t)?t.map(function(t){return t.name}):Object.keys(t)).forEach(function(n,r){var i=It.registeredVariables[n];null==e.accumulatedMeanSquares[r]&&(e.accumulatedMeanSquares[r]={originalName:n+"/rms",variable:Fe(function(){return bn(i).variable(!1)})}),null==e.accumulatedMoments[r]&&(e.accumulatedMoments[r]={originalName:n+"/momentum",variable:Fe(function(){return bn(i).variable(!1)})}),null==e.accumulatedMeanGrads[r]&&e.centered&&(e.accumulatedMeanGrads[r]={originalName:n+"/mg",variable:Fe(function(){return bn(i).variable(!1)})});var a=Array.isArray(t)?t[r].tensor:t[n];if(null!=a){var o=e.accumulatedMeanSquares[r].variable,s=e.accumulatedMoments[r].variable;Fe(function(){var t=o.mul(e.decay).add(a.square().mul(1-e.decay));if(e.centered){var n=e.accumulatedMeanGrads[r].variable,u=n.mul(e.decay).add(a.mul(1-e.decay)),l=s.mul(e.momentum).add(a.mul(e.learningRate).div(t.sub(u.square().add(e.epsilon)).sqrt()));o.assign(t),n.assign(u),s.assign(l);var c=i.sub(l);i.assign(c)}else{var p=o.mul(e.decay).add(a.square().mul(1-e.decay));l=s.mul(e.momentum).add(a.mul(e.learningRate).div(p.add(e.epsilon).sqrt())),o.assign(p),s.assign(l),c=i.sub(l),i.assign(c)}})}}),this.incrementIterations()},e.prototype.dispose=function(){null!=this.accumulatedMeanSquares&&Me(this.accumulatedMeanSquares.map(function(t){return t.variable})),null!=this.accumulatedMeanGrads&&this.centered&&Me(this.accumulatedMeanGrads.map(function(t){return t.variable})),null!=this.accumulatedMoments&&Me(this.accumulatedMoments.map(function(t){return t.variable}))},e.prototype.getWeights=function(){return r(this,void 0,void 0,function(){var t;return i(this,function(e){switch(e.label){case 0:return t=this.accumulatedMeanSquares.concat(this.accumulatedMoments),this.centered&&t.push.apply(t,this.accumulatedMeanGrads),[4,this.saveIterations()];case 1:return[2,[e.sent()].concat(t.map(function(t){return{name:t.originalName,tensor:t.variable}}))]}})})},e.prototype.setWeights=function(t){return r(this,void 0,void 0,function(){var e;return i(this,function(n){switch(n.label){case 0:return[4,this.extractIterations(t)];case 1:return t=n.sent(),e=this.centered?t.length/3:t.length/2,this.accumulatedMeanSquares=t.slice(0,e).map(function(t){return{originalName:t.name,variable:t.tensor.variable(!1)}}),this.accumulatedMoments=t.slice(e,2*e).map(function(t){return{originalName:t.name,variable:t.tensor.variable(!1)}}),this.centered&&(this.accumulatedMeanGrads=t.slice(2*e,3*e).map(function(t){return{originalName:t.name,variable:t.tensor.variable(!1)}})),[2]}})})},e.prototype.getConfig=function(){return{learningRate:this.learningRate,decay:this.decay,momentum:this.momentum,epsilon:this.epsilon,centered:this.centered}},e.fromConfig=function(t,e){return new t(e.learningRate,e.decay,e.momentum,e.epsilon,e.centered)},e.className="RMSProp",e}(kp);vp(_p);var Fp=function(){function t(){}return t.sgd=function(t){return new Dp(t)},t.momentum=function(t,e,n){return void 0===n&&(n=!1),new Op(t,e,n)},t.rmsprop=function(t,e,n,r,i){return void 0===e&&(e=.9),void 0===n&&(n=0),void 0===r&&(r=null),void 0===i&&(i=!1),new _p(t,e,n,r,i)},t.adam=function(t,e,n,r){return void 0===t&&(t=.001),void 0===e&&(e=.9),void 0===n&&(n=.999),void 0===r&&(r=null),new Rp(t,e,n,r)},t.adadelta=function(t,e,n){return void 0===t&&(t=.001),void 0===e&&(e=.95),void 0===n&&(n=null),new Ip(t,e,n)},t.adamax=function(t,e,n,r,i){return void 0===t&&(t=.002),void 0===e&&(e=.9),void 0===n&&(n=.999),void 0===r&&(r=null),void 0===i&&(i=0),new Tp(t,e,n,r,i)},t.adagrad=function(t,e){return void 0===e&&(e=.1),new Ap(t,e)},t}(),Mp={sgd:Fp.sgd,momentum:Fp.momentum,adadelta:Fp.adadelta,adagrad:Fp.adagrad,rmsprop:Fp.rmsprop,adamax:Fp.adamax,adam:Fp.adam},zp="undefined"!=typeof requestAnimationFrame?requestAnimationFrame:"undefined"!=typeof setImmediate?setImmediate:function(t){return t()};function Lp(){return new Promise(function(t){return zp(function(){return t()})})}ut=pc;var Pp=function(t,e){return(Pp=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n])})(t,e)};function Bp(t,e){function n(){this.constructor=t}Pp(t,e),t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)}var Vp,Wp=function(){return(Wp=Object.assign||function(t){for(var e,n=1,r=arguments.length;n<r;n++)for(var i in e=arguments[n])Object.prototype.hasOwnProperty.call(e,i)&&(t[i]=e[i]);return t}).apply(this,arguments)};function Up(t,e,n,r){return new(n||(n=Promise))(function(i,a){function o(t){try{u(r.next(t))}catch(t){a(t)}}function s(t){try{u(r.throw(t))}catch(t){a(t)}}function u(t){t.done?i(t.value):new n(function(e){e(t.value)}).then(o,s)}u((r=r.apply(t,e||[])).next())})}function jp(t,e){var n,r,i,a,o={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return a={next:s(0),throw:s(1),return:s(2)},"function"==typeof Symbol&&(a[Symbol.iterator]=function(){return this}),a;function s(a){return function(s){return function(a){if(n)throw new TypeError("Generator is already executing.");for(;o;)try{if(n=1,r&&(i=2&a[0]?r.return:a[0]?r.throw||((i=r.return)&&i.call(r),0):r.next)&&!(i=i.call(r,a[1])).done)return i;switch(r=0,i&&(a=[2&a[0],i.value]),a[0]){case 0:case 1:i=a;break;case 4:return o.label++,{value:a[1],done:!1};case 5:o.label++,r=a[1],a=[0];continue;case 7:a=o.ops.pop(),o.trys.pop();continue;default:if(!(i=(i=o.trys).length>0&&i[i.length-1])&&(6===a[0]||2===a[0])){o=0;continue}if(3===a[0]&&(!i||a[1]>i[0]&&a[1]<i[3])){o.label=a[1];break}if(6===a[0]&&o.label<i[1]){o.label=i[1],i=a;break}if(i&&o.label<i[2]){o.label=i[2],o.ops.push(a);break}i[2]&&o.ops.pop(),o.trys.pop();continue}a=e.call(t,o)}catch(t){a=[6,t],r=0}finally{n=i=0}if(5&a[0])throw a[1];return{value:a[0]?a[1]:void 0,done:!0}}([a,s])}}}function qp(){return null==Vp&&(Vp=Le().epsilon()),Vp}var Hp=function(t){function e(n){var r=t.call(this,n)||this;return Object.setPrototypeOf(r,e.prototype),r}return Bp(e,t),e}(Error),Gp=function(t){function e(n){var r=t.call(this,n)||this;return Object.setPrototypeOf(r,e.prototype),r}return Bp(e,t),e}(Error),Kp=function(t){function e(n){var r=t.call(this,n)||this;return Object.setPrototypeOf(r,e.prototype),r}return Bp(e,t),e}(Error),$p=function(t){function e(n){var r=t.call(this,n)||this;return Object.setPrototypeOf(r,e.prototype),r}return Bp(e,t),e}(Error),Xp=function(t){function e(n){var r=t.call(this,n)||this;return Object.setPrototypeOf(r,e.prototype),r}return Bp(e,t),e}(Error);!function(t){function e(n){var r=t.call(this,n)||this;return Object.setPrototypeOf(r,e.prototype),r}Bp(e,t)}(Error);function Yp(t,e){if(Array.isArray(t)){for(var n=[],r=0;r<e;r++)n=n.concat(t);return n}return(n=new Array(e)).fill(t),n}function Jp(t,e){if(!t)throw new Xp(e)}function Zp(t,e){for(var n=0,r=0,i=t;r<i.length;r++)i[r]===e&&n++;return n}function Qp(t){return 1===t.length?t[0]:t}function th(t){return Array.isArray(t)?t:[t]}function eh(t){var e=t.replace(/(.)([A-Z][a-z0-9]+)/g,"$1_$2").replace(/([a-z])([A-Z])/g,"$1_$2").toLowerCase();return"_"!==e[0]?e:"private"+e}function nh(t){return t.length<=1?t:-1===t.indexOf("_")?t:t.replace(/[_]+(\w|$)/g,function(t,e){return e.toUpperCase()})}var rh={};function ih(t){if(null===t||void 0===t)return null;var e={};return e.className=t.getClassName(),e.config=t.getConfig(),e}function ah(t,e,n,r,i){var a,o,s;if(void 0===e&&(e={}),void 0===n&&(n={}),void 0===r&&(r="object"),void 0===i&&(i=!1),"string"==typeof t){var u=t,l=void 0;if(u in n)l=n[u];else if(u in rh)l=rh[u];else if(null==(l=e[u]))throw new Kp("Unknown "+r+": "+t+". This may be due to one of the following reasons:\n1. The "+r+" is defined in Python, in which case it needs to be ported to TensorFlow.js or your JavaScript code.\n2. The custom "+r+" is defined in JavaScript, but is not registered properly with tf.serialization.registerClass().");return l}var c=t;if(null==c.className||null==c.config)throw new Kp(r+": Improper config format: "+JSON.stringify(c)+".\n'className' and 'config' must set.");var p=c.className,h=void 0,f=void 0;if(p in n?(h=(a=n[p])[0],f=a[1]):p in rh?(h=(o=rh.className)[0],f=o[1]):p in e&&(h=(s=e[p])[0],f=s[1]),null==h)throw new Kp("Unknown "+r+": "+p+". This may be due to one of the following reasons:\n1. The "+r+" is defined in Python, in which case it needs to be ported to TensorFlow.js or your JavaScript code.\n2. The custom "+r+" is defined in JavaScript, but is not registered properly with tf.serialization.registerClass().");if(null!=f){for(var d={},m=0,g=Object.keys(rh);m<g.length;m++)d[N=g[m]]=rh[N];for(var v=0,y=Object.keys(n);v<y.length;v++)d[N=y[v]]=n[N];c.config.customObjects=d;for(var b=Wp({},rh),x=0,w=Object.keys(n);x<w.length;x++){var N=w[x];rh[N]=n[N]}!function t(e){if(null!=e&&"object"==typeof e)if(Array.isArray(e))e.forEach(function(e){return t(e)});else for(var n=0,r=Object.keys(e);n<r.length;n++){var i=r[n],a=e[i];null!=a&&"object"==typeof a&&(Array.isArray(a)||"ndarray"!==a.type||"number"!=typeof a.value?t(a):e[i]=a.value)}}(c.config);var C=f(h,c.config,n,i);return rh=Wp({},b),C}b=Wp({},rh);for(var E=0,S=Object.keys(n);E<S.length;E++)N=S[E],rh[N]=n[N];return C=new h(c.config),rh=Wp({},b),C}function oh(t,e){return-1*function(t,e){return t<e?-1:t>e?1:0}(t,e)}function sh(t){if(null==t)return t;for(var e=[],n=0,r=t;n<r.length;n++){var i=r[n];-1===e.indexOf(i)&&e.push(i)}return e}function uh(t){if(null==t)throw new Kp("Invalid value in obj: "+JSON.stringify(t));for(var e in t)if(t.hasOwnProperty(e))return!1;return!0}function lh(t,e,n){if(null!=n&&t.indexOf(n)<0)throw new Kp(n+" is not a valid "+e+".  Valid values are "+t+" or null/undefined.")}function ch(t,e,n,r){return void 0===n&&(n=0),void 0===r&&(r=1/0),Jp(n>=0),Jp(r>=n),Array.isArray(t)&&t.length>=n&&t.length<=r&&t.every(function(t){return typeof t===e})}function ph(t,e){Array.isArray(t)?(J.assert(t.length>0,function(){return e+" is unexpectedly an empty array."}),t.forEach(function(t,n){return ph(t,"element "+(n+1)+" of "+e)})):J.assert(Number.isInteger(t)&&t>0,function(){return"Expected "+e+" to be a positive integer, but got "+function t(e){return null===e?"null":Array.isArray(e)?"["+e.map(function(e){return t(e)}).join(",")+"]":"string"==typeof e?'"'+e+'"':""+e}(t)+"."})}function hh(t,e){return Fe(function(){return hs(cl(Js(t,t),e,!0))})}var fh=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return Bp(e,t),e.prototype.getConfig=function(){return{}},e}(yp.Serializable),dh=function(t){function e(e){var n=t.call(this)||this;return n.defaultMaxValue=2,n.defaultAxis=0,n.maxValue=null!=e.maxValue?e.maxValue:n.defaultMaxValue,n.axis=null!=e.axis?e.axis:n.defaultAxis,n}return Bp(e,t),e.prototype.apply=function(t){var e=this;return Fe(function(){var n=hh(t,e.axis),r=qo(n,0,e.maxValue);return Ys(t,Ws(r,Ls(qp(),n)))})},e.prototype.getConfig=function(){return{maxValue:this.maxValue,axis:this.axis}},e.className="MaxNorm",e}(fh);yp.registerClass(dh);var mh=function(t){function e(e){var n=t.call(this)||this;return n.defaultAxis=0,n.axis=null!=e.axis?e.axis:n.defaultAxis,n}return Bp(e,t),e.prototype.apply=function(t){var e=this;return Fe(function(){return Ws(t,Ls(qp(),hh(t,e.axis)))})},e.prototype.getConfig=function(){return{axis:this.axis}},e.className="UnitNorm",e}(fh);yp.registerClass(mh);var gh=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return Bp(e,t),e.prototype.apply=function(t){return ml(t)},e.className="NonNeg",e}(fh);yp.registerClass(gh);var vh=function(t){function e(e){var n=t.call(this)||this;return n.defaultMinValue=0,n.defaultMaxValue=1,n.defaultRate=1,n.defaultAxis=0,n.minValue=null!=e.minValue?e.minValue:n.defaultMinValue,n.maxValue=null!=e.maxValue?e.maxValue:n.defaultMaxValue,n.rate=null!=e.rate?e.rate:n.defaultRate,n.axis=null!=e.axis?e.axis:n.defaultAxis,n}return Bp(e,t),e.prototype.apply=function(t){var e=this;return Fe(function(){var n=hh(t,e.axis),r=Ls(Ys(e.rate,qo(n,e.minValue,e.maxValue)),Ys(1-e.rate,n));return Ys(t,Ws(r,Ls(qp(),n)))})},e.prototype.getConfig=function(){return{minValue:this.minValue,maxValue:this.maxValue,rate:this.rate,axis:this.axis}},e.className="MinMaxNorm",e}(fh);yp.registerClass(vh);var yh={maxNorm:"MaxNorm",minMaxNorm:"MinMaxNorm",nonNeg:"NonNeg",unitNorm:"UnitNorm"};function bh(t){return ih(t)}function xh(t,e){return void 0===e&&(e={}),ah(t,yp.SerializationMap.getMap().classNameMap,e,"constraint")}function wh(t){return null==t?null:"string"==typeof t?xh({className:t in yh?yh[t]:t,config:{}}):t instanceof fh?t:xh(t)}var Nh=Object.freeze({maxNorm:function(t){return new dh(t)},unitNorm:function(t){return new mh(t)},nonNeg:function(){return new gh},minMaxNorm:function(t){return new vh(t)}}),Ch=["channelsFirst","channelsLast"],Eh=["valid","same","causal"],Sh=["max","avg"],kh=["sum","mul","concat","ave"],Ih=new Map;function Ah(t){lh(Ch,"DataFormat",t)}function Rh(t){lh(Eh,"PaddingMode",t)}function Th(t){lh(Sh,"PoolMode",t)}var Dh=[],Oh="/";function _h(t,e){Dh.push(t);try{var n=e();return Dh.pop(),n}catch(t){throw Dh.pop(),t}}function Fh(t){if(!Lh(t))throw new Error("Not a valid tensor name: '"+t+"'");return(0===Dh.length?"":Dh.join(Oh)+Oh)+t}function Mh(t){if(!Lh(t))throw new Error("Not a valid tensor name: '"+t+"'");Ih.has(t)||Ih.set(t,0);var e=Ih.get(t);if(Ih.set(t,Ih.get(t)+1),e>0){var n=t+"_"+e;return Ih.set(n,1),n}return t}var zh=new RegExp(/^[A-Za-z0-9][-A-Za-z0-9\._\/]*$/);function Lh(t){return!!t.match(zh)}function Ph(t){return t===parseInt(t.toString(),10)}function Bh(t,e,n){null==e&&(e=0),null==n&&(n=t.length);for(var r=1,i=e;i<n;++i)r*=t[i];return r}function Vh(t){return sn(t=Array.isArray(t)?new Float32Array(t):t)}function Wh(t){return ul(Vh(t)).dataSync()[0]}function Uh(t){return ol(Vh(t)).dataSync()[0]}function jh(t,e){if(e<t)throw new Kp("end ("+e+") < begin ("+t+") is forbidden.");for(var n=[],r=t;r<e;++r)n.push(r);return n}function qh(t,e){return t.asType(e)}function Hh(t,e){void 0===e&&(e=-1);var n=t.shape.slice();return e<0&&(e=n.length+e+1),n.splice(e,0,1),t.reshape(n)}function Gh(t,e,n){return Fe(function(){switch(t.rank){case 1:return Yu(t,e,n);case 2:return Ju(t,[e,0],[n,t.shape[1]]);case 3:return Zu(t,[e,0,0],[n,t.shape[1],t.shape[2]]);case 4:return Qu(t,[e,0,0,0],[n,t.shape[1],t.shape[2],t.shape[3]]);default:throw new Kp("sliceAlongFirstAxis() received an unsupported tensor rank: "+t.rank)}})}function Kh(t,e,n){return Fe(function(){switch(t.rank){case 1:return Yu(t,e,n);case 2:return Ju(t,[0,e],[t.shape[0],n]);case 3:return Zu(t,[0,0,e],[t.shape[0],t.shape[1],n]);case 4:return Qu(t,[0,0,0,e],[t.shape[0],t.shape[1],t.shape[2],n]);default:throw new Kp("sliceAlongLastAxis() received an unsupported tensor rank: "+t.rank)}})}function $h(t,e,n,r){return Fe(function(){switch(t.rank){case 1:return Yu(t,e,n);case 2:switch(r){case 1:return Gh(t,e,n);case 2:return Kh(t,e,n);default:throw new Kp("The axis is not within the rank of the tensor "+r)}case 3:switch(r){case 1:return Gh(t,e,n);case 2:return Zu(t,[0,e,0],[t.shape[0],n,t.shape[2]]);case 3:return Kh(t,e,n);default:throw new Kp("The axis is not within the rank of the tensor "+r)}case 4:switch(r){case 1:return Gh(t,e,n);case 2:return Qu(t,[0,e,0,0],[t.shape[0],n,t.shape[2],t.shape[3]]);case 3:return Qu(t,[0,0,e,0],[t.shape[0],t.shape[1],n,t.shape[3]]);case 4:return Kh(t,e,n);default:throw new Kp("The axis is not within the rank of the tensor "+r)}default:throw new Kp("sliceAlongLastAxis() received an unsupported tensor rank: "+t.rank)}})}function Xh(t,e){var n;return void 0===e&&(e=-1),e<0&&(e=0!==(n=t[0].rank)?n:0),e===t[0].rank&&(e=-1),xn(t,e)}function Yh(t,e){switch(t.rank){case 1:return wn([t,e]);case 2:return Nn([t,e],0);case 3:return Cn([t,e],0);case 4:return En([t,e],0);default:throw new Kp("concatAlongFirstAxis() received an unsupported tensor rank: "+t.rank)}}function Jh(t,e){if(Array.isArray(e)||(e=[e]),t.rank!==e.length)throw new Kp("The length of input n ("+e.length+") does not match the number of dimensions in input x ("+t.rank+")");return ur(t,e)}function Zh(t,e,n,r,i){return void 0===e&&(e=0),void 0===n&&(n=1),er(t,e,n,r,i)}function Qh(t,e,n,r){if(t.rank<2||e.rank<2)throw new $p("dot requires both inputs to be rank >= 2 but got x shape = "+t.shape+" and y shape = "+e.shape);if(e.rank>=3&&t.shape.slice(-1)[0]!==(c=e.shape.slice(-2)[0]))throw new $p("If rank y >= 3, then the second last dim of y must equal the last dim of x but got x shape = "+t.shape+" and  y shape = "+e.shape);if(2===t.rank&&2===e.rank){var i=!1,a=!1;return cc.matMul({a:t,b:e,transposeA:i,transposeB:a,bias:r?nf(t.rank,r,"channelsLast"):null,activation:n})}var o=t.shape.slice(),s=o.pop();t=t.reshape([-1,s]);var u=e.shape.slice(),l=u.pop(),c=u.pop(),p=u.concat([l]),h=Array.from({length:e.rank},function(t,n){return 0===n?e.rank-2:n<=e.rank-2?n-1:n});e=e.transpose(h).reshape([c,-1]);var f=o.concat(p);return i=!1,a=!1,cc.matMul({a:t,b:e,transposeA:i,transposeB:a,bias:r?nf(t.rank,r,"channelsLast"):null,activation:n}).reshape(f)}function tf(t,e,n){return Fe(function(){return e=Array.isArray(e)?sn(e,"int32"):e.toInt(),yu(t,e,n)})}function ef(t){return Js(t,t)}function nf(t,e,n){var r=e.shape;if(1!==e.rank&&e.rank!==t)throw new Kp("Unexpected bias dimensions: "+e.rank+"; expected it to be 1 or "+t);if(5===t){if("channelsFirst"===n)return 1===r.length?e.reshape([1,r[0],1,1,1]):e.reshape([1,r[3],r[0],r[1],r[2]]);if("channelsLast"===n)return 1===r.length?e.reshape([1,1,1,1,r[0]]):e.reshape([1].concat(r))}else if(4===t){if("channelsFirst"===n)return 1===r.length?e.reshape([1,r[0],1,1]):e.reshape([1,r[2],r[0],r[1]]);if("channelsLast"===n)return 1===r.length?e.reshape([1,1,1,r[0]]):e.reshape([1].concat(r))}else if(3===t){if("channelsFirst"===n)return 1===r.length?e.reshape([1,r[0],1]):e.reshape([1,r[1],r[0]]);if("channelsLast"===n)return 1===r.length?e.reshape([1,1,r[0]]):e.reshape([1].concat(r))}else if(t<3)return e;throw new Kp("Unsupported input rank by biasAdd: "+e.rank)}function rf(t,e,n){return Fe(function(){return null==n&&(n="channelsLast"),Ah(n),t.add(nf(t.rank,e,n))})}function af(t,e,n,r){return Fe(function(){return Fl(t,e,n,r)})}function of(t,e,n){return void 0===n&&(n=!1),n?t():e()}var sf=["fanIn","fanOut","fanAvg"],uf=["normal","uniform","truncatedNormal"];var lf=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return Bp(e,t),e.prototype.fromConfigUsesCustomObjects=function(){return!1},e.prototype.getConfig=function(){return{}},e}(yp.Serializable),cf=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return Bp(e,t),e.prototype.apply=function(t,e){return dn(t,e)},e.className="Zeros",e}(lf);yp.registerClass(cf);var pf=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return Bp(e,t),e.prototype.apply=function(t,e){return fn(t,e)},e.className="Ones",e}(lf);yp.registerClass(pf);var hf=function(t){function e(e){var n=t.call(this)||this;if("object"!=typeof e)throw new Kp("Expected argument of type ConstantConfig but got "+e);if(void 0===e.value)throw new Kp("config must have value set but got "+e);return n.value=e.value,n}return Bp(e,t),e.prototype.apply=function(t,e){var n=this;return Fe(function(){return Ys(on(n.value),fn(t,e))})},e.prototype.getConfig=function(){return{value:this.value}},e.className="Constant",e}(lf);yp.registerClass(hf);var ff=function(t){function e(e){var n=t.call(this)||this;return n.DEFAULT_MINVAL=-.05,n.DEFAULT_MAXVAL=.05,n.minval=e.minval||n.DEFAULT_MINVAL,n.maxval=e.maxval||n.DEFAULT_MAXVAL,n.seed=e.seed,n}return Bp(e,t),e.prototype.apply=function(t,e){return rr(t,this.minval,this.maxval,e)},e.prototype.getConfig=function(){return{minval:this.minval,maxval:this.maxval,seed:this.seed}},e.className="RandomUniform",e}(lf);yp.registerClass(ff);var df=function(t){function e(e){var n=t.call(this)||this;return n.DEFAULT_MEAN=0,n.DEFAULT_STDDEV=.05,n.mean=e.mean||n.DEFAULT_MEAN,n.stddev=e.stddev||n.DEFAULT_STDDEV,n.seed=e.seed,n}return Bp(e,t),e.prototype.apply=function(t,e){if("float32"!==(e=e||"float32")&&"int32"!==e)throw new $p("randomNormal does not support dType "+e+".");return Zh(t,this.mean,this.stddev,e,this.seed)},e.prototype.getConfig=function(){return{mean:this.mean,stddev:this.stddev,seed:this.seed}},e.className="RandomNormal",e}(lf);yp.registerClass(df);var mf=function(t){function e(e){var n=t.call(this)||this;return n.DEFAULT_MEAN=0,n.DEFAULT_STDDEV=.05,n.mean=e.mean||n.DEFAULT_MEAN,n.stddev=e.stddev||n.DEFAULT_STDDEV,n.seed=e.seed,n}return Bp(e,t),e.prototype.apply=function(t,e){if("float32"!==(e=e||"float32")&&"int32"!==e)throw new $p("truncatedNormal does not support dType "+e+".");return lr(t,this.mean,this.stddev,e,this.seed)},e.prototype.getConfig=function(){return{mean:this.mean,stddev:this.stddev,seed:this.seed}},e.className="TruncatedNormal",e}(lf);yp.registerClass(mf);var gf=function(t){function e(e){var n=t.call(this)||this;return n.gain=null!=e.gain?e.gain:1,n}return Bp(e,t),e.prototype.apply=function(t,e){var n=this;return Fe(function(){if(2!==t.length||t[0]!==t[1])throw new Kp("Identity matrix initializer can only be used for 2D square matrices.");return Ys(n.gain,Gn(t[0]))})},e.prototype.getConfig=function(){return{gain:this.gain}},e.className="Identity",e}(lf);yp.registerClass(gf);var vf=function(t){function e(e){var n=t.call(this)||this;if(e.scale<0)throw new Kp("scale must be a positive float. Got: "+e.scale);return n.scale=null==e.scale?1:e.scale,n.mode=null==e.mode?"fanIn":e.mode,function(t){lh(sf,"FanMode",t)}(n.mode),n.distribution=null==e.distribution?"normal":e.distribution,function(t){lh(uf,"Distribution",t)}(n.distribution),n.seed=e.seed,n}return Bp(e,t),e.prototype.apply=function(t,e){var n=function(t,e){var n,r;if(void 0===e&&(e="channelsLast"),Ah(e),2===t.length)n=t[0],r=t[1];else if(-1!==[3,4,5].indexOf(t.length))if("channelsFirst"===e){var i=Bh(t,2);n=t[1]*i,r=t[0]*i}else"channelsLast"===e&&(i=Bh(t,0,t.length-2),n=t[t.length-2]*i,r=t[t.length-1]*i);else{var a=Bh(t);n=Math.sqrt(a),r=Math.sqrt(a)}return[n,r]}(t),r=n[0],i=n[1],a=this.scale;if("fanIn"===this.mode?a/=Math.max(1,r):"fanOut"===this.mode?a/=Math.max(1,i):a/=Math.max(1,(r+i)/2),"normal"===this.distribution){var o=Math.sqrt(a);if("float32"!==(e=e||"float32")&&"int32"!==e)throw new $p(this.getClassName()+" does not support dType "+e+".");return lr(t,0,o,e,this.seed)}var s=Math.sqrt(3*a);return rr(t,-s,s,e)},e.prototype.getConfig=function(){return{scale:this.scale,mode:this.mode,distribution:this.distribution,seed:this.seed}},e.className="VarianceScaling",e}(lf);yp.registerClass(vf);var yf=function(t){function e(e){return t.call(this,{scale:1,mode:"fanAvg",distribution:"uniform",seed:null==e?null:e.seed})||this}return Bp(e,t),e.prototype.getClassName=function(){return vf.className},e.className="GlorotUniform",e}(vf);yp.registerClass(yf);var bf=function(t){function e(e){return t.call(this,{scale:1,mode:"fanAvg",distribution:"normal",seed:null==e?null:e.seed})||this}return Bp(e,t),e.prototype.getClassName=function(){return vf.className},e.className="GlorotNormal",e}(vf);yp.registerClass(bf);var xf=function(t){function e(e){return t.call(this,{scale:2,mode:"fanIn",distribution:"normal",seed:null==e?null:e.seed})||this}return Bp(e,t),e.prototype.getClassName=function(){return vf.className},e.className="HeNormal",e}(vf);yp.registerClass(xf);var wf=function(t){function e(e){return t.call(this,{scale:2,mode:"fanIn",distribution:"uniform",seed:null==e?null:e.seed})||this}return Bp(e,t),e.prototype.getClassName=function(){return vf.className},e.className="HeUniform",e}(vf);yp.registerClass(wf);var Nf=function(t){function e(e){return t.call(this,{scale:1,mode:"fanIn",distribution:"normal",seed:null==e?null:e.seed})||this}return Bp(e,t),e.prototype.getClassName=function(){return vf.className},e.className="LeCunNormal",e}(vf);yp.registerClass(Nf);var Cf=function(t){function e(e){return t.call(this,{scale:1,mode:"fanIn",distribution:"uniform",seed:null==e?null:e.seed})||this}return Bp(e,t),e.prototype.getClassName=function(){return vf.className},e.className="LeCunNormal",e}(vf);yp.registerClass(Cf);var Ef=function(t){function e(e){var n=t.call(this)||this;if(n.DEFAULT_GAIN=1,n.gain=null==e.gain?n.DEFAULT_GAIN:e.gain,n.seed=e.seed,null!=n.seed)throw new $p("Random seed is not implemented for Orthogonal Initializer yet.");return n}return Bp(e,t),e.prototype.apply=function(t,e){var n=this;return Fe(function(){if(2!==t.length)throw new $p("The Orthogonal Initializer does not support non-2D shapes yet.");t[0]*t[1]>2e3&&console.warn("Orthogonal initializer is being called on a matrix with more than 2000 ("+t[0]*t[1]+") elements: Slowness may result.");var e=Zh(t[0]>t[1]?[t[1],t[0]]:t,0,1,"float32"),r=ec.gramSchmidt(e);return t[0]>t[1]&&(r=r.transpose()),Ys(n.gain,r)})},e.prototype.getConfig=function(){return{gain:this.gain,seed:this.seed}},e.className="Orthogonal",e}(lf);yp.registerClass(Ef);var Sf={constant:"Constant",glorotNormal:"GlorotNormal",glorotUniform:"GlorotUniform",heNormal:"HeNormal",heUniform:"HeUniform",identity:"Identity",leCunNormal:"LeCunNormal",leCunUniform:"LeCunUniform",ones:"Ones",orthogonal:"Orthogonal",randomNormal:"RandomNormal",randomUniform:"RandomUniform",truncatedNormal:"TruncatedNormal",varianceScaling:"VarianceScaling",zeros:"Zeros"};function kf(t,e){return void 0===e&&(e={}),ah(t,yp.SerializationMap.getMap().classNameMap,e,"initializer")}function If(t){return ih(t)}function Af(t){if("string"==typeof t){var e=t in Sf?Sf[t]:t;if("GlorotNormal"===e)return new bf;if("GlorotUniform"===e)return new yf;if("HeNormal"===e)return new xf;if("HeUniform"===e)return new wf;if("LeCunNormal"===e)return new Nf;if("LeCunUniform"===e)return new Cf;var n={};return n.className=e,n.config={},kf(n)}return t instanceof lf?t:kf(t)}var Rf=Object.freeze({zeros:function(){return new cf},ones:function(){return new pf},constant:function(t){return new hf(t)},randomUniform:function(t){return new ff(t)},randomNormal:function(t){return new df(t)},truncatedNormal:function(t){return new mf(t)},identity:function(t){return new gf(t)},varianceScaling:function(t){return new vf(t)},glorotUniform:function(t){return new yf(t)},glorotNormal:function(t){return new bf(t)},heNormal:function(t){return new xf(t)},heUniform:function(t){return new wf(t)},leCunNormal:function(t){return new Nf(t)},leCunUniform:function(t){return new Cf(t)},orthogonal:function(t){return new Ef(t)}}),Tf=0;function Df(){return Tf++}var Of={};function _f(t){return void 0===t&&(t=""),t in Of||(Of[t]=0),Of[t]+=1,t+Of[t].toString()}function Ff(t){return Array.isArray(t)&&Array.isArray(t[0])}function Mf(t){return 0===t.length?[]:Array.isArray(t[0])?t:[t]}function zf(t){var e;if(Array.isArray(t)){if(1!==t.length)throw new Kp("Expected Tensor length to be 1; got "+t.length);e=t[0]}else e=t;return e}function Lf(t){if(Array.isArray(t)&&Array.isArray(t[0])){if(1===t.length)return(t=t)[0];throw new Kp("Expected exactly 1 Shape; got "+t.length)}return t}function Pf(t){for(var e=0,n=0,r=t;n<r.length;n++){var i=r[n];0===i.shape.length?e+=1:e+=i.shape.reduce(function(t,e){return t*e})}return e}var Bf="Variable",Vf=function(){function t(t,e,n,r,i){void 0===e&&(e="float32"),void 0===n&&(n=Bf),void 0===r&&(r=!0),void 0===i&&(i=null),this.dtype=null==e?"float32":e,this.shape=t.shape,this.id=Df(),n=null==n?Bf:n,this.originalName=Fh(n),this.name=Mh(this.originalName),this.trainable_=r,this.constraint=i,this.val=gt(t,this.trainable_,this.name,this.dtype)}return t.prototype.read=function(){return this.assertNotDisposed(),this.val},t.prototype.write=function(t){return this.assertNotDisposed(),function(t,e){if(t.shape.toString()!==e.shape.toString())throw new Error("Shape mismatch: "+JSON.stringify(t.shape)+" vs. "+JSON.stringify(e.shape))}(this.val,t),this.val.id!==t.id&&(this.val.assign(t),null!=this.constraint&&this.val.assign(this.constraint.apply(this.val))),this},t.prototype.dispose=function(){this.assertNotDisposed(),this.val.dispose()},t.prototype.assertNotDisposed=function(){if(this.val.isDisposed)throw new Error("LayersVariable "+this.name+" is already disposed.")},Object.defineProperty(t.prototype,"trainable",{get:function(){return this.trainable_},set:function(t){this.trainable_=t,this.val.trainable=t},enumerable:!0,configurable:!0}),t}();function Wf(t){return t.map(function(t){return t.read()})}function Uf(t){t.forEach(function(t){t[0].write(t[1])})}var jf=function(t){this.dtype=t.dtype,this.shape=t.shape,null!=t.shape?this.ndim=t.shape.length:this.ndim=t.ndim,this.maxNDim=t.maxNDim,this.minNDim=t.minNDim,this.axes=t.axes||{}},qf=function(t,e,n,r,i,a,o){this.dtype=t,this.shape=e,this.sourceLayer=n,this.inputs=r,this.callArgs=i,this.outputTensorIndex=o,this.id=Df(),null!=a&&(this.originalName=Fh(a),this.name=Mh(this.originalName)),this.rank=e.length},Hf=0,Gf=function(){function t(t,e){this.callArgs=e,this.id=Hf++,this.outboundLayer=t.outboundLayer,this.inboundLayers=t.inboundLayers,this.nodeIndices=t.nodeIndices,this.tensorIndices=t.tensorIndices,this.inputTensors=t.inputTensors,this.outputTensors=t.outputTensors,this.inputMasks=t.inputMasks,this.outputMasks=t.outputMasks,this.inputShapes=t.inputShapes,this.outputShapes=t.outputShapes;for(var n=0,r=t.inboundLayers;n<r.length;n++){var i=r[n];null!=i&&i.outboundNodes.push(this)}t.outboundLayer.inboundNodes.push(this)}return t.prototype.getConfig=function(){for(var t=[],e=0,n=this.inboundLayers;e<n.length;e++){var r=n[e];null!=r?t.push(r.name):t.push(null)}return{outboundLayer:this.outboundLayer?this.outboundLayer.name:null,inboundLayers:t,nodeIndices:this.nodeIndices,tensorIndices:this.tensorIndices}},t}(),Kf=0,$f=function(t){function e(e){var n=t.call(this)||this;n._callHook=null,n._addedWeightNames=[],n._stateful=!1,n.id=Kf++,n.activityRegularizer=null,n.inputSpec=null,n.supportsMasking=!1,n._trainableWeights=[],n._nonTrainableWeights=[],n._losses=[],n._updates=[],n._built=!1,n.inboundNodes=[],n.outboundNodes=[];var r=e.name;if(!r){var i=n.getClassName();r=eh(i)+"_"+_f(i)}if(n.name=r,n.trainable_=null==e.trainable||e.trainable,null!=e.inputShape||null!=e.batchInputShape){var a=void 0;if(null!=e.batchInputShape)a=e.batchInputShape;else if(null!=e.inputShape){var o=null;null!=e.batchSize&&(o=e.batchSize),a=[o].concat(e.inputShape)}n.batchInputShape=a;var s=e.dtype;null==s&&(s=e.inputDType),null==s&&(s="float32"),n.dtype=s}return null!=e.weights?n.initialWeights=e.weights:n.initialWeights=null,n._refCount=null,n.fastWeightInitDuringBuild=!1,n}return Bp(e,t),e.nodeKey=function(t,e){return t.name+"_ib-"+e.toString()},e.prototype.getNodeAtIndex=function(t,e){if(0===this.inboundNodes.length)throw new Gp("The layer has never been called and thus has no defined "+e+".");if(this.inboundNodes.length<=t)throw new Kp("Asked to get "+e+" at node "+t+", but the layer has only "+this.inboundNodes.length+" inbound nodes.");return this.inboundNodes[t]},e.prototype.getInputAt=function(t){return Qp(this.getNodeAtIndex(t,"input").inputTensors)},e.prototype.getOutputAt=function(t){return Qp(this.getNodeAtIndex(t,"output").outputTensors)},Object.defineProperty(e.prototype,"input",{get:function(){if(this.inboundNodes.length>1)throw new Hp("Layer "+this.name+' has multiple inbound nodes, hence the notion of "layer input" is ill-defined. Use `getInputAt(nodeIndex)` instead.');if(0===this.inboundNodes.length)throw new Hp("Layer "+this.name+" is not connected, no input to return.");return Qp(this.getNodeAtIndex(0,"input").inputTensors)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"output",{get:function(){if(0===this.inboundNodes.length)throw new Hp("Layer "+this.name+" has no inbound nodes.");if(this.inboundNodes.length>1)throw new Hp("Layer "+this.name+' has multiple inbound nodes, hence the notion of "layer output" is ill-defined. Use `getOutputAt(nodeIndex)` instead.');return Qp(this.getNodeAtIndex(0,"output").outputTensors)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"losses",{get:function(){return this._losses},enumerable:!0,configurable:!0}),e.prototype.calculateLosses=function(){return this.losses.map(function(t){return t()})},Object.defineProperty(e.prototype,"updates",{get:function(){return this._updates},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"built",{get:function(){return this._built},set:function(t){this._built=t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"trainable",{get:function(){return this.trainable_},set:function(t){this._trainableWeights.forEach(function(e){return e.trainable=t}),this.trainable_=t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"trainableWeights",{get:function(){return this.trainable_?this._trainableWeights.filter(function(t){return t.trainable}):[]},set:function(t){this._trainableWeights=t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"nonTrainableWeights",{get:function(){return this.trainable?this._trainableWeights.filter(function(t){return!t.trainable}).concat(this._nonTrainableWeights):this._trainableWeights.concat(this._nonTrainableWeights)},set:function(t){this._nonTrainableWeights=t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"weights",{get:function(){return this.trainableWeights.concat(this.nonTrainableWeights)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"stateful",{get:function(){return this._stateful},enumerable:!0,configurable:!0}),e.prototype.resetStates=function(){if(!this.stateful)throw new Error("Cannot call the resetStates() method of a non-stateful Layer object.")},e.prototype.assertInputCompatibility=function(t){if(t=th(t),null!=this.inputSpec&&0!==this.inputSpec.length){var e=th(this.inputSpec);if(t.length!==e.length)throw new Kp("Layer "+this.name+" expects "+e.length+" inputs, but it received "+t.length+" input tensors. Input received: "+t);for(var n=0;n<t.length;n++){var r=t[n],i=e[n];if(null!=i){var a=r.rank;if(null!=i.ndim&&a!==i.ndim)throw new Kp("Input "+n+" is incompatible with layer "+this.name+": expected ndim="+i.ndim+", found ndim="+a);if(null!=i.maxNDim&&a>i.maxNDim)throw new Kp("Input "+n+" is incompatible with layer "+this.name+": expected max_ndim="+i.maxNDim+", found ndim="+a);if(null!=i.minNDim&&a<i.minNDim)throw new Kp("Input "+n+" is incompatible with layer "+this.name+": expected min_ndim="+i.minNDim+", found ndim="+a+".");if(null!=i.dtype&&r.dtype!==i.dtype)throw new Kp("Input "+n+" is incompatible with layer "+this.name+" : expected dtype="+i.dtype+", found dtype="+r.dtype+".");if(i.axes){var o=r.shape;for(var s in i.axes){var u=Number(s),l=i.axes[s],c=u>=0?o[u]:o[o.length+u];if(null!=l&&-1===[l,null].indexOf(c))throw new Kp("Input "+n+" is incompatible with layer "+this.name+": expected axis "+u+" of input shape to have value "+l+" but got shape "+o+".")}}if(null!=i.shape)for(var p=0;p<i.shape.length;++p){var h=i.shape[p],f=r.shape[p];if(null!=h&&null!=f&&h!==f)throw new Kp("Input "+n+" is incompatible with layer "+this.name+": expected shape="+i.shape+", found shape="+r.shape+".")}}}}},e.prototype.call=function(t,e){return t},e.prototype.invokeCallHook=function(t,e){null!=this._callHook&&this._callHook(t,e)},e.prototype.setCallHook=function(t){this._callHook=t},e.prototype.clearCallHook=function(){this._callHook=null},e.prototype.apply=function(t,e){var n=this;e=e||{},this.assertNotDisposed();for(var r=th(t),i=!0,a=0,o=r;a<o.length;a++)if(!(o[a]instanceof qf)){i=!1;break}for(var s=!0,u=0,l=r;u<l.length;u++)if(l[u]instanceof qf){s=!1;break}if(i===s)throw new Kp("Arguments to apply() must be all SymbolicTensors or all Tensors");return _h(this.name,function(){if(!n.built){n.assertInputCompatibility(t);for(var i=[],a=0,o=th(t);a<o.length;a++){var u=o[a];i.push(u.shape)}n.build(Qp(i)),n.built=!0,n.initialWeights&&n.setWeights(n.initialWeights),null===n._refCount&&s&&(n._refCount=1)}if(n.assertInputCompatibility(t),s){for(var l=[],c=0,p=th(m=n.call(t,e));c<p.length;c++){var h=p[c];-1!==r.indexOf(h)&&(h=h.clone()),l.push(h)}if(m=Qp(l),null!=n.activityRegularizer)throw new $p("Layer invocation in the presence of activity regularizer(s) is not supported yet.");return m}var f=function(t){for(var e=[],n=0,r=t=th(t);n<r.length;n++){var i=r[n];e.push(i.shape)}return Qp(e)}(t),d=n.computeOutputShape(f),m=void 0,g="float32";if(n.warnOnIncompatibleInputShape(Array.isArray(t)?f[0]:f),m=null!=d&&d.length>0&&Array.isArray(d[0])?d.map(function(r,i){return new qf(g,r,n,th(t),e,n.name,i)}):new qf(g,d,n,th(t),e,n.name),n.addInboundNode(t,m,null,null,f,d,e),n._refCount++,null!=n.activityRegularizer)throw new $p("Layer invocation in the presence of activity regularizer(s) is not supported yet.");return m})},e.prototype.warnOnIncompatibleInputShape=function(t){if(null!=this.batchInputShape)if(t.length!==this.batchInputShape.length)console.warn("The rank of the input tensor provided (shape: "+JSON.stringify(t)+") does not match that of the batchInputShape ("+JSON.stringify(this.batchInputShape)+") of the layer "+this.name);else{var e=!1;this.batchInputShape.forEach(function(n,r){null!=n&&null!=t[r]&&t[r]!==n&&(e=!0)}),e&&console.warn("The shape of the input tensor ("+JSON.stringify(t)+") does not match the expectation of layer "+this.name+": "+JSON.stringify(this.batchInputShape))}},Object.defineProperty(e.prototype,"outputShape",{get:function(){if(null==this.inboundNodes||0===this.inboundNodes.length)throw new Hp("The layer "+this.name+" has never been called and thus has no defined output shape.");for(var t=[],e=0,n=this.inboundNodes;e<n.length;e++){var r=n[e],i=JSON.stringify(r.outputShapes);-1===t.indexOf(i)&&t.push(i)}if(1===t.length){var a=this.inboundNodes[0].outputShapes;return Array.isArray(a)&&Array.isArray(a[0])&&1===a.length?a[0]:a}throw new Hp("The layer "+this.name+' has multiple inbound nodes with different output shapes. Hence the notion of "outut shape" is ill-defined for the layer.')},enumerable:!0,configurable:!0}),e.prototype.countParams=function(){if(!this.built)throw new Gp("You tried to call countParams() on "+this.name+", but the layer is not built yet. Build it first by calling build(batchInputShape).");return Pf(this.weights)},e.prototype.build=function(t){this.built=!0},e.prototype.getWeights=function(t){return void 0===t&&(t=!1),Wf(t?this.trainableWeights:this.weights)},e.prototype.setWeights=function(t){var e=this;Fe(function(){var n=e.weights;if(n.length!==t.length)throw new Kp('You called setWeights(weights) on layer "'+e.name+'" with a weight list of length '+t.length+", but the layer was expecting "+n.length+" weights. Provided weights: "+t+"...");if(0!==n.length){for(var r=[],i=Wf(n),a=0;a<i.length;++a){var o=i[a],s=n[a],u=t[a];if(!J.arraysEqual(o.shape,u.shape))throw new Kp("Layer weight shape "+o.shape+" not compatible with provided weight shape "+u.shape);r.push([s,u])}Uf(r)}})},e.prototype.addWeight=function(t,e,n,r,i,a,o){if(-1!==this._addedWeightNames.indexOf(t))throw new Kp("Duplicate weight name "+t+" for layer "+this.name);this._addedWeightNames.push(t),null==n&&(n="float32"),this.fastWeightInitDuringBuild&&(r=Af("zeros"));var s=r.apply(e,n),u=new Vf(s,n,t,a,o);return s.dispose(),null!=i&&this.addLoss(function(){return i.apply(u.read())}),null==a&&(a=!0),a?this._trainableWeights.push(u):this._nonTrainableWeights.push(u),u},e.prototype.setFastWeightInitDuringBuild=function(t){this.fastWeightInitDuringBuild=t},e.prototype.addLoss=function(t){var e;null==t||Array.isArray(t)&&0===t.length||(t=th(t),void 0!==this._losses&&null!==this._losses&&(e=this.losses).push.apply(e,t))},e.prototype.computeOutputShape=function(t){return t},e.prototype.computeMask=function(t,e){var n=this;if(!this.supportsMasking){if(null!=e){if(!Array.isArray(e))throw new TypeError("Layer "+this.name+" does not support masking, but was passed an inputMask.");e.forEach(function(t){if(null!=t)throw new TypeError("Layer "+n.name+" does not support masking, but was passed an inputMask.")})}return null}return e},e.prototype.addInboundNode=function(t,e,n,r,i,a,o){void 0===o&&(o=null);var s=th(t);e=th(e),n=th(n),r=th(r),i=Mf(i),a=Mf(a);for(var u=[],l=[],c=[],p=0,h=s;p<h.length;p++){var f=h[p];u.push(f.sourceLayer),l.push(f.nodeIndex),c.push(f.tensorIndex)}new Gf({outboundLayer:this,inboundLayers:u,nodeIndices:l,tensorIndices:c,inputTensors:s,outputTensors:e,inputMasks:n,outputMasks:r,inputShapes:i,outputShapes:a},o);for(var d=0;d<e.length;d++)e[d].sourceLayer=this,e[d].nodeIndex=this.inboundNodes.length-1,e[d].tensorIndex=d},e.prototype.getConfig=function(){var t={name:this.name,trainable:this.trainable};return null!=this.batchInputShape&&(t.batchInputShape=this.batchInputShape),null!=this.dtype&&(t.dtype=this.dtype),t},e.prototype.disposeWeights=function(){return this.weights.forEach(function(t){return t.dispose()}),this.weights.length},e.prototype.assertNotDisposed=function(){if(0===this._refCount)throw new Error("Layer '"+this.name+"' is already disposed.")},e.prototype.dispose=function(){if(!this.built)throw new Error("Cannot dispose Layer "+this.name+" because it has not been built yet.");if(null===this._refCount)throw new Error("Cannot dispose Layer "+this.name+" because it has not been used yet.");this.assertNotDisposed();var t=0;return 0==--this._refCount&&(t=this.disposeWeights()),{refCountAfterDispose:this._refCount,numDisposedVariables:t}},e}(yp.Serializable);var Xf,Yf=function(t){function e(e){var n=t.call(this,{dtype:e.dtype,name:null!=e.name?e.name:_f("input").toString()})||this;if(null==e.batchSize&&(e.batchSize=null),null==e.sparse&&(e.sparse=!1),n.trainable=!1,n.built=!0,n.sparse=e.sparse,null!=e.inputShape&&null!=e.batchInputShape)throw new Kp("Only provide the inputShape OR batchInputShape argument to inputLayer, not both at the same time.");var r=e.batchInputShape;if(null==r){if(null==e.inputShape)throw new Kp("An InputLayer should be passed either a `batchInputShape` or an `inputShape`.");r=[e.batchSize].concat(e.inputShape)}else if(null!=e.batchSize)throw new Kp("Cannot specify batchSize if batchInputShape is specified when creating an InputLayer.");var i=e.dtype||"float32";n.batchInputShape=r,n.dtype=i,n.inputSpec=[{shape:r}];var a=new qf(n.dtype,n.batchInputShape,n,[],{},n.name);return a.nodeIndex=0,a.tensorIndex=0,new Gf({outboundLayer:n,inboundLayers:[],nodeIndices:[],tensorIndices:[],inputTensors:[a],outputTensors:[a],inputMasks:[null],outputMasks:[null],inputShapes:[r],outputShapes:[r]}),n}return Bp(e,t),e.prototype.apply=function(t,e){throw new Kp("Cannot pass any input to an InputLayer's apply() method. InputLayer name: "+this.name)},e.prototype.dispose=function(){return{refCountAfterDispose:this._refCount,numDisposedVariables:0}},e.prototype.getConfig=function(){return{batchInputShape:this.batchInputShape,dtype:this.dtype,sparse:this.sparse,name:this.name}},e.className="InputLayer",e}($f);function Jf(t){if(null==t.batchShape&&null==t.shape)throw new Error("Please provide to Input either a `shape` or a `batchShape` argument. Note that `shape` does not include the batch dimension.");if(null!=t.batchShape&&null!=t.shape)throw new Kp("Please provide either a `shape` or `batchShape` argument to Input, but not both.");var e=t.batchShape;null!=t.shape&&null==e&&(e=[null].concat(t.shape));var n=t.dtype;return null==n&&(n="float32"),new Yf({batchInputShape:e,name:t.name,dtype:n,sparse:t.sparse}).inboundNodes[0].outputTensors[0]}function Zf(t){return Up(this,void 0,void 0,function(){var e,n,r,i,a,o,s,u;return jp(this,function(l){switch(l.label){case 0:if(null==t)return[2];for(i in e=[],n=[],r=[],t)"number"!=typeof(a=t[i])&&(o=a,e.push(o.data()),n.push(i),r.push(o));return e.length>0?[4,Promise.all(e)]:[3,2];case 1:for(s=l.sent(),u=0;u<s.length;++u)t[n[u]]=s[u][0];Me(r),l.label=2;case 2:return[2]}})})}function Qf(t){if(null!=t)for(var e in t){var n=t[e];"number"!=typeof n&&n.dispose()}}yp.registerClass(Yf),function(t){t[t.SILENT=0]="SILENT",t[t.VERBOSE=1]="VERBOSE"}(Xf||(Xf={}));var td=125,ed=function(){function t(){this.validationData=null}return t.prototype.setParams=function(t){this.params=t},t.prototype.onEpochBegin=function(t,e){return Up(this,void 0,void 0,function(){return jp(this,function(t){return[2]})})},t.prototype.onEpochEnd=function(t,e){return Up(this,void 0,void 0,function(){return jp(this,function(t){return[2]})})},t.prototype.onBatchBegin=function(t,e){return Up(this,void 0,void 0,function(){return jp(this,function(t){return[2]})})},t.prototype.onBatchEnd=function(t,e){return Up(this,void 0,void 0,function(){return jp(this,function(t){return[2]})})},t.prototype.onTrainBegin=function(t){return Up(this,void 0,void 0,function(){return jp(this,function(t){return[2]})})},t.prototype.onTrainEnd=function(t){return Up(this,void 0,void 0,function(){return jp(this,function(t){return[2]})})},t.prototype.setModel=function(t){},t}(),nd=function(){function t(t,e){void 0===e&&(e=10),null==t&&(t=[]),this.callbacks=t,this.queueLength=e}return t.prototype.append=function(t){this.callbacks.push(t)},t.prototype.setParams=function(t){for(var e=0,n=this.callbacks;e<n.length;e++)n[e].setParams(t)},t.prototype.setModel=function(t){for(var e=0,n=this.callbacks;e<n.length;e++)n[e].setModel(t)},t.prototype.onEpochBegin=function(t,e){return Up(this,void 0,void 0,function(){var n,r;return jp(this,function(i){switch(i.label){case 0:null==e&&(e={}),n=0,r=this.callbacks,i.label=1;case 1:return n<r.length?[4,r[n].onEpochBegin(t,e)]:[3,4];case 2:i.sent(),i.label=3;case 3:return n++,[3,1];case 4:return[2]}})})},t.prototype.onEpochEnd=function(t,e){return Up(this,void 0,void 0,function(){var n,r;return jp(this,function(i){switch(i.label){case 0:null==e&&(e={}),n=0,r=this.callbacks,i.label=1;case 1:return n<r.length?[4,r[n].onEpochEnd(t,e)]:[3,4];case 2:i.sent(),i.label=3;case 3:return n++,[3,1];case 4:return[2]}})})},t.prototype.onBatchBegin=function(t,e){return Up(this,void 0,void 0,function(){var n,r;return jp(this,function(i){switch(i.label){case 0:null==e&&(e={}),n=0,r=this.callbacks,i.label=1;case 1:return n<r.length?[4,r[n].onBatchBegin(t,e)]:[3,4];case 2:i.sent(),i.label=3;case 3:return n++,[3,1];case 4:return[2]}})})},t.prototype.onBatchEnd=function(t,e){return Up(this,void 0,void 0,function(){var n,r;return jp(this,function(i){switch(i.label){case 0:null==e&&(e={}),n=0,r=this.callbacks,i.label=1;case 1:return n<r.length?[4,r[n].onBatchEnd(t,e)]:[3,4];case 2:i.sent(),i.label=3;case 3:return n++,[3,1];case 4:return[2]}})})},t.prototype.onTrainBegin=function(t){return Up(this,void 0,void 0,function(){var e,n;return jp(this,function(r){switch(r.label){case 0:null==t&&(t={}),e=0,n=this.callbacks,r.label=1;case 1:return e<n.length?[4,n[e].onTrainBegin(t)]:[3,4];case 2:r.sent(),r.label=3;case 3:return e++,[3,1];case 4:return[2]}})})},t.prototype.onTrainEnd=function(t){return Up(this,void 0,void 0,function(){var e,n;return jp(this,function(r){switch(r.label){case 0:null==t&&(t={}),e=0,n=this.callbacks,r.label=1;case 1:return e<n.length?[4,n[e].onTrainEnd(t)]:[3,4];case 2:r.sent(),r.label=3;case 3:return e++,[3,1];case 4:return[2]}})})},t}(),rd=function(t){function e(){return t.call(this)||this}return Bp(e,t),e.prototype.onEpochBegin=function(t){return Up(this,void 0,void 0,function(){return jp(this,function(t){return this.seen=0,this.totals={},[2]})})},e.prototype.onBatchEnd=function(t,e){return Up(this,void 0,void 0,function(){var t,n,r,i,a=this;return jp(this,function(o){for(i in null==e&&(e={}),t=null==e.size?0:e.size,this.seen+=t,n=function(n){var i=e[n];if("number"==typeof i)r.totals.hasOwnProperty(n)||(r.totals[n]=0),r.totals[n]=r.totals[n]+i*t;else{var o=void 0;n in r.totals?o=r.totals[n]:r.totals[n]=0,r.totals[n]=Fe(function(){return Ls(a.totals[n],Ys(i,t))}),null!=o&&o.dispose()}},r=this,e)n(i);return[2]})})},e.prototype.onEpochEnd=function(t,e){return Up(this,void 0,void 0,function(){var t,n,r,i,a,o=this;return jp(this,function(s){if(null!=e)for(t=function(t){if(null==n.totals[t])return"continue";"number"==typeof n.totals[t]?e[t]=n.totals[t]/n.seen:Fe(function(){e[t]=Ys(Ws(1,o.seen),o.totals[t]),o.totals[t].dispose(),ze(e[t])})},n=this,r=0,i=this.params.metrics;r<i.length;r++)a=i[r],t(a);return[2]})})},e}(ed),id=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return Bp(e,t),e.prototype.onTrainBegin=function(t){return Up(this,void 0,void 0,function(){return jp(this,function(t){return this.epoch=[],this.history={},[2]})})},e.prototype.onEpochEnd=function(t,e){return Up(this,void 0,void 0,function(){var n;return jp(this,function(r){for(n in null==e&&(e={}),this.epoch.push(t),e)null==this.history[n]&&(this.history[n]=[]),this.history[n].push(e[n]);return[2]})})},e.prototype.syncData=function(){return Up(this,void 0,void 0,function(){var t,e,n,r,i,a,o,s,u;return jp(this,function(l){switch(l.label){case 0:for(r in t=[],e=[],n=[],this.history)for(i=this.history[r],a=0;a<i.length;++a)"number"!=typeof i[a]&&(o=i[a],t.push(o.data()),e.push(r),n.push(a));return[4,Promise.all(t)];case 1:for(s=l.sent(),u=0;u<s.length;++u)this.history[e[u]][n[u]].dispose(),this.history[e[u]][n[u]]=s[u][0];return[2]}})})},e}(ed),ad=function(t){function e(e,n){var r=t.call(this)||this;if(r.currentEpoch=0,r.yieldEvery=n||"auto","auto"===r.yieldEvery&&(r.yieldEvery=td),"never"===r.yieldEvery&&null!=e.onYield)throw new Error("yieldEvery is `never` but you provided an `onYield` callback. Either change `yieldEvery` or remove the callback");return J.isNumber(r.yieldEvery)&&(r.maybeWait=function(t,e){var n,r=J.now();return function(){for(var i=[],a=0;a<arguments.length;a++)i[a]=arguments[a];var o=J.now();return o-r<e?n:(r=o,n=t.apply(void 0,i))}}(r.maybeWait.bind(r),r.yieldEvery)),r.trainBegin=e.onTrainBegin,r.trainEnd=e.onTrainEnd,r.epochBegin=e.onEpochBegin,r.epochEnd=e.onEpochEnd,r.batchBegin=e.onBatchBegin,r.batchEnd=e.onBatchEnd,r.yield=e.onYield,r}return Bp(e,t),e.prototype.maybeWait=function(t,e,n){return Up(this,void 0,void 0,function(){var r;return jp(this,function(i){switch(i.label){case 0:return r=[],null==this.yield?[3,2]:[4,Zf(n)];case 1:i.sent(),r.push(this.yield(t,e,n)),i.label=2;case 2:return r.push(Lp()),[4,Promise.all(r)];case 3:return i.sent(),[2]}})})},e.prototype.onEpochBegin=function(t,e){return Up(this,void 0,void 0,function(){return jp(this,function(n){switch(n.label){case 0:return this.currentEpoch=t,null==this.epochBegin?[3,3]:[4,Zf(e)];case 1:return n.sent(),[4,this.epochBegin(t,e)];case 2:n.sent(),n.label=3;case 3:return[2]}})})},e.prototype.onEpochEnd=function(t,e){return Up(this,void 0,void 0,function(){var n;return jp(this,function(r){switch(r.label){case 0:return n=[],null==this.epochEnd?[3,2]:[4,Zf(e)];case 1:r.sent(),n.push(this.epochEnd(t,e)),r.label=2;case 2:return"epoch"===this.yieldEvery&&n.push(Lp()),[4,Promise.all(n)];case 3:return r.sent(),[2]}})})},e.prototype.onBatchBegin=function(t,e){return Up(this,void 0,void 0,function(){return jp(this,function(n){switch(n.label){case 0:return null==this.batchBegin?[3,3]:[4,Zf(e)];case 1:return n.sent(),[4,this.batchBegin(t,e)];case 2:n.sent(),n.label=3;case 3:return[2]}})})},e.prototype.onBatchEnd=function(t,e){return Up(this,void 0,void 0,function(){var n;return jp(this,function(r){switch(r.label){case 0:return n=[],null==this.batchEnd?[3,2]:[4,Zf(e)];case 1:r.sent(),n.push(this.batchEnd(t,e)),r.label=2;case 2:return"batch"===this.yieldEvery?n.push(Lp()):J.isNumber(this.yieldEvery)&&n.push(this.maybeWait(this.currentEpoch,t,e)),[4,Promise.all(n)];case 3:return r.sent(),[2]}})})},e.prototype.onTrainBegin=function(t){return Up(this,void 0,void 0,function(){return jp(this,function(e){switch(e.label){case 0:return null==this.trainBegin?[3,3]:[4,Zf(t)];case 1:return e.sent(),[4,this.trainBegin(t)];case 2:e.sent(),e.label=3;case 3:return[2]}})})},e.prototype.onTrainEnd=function(t){return Up(this,void 0,void 0,function(){return jp(this,function(e){switch(e.label){case 0:return null==this.trainEnd?[3,3]:[4,Zf(t)];case 1:return e.sent(),[4,this.trainEnd(t)];case 2:e.sent(),e.label=3;case 3:return[2]}})})},e}(ed);function od(t,e){return null==t&&(t={}),t instanceof ed?[t]:Array.isArray(t)&&t[0]instanceof ed?t:th(t).map(function(t){return new ad(t,e)})}var sd=function(){function t(){}return t.registerCallbackConstructor=function(e,n){J.assert(e>=0&&Number.isInteger(e),function(){return"Verbosity level is expected to be an integer >= 0, but got "+e}),t.checkForDuplicate(n),null==t.constructors[e]&&(t.constructors[e]=[]),t.constructors[e].push(n)},t.checkForDuplicate=function(e){for(var n in t.constructors)t.constructors[+n].forEach(function(t){if(t===e)throw new Kp("Duplicate callback constructor.")})},t.clear=function(){t.constructors={}},t.createCallbacks=function(e){var n=[];for(var r in t.constructors){var i=+r;e>=i&&n.push.apply(n,t.constructors[i])}return n.map(function(t){return new t})},t.constructors={},t}();function ud(t,e,n,r,i,a,o,s,u){var l=new id,c=[new rd].concat(sd.createCallbacks(e));null!=t&&c.push.apply(c,t),c.push(l);var p=new nd(c);return p.setParams({epochs:n,initialEpoch:r,samples:i,steps:a,batchSize:o,verbose:e,doValidation:s,metrics:u}),{callbackList:p,history:l}}function ld(t,e,n){return void 0===e&&(e={}),void 0===n&&(n=!1),ah(t,yp.SerializationMap.getMap().classNameMap,e,"layer",n)}function cd(t,e){return Fe(function(){"float32"!==t.dtype&&(t=t.asType("float32"));var n=cl(ef(t),e,!0),r=mn(n.shape,qp()),i=hs(qs(n,r));return Ws(t,i)})}function pd(t,e){return Fe(function(){return sl(ef(nu(e,t)),-1)})}function hd(t,e){return Fe(function(){return sl(zo(nu(e,t)),-1)})}function fd(t,e){return Fe(function(){var n=nu(t,e),r=qo(zo(t),qp(),Number.MAX_VALUE),i=zo(Ws(n,r));return Ys(100,sl(i,-1))})}function dd(t,e,n){return void 0===n&&(n=!1),Fe(function(){if(n)e=Rr(e);else{var r=cl(e,e.shape.length-1,!0);e=Ws(e,r)}return e=qo(e,qp(),1-qp()),ts(cl(Ys(t.toFloat(),Jo(e)),e.shape.length-1))})}function md(t,e){return Fe(function(){var n=Yo(function(t){var e=[Bh(t.shape)];return t.reshape(e)}(t)).toInt(),r=(e=qo(e,qp(),1-qp())).shape;return dd($n(n,r[r.length-1]).reshape(r),e,!1)})}function gd(t,e){return Fe(function(){var n;return n=qo(e,qp(),1-qp()),n=Jo(Ws(n,nu(1,n))),sl(function(t,e){if(!J.arraysEqual(t.shape,e.shape))throw new Kp("logits and labels must have the same shape, but got shapes "+JSON.stringify(t.shape)+" and "+JSON.stringify(e.shape));return Fe(function(){var n=e.relu(),r=e.abs().neg();return n.sub(e.mul(t)).add(r.exp().log1p())})}(t,n),-1)})}function vd(t,e){return Fe(function(){var n=cd(t,-1),r=cd(e,-1),i=Ys(n,r);return ts(cl(i,-1))})}var yd={meanSquaredError:pd,meanAbsoluteError:hd,meanAbsolutePercentageError:fd,meanSquaredLogarithmicError:function(t,e){return Fe(function(){var n=qo(e,qp(),Number.MAX_VALUE),r=Jo(Ls(1,n)),i=qo(t,qp(),Number.MAX_VALUE),a=Jo(Ls(1,i));return sl(ef(nu(r,a)),-1)})},squaredHinge:function(t,e){return Fe(function(){var n=qs(0,nu(1,Ys(t,e)));return sl(ef(n),-1)})},hinge:function(t,e){return Fe(function(){var n=qs(0,nu(1,Ys(t,e)));return sl(n,-1)})},categoricalHinge:function(t,e){return Fe(function(){var n=cl(Ys(t,e),-1),r=ol(Ys(nu(1,t),e),-1);return qs(0,Ls(1,nu(r,n)))})},logcosh:function(t,e){return Fe(function(){var n=Math.log(2),r=nu(e,t),i=nu(Ls(r,ps(Ys(-2,r))),n);return sl(i,-1)})},categoricalCrossentropy:dd,sparseCategoricalCrossentropy:md,binaryCrossentropy:gd,kullbackLeiblerDivergence:function(t,e){return Fe(function(){var n=qo(t,qp(),1),r=qo(e,qp(),1);return cl(Ys(t,Jo(Ws(n,r))),-1)})},poisson:function(t,e){return Fe(function(){var n=Jo(Ls(qp(),e));return sl(nu(e,Ys(t,n)),-1)})},cosineProximity:vd};function bd(t){if("string"==typeof t){if(t in yd)return yd[t];var e="Unknown loss "+t;throw t.toLowerCase().includes("softmaxcrossentropy")&&(e="Unknown loss "+t+'. Use "categoricalCrossentropy" as the string name for tf.losses.softmaxCrossEntropy'),new Kp(e)}return t}function xd(t,e){return Fe(function(){var n=Ys(.5,yn(e)),r=qh(ou(e,n),t.dtype);return sl(iu(t,r),-1)})}function wd(t,e){return Fe(function(){return qh(iu(rl(t,-1),rl(e,-1)),"float32")})}function Nd(t,e){return Fe(function(){return Ds(t.equal(1),e.equal(1)).sum().cast("float32")})}function Cd(t,e){return Fe(function(){var n=Nd(t,e),r=function(t,e){return Fe(function(){return Ds(t.equal(0),e.equal(1)).sum().cast("float32")})}(t,e),i=n.add(r);return Ms(ou(i,0),n.div(i),0).cast("float32")})}function Ed(t,e){return Fe(function(){var n=Nd(t,e),r=function(t,e){return Fe(function(){return Ds(t.equal(1),e.equal(0)).sum().cast("float32")})}(t,e),i=n.add(r);return Ms(ou(i,0),n.div(i),0).cast("float32")})}function Sd(t,e){return gd(t,e)}function kd(t,e){return t.rank===e.rank&&(t=t.squeeze([t.rank-1])),(e=e.argMax(-1)).dtype!==t.dtype&&(e=e.asType(t.dtype)),iu(t,e).asType("float32")}var Id=dd,Ad=md,Rd={binaryAccuracy:xd,categoricalAccuracy:wd,precision:Cd,categoricalCrossentropy:Id,sparseCategoricalCrossentropy:Ad,mse:pd,MSE:pd,mae:hd,MAE:hd,mape:fd,MAPE:fd,cosine:vd};function Td(t){if(Jp(null!==t,"Unknown LossOrMetricFn "+t),"string"==typeof t)return t;for(var e=void 0,n=0,r=Object.keys(yd);n<r.length;n++){var i=r[n];if(yd[i]===t){e=i;break}}if(void 0!==e)return e;for(var a=0,o=Object.keys(Rd);a<o.length;a++)if(i=o[a],Rd[i]===t){e=i;break}return void 0!==e?e:t.name}var Dd=1048576;function Od(t,e,n){if(void 0===n&&(n=!1),null==t||"object"!=typeof t||Object.getPrototypeOf(t)!==Object.prototype||!function t(e){if(null===e)return!0;if("object"==typeof e){if(Object.getPrototypeOf(e)===Object.prototype){for(var n=0,r=Object.keys(e);n<r.length;n++){var i=r[n];if("string"!=typeof i)return!1;if(!t(e[i]))return!1}return!0}if(Array.isArray(e)){for(var a=0,o=e;a<o.length;a++)if(!t(o[a]))return!1;return!0}return!1}var s=typeof e;return"string"===s||"number"===s||"boolean"===s}(t))throw new Error("User-defined metadata is expected to be a JSON object, but is not.");if(n){var r=JSON.stringify(t);r.length>Dd&&console.warn('User-defined metadata of model "'+e+'" is too large in size (length='+r.length+" when serialized). It is not recommended to store such large objects in user-defined metadata. Please make sure its serialized length is <= "+Dd+".")}}function _d(t,e,n,r){void 0===r&&(r=console.log);var i,a=function(t){var e=!0,n=[],r=[];for(var i in t.nodesByDepth)n.push(t.nodesByDepth[i]);for(var a=0,o=n;a<o.length;a++){var s=o[a];if(s.length>1||1===s.length&&s[0].inboundLayers.length>1){e=!1;break}r.push.apply(r,s)}if(e)for(var u=0,l=t.layers;u<l.length;u++){for(var c=!1,p=0,h=l[u].inboundNodes;p<h.length;p++){var f=h[p];if(-1!==r.indexOf(f)){if(c){e=!1;break}c=!0}}if(!e)break}return e}(t),o=["Layer (type)","Output shape","Param #"];if(a?(e=e||65,n=n||[.45,.85,1]):(e=e||98,n=n||[.33,.55,.67,1]),n[n.length-1]<=1&&(n=n.map(function(t){return Math.floor(e*t)})),!a)for(var s in o.push("Receives inputs"),i=[],t.nodesByDepth)i.push.apply(i,t.nodesByDepth[s]);r("_".repeat(e)),Fd(o,n,r),r("=".repeat(e));for(var u=t.layers,l=0;l<u.length;++l)a?Md(u[l],n,r):zd(u[l],n,i,r),r((l===u.length-1?"=":"_").repeat(e));t.checkTrainableWeightsConsistency();var c=function(t){return null!=t.collectedTrainableWeights?Pf(t.collectedTrainableWeights):Pf(t.trainableWeights)}(t),p=Pf(t.nonTrainableWeights);r("Total params: "+(c+p)),r("Trainable params: "+c),r("Non-trainable params: "+p),r("_".repeat(e))}function Fd(t,e,n){void 0===n&&(n=console.log);for(var r="",i=0;i<t.length;++i)i>0&&(r=r.slice(0,r.length-1)+" "),r=(r+=t[i]).slice(0,e[i]),r+=" ".repeat(e[i]-r.length);n(r)}function Md(t,e,n){var r;try{r=JSON.stringify(t.outputShape)}catch(t){r="multiple"}Fd([t.name+" ("+t.getClassName()+")",r,t.countParams().toString()],e,n)}function zd(t,e,n,r){var i;try{i=JSON.stringify(t.outputShape)}catch(t){i="multiple"}for(var a=[],o=0,s=t.inboundNodes;o<s.length;o++){var u=s[o];if(!(null!=n&&n.length>0&&-1===n.indexOf(u)))for(var l=0;l<u.inboundLayers.length;++l){var c=u.inboundLayers[l].name,p=u.nodeIndices[l],h=u.tensorIndices[l];a.push(c+"["+p+"]["+h+"]")}}var f=t.name,d=t.getClassName(),m=0===a.length?"":a[0];for(Fd([f+" ("+d+")",i,t.countParams().toString(),m],e,r),l=1;l<a.length;++l)Fd(["","","",a[l]],e,r)}function Ld(t,e,n){return("inboundNodes"===t||"outputLayers"===t||"inputLayers"===t)&&0===e&&"string"==typeof n}function Pd(t,e){if(null===t)return null;if("string"==typeof t)return nh(t);if("number"==typeof t||"boolean"==typeof t)return t;if(t instanceof Array){for(var n=[],r=t.length,i=0;i<r;++i){var a=t[i];Ld(e,i,a)?n.push(a):n.push(Pd(a,e))}return n}for(var o={},s=0,u=Object.keys(t);s<u.length;s++){var l=u[s],c=t[l];if("name"===l&&"string"==typeof c)o[l]=c;else{var p=nh(l);o[p]=Pd(c,p)}}return o}var Bd=function(){function t(e){if(this.id2Value={},this.id2Mask={},this.name2Id={},e instanceof t)for(var n in e.id2Value)this.id2Value[n]=e.id2Value[n],n in e.id2Mask&&(this.id2Mask[n]=e.id2Mask[n]);else{if(null==e)return;for(var r=0,i=e;r<i.length;r++){var a=i[r];this.add(a.key,a.value)}}}return t.prototype.add=function(t,e,n){if(null!=this.id2Value[t.id])throw new Kp("Duplicate key: name="+t.name+", id="+t.id);return this.id2Value[t.id]=function(t,e){if(null==t.dtype||t.dtype===e.dtype)return e;try{return Wn(e,t.dtype)}catch(n){throw new Kp("The dtype of the feed ("+e.dtype+") can not be cast to the dtype of the key '"+t.name+"' ("+t.dtype+").")}}(t,e),this.name2Id[t.name]=t.id,null!=n&&(this.id2Mask[t.id]=n),this},t.prototype.addFeed=function(t){this.add(t.key,t.value)},t.prototype.hasKey=function(t){return null!=this.id2Value[t.id]},t.prototype.names=function(){return Object.keys(this.name2Id)},t.prototype.getValue=function(t){if(t instanceof qf){if(null==this.id2Value[t.id])throw new Kp("Nonexistent key: "+t.name);return this.id2Value[t.id]}var e=this.name2Id[t];if(null==e)throw new Kp("Feed dict has no SymbolicTensor name: "+t);return this.id2Value[e]},t.prototype.getMask=function(t){if(t instanceof qf){if(null==this.id2Value[t.id])throw new Kp("Nonexistent key: "+t.name);return this.id2Mask[t.id]}var e=this.name2Id[t];if(null==e)throw new Kp("Feed dict has no SymbolicTensor name: "+t);return this.id2Mask[e]},t.prototype.disposeMasks=function(){null!=this.id2Mask&&Me(this.id2Mask)},t}(),Vd={},Wd={};function Ud(t,e,n,r){for(var i=null!=n&&n.training,a=Array.isArray(t),o=a?t:[t],s=o.map(function(t){return t.name}),u=[],l=e.names(),c=0,p=s;c<p.length;c++){var h=p[c];-1!==l.indexOf(h)?u.push(e.getValue(h)):u.push(null)}null!=r&&(r.maxNumTensors=-1/0,r.minNumTensors=1/0);var f,d,m=s.join(",")+"|"+e.names().join(",");if(null==Vd[m]){var g=function(t,e){J.assert(null!=t&&t.length>0,function(){return"Expected at least one fetch, got none"});var n=[],r={};if(1===t.length){var i=jd(t[0],e);n=i.sorted,r=i.recipientMap}else for(var a=new Set,o=0,s=t;o<s.length;o++){for(var u=jd(s[o],e),l=u.sorted,c=u.recipientMap,p=0,h=l;p<h.length;p++){var f=h[p];a.has(f.name)||(n.push(f),a.add(f.name))}var d=function(t){null==r[t]&&(r[t]=new Set),c[t].forEach(function(e){return r[t].add(e)})};for(var m in c)d(m)}return{sorted:n,recipientCounts:function(t){var e={};for(var n in t)e[n]=t[n].size;return e}(r)}}(o,e);f=g.sorted,d=g.recipientCounts,Vd[m]=f,Wd[m]=d}f=Vd[m],d={},i||Object.assign(d,Wd[m]);for(var v=new Bd(e),y=0;y<f.length;++y){if(null!=r){var b=_e().numTensors;b>r.maxNumTensors&&(r.maxNumTensors=b),b<r.minNumTensors&&(r.minNumTensors=b)}var x=f[y],w=x.sourceLayer;if(!(w instanceof Yf)){for(var N=[],C=[],E=[],S=!1,k=0,I=x.inputs;k<I.length;k++){var A=I[k],R=v.getValue(A),T=v.getMask(A);N.push(R),C.push(T),null!=T&&(S=!0),i||(d[A.name]--,0!==d[A.name]||e.hasKey(A)||-1!==s.indexOf(A.name)||R.isDisposed||!0===A.sourceLayer.stateful||E.push(R))}S&&((n=n||{}).mask=C[0]);var D=th(w.apply(N,n)),O=null;w.supportsMasking&&(O=w.computeMask(N,C));for(var _=qd(x),F=Array.isArray(_)?_:[_],M=0;M<F.length;++M){v.hasKey(F[M])||v.add(F[M],D[M],Array.isArray(O)?O[0]:O);var z=s.indexOf(F[M].name);-1!==z&&(u[z]=D[M])}i||Me(E)}}return v.disposeMasks(),a?u:u[0]}function jd(t,e){for(var n=new Set,r=[],i={},a=0,o=e.names();a<o.length;a++){var s=o[a];n.add(s)}var u=[],l=[];for(u.push(t);u.length>0;){var c=u[u.length-1];if(n.has(c.name))u.pop();else{var p=l[l.length-1]===u.length-1;if(0===c.inputs.length||p)u.pop(),r.push(c),n.add(c.name),p&&l.pop();else{l.push(u.length-1);for(var h=0,f=c.inputs;h<f.length;h++){var d=f[h];null==i[d.name]&&(i[d.name]=new Set),i[d.name].add(c.name),n.has(d.name)||u.push(d)}}}}return{sorted:r,recipientMap:i}}function qd(t){var e;if(1===t.sourceLayer.inboundNodes.length)e=t.sourceLayer.output;else{for(var n=null,r=0;r<t.sourceLayer.inboundNodes.length;++r)for(var i=0,a=t.sourceLayer.inboundNodes[r].outputTensors;i<a.length;i++)if(a[i].id===t.id){n=r;break}e=t.sourceLayer.getOutputAt(n)}return e}function Hd(t,e){return function(t,e,n){var r=e.length;if(null==t||Array.isArray(t)&&0===t.length)return e.map(function(t){return null});if(1===r)return Array.isArray(t)&&1===t.length?t:"object"==typeof t&&e[0]in t?[t[e[0]]]:[t];if(Array.isArray(t)){if(t.length!==r)throw new Error("Provided "+n+" is an array of "+t.length+" element(s), but the model has "+r+" outputs. Make sure a set of weights is provided for each model output.");return t}if("object"==typeof t&&Object.keys(t).length>0&&"object"==typeof t[Object.keys(t)[0]]){var i=[];return e.forEach(function(e){e in t?i.push(t[e]):i.push(null)}),i}throw new Error("The model has multiple ("+r+") outputs, so "+n+" must be either an array with "+r+" elements or an object with "+e+" keys. Provided "+n+" not understood: "+JSON.stringify(t))}(t,e,"classWeight")}function Gd(t,e,n,r){return Up(this,void 0,void 0,function(){var i,a,o,s,u;return jp(this,function(l){switch(l.label){case 0:if(null!=e||null!=r)throw new Error("Support sampleWeight is not implemented yet");return null==n?[3,2]:(i=Fe(function(){if(1===t.shape.length)return t.clone();if(2===t.shape.length){if(t.shape[1]>1)return t.argMax(1);if(1===t.shape[1])return t.reshape([t.shape[0]]);throw new Error("Encountered unexpected last-dimension size ("+t.shape[1]+") during handling of class weights. The size is expected to be >= 1.")}throw new Error("Unexpected rank of target (y) tensor ("+t.rank+") during handling of class weights. The rank is expected to be 1 or 2.")}),s=(o=Array).from,[4,i.data()]);case 1:return a=s.apply(o,[l.sent()]),Me(i),u=[],a.forEach(function(t){if(null==n[t])throw new Error("classWeight must contain all classes in the training data. The class "+t+" exists in the data but not in classWeight");u.push(n[t])}),[2,sn(u,"float32")];case 2:return[2,null]}})})}function Kd(t,e){return Ys(t,e)}var $d=32;function Xd(t,e){var n,r,i=e;n=i.xs,r=i.ys,J.assert(null!=n&&null!=r,function(){return"A Dataset iterator for fitDataset() is expected to generate objects of the form `{xs: xVal, ys: yVal}`, where the two values may be `tf.Tensor`, an array of Tensors, or a map of string to Tensor.  The provided Dataset instead generates "+e});var a=Yd("input",t.inputNames,n),o=Yd("output",t.outputNames,r),s=a[0].shape[0];J.assert(a.length===t.inputs.length,function(){return"LayersModel has "+t.inputs.length+" inputs, but the dataset provides "+a.length+" inputs.  (Expected input keys: "+JSON.stringify(t.inputNames)+")"}),J.assert(o.length===t.outputs.length,function(){return"LayersModel has "+t.outputs.length+" outputs, but the dataset provides "+o.length+" outputs.  (Expected output keys: "+JSON.stringify(t.outputNames)+")"});var u=function(e){J.assert(a[e].shape[0]===s,function(){return"Batch size mismatch: input "+t.inputNames[e]+" has "+a[e].shape[0]+"; expected  "+s+" based on input "+t.inputNames[0]+"."})};for(var l in a)u(l);var c=function(e){J.assert(o[e].shape[0]===s,function(){return"Batch size mismatch: output "+t.outputNames[e]+" has "+o[e].shape[0]+"; expected  "+s+" based on input "+t.inputNames[0]+"."})};for(var p in o)c(p);return{xs:a,ys:o}}function Yd(t,e,n){if(n instanceof ct)return[n];if(Array.isArray(n))return J.assert(n.length===e.length,function(){return"Received an array of "+n.length+" Tensors, but expected "+e.length+" to match the "+t+" keys "+e+"."}),n;for(var r=[],i=0,a=e;i<a.length;i++){var o=a[i];if(null==n[o])throw new Kp("The feature data generated by the dataset lacks the required "+t+" key '"+o+"'.");r.push(n[o])}return r}function Jd(t,e,n){return Up(this,void 0,void 0,function(){var r,i,a,o,s,u,l,c,p,h,f,d,m,g,v,y,b,x,w,N,C,E,S,k,I,A,R,T,D,O,_,F,M,z;return jp(this,function(L){switch(L.label){case 0:if(r=null!=n.batchesPerEpoch,J.assert(null!=t.optimizer,function(){return"You must compile a model before training/testing. Use LayersModel.compile(modelCompileConfig)."}),J.assert(null!=n,function(){return"For fitDataset(), the 2nd argument (config) is required, but it is not provided in this call."}),J.assert(null!=n.epochs&&n.epochs>0&&Number.isInteger(n.epochs),function(){return"For fitDataset(), config.epochs is expected to be a positive integer, but got "+n.epochs}),J.assert(!r||n.batchesPerEpoch>0&&Number.isInteger(n.batchesPerEpoch),function(){return"For fitDataset(), config.batchesPerEpoch is expected to be a positive integer if specified, but got "+n.batchesPerEpoch}),J.assert(null==n.validationSplit,function(){return"`validationSplit` is not supported by `fitDataset()`. Use validationData instead."}),t.isTraining)throw new Error("Cannot start training because another fit() call is ongoing.");t.isTraining=!0,L.label=1;case 1:return L.trys.push([1,,26,27]),i=null!=n.validationData,a=void 0,o=void 0,i&&(Zd(n.validationData)?J.assert(null==n.validationBatches||n.validationBatches>0&&Number.isInteger(n.validationBatches),function(){return"For fitDataset() with dataset-based validation, config.validationBatches is expected not to be provided, or to be a positive integer, but got "+n.validationBatches}):(s=function(t){if(3===t.length)throw new $p("Validation with sample weights is not implemented yet.");return{xs:t[0],ys:t[1]}}(n.validationData),a=s.xs,o=s.ys)),u=t.makeTrainFunction(),l=t.getDedupedMetricsNames(),c=void 0,c=i?l.slice().concat(l.map(function(t){return"val_"+t})):l.slice(),p=od(n.callbacks,n.yieldEvery),h=null==n.verbose?1:n.verbose,f=ud(p,h,n.epochs,null,null,function(t,e){var n=null;return null!=e.batchesPerEpoch?n=e.batchesPerEpoch:Number.isFinite(t.size)&&(n=t.size),n}(e,n),null,i,c),d=f.callbackList,m=f.history,d.setModel(t),t.history=m,[4,d.onTrainBegin()];case 2:return L.sent(),t.stopTraining_=!1,g=null==n.initialEpoch?0:n.initialEpoch,[4,e.iterator()];case 3:v=L.sent(),L.label=4;case 4:return g<n.epochs?(y={},[4,d.onEpochBegin(g)]):[3,23];case 5:return L.sent(),b=0,x=0,r?[3,7]:[4,e.iterator()];case 6:v=L.sent(),L.label=7;case 7:return!r||b<n.batchesPerEpoch?[4,v.next()]:[3,21];case 8:return w=L.sent(),r&&w.done?(console.warn("You provided `batchesPerEpoch` as "+n.batchesPerEpoch+", but your dataset iterator ran out of data after "+b+" batches; interrupting training. Make sure that your dataset can generate at least `batchesPerEpoch * epochs` batches (in this case, "+n.batchesPerEpoch*n.epochs+" batches). You may need to use the repeat() function when building your dataset."),[3,21]):null==w.value?[3,15]:(N=Xd(t,w.value),C=N.xs,E=N.ys,(S={}).batch=x,S.size=C[0].shape[0],[4,d.onBatchBegin(x,S)]);case 9:if(L.sent(),k=[],null==n.classWeight)return[3,13];I=Hd(n.classWeight,t.outputNames),z=0,L.label=10;case 10:return z<I.length?(R=(A=k).push,[4,Gd(E[z],null,I[z])]):[3,13];case 11:R.apply(A,[L.sent()]),L.label=12;case 12:return++z,[3,10];case 13:for(T=C.concat(E).concat(k),D=u(T),Me(T),z=0;z<l.length;++z)O=l[z],_=D[z],S[O]=_,ze(_);return[4,d.onBatchEnd(x,S)];case 14:L.sent(),Qf(S),x++,b++,L.label=15;case 15:return(r?b>=n.batchesPerEpoch:w.done)?i?(F=void 0,Zd(n.validationData)?(M=th,[4,t.evaluateDataset(n.validationData,{batches:n.validationBatches})]):[3,17]):[3,19]:[3,20];case 16:return F=M.apply(void 0,[L.sent()]),[3,18];case 17:F=th(t.evaluate(a,o,{batchSize:null==n.validationBatchSize?$d:n.validationBatchSize,verbose:0})),L.label=18;case 18:for(z=0;z<t.metricsNames.length;++z)y["val_"+t.metricsNames[z]]=F[z];L.label=19;case 19:return[3,21];case 20:return t.stopTraining_?[3,21]:[3,7];case 21:return[4,d.onEpochEnd(g,y)];case 22:return L.sent(),g++,t.stopTraining_?[3,23]:[3,4];case 23:return[4,d.onTrainEnd()];case 24:return L.sent(),[4,t.history.syncData()];case 25:return L.sent(),[2,t.history];case 26:return t.isTraining=!1,[7];case 27:return[2]}})})}function Zd(t){return"function"==typeof t.iterator}function Qd(t){J.assert(t>0&&Number.isInteger(t),function(){return"batchSize is required to be a positive integer, but got "+t})}function tm(t,e,n){return null==t?[null]:Array.isArray(t)?t.map(function(t){return Gh(t,e,n-e)}):Gh(t,e,n-e)}function em(t,e){return Fe(function(){return null==t?null:Array.isArray(t)?t.map(function(t){return em(t,e)}):tf(t,"int32"===e.dtype?e:e.toInt())})}function nm(t,e){for(var n=[],r=0,i=null;r<t;)(i=r+e)>=t&&(i=t),n.push([r,i]),r=i;return n}function rm(t,e,n,r){return void 0===r&&(r={}),Up(this,void 0,void 0,function(){var i,a,o,s,u,l,c,p,h,f,d,m,g,v,y,b,x,w,N,C,E,S;return jp(this,function(k){switch(k.label){case 0:if(t.isTraining)throw new Error("Cannot start training because another fit() call is ongoing.");t.isTraining=!0,k.label=1;case 1:return k.trys.push([1,,7,8]),Qd(p=null==r.batchSize?32:r.batchSize),h=!1,[4,t.standardizeUserData(e,n,r.sampleWeight,r.classWeight,h,p)];case 2:if(f=k.sent(),i=f[0],a=f[1],c=f[2],d=!1,m=void 0,!(null!=r.validationData&&r.validationData.length>0))return[3,4];if(d=!0,2!==r.validationData.length)throw 3===r.validationData.length?new $p("validationData including sample weights is not supported yet."):new Kp("When passing validation data, it must contain 2 (valX, valY) or 3 (valX, valY, valSampleWeight) items; "+r.validationData+" is invalid.");return o=r.validationData[0],s=r.validationData[1],g=!0,[4,t.standardizeUserData(o,s,null,null,g,p)];case 3:return v=k.sent(),u=v[0],l=v[1],m=u.concat(l),[3,5];case 4:null!=r.validationSplit&&r.validationSplit>0&&r.validationSplit<1?(d=!0,y=Math.floor(i[0].shape[0]*(1-r.validationSplit)),b=i[0].shape[0],u=tm(i,y,b),i=tm(i,0,y),l=tm(a,y,b),a=tm(a,0,y),m=u.concat(l)):null!=r.validationSteps&&(d=!0),k.label=5;case 5:return x=i.concat(a).concat(c),t.checkTrainableWeightsConsistency(),w=t.makeTrainFunction(),N=t.getDedupedMetricsNames(),C=void 0,E=void 0,d?(t.makeTestFunction(),C=t.testFunction,E=N.slice().concat(N.map(function(t){return"val_"+t}))):(C=null,m=[],E=N.slice()),S=od(r.callbacks,r.yieldEvery),[4,function(t,e,n,r,i,a,o,s,u,l,c,p,h,f,d){return Up(this,void 0,void 0,function(){var m,g,v,y,b,x,w,N;return jp(this,function(C){switch(C.label){case 0:if(null==i&&(i=32),null==a&&(a=1),null==c&&(c=!0),null==h&&(h=0),m=!1,null!=u&&null!=l&&(m=!0),null!=d&&(m=!0,null==f))throw new Kp("Can only use `validationSteps` when doing step-wise training, i.e., `stepsPerEpoch` must be set.");return null!=(g=t.checkNumSamples(n,i,f,"steps_per_epoch"))&&(v=jh(0,g)),null==o&&(o=1),y=ud(s,o,a,h,g,f,i,m,p),b=y.callbackList,x=y.history,b.setModel(t),t.history=x,[4,b.onTrainBegin()];case 1:C.sent(),t.stopTraining_=!1,w=function(a){var o,s,p,h,d;return jp(this,function(y){switch(y.label){case 0:return[4,b.onEpochBegin(a)];case 1:if(y.sent(),o={},null==f)return[3,2];throw new $p("stepsPerEpoch mode is not implemented yet.");case 2:if("batch"===c)throw new $p("batch shuffling is not implemneted yet");c&&J.shuffle(v),s=sn(v),p=nm(g,i),h=function(a){var c;return jp(this,function(h){switch(h.label){case 0:return c={},[4,b.onBatchBegin(a,c)];case 1:return h.sent(),Fe(function(){var h=p[a][0],f=p[a][1],d=Gh(s,h,f-h);c.batch=a,c.size=f-h;for(var g=em(n,d),v=e(g),y=0;y<r.length;++y){var b=r[y],x=v[y];c[b]=x,ze(x)}if(a===p.length-1&&m){var w=t.testLoop(u,l,i);for(y=0;y<r.length;++y)b=r[y],ze(x=w[y]),o["val_"+b]=x}}),[4,b.onBatchEnd(a,c)];case 2:return h.sent(),Qf(c),t.stopTraining_?[2,"break"]:[2]}})},d=0,y.label=3;case 3:return d<p.length?[5,h(d)]:[3,6];case 4:if("break"===y.sent())return[3,6];y.label=5;case 5:return++d,[3,3];case 6:s.dispose(),y.label=7;case 7:return[4,b.onEpochEnd(a,o)];case 8:return y.sent(),t.stopTraining_?[2,"break"]:[2]}})},N=h,C.label=2;case 2:return N<a?[5,w(N)]:[3,5];case 3:if("break"===C.sent())return[3,5];C.label=4;case 4:return++N,[3,2];case 5:return[4,b.onTrainEnd()];case 6:return C.sent(),[4,t.history.syncData()];case 7:return C.sent(),[2,t.history]}})})}(t,w,x,N,p,r.epochs,r.verbose,S,C,m,r.shuffle,E,r.initialEpoch,null,null)];case 6:return[2,k.sent()];case 7:return t.isTraining=!1,am(i,e),am(a,n),am(u,o),am(l,s),null!=c&&Me(c),[7];case 8:return[2]}})})}function im(t){var e=[];t instanceof ct&&(t=[t]);for(var n=0;n<t.length;++n){var r=t[n];if(1===r.rank)e.push(Hh(r,1));else{if(0===r.rank)throw new Error("Expected tensor to be at least 1D, but received a 0D tensor (scalar).");e.push(r)}}return e}function am(t,e){if(null!=t){var n=[];if(e instanceof ct)n.push(e.id);else if(Array.isArray(e))e.forEach(function(t){return n.push(t.id)});else if(null!=e)for(var r in e){var i=e[r];n.push(i.id)}var a=[];if(t instanceof ct)-1===n.indexOf(t.id)&&a.push(t);else if(Array.isArray(t))t.forEach(function(t){-1===n.indexOf(t.id)&&a.push(t)});else if(null!=t)for(var o in t){var s=t[o];-1===n.indexOf(s.id)&&a.push(s)}a.forEach(function(t){t.isDisposed||t.dispose()})}}function om(t){return Array.isArray(t)}function sm(t){return!function(t){return t instanceof ct}(t)&&!om(t)}function um(t,e,n,r,i){if(void 0===r&&(r=!0),void 0===i&&(i=""),null==e||0===e.length){if(null!=t){var a=!1;if(om(t)&&t.length>0)a=!0;else if(sm(t)){for(var o in t)if(t.hasOwnProperty(o)){a=!0;break}}else a=!0;if(a)throw new Kp("Error when checking model "+i+" expected no data, but got "+t)}return[]}if(null==t)return e.map(function(t){return null});var s;if(sm(t)){t=t,s=[];for(var u=0,l=e;u<l.length;u++){var c=l[u];if(null==t[c])throw new Kp('No data provided for "'+c+'". Need data for each key in: '+e);s.push(t[c])}}else if(om(t)){if((t=t).length!==e.length)throw new Kp("Error when checking model "+i+": the Array of Tensors that you are passing to your model is not the size the model expected. Expected to see "+e.length+" Tensor(s), but instead got the following list of Tensor(s): "+t);s=t}else{if(t=t,e.length>1)throw new Kp("The model "+i+" expects "+e.length+" Tensor(s), but only received one Tensor. Found: Tensor with shape "+t.shape);s=[t]}if(s=im(s),null!=n)for(var p=0;p<e.length;++p)if(null!=n[p]){var h=s[p];if(h.shape.length!==n[p].length)throw new Kp("Error when checking "+i+": expected "+e[p]+" to have "+n[p].length+" dimension(s). but got array with shape "+h.shape);for(var f=0;f<n[p].length;++f)if(0!==f||r){var d=h.shape[f],m=n[p][f];if(null!=m&&m>=0&&d!==m)throw new Kp("Error when checking "+i+": expected "+e[p]+" to have shape ["+n[p]+"], but got array with shape ["+h.shape+"].")}}return s}function lm(t,e,n,r,i){var a;if(void 0===r&&(r=!0),void 0===i&&(i=""),Array.isArray(t)){if(t.length!==e.length)throw new Kp("Error when checking model "+i+": the Array of Tensors that you are passing to your model is not the size the the model expected. Expected to see "+e.length+" Tensor(s), but instead got "+t.length+" Tensors(s).");a=t}else{if(e.length>1)throw new Kp("The model expects "+e.length+" "+i+" Tensors, but only received one Tensor. Found: array with shape "+JSON.stringify(t.shape)+".");a=[t]}if(null!=n)for(var o=0;o<e.length;++o)if(null!=n[o]){var s=a[o];if(s.shape.length!==n[o].length)throw new Kp("Error when checking "+i+": expected "+e[o]+" to have "+n[o].length+" dimension(s), but got array with shape "+JSON.stringify(s.shape));for(var u=0;u<n[o].length;++u)if(0!==u||r){var l=s.shape[u],c=n[o][u];if(null!=c&&c!==l)throw new Kp("Error when checking "+i+": expected "+e[o]+" to have shape "+JSON.stringify(n[o])+" but got array with shape "+JSON.stringify(s.shape)+".")}}}var cm=function(t){function e(e){var n=t.call(this,e)||this;return n.isTraining=!1,n}return Bp(e,t),e.prototype.summary=function(t,e,n){if(void 0===n&&(n=console.log),!this.built)throw new Kp("This model has never been called, thus its weights have not been created yet. So no summary can be displayed. Build the model first (e.g., by calling it on some test data).");_d(this,t,e,n)},e.prototype.compile=function(t){var e=this;if(null==t.loss&&(t.loss=[]),this.loss=t.loss,"string"==typeof t.optimizer)this.optimizer_=function(t){var e={Adagrad:function(){return Mp.adagrad(.01)},Adadelta:function(){return Mp.adadelta(1,.95,qp())},Adam:function(){return Mp.adam(.001,.9,.999,qp())},Adamax:function(){return Mp.adamax(.002,.9,.999,qp(),0)},RMSProp:function(){return Mp.rmsprop(.001,.9,0,qp())},SGD:function(){return Mp.sgd(.01)}};if(e.adagrad=e.Adagrad,e.adadelta=e.Adadelta,e.adam=e.Adam,e.adamax=e.Adamax,e.rmsprop=e.RMSProp,e.sgd=e.SGD,t in e)return e[t]();throw new Kp("Unknown Optimizer "+t)}(t.optimizer),this.isOptimizerOwned=!0;else{if(!(t.optimizer instanceof kp))throw new Kp("User-defined optimizer must be an instance of tf.Optimizer.");this.optimizer_=t.optimizer,this.isOptimizerOwned=!1}var n=[];if(Array.isArray(t.loss)||"string"==typeof t.loss||"function"==typeof t.loss)if(Array.isArray(t.loss)){if(t.loss.length!==this.outputs.length)throw new Kp("When passing an Array as loss, it should have one entry per model output. The model has "+this.outputs.length+" output(s), but you passed loss="+t.loss+".");var r=t.loss;n=r.map(function(t){return bd(t)})}else{var i=bd(t.loss);this.outputs.forEach(function(t){n.push(i)})}else{for(var a in t.loss=t.loss,t.loss)if(-1===this.outputNames.indexOf(a))throw new Kp('Unknown entry in loss dictionary: "'+a+'". Only expected the following keys: '+this.outputNames);for(var o=0,s=this.outputNames;o<s.length;o++){var u=s[o];null==t.loss[u]&&console.warn('Output "'+u+'" is missing from loss dictionary. We assume this was done on purpose, and we will not be expecting data to be passed to '+u+" during training"),n.push(bd(t.loss[u]))}}this.lossFunctions=n,this.feedOutputNames=[],this.feedOutputShapes=[],this.feedLossFns=[];for(var l=0;l<this.outputs.length;++l){var c=this.internalOutputShapes[l],p=this.outputNames[l];this.feedOutputNames.push(p),this.feedOutputShapes.push(c),this.feedLossFns.push(this.lossFunctions[l])}var h=[];this.metrics=t.metrics,this.metricsNames=["loss"],this.metricsTensors=[],_h("loss",function(){for(var t=0;t<e.outputs.length;++t)if(-1===h.indexOf(t)){var n=e.lossFunctions[t];e.outputs.length>1&&(e.metricsTensors.push([n,t]),e.metricsNames.push(e.outputNames[t]+"_loss"))}});var f=function(t,e){if(null==t||Array.isArray(t)&&0===t.length)return e.map(function(t){return[]});var n;if("string"==typeof t||"function"==typeof t)n=[t];else{if(!Array.isArray(t)&&"object"!=typeof t)throw new TypeError("Type of metrics argument not understood. Expected an string,function, Array, or Object, found: "+t);n=t}if(Array.isArray(n))return e.map(function(t){return n});for(var r=[],i=0,a=e;i<a.length;i++){var o=a[i],s=n.hasOwnProperty(o)?n[o]:[];Array.isArray(s)||(s=[s]),r.push(s)}return r}(t.metrics,this.outputNames);_h("metric",function(){for(var t=function(t){if(-1!==h.indexOf(t))return"continue";!function(n){for(var r,i,a,o=function(n){if("string"==typeof n&&-1!==["accuracy","acc","crossentropy","ce"].indexOf(n)){var o=e.internalOutputShapes[t];1===o[o.length-1]||e.lossFunctions[t]===gd?-1!==["accuracy","acc"].indexOf(n)?i=xd:-1!==["crossentropy","ce"].indexOf(n)&&(i=Sd):e.lossFunctions[t]===md?-1!==["accuracy","acc"].indexOf(n)?i=kd:-1!==["crossentropy","ce"].indexOf(n)&&(i=Ad):-1!==["accuracy","acc"].indexOf(n)?i=wd:-1!==["crossentropy","ce"].indexOf(n)&&(i=Id);var s=void 0;-1!==["accuracy","acc"].indexOf(n)?s="acc":-1!==["crossentropy","ce"].indexOf(n)&&(s="ce"),a=i,r=""+s}else{var u=function(t){if("string"==typeof t&&t in Rd)return Rd[t];if("string"!=typeof t&&null!=t)return t;throw new Kp("Unknown metric "+t)}(n);a=u,r=""+Td(n)}var l;_h(r,function(){l=a}),function(t,n,r){e.outputNames.length>1&&(n=e.outputNames[t]+"_"+n),e.metricsNames.push(n),e.metricsTensors.push([r,t])}(t,r,l)},s=0,u=f[t];s<u.length;s++)o(u[s])}()},n=0;n<e.outputs.length;++n)t(n)}),this.collectedTrainableWeights=this.trainableWeights},e.prototype.checkTrainableWeightsConsistency=function(){null!=this.collectedTrainableWeights&&this.trainableWeights.length!==this.collectedTrainableWeights.length&&console.warn("Discrepancy between trainableweights and collected trainable weights. Did you set `model.trainable` without calling `model.compile()` afterwards?")},e.prototype.evaluate=function(t,e,n){void 0===n&&(n={});var r=null==n.batchSize?32:n.batchSize;Qd(r);var i=this.standardizeUserDataXY(t,e,!0,r);try{var a=i[0].concat(i[1]);this.makeTestFunction();var o=this.testFunction;return Qp(this.testLoop(o,a,r,n.verbose,n.steps))}finally{am(i[0],t),am(i[1],e)}},e.prototype.evaluateDataset=function(t,e){return Up(this,void 0,void 0,function(){return jp(this,function(n){return this.makeTestFunction(),[2,function(t,e,n){return Up(this,void 0,void 0,function(){var r,i,a,o,s,u,l,c,p,h;return jp(this,function(f){switch(f.label){case 0:if(r=null!=(n=n||{}).batches,i=t.testFunction,a=[],n.verbose>0)throw new $p("Verbose mode is not implemented yet.");return J.assert(!r||n.batches>0&&Number.isInteger(n.batches),function(){return"Test loop expects `batches` to be a positive integer, but received "+JSON.stringify(n.batches)}),function(t){return"function"==typeof t.next}(e)?(s=e,[3,3]):[3,1];case 1:return[4,e.iterator()];case 2:s=f.sent(),f.label=3;case 3:o=s,u=0,l=0,c=function(){var e;return jp(this,function(s){switch(s.label){case 0:return[4,o.next()];case 1:return e=s.sent(),a=Fe(function(){if(e.value){var n=Xd(t,e.value),r=n.xs,o=n.ys,s=r.concat(o),c=Fe(function(){return i(s)});if(Me(s),0===l)for(var p=0;p<c.length;++p)a.push(on(0));var h=s[0].shape[0],f=function(t){var e=c[t],n=a[t];a[t]=Fe(function(){return Ls(a[t],Ys(h,e))}),l>0&&Me(n)};for(p=0;p<c.length;++p)f(p);Me(c),u+=h,++l}return a}),e.done?(r&&console.warn("Your dataset iterator ran out of data during evaluateDataset(). Interrupting evalution. Make sure that your dataset can generate at least `batches` batches (in this case, "+n.batches+" batches). You may need to use the repeat() function when building your dataset."),[2,"break"]):[2]}})},f.label=4;case 4:return!r||l<n.batches?[5,c()]:[3,6];case 5:return"break"===f.sent()?[3,6]:[3,4];case 6:for(p=0;p<a.length;++p)h=a[p],a[p]=Ws(a[p],u),Me(h);return[2,Qp(a)]}})})}(this,t,e)]})})},e.prototype.checkNumSamples=function(t,e,n,r){var i;if(void 0===r&&(r="steps"),null!=n){if(i=null,null!=e)throw new Kp("If "+r+" is set, batchSize must be null or undefined.Got batchSize = "+e)}else{if(null==t)throw new Kp("Either the input data should have a defined shape, or "+r+" shoud be specified.");i=Array.isArray(t)?t[0].shape[0]:t.shape[0]}return i},e.prototype.execute=function(t,e){if(Array.isArray(e)&&0===e.length)throw new Kp("`outputs` is an empty Array, which is not allowed.");var n=Array.isArray(e),r=n?e:[e],i=this.retrieveSymbolicTensors(r),a=new Bd;if(t instanceof ct&&(t=[t]),Array.isArray(t)){if(t.length!==this.inputs.length)throw new Kp("The number of inputs provided ("+t.length+") does not match the number of inputs of this model ("+this.inputs.length+").");for(var o=0;o<this.inputs.length;++o)a.add(this.inputs[o],t[o])}else for(var s=0,u=this.inputs;s<u.length;s++){var l=u[s],c=t[l.name];if(null==c)throw new Kp("No value is provided for the model's input "+l.name);a.add(l,c)}var p=Ud(i,a);return n?p:p[0]},e.prototype.retrieveSymbolicTensors=function(t){for(var e=Yp(null,t.length),n=t.length,r=0,i=this.layers;r<i.length;r++){for(var a=i[r],o=Array.isArray(a.output)?a.output:[a.output],s=o.map(function(t){return t.name}),u=0;u<t.length;++u){var l=s.indexOf(t[u]);if(-1!==l&&(e[u]=o[l],n--),0===n)break}if(0===n)break}if(n>0){var c=[];throw e.forEach(function(e,n){null==e&&c.push(t[n])}),new Kp("Cannot find SymbolicTensors for output name(s): "+JSON.stringify(c))}return e},e.prototype.predictLoop=function(t,e,n){var r=this;return void 0===e&&(e=32),void 0===n&&(n=!1),Fe(function(){var i=r.checkNumSamples(t);if(n)throw new $p("Verbose predictLoop() is not implemented yet.");for(var a=nm(i,e),o=r.outputs.map(function(t){return[]}),s=function(e){Fe(function(){var n=a[e][0],i=a[e][1],o=tm(t,n,i),s=[];if(Array.isArray(o))for(var u=0;u<o.length;++u)s.push({key:r.inputs[u],value:o[u]});else s.push({key:r.inputs[0],value:o});var l=new Bd(s);return Ud(r.outputs,l)}).forEach(function(t,e){return o[e].push(t)})},u=0;u<a.length;++u)s(u);return Qp(o.map(function(t){return xn(t,0)}))})},e.prototype.predict=function(t,e){void 0===e&&(e={});var n=im(t);lm(n,this.inputNames,this.feedInputShapes,!1);try{var r=null==e.batchSize?32:e.batchSize;return Qd(r),this.predictLoop(n,r)}finally{am(n,t)}},e.prototype.predictOnBatch=function(t){lm(t,this.inputNames,this.feedInputShapes,!0);var e=(Array.isArray(t)?t[0]:t).shape[0];return this.predictLoop(t,e)},e.prototype.standardizeUserDataXY=function(t,e,n,r){if(void 0===n&&(n=!0),null==this.optimizer_)throw new Gp("You must compile a model before training/testing. Use LayersModel.compile(modelCompileArgs).");for(var i=[],a=0;a<this.feedOutputShapes.length;++a){var o=this.feedOutputShapes[a];this.feedLossFns[a]===md?i.push(o.slice(0,o.length-1).concat([1])):i.push(o)}if(function(t,e,n){var r=sh(t.map(function(t){return t.shape[0]}));r.sort();var i=sh(e.map(function(t){return t.shape[0]}));if(i.sort(),r.length>1)throw new Kp("All input Tensors (x) should have the same number of samples. Got array shapes: "+JSON.stringify(t.map(function(t){return t.shape})));if(i.length>1)throw new Kp("All target Tensors (y) should have the same number of samples. Got array shapes: "+JSON.stringify(e.map(function(t){return t.shape})));if(r.length>0&&i.length>0&&!J.arraysEqual(r,i))throw new Kp("Input Tensors should have the same number of samples as target Tensors. Found "+r[0]+" input sample(s) and "+i[0]+" target sample(s).")}(t=um(t,this.feedInputNames,this.feedInputShapes,!1,"input"),e=um(e,this.feedOutputNames,i,!1,"target")),function(t,e,n){for(var r=[pd,gd,dd],i=0;i<t.length;++i){var a=t[i],o=e[i],s=n[i];if(null!=o){if(o===dd&&1===a.shape[a.shape.length-1])throw new Kp("You are passing a target array of shape "+a.shape+" while using a loss 'categorical_crossentropy'. 'categorical_crossentropy'expects targets to be binary matrices (1s and 0s) of shape [samples, classes].");if(-1!==r.indexOf(o))for(var u=a.shape.slice(1),l=s.slice(1),c=0;c<u.length;++c){var p=u[c],h=l[c];if(null!=h&&p!==h)throw new Kp("A target Tensor with shape "+a.shape+" was passed for an output of shape "+s+", while using a loss function that expects targets to have the same shape as the output.")}}}}(e,this.feedLossFns,this.feedOutputShapes),this.stateful&&null!=r&&r>0&&t[0].shape[0]%r!=0)throw new Kp("In a stateful network, you should only pass inputs with a number of samples that is divisible by the batch size "+r+". Found: "+t[0].shape[0]+" sample(s).");return[t,e]},e.prototype.standardizeUserData=function(t,e,n,r,i,a){return void 0===i&&(i=!0),Up(this,void 0,void 0,function(){var o,s,u,l,c,p,h,f;return jp(this,function(d){switch(d.label){case 0:if(o=this.standardizeUserDataXY(t,e,i,a),s=o[0],u=o[1],null!=n)throw new Error("sample weight is not supported yet.");if(l=null,null==r)return[3,4];c=Hd(r,this.outputNames),l=[],p=0,d.label=1;case 1:return p<c.length?(f=(h=l).push,[4,Gd(u[p],null,c[p])]):[3,4];case 2:f.apply(h,[d.sent()]),d.label=3;case 3:return++p,[3,1];case 4:return[2,[s,u,l]]}})})},e.prototype.testLoop=function(t,e,n,r,i){var a=this;return void 0===r&&(r=0),Fe(function(){var o=a.checkNumSamples(e,n,i,"steps"),s=[];if(r>0)throw new $p("Verbose mode is not implemented yet.");if(null!=i)throw new $p("steps mode in testLoop() is not implemented yet");for(var u=nm(o,n),l=sn(jh(0,o)),c=0;c<u.length;++c){var p=u[c][0],h=u[c][1],f=Gh(l,p,h-p),d=em(e,f),m=t(d);if(0===c)for(var g=0;g<m.length;++g)s.push(on(0));for(g=0;g<m.length;++g){var v=m[g];s[g]=Ls(s[g],Ys(h-p,v))}}for(g=0;g<s.length;++g)s[g]=Ws(s[g],o);return s})},e.prototype.getDedupedMetricsNames=function(){for(var t=this.metricsNames,e=[],n=0;n<t.length;++n){var r=t[n],i=r;Zp(t,r)>1&&(i+="_"+Zp(t.slice(0,n),r)),e.push(i)}return e},e.prototype.makeTrainFunction=function(){var t=this;return function(e){var n=[],r=e.slice(0,t.inputs.length),i=e.slice(t.inputs.length,t.inputs.length+t.outputs.length),a=e.slice(t.inputs.length+t.outputs.length,t.inputs.length+2*t.outputs.length),o=[],s=t.collectedTrainableWeights.map(function(t){return t.read()});return[t.optimizer_.minimize(function(){for(var e=[],s=0;s<t.inputs.length;++s)e.push({key:t.inputs[s],value:r[s]});var u,l=new Bd(e),c=Ud(t.outputs,l,{training:!0});for(s=0;s<t.lossFunctions.length;++s){var p=(0,t.lossFunctions[s])(i[s],c[s]);null!=a[s]&&(p=Kd(p,a[s]));var h=sl(p);n.push(h),u=0===s?p:Ls(u,p)}for(s=0;s<t.metricsTensors.length;++s){var f=void 0;if(t.outputs.length>1&&s<t.outputs.length)f=n[s];else{var d=t.metricsTensors[s][0],m=t.metricsTensors[s][1];f=sl(d(i[m],c[m]))}ze(f),o.push(f)}return u=sl(u),t.calculateLosses().forEach(function(t){u=Ls(u,t)}),u},!0,s)].concat(o)}},e.prototype.makeTestFunction=function(){var t=this;this.testFunction=function(e){return Fe(function(){for(var n,r=[],i=e.slice(0,t.inputs.length),a=e.slice(t.inputs.length,t.inputs.length+t.outputs.length),o=[],s=0;s<t.inputs.length;++s)o.push({key:t.inputs[s],value:i[s]});var u=new Bd(o),l=Ud(t.outputs,u);for(s=0;s<t.lossFunctions.length;++s){var c=t.lossFunctions[s],p=sl(c(a[s],l[s]));n=0===s?p:Ls(n,p),r.push(n)}for(s=0;s<t.metricsTensors.length;++s){var h=t.metricsTensors[s][0],f=t.metricsTensors[s][1],d=sl(h(a[f],l[f]));r.push(d)}return r})}},e.prototype.fit=function(t,e,n){return void 0===n&&(n={}),Up(this,void 0,void 0,function(){return jp(this,function(r){return[2,rm(this,t,e,n)]})})},e.prototype.fitDataset=function(t,e){return Up(this,void 0,void 0,function(){return jp(this,function(n){return[2,Jd(this,t,e)]})})},e.prototype.trainOnBatch=function(t,e){return Up(this,void 0,void 0,function(){var n,r,i,a,o,s,u,l,c;return jp(this,function(p){switch(p.label){case 0:return[4,this.standardizeUserData(t,e)];case 1:n=p.sent(),r=n[0],i=n[1],a=this.makeTrainFunction(),o=a(r.concat(i)),s=[],u=0,l=o,p.label=2;case 2:return u<l.length?[4,l[u].data()]:[3,5];case 3:c=p.sent(),s.push(c[0]),p.label=4;case 4:return u++,[3,2];case 5:return Me(o),[2,Qp(s)]}})})},e.prototype.getNamedWeights=function(t){for(var e=[],n=null!=t&&t.trainableOnly,r=n?this.trainableWeights:this.weights,i=this.getWeights(n),a=0;a<r.length;++a)n&&!r[a].trainable||e.push({name:r[a].originalName,tensor:i[a]});return e},Object.defineProperty(e.prototype,"stopTraining",{get:function(){return this.stopTraining_},set:function(t){this.stopTraining_=t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"optimizer",{get:function(){return this.optimizer_},set:function(t){this.optimizer_!==t&&(this.optimizer_=t,this.isOptimizerOwned=!1)},enumerable:!0,configurable:!0}),e.prototype.dispose=function(){var e=t.prototype.dispose.call(this);if(0===e.refCountAfterDispose&&null!=this.optimizer&&this.isOptimizerOwned){var n=_e().numTensors;this.optimizer_.dispose(),e.numDisposedVariables+=n-_e().numTensors}return e},e.prototype.getLossIdentifiers=function(){var t;if("string"==typeof this.loss)t=eh(this.loss);else if(Array.isArray(this.loss)){for(var e=0,n=this.loss;e<n.length;e++)if("string"!=typeof n[e])throw new Error("Serialization of non-string loss is not supported.");t=this.loss.map(function(t){return eh(t)})}else{var r=Object.keys(this.loss);t={};for(var i=this.loss,a=0,o=r;a<o.length;a++){var s=o[a];if("string"!=typeof i[s])throw new Error("Serialization of non-string loss is not supported.");t[s]=eh(i[s])}}return t},e.prototype.getMetricIdentifiers=function(){if("string"==typeof this.metrics||"function"==typeof this.metrics)return[eh(Td(this.metrics))];if(Array.isArray(this.metrics))return this.metrics.map(function(t){return eh(Td(t))});var t={};for(var e in this.metrics)t[e]=eh(Td(this.metrics[e]));return t},e.prototype.getTrainingConfig=function(){return{loss:this.getLossIdentifiers(),metrics:this.getMetricIdentifiers(),optimizer_config:{class_name:this.optimizer.getClassName(),config:this.optimizer.getConfig()}}},e.prototype.loadTrainingConfig=function(t){if(null!=t.weighted_metrics)throw new Error("Loading weight_metrics is not supported yet.");if(null!=t.loss_weights)throw new Error("Loading loss_weights is not supported yet.");if(null!=t.sample_weight_mode)throw new Error("Loading sample_weight_mode is not supported yet.");var e,n,r=ld(Pd(t.optimizer_config));if("string"==typeof t.loss)e=nh(t.loss);else if(Array.isArray(t.loss))e=t.loss.map(function(t){return nh(t)});else if(null!=t.loss)for(var i in e={},t.loss)e[i]=nh(t.loss[i]);if(Array.isArray(t.metrics))n=t.metrics.map(function(t){return nh(t)});else if(null!=t.metrics)for(var i in n={},t.metrics)n[i]=nh(t.metrics[i]);this.compile({loss:e,metrics:n,optimizer:r})},e.prototype.save=function(t,e){return Up(this,void 0,void 0,function(){var n,r,i,a,o,s,u,l,c,p,h,f,d,m;return jp(this,function(g){switch(g.label){case 0:if("string"==typeof t){if(0===(r=cp.getSaveHandlers(t)).length)throw new Kp("Cannot find any save handlers for URL '"+t+"'");if(r.length>1)throw new Kp("Found more than one ("+r.length+") save handlers for URL '"+t+"'");t=r[0]}if(null==t.save)throw new Kp("LayersModel.save() cannot proceed because the IOHandler provided does not have the `save` attribute defined.");return[4,cp.encodeWeights(this.getNamedWeights(e))];case 1:return i=g.sent(),a=!1,o=null,s=this.toJSON(o,a),u={modelTopology:s,format:"layers-model",generatedBy:"TensorFlow.js tfjs-layers v1.2.8",convertedBy:null},null!=e&&e.includeOptimizer&&null!=this.optimizer?(u.trainingConfig=this.getTrainingConfig(),l="optimizer",d=(f=cp).encodeWeights,[4,this.optimizer.getWeights()]):[3,4];case 2:return[4,d.apply(f,[g.sent(),l])];case 3:c=g.sent(),p=c.data,h=c.specs,(n=i.specs).push.apply(n,h),i.data=cp.concatenateArrayBuffers([i.data,p]),g.label=4;case 4:return null!=this.userDefinedMetadata&&(m=!0,Od(this.userDefinedMetadata,this.name,m),u.userDefinedMetadata=this.userDefinedMetadata),u.weightData=i.data,u.weightSpecs=i.specs,[2,t.save(u)]}})})},e.prototype.setUserDefinedMetadata=function(t){Od(t,this.name),this.userDefinedMetadata=t},e.prototype.getUserDefinedMetadata=function(){return this.userDefinedMetadata},e.className="Model",e}(function(t){function e(n){var r=t.call(this,{})||this;if(r.containerNodes=new Set,r.name=n.name,null==r.name){var i=r.getClassName().toLowerCase();r.name=_f(i)}if(r.supportsMasking=!1,r.trainable_=!0,Array.isArray(n.inputs)?r.inputs=n.inputs.slice():r.inputs=[n.inputs],Array.isArray(n.outputs)?r.outputs=n.outputs.slice():r.outputs=[n.outputs],sh(r.inputs).length!==r.inputs.length)throw new Kp("The list of inputs passed to the model is redundant. All inputs should only appear once. Found: "+r.inputs.map(function(t){return t.name}));sh(r.outputs).length!==r.outputs.length&&console.warn("The list of outputs passed to the model is redundant. All outputs should only appear once. Found: "+r.outputs.map(function(t){return t.name})),r.inputLayers=[],r.inputLayersNodeIndices=[],r.inputLayersTensorIndices=[],r.outputLayers=[],r.outputLayersNodeIndices=[],r.outputLayersTensorIndices=[],r.layers=[];for(var a=0,o=r.outputs;a<o.length;a++){var s=(k=o[a]).sourceLayer,u=k.nodeIndex,l=k.tensorIndex;r.outputLayers.push(s),r.outputLayersNodeIndices.push(u),r.outputLayersTensorIndices.push(l)}for(var c=0,p=r.inputs;c<p.length;c++)s=(k=p[c]).sourceLayer,u=k.nodeIndex,l=k.tensorIndex,Jp(0===u,"input layer has >1 nodes"),Jp(0===l,"input layer has >1 tensors"),r.inputLayers.push(s),r.inputLayersNodeIndices.push(u),r.inputLayersTensorIndices.push(l);r.inputNames=[],r.outputNames=[],r.feedInputShapes=[],r.feedInputNames=[],r.feedOutputNames=[];for(var h=0;h<r.inputLayers.length;h++){if(!((s=r.inputLayers[h])instanceof Yf))throw new TypeError("Input layers to a LayersModel must be InputLayer objects. Received inputs: "+n.inputs+". Input "+h+" (0-based) originates from layer type "+s.getClassName()+".");r.inputNames.push(s.name),r.feedInputShapes.push(s.batchInputShape),r.feedInputNames.push(s.name)}for(var f=0,d=r.outputLayers;f<d.length;f++)s=d[f],r.outputNames.push(s.name);r.internalInputShapes=r.inputs.map(function(t){return t.shape}),r.internalOutputShapes=r.outputs.map(function(t){return t.shape});for(var m={},g={},v={},y={},b={},x=[],w=function(t,n,i,a,o,s){null!=a&&null!=o&&null!=s||(a=t.sourceLayer,o=t.nodeIndex,s=t.tensorIndex);var u=a.inboundNodes[o];if(-1!==i.indexOf(u))throw new Gp("The tensor "+t.name+' at layer "'+a.name+'" is part of a cycle.');if(-1===n.indexOf(u)){r.containerNodes.add(e.nodeKey(a,o)),a.id in b||(b[a.id]=Object.keys(b).length),-1===i.indexOf(u)&&i.push(u);for(var l=u.inboundLayers.length,c=0;c<l;c++){var p=u.inputTensors[c],h=u.inboundLayers[c],f=u.nodeIndices[c],d=u.tensorIndices[c];w(p,n,i,h,f,d)}for(n.push(u);i.indexOf(u)>=0;)i.splice(i.indexOf(u),1);x.push(u)}},N=[],C=[],E=0,S=r.outputs;E<S.length;E++){var k=S[E];w(k,N,C)}for(var I=0,A=x.slice().reverse();I<A.length;I++){g[(Y=A[I]).id]=Y,Y.id in m||(m[Y.id]=0);var R=m[Y.id],T=null==v[Y.outboundLayer.id]?0:v[Y.outboundLayer.id];for(R=Math.max(R,T),v[Y.outboundLayer.id]=R,y[Y.outboundLayer.id]=Y.outboundLayer,m[Y.id]=R,h=0;h<Y.inboundLayers.length;h++){var D=Y.inboundLayers[h],O=(u=Y.nodeIndices[h],D.inboundNodes[u]),_=null==m[O.id]?0:m[O.id];m[O.id]=Math.max(R+1,_),g[O.id]=O}}var F={};for(var M in m)(R=m[M])in F||(F[R]=[]),F[R].push(g[M]);var z={};for(var L in v)(R=v[L])in z||(z[R]=[]),z[R].push(y[L]);var P=Object.keys(z).map(function(t){return parseInt(t,10)}).sort(oh);r.layers=[];for(var B=0,V=P;B<V.length;B++){var W=z[R=V[B]];W.sort(function(t,e){var n=b[t.id],r=b[e.id];return n<r?-1:n>r?1:0});for(var U=0,j=W;U<j.length;U++)s=j[U],r.layers.push(s)}r.layersByDepth=z,P=Object.keys(F).map(function(t){return parseInt(t,10)}).sort(oh);for(var q=r.inputs.slice(),H=[],G=0,K=P;G<K.length;G++)for(var $=0,X=F[R=K[G]];$<X.length;$++){var Y;if(null!=(s=(Y=X[$]).outboundLayer)){for(var J=0,Z=Y.inputTensors;J<Z.length;J++)if(k=Z[J],-1===q.indexOf(k))throw new Gp("Graph disconnected: cannot obtain value for tensor "+k+' at layer "'+s.name+'". The following previous layers were accessed without issue: '+H);for(var Q=0,tt=Y.outputTensors;Q<tt.length;Q++)k=tt[Q],q.push(k);H.push(s.name)}}r.nodesByDepth=F;for(var et=r.layers.map(function(t){return t.name}),nt=function(t){var e=et.filter(function(e){return e===t}).length;if(1!==e)throw new Gp('The name "'+t+'" is used '+e+" times in the model. All layer names should be unique. Layer names: "+JSON.stringify(et))},rt=0,it=et;rt<it.length;rt++)nt(it[rt]);return r.outboundNodes=[],r.inboundNodes=[],new Gf({outboundLayer:r,inboundLayers:[],nodeIndices:[],tensorIndices:[],inputTensors:r.inputs,outputTensors:r.outputs,inputMasks:r.inputs.map(function(t){return null}),outputMasks:r.outputs.map(function(t){return null}),inputShapes:r.inputs.map(function(t){return t.shape}),outputShapes:r.outputs.map(function(t){return t.shape})}),r.built=!0,r._refCount=1,r}return Bp(e,t),e.prototype.assertNotDisposed=function(){if(0===this._refCount)throw new Error("Container '"+this.name+"' is already disposed.")},e.prototype.dispose=function(){this.assertNotDisposed();var t={refCountAfterDispose:null,numDisposedVariables:0};if(0==--this._refCount)for(var e=0,n=this.layers;e<n.length;e++){var r=n[e];t.numDisposedVariables+=r.dispose().numDisposedVariables}return t.refCountAfterDispose=this._refCount,t},Object.defineProperty(e.prototype,"trainable",{get:function(){return this.trainable_},set:function(t){this.layers.forEach(function(e){e._trainableWeights.forEach(function(e){return e.trainable=t})}),this.trainable_=t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"trainableWeights",{get:function(){if(this._trainableWeights.length>0)throw new Kp("Container instance unexpectedly contains _trainableWeights.The trainable weights of a Container are a union of the trainable weights of its consituent Layers. Its own _trainableWeights must remain an empty Array.");if(!this.trainable)return[];for(var t=[],e=0,n=this.layers;e<n.length;e++){var r=n[e];t=t.concat(r.trainableWeights)}return t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"nonTrainableWeights",{get:function(){for(var t=[],e=0,n=this.layers;e<n.length;e++){var r=n[e];t.push.apply(t,r.nonTrainableWeights)}if(!this.trainable){for(var i=[],a=0,o=this.layers;a<o.length;a++)r=o[a],i.push.apply(i,r.trainableWeights);return i.concat(t)}return t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"weights",{get:function(){return this.trainableWeights.concat(this.nonTrainableWeights)},enumerable:!0,configurable:!0}),e.prototype.loadWeights=function(t,e){void 0===e&&(e=!0);for(var n={},r=0,i=0,a=this.layers;i<a.length;i++)for(var o=0,s=a[i].weights;o<s.length;o++){var u=s[o];if(null!=n[u.originalName])throw new Kp("Duplicate weight name: "+u.originalName);n[u.originalName]=u,r++}var l=[];for(var c in t){if(null!=n[c])l.push([n[c],t[c]]);else if(e)throw new Kp("Provided weight data has no target variable: "+c);delete n[c]}if(e){var p=[];for(var h in n)p.push(h);if(p.length>0)throw new Kp(p.length+" of "+r+" weights are not set: "+p)}Uf(l)},e.prototype.updatedConfig=function(){var t=this.getConfig(),e={};return e.className=this.getClassName(),e.config=t,e.kerasVersion="tfjs-layers 1.2.8",e.backend="TensorFlow.js",e},e.prototype.toJSON=function(t,e){void 0===e&&(e=!0);var n=function t(e,n){if(null===e||void 0===e)return null;if("string"==typeof e)return eh(e);if("number"==typeof e||"boolean"==typeof e)return e;if(e instanceof Array){for(var r=[],i=e.length,a=0;a<i;++a){var o=e[a];Ld(n,a,o)?r.push(o):r.push(t(o,n))}return r}for(var s={},u=0,l=Object.keys(e);u<l.length;u++){var c=l[u],p=e[c];s[eh(c)]="name"!==c&&"className"!==c||"string"!=typeof p?t(p,c):p}return s}(this.updatedConfig());return e?JSON.stringify(n):n},e.prototype.call=function(t,e){var n=this;return Fe(function(){t=th(t);for(var r=new Bd,i=0;i<n.inputs.length;++i)r.add(n.inputs[i],t[i]);return Ud(n.outputs,r,e)})},e.prototype.computeMask=function(t,e){var n=this;return Fe(function(){var r;return t=th(t),r=null==e?Yp(null,t.length):th(e),n.runInternalGraph(t,r)[1]})},e.prototype.computeOutputShape=function(t){var e=Mf(t);if(e.length!==this.inputLayers.length)throw new Kp("Invalid inputShape argument "+t+": model has "+this.inputLayers.length+" tensor inputs.");for(var n={},r=0;r<e.length;r++){var i=this.inputLayers[r],a=e[r];n[C=i.name+"_0_0"]=a}var o=Object.keys(this.nodesByDepth).map(function(t){return parseInt(t,10)}).sort(oh);if(o.length>1)for(var s=0,u=o;s<u.length;s++)for(var l=u[s],c=0,p=this.nodesByDepth[l];c<p.length;c++){var h=p[c];if(i=h.outboundLayer,-1===this.inputLayers.map(function(t){return t.id}).indexOf(i.id)){for(var f=[],d=0;d<h.inboundLayers.length;d++){var m=h.inboundLayers[d],g=h.nodeIndices[d],v=h.tensorIndices[d],y=n[C=m.name+"_"+g+"_"+v];f.push(y)}var b=Mf(i.computeOutputShape(Qp(f))),x=i.inboundNodes.indexOf(h);for(d=0;d<b.length;d++)n[C=i.name+"_"+x+"_"+d]=b[d]}}var w=[],N=[];for(r=0;r<this.outputLayers.length;r++){i=this.outputLayers[r],x=this.outputLayersNodeIndices[r],v=this.outputLayersTensorIndices[r];var C=i.name+"_"+x+"_"+v;N.push(C)}for(r=0;r<N.length;r++){var E=N[r];Jp(E in n),w.push(n[E])}return Qp(w)},e.prototype.runInternalGraph=function(t,e){null==e&&(e=Yp(null,t.length));for(var n={},r=0;r<this.inputs.length;++r){var i=this.inputs[r],a=t[r],o=e[r];n[i.id]=[a,o]}for(var s=0,u=Object.keys(this.nodesByDepth).map(function(t){return parseInt(t,10)}).sort(oh);s<u.length;s++)for(var l=u[s],c=0,p=this.nodesByDepth[l];c<p.length;c++){for(var h=p[c],f=h.outboundLayer,d=h.inputTensors,m=h.outputTensors,g=new Array,v=0,y=d;v<y.length;v++)(i=y[v]).id in n&&g.push(n[i.id]);if(g.length===d.length){var b={},x=void 0,w=void 0,N=void 0,C=void 0;if(null!=h.callArgs&&(b=h.callArgs),1===g.length){var E=g[0],S=E[0],k=E[1];null==b.mask&&(b.mask=k),N=th(f.call(S,b)),C=th(f.computeMask(S,k)),x=[S],w=[k]}else x=g.map(function(t){return t[0]}),w=g.map(function(t){return t[1]}),null==b.mask&&(b.mask=w),N=th(f.call(x,b)),C=th(f.computeMask(x,w));if(f.activityRegularizer)throw new $p("LayersModel invocation with concrete Tensor value(s) in the presence of activity regularizer(s) is not supported yet.");for(r=0;r<m.length;++r)i=m[r],a=N[r],o=C[r],n[i.id]=[a,o]}}for(var I=[],A=[],R=[],T=0,D=this.outputs;T<D.length;T++){Jp((i=D[T]).id in n,"Could not compute output "+i.name+" : "+i.id);var O=n[i.id],_=O[0];o=O[1],R.push(_.shape),I.push(_),A.push(o)}return[I,A,R]},e.prototype.buildNodeConversionMap=function(t){for(var n,r={},i=0,a=this.layers;i<a.length;i++){var o=a[i];n=o instanceof e?1:0;for(var s=0;s<o.inboundNodes.length;s++){var u=e.nodeKey(o,s);this.containerNodes.has(u)&&(r[u]=n,n+=1)}}return r},e.prototype.getLayer=function(t,e){if(null!=e){if(this.layers.length<=e)throw new Kp("Was asked to retrieve layer at index "+e+", but model only has "+this.layers.length+" layer(s).");return this.layers[e]}if(null==t)throw new Kp("Provide either a layer name or layer index");for(var n=0,r=this.layers;n<r.length;n++){var i=r[n];if(i.name===t)return i}throw new Kp("No such layer: "+t)},e.prototype.calculateLosses=function(){var t=this;return Fe(function(){for(var n=[],r=0,i=t.layers;r<i.length;r++)for(var a=i[r],o=0;o<a.inboundNodes.length;++o){var s=e.nodeKey(a,o);t.containerNodes.has(s)&&n.push.apply(n,a.calculateLosses())}return n})},e.prototype.getConfig=function(){for(var t={name:this.name},n=this.buildNodeConversionMap(this.layers),r=[],i=0,a=this.layers;i<a.length;i++){for(var o=(x=a[i]).getClassName(),s=x.getConfig(),u=[],l=0;l<x.inboundNodes.length;l++){var c=x.inboundNodes[l],p=e.nodeKey(x,l),h={};if(this.containerNodes.has(p)){if(c.callArgs)try{JSON.stringify(c.callArgs),h=c.callArgs}catch(t){console.warn("Layer "+x.name+" was passed non-serializable keyword arguments: "+c.callArgs+". They will not be included in the serialized model (and thus will be missing at deserialization time)."),h={}}if(c.inboundLayers.length>0){for(var f=[],d=0;d<c.inboundLayers.length;d++){var m=c.inboundLayers[d],g=c.nodeIndices[d],v=c.tensorIndices[d];null==(N=n[e.nodeKey(m,g)])&&(N=0),f.push([m.name,N,v,h])}u.push(f)}}}var y={};y.name=x.name,y.className=o,y.config=s,y.inboundNodes=u,r.push(y)}t.layers=r;var b=[];for(d=0;d<this.inputLayers.length;d++){var x=this.inputLayers[d];g=this.inputLayersNodeIndices[d],p=e.nodeKey(x,g),this.containerNodes.has(p)&&(null!==(N=n[p])&&void 0!==N||(N=0),v=this.inputLayersTensorIndices[d],b.push([x.name,N,v]))}t.inputLayers=b;var w=[];for(d=0;d<this.outputLayers.length;d++){var N;if(x=this.outputLayers[d],g=this.outputLayersNodeIndices[d],p=e.nodeKey(x,g),this.containerNodes.has(p))null!==(N=n[p])&&void 0!==N||(N=0),v=this.outputLayersTensorIndices[d],w.push([x.name,N,v])}return t.outputLayers=w,t},e.fromConfig=function(t,e,n,r){void 0===n&&(n={}),void 0===r&&(r=!1);var i={},a={};function o(t,e){t.name in a?a[t.name].push(e):a[t.name]=[e]}function s(t,e){for(var n,r=[],a=0,s=e;a<s.length;a++){var u=s[a],l=u[0],c=u[1],p=u[2];if(n=null==u[3]?{}:u[3],!(l in i))return void o(t,e);var h=i[l];if(h.inboundNodes.length<=c)return void o(t,e);var f=h.inboundNodes[c];r.push(f.outputTensors[p])}r.length>0&&t.apply(Qp(r),n)}function u(t){var n=t.name,a=ld(t,null!=e.customObjects?e.customObjects:{});a.setFastWeightInitDuringBuild(r),i[n]=a,t.inboundNodes.forEach(function(t){if(!(t instanceof Array))throw new Kp("Corrupted configuration, expected array for nodeData: "+t);o(a,t)})}for(var l=e.name,c=e.layers,p=0,h=c;p<h.length;p++)u(m=h[p]);for(;!uh(a);)for(var f=0,d=c;f<d.length;f++){var m=d[f];if((R=i[m.name]).name in a){var g=a[R.name];delete a[R.name];for(var v=0,y=g;v<y.length;v++)s(R,y[v])}}for(var b=[],x=[],w=0,N=e.inputLayers;w<N.length;w++){var C=(m=N[w])[0],E=m[1],S=m[2];Jp(C in i);var k=(R=i[C]).inboundNodes[E].outputTensors;b.push(k[S])}for(var I=0,A=e.outputLayers;I<A.length;I++){var R;C=(m=A[I])[0],E=m[1],S=m[2],Jp(C in i),k=(R=i[C]).inboundNodes[E].outputTensors,x.push(k[S])}return new t({inputs:b,outputs:x,name:l})},Object.defineProperty(e.prototype,"stateful",{get:function(){if(this._stateful)throw new Kp("Container instance unexpectedly has _stateful = true. The statefulness of a Container is determined by the Layers it contains. Its _stateful property must remain the default false.");for(var t=0,e=this.layers;t<e.length;t++)if(e[t].stateful)return!0;return!1},enumerable:!0,configurable:!0}),e.prototype.resetStates=function(){var t=this;Fe(function(){t.layers.forEach(function(t){t.stateful&&t.resetStates()})})},e}($f));function pm(t,e){return Up(this,void 0,void 0,function(){var n;return jp(this,function(r){if(null==e&&(e={}),"string"==typeof t){if(0===(n=cp.getLoadHandlers(t,e.onProgress)).length)n.push(cp.browserHTTPRequest(t,e));else if(n.length>1)throw new Kp("Found more than one ("+n.length+") load handlers for URL '"+t+"'");t=n[0]}return[2,function(t,e,n){return Up(this,void 0,void 0,function(){var r,i,a,o,s,u,l,c,p;return jp(this,function(h){switch(h.label){case 0:if(null==n&&(n={}),null==t.load)throw new Kp("Cannot proceed with model loading because the IOHandler provided does not have the `load` method implemented.");return[4,t.load()];case 1:if(r=h.sent(),null!=(i=r.modelTopology).model_config&&(i=i.model_config),a=null==n.strict||n.strict,o=null!=r.weightData&&null!=r.weightSpecs&&a,s=ld(Pd(i),e,o),null!=(u=r.trainingConfig)&&s.loadTrainingConfig(u),null!=r.userDefinedMetadata&&s.setUserDefinedMetadata(r.userDefinedMetadata),null==r.weightData)return[3,4];if(null==r.weightSpecs)throw new Kp("LayersModel artifacts contains weight data, but not weight specs. Therefore loading of weights cannot proceed.");return l=function(t,e){var n=cp.decodeWeights(t,e),r={},i=[];return e.forEach(function(t){"optimizer"===t.group?i.push({name:t.name,tensor:n[t.name]}):r[t.name]=n[t.name]}),{modelWeights:r,optimizerWeights:i}}(r.weightData,r.weightSpecs),c=l.modelWeights,p=l.optimizerWeights,s.loadWeights(c,a),null!=s.optimizer&&p.length>0?[4,s.optimizer.setWeights(p)]:[3,3];case 2:h.sent(),h.label=3;case 3:Me(c),Me(p.map(function(t){return t.tensor})),h.label=4;case 4:return[2,s]}})})}(t,void 0,e)]})})}yp.registerClass(cm);var hm=function(t){function e(e){var n=t.call(this,{inputs:[],outputs:[]})||this;if(e=e||{},n.trainable=!0,n.built=!1,n.name=null!=e.name?e.name:_f("sequential_"),null!=e.layers)for(var r=0,i=e.layers;r<i.length;r++){var a=i[r];n.add(a)}return n}return Bp(e,t),e.prototype.checkShape=function(t){if(t.inboundNodes[0].outputTensors[0].shape.some(function(t){return t<0}))throw new Kp("Negative dimension size caused by adding layer "+t.name+" with input shape ["+t.inboundNodes[0].inputTensors[0].shape+"]")},e.prototype.add=function(t){var n,r=t instanceof e||t instanceof cm;if(r){if(1!==(n=t).outputs.length)throw new Kp("All layers in a Sequential model should have a single output tensor. For multi-output layers, use the functional API.");if(1!==n.inputs.length)throw new Kp("All layers in a Sequential model should have a single input tensor. For multi-input layers, use the functional API.")}if(0===this.outputs.length){if(0===t.inboundNodes.length){if(null==t.batchInputShape)throw new Kp("The first layer in a Sequential model must get an `inputShape` or `batchInputShape` argument.");var i=Jf({batchShape:t.batchInputShape,dtype:t.dtype,name:t.name+"_input"});t.apply(i)}if(r)this.outputs=n.outputs,this.inputs=n.inputs;else{if(1!==t.inboundNodes.length)throw new Kp("A layer added to a Sequential model must not already be connected somewhere else. LayersModel received layer "+t.name+" which has "+t.inboundNodes.length+" pre-existing inbound connections.");if(1!==t.inboundNodes[0].outputTensors.length)throw new Kp("All layers in a Sequential model should have a single output tensor. For multi-output layers, use the functional API.");this.checkShape(t),this.outputs=[t.inboundNodes[0].outputTensors[0]],this.inputs=function t(e,n,r){if((null==n||null!=r&&r>0)&&(n=e.sourceLayer,r=e.nodeIndex),0===n.inboundNodes.length)return[e];var i=n.inboundNodes[r];if(0===i.inboundLayers.length)return i.inputTensors;for(var a=[],o=0;o<i.inboundLayers.length;o++)for(var s=0,u=t(i.inputTensors[o],i.inboundLayers[o],i.nodeIndices[o]);s<u.length;s++){var l=u[s];-1===a.indexOf(l)&&a.push(l)}return a}(this.outputs[0])}this.inboundNodes=[],new Gf({outboundLayer:this,inboundLayers:[],nodeIndices:[],tensorIndices:[],inputTensors:this.inputs,outputTensors:this.outputs,inputMasks:Yp(null,this.inputs.length),outputMasks:[null],inputShapes:this.inputs.map(function(t){return t.shape}),outputShapes:this.outputs[0].shape})}else{var a=t.apply(this.outputs[0]);if(Array.isArray(a))throw new TypeError("All layers in a Sequential model should have a single output tensor. For multi-output layers, use the functional API.");this.checkShape(t),this.outputs=[a],this.inboundNodes[0].outputTensors=this.outputs,this.inboundNodes[0].outputShapes=[this.outputs[0].shape]}this.layers.push(t),this.built=!1},e.prototype.pop=function(){if(0===this.layers.length)throw new TypeError("There are no layers in the model.");if(this.layers.pop(),0===this.layers.length)this.outputs=[],this.inboundNodes=[],this.outboundNodes=[];else{var t=this.layers.length-1;this.layers[t].outboundNodes=[],this.outputs=[this.layers[t].output],this.inboundNodes[0].outputTensors=this.outputs,this.inboundNodes[0].outputShapes=[this.outputs[0].shape]}},e.prototype.call=function(t,e){return null==this.model&&this.build(),this.model.call(t,e)},e.prototype.build=function(t){if(Lf(t),0===this.inputs.length||0===this.outputs.length)throw new TypeError("Sequential model cannot be built: model is empty. Add some layers first.");this.model=new cm({inputs:this.inputs,outputs:this.outputs[0],name:this.name+"_model"}),this.model.trainable=this.trainable,this.supportsMasking=this.model.supportsMasking,this.inputLayers=this.model.inputLayers,this.inputLayersNodeIndices=this.model.inputLayersNodeIndices,this.inputLayersTensorIndices=this.model.inputLayersTensorIndices,this.outputLayers=this.model.outputLayers,this.outputLayersNodeIndices=this.model.outputLayersNodeIndices,this.outputLayersTensorIndices=this.model.outputLayersTensorIndices,this.nodesByDepth=this.model.nodesByDepth,this.containerNodes=this.model.containerNodes,this.outputNames=this.model.outputNames,this.inputNames=this.model.inputNames,this.built=!0},e.prototype.countParams=function(){return this.built||this.build(),t.prototype.countParams.call(this)},e.prototype.summary=function(e,n,r){void 0===r&&(r=console.log),this.built||this.build(),t.prototype.summary.call(this,e,n,r)},e.prototype.setWeights=function(t){null==this.model&&this.build(),this.model.setWeights(t)},e.prototype.evaluate=function(t,e,n){if(void 0===n&&(n={}),!this.built)throw new Gp("The model needs to be compiled before being used.");return this.model.evaluate(t,e,n)},e.prototype.evaluateDataset=function(t,e){return Up(this,void 0,void 0,function(){return jp(this,function(n){if(!this.built)throw new Gp("The model needs to be compiled before being used.");return[2,this.model.evaluateDataset(t,e)]})})},e.prototype.predict=function(t,e){return void 0===e&&(e={}),null==this.model&&this.build(),this.model.predict(t,e)},e.prototype.predictOnBatch=function(t){return null==this.model&&this.build(),this.model.predictOnBatch(t)},e.prototype.compile=function(t){this.build(),this.model.compile(t),this.optimizer_=this.model.optimizer,this.isOptimizerOwned=this.model.isOptimizerOwned,this.loss=this.model.loss,this.metrics=this.model.metrics,this.metricsTensors=this.model.metricsTensors,this.metricsNames=this.model.metricsNames},Object.defineProperty(e.prototype,"optimizer",{get:function(){return null==this.model?void 0:this.model.optimizer},set:function(t){this.model.optimizer=t},enumerable:!0,configurable:!0}),e.prototype.fit=function(t,e,n){return void 0===n&&(n={}),Up(this,void 0,void 0,function(){return jp(this,function(r){if(!this.built)throw new Gp("The model needs to be compiled before being used.");return[2,this.model.fit(t,e,n)]})})},e.prototype.fitDataset=function(t,e){return Up(this,void 0,void 0,function(){return jp(this,function(n){if(!this.built)throw new Gp("The model needs to be compiled before being used.");return[2,this.model.fitDataset(t,e)]})})},e.prototype.trainOnBatch=function(t,e){return Up(this,void 0,void 0,function(){return jp(this,function(n){return[2,this.model.trainOnBatch(t,e)]})})},e.fromConfig=function(t,n,r,i){var a;void 0===r&&(r={}),void 0===i&&(i=!1);var o={};if(n instanceof Array){if(null==n[0].className||"Merge"===n[0].className)throw new Kp("Legacy serialization format not supported yet.");a=n}else J.assert(null!=n.layers,function(){return"When the config data for a Sequential model is not an Array, it must be an Object that contains the 'layers' field."}),a=n.layers,delete n.layers,o=n;var s=new t(o);if(!(s instanceof e))throw new $p("Sequential.fromConfig called on non-Sequential input: "+s);for(var u=0,l=a;u<l.length;u++){var c=ld(l[u],void 0,i);i&&c.setFastWeightInitDuringBuild(!0),s.add(c)}return s},Object.defineProperty(e.prototype,"stopTraining",{get:function(){if(null==this.model)throw new Kp("Cannot get the stopTraining property of a sequential model before it is compiled.");return this.model.stopTraining},set:function(t){if(null==this.model)throw new Kp("Cannot set the stopTraining property of a sequential model before it is compiled.");this.model.stopTraining=t},enumerable:!0,configurable:!0}),e.prototype.getConfig=function(){for(var t=[],e=0,n=this.layers;e<n.length;e++){var r=n[e],i={};i.className=r.getClassName(),i.config=r.getConfig(),t.push(i)}return t},e.className="Sequential",e}(cm);function fm(t){return Jf(t)}yp.registerClass(hm);var dm=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return Bp(e,t),e.prototype.getConfig=function(){return{}},e}(yp.Serializable),mm=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return Bp(e,t),e.prototype.apply=function(t,e){return void 0===e&&(e=1),function(t,e){if(void 0===e&&(e=1),1!==e)throw new $p("Support for alpha values other than 1 ("+e+") is not implemented yet.");return hl(t)}(t,e)},e.className="elu",e}(dm);yp.registerClass(mm);var gm=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return Bp(e,t),e.prototype.apply=function(t){return gl(t)},e.className="selu",e}(dm);yp.registerClass(gm);var vm=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return Bp(e,t),e.prototype.apply=function(t){return ml(t)},e.className="relu",e}(dm);yp.registerClass(vm);var ym=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return Bp(e,t),e.prototype.apply=function(t){return Fe(function(){return Gs(6,ml(t))})},e.className="relu6",e}(dm);yp.registerClass(ym);var bm=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return Bp(e,t),e.prototype.apply=function(t){return t},e.className="linear",e}(dm);yp.registerClass(bm);var xm=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return Bp(e,t),e.prototype.apply=function(t){return is(t)},e.className="sigmoid",e}(dm);yp.registerClass(xm);var wm=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return Bp(e,t),e.prototype.apply=function(t){return function(t){return Fe(function(){var e=Ls(.5,Ys(.2,t));return qo(e,0,1)})}(t)},e.className="hardSigmoid",e}(dm);yp.registerClass(wm);var Nm=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return Bp(e,t),e.prototype.apply=function(t){return ps(t)},e.className="softplus",e}(dm);yp.registerClass(Nm);var Cm=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return Bp(e,t),e.prototype.apply=function(t){return function(t){return Fe(function(){return Ws(t,zo(t).add(1))})}(t)},e.className="softsign",e}(dm);yp.registerClass(Cm);var Em=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return Bp(e,t),e.prototype.apply=function(t){return gs(t)},e.className="tanh",e}(dm);yp.registerClass(Em);var Sm=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return Bp(e,t),e.prototype.apply=function(t,e){return void 0===e&&(e=-1),Rr(t,e)},e.className="softmax",e}(dm);yp.registerClass(Sm);var km=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return Bp(e,t),e.prototype.apply=function(t,e){return void 0===e&&(e=-1),Tr(t,e)},e.className="logSoftmax",e}(dm);function Im(t){return t.getClassName()}function Am(t,e){return void 0===e&&(e={}),ah(t,yp.SerializationMap.getMap().classNameMap,e,"activation")}function Rm(t){var e;return null==t?Am(e={className:"linear",config:{}}):"string"==typeof t?((e={}).className=t,e.config={},Am(e)):t instanceof dm?t:Am(t)}function Tm(t){if(null!=t&&"object"!=typeof t)throw new Error("Argument to L1L2 regularizer's constructor is expected to be an object, but received: "+t)}yp.registerClass(km);var Dm=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return Bp(e,t),e}(yp.Serializable),Om=function(t){function e(e){var n=t.call(this)||this;return Tm(e),n.l1=null==e||null==e.l1?.01:e.l1,n.l2=null==e||null==e.l2?.01:e.l2,n.hasL1=0!==n.l1,n.hasL2=0!==n.l2,n}return Bp(e,t),e.prototype.apply=function(t){var e=this;return Fe(function(){var n=dn([1]);return e.hasL1&&(n=Ls(n,cl(Ys(e.l1,zo(t))))),e.hasL2&&(n=Ls(n,cl(Ys(e.l2,ef(t))))),n.asScalar()})},e.prototype.getConfig=function(){return{l1:this.l1,l2:this.l2}},e.fromConfig=function(t,e){return new t({l1:e.l1,l2:e.l2})},e.className="L1L2",e}(Dm);yp.registerClass(Om);var _m={l1l2:"L1L2"};function Fm(t){return ih(t)}function Mm(t,e){return void 0===e&&(e={}),ah(t,yp.SerializationMap.getMap().classNameMap,e,"regularizer")}function zm(t){return null==t?null:"string"==typeof t?Mm({className:t in _m?_m[t]:t,config:{}}):t instanceof Dm?t:Mm(t)}var Lm=function(t){function e(e){var n=t.call(this,null==e?{}:e)||this;return n.supportsMasking=!0,null!=e&&(n.maxValue=e.maxValue),n}return Bp(e,t),e.prototype.call=function(t,e){t=zf(t);var n=ml(t);return null!=this.maxValue&&(n=qo(n,0,this.maxValue)),n},e.prototype.computeOutputShape=function(t){return t},e.prototype.getConfig=function(){var e={maxValue:this.maxValue},n=t.prototype.getConfig.call(this);return Object.assign(e,n),e},e.className="ReLU",e}($f);yp.registerClass(Lm);var Pm=function(t){function e(e){var n=t.call(this,null==e?{}:e)||this;return n.DEFAULT_ALPHA=.3,null==e&&(e={}),n.alpha=null==e.alpha?n.DEFAULT_ALPHA:e.alpha,n}return Bp(e,t),e.prototype.call=function(t,e){var n=zf(t);return fl(n,this.alpha)},e.prototype.computeOutputShape=function(t){return t},e.prototype.getConfig=function(){var e={alpha:this.alpha},n=t.prototype.getConfig.call(this);return Object.assign(e,n),e},e.className="LeakyReLU",e}($f);yp.registerClass(Pm);var Bm=function(t){function e(e){var n=t.call(this,null==e?{}:e)||this;if(n.DEFAULT_ALPHA_INITIALIZER="zeros",null==e&&(e={}),n.supportsMasking=!0,n.alphaInitializer=Af(e.alphaInitializer||n.DEFAULT_ALPHA_INITIALIZER),n.alphaRegularizer=zm(e.alphaRegularizer),n.alphaConstraint=wh(e.alphaConstraint),null==e.sharedAxes)n.sharedAxes=null;else if(Array.isArray(e.sharedAxes))n.sharedAxes=e.sharedAxes;else{if("number"!=typeof e.sharedAxes)throw new Kp("Expected sharedAxes to be a number or an array of numbers, but got "+e.sharedAxes);n.sharedAxes=[e.sharedAxes]}return n}return Bp(e,t),e.prototype.build=function(t){var e=(t=Lf(t)).slice(1);if(null!=this.sharedAxes)for(var n=0,r=this.sharedAxes;n<r.length;n++)e[(a=r[n])-1]=1;this.alpha=this.addWeight("alpha",e,"float32",this.alphaInitializer,this.alphaRegularizer,!0,this.alphaConstraint);var i={};if(null!=this.sharedAxes)for(var a=1;a<t.length;++a)i[a]=t[a];this.inputSpec=[new jf({ndim:t.length,axes:i})],this.built=!0},e.prototype.call=function(t,e){return t=zf(t),dl(t,this.alpha.read())},e.prototype.getConfig=function(){var e={alphaInitializer:If(this.alphaInitializer),alphaRegularizer:Fm(this.alphaRegularizer),alphaConstraint:bh(this.alphaConstraint),sharedAxes:this.sharedAxes},n=t.prototype.getConfig.call(this);return Object.assign(e,n),e},e.className="PReLU",e}($f);yp.registerClass(Bm);var Vm=function(t){function e(e){var n=t.call(this,null==e?{}:e)||this;if(n.DEFAULT_ALPHA=1,null==e&&(e={}),null!=e.alpha&&e.alpha!==n.DEFAULT_ALPHA)throw new $p("Non-default alpha value ("+e.alpha+") is not supported by the ELU layer yet.");return n.alpha=null==e.alpha?n.DEFAULT_ALPHA:e.alpha,n}return Bp(e,t),e.prototype.call=function(t,e){var n=zf(t);return hl(n)},e.prototype.computeOutputShape=function(t){return t},e.prototype.getConfig=function(){var e={alpha:this.alpha},n=t.prototype.getConfig.call(this);return Object.assign(e,n),e},e.className="ELU",e}($f);yp.registerClass(Vm);var Wm=function(t){function e(e){var n=t.call(this,null==e?{}:e)||this;return n.DEFAULT_THETA=1,null==e&&(e={}),n.theta=null==e.theta?n.DEFAULT_THETA:e.theta,n}return Bp(e,t),e.prototype.call=function(t,e){var n=zf(t);return n.mul(qh(n.greater(this.theta),"float32"))},e.prototype.computeOutputShape=function(t){return t},e.prototype.getConfig=function(){var e={theta:this.theta},n=t.prototype.getConfig.call(this);return Object.assign(e,n),e},e.className="ThresholdedReLU",e}($f);yp.registerClass(Wm);var Um=function(t){function e(e){var n=t.call(this,null==e?{}:e)||this;return n.DEFAULT_AXIS=1,null==e&&(e={}),n.softmax=(new Sm).apply,n.axis=null==e.axis?n.DEFAULT_AXIS:e.axis,n}return Bp(e,t),e.prototype.call=function(t,e){var n=zf(t);return this.softmax(n,this.axis)},e.prototype.computeOutputShape=function(t){return t},e.prototype.getConfig=function(){var e={axis:this.axis},n=t.prototype.getConfig.call(this);return Object.assign(e,n),e},e.className="Softmax",e}($f);function jm(t,e,n){if("number"==typeof t)return Yp(t,e);if(t.length!==e)throw new Kp("The "+n+" argument must be an integer or tuple of "+e+" integers. Received: "+t.length+" elements.");for(var r=0;r<e;++r){var i=t[r];if(!Ph(i))throw new Kp("The "+n+" argument must be an integer or tuple of "+e+" integers. Received: "+JSON.stringify(t)+" including a non-integer number "+i)}return t}function qm(t,e,n,r,i){return void 0===i&&(i=1),null==t?t:(a="same"===n?t:t-(e+(e-1)*(i-1))+1,Math.floor((a+r-1)/r));var a}function Hm(t,e,n,r){if(null==t)return null;if("valid"===r)t=t*e+Uh([n-e,0]);else{if("same"!==r)throw new Kp("Unsupport padding mode: "+r+".");t*=e}return t}function Gm(t,e){return Fe(function(){return Ah(e),"channelsFirst"===e?vl(t,[0,2,3,1]):t})}function Km(t,e){return Fe(function(){return Ah(e),"channelsFirst"===e?vl(t,[0,2,3,4,1]):t})}function $m(t,e,n,r,i,a,o,s){return void 0===r&&(r=[1,1]),void 0===i&&(i="valid"),void 0===s&&(s=null),Fe(function(){if(null==a&&(a="channelsLast"),Ah(a),3!==t.rank&&4!==t.rank)throw new Kp("conv2dWithBiasActivation expects input to be of rank 3 or 4, but received "+t.rank+".");if(3!==e.rank&&4!==e.rank)throw new Kp("conv2dWithBiasActivation expects kernel to be of rank 3 or 4, but received "+t.rank+".");var u=Gm(t,a);if("causal"===i)throw new $p("The support for CAUSAL padding mode in conv1dWithBias is not implemented yet.");return u=cc.conv2d({x:u,filter:e,strides:r,pad:"same"===i?"same":"valid",dilations:o,dataFormat:"NHWC",bias:n,activation:s}),"channelsFirst"===a&&(u=vl(u,[0,3,1,2])),u})}yp.registerClass(Um);var Xm=function(t){function e(n,r){var i=t.call(this,r)||this;if(i.bias=null,i.DEFAULT_KERNEL_INITIALIZER="glorotNormal",i.DEFAULT_BIAS_INITIALIZER="zeros",e.verifyArgs(r),i.rank=n,ph(i.rank,"rank"),1!==i.rank&&2!==i.rank&&3!==i.rank)throw new $p("Convolution layer for rank other than 1, 2, or 3 ("+i.rank+") is not implemented yet.");if(i.kernelSize=jm(r.kernelSize,n,"kernelSize"),i.strides=jm(null==r.strides?1:r.strides,n,"strides"),i.padding=null==r.padding?"valid":r.padding,Rh(i.padding),i.dataFormat=null==r.dataFormat?"channelsLast":r.dataFormat,Ah(i.dataFormat),i.activation=Rm(r.activation),i.useBias=null==r.useBias||r.useBias,i.biasInitializer=Af(r.biasInitializer||i.DEFAULT_BIAS_INITIALIZER),i.biasConstraint=wh(r.biasConstraint),i.biasRegularizer=zm(r.biasRegularizer),i.activityRegularizer=zm(r.activityRegularizer),i.dilationRate=jm(null==r.dilationRate?1:r.dilationRate,n,"dilationRate"),1===i.rank&&Array.isArray(i.dilationRate)&&1!==i.dilationRate.length)throw new Kp("dilationRate must be a number or an array of a single number for 1D convolution, but received "+JSON.stringify(i.dilationRate));if(2===i.rank){if("number"==typeof i.dilationRate)i.dilationRate=[i.dilationRate,i.dilationRate];else if(2!==i.dilationRate.length)throw new Kp("dilationRate must be a number or array of two numbers for 2D convolution, but received "+JSON.stringify(i.dilationRate))}else if(3===i.rank)if("number"==typeof i.dilationRate)i.dilationRate=[i.dilationRate,i.dilationRate,i.dilationRate];else if(3!==i.dilationRate.length)throw new Kp("dilationRate must be a number or array of three numbers for 3D convolution, but received "+JSON.stringify(i.dilationRate));return i}return Bp(e,t),e.verifyArgs=function(t){if(Jp("kernelSize"in t,"required key 'kernelSize' not in config"),"number"!=typeof t.kernelSize&&!ch(t.kernelSize,"number",1,3))throw new Kp("BaseConv expects config.kernelSize to be number or number[] with length 1, 2, or 3, but received "+JSON.stringify(t.kernelSize)+".")},e.prototype.getConfig=function(){var e={kernelSize:this.kernelSize,strides:this.strides,padding:this.padding,dataFormat:this.dataFormat,dilationRate:this.dilationRate,activation:Im(this.activation),useBias:this.useBias,biasInitializer:If(this.biasInitializer),biasRegularizer:Fm(this.biasRegularizer),activityRegularizer:Fm(this.activityRegularizer),biasConstraint:bh(this.biasConstraint)},n=t.prototype.getConfig.call(this);return Object.assign(e,n),e},e}($f),Ym=function(t){function e(n,r){var i=t.call(this,n,r)||this;return i.kernel=null,e.verifyArgs(r),i.filters=r.filters,ph(i.filters,"filters"),i.kernelInitializer=Af(r.kernelInitializer||i.DEFAULT_KERNEL_INITIALIZER),i.kernelConstraint=wh(r.kernelConstraint),i.kernelRegularizer=zm(r.kernelRegularizer),i}return Bp(e,t),e.prototype.build=function(t){var e;t=Lf(t);var n="channelsFirst"===this.dataFormat?1:t.length-1;if(null==t[n])throw new Kp("The channel dimension of the input should be defined. Found "+t[n]);var r=t[n],i=this.kernelSize.concat([r,this.filters]);this.kernel=this.addWeight("kernel",i,null,this.kernelInitializer,this.kernelRegularizer,!0,this.kernelConstraint),this.useBias&&(this.bias=this.addWeight("bias",[this.filters],null,this.biasInitializer,this.biasRegularizer,!0,this.biasConstraint)),this.inputSpec=[{ndim:this.rank+2,axes:(e={},e[n]=r,e)}],this.built=!0},e.prototype.call=function(t,e){var n=this;return Fe(function(){var e;t=zf(t);var r=null==n.bias?null:n.bias.read(),i=function(t){return"relu"===t?"relu":"linear"===t?"linear":null}(n.activation.getClassName());if(null!=i&&2===n.rank)e=$m(t,n.kernel.read(),r,n.strides,n.padding,n.dataFormat,n.dilationRate,i);else{if(1===n.rank)e=function(t,e,n,r,i,a,o){return void 0===r&&(r=1),void 0===i&&(i="valid"),void 0===o&&(o=1),Fe(function(){if(null==a&&(a="channelsLast"),Ah(a),3!==t.shape.length)throw new Kp("The input of a conv1dWithBias operation should be 3, but is "+t.shape.length+" instead.");if(3!==e.shape.length)throw new Kp("The kernel for a conv1dWithBias operation should be 3, but is "+e.shape.length+" instead");if(null!=n&&1!==n.shape.length)throw new Kp("The bias for a conv1dWithBias operation should be 1, but is "+e.shape.length+" instead");if("channelsFirst"===a&&(t=vl(t,[0,2,1])),"causal"===i)throw new $p("The support for CAUSAL padding mode in conv1dWithBias is not implemented yet.");var s=Su(t,e,r,"same"===i?"same":"valid","NWC",o);return null!=n&&(s=rf(s,n)),s})}(t,n.kernel.read(),r,n.strides[0],n.padding,n.dataFormat,n.dilationRate[0]);else if(2===n.rank)e=$m(t,n.kernel.read(),r,n.strides,n.padding,n.dataFormat,n.dilationRate);else{if(3!==n.rank)throw new $p("convolutions greater than 3D are not implemented yet.");e=function(t,e,n,r,i,a,o){return void 0===r&&(r=[1,1,1]),void 0===i&&(i="valid"),Fe(function(){if(null==a&&(a="channelsLast"),Ah(a),4!==t.rank&&5!==t.rank)throw new Kp("conv3dWithBias expects input to be of rank 4 or 5, but received "+t.rank+".");if(4!==e.rank&&5!==e.rank)throw new Kp("conv3dWithBias expects kernel to be of rank 4 or 5, but received "+t.rank+".");var s=Km(t,a);if("causal"===i)throw new $p("The support for CAUSAL padding mode in conv3dWithBias is not implemented yet.");return s=Iu(s,e,r,"same"===i?"same":"valid","NDHWC",o),null!=n&&(s=rf(s,n)),"channelsFirst"===a&&(s=vl(s,[0,4,1,2,3])),s})}(t,n.kernel.read(),r,n.strides,n.padding,n.dataFormat,n.dilationRate)}null!=n.activation&&(e=n.activation.apply(e))}return e})},e.prototype.computeOutputShape=function(t){t=Lf(t);for(var e=[],n="channelsLast"===this.dataFormat?t.slice(1,t.length-1):t.slice(2),r=0;r<n.length;++r){var i=qm(n[r],this.kernelSize[r],this.padding,this.strides[r],"number"==typeof this.dilationRate?this.dilationRate:this.dilationRate[r]);e.push(i)}var a=[t[0]];return"channelsLast"===this.dataFormat?(a=a.concat(e)).push(this.filters):(a.push(this.filters),a=a.concat(e)),a},e.prototype.getConfig=function(){var e={filters:this.filters,kernelInitializer:If(this.kernelInitializer),kernelRegularizer:Fm(this.kernelRegularizer),kernelConstraint:bh(this.kernelConstraint)},n=t.prototype.getConfig.call(this);return Object.assign(e,n),e},e.verifyArgs=function(t){if(!("filters"in t)||"number"!=typeof t.filters||t.filters<1)throw new Kp("Convolution layer expected config.filters to be a 'number' > 0 but got "+JSON.stringify(t.filters))},e}(Xm),Jm=function(t){function e(n){var r=t.call(this,2,n)||this;return e.verifyArgs(n),r}return Bp(e,t),e.prototype.getConfig=function(){var e=t.prototype.getConfig.call(this);return delete e.rank,e},e.verifyArgs=function(t){if("number"!=typeof t.kernelSize&&!ch(t.kernelSize,"number",1,2))throw new Kp("Conv2D expects config.kernelSize to be number or number[] with length 1 or 2, but received "+JSON.stringify(t.kernelSize)+".")},e.className="Conv2D",e}(Ym);yp.registerClass(Jm);var Zm=function(t){function e(n){var r=t.call(this,3,n)||this;return e.verifyArgs(n),r}return Bp(e,t),e.prototype.getConfig=function(){var e=t.prototype.getConfig.call(this);return delete e.rank,e},e.verifyArgs=function(t){if("number"!=typeof t.kernelSize&&(!Array.isArray(t.kernelSize)||1!==t.kernelSize.length&&3!==t.kernelSize.length))throw new Kp("Conv3D expects config.kernelSize to be number or [number, number, number], but received "+JSON.stringify(t.kernelSize)+".")},e.className="Conv3D",e}(Ym);yp.registerClass(Zm);var Qm=function(t){function e(e){var n=t.call(this,e)||this;if(n.inputSpec=[new jf({ndim:4})],"same"!==n.padding&&"valid"!==n.padding)throw new Kp("Conv2DTranspose currently supports only padding modes 'same' and 'valid', but received padding mode "+n.padding);return n}return Bp(e,t),e.prototype.build=function(t){var e;if(4!==(t=Lf(t)).length)throw new Kp("Input should have rank 4; Received input shape: "+JSON.stringify(t));var n="channelsFirst"===this.dataFormat?1:t.length-1;if(null==t[n])throw new Kp("The channel dimension of the inputs should be defined. Found `None`.");var r=t[n],i=this.kernelSize.concat([this.filters,r]);this.kernel=this.addWeight("kernel",i,"float32",this.kernelInitializer,this.kernelRegularizer,!0,this.kernelConstraint),this.useBias&&(this.bias=this.addWeight("bias",[this.filters],"float32",this.biasInitializer,this.biasRegularizer,!0,this.biasConstraint)),this.inputSpec=[new jf({ndim:4,axes:(e={},e[n]=r,e)})],this.built=!0},e.prototype.call=function(t,e){var n=this;return Fe(function(){var e=zf(t);if(4!==e.shape.length)throw new Kp("Conv2DTranspose.call() expects input tensor to be rank-4, but received a tensor of rank-"+e.shape.length);var r,i,a=e.shape,o=a[0];"channelsFirst"===n.dataFormat?(r=2,i=3):(r=1,i=2);var s=a[r],u=a[i],l=n.kernelSize[0],c=n.kernelSize[1],p=n.strides[0],h=n.strides[1],f=[o,Hm(s,p,l,n.padding),Hm(u,h,c,n.padding),n.filters];"channelsLast"!==n.dataFormat&&(e=vl(e,[0,2,3,1]));var d=Ou(e,n.kernel.read(),f,n.strides,n.padding);return"channelsLast"!==n.dataFormat&&(d=vl(d,[0,3,1,2])),null!=n.bias&&(d=rf(d,n.bias.read(),n.dataFormat)),null!=n.activation&&(d=n.activation.apply(d)),d})},e.prototype.computeOutputShape=function(t){var e,n,r,i=(t=Lf(t)).slice();"channelsFirst"===this.dataFormat?(e=1,n=2,r=3):(e=3,n=1,r=2);var a=this.kernelSize[0],o=this.kernelSize[1],s=this.strides[0],u=this.strides[1];return i[e]=this.filters,i[n]=Hm(i[n],s,a,this.padding),i[r]=Hm(i[r],u,o,this.padding),i},e.prototype.getConfig=function(){var e=t.prototype.getConfig.call(this);return delete e.dilationRate,e},e.className="Conv2DTranspose",e}(Jm);yp.registerClass(Qm);var tg=function(t){function e(e){return t.call(this,2,e)||this}return Bp(e,t),e.className="SeparableConv2D",e}(function(t){function e(e,n){var r=t.call(this,e,n)||this;if(r.DEFAULT_DEPTHWISE_INITIALIZER="glorotUniform",r.DEFAULT_POINTWISE_INITIALIZER="glorotUniform",r.depthwiseKernel=null,r.pointwiseKernel=null,null==n.filters)throw new Kp("The `filters` configuration field is required by SeparableConv, but is unspecified.");if(null!=n.kernelInitializer||null!=n.kernelRegularizer||null!=n.kernelConstraint)throw new Kp("Fields kernelInitializer, kernelRegularizer and kernelConstraint are invalid for SeparableConv2D. Use depthwiseInitializer, depthwiseRegularizer, depthwiseConstraint, pointwiseInitializer, pointwiseRegularizer and pointwiseConstraint instead.");if(null!=n.padding&&"same"!==n.padding&&"valid"!==n.padding)throw new Kp("SeparableConv"+r.rank+"D supports only padding modes: 'same' and 'valid', but received "+JSON.stringify(n.padding));return r.depthMultiplier=null==n.depthMultiplier?1:n.depthMultiplier,r.depthwiseInitializer=Af(n.depthwiseInitializer||r.DEFAULT_DEPTHWISE_INITIALIZER),r.depthwiseRegularizer=zm(n.depthwiseRegularizer),r.depthwiseConstraint=wh(n.depthwiseConstraint),r.pointwiseInitializer=Af(n.depthwiseInitializer||r.DEFAULT_POINTWISE_INITIALIZER),r.pointwiseRegularizer=zm(n.pointwiseRegularizer),r.pointwiseConstraint=wh(n.pointwiseConstraint),r}return Bp(e,t),e.prototype.build=function(t){var e;if((t=Lf(t)).length<this.rank+2)throw new Kp("Inputs to SeparableConv"+this.rank+"D should have rank "+(this.rank+2)+", but received input shape: "+JSON.stringify(t));var n="channelsFirst"===this.dataFormat?1:t.length-1;if(null==t[n]||t[n]<0)throw new Kp("The channel dimension of the inputs should be defined, but found "+JSON.stringify(t[n]));for(var r=t[n],i=this.kernelSize.concat([r,this.depthMultiplier]),a=[],o=0;o<this.rank;++o)a.push(1);a.push(r*this.depthMultiplier,this.filters),this.depthwiseKernel=this.addWeight("depthwise_kernel",i,"float32",this.depthwiseInitializer,this.depthwiseRegularizer,!0,this.depthwiseConstraint),this.pointwiseKernel=this.addWeight("pointwise_kernel",a,"float32",this.pointwiseInitializer,this.pointwiseRegularizer,!0,this.pointwiseConstraint),this.useBias?this.bias=this.addWeight("bias",[this.filters],"float32",this.biasInitializer,this.biasRegularizer,!0,this.biasConstraint):this.bias=null,this.inputSpec=[new jf({ndim:this.rank+2,axes:(e={},e[n]=r,e)})],this.built=!0},e.prototype.call=function(t,e){var n=this;return Fe(function(){var e;if(t=zf(t),1===n.rank)throw new $p("1D separable convolution is not implemented yet.");return 2===n.rank&&("channelsFirst"===n.dataFormat&&(t=vl(t,[0,2,3,1])),e=Du(t,n.depthwiseKernel.read(),n.pointwiseKernel.read(),n.strides,n.padding,n.dilationRate,"NHWC")),n.useBias&&(e=rf(e,n.bias.read(),n.dataFormat)),null!=n.activation&&(e=n.activation.apply(e)),"channelsFirst"===n.dataFormat&&(e=vl(e,[0,3,1,2])),e})},e.prototype.getConfig=function(){var e=t.prototype.getConfig.call(this);return delete e.rank,delete e.kernelInitializer,delete e.kernelRegularizer,delete e.kernelConstraint,e.depthwiseInitializer=If(this.depthwiseInitializer),e.pointwiseInitializer=If(this.pointwiseInitializer),e.depthwiseRegularizer=Fm(this.depthwiseRegularizer),e.pointwiseRegularizer=Fm(this.pointwiseRegularizer),e.depthwiseConstraint=bh(this.depthwiseConstraint),e.pointwiseConstraint=bh(this.pointwiseConstraint),e},e.className="SeparableConv",e}(Ym));yp.registerClass(tg);var eg=function(t){function e(n){var r=t.call(this,1,n)||this;return e.verifyArgs(n),r.inputSpec=[{ndim:3}],r}return Bp(e,t),e.prototype.getConfig=function(){var e=t.prototype.getConfig.call(this);return delete e.rank,delete e.dataFormat,e},e.verifyArgs=function(t){if("number"!=typeof t.kernelSize&&!ch(t.kernelSize,"number",1,1))throw new Kp("Conv1D expects config.kernelSize to be number or number[] with length 1, but received "+JSON.stringify(t.kernelSize)+".")},e.className="Conv1D",e}(Ym);yp.registerClass(eg);var ng=function(t){function e(e){var n=t.call(this,e)||this;return"number"==typeof e.cropping?n.cropping=[[e.cropping,e.cropping],[e.cropping,e.cropping]]:"number"==typeof e.cropping[0]?n.cropping=[[e.cropping[0],e.cropping[0]],[e.cropping[1],e.cropping[1]]]:n.cropping=e.cropping,n.dataFormat=void 0===e.dataFormat?"channelsLast":e.dataFormat,n.inputSpec=[{ndim:4}],n}return Bp(e,t),e.prototype.computeOutputShape=function(t){return"channelsFirst"===this.dataFormat?[t[0],t[1],t[2]-this.cropping[0][0]-this.cropping[0][1],t[3]-this.cropping[1][0]-this.cropping[1][1]]:[t[0],t[1]-this.cropping[0][0]-this.cropping[0][1],t[2]-this.cropping[1][0]-this.cropping[1][1],t[3]]},e.prototype.call=function(t,e){var n=this;return Fe(function(){return t=zf(t),"channelsLast"===n.dataFormat?$h($h(t,n.cropping[0][0],t.shape[1]-n.cropping[0][0]-n.cropping[0][1],2),n.cropping[1][0],t.shape[2]-n.cropping[1][1]-n.cropping[1][0],3):$h($h(t,n.cropping[0][0],t.shape[2]-n.cropping[0][0]-n.cropping[0][1],3),n.cropping[1][0],t.shape[3]-n.cropping[1][1]-n.cropping[1][0],4)})},e.prototype.getConfig=function(){var e={cropping:this.cropping,dataFormat:this.dataFormat},n=t.prototype.getConfig.call(this);return Object.assign(e,n),e},e.className="Cropping2D",e}($f);yp.registerClass(ng);var rg=function(t){function e(e){var n=t.call(this,e)||this;return n.DEFAULT_SIZE=[2,2],n.inputSpec=[{ndim:4}],n.size=null==e.size?n.DEFAULT_SIZE:e.size,n.dataFormat=null==e.dataFormat?"channelsLast":e.dataFormat,n}return Bp(e,t),e.prototype.computeOutputShape=function(t){if("channelsFirst"===this.dataFormat){var e=null==t[2]?null:this.size[0]*t[2],n=null==t[3]?null:this.size[1]*t[3];return[t[0],t[1],e,n]}return e=null==t[1]?null:this.size[0]*t[1],n=null==t[2]?null:this.size[1]*t[2],[t[0],e,n,t[3]]},e.prototype.call=function(t,e){var n=this;return Fe(function(){var e=zf(t),r=e.shape;if("channelsFirst"===n.dataFormat){e=vl(e,[0,2,3,1]);var i=n.size[0]*r[2],a=n.size[1]*r[3],o=e.resizeNearestNeighbor([i,a]);return vl(o,[0,3,1,2])}return i=n.size[0]*r[1],a=n.size[1]*r[2],e.resizeNearestNeighbor([i,a])})},e.prototype.getConfig=function(){var e={size:this.size,dataFormat:this.dataFormat},n=t.prototype.getConfig.call(this);return Object.assign(e,n),e},e.className="UpSampling2D",e}($f);yp.registerClass(rg);var ig=function(t){function e(e){var n=t.call(this,2,e)||this;return n.depthwiseKernel=null,n.depthMultiplier=null==e.depthMultiplier?1:e.depthMultiplier,n.depthwiseInitializer=Af(e.depthwiseInitializer||n.DEFAULT_KERNEL_INITIALIZER),n.depthwiseConstraint=wh(e.depthwiseConstraint),n.depthwiseRegularizer=zm(e.depthwiseRegularizer),n}return Bp(e,t),e.prototype.build=function(t){if((t=Lf(t)).length<4)throw new Kp("Inputs to DepthwiseConv2D should have rank 4. Received input shape: "+JSON.stringify(t)+".");var e="channelsFirst"===this.dataFormat?1:3;if(null==t[e]||t[e]<0)throw new Kp("The channel dimension of the inputs to DepthwiseConv2D should be defined, but is not ("+t[e]+").");var n=t[e],r=[this.kernelSize[0],this.kernelSize[1],n,this.depthMultiplier];this.depthwiseKernel=this.addWeight("depthwise_kernel",r,null,this.depthwiseInitializer,this.depthwiseRegularizer,!0,this.depthwiseConstraint),this.useBias?this.bias=this.addWeight("bias",[n*this.depthMultiplier],null,this.biasInitializer,this.biasRegularizer,!0,this.biasConstraint):this.bias=null,this.built=!0},e.prototype.call=function(t,e){var n=this;return Fe(function(){var e=function(t,e,n,r,i,a){return void 0===n&&(n=[1,1]),void 0===r&&(r="valid"),Fe(function(){null==i&&(i="channelsLast"),Ah(i);var o=Gm(t,i);if(4!==t.rank)throw new Kp("Input for depthwiseConv2d is required to be 4-D, but is instead "+t.rank+"-D");if(4!==e.rank)throw new Kp("depthwiseKernel is required to be 4-D, but is instead "+e.rank+"-D");return o=Tu(o,e,n,"same"===r?"same":"valid","NHWC",a),"channelsFirst"===i&&(o=vl(o,[0,3,1,2])),o})}(t=zf(t),n.depthwiseKernel.read(),n.strides,n.padding,n.dataFormat,null);return n.useBias&&(e=rf(e,n.bias.read(),n.dataFormat)),null!=n.activation&&(e=n.activation.apply(e)),e})},e.prototype.computeOutputShape=function(t){t=Lf(t);var e="channelsFirst"===this.dataFormat?t[2]:t[1],n="channelsFirst"===this.dataFormat?t[3]:t[2],r="channelsFirst"===this.dataFormat?t[1]*this.depthMultiplier:t[3]*this.depthMultiplier,i=qm(e,this.kernelSize[0],this.padding,this.strides[0]),a=qm(n,this.kernelSize[1],this.padding,this.strides[1]);return"channelsFirst"===this.dataFormat?[t[0],r,i,a]:[t[0],i,a,r]},e.prototype.getConfig=function(){var e=t.prototype.getConfig.call(this);return e.depthMultiplier=this.depthMultiplier,e.depthwiseInitializer=If(this.depthwiseInitializer),e.depthwiseRegularizer=Fm(this.depthwiseRegularizer),e.depthwiseConstraint=bh(this.depthwiseRegularizer),e},e.className="DepthwiseConv2D",e}(Xm);yp.registerClass(ig);var ag=function(t){function e(e){var n=t.call(this,e)||this;return n.rate=Math.max(Math.min(e.rate,1),0),n.noiseShape=e.noiseShape,n.seed=e.seed,n.supportsMasking=!0,n}return Bp(e,t),e.prototype.getNoiseShape=function(t){if(null==this.noiseShape)return this.noiseShape;for(var e=t.shape,n=[],r=0;r<this.noiseShape.length;++r)n.push(null==this.noiseShape[r]?e[r]:this.noiseShape[r]);return n},e.prototype.call=function(t,e){var n=this;return Fe(function(){n.invokeCallHook(t,e);var r=zf(t);if(0<n.rate&&n.rate<1){var i=null!=e.training&&e.training,a=n.getNoiseShape(r);return of(function(){return af(r,n.rate,a,n.seed)},function(){return r},i)}return t})},e.prototype.getConfig=function(){var e={rate:this.rate,noiseShape:this.noiseShape,seed:this.seed},n=t.prototype.getConfig.call(this);return Object.assign(e,n),e},e.prototype.dispose=function(){return t.prototype.dispose.call(this)},e.className="Dropout",e}($f);yp.registerClass(ag);var og=function(t){function e(e){var n=t.call(this,e)||this;if(n.activation=null,n.useBias=!0,n.kernel=null,n.bias=null,n.DEFAULT_KERNEL_INITIALIZER="glorotNormal",n.DEFAULT_BIAS_INITIALIZER="zeros",null==e.batchInputShape&&null==e.inputShape&&null!=e.inputDim){var r=null;null!=e.batchSize&&(r=e.batchSize),n.batchInputShape=[r,e.inputDim]}return n.units=e.units,ph(n.units,"units"),n.activation=Rm(e.activation),null!=e.useBias&&(n.useBias=e.useBias),n.kernelInitializer=Af(e.kernelInitializer||n.DEFAULT_KERNEL_INITIALIZER),n.biasInitializer=Af(e.biasInitializer||n.DEFAULT_BIAS_INITIALIZER),n.kernelConstraint=wh(e.kernelConstraint),n.biasConstraint=wh(e.biasConstraint),n.kernelRegularizer=zm(e.kernelRegularizer),n.biasRegularizer=zm(e.biasRegularizer),n.activityRegularizer=zm(e.activityRegularizer),n.supportsMasking=!0,n.inputSpec=[{minNDim:2}],n}return Bp(e,t),e.prototype.build=function(t){var e,n=(t=Lf(t))[t.length-1];null==this.kernel&&(this.kernel=this.addWeight("kernel",[n,this.units],null,this.kernelInitializer,this.kernelRegularizer,!0,this.kernelConstraint),this.useBias&&(this.bias=this.addWeight("bias",[this.units],null,this.biasInitializer,this.biasRegularizer,!0,this.biasConstraint))),this.inputSpec=[{minNDim:2,axes:(e={},e[-1]=n,e)}],this.built=!0},e.prototype.computeOutputShape=function(t){var e=(t=Lf(t)).slice();return e[e.length-1]=this.units,e},e.prototype.call=function(t,e){var n=this;return Fe(function(){n.invokeCallHook(t,e);var r,i=zf(t),a=function(t){return"relu"===t?"relu":"linear"===t?"linear":null}(n.activation.getClassName());return null!=a?r=Qh(i,n.kernel.read(),a,n.bias?n.bias.read():null):(r=Qh(i,n.kernel.read()),null!=n.bias&&(r=rf(r,n.bias.read())),null!=n.activation&&(r=n.activation.apply(r))),r})},e.prototype.getConfig=function(){var e={units:this.units,activation:Im(this.activation),useBias:this.useBias,kernelInitializer:If(this.kernelInitializer),biasInitializer:If(this.biasInitializer),kernelRegularizer:Fm(this.kernelRegularizer),biasRegularizer:Fm(this.biasRegularizer),activityRegularizer:Fm(this.activityRegularizer),kernelConstraint:bh(this.kernelConstraint),biasConstraint:bh(this.biasConstraint)},n=t.prototype.getConfig.call(this);return Object.assign(e,n),e},e.className="Dense",e}($f);yp.registerClass(og);var sg=function(t){function e(e){var n=t.call(this,e||{})||this;return n.inputSpec=[{minNDim:3}],n}return Bp(e,t),e.prototype.computeOutputShape=function(t){for(var e=0,n=(t=Lf(t)).slice(1);e<n.length;e++)if(null==n[e])throw new Kp('The shape of the input to "Flatten" is not fully defined (got '+t.slice(1)+'). Make sure to pass a complete "input_shape" or "batch_input_shape" argument to the first layer in your model.');return[t[0],Bh(t,1)]},e.prototype.call=function(t,e){var n=this;return Fe(function(){return n.invokeCallHook(t,e),function(t){if(t.rank<=1)throw new Kp("batchFlatten requires a minimum rank of 2. Got rank: "+t.rank+".");var e=[t.shape[0],Bh(t.shape,1)];return t.reshape(e)}(zf(t))})},e.className="Flatten",e}($f);yp.registerClass(sg);var ug=function(t){function e(e){var n=t.call(this,e)||this;return n.supportsMasking=!0,n.activation=Rm(e.activation),n}return Bp(e,t),e.prototype.call=function(t,e){var n=this;return Fe(function(){n.invokeCallHook(t,e);var r=zf(t);return n.activation.apply(r)})},e.prototype.getConfig=function(){var e={activation:Im(this.activation)},n=t.prototype.getConfig.call(this);return Object.assign(e,n),e},e.className="Activation",e}($f);yp.registerClass(ug);var lg=function(t){function e(e){var n=t.call(this,e)||this;return n.n=e.n,n.inputSpec=[{ndim:2}],n}return Bp(e,t),e.prototype.computeOutputShape=function(t){return[t[0],this.n,t[1]]},e.prototype.call=function(t,e){var n=this;return Fe(function(){return function(t,e){return Fe(function(){if(2!==t.shape.length)throw new Kp("repeat() expects a rank-2 tensor, but received a rank-"+t.shape.length+" tensor.");return Jh(Hh(t,1),[1,e,1])})}(t=zf(t),n.n)})},e.prototype.getConfig=function(){var e={n:this.n},n=t.prototype.getConfig.call(this);return Object.assign(e,n),e},e.className="RepeatVector",e}($f);yp.registerClass(lg);var cg=function(t){function e(e){var n=t.call(this,e)||this;n.targetShape=e.targetShape;for(var r=0;r<n.targetShape.length;++r)n.isUnknown(n.targetShape[r])&&(n.targetShape[r]=null);return n}return Bp(e,t),e.prototype.isUnknown=function(t){return t<0||null==t},e.prototype.fixUnknownDimension=function(t,e){for(var n="Total size of new array must be unchanged.",r=e.slice(),i=1,a=null,o=0;o<r.length;++o){var s=r[o];if(this.isUnknown(s)){if(null!==a)throw new Kp("Can only specifiy one unknown dimension.");a=o}else i*=s}var u=Bh(t);if(null!==a){if(0===i||u%i!=0)throw new Kp(n);r[a]=u/i}else if(u!==i)throw new Kp(n);return r},e.prototype.computeOutputShape=function(t){for(var e=!1,n=0;n<t.length;++n)if(this.isUnknown(t[n])){e=!0;break}return e?t.slice(0,1).concat(this.targetShape):t.slice(0,1).concat(this.fixUnknownDimension(t.slice(1),this.targetShape))},e.prototype.call=function(t,e){var n=this;return Fe(function(){n.invokeCallHook(t,e);var r=zf(t),i=r.shape,a=i.slice(0,1).concat(n.fixUnknownDimension(i.slice(1),n.targetShape));return r.reshape(a)})},e.prototype.getConfig=function(){var e={targetShape:this.targetShape},n=t.prototype.getConfig.call(this);return Object.assign(e,n),e},e.className="Reshape",e}($f);yp.registerClass(cg);var pg=function(t){function e(e){var n=t.call(this,e)||this;if(null==e.dims)throw new Error("Required configuration field `dims` is missing during Permute constructor call.");if(!Array.isArray(e.dims))throw new Error("Permute constructor requires `dims` to be an Array, but received "+e.dims+" instead.");var r=jh(1,e.dims.length+1);if(!J.arraysEqual(e.dims.slice().sort(),r))throw new Error("Invalid permutation `dims`: "+JSON.stringify(e.dims)+" `dims` must contain consecutive integers starting from 1.");return n.dims=e.dims,n.dimsIncludingBatch=[0].concat(n.dims),n.inputSpec=[new jf({ndim:n.dims.length+1})],n}return Bp(e,t),e.prototype.computeOutputShape=function(t){var e=(t=Lf(t)).slice();return this.dims.forEach(function(n,r){e[r+1]=t[n]}),e},e.prototype.call=function(t,e){return vl(zf(t),this.dimsIncludingBatch)},e.prototype.getConfig=function(){var e={dims:this.dims},n=t.prototype.getConfig.call(this);return Object.assign(e,n),e},e.className="Permute",e}($f);yp.registerClass(pg);var hg=function(t){function e(e){var n=t.call(this,null==e?{}:e)||this;return n.supportsMasking=!0,n.maskValue=null!=e?null==e.maskValue?0:e.maskValue:0,n}return Bp(e,t),e.prototype.computeOutputShape=function(t){return t},e.prototype.getConfig=function(){var e=t.prototype.getConfig.call(this),n={maskValue:this.maskValue};return Object.assign(n,e),n},e.prototype.computeMask=function(t,e){var n=zf(t);return nl(du(n,this.maskValue),-1)},e.prototype.call=function(t,e){var n=this;return Fe(function(){n.invokeCallHook(t,e);var r=zf(t),i=nl(du(r,n.maskValue),-1,!0);return r.mul(i.asType(r.dtype))})},e.className="Masking",e}($f);yp.registerClass(hg);var fg=function(t){function e(e){var n=t.call(this,e)||this;if(n.embeddings=null,n.DEFAULT_EMBEDDINGS_INITIALIZER="randomUniform",null==e.batchInputShape&&null==e.inputShape){var r=null;null!=e.batchSize&&(r=e.batchSize),null==e.inputLength?n.batchInputShape=[r,null]:n.batchInputShape=[r].concat(th(e.inputLength))}return n.inputDim=e.inputDim,ph(n.inputDim,"inputDim"),n.outputDim=e.outputDim,ph(n.outputDim,"outputDim"),n.embeddingsInitializer=Af(e.embeddingsInitializer||n.DEFAULT_EMBEDDINGS_INITIALIZER),n.embeddingsRegularizer=zm(e.embeddingsRegularizer),n.activityRegularizer=zm(e.activityRegularizer),n.embeddingsConstraint=wh(e.embeddingsConstraint),n.maskZero=e.maskZero,n.supportsMasking=e.maskZero,n.inputLength=e.inputLength,n}return Bp(e,t),e.prototype.build=function(t){this.embeddings=this.addWeight("embeddings",[this.inputDim,this.outputDim],this.dtype,this.embeddingsInitializer,this.embeddingsRegularizer,!0,this.embeddingsConstraint),this.built=!0},e.prototype.warnOnIncompatibleInputShape=function(t){},e.prototype.computeMask=function(t,e){var n=this;return Fe(function(){return n.maskZero?(t=zf(t),du(t,bn(t))):null})},e.prototype.computeOutputShape=function(t){if(t=Lf(t),null==this.inputLength)return t.concat([this.outputDim]);var e=th(this.inputLength);if(e.length!==t.length-1)throw new Kp('"inputLength" is '+this.inputLength+", but received input shape has shape "+t);for(var n=0,r=0;r<e.length;++r){var i=e[r],a=t[r+1];if(null!=i&&null!=a&&i!==a)throw new Kp('"inputLength" is '+this.inputLength+", but received input shape has shape "+t);null==i&&(e[n]=a),n++}return[t[0]].concat(e,[this.outputDim])},e.prototype.call=function(t,e){var n=this;return Fe(function(){n.invokeCallHook(t,e);var r=zf(t);return"int32"!==r.dtype&&(r=qh(r,"int32")),tf(n.embeddings.read(),r.as1D()).reshape(Lf(n.computeOutputShape(r.shape)))})},e.prototype.getConfig=function(){var e={inputDim:this.inputDim,outputDim:this.outputDim,embeddingsInitializer:If(this.embeddingsInitializer),embeddingsRegularizer:Fm(this.embeddingsRegularizer),activityRegularizer:Fm(this.activityRegularizer),embeddingsConstraint:bh(this.embeddingsConstraint),maskZero:this.maskZero,inputLength:this.inputLength},n=t.prototype.getConfig.call(this);return Object.assign(e,n),e},e.className="Embedding",e}($f);yp.registerClass(fg);var dg=function(t){function e(e){var n=t.call(this,e||{})||this;return n.supportsMasking=!0,n}return Bp(e,t),e.prototype.mergeFunction=function(t){throw new $p},e.prototype.computeElementwiseOpOutputShape=function(t,e){if(null==t||null==e)return null;if(t.length<e.length)return this.computeElementwiseOpOutputShape(e,t);if(0===e.length)return t;for(var n=t.slice(0,t.length-e.length),r=0;r<e.length;++r){var i=t[t.length-e.length+r],a=e[r];if(null==i||null==a||i<0||a<0)n.push(null);else if(1===i)n.push(a);else if(1===a)n.push(i);else{if(i!==a)throw new Kp("Operands could not be broadcast together with shapes "+JSON.stringify(t)+" "+JSON.stringify(e));n.push(i)}}return n},e.prototype.build=function(t){if(Array.isArray(t)&&!Array.isArray(t[0])&&(t=[Lf(t)]),(t=t).length<2)throw new Kp("A merge layer should be called on an Array of at least 2 inputs. Got "+t.length+" input(s).");for(var e=[],n=0,r=t;n<r.length;n++)null!=(o=r[n])&&null!==o[0]&&e.push(o[0]);if((e=sh(e)).length>1)throw new Kp("Can not merge tensors with different batch sizes. Got tensors with shapes: "+JSON.stringify(t)+".");for(var i=null==t[0]?null:t[0].slice(1),a=1;a<t.length;++a){var o=null==t[a]?null:t[a].slice(1);i=this.computeElementwiseOpOutputShape(i,o)}var s=t.map(function(t){return t.length});-1===t.indexOf(null)&&1===sh(s).length?this.reshapeRequired=!1:this.reshapeRequired=!0},e.prototype.call=function(t,e){var n=this;return Fe(function(){if(t=t,n.reshapeRequired){var e=[],r=t.map(function(t){return t.rank});if(-1===r.indexOf(null)){for(var i=Uh(r),a=0,o=t;a<o.length;a++){for(var s=(h=o[a]).rank,u=0;u<i-s;++u)h=Hh(h,1);e.push(h)}return n.mergeFunction(e)}for(var l=!1,c=0,p=t;c<p.length;c++){var h;if(null==(s=(h=p[c]).rank)){var f=h.shape,d=f[0],m=f.slice(1).concat([d]),g=h.reshape([d].concat(Bh(f.slice(1))));g=(g=vl(g,[1,0])).reshape(m),e.push(g),l=!0}else if(s>1){var v=jh(1,s).concat([0]);e.push(vl(h,v)),l=!0}else e.push(h)}var y=n.mergeFunction(e),b=y.rank;if(l)if(null==b){var x=y.shape;m=[d=x[x.length-1]].concat(x.slice(0,x.length-1)),y=vl(y.reshape([-1,d]),[1,0]).reshape(m)}else b>1&&(v=[b-1].concat(jh(0,b-1)),y=vl(y,v));return y}return n.mergeFunction(t)})},e.prototype.computeOutputShape=function(t){var e;e=null==(t=t)[0]?null:t[0].slice(1);for(var n=1;n<t.length;++n){var r=null==t[n]?null:t[n].slice(1);e=this.computeElementwiseOpOutputShape(e,r)}for(var i=[],a=0,o=t;a<o.length;a++)null!=(r=o[a])&&null!==r[0]&&i.push(r[0]);return 1===(i=sh(i)).length?i.concat(e):[null].concat(e)},e.prototype.computeMask=function(t,e){return Fe(function(){if(null==e)return null;if(!Array.isArray(e))throw new Kp("`mask` should be an Array");if(!Array.isArray(t))throw new Kp("`inputs` should be an Array");if(e.length!==t.length)throw new Kp("The Array 'inputs' and 'mask' are expected to have the same length, but have different lengths ("+t.length+" vs "+e.length+")");if(e.every(function(t){return null==t}))return null;for(var n=(e=e.map(function(t){return null==t?t:Hn(t,0)}))[0],r=1;r<e.length-1;++r)n=Ds(n,e[r]);return n})},e}($f),mg=function(t){function e(e){return t.call(this,e)||this}return Bp(e,t),e.prototype.mergeFunction=function(t){return Fe(function(){for(var e=t[0].clone(),n=1;n<t.length;++n)e=Ls(e,t[n]);return e})},e.className="Add",e}(dg);yp.registerClass(mg);var gg=function(t){function e(e){return t.call(this,e)||this}return Bp(e,t),e.prototype.mergeFunction=function(t){return Fe(function(){for(var e=t[0].clone(),n=1;n<t.length;++n)e=Ys(e,t[n]);return e})},e.className="Multiply",e}(dg);yp.registerClass(gg);var vg=function(t){function e(e){return t.call(this,e)||this}return Bp(e,t),e.prototype.mergeFunction=function(t){return Fe(function(){for(var e=t[0].clone(),n=1;n<t.length;++n)e=Ls(e,t[n]);return Ys(1/t.length,e)})},e.className="Average",e}(dg);yp.registerClass(vg);var yg=function(t){function e(e){return t.call(this,e)||this}return Bp(e,t),e.prototype.mergeFunction=function(t){return Fe(function(){for(var e=t[0],n=1;n<t.length;++n)e=qs(e,t[n]);return e})},e.className="Maximum",e}(dg);yp.registerClass(yg);var bg=function(t){function e(e){return t.call(this,e)||this}return Bp(e,t),e.prototype.mergeFunction=function(t){return Fe(function(){for(var e=t[0],n=1;n<t.length;++n)e=Gs(e,t[n]);return e})},e.className="Minimum",e}(dg);yp.registerClass(bg);var xg=function(t){function e(e){var n=t.call(this,e)||this;return n.DEFAULT_AXIS=-1,null==e&&(e={}),n.axis=null==e.axis?n.DEFAULT_AXIS:e.axis,n.supportsMasking=!0,n.reshapeRequired=!1,n}return Bp(e,t),e.prototype.build=function(t){if(!Array.isArray(t)||!Array.isArray(t[0])||1===t.length)throw new Kp("A `Concatenate` layer should be called on a list of at least 2 inputs");for(var e=!0,n=0,r=t=t;n<r.length;n++)if(null!=(c=r[n])){e=!1;break}if(!e){for(var i=[],a=0;a<t.length;++a){var o=t[a].slice();o.splice(this.axis,1);for(var s=!1,u=0,l=i;u<l.length;u++){var c=l[u];if(J.arraysEqual(c,o)){s=!0;break}}s||i.push(o)}if(i.length>1)throw new Kp("A `Concatenate` layer requires inputs with matching shapes except for the concat axis. Got input shapes: "+JSON.stringify(t))}},e.prototype.mergeFunction=function(t){var e=this;return Fe(function(){return Xh(t,e.axis)})},e.prototype.computeOutputShape=function(t){if(!Array.isArray(t)||!Array.isArray(t[0]))throw new Kp("A `Concatenate` layer should be called on a list of inputs.");for(var e=t,n=e[0].slice(),r=this.axis<0?n.length+this.axis:this.axis,i=0,a=e.slice(1);i<a.length;i++){var o=a[i];if(null==n[r]||null==o[r]){n[r]=null;break}n[r]+=o[r]}return n},e.prototype.computeMask=function(t,e){var n=this;if(null==e)return null;if(!Array.isArray(e))throw new Kp("`mask` should be an array for Concatenate");if(!Array.isArray(t))throw new Kp("`inputs` should be an array for Concatenate");if(e.length!==t.length)throw new Kp("Mismatch in the length of mask ("+e.length+") and the legnth of inputs ("+t.length+")");return Fe(function(){var r=!0;if(e.forEach(function(t){null==t||(r=!1)}),r)return null;for(var i=[],a=0;a<t.length;++a)null==e[a]?i.push(yn(t[a]).asType("bool")):e[a].rank<t[a].rank?i.push(Hn(e[a],-1)):i.push(e[a]);var o=xn(i,n.axis);return el(o,-1,!1)})},e.prototype.getConfig=function(){var e={axis:this.axis},n=t.prototype.getConfig.call(this);return Object.assign(e,n),e},e.className="Concatenate",e}(dg);function wg(t,e){for(;t<0;)t+=e;return t}yp.registerClass(xg);var Ng=function(t){function e(e){var n=t.call(this,e)||this;return n.axes=e.axes,n.normalize=null!=e.normalize&&e.normalize,n.supportsMasking=!0,n.reshapeRequired=!1,n}return Bp(e,t),e.prototype.build=function(t){J.assert(Array.isArray(t)&&2===t.length&&Array.isArray(t[0])&&Array.isArray(t[1]),function(){return"A `Dot` layer should be called on a list of exactly 2 inputs."});var e=t[0],n=t[1];if(e.length>3||n.length>3)throw new $p("Dot layer does not support tensors of 4D or higher rank yet.");var r=this.interpretAxes(e,n);if(e[r[0]]!==n[r[1]])throw new Kp("Dimension incompatibility: "+e[r[0]]+" !== "+n[r[1]])},e.prototype.mergeFunction=function(t){if(2!==t.length)throw new Kp("A `Dot` layer must be called on exactly 2 inputs, but received "+t.length+" input(s).");var e,n=t[0],r=t[1];return e=Array.isArray(this.axes)?this.axes.map(function(e,n){return wg(e,t[n].shape.length)}):[wg(this.axes,n.shape.length),wg(this.axes,r.shape.length)],this.normalize&&(n=cd(n,e[0]),r=cd(r,e[1])),function(t,e,n){if(t.shape.length>3||e.shape.length>3)throw new $p("batchDot is not implemented for tensors of 4D or higher rank yet");if(J.assert(t.shape.length>=2,function(){return"batchDot requires the rank of x to be >= 2, but got "+t.shape.length}),J.assert(t.shape.length>=2,function(){return"batchDot requires the rank of y to be >= 2, but got "+e.shape.length}),"number"==typeof n&&(n=[n,n]),"complex64"===t.dtype||"complex64"===e.dtype)throw new $p("batchDot is not implemented for complex64-type Tensors yet.");var r=t.shape.length,i=e.shape.length;null==n&&(n=[r-1,i-2]);var a=n;return Fe(function(){var n,o;if(r>i){n=r-i;for(var s=[],u=0;u<n;++u)s.push(1);e=e.reshape(e.shape.concat(s))}else if(i>r){for(n=i-r,s=[],u=0;u<n;++u)s.push(1);t=t.reshape(t.shape.concat(s))}else n=0;if(2===t.shape.length&&2===e.shape.length)o=a[0]===a[1]?t.mulStrict(e).sum(a[0]):t.transpose([1,0]).mulStrict(e).sum(a[1]);else{var l=a[0]!==t.shape.length-1,c=a[1]===e.shape.length-1;o=t.matMul(e,l,c)}if(n>0){var p,h=[];for(u=p=r>i?r+i-3:r-1;u<p+n;++u)h.push(u);o=o.squeeze(h)}return 1===o.shape.length&&(o=o.expandDims(1)),o})}(n,r,e)},e.prototype.interpretAxes=function(t,e){return Array.isArray(this.axes)?this.axes:[wg(this.axes,t.length),wg(this.axes,e.length)]},e.prototype.computeOutputShape=function(t){J.assert(Array.isArray(t)&&2===t.length&&Array.isArray(t[0])&&Array.isArray(t[1]),function(){return"A `Dot` layer should be called on a list of exactly 2 inputs."});var e=t[0].slice(),n=t[1].slice();if(e.length>3||n.length>3)throw new $p("Dot layer does not support tensors of 4D or higher rank yet.");var r=this.interpretAxes(e,n);e.splice(r[0],1),n.splice(r[1],1),n.splice(0,1);var i=e.concat(n);return 1===i.length&&i.push(1),i},e.prototype.computeMask=function(t,e){return null},e.prototype.getConfig=function(){var e={axes:this.axes,normalize:this.normalize},n=t.prototype.getConfig.call(this);return Object.assign(e,n),e},e.className="Dot",e}(dg);yp.registerClass(Ng);var Cg=function(t){function e(e){var n=t.call(this,e)||this;return n.supportsMasking=!0,n.stddev=e.stddev,n}return Bp(e,t),e.prototype.computeOutputShape=function(t){return t},e.prototype.getConfig=function(){var e=t.prototype.getConfig.call(this),n={stddev:this.stddev};return Object.assign(n,e),n},e.prototype.call=function(t,e){var n=this;return Fe(function(){n.invokeCallHook(t,e);var r=zf(t);return of(function(){return Zh(r.shape,0,n.stddev).add(r)},function(){return r},e.training||!1)})},e.className="GaussianNoise",e}($f);yp.registerClass(Cg);var Eg=function(t){function e(e){var n=t.call(this,e)||this;return n.supportsMasking=!0,n.rate=e.rate,n}return Bp(e,t),e.prototype.computeOutputShape=function(t){return t},e.prototype.getConfig=function(){var e=t.prototype.getConfig.call(this),n={rate:this.rate};return Object.assign(n,e),n},e.prototype.call=function(t,e){var n=this;return Fe(function(){n.invokeCallHook(t,e);var r=zf(t);return n.rate>0&&n.rate<1?of(function(){var t=Math.sqrt(n.rate/(1-n.rate));return r.mul(Zh(r.shape,1,t))},function(){return r},e.training||!1):r})},e.className="GaussianDropout",e}($f);yp.registerClass(Eg);var Sg=function(t){function e(e){var n=t.call(this,e)||this;return n.supportsMasking=!0,n.rate=e.rate,n.noiseShape=e.noiseShape,n}return Bp(e,t),e.prototype._getNoiseShape=function(t){return this.noiseShape||zf(t).shape},e.prototype.computeOutputShape=function(t){return t},e.prototype.getConfig=function(){var e=t.prototype.getConfig.call(this),n={rate:this.rate};return Object.assign(n,e),n},e.prototype.call=function(t,e){var n=this;return Fe(function(){if(n.rate<1&&n.rate>0){var r=n._getNoiseShape(t);return of(function(){var e=zf(t),i=-1.7580993408473766,a=su(rr(r),n.rate);a=qh(a,"float32");var o=Math.pow((1-n.rate)*(1+n.rate*Math.pow(i,2)),-.5),s=-o*i*n.rate;return e.mul(a).add(a.add(-1).mul(i)).mul(o).add(s)},function(){return zf(t)},e.training||!1)}return t})},e.className="AlphaDropout",e}($f);function kg(t,e,n,r,i,a){var o;if(void 0===a&&(a=.001),2===t.rank)o=As(t,e,n,r,i,a);else if(3===t.rank)o=Rs(t,e,n,r,i,a);else{if(4!==t.rank)throw new $p("batchNormalization is not implemented for array of rank "+t.rank+" yet");o=Ts(t,e,n,r,i,a)}return o}function Ig(t,e,n,r,i){return void 0===i&&(i=.001),J.arraysEqual(r.slice().sort(),jh(0,t.rank-1))?function(t,e,n,r,i){return void 0===i&&(i=.001),Fe(function(){var a=ll(t,r),o=a.mean,s=a.variance;return[kg(t,o,s,n,e,i),o,s]})}(t,e,n,r,i):function(t,e,n,r,i){return void 0===i&&(i=.001),Fe(function(){for(var a=ll(t,r),o=a.mean,s=a.variance,u=[],l=0,c=jh(0,t.rank);l<c.length;l++){var p=c[l];-1!==r.indexOf(p)?u.push(1):u.push(t.shape[p])}var h=o.reshape(u),f=s.reshape(u),d=null==e?null:e.reshape(u),m=null==n?null:n.reshape(u);return[kg(t,h,f,m,d,i),o,s]})}(t,e,n,r,i)}yp.registerClass(Sg);var Ag=function(t){function e(e){var n=this;return null==e&&(e={}),(n=t.call(this,e)||this).supportsMasking=!0,n.axis=null==e.axis?-1:e.axis,n.momentum=null==e.momentum?.99:e.momentum,n.epsilon=null==e.epsilon?.001:e.epsilon,n.center=null==e.center||e.center,n.scale=null==e.scale||e.scale,n.betaInitializer=Af(e.betaInitializer||"zeros"),n.gammaInitializer=Af(e.gammaInitializer||"ones"),n.movingMeanInitializer=Af(e.movingMeanInitializer||"zeros"),n.movingVarianceInitializer=Af(e.movingVarianceInitializer||"ones"),n.betaConstraint=wh(e.betaConstraint),n.gammaConstraint=wh(e.gammaConstraint),n.betaRegularizer=zm(e.betaRegularizer),n.gammaRegularizer=zm(e.gammaRegularizer),n}return Bp(e,t),e.prototype.build=function(t){var e;t=Lf(t);var n=this.axis>=0?this.axis:this.axis+t.length,r=t[n];if(null==r)throw new Kp("Axis "+n+" of input tensor should have a defined dimension but the layer received an input with shape "+JSON.stringify(t)+".");this.inputSpec=[new jf({ndim:t.length,axes:(e={},e[n]=r,e)})];var i=[r];this.scale&&(this.gamma=this.addWeight("gamma",i,null,this.gammaInitializer,this.gammaRegularizer,!0,this.gammaConstraint)),this.center&&(this.beta=this.addWeight("beta",i,null,this.betaInitializer,this.betaRegularizer,!0,this.betaConstraint)),this.movingMean=this.addWeight("moving_mean",i,null,this.movingMeanInitializer,null,!1),this.movingVariance=this.addWeight("moving_variance",i,null,this.movingVarianceInitializer,null,!1),this.built=!0},e.prototype.call=function(t,e){var n=this;return Fe(function(){var r=null!=e.training&&e.training,i=zf(t),a=i.shape,o=a.length,s=jh(0,o),u=n.axis>=0?n.axis:n.axis+o;s.splice(u,1);var l=Yp(1,o);l[u]=a[u];var c=s.slice();c.sort();var p=!J.arraysEqual(c,jh(0,o).slice(0,o-1));if(!r)return function(){if(p){var t=n.movingMean.read().reshape(l),e=n.movingVariance.read().reshape(l),r=n.center?n.beta.read().reshape(l):null,a=n.scale?n.gamma.read().reshape(l):null;return kg(i,t,e,r,a,n.epsilon)}return kg(i,n.movingMean.read(),n.movingVariance.read(),null==n.beta?null:n.beta.read(),null==n.gamma?null:n.gamma.read(),n.epsilon)}();var h=Ig(i,n.gamma.read(),n.beta.read(),s,n.epsilon),f=h[0],d=h[1],m=h[2],g=function(t,e,n){Fe(function(){var r=1-n,i=t.read(),a=i.sub(e).mul(r);t.write(i.sub(a))})};return g(n.movingMean,d,n.momentum),g(n.movingVariance,m,n.momentum),f})},e.prototype.getConfig=function(){var e={axis:this.axis,momentum:this.momentum,epsilon:this.epsilon,center:this.center,scale:this.scale,betaInitializer:If(this.betaInitializer),gammaInitializer:If(this.gammaInitializer),movingMeanInitializer:If(this.movingMeanInitializer),movingVarianceInitializer:If(this.movingVarianceInitializer),betaRegularizer:Fm(this.betaRegularizer),gammaRegularizer:Fm(this.gammaRegularizer),betaConstraint:bh(this.betaConstraint),gammaConstraint:bh(this.gammaConstraint)},n=t.prototype.getConfig.call(this);return Object.assign(e,n),e},e.className="BatchNormalization",e}($f);yp.registerClass(Ag);var Rg=function(t){function e(e){var n=this;if(null==e&&(e={}),(n=t.call(this,e)||this).dataFormat=null==e.dataFormat?"channelsLast":e.dataFormat,null==e.padding)n.padding=[[1,1],[1,1]];else if("number"==typeof e.padding)n.padding=[[e.padding,e.padding],[e.padding,e.padding]];else{if(e.padding=e.padding,2!==e.padding.length)throw new Kp("ZeroPadding2D expects padding to be a length-2 array, but received a length-"+e.padding.length+" array.");var r=void 0,i=void 0;if("number"==typeof e.padding[0])r=[e.padding[0],e.padding[0]],i=[e.padding[1],e.padding[1]];else{if(e.padding=e.padding,2!==e.padding[0].length)throw new Kp("ZeroPadding2D expects height padding to be a length-2 array, but received a length-"+e.padding[0].length+" array.");if(r=e.padding[0],2!==e.padding[1].length)throw new Kp("ZeroPadding2D expects width padding to be a length-2 array, but received a length-"+e.padding[1].length+" array.");i=e.padding[1]}n.padding=[r,i]}return n.inputSpec=[new jf({ndim:4})],n}return Bp(e,t),e.prototype.computeOutputShape=function(t){var e,n;return t=Lf(t),"channelsFirst"===this.dataFormat?(e=null!=t[2]&&t[2]>=0?t[2]+this.padding[0][0]+this.padding[0][1]:null,n=null!=t[3]&&t[3]>=0?t[3]+this.padding[1][0]+this.padding[1][1]:null,[t[0],t[1],e,n]):(e=null!=t[1]&&t[1]>=0?t[1]+this.padding[0][0]+this.padding[0][1]:null,n=null!=t[2]&&t[2]>=0?t[2]+this.padding[1][0]+this.padding[1][1]:null,[t[0],e,n,t[3]])},e.prototype.call=function(t,e){var n=this;return Fe(function(){return function(t,e,n){return Fe(function(){if(4!==t.rank)throw new Kp("temporalPadding expects input tensor to be 4-D, but received a "+t.rank+"-D tensor.");if(null==e&&(e=[[1,1],[1,1]]),2!==e.length||2!==e[0].length||2!==e[1].length)throw new Kp("spatial2dPadding expects `padding` to be an Array of two Arrays, each of which is an Array of two integers.");if(null==n&&(n="channelsLast"),"channelsLast"!==n&&"channelsFirst"!==n)throw new Kp("Unknown data format: "+n+". Supported data formats are 'channelsLast' and 'channelsFirst.");var r;return r="channelsFirst"===n?[[0,0],[0,0],e[0],e[1]]:[[0,0],e[0],e[1],[0,0]],Xn(t,r)})}(zf(t),n.padding,n.dataFormat)})},e.prototype.getConfig=function(){var e={padding:this.padding,dataFormat:this.dataFormat},n=t.prototype.getConfig.call(this);return Object.assign(e,n),e},e.className="ZeroPadding2D",e}($f);function Tg(t,e,n,r,i,a){return Fe(function(){var o;Ah(i),Th(a),Rh(r),null==n&&(n=[1,1]),null==r&&(r="valid"),null==i&&(i="channelsLast"),null==a&&(a="max"),t=Gm(t,i);var s="same"===r?"same":"valid";return o="max"===a?qu(t,e,n,s):Hu(t,e,n,s),"channelsFirst"===i&&(o=vl(o,[0,3,1,2])),o})}function Dg(t,e,n,r,i,a){return Fe(function(){var o;Ah(i),Th(a),Rh(r),null==n&&(n=[1,1,1]),null==r&&(r="valid"),null==i&&(i="channelsLast"),null==a&&(a="max"),t=Km(t,i);var s="same"===r?"same":"valid";return o="max"===a?Ku(t,e,n,s):$u(t,e,n,s),"channelsFirst"===i&&(o=vl(o,[0,4,1,2,3])),o})}yp.registerClass(Rg);var Og=function(t){function e(e){var n=this;if(null==e.poolSize&&(e.poolSize=2),n=t.call(this,e)||this,"number"==typeof e.poolSize)n.poolSize=[e.poolSize];else{if(!Array.isArray(e.poolSize)||1!==e.poolSize.length||"number"!=typeof e.poolSize[0])throw new Kp("poolSize for 1D convolutional layer must be a number or an Array of a single number, but received "+JSON.stringify(e.poolSize));n.poolSize=e.poolSize}if(ph(n.poolSize,"poolSize"),null==e.strides)n.strides=n.poolSize;else if("number"==typeof e.strides)n.strides=[e.strides];else{if(!Array.isArray(e.strides)||1!==e.strides.length||"number"!=typeof e.strides[0])throw new Kp("strides for 1D convolutional layer must be a number or an Array of a single number, but received "+JSON.stringify(e.strides));n.strides=e.strides}return ph(n.strides,"strides"),n.padding=null==e.padding?"valid":e.padding,Rh(n.padding),n.inputSpec=[new jf({ndim:3})],n}return Bp(e,t),e.prototype.computeOutputShape=function(t){var e=qm((t=Lf(t))[1],this.poolSize[0],this.padding,this.strides[0]);return[t[0],e,t[2]]},e.prototype.call=function(t,e){var n=this;return Fe(function(){n.invokeCallHook(t,e),t=Hh(zf(t),2);var r=n.poolingFunction(zf(t),[n.poolSize[0],1],[n.strides[0],1],n.padding,"channelsLast");return or(r,[2])})},e.prototype.getConfig=function(){var e={poolSize:this.poolSize,padding:this.padding,strides:this.strides},n=t.prototype.getConfig.call(this);return Object.assign(e,n),e},e}($f),_g=function(t){function e(e){return t.call(this,e)||this}return Bp(e,t),e.prototype.poolingFunction=function(t,e,n,r,i){return Ah(i),Rh(r),Tg(t,e,n,r,i,"max")},e.className="MaxPooling1D",e}(Og);yp.registerClass(_g);var Fg=function(t){function e(e){return t.call(this,e)||this}return Bp(e,t),e.prototype.poolingFunction=function(t,e,n,r,i){return Ah(i),Rh(r),Tg(t,e,n,r,i,"avg")},e.className="AveragePooling1D",e}(Og);yp.registerClass(Fg);var Mg=function(t){function e(e){var n=this;if(null==e.poolSize&&(e.poolSize=[2,2]),(n=t.call(this,e)||this).poolSize=Array.isArray(e.poolSize)?e.poolSize:[e.poolSize,e.poolSize],null==e.strides)n.strides=n.poolSize;else if(Array.isArray(e.strides)){if(2!==e.strides.length)throw new Kp("If the strides property of a 2D pooling layer is an Array, it is expected to have a length of 2, but received length "+e.strides.length+".");n.strides=e.strides}else n.strides=[e.strides,e.strides];return ph(n.poolSize,"poolSize"),ph(n.strides,"strides"),n.padding=null==e.padding?"valid":e.padding,n.dataFormat=null==e.dataFormat?"channelsLast":e.dataFormat,Ah(n.dataFormat),Rh(n.padding),n.inputSpec=[new jf({ndim:4})],n}return Bp(e,t),e.prototype.computeOutputShape=function(t){t=Lf(t);var e="channelsFirst"===this.dataFormat?t[2]:t[1],n="channelsFirst"===this.dataFormat?t[3]:t[2];return e=qm(e,this.poolSize[0],this.padding,this.strides[0]),n=qm(n,this.poolSize[1],this.padding,this.strides[1]),"channelsFirst"===this.dataFormat?[t[0],t[1],e,n]:[t[0],e,n,t[3]]},e.prototype.call=function(t,e){var n=this;return Fe(function(){return n.invokeCallHook(t,e),n.poolingFunction(zf(t),n.poolSize,n.strides,n.padding,n.dataFormat)})},e.prototype.getConfig=function(){var e={poolSize:this.poolSize,padding:this.padding,strides:this.strides,dataFormat:this.dataFormat},n=t.prototype.getConfig.call(this);return Object.assign(e,n),e},e}($f),zg=function(t){function e(e){return t.call(this,e)||this}return Bp(e,t),e.prototype.poolingFunction=function(t,e,n,r,i){return Ah(i),Rh(r),Tg(t,e,n,r,i,"max")},e.className="MaxPooling2D",e}(Mg);yp.registerClass(zg);var Lg=function(t){function e(e){return t.call(this,e)||this}return Bp(e,t),e.prototype.poolingFunction=function(t,e,n,r,i){return Ah(i),Rh(r),Tg(t,e,n,r,i,"avg")},e.className="AveragePooling2D",e}(Mg);yp.registerClass(Lg);var Pg=function(t){function e(e){var n=this;if(null==e.poolSize&&(e.poolSize=[2,2,2]),(n=t.call(this,e)||this).poolSize=Array.isArray(e.poolSize)?e.poolSize:[e.poolSize,e.poolSize,e.poolSize],null==e.strides)n.strides=n.poolSize;else if(Array.isArray(e.strides)){if(3!==e.strides.length)throw new Kp("If the strides property of a 3D pooling layer is an Array, it is expected to have a length of 3, but received length "+e.strides.length+".");n.strides=e.strides}else n.strides=[e.strides,e.strides,e.strides];return ph(n.poolSize,"poolSize"),ph(n.strides,"strides"),n.padding=null==e.padding?"valid":e.padding,n.dataFormat=null==e.dataFormat?"channelsLast":e.dataFormat,Ah(n.dataFormat),Rh(n.padding),n.inputSpec=[new jf({ndim:5})],n}return Bp(e,t),e.prototype.computeOutputShape=function(t){t=Lf(t);var e="channelsFirst"===this.dataFormat?t[2]:t[1],n="channelsFirst"===this.dataFormat?t[3]:t[2],r="channelsFirst"===this.dataFormat?t[4]:t[3];return e=qm(e,this.poolSize[0],this.padding,this.strides[0]),n=qm(n,this.poolSize[1],this.padding,this.strides[1]),r=qm(r,this.poolSize[2],this.padding,this.strides[2]),"channelsFirst"===this.dataFormat?[t[0],t[1],e,n,r]:[t[0],e,n,r,t[4]]},e.prototype.call=function(t,e){var n=this;return Fe(function(){return n.invokeCallHook(t,e),n.poolingFunction(zf(t),n.poolSize,n.strides,n.padding,n.dataFormat)})},e.prototype.getConfig=function(){var e={poolSize:this.poolSize,padding:this.padding,strides:this.strides,dataFormat:this.dataFormat},n=t.prototype.getConfig.call(this);return Object.assign(e,n),e},e}($f),Bg=function(t){function e(e){return t.call(this,e)||this}return Bp(e,t),e.prototype.poolingFunction=function(t,e,n,r,i){return Ah(i),Rh(r),Dg(t,e,n,r,i,"max")},e.className="MaxPooling3D",e}(Pg);yp.registerClass(Bg);var Vg=function(t){function e(e){return t.call(this,e)||this}return Bp(e,t),e.prototype.poolingFunction=function(t,e,n,r,i){return Ah(i),Rh(r),Dg(t,e,n,r,i,"avg")},e.className="AveragePooling3D",e}(Pg);yp.registerClass(Vg);var Wg=function(t){function e(e){var n=t.call(this,e)||this;return n.inputSpec=[new jf({ndim:3})],n}return Bp(e,t),e.prototype.computeOutputShape=function(t){return[t[0],t[2]]},e.prototype.call=function(t,e){throw new $p},e}($f),Ug=function(t){function e(e){return t.call(this,e||{})||this}return Bp(e,t),e.prototype.call=function(t,e){return Fe(function(){var e=zf(t);return sl(e,1)})},e.className="GlobalAveragePooling1D",e}(Wg);yp.registerClass(Ug);var jg=function(t){function e(e){return t.call(this,e||{})||this}return Bp(e,t),e.prototype.call=function(t,e){return Fe(function(){var e=zf(t);return ol(e,1)})},e.className="GlobalMaxPooling1D",e}(Wg);yp.registerClass(jg);var qg=function(t){function e(e){var n=t.call(this,e)||this;return n.dataFormat=null==e.dataFormat?"channelsLast":e.dataFormat,Ah(n.dataFormat),n.inputSpec=[new jf({ndim:4})],n}return Bp(e,t),e.prototype.computeOutputShape=function(t){return t=t,"channelsLast"===this.dataFormat?[t[0],t[3]]:[t[0],t[1]]},e.prototype.call=function(t,e){throw new $p},e.prototype.getConfig=function(){var e={dataFormat:this.dataFormat},n=t.prototype.getConfig.call(this);return Object.assign(e,n),e},e}($f),Hg=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return Bp(e,t),e.prototype.call=function(t,e){var n=this;return Fe(function(){var e=zf(t);return"channelsLast"===n.dataFormat?sl(e,[1,2]):sl(e,[2,3])})},e.className="GlobalAveragePooling2D",e}(qg);yp.registerClass(Hg);var Gg=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return Bp(e,t),e.prototype.call=function(t,e){var n=this;return Fe(function(){var e=zf(t);return"channelsLast"===n.dataFormat?ol(e,[1,2]):ol(e,[2,3])})},e.className="GlobalMaxPooling2D",e}(qg);function Kg(t,e,n,r){if(Array.isArray(t)){if(null!=e||null!=n)throw new Kp("When inputs is an array, neither initialState or constants should be provided");null!=r&&(n=t.slice(t.length-r,t.length),t=t.slice(0,t.length-r)),t.length>1&&(e=t.slice(1,t.length)),t=t[0]}function i(t){return null==t||Array.isArray(t)?t:[t]}return{inputs:t,initialState:e=i(e),constants:n=i(n)}}function $g(t,e,n,r,i,a,o,s){return void 0===r&&(r=!1),void 0===o&&(o=!1),void 0===s&&(s=!1),Fe(function(){var u=e.shape.length;if(u<3)throw new Kp("Input should be at least 3D, but is "+u+"D.");var l=[1,0].concat(jh(2,u));if(e=vl(e,l),null!=a)throw new $p("The rnn() functoin of the deeplearn.js backend does not support constants yet.");o&&console.warn("Backend rnn(): the unroll = true option is not applicable to the imperative deeplearn.js backend."),null!=i&&((i=i.asType("bool").asType("float32")).rank===u-1&&(i=Hn(i,-1)),i=vl(i,l)),r&&(e=Lu(e,0),null!=i&&(i=Lu(i,0)));var c,p,h=[],f=n,d=e.shape[0],m=cr(e);null!=i&&(p=cr(i));for(var g,v=function(e){var n=m[e],r=Fe(function(){return t(n,f)});if(null==i)c=r[0],f=r[1];else{var a=Fe(function(){var t=p[e],n=yn(t).sub(t);return{output:r[0].mul(t).addStrict(f[0].mul(n)),newStates:f.map(function(e,i){return r[1][i].mul(t).addStrict(e.mul(n))})}});c=a.output,f=a.newStates}s&&h.push(c)},y=0;y<d;++y)v(y);return s&&(g=sr(h,1)),[c,g,f]})}yp.registerClass(Gg);var Xg=function(t){function e(e){var n,r=t.call(this,e)||this;if(null==e.cell)throw new Kp("cell property is missing for the constructor of RNN.");if(null==(n=Array.isArray(e.cell)?new rv({cells:e.cell}):e.cell).stateSize)throw new Kp("The RNN cell should have an attribute `stateSize` (tuple of integers, one integer per RNN state).");return r.cell=n,r.returnSequences=null!=e.returnSequences&&e.returnSequences,r.returnState=null!=e.returnState&&e.returnState,r.goBackwards=null!=e.goBackwards&&e.goBackwards,r._stateful=null!=e.stateful&&e.stateful,r.unroll=null!=e.unroll&&e.unroll,r.supportsMasking=!0,r.inputSpec=[new jf({ndim:3})],r.stateSpec=null,r.states_=null,r.numConstants=null,r.keptStates=[],r}return Bp(e,t),e.prototype.getStates=function(){return null==this.states_?jh(0,Array.isArray(this.cell.stateSize)?this.cell.stateSize.length:1).map(function(t){return null}):this.states_},e.prototype.setStates=function(t){this.states_=t},e.prototype.computeOutputShape=function(t){Ff(t)&&(t=t[0]),t=t;var e=this.cell.stateSize;Array.isArray(e)||(e=[e]);var n,r=e[0];if(n=this.returnSequences?[t[0],t[1],r]:[t[0],r],this.returnState){for(var i=[],a=0,o=e;a<o.length;a++){var s=o[a];i.push([t[0],s])}return[n].concat(i)}return n},e.prototype.computeMask=function(t,e){var n=this;return Fe(function(){Array.isArray(e)&&(e=e[0]);var t=n.returnSequences?e:null;if(n.returnState){var r=n.states.map(function(t){return null});return[t].concat(r)}return t})},Object.defineProperty(e.prototype,"states",{get:function(){if(null==this.states_){for(var t=Array.isArray(this.cell.stateSize)?this.cell.stateSize.length:1,e=[],n=0;n<t;++n)e.push(null);return e}return this.states_},set:function(t){this.states_=t},enumerable:!0,configurable:!0}),e.prototype.build=function(t){if(null!=this.numConstants)throw new $p("Constants support is not implemented in RNN yet.");Ff(t)&&(t=t[0]),t=t;var e=this.stateful?t[0]:null,n=t[t.length-1];this.inputSpec[0]=new jf({shape:[e,null,n]});var r,i=[t[0]].concat(t.slice(2));if(this.cell.build(i),r=Array.isArray(this.cell.stateSize)?this.cell.stateSize:[this.cell.stateSize],null!=this.stateSpec){if(!J.arraysEqual(this.stateSpec.map(function(t){return t.shape[t.shape.length-1]}),r))throw new Kp("An initialState was passed that is not compatible with cell.stateSize. Received stateSpec="+this.stateSpec+"; However cell.stateSize is "+this.cell.stateSize)}else this.stateSpec=r.map(function(t){return new jf({shape:[null,t]})});this.stateful&&this.resetStates()},e.prototype.resetStates=function(t,e){var n=this;void 0===e&&(e=!1),Fe(function(){if(!n.stateful)throw new Hp("Cannot call resetStates() on an RNN Layer that is not stateful.");var r=n.inputSpec[0].shape[0];if(null==r)throw new Kp("If an RNN is stateful, it needs to know its batch size. Specify the batch size of your input tensors: \n- If using a Sequential model, specify the batch size by passing a `batchInputShape` option to your first layer.\n- If using the functional API, specify the batch size by passing a `batchShape` option to your Input layer.");if(null==n.states_)Array.isArray(n.cell.stateSize)?n.states_=n.cell.stateSize.map(function(t){return dn([r,t])}):n.states_=[dn([r,n.cell.stateSize])];else if(null==t)Me(n.states_),null!=n.keptStates&&(Me(n.keptStates),n.keptStates=[]),Array.isArray(n.cell.stateSize)?n.states_=n.cell.stateSize.map(function(t){return dn([r,t])}):n.states_[0]=dn([r,n.cell.stateSize]);else{if(Array.isArray(t)||(t=[t]),t.length!==n.states_.length)throw new Kp("Layer "+n.name+" expects "+n.states_.length+" state(s), but it received "+t.length+" state value(s). Input received: "+t);!0===e?n.keptStates.push(n.states_.slice()):Me(n.states_);for(var i=0;i<n.states_.length;++i){var a=t[i],o=Array.isArray(n.cell.stateSize)?n.cell.stateSize[i]:n.cell.stateSize,s=[r,o];if(!J.arraysEqual(a.shape,s))throw new Kp("State "+i+" is incompatible with layer "+n.name+": expected shape="+s+", received shape="+a.shape);n.states_[i]=a}}n.states_=n.states_.map(function(t){return ze(t.clone())})})},e.prototype.apply=function(e,n){var r=null==n?null:n.initialState,i=null==n?null:n.constants;null==n&&(n={});var a=Kg(e,r,i,this.numConstants);e=a.inputs,r=a.initialState,i=a.constants;var o=[],s=[];if(null!=r){n.initialState=r,o=o.concat(r),this.stateSpec=[];for(var u=0,l=r;u<l.length;u++){var c=l[u];this.stateSpec.push(new jf({shape:c.shape}))}s=s.concat(this.stateSpec)}if(null!=i&&(n.constants=i,o=o.concat(i),this.numConstants=i.length),o[0]instanceof qf){var p=[e].concat(o),h=this.inputSpec.concat(s),f=this.inputSpec;this.inputSpec=h;var d=t.prototype.apply.call(this,p,n);return this.inputSpec=f,d}return t.prototype.apply.call(this,e,n)},e.prototype.call=function(t,e){var n=this;return Fe(function(){var r=null==e?null:e.mask,i=null==e?null:e.training,a=null==e?null:e.initialState;t=zf(t),null==a&&(a=n.stateful?n.states_:n.getInitialState(t));var o=Array.isArray(n.cell.stateSize)?n.cell.stateSize.length:1;if(a.length!==o)throw new Kp("RNN Layer has "+o+" state(s) but was passed "+a.length+" initial state(s).");n.unroll&&console.warn("Ignoring unroll = true for RNN layer, due to imperative backend.");var s={training:i},u=$g(function(t,e){var r=n.cell.call([t].concat(e),s);return[r[0],r.slice(1)]},t,a,n.goBackwards,r,null,n.unroll,n.returnSequences),l=u[0],c=u[1],p=u[2];n.stateful&&n.resetStates(p,i);var h=n.returnSequences?c:l;return n.returnState?[h].concat(p):h})},e.prototype.getInitialState=function(t){var e=this;return Fe(function(){var n=dn(t.shape);return n=Hh(n=cl(n,[1,2])),Array.isArray(e.cell.stateSize)?e.cell.stateSize.map(function(t){return t>1?Jh(n,[1,t]):n}):e.cell.stateSize>1?[Jh(n,[1,e.cell.stateSize])]:[n]})},Object.defineProperty(e.prototype,"trainableWeights",{get:function(){return this.trainable?this.cell.trainableWeights:[]},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"nonTrainableWeights",{get:function(){return this.trainable?this.cell.nonTrainableWeights:this.cell.weights},enumerable:!0,configurable:!0}),e.prototype.setFastWeightInitDuringBuild=function(e){t.prototype.setFastWeightInitDuringBuild.call(this,e),null!=this.cell&&this.cell.setFastWeightInitDuringBuild(e)},e.prototype.getConfig=function(){var e={returnSequences:this.returnSequences,returnState:this.returnState,goBackwards:this.goBackwards,stateful:this.stateful,unroll:this.unroll};null!=this.numConstants&&(e.numConstants=this.numConstants);var n=this.cell.getConfig();e.cell={className:this.cell.getClassName(),config:n};var r=t.prototype.getConfig.call(this);return Object.assign(e,r),e},e.fromConfig=function(t,e,n){void 0===n&&(n={});var r=ld(e.cell,n);return new t(Object.assign(e,{cell:r}))},e.className="RNN",e}($f);yp.registerClass(Xg);var Yg=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return Bp(e,t),e}($f),Jg=function(t){function e(e){var n=t.call(this,e)||this;return n.DEFAULT_ACTIVATION="tanh",n.DEFAULT_KERNEL_INITIALIZER="glorotNormal",n.DEFAULT_RECURRENT_INITIALIZER="orthogonal",n.DEFAULT_BIAS_INITIALIZER="zeros",n.units=e.units,ph(n.units,"units"),n.activation=Rm(null==e.activation?n.DEFAULT_ACTIVATION:e.activation),n.useBias=null==e.useBias||e.useBias,n.kernelInitializer=Af(e.kernelInitializer||n.DEFAULT_KERNEL_INITIALIZER),n.recurrentInitializer=Af(e.recurrentInitializer||n.DEFAULT_RECURRENT_INITIALIZER),n.biasInitializer=Af(e.biasInitializer||n.DEFAULT_BIAS_INITIALIZER),n.kernelRegularizer=zm(e.kernelRegularizer),n.recurrentRegularizer=zm(e.recurrentRegularizer),n.biasRegularizer=zm(e.biasRegularizer),n.kernelConstraint=wh(e.kernelConstraint),n.recurrentConstraint=wh(e.recurrentConstraint),n.biasConstraint=wh(e.biasConstraint),n.dropout=Wh([1,Uh([0,null==e.dropout?0:e.dropout])]),n.recurrentDropout=Wh([1,Uh([0,null==e.recurrentDropout?0:e.recurrentDropout])]),n.stateSize=n.units,n.dropoutMask=null,n.recurrentDropoutMask=null,n}return Bp(e,t),e.prototype.build=function(t){t=Lf(t),this.kernel=this.addWeight("kernel",[t[t.length-1],this.units],null,this.kernelInitializer,this.kernelRegularizer,!0,this.kernelConstraint),this.recurrentKernel=this.addWeight("recurrent_kernel",[this.units,this.units],null,this.recurrentInitializer,this.recurrentRegularizer,!0,this.recurrentConstraint),this.useBias?this.bias=this.addWeight("bias",[this.units],null,this.biasInitializer,this.biasRegularizer,!0,this.biasConstraint):this.bias=null,this.built=!0},e.prototype.call=function(t,e){var n=this;return Fe(function(){if(2!==(t=t).length)throw new Kp("SimpleRNNCell expects 2 input Tensors, got "+t.length+".");var r=t[1];t=t[0];var i,a=null!=e.training&&e.training;0<n.dropout&&n.dropout<1&&null==n.dropoutMask&&(n.dropoutMask=iv(function(){return yn(t)},n.dropout,a)),0<n.recurrentDropout&&n.recurrentDropout<1&&null==n.recurrentDropoutMask&&(n.recurrentDropoutMask=iv(function(){return yn(r)},n.recurrentDropout,a));var o=n.dropoutMask,s=n.recurrentDropoutMask;i=Qh(null!=o?Ys(t,o):t,n.kernel.read()),null!=n.bias&&(i=rf(i,n.bias.read())),null!=s&&(r=Ys(r,s));var u=Ls(i,Qh(r,n.recurrentKernel.read()));return null!=n.activation&&(u=n.activation.apply(u)),[u,u]})},e.prototype.getConfig=function(){var e={units:this.units,activation:Im(this.activation),useBias:this.useBias,kernelInitializer:If(this.kernelInitializer),recurrentInitializer:If(this.recurrentInitializer),biasInitializer:If(this.biasInitializer),kernelRegularizer:Fm(this.kernelRegularizer),recurrentRegularizer:Fm(this.recurrentRegularizer),biasRegularizer:Fm(this.biasRegularizer),activityRegularizer:Fm(this.activityRegularizer),kernelConstraint:bh(this.kernelConstraint),recurrentConstraint:bh(this.recurrentConstraint),biasConstraint:bh(this.biasConstraint),dropout:this.dropout,recurrentDropout:this.recurrentDropout},n=t.prototype.getConfig.call(this);return Object.assign(e,n),e},e.className="SimpleRNNCell",e}(Yg);yp.registerClass(Jg);var Zg=function(t){function e(e){return e.cell=new Jg(e),t.call(this,e)||this}return Bp(e,t),e.prototype.call=function(e,n){var r=this;return Fe(function(){null!=r.cell.dropoutMask&&(Me(r.cell.dropoutMask),r.cell.dropoutMask=null),null!=r.cell.recurrentDropoutMask&&(Me(r.cell.recurrentDropoutMask),r.cell.recurrentDropoutMask=null);var i=null==n?null:n.mask,a=null==n?null:n.training,o=null==n?null:n.initialState;return t.prototype.call.call(r,e,{mask:i,training:a,initialState:o})})},Object.defineProperty(e.prototype,"units",{get:function(){return this.cell.units},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"activation",{get:function(){return this.cell.activation},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"useBias",{get:function(){return this.cell.useBias},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"kernelInitializer",{get:function(){return this.cell.kernelInitializer},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"recurrentInitializer",{get:function(){return this.cell.recurrentInitializer},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"biasInitializer",{get:function(){return this.cell.biasInitializer},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"kernelRegularizer",{get:function(){return this.cell.kernelRegularizer},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"recurrentRegularizer",{get:function(){return this.cell.recurrentRegularizer},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"biasRegularizer",{get:function(){return this.cell.biasRegularizer},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"kernelConstraint",{get:function(){return this.cell.kernelConstraint},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"recurrentConstraint",{get:function(){return this.cell.recurrentConstraint},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"biasConstraint",{get:function(){return this.cell.biasConstraint},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"dropout",{get:function(){return this.cell.dropout},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"recurrentDropout",{get:function(){return this.cell.recurrentDropout},enumerable:!0,configurable:!0}),e.prototype.getConfig=function(){var e={units:this.units,activation:Im(this.activation),useBias:this.useBias,kernelInitializer:If(this.kernelInitializer),recurrentInitializer:If(this.recurrentInitializer),biasInitializer:If(this.biasInitializer),kernelRegularizer:Fm(this.kernelRegularizer),recurrentRegularizer:Fm(this.recurrentRegularizer),biasRegularizer:Fm(this.biasRegularizer),activityRegularizer:Fm(this.activityRegularizer),kernelConstraint:bh(this.kernelConstraint),recurrentConstraint:bh(this.recurrentConstraint),biasConstraint:bh(this.biasConstraint),dropout:this.dropout,recurrentDropout:this.recurrentDropout},n=t.prototype.getConfig.call(this);return delete n.cell,Object.assign(e,n),e},e.fromConfig=function(t,e){return new t(e)},e.className="SimpleRNN",e}(Xg);yp.registerClass(Zg);var Qg=function(t){function e(e){var n=t.call(this,e)||this;return n.DEFAULT_ACTIVATION="tanh",n.DEFAULT_RECURRENT_ACTIVATION="hardSigmoid",n.DEFAULT_KERNEL_INITIALIZER="glorotNormal",n.DEFAULT_RECURRENT_INITIALIZER="orthogonal",n.DEFAULT_BIAS_INITIALIZER="zeros",n.units=e.units,ph(n.units,"units"),n.activation=Rm(void 0===e.activation?n.DEFAULT_ACTIVATION:e.activation),n.recurrentActivation=Rm(void 0===e.recurrentActivation?n.DEFAULT_RECURRENT_ACTIVATION:e.recurrentActivation),n.useBias=null==e.useBias||e.useBias,n.kernelInitializer=Af(e.kernelInitializer||n.DEFAULT_KERNEL_INITIALIZER),n.recurrentInitializer=Af(e.recurrentInitializer||n.DEFAULT_RECURRENT_INITIALIZER),n.biasInitializer=Af(e.biasInitializer||n.DEFAULT_BIAS_INITIALIZER),n.kernelRegularizer=zm(e.kernelRegularizer),n.recurrentRegularizer=zm(e.recurrentRegularizer),n.biasRegularizer=zm(e.biasRegularizer),n.kernelConstraint=wh(e.kernelConstraint),n.recurrentConstraint=wh(e.recurrentConstraint),n.biasConstraint=wh(e.biasConstraint),n.dropout=Wh([1,Uh([0,null==e.dropout?0:e.dropout])]),n.recurrentDropout=Wh([1,Uh([0,null==e.recurrentDropout?0:e.recurrentDropout])]),n.implementation=e.implementation,n.stateSize=n.units,n.dropoutMask=null,n.recurrentDropoutMask=null,n}return Bp(e,t),e.prototype.build=function(t){var e=(t=Lf(t))[t.length-1];this.kernel=this.addWeight("kernel",[e,3*this.units],null,this.kernelInitializer,this.kernelRegularizer,!0,this.kernelConstraint),this.recurrentKernel=this.addWeight("recurrent_kernel",[this.units,3*this.units],null,this.recurrentInitializer,this.recurrentRegularizer,!0,this.recurrentConstraint),this.useBias?this.bias=this.addWeight("bias",[3*this.units],null,this.biasInitializer,this.biasRegularizer,!0,this.biasConstraint):this.bias=null,this.built=!0},e.prototype.call=function(t,e){var n=this;return Fe(function(){if(2!==(t=t).length)throw new Kp("GRUCell expects 2 input Tensors (inputs, h, c), got "+t.length+".");var r=null!=e.training&&e.training,i=t[1];t=t[0],0<n.dropout&&n.dropout<1&&null==n.dropoutMask&&(n.dropoutMask=iv(function(){return yn(t)},n.dropout,r,3)),0<n.recurrentDropout&&n.recurrentDropout<1&&null==n.recurrentDropoutMask&&(n.recurrentDropoutMask=iv(function(){return yn(i)},n.recurrentDropout,r,3));var a,o,s,u=n.dropoutMask,l=n.recurrentDropoutMask;0<n.dropout&&n.dropout<1&&(t=Ys(t,u[0]));var c=Qh(t,n.kernel.read());n.useBias&&(c=rf(c,n.bias.read())),0<n.recurrentDropout&&n.recurrentDropout<1&&(i=Ys(i,l[0]));var p=n.recurrentKernel.read(),h=Sn(p,[2*n.units,n.units],p.rank-1),f=h[0],d=h[1],m=Qh(i,f),g=Sn(c,3,c.rank-1),v=g[0],y=g[1],b=g[2],x=Sn(m,2,m.rank-1),w=x[0],N=x[1];a=n.recurrentActivation.apply(Ls(v,w)),o=n.recurrentActivation.apply(Ls(y,N));var C=Qh(Ys(o,i),d);s=n.activation.apply(Ls(b,C));var E=Ls(Ys(a,i),Ys(Ls(1,ts(a)),s));return[E,E]})},e.prototype.getConfig=function(){var e={units:this.units,activation:Im(this.activation),recurrentActivation:Im(this.recurrentActivation),useBias:this.useBias,kernelInitializer:If(this.kernelInitializer),recurrentInitializer:If(this.recurrentInitializer),biasInitializer:If(this.biasInitializer),kernelRegularizer:Fm(this.kernelRegularizer),recurrentRegularizer:Fm(this.recurrentRegularizer),biasRegularizer:Fm(this.biasRegularizer),activityRegularizer:Fm(this.activityRegularizer),kernelConstraint:bh(this.kernelConstraint),recurrentConstraint:bh(this.recurrentConstraint),biasConstraint:bh(this.biasConstraint),dropout:this.dropout,recurrentDropout:this.recurrentDropout,implementation:this.implementation},n=t.prototype.getConfig.call(this);return Object.assign(e,n),e},e.className="GRUCell",e}(Yg);yp.registerClass(Qg);var tv=function(t){function e(e){return 0===e.implementation&&console.warn("`implementation=0` has been deprecated, and now defaults to `implementation=1`. Please update your layer call."),e.cell=new Qg(e),t.call(this,e)||this}return Bp(e,t),e.prototype.call=function(e,n){var r=this;return Fe(function(){null!=r.cell.dropoutMask&&(Me(r.cell.dropoutMask),r.cell.dropoutMask=null),null!=r.cell.recurrentDropoutMask&&(Me(r.cell.recurrentDropoutMask),r.cell.recurrentDropoutMask=null);var i=null==n?null:n.mask,a=null==n?null:n.training,o=null==n?null:n.initialState;return t.prototype.call.call(r,e,{mask:i,training:a,initialState:o})})},Object.defineProperty(e.prototype,"units",{get:function(){return this.cell.units},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"activation",{get:function(){return this.cell.activation},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"recurrentActivation",{get:function(){return this.cell.recurrentActivation},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"useBias",{get:function(){return this.cell.useBias},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"kernelInitializer",{get:function(){return this.cell.kernelInitializer},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"recurrentInitializer",{get:function(){return this.cell.recurrentInitializer},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"biasInitializer",{get:function(){return this.cell.biasInitializer},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"kernelRegularizer",{get:function(){return this.cell.kernelRegularizer},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"recurrentRegularizer",{get:function(){return this.cell.recurrentRegularizer},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"biasRegularizer",{get:function(){return this.cell.biasRegularizer},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"kernelConstraint",{get:function(){return this.cell.kernelConstraint},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"recurrentConstraint",{get:function(){return this.cell.recurrentConstraint},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"biasConstraint",{get:function(){return this.cell.biasConstraint},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"dropout",{get:function(){return this.cell.dropout},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"recurrentDropout",{get:function(){return this.cell.recurrentDropout},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"implementation",{get:function(){return this.cell.implementation},enumerable:!0,configurable:!0}),e.prototype.getConfig=function(){var e={units:this.units,activation:Im(this.activation),recurrentActivation:Im(this.recurrentActivation),useBias:this.useBias,kernelInitializer:If(this.kernelInitializer),recurrentInitializer:If(this.recurrentInitializer),biasInitializer:If(this.biasInitializer),kernelRegularizer:Fm(this.kernelRegularizer),recurrentRegularizer:Fm(this.recurrentRegularizer),biasRegularizer:Fm(this.biasRegularizer),activityRegularizer:Fm(this.activityRegularizer),kernelConstraint:bh(this.kernelConstraint),recurrentConstraint:bh(this.recurrentConstraint),biasConstraint:bh(this.biasConstraint),dropout:this.dropout,recurrentDropout:this.recurrentDropout,implementation:this.implementation},n=t.prototype.getConfig.call(this);return delete n.cell,Object.assign(e,n),e},e.fromConfig=function(t,e){return 0===e.implmentation&&(e.implementation=1),new t(e)},e.className="GRU",e}(Xg);yp.registerClass(tv);var ev=function(t){function e(e){var n=t.call(this,e)||this;return n.DEFAULT_ACTIVATION="tanh",n.DEFAULT_RECURRENT_ACTIVATION="hardSigmoid",n.DEFAULT_KERNEL_INITIALIZER="glorotNormal",n.DEFAULT_RECURRENT_INITIALIZER="orthogonal",n.DEFAULT_BIAS_INITIALIZER="zeros",n.units=e.units,ph(n.units,"units"),n.activation=Rm(void 0===e.activation?n.DEFAULT_ACTIVATION:e.activation),n.recurrentActivation=Rm(void 0===e.recurrentActivation?n.DEFAULT_RECURRENT_ACTIVATION:e.recurrentActivation),n.useBias=null==e.useBias||e.useBias,n.kernelInitializer=Af(e.kernelInitializer||n.DEFAULT_KERNEL_INITIALIZER),n.recurrentInitializer=Af(e.recurrentInitializer||n.DEFAULT_RECURRENT_INITIALIZER),n.biasInitializer=Af(e.biasInitializer||n.DEFAULT_BIAS_INITIALIZER),n.unitForgetBias=e.unitForgetBias,n.kernelRegularizer=zm(e.kernelRegularizer),n.recurrentRegularizer=zm(e.recurrentRegularizer),n.biasRegularizer=zm(e.biasRegularizer),n.kernelConstraint=wh(e.kernelConstraint),n.recurrentConstraint=wh(e.recurrentConstraint),n.biasConstraint=wh(e.biasConstraint),n.dropout=Wh([1,Uh([0,null==e.dropout?0:e.dropout])]),n.recurrentDropout=Wh([1,Uh([0,null==e.recurrentDropout?0:e.recurrentDropout])]),n.implementation=e.implementation,n.stateSize=[n.units,n.units],n.dropoutMask=null,n.recurrentDropoutMask=null,n}return Bp(e,t),e.prototype.build=function(t){var e,n,r=(t=Lf(t))[t.length-1];if(this.kernel=this.addWeight("kernel",[r,4*this.units],null,this.kernelInitializer,this.kernelRegularizer,!0,this.kernelConstraint),this.recurrentKernel=this.addWeight("recurrent_kernel",[this.units,4*this.units],null,this.recurrentInitializer,this.recurrentRegularizer,!0,this.recurrentConstraint),this.useBias){if(this.unitForgetBias){var i=this.biasInitializer,a=this.units;n=new((e=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return Bp(e,t),e.prototype.apply=function(t,e){var n=i.apply([a]),r=(new pf).apply([a]),o=i.apply([2*a]);return Yh(Yh(n,r),o)},e}(lf)).className="CustomInit",e)}else n=this.biasInitializer;this.bias=this.addWeight("bias",[4*this.units],null,n,this.biasRegularizer,!0,this.biasConstraint)}else this.bias=null;this.built=!0},e.prototype.call=function(t,e){var n=this;return Fe(function(){var r=null!=e.training&&e.training;if(3!==(t=t).length)throw new Kp("LSTMCell expects 3 input Tensors (inputs, h, c), got "+t.length+".");var i=t[1],a=t[2];t=t[0],0<n.dropout&&n.dropout<1&&null==n.dropoutMask&&(n.dropoutMask=iv(function(){return yn(t)},n.dropout,r,4)),0<n.recurrentDropout&&n.recurrentDropout<1&&null==n.recurrentDropoutMask&&(n.recurrentDropoutMask=iv(function(){return yn(i)},n.recurrentDropout,r,4));var o,s,u,l,c=n.dropoutMask,p=n.recurrentDropoutMask;0<n.dropout&&n.dropout<1&&(t=Ys(t,c[0]));var h=Qh(t,n.kernel.read());0<n.recurrentDropout&&n.recurrentDropout<1&&(i=Ys(i,p[0])),h=Ls(h,Qh(i,n.recurrentKernel.read())),n.useBias&&(h=rf(h,n.bias.read()));var f=Sn(h,4,h.rank-1),d=f[0],m=f[1],g=f[2],v=f[3];o=n.recurrentActivation.apply(d),s=n.recurrentActivation.apply(m),u=Ls(Ys(s,a),Ys(o,n.activation.apply(g))),l=n.recurrentActivation.apply(v);var y=Ys(l,n.activation.apply(u));return[y,y,u]})},e.prototype.getConfig=function(){var e={units:this.units,activation:Im(this.activation),recurrentActivation:Im(this.recurrentActivation),useBias:this.useBias,kernelInitializer:If(this.kernelInitializer),recurrentInitializer:If(this.recurrentInitializer),biasInitializer:If(this.biasInitializer),unitForgetBias:this.unitForgetBias,kernelRegularizer:Fm(this.kernelRegularizer),recurrentRegularizer:Fm(this.recurrentRegularizer),biasRegularizer:Fm(this.biasRegularizer),activityRegularizer:Fm(this.activityRegularizer),kernelConstraint:bh(this.kernelConstraint),recurrentConstraint:bh(this.recurrentConstraint),biasConstraint:bh(this.biasConstraint),dropout:this.dropout,recurrentDropout:this.recurrentDropout,implementation:this.implementation},n=t.prototype.getConfig.call(this);return Object.assign(e,n),e},e.className="LSTMCell",e}(Yg);yp.registerClass(ev);var nv=function(t){function e(e){return 0===e.implementation&&console.warn("`implementation=0` has been deprecated, and now defaults to `implementation=1`. Please update your layer call."),e.cell=new ev(e),t.call(this,e)||this}return Bp(e,t),e.prototype.call=function(e,n){var r=this;return Fe(function(){null!=r.cell.dropoutMask&&(Me(r.cell.dropoutMask),r.cell.dropoutMask=null),null!=r.cell.recurrentDropoutMask&&(Me(r.cell.recurrentDropoutMask),r.cell.recurrentDropoutMask=null);var i=null==n?null:n.mask,a=null==n?null:n.training,o=null==n?null:n.initialState;return t.prototype.call.call(r,e,{mask:i,training:a,initialState:o})})},Object.defineProperty(e.prototype,"units",{get:function(){return this.cell.units},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"activation",{get:function(){return this.cell.activation},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"recurrentActivation",{get:function(){return this.cell.recurrentActivation},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"useBias",{get:function(){return this.cell.useBias},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"kernelInitializer",{get:function(){return this.cell.kernelInitializer},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"recurrentInitializer",{get:function(){return this.cell.recurrentInitializer},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"biasInitializer",{get:function(){return this.cell.biasInitializer},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"unitForgetBias",{get:function(){return this.cell.unitForgetBias},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"kernelRegularizer",{get:function(){return this.cell.kernelRegularizer},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"recurrentRegularizer",{get:function(){return this.cell.recurrentRegularizer},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"biasRegularizer",{get:function(){return this.cell.biasRegularizer},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"kernelConstraint",{get:function(){return this.cell.kernelConstraint},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"recurrentConstraint",{get:function(){return this.cell.recurrentConstraint},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"biasConstraint",{get:function(){return this.cell.biasConstraint},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"dropout",{get:function(){return this.cell.dropout},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"recurrentDropout",{get:function(){return this.cell.recurrentDropout},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"implementation",{get:function(){return this.cell.implementation},enumerable:!0,configurable:!0}),e.prototype.getConfig=function(){var e={units:this.units,activation:Im(this.activation),recurrentActivation:Im(this.recurrentActivation),useBias:this.useBias,kernelInitializer:If(this.kernelInitializer),recurrentInitializer:If(this.recurrentInitializer),biasInitializer:If(this.biasInitializer),unitForgetBias:this.unitForgetBias,kernelRegularizer:Fm(this.kernelRegularizer),recurrentRegularizer:Fm(this.recurrentRegularizer),biasRegularizer:Fm(this.biasRegularizer),activityRegularizer:Fm(this.activityRegularizer),kernelConstraint:bh(this.kernelConstraint),recurrentConstraint:bh(this.recurrentConstraint),biasConstraint:bh(this.biasConstraint),dropout:this.dropout,recurrentDropout:this.recurrentDropout,implementation:this.implementation},n=t.prototype.getConfig.call(this);return delete n.cell,Object.assign(e,n),e},e.fromConfig=function(t,e){return 0===e.implmentation&&(e.implementation=1),new t(e)},e.className="LSTM",e}(Xg);yp.registerClass(nv);var rv=function(t){function e(e){var n=t.call(this,e)||this;return n.cells=e.cells,n}return Bp(e,t),Object.defineProperty(e.prototype,"stateSize",{get:function(){for(var t=[],e=0,n=this.cells.slice().reverse();e<n.length;e++){var r=n[e];Array.isArray(r.stateSize)?t.push.apply(t,r.stateSize):t.push(r.stateSize)}return t},enumerable:!0,configurable:!0}),e.prototype.call=function(t,e){var n=this;return Fe(function(){for(var r=(t=t).slice(1),i=[],a=0,o=n.cells.slice().reverse();a<o.length;a++){var s=o[a];Array.isArray(s.stateSize)?i.push(r.splice(0,s.stateSize.length)):i.push(r.splice(0,1))}i.reverse();for(var u,l=[],c=0;c<n.cells.length;++c)s=n.cells[c],r=i[c],u=0===c?[t[0]].concat(r):[u[0]].concat(r),u=s.call(u,e),l.push(u.slice(1));r=[];for(var p=0,h=l.slice().reverse();p<h.length;p++){var f=h[p];r.push.apply(r,f)}return[u[0]].concat(r)})},e.prototype.build=function(t){var e;Ff(t)&&(t=t[0]),t=t;for(var n=0,r=this.cells;n<r.length;n++){var i=r[n];i.build(t),e=Array.isArray(i.stateSize)?i.stateSize[0]:i.stateSize,t=[t[0],e]}this.built=!0},e.prototype.getConfig=function(){for(var e=[],n=0,r=this.cells;n<r.length;n++){var i=r[n];e.push({className:i.getClassName(),config:i.getConfig()})}var a={cells:e},o=t.prototype.getConfig.call(this);return Object.assign(a,o),a},e.fromConfig=function(t,e,n){void 0===n&&(n={});for(var r=[],i=0,a=e.cells;i<a.length;i++){var o=a[i];r.push(ld(o,n))}return new t({cells:r})},Object.defineProperty(e.prototype,"trainableWeights",{get:function(){if(!this.trainable)return[];for(var t=[],e=0,n=this.cells;e<n.length;e++){var r=n[e];t.push.apply(t,r.trainableWeights)}return t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"nonTrainableWeights",{get:function(){for(var t=[],e=0,n=this.cells;e<n.length;e++){var r=n[e];t.push.apply(t,r.nonTrainableWeights)}if(!this.trainable){for(var i=[],a=0,o=this.cells;a<o.length;a++)r=o[a],i.push.apply(i,r.trainableWeights);return i.concat(t)}return t},enumerable:!0,configurable:!0}),e.prototype.getWeights=function(){for(var t=[],e=0,n=this.cells;e<n.length;e++){var r=n[e];t.push.apply(t,r.weights)}return Wf(t)},e.prototype.setWeights=function(t){for(var e=[],n=0,r=this.cells;n<r.length;n++)for(var i=r[n],a=i.weights.length,o=t.splice(a),s=0;s<i.weights.length;++s)e.push([i.weights[s],o[s]]);Uf(e)},e.className="StackedRNNCells",e}(Yg);function iv(t,e,n,r){function i(){return af(t(),e)}if(void 0===n&&(n=null),void 0===r&&(r=1),r>1){for(var a=[],o=0;o<r;o++)a.push(of(i,t,n));return a.map(function(t){return ze(t.clone())})}return ze(of(i,t,n).clone())}yp.registerClass(rv);var av=function(t){function e(e){var n=t.call(this,e)||this;return n.layer=e.layer,n}return Bp(e,t),e.prototype.build=function(t){this.built=!0},Object.defineProperty(e.prototype,"trainable",{get:function(){return null!=this.layer&&this.layer.trainable},set:function(t){null!=this.layer&&(this.layer.trainable=t)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"trainableWeights",{get:function(){return this.layer.trainableWeights},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"nonTrainableWeights",{get:function(){return this.layer.nonTrainableWeights},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"updates",{get:function(){return this.layer._updates},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"losses",{get:function(){return this.layer.losses},enumerable:!0,configurable:!0}),e.prototype.getWeights=function(){return this.layer.getWeights()},e.prototype.setWeights=function(t){this.layer.setWeights(t)},e.prototype.getConfig=function(){var e={layer:{className:this.layer.getClassName(),config:this.layer.getConfig()}},n=t.prototype.getConfig.call(this);return Object.assign(e,n),e},e.prototype.setFastWeightInitDuringBuild=function(e){t.prototype.setFastWeightInitDuringBuild.call(this,e),null!=this.layer&&this.layer.setFastWeightInitDuringBuild(e)},e.fromConfig=function(t,e,n){void 0===n&&(n={});var r=ld(e.layer,n);delete e.layer;var i={layer:r};return Object.assign(i,e),new t(i)},e}($f),ov=function(t){function e(e){var n=t.call(this,e)||this;return n.supportsMasking=!0,n}return Bp(e,t),e.prototype.build=function(e){if((e=Lf(e)).length<3)throw new Kp("TimeDistributed layer expects an input shape >= 3D, but received input shape "+JSON.stringify(e));this.inputSpec=[{shape:e}];var n=[e[0]].concat(e.slice(2));this.layer.built||(this.layer.build(n),this.layer.built=!0),t.prototype.build.call(this,e)},e.prototype.computeOutputShape=function(t){var e=[(t=Lf(t))[0]].concat(t.slice(2)),n=this.layer.computeOutputShape(e),r=t[1];return[n[0],r].concat(n.slice(1))},e.prototype.call=function(t,e){var n=this;return Fe(function(){return $g(function(t,r){return[zf(n.layer.call(t,e)),[]]},t=zf(t),[],!1,null,null,!1,!0)[1]})},e.className="TimeDistributed",e}(av);yp.registerClass(ov);var sv="concat",uv=function(t){function e(e){var n=t.call(this,e)||this,r=e.layer.getConfig(),i={};i.className=e.layer.getClassName(),i.config=r,n.forwardLayer=ld(i),r.goBackwards=!0!==r.goBackwards;var a={};if(a.className=e.layer.getClassName(),a.config=r,n.backwardLayer=ld(a),n.forwardLayer.name="forward_"+n.forwardLayer.name,n.backwardLayer.name="backward_"+n.backwardLayer.name,n.mergeMode=void 0===e.mergeMode?sv:e.mergeMode,function(t){lh(kh,"BidirectionalMergeMode",t)}(n.mergeMode),e.weights)throw new $p("weights support is not implemented for Bidirectional layer yet.");return n._stateful=e.layer.stateful,n.returnSequences=e.layer.returnSequences,n.returnState=e.layer.returnState,n.supportsMasking=!0,n._trainable=!0,n.inputSpec=e.layer.inputSpec,n.numConstants=null,n}return Bp(e,t),Object.defineProperty(e.prototype,"trainable",{get:function(){return this._trainable},set:function(t){this._trainable=t,null!=this.forwardLayer&&(this.forwardLayer.trainable=t),null!=this.backwardLayer&&(this.backwardLayer.trainable=t)},enumerable:!0,configurable:!0}),e.prototype.getWeights=function(){return this.forwardLayer.getWeights().concat(this.backwardLayer.getWeights())},e.prototype.setWeights=function(t){var e=t.length,n=Math.floor(e/2);this.forwardLayer.setWeights(t.slice(0,n)),this.backwardLayer.setWeights(t.slice(n))},e.prototype.computeOutputShape=function(t){var e,n,r,i=this.forwardLayer.computeOutputShape(t);return Array.isArray(i)&&Array.isArray(i[0])||(i=[i]),i=i,this.returnState?(r=i.slice(1),e=i[0]):e=i[0],e=e,"concat"===this.mergeMode?(e[e.length-1]*=2,n=[e]):n=null==this.mergeMode?[e,e.slice()]:[e],this.returnState?null==this.mergeMode?n.concat(r).concat(r.slice()):[e].concat(r).concat(r.slice()):Qp(n)},e.prototype.apply=function(e,n){var r=null==n?null:n.initialState,i=null==n?null:n.constants;null==n&&(n={});var a=Kg(e,r,i,this.numConstants);if(e=a.inputs,r=a.initialState,i=a.constants,Array.isArray(e)&&(r=e.slice(1),e=e[0]),(null==r||0===r.length)&&null==i)return t.prototype.apply.call(this,e,n);var o=[],s=[];if(null!=r){var u=r.length;if(u%2>0)throw new Kp("When passing `initialState` to a Bidrectional RNN, the state should be an Array containing the states of the underlying RNNs.");n.initialState=r,o.push.apply(o,r);var l=r.map(function(t){return new jf({shape:t.shape})});this.forwardLayer.stateSpec=l.slice(0,u/2),this.backwardLayer.stateSpec=l.slice(u/2),s.push.apply(s,l)}if(null!=i)throw new $p("Support for constants in Bidirectional layers is not implemented yet.");for(var c=o[0]instanceof qf,p=0,h=o;p<h.length;p++)if(h[p]instanceof qf!==c)throw new Kp("The initial state of a Bidirectional layer cannot be specified as a mix of symbolic and non-symbolic tensors");if(c){var f=[e].concat(o),d=this.inputSpec.concat(s),m=this.inputSpec;this.inputSpec=d;var g=t.prototype.apply.call(this,f,n);return this.inputSpec=m,g}return t.prototype.apply.call(this,e,n)},e.prototype.call=function(t,e){var n=this;return Fe(function(){if(null!=e.mask)throw new $p("The support for masking is not implemented for Bidirectional layers yet.");var r,i,a,o,s=e.initialState;if(null==s)r=n.forwardLayer.call(t,e),i=n.backwardLayer.call(t,e);else{var u=s.slice(0,s.length/2),l=s.slice(s.length/2);r=n.forwardLayer.call(t,Object.assign(e,{initialState:u})),i=n.backwardLayer.call(t,Object.assign(e,{initialState:l}))}return n.returnState&&(Array.isArray(r)&&(a=r.slice(1).concat(i.slice(1))),r=r[0],i=i[0]),n.returnSequences&&(i=Lu(i,1)),"concat"===n.mergeMode?o=Xh([r,i]):"sum"===n.mergeMode?o=Ls(r,i):"ave"===n.mergeMode?o=Ys(.5,Ls(r,i)):"mul"===n.mergeMode?o=Ys(r,i):null==n.mergeMode&&(o=[r,i]),n.returnState?null==n.mergeMode?o.concat(a):[o].concat(a):o})},e.prototype.resetStates=function(t){this.forwardLayer.resetStates(),this.backwardLayer.resetStates()},e.prototype.build=function(t){var e=this;_h(this.forwardLayer.name,function(){e.forwardLayer.build(t)}),_h(this.backwardLayer.name,function(){e.backwardLayer.build(t)}),this.built=!0},Object.defineProperty(e.prototype,"trainableWeights",{get:function(){return this.forwardLayer.trainableWeights.concat(this.backwardLayer.trainableWeights)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"nonTrainableWeights",{get:function(){return this.forwardLayer.nonTrainableWeights.concat(this.backwardLayer.nonTrainableWeights)},enumerable:!0,configurable:!0}),e.prototype.setFastWeightInitDuringBuild=function(e){t.prototype.setFastWeightInitDuringBuild.call(this,e),null!=this.forwardLayer&&this.forwardLayer.setFastWeightInitDuringBuild(e),null!=this.backwardLayer&&this.backwardLayer.setFastWeightInitDuringBuild(e)},e.prototype.getConfig=function(){var e={mergeMode:this.mergeMode},n=t.prototype.getConfig.call(this);return Object.assign(e,n),e},e.fromConfig=function(t,e){var n=ld(e.layer);if(delete e.layer,null!=e.numConstants)throw new $p("Deserialization of a Bidirectional layer with numConstants present is not supported yet.");var r=e;return r.layer=n,new t(r)},e.className="Bidirectional",e}(av);function lv(t){return new Fg(t)}function cv(t){return new Lg(t)}function pv(t){return new Vg(t)}function hv(t){return new jg(t)}function fv(t){return new Gg(t)}function dv(t){return new _g(t)}function mv(t){return new zg(t)}yp.registerClass(uv);var gv=hv,vv=fv,yv=dv,bv=mv;var xv=Object.freeze({inputLayer:function(t){return new Yf(t)},elu:function(t){return new Vm(t)},reLU:function(t){return new Lm(t)},leakyReLU:function(t){return new Pm(t)},prelu:function(t){return new Bm(t)},softmax:function(t){return new Um(t)},thresholdedReLU:function(t){return new Wm(t)},conv1d:function(t){return new eg(t)},conv2d:function(t){return new Jm(t)},conv2dTranspose:function(t){return new Qm(t)},conv3d:function(t){return new Zm(t)},separableConv2d:function(t){return new tg(t)},cropping2D:function(t){return new ng(t)},upSampling2d:function(t){return new rg(t)},depthwiseConv2d:function(t){return new ig(t)},activation:function(t){return new ug(t)},dense:function(t){return new og(t)},dropout:function(t){return new ag(t)},flatten:function(t){return new sg(t)},repeatVector:function(t){return new lg(t)},reshape:function(t){return new cg(t)},permute:function(t){return new pg(t)},embedding:function(t){return new fg(t)},add:function(t){return new mg(t)},average:function(t){return new vg(t)},concatenate:function(t){return new xg(t)},maximum:function(t){return new yg(t)},minimum:function(t){return new bg(t)},multiply:function(t){return new gg(t)},dot:function(t){return new Ng(t)},batchNormalization:function(t){return new Ag(t)},zeroPadding2d:function(t){return new Rg(t)},averagePooling1d:lv,avgPool1d:function(t){return lv(t)},avgPooling1d:function(t){return lv(t)},averagePooling2d:cv,avgPool2d:function(t){return cv(t)},avgPooling2d:function(t){return cv(t)},averagePooling3d:pv,avgPool3d:function(t){return pv(t)},avgPooling3d:function(t){return pv(t)},globalAveragePooling1d:function(t){return new Ug(t)},globalAveragePooling2d:function(t){return new Hg(t)},globalMaxPooling1d:hv,globalMaxPooling2d:fv,maxPooling1d:dv,maxPooling2d:mv,maxPooling3d:function(t){return new Bg(t)},gru:function(t){return new tv(t)},gruCell:function(t){return new Qg(t)},lstm:function(t){return new nv(t)},lstmCell:function(t){return new ev(t)},simpleRNN:function(t){return new Zg(t)},simpleRNNCell:function(t){return new Jg(t)},rnn:function(t){return new Xg(t)},stackedRNNCells:function(t){return new rv(t)},bidirectional:function(t){return new uv(t)},timeDistributed:function(t){return new ov(t)},globalMaxPool1d:gv,globalMaxPool2d:vv,maxPool1d:yv,maxPool2d:bv,Layer:$f,RNN:Xg,RNNCell:Yg,input:fm,gaussianNoise:function(t){return new Cg(t)},gaussianDropout:function(t){return new Eg(t)},alphaDropout:function(t){return new Sg(t)},masking:function(t){return new hg(t)}});var wv=Object.freeze({binaryAccuracy:function(t,e){return xd(t,e)},binaryCrossentropy:function(t,e){return Sd(t,e)},sparseCategoricalAccuracy:function(t,e){return kd(t,e)},categoricalAccuracy:function(t,e){return wd(t,e)},categoricalCrossentropy:function(t,e){return Id(t,e)},precision:function(t,e){return Cd(t,e)},recall:function(t,e){return Ed(t,e)},cosineProximity:function(t,e){return vd(t,e)},meanAbsoluteError:function(t,e){return hd(t,e)},meanAbsolutePercentageError:function(t,e){return fd(t,e)},MAPE:function(t,e){return fd(t,e)},mape:function(t,e){return fd(t,e)},meanSquaredError:function(t,e){return pd(t,e)},MSE:function(t,e){return pd(t,e)},mse:function(t,e){return pd(t,e)}}),Nv=Object.freeze({modelFromJSON:function(t,e){return Up(this,void 0,void 0,function(){var n,r,i,a,o,s,u,l;return jp(this,function(c){switch(c.label){case 0:return"modelTopology"in t||(t={modelTopology:t}),null!=(n=(t=t).modelTopology).model_config&&(n=n.model_config),r=Pd(n),i=ld(r,e),null==t.weightsManifest?[3,2]:[4,cp.loadWeights(t.weightsManifest,t.pathPrefix,i.weights.map(function(t){return t.originalName}))];case 1:for(a=c.sent(),o={},s=0,u=i.weights;s<u.length;s++)l=u[s],o[l.originalName]=a[l.originalName];i.loadWeights(o),Me(a),c.label=2;case 2:return[2,i]}})})}});var Cv=Object.freeze({l1l2:function(t){return new Om(t)},l1:function(t){return function(t){return Tm(t),new Om({l1:null!=t?t.l1:null,l2:0})}(t)},l2:function(t){return function(t){return Tm(t),new Om({l2:null!=t?t.l2:null,l1:0})}(t)}}),Ev=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e.model=null,e}return Bp(e,t),e.prototype.setModel=function(t){if(!(t instanceof cm))throw new Error("model must be a LayersModel, not some other Container");this.model=t},e}(ed);function Sv(t,e){return t<e}function kv(t,e){return t>e}var Iv=function(t){function e(e){var n=t.call(this)||this;if(null==e&&(e={}),e.restoreBestWeights)throw new $p("restoreBestWeights = True is not implemented in EarlyStopping yet.");return n.monitor=e.monitor||"val_loss",n.minDelta=Math.abs(e.minDelta||0),n.patience=e.patience||0,n.verbose=e.verbose||0,n.mode=e.mode||"auto",n.baseline=e.baseline,-1===["auto","min","max"].indexOf(n.mode)&&(console.warn("EarlyStopping mode '"+n.mode+"' is invalid. Falling back to mode 'auto'."),n.mode="auto"),"min"===n.mode?n.monitorFunc=Sv:"max"===n.mode?n.monitorFunc=kv:-1!==n.monitor.indexOf("acc")?n.monitorFunc=kv:n.monitorFunc=Sv,n.monitorFunc===Sv&&(n.minDelta*=-1),n}return Bp(e,t),e.prototype.onTrainBegin=function(t){return Up(this,void 0,void 0,function(){return jp(this,function(t){return this.wait=0,this.stoppedEpoch=0,null!=this.baseline?this.best=this.baseline:this.best=this.monitorFunc===Sv?1/0:-1/0,[2]})})},e.prototype.onEpochEnd=function(t,e){return Up(this,void 0,void 0,function(){var n;return jp(this,function(r){switch(r.label){case 0:return[4,Zf(e)];case 1:return r.sent(),null==(n=this.getMonitorValue(e))?[2]:(this.monitorFunc(n-this.minDelta,this.best)?(this.best=n,this.wait=0):(this.wait++,this.wait>=this.patience&&(this.stoppedEpoch=t,this.model.stopTraining=!0)),[2])}})})},e.prototype.onTrainEnd=function(t){return Up(this,void 0,void 0,function(){return jp(this,function(t){return this.stoppedEpoch>0&&this.verbose&&console.log("Epoch "+this.stoppedEpoch+": early stopping."),[2]})})},e.prototype.getMonitorValue=function(t){null==t&&(t={});var e=t[this.monitor];return null==e&&console.warn("Metric for EarlyStopping "+this.monitor+" is not available. Available metrics are: "+Object.keys(t)),e},e}(Ev);var Av={earlyStopping:function(t){return new Iv(t)}},Rv=function(){return(Rv=Object.assign||function(t){for(var e,n=1,r=arguments.length;n<r;n++)for(var i in e=arguments[n])Object.prototype.hasOwnProperty.call(e,i)&&(t[i]=e[i]);return t}).apply(this,arguments)};function Tv(t,e,n,r){return new(n||(n=Promise))(function(i,a){function o(t){try{u(r.next(t))}catch(t){a(t)}}function s(t){try{u(r.throw(t))}catch(t){a(t)}}function u(t){t.done?i(t.value):new n(function(e){e(t.value)}).then(o,s)}u((r=r.apply(t,e||[])).next())})}function Dv(t,e){var n,r,i,a,o={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return a={next:s(0),throw:s(1),return:s(2)},"function"==typeof Symbol&&(a[Symbol.iterator]=function(){return this}),a;function s(a){return function(s){return function(a){if(n)throw new TypeError("Generator is already executing.");for(;o;)try{if(n=1,r&&(i=2&a[0]?r.return:a[0]?r.throw||((i=r.return)&&i.call(r),0):r.next)&&!(i=i.call(r,a[1])).done)return i;switch(r=0,i&&(a=[2&a[0],i.value]),a[0]){case 0:case 1:i=a;break;case 4:return o.label++,{value:a[1],done:!1};case 5:o.label++,r=a[1],a=[0];continue;case 7:a=o.ops.pop(),o.trys.pop();continue;default:if(!(i=(i=o.trys).length>0&&i[i.length-1])&&(6===a[0]||2===a[0])){o=0;continue}if(3===a[0]&&(!i||a[1]>i[0]&&a[1]<i[3])){o.label=a[1];break}if(6===a[0]&&o.label<i[1]){o.label=i[1],i=a;break}if(i&&o.label<i[2]){o.label=i[2],o.ops.push(a);break}i[2]&&o.ops.pop(),o.trys.pop();continue}a=e.call(t,o)}catch(t){a=[6,t],r=0}finally{n=i=0}if(5&a[0])throw a[1];return{value:a[0]?a[1]:void 0,done:!0}}([a,s])}}}var Ov,_v,Fv={};function Mv(t,e){var n={tfOpName:t,category:"custom",inputs:[],attrs:[],customExecutor:e};Fv[t]=n}function zv(t){return Fv[t]}function Lv(t,e,n,r){var i=e.inputParams[t];if(i&&void 0!==i.inputIndexStart){var a=i.inputIndexStart,o=0===i.inputIndexEnd?void 0:void 0===i.inputIndexEnd?a+1:i.inputIndexEnd;if("tensor"===i.type)return Pv(e.inputNames[i.inputIndexStart],n,r);if("tensors"===i.type)return e.inputNames.slice(a,o).map(function(t){return Pv(t,n,r)});var s=Array.prototype.slice.call(Pv(e.inputNames.slice(a)[0],n,r).dataSync());return"number"===i.type?s[0]:s}var u=e.attrParams[t];return u&&u.value}function Pv(t,e,n){var r=Wv(t),i=r[0],a=r[1],o=n.currentContextIds.find(function(t){return!!e[Vv(i,t)]});return void 0!==o?e[Vv(i,o)][a]:void 0}function Bv(t,e){var n=Wv(t),r=n[0],i=n[1];return[Vv(r,e&&e.currentContextId),i]}function Vv(t,e){return e?t+"-"+e:t}function Wv(t){var e=t.lastIndexOf(":");return-1===e?[t,0]:[t.substring(0,e),Number(t.substring(e+1))]}function Uv(t,e){for(var n=[],r=0;r<t.length;r+=e)n.push(t.slice(r,r+e));return n}!function(t){t[t.DT_INVALID=0]="DT_INVALID",t[t.DT_FLOAT=1]="DT_FLOAT",t[t.DT_DOUBLE=2]="DT_DOUBLE",t[t.DT_INT32=3]="DT_INT32",t[t.DT_UINT8=4]="DT_UINT8",t[t.DT_INT16=5]="DT_INT16",t[t.DT_INT8=6]="DT_INT8",t[t.DT_STRING=7]="DT_STRING",t[t.DT_COMPLEX64=8]="DT_COMPLEX64",t[t.DT_INT64=9]="DT_INT64",t[t.DT_BOOL=10]="DT_BOOL",t[t.DT_QINT8=11]="DT_QINT8",t[t.DT_QUINT8=12]="DT_QUINT8",t[t.DT_QINT32=13]="DT_QINT32",t[t.DT_BFLOAT16=14]="DT_BFLOAT16",t[t.DT_FLOAT_REF=101]="DT_FLOAT_REF",t[t.DT_DOUBLE_REF=102]="DT_DOUBLE_REF",t[t.DT_INT32_REF=103]="DT_INT32_REF",t[t.DT_UINT8_REF=104]="DT_UINT8_REF",t[t.DT_INT16_REF=105]="DT_INT16_REF",t[t.DT_INT8_REF=106]="DT_INT8_REF",t[t.DT_STRING_REF=107]="DT_STRING_REF",t[t.DT_COMPLEX64_REF=108]="DT_COMPLEX64_REF",t[t.DT_INT64_REF=109]="DT_INT64_REF",t[t.DT_BOOL_REF=110]="DT_BOOL_REF",t[t.DT_QINT8_REF=111]="DT_QINT8_REF",t[t.DT_QUINT8_REF=112]="DT_QUINT8_REF",t[t.DT_QINT32_REF=113]="DT_QINT32_REF",t[t.DT_BFLOAT16_REF=114]="DT_BFLOAT16_REF"}(Ov||(Ov={})),function(t){!function(t){t[t.LEGACY=0]="LEGACY",t[t.V1=1]="V1",t[t.V2=2]="V2"}(t.CheckpointFormatVersion||(t.CheckpointFormatVersion={}))}(_v||(_v={}));var jv=Object.freeze({json:[{tfOpName:"Add",category:"arithmetic",inputs:[{start:0,name:"a",type:"tensor"},{start:1,name:"b",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"AddV2",category:"arithmetic",inputs:[{start:0,name:"a",type:"tensor"},{start:1,name:"b",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"AddN",category:"arithmetic",inputs:[{start:0,end:0,name:"tensors",type:"tensors"}]},{tfOpName:"BiasAdd",category:"arithmetic",inputs:[{start:0,name:"a",type:"tensor"},{start:1,name:"b",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"Sub",category:"arithmetic",inputs:[{start:0,name:"a",type:"tensor"},{start:1,name:"b",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"RealDiv",category:"arithmetic",inputs:[{start:0,name:"a",type:"tensor"},{start:1,name:"b",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"Div",category:"arithmetic",inputs:[{start:0,name:"a",type:"tensor"},{start:1,name:"b",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"FloorDiv",category:"arithmetic",inputs:[{start:0,name:"a",type:"tensor"},{start:1,name:"b",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"Mul",category:"arithmetic",inputs:[{start:0,name:"a",type:"tensor"},{start:1,name:"b",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"Maximum",category:"arithmetic",inputs:[{start:0,name:"a",type:"tensor"},{start:1,name:"b",type:"tensor"}]},{tfOpName:"Minimum",category:"arithmetic",inputs:[{start:0,name:"a",type:"tensor"},{start:1,name:"b",type:"tensor"}]},{tfOpName:"Pow",category:"arithmetic",inputs:[{start:0,name:"a",type:"tensor"},{start:1,name:"b",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"SquaredDifference",category:"arithmetic",inputs:[{start:0,name:"a",type:"tensor"},{start:1,name:"b",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"Mod",category:"arithmetic",inputs:[{start:0,name:"a",type:"tensor"},{start:1,name:"b",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"FloorMod",category:"arithmetic",inputs:[{start:0,name:"a",type:"tensor"},{start:1,name:"b",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]}]}),qv=Object.freeze({json:[{tfOpName:"Abs",category:"basic_math",inputs:[{start:0,name:"x",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"Acos",category:"basic_math",inputs:[{start:0,name:"x",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"Asin",category:"basic_math",inputs:[{start:0,name:"x",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"Atan",category:"basic_math",inputs:[{start:0,name:"x",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"Atan2",category:"basic_math",inputs:[{start:0,name:"x",type:"tensor"},{start:1,name:"y",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"Ceil",category:"basic_math",inputs:[{start:0,name:"x",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"ClipByValue",category:"basic_math",inputs:[{start:0,name:"x",type:"tensor"}],attrs:[{tfName:"clip_value_min",name:"clipValueMin",type:"number"},{tfName:"clip_value_max",name:"clipValueMax",type:"number"}]},{tfOpName:"Complex",category:"basic_math",inputs:[{start:0,name:"real",type:"tensor"},{start:1,name:"imag",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"ComplexAbs",category:"basic_math",inputs:[{start:0,name:"x",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"Cos",category:"basic_math",inputs:[{start:0,name:"x",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"Cosh",category:"basic_math",inputs:[{start:0,name:"x",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"Elu",category:"basic_math",inputs:[{start:0,name:"x",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"Exp",category:"basic_math",inputs:[{start:0,name:"x",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"Floor",category:"basic_math",inputs:[{start:0,name:"x",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"Log",category:"basic_math",inputs:[{start:0,name:"x",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"Imag",category:"basic_math",inputs:[{start:0,name:"x",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0},{tfName:"Tout",name:"outputType",type:"dtype",notSupported:!0}]},{tfOpName:"Neg",category:"basic_math",inputs:[{start:0,name:"x",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"Real",category:"basic_math",inputs:[{start:0,name:"x",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0},{tfName:"Tout",name:"outputType",type:"dtype",notSupported:!0}]},{tfOpName:"Relu",category:"basic_math",inputs:[{start:0,name:"x",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"Relu6",category:"basic_math",inputs:[{start:0,name:"x",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0},{tfName:"clipValueMin",name:"clipValueMin",type:"number",defaultValue:0},{tfName:"clipValueMax",name:"clipValueMax",type:"number",defaultValue:6}]},{tfOpName:"Selu",category:"basic_math",inputs:[{start:0,name:"x",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"Sigmoid",category:"basic_math",inputs:[{start:0,name:"x",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"Sin",category:"basic_math",inputs:[{start:0,name:"x",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"Sinh",category:"basic_math",inputs:[{start:0,name:"x",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"Sqrt",category:"basic_math",inputs:[{start:0,name:"x",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"Rsqrt",category:"basic_math",inputs:[{start:0,name:"x",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"Square",category:"basic_math",inputs:[{start:0,name:"x",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"Tan",category:"basic_math",inputs:[{start:0,name:"x",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"Tanh",category:"basic_math",inputs:[{start:0,name:"x",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"Sign",category:"basic_math",inputs:[{start:0,name:"x",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"Round",category:"basic_math",inputs:[{start:0,name:"x",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"Expm1",category:"basic_math",inputs:[{start:0,name:"x",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"Log1p",category:"basic_math",inputs:[{start:0,name:"x",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"Reciprocal",category:"basic_math",inputs:[{start:0,name:"x",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"Softplus",category:"basic_math",inputs:[{start:0,name:"x",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"Asinh",category:"basic_math",inputs:[{start:0,name:"x",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"Acosh",category:"basic_math",inputs:[{start:0,name:"x",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"Atanh",category:"basic_math",inputs:[{start:0,name:"x",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"Erf",category:"basic_math",inputs:[{start:0,name:"x",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"Prod",category:"basic_math",inputs:[{start:0,name:"x",type:"tensor"},{start:1,name:"axes",type:"number[]"}],attrs:[{tfName:"keep_dims",name:"keepDims",type:"bool",notSupported:!0},{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"LeakyRelu",category:"basic_math",inputs:[{start:0,name:"x",type:"tensor"}],attrs:[{tfName:"alpha",name:"alpha",type:"number",defaultValue:.2},{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]}]}),Hv=Object.freeze({json:[{tfOpName:"LoopCond",category:"control",inputs:[{start:0,name:"pred",type:"tensor"}]},{tfOpName:"Switch",category:"control",inputs:[{start:0,name:"data",type:"tensor"},{start:1,name:"pred",type:"tensor"}]},{tfOpName:"Merge",category:"control",inputs:[{start:0,end:0,name:"tensors",type:"tensors"}]},{tfOpName:"Enter",category:"control",inputs:[{start:0,name:"tensor",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0},{tfName:"frame_name",name:"frameName",type:"string"},{tfName:"is_constant",name:"isConstant",type:"bool"}]},{tfOpName:"Exit",category:"control",inputs:[{start:0,name:"tensor",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"NextIteration",category:"control",inputs:[{start:0,name:"tensor",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"TensorArrayV3",category:"control",inputs:[{start:0,name:"size",type:"number"}],attrs:[{tfName:"dtype",name:"dtype",type:"dtype"},{tfName:"element_shape",name:"elementShape",type:"shape"},{tfName:"dynamic_size",name:"dynamicSize",type:"bool"},{tfName:"clear_after_read",name:"clearAfterRead",type:"bool"},{tfName:"identical_element_shapes",name:"identicalElementShapes",type:"bool"},{tfName:"tensor_array_name",name:"name",type:"string"}]},{tfOpName:"TensorArrayWriteV3",category:"control",inputs:[{start:0,name:"tensorArrayId",type:"number"},{start:1,name:"index",type:"number"},{start:2,name:"tensor",type:"tensor"},{start:3,name:"flowIn",type:"number"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"TensorArrayReadV3",category:"control",inputs:[{start:0,name:"tensorArrayId",type:"number"},{start:1,name:"index",type:"number"},{start:2,name:"flowIn",type:"number"}],attrs:[{tfName:"dtype",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"TensorArrayGatherV3",category:"control",inputs:[{start:0,name:"tensorArrayId",type:"number"},{start:1,name:"indices",type:"number[]"},{start:2,name:"flowIn",type:"number"}],attrs:[{tfName:"dtype",name:"dtype",type:"dtype"},{tfName:"element_shape",name:"elementShape",type:"shape"}]},{tfOpName:"TensorArrayScatterV3",category:"control",inputs:[{start:0,name:"tensorArrayId",type:"number"},{start:1,name:"indices",type:"number[]"},{start:2,name:"tensor",type:"tensor"},{start:3,name:"flowIn",type:"number"}],attrs:[{tfName:"T",name:"dtype",type:"dtype"}]},{tfOpName:"TensorArrayConcatV3",category:"control",inputs:[{start:0,name:"tensorArrayId",type:"number"},{start:1,name:"flowIn",type:"number"}],attrs:[{tfName:"dtype",name:"dtype",type:"dtype"},{tfName:"element_shape_except0",name:"elementShapeExcept0",type:"shape",notSupported:!0}]},{tfOpName:"TensorArraySplitV3",category:"control",inputs:[{start:0,name:"tensorArrayId",type:"number"},{start:1,name:"tensor",type:"tensor"},{start:2,name:"lengths",type:"number[]"},{start:3,name:"flowIn",type:"number"}],attrs:[{tfName:"T",name:"dtype",type:"dtype"}]},{tfOpName:"TensorArraySizeV3",category:"control",inputs:[{start:0,name:"tensorArrayId",type:"number"},{start:1,name:"flowIn",type:"number"}]},{tfOpName:"TensorArrayCloseV3",category:"control",inputs:[{start:0,name:"tensorArrayId",type:"number"}]}]}),Gv=Object.freeze({json:[{tfOpName:"AvgPool",category:"convolution",inputs:[{start:0,name:"x",type:"tensor"}],attrs:[{tfName:"strides",name:"strides",type:"number[]"},{tfName:"padding",name:"pad",type:"string"},{tfName:"data_format",name:"dataFormat",type:"string",notSupported:!0},{tfName:"ksize",name:"kernelSize",type:"number[]"},{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"MaxPool",category:"convolution",inputs:[{start:0,name:"x",type:"tensor"}],attrs:[{tfName:"strides",name:"strides",type:"number[]"},{tfName:"padding",name:"pad",type:"string"},{tfName:"data_format",name:"dataFormat",type:"string",notSupported:!0},{tfName:"ksize",name:"kernelSize",type:"number[]"},{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"AvgPool3D",category:"convolution",inputs:[{start:0,name:"x",type:"tensor"}],attrs:[{tfName:"strides",name:"strides",type:"number[]"},{tfName:"padding",name:"pad",type:"string"},{tfName:"data_format",name:"dataFormat",type:"string",notSupported:!0},{tfName:"ksize",name:"kernelSize",type:"number[]"},{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"MaxPool3D",category:"convolution",inputs:[{start:0,name:"x",type:"tensor"}],attrs:[{tfName:"strides",name:"strides",type:"number[]"},{tfName:"padding",name:"pad",type:"string"},{tfName:"data_format",name:"dataFormat",type:"string",notSupported:!0},{tfName:"ksize",name:"kernelSize",type:"number[]"},{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"Conv1D",category:"convolution",inputs:[{start:0,name:"x",type:"tensor"},{start:1,name:"filter",type:"tensor"}],attrs:[{tfName:"stride",name:"stride",type:"number"},{tfName:"padding",name:"pad",type:"string"},{tfName:"data_format",name:"dataFormat",type:"string",defaultValue:"NWC"},{tfName:"T",name:"dtype",type:"dtype",notSupported:!0},{tfName:"dilation",name:"dilation",type:"number",defaultValue:1}]},{tfOpName:"Conv2D",category:"convolution",inputs:[{start:0,name:"x",type:"tensor"},{start:1,name:"filter",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0},{tfName:"strides",name:"strides",type:"number[]"},{tfName:"padding",name:"pad",type:"string"},{tfName:"useCudnnOnGpu",name:"useCudnnOnGpu",type:"bool"},{tfName:"data_format",name:"dataFormat",type:"string",defaultValue:"NHWC"},{tfName:"dilations",name:"dilations",type:"number[]"}]},{tfOpName:"Conv2DBackpropInput",category:"convolution",inputs:[{start:2,name:"x",type:"tensor"},{start:1,name:"filter",type:"tensor"},{start:0,name:"outputShape",type:"number[]"}],attrs:[{tfName:"strides",name:"strides",type:"number[]"},{tfName:"padding",name:"pad",type:"string"},{tfName:"data_format",name:"dataFormat",type:"string",notSupported:!0}]},{tfOpName:"DepthwiseConv2d",category:"convolution",inputs:[{start:0,name:"input",type:"tensor"},{start:1,name:"filter",type:"tensor"}],attrs:[{tfName:"strides",name:"strides",type:"number[]"},{tfName:"padding",name:"pad",type:"string"},{tfName:"data_format",name:"dataFormat",type:"string",defaultValue:"NHWC"},{tfName:"dilations",name:"dilations",type:"number[]"}]},{tfOpName:"DepthwiseConv2dNative",category:"convolution",inputs:[{start:0,name:"input",type:"tensor"},{start:1,name:"filter",type:"tensor"}],attrs:[{tfName:"strides",name:"strides",type:"number[]"},{tfName:"padding",name:"pad",type:"string"},{tfName:"data_format",name:"dataFormat",type:"string",defaultValue:"NHWC"},{tfName:"dilations",name:"dilations",type:"number[]"}]},{tfOpName:"Conv3D",category:"convolution",inputs:[{start:0,name:"x",type:"tensor"},{start:1,name:"filter",type:"tensor"}],attrs:[{tfName:"strides",name:"strides",type:"number[]"},{tfName:"padding",name:"pad",type:"string"},{tfName:"data_format",name:"dataFormat",type:"string",defaultValue:"NHWC"},{tfName:"dilations",name:"dilations",type:"number[]"}]}]}),Kv=Object.freeze({json:[{tfOpName:"Fill",category:"creation",inputs:[{start:0,name:"shape",type:"number[]"},{start:1,name:"value",type:"number"}],attrs:[{tfName:"T",name:"dtype",type:"dtype"}]},{tfOpName:"LinSpace",category:"creation",inputs:[{start:0,name:"start",type:"number"},{start:1,name:"stop",type:"number"},{start:2,name:"num",type:"number"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"OneHot",category:"creation",inputs:[{start:0,name:"indices",type:"tensor"},{start:1,name:"depth",type:"number"},{start:2,name:"onValue",type:"number",defaultValue:1},{start:3,name:"offValue",type:"number",defaultValue:0}],attrs:[{tfName:"axis",name:"axis",type:"number",notSupported:!0},{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"Ones",category:"creation",inputs:[{start:0,name:"shape",type:"number[]"}],attrs:[{tfName:"T",name:"dtype",type:"dtype"}]},{tfOpName:"OnesLike",category:"creation",inputs:[{start:0,name:"x",type:"tensor"}],attrs:[{tfName:"dtype",name:"dtype",type:"dtype"}]},{tfOpName:"RandomUniform",category:"creation",inputs:[{start:0,name:"shape",type:"number[]"}],attrs:[{tfName:"minval",name:"minval",type:"number",defaultValue:0},{tfName:"maxval",name:"maxval",type:"number",defaultValue:1},{tfName:"dtype",name:"dtype",type:"dtype"},{tfName:"seed",name:"seed",type:"number",defaultValue:0},{tfName:"seed2",name:"seed2",type:"number",defaultValue:0,notSupported:!0},{tfName:"T",name:"T",type:"number",notSupported:!0}]},{tfOpName:"Range",category:"creation",inputs:[{start:0,name:"start",type:"number"},{start:1,name:"stop",type:"number"},{start:2,name:"step",type:"number",defaultValue:0}],attrs:[{tfName:"Tidx",name:"dtype",type:"dtype"}]},{tfOpName:"TruncatedNormal",category:"creation",inputs:[{start:0,name:"shape",type:"number[]"}],attrs:[{tfName:"means",name:"mean",type:"number",defaultValue:0},{tfName:"stddev",name:"stdDev",type:"number",defaultValue:1},{tfName:"seed",name:"seed",type:"number"},{tfName:"seed2",name:"seed2",type:"number",defaultValue:0,notSupported:!0},{tfName:"dtype",name:"dtype",type:"dtype"},{tfName:"T",name:"T",type:"number",notSupported:!0}]},{tfOpName:"Zeros",category:"creation",inputs:[{start:0,name:"shape",type:"number[]"}],attrs:[{tfName:"T",name:"dtype",type:"dtype"}]},{tfOpName:"ZerosLike",category:"creation",inputs:[{start:0,name:"x",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype"}]}]}),$v=Object.freeze({json:[{tfOpName:"NonMaxSuppressionV2",category:"dynamic",inputs:[{start:0,name:"boxes",type:"tensor"},{start:1,name:"scores",type:"tensor"},{start:2,name:"maxOutputSize",type:"number"},{start:3,name:"iouThreshold",type:"number"}]},{tfOpName:"NonMaxSuppressionV3",category:"dynamic",inputs:[{start:0,name:"boxes",type:"tensor"},{start:1,name:"scores",type:"tensor"},{start:2,name:"maxOutputSize",type:"number"},{start:3,name:"iouThreshold",type:"number"},{start:4,name:"scoreThreshold",type:"number"}]},{tfOpName:"Where",category:"dynamic",inputs:[{start:0,name:"condition",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"ListDiff",category:"dynamic",inputs:[{start:0,name:"x",type:"tensor"},{start:1,name:"y",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]}]}),Xv=Object.freeze({json:[{tfOpName:"TopKV2",category:"evaluation",inputs:[{start:0,name:"x",type:"tensor"},{start:1,name:"k",type:"number"}],attrs:[{tfName:"sorted",name:"sorted",type:"bool"}]}]}),Yv=Object.freeze({json:[{tfOpName:"PlaceholderWithDefault",category:"graph",inputs:[{start:0,name:"default",type:"tensor"}],attrs:[{tfName:"shape",name:"shape",type:"shape"},{tfName:"dtype",name:"dtype",type:"dtype"}]},{tfOpName:"Placeholder",category:"graph",attrs:[{tfName:"shape",name:"shape",type:"shape"},{tfName:"dtype",name:"dtype",type:"dtype"}]},{tfOpName:"Const",category:"graph"},{tfOpName:"Identity",category:"graph",inputs:[{start:0,name:"x",type:"tensor"}]},{tfOpName:"IdentityN",category:"graph",inputs:[{start:0,end:0,name:"x",type:"tensors"}]},{tfOpName:"Snapshot",category:"graph",inputs:[{start:0,name:"x",type:"tensor"}]},{tfOpName:"Rank",category:"graph",inputs:[{start:0,name:"x",type:"tensor"}]},{tfOpName:"Size",category:"graph",inputs:[{start:0,name:"x",type:"tensor"}]},{tfOpName:"Shape",category:"graph",inputs:[{start:0,name:"x",type:"tensor"}]},{tfOpName:"ShapeN",category:"graph",inputs:[{start:0,end:0,name:"x",type:"tensors"}]},{tfOpName:"Print",category:"graph",inputs:[{start:0,name:"x",type:"tensor"},{start:1,name:"data",type:"tensors"}],attrs:[{tfName:"message",name:"message",type:"string"},{tfName:"first_n",name:"firstN",type:"number",notSupported:!0},{tfName:"summarize",name:"summarize",type:"number",defaultValue:3}]},{tfOpName:"NoOp",category:"graph",inputs:[]},{tfOpName:"StopGradient",category:"graph",inputs:[{start:0,name:"x",type:"tensor"}]},{tfOpName:"FakeQuantWithMinMaxVars",category:"graph",inputs:[{start:0,name:"x",type:"tensor"}],attrs:[{tfName:"min",name:"min",type:"number"},{tfName:"max",name:"max",type:"number"}]}]}),Jv=Object.freeze({json:[{tfOpName:"ResizeBilinear",category:"image",inputs:[{start:0,name:"images",type:"tensor"},{start:1,name:"size",type:"number[]"}],attrs:[{tfName:"align_corners",name:"alignCorners",type:"bool"},{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"ResizeNearestNeighbor",category:"image",inputs:[{start:0,name:"images",type:"tensor"},{start:1,name:"size",type:"number[]"}],attrs:[{tfName:"align_corners",name:"alignCorners",type:"bool"},{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"CropAndResize",category:"image",inputs:[{start:0,name:"image",type:"tensor"},{start:1,name:"boxes",type:"tensor"},{start:2,name:"boxInd",type:"tensor"},{start:3,name:"cropSize",type:"number[]"}],attrs:[{tfName:"method",name:"method",type:"string"},{tfName:"extrapolation_value",name:"extrapolationValue",type:"number"}]}]}),Zv=Object.freeze({json:[{tfOpName:"Equal",category:"logical",inputs:[{start:0,name:"a",type:"tensor"},{start:1,name:"b",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"NotEqual",category:"logical",inputs:[{start:0,name:"a",type:"tensor"},{start:1,name:"b",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"Greater",category:"logical",inputs:[{start:0,name:"a",type:"tensor"},{start:1,name:"b",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"GreaterEqual",category:"logical",inputs:[{start:0,name:"a",type:"tensor"},{start:1,name:"b",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"Less",category:"logical",inputs:[{start:0,name:"a",type:"tensor"},{start:1,name:"b",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"LessEqual",category:"logical",inputs:[{start:0,name:"a",type:"tensor"},{start:1,name:"b",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"LogicalAnd",category:"logical",inputs:[{start:0,name:"a",type:"tensor"},{start:1,name:"b",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"LogicalNot",category:"logical",inputs:[{start:0,name:"a",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"LogicalOr",category:"logical",inputs:[{start:0,name:"a",type:"tensor"},{start:1,name:"b",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"Select",category:"logical",inputs:[{start:0,name:"condition",type:"tensor"},{start:1,name:"a",type:"tensor"},{start:2,name:"b",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]}]}),Qv=Object.freeze({json:[{tfOpName:"MatMul",category:"matrices",inputs:[{start:0,name:"a",type:"tensor"},{start:1,name:"b",type:"tensor"}],attrs:[{tfName:"transpose_a",name:"transposeA",type:"bool",defaultValue:!1},{tfName:"transpose_b",name:"transposeB",type:"bool",defaultValue:!1},{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"BatchMatMul",category:"matrices",inputs:[{start:0,name:"a",type:"tensor"},{start:1,name:"b",type:"tensor"}],attrs:[{tfName:"adj_x",name:"transposeA",type:"bool",defaultValue:!1},{tfName:"adj_y",name:"transposeB",type:"bool",defaultValue:!1},{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"BatchMatMulV2",category:"matrices",inputs:[{start:0,name:"a",type:"tensor"},{start:1,name:"b",type:"tensor"}],attrs:[{tfName:"adj_x",name:"transposeA",type:"bool",defaultValue:!1},{tfName:"adj_y",name:"transposeB",type:"bool",defaultValue:!1},{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"Transpose",category:"matrices",inputs:[{start:0,name:"x",type:"tensor"},{start:1,name:"perm",type:"number[]"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]}]}),ty=Object.freeze({json:[{tfOpName:"FusedBatchNorm",category:"normalization",inputs:[{start:0,name:"x",type:"tensor"},{start:1,name:"scale",type:"tensor"},{start:2,name:"offset",type:"tensor"},{start:3,name:"mean",type:"tensor"},{start:4,name:"variance",type:"tensor"}],attrs:[{tfName:"epsilon",name:"epsilon",type:"number",defaultValue:.001},{tfName:"data_format",name:"dataFormat",type:"string",notSupported:!0}]},{tfOpName:"FusedBatchNormV2",category:"normalization",inputs:[{start:0,name:"x",type:"tensor"},{start:1,name:"scale",type:"tensor"},{start:2,name:"offset",type:"tensor"},{start:3,name:"mean",type:"tensor"},{start:4,name:"variance",type:"tensor"}],attrs:[{tfName:"epsilon",name:"epsilon",type:"number",defaultValue:.001},{tfName:"data_format",name:"dataFormat",type:"string",notSupported:!0}]},{tfOpName:"FusedBatchNormV3",category:"normalization",inputs:[{start:0,name:"x",type:"tensor"},{start:1,name:"scale",type:"tensor"},{start:2,name:"offset",type:"tensor"},{start:3,name:"mean",type:"tensor"},{start:4,name:"variance",type:"tensor"}],attrs:[{tfName:"epsilon",name:"epsilon",type:"number",defaultValue:.001},{tfName:"data_format",name:"dataFormat",type:"string",notSupported:!0}]},{tfOpName:"LRN",category:"normalization",inputs:[{start:0,name:"x",type:"tensor"}],attrs:[{tfName:"depth_radius",name:"radius",type:"number",defaultValue:5},{tfName:"bias",name:"bias",type:"number",defaultValue:1},{tfName:"alpha",name:"alpha",type:"number",defaultValue:1},{tfName:"beta",name:"beta",type:"number",defaultValue:.5}]},{tfOpName:"Softmax",category:"normalization",inputs:[{start:0,name:"x",type:"tensor"}]},{tfOpName:"LogSoftmax",category:"normalization",inputs:[{start:0,name:"x",type:"tensor"}]},{tfOpName:"SparseToDense",category:"normalization",inputs:[{start:0,name:"sparseIndices",type:"tensor"},{start:1,name:"outputShape",type:"number[]"},{start:2,name:"sparseValues",type:"tensor"},{start:3,name:"defaultValue",type:"tensor"}],attrs:[{tfName:"validate_indices",name:"validateIndices",type:"bool",defaultValue:!0,notSupported:!0}]}]}),ey=Object.freeze({json:[{tfOpName:"Max",category:"reduction",inputs:[{start:0,name:"x",type:"tensor"},{start:1,name:"axis",type:"number[]"}],attrs:[{tfName:"keep_dims",name:"keepDims",type:"bool"}]},{tfOpName:"Mean",category:"reduction",inputs:[{start:0,name:"x",type:"tensor"},{start:1,name:"axis",type:"number[]"}],attrs:[{tfName:"keep_dims",name:"keepDims",type:"bool"}]},{tfOpName:"Min",category:"reduction",inputs:[{start:0,name:"x",type:"tensor"},{start:1,name:"axis",type:"number[]"}],attrs:[{tfName:"keep_dims",name:"keepDims",type:"bool"}]},{tfOpName:"Sum",category:"reduction",inputs:[{start:0,name:"x",type:"tensor"},{start:1,name:"axis",type:"number[]"}],attrs:[{tfName:"keep_dims",name:"keepDims",type:"bool"}]},{tfOpName:"All",category:"reduction",inputs:[{start:0,name:"x",type:"tensor"},{start:1,name:"axis",type:"number[]"}],attrs:[{tfName:"keep_dims",name:"keepDims",type:"bool"}]},{tfOpName:"Any",category:"reduction",inputs:[{start:0,name:"x",type:"tensor"},{start:1,name:"axis",type:"number[]"}],attrs:[{tfName:"keep_dims",name:"keepDims",type:"bool"}]},{tfOpName:"ArgMax",category:"reduction",inputs:[{start:0,name:"x",type:"tensor"},{start:1,name:"axis",type:"number"}]},{tfOpName:"ArgMin",category:"reduction",inputs:[{start:0,name:"x",type:"tensor"},{start:1,name:"axis",type:"number"}]},{tfOpName:"Prod",category:"reduction",inputs:[{start:0,name:"x",type:"tensor"},{start:1,name:"axis",type:"number[]"}],attrs:[{tfName:"keep_dims",name:"keepDims",type:"bool"}]}]}),ny=Object.freeze({json:[{tfOpName:"ConcatV2",category:"slice_join",inputs:[{start:0,end:-1,name:"tensors",type:"tensors"},{start:-1,name:"axis",type:"number"}]},{tfOpName:"Concat",category:"slice_join",inputs:[{start:1,end:0,name:"tensors",type:"tensors"},{start:0,name:"axis",type:"number"}]},{tfOpName:"GatherV2",category:"slice_join",inputs:[{start:0,name:"x",type:"tensor"},{start:1,name:"indices",type:"tensor"},{start:2,name:"axis",type:"number",defaultValue:0}]},{tfOpName:"Gather",category:"slice_join",inputs:[{start:0,name:"x",type:"tensor"},{start:1,name:"indices",type:"tensor"}],attrs:[{tfName:"axis",name:"axis",type:"number",defaultValue:0},{tfName:"validate_indices",name:"validateIndices",type:"bool",notSupported:!0}]},{tfOpName:"Reverse",category:"slice_join",inputs:[{start:0,name:"x",type:"tensor"},{start:1,name:"dims",type:"bool",notSupported:!0}]},{tfOpName:"ReverseV2",category:"slice_join",inputs:[{start:0,name:"x",type:"tensor"},{start:1,name:"axis",type:"number[]"}]},{tfOpName:"Slice",category:"slice_join",inputs:[{start:0,name:"x",type:"tensor"},{start:1,name:"begin",type:"number[]"},{start:2,name:"size",type:"number[]"}]},{tfOpName:"StridedSlice",category:"slice_join",inputs:[{start:0,name:"x",type:"tensor"},{start:1,name:"begin",type:"number[]"},{start:2,name:"end",type:"number[]"},{start:3,name:"strides",type:"number[]"}],attrs:[{tfName:"begin_mask",name:"beginMask",type:"number",defaultValue:0},{tfName:"end_mask",name:"endMask",type:"number",defaultValue:0},{tfName:"new_axis_mask",name:"newAxisMask",type:"number",defaultValue:0},{tfName:"ellipsis_mask",name:"ellipsisMask",type:"number",defaultValue:0},{tfName:"shrink_axis_mask",name:"shrinkAxisMask",type:"number",defaultValue:0}]},{tfOpName:"Pack",category:"slice_join",inputs:[{start:0,end:0,name:"tensors",type:"tensors"}],attrs:[{tfName:"axis",name:"axis",type:"number",defaultValue:0}]},{tfOpName:"Unpack",category:"slice_join",inputs:[{start:0,name:"tensor",type:"tensor"}],attrs:[{tfName:"axis",name:"axis",type:"number",defaultValue:0},{tfName:"num",name:"num",type:"number",defaultValue:0,notSupported:!0}]},{tfOpName:"Tile",category:"slice_join",inputs:[{start:0,name:"x",type:"tensor"},{start:1,name:"reps",type:"number[]"}]},{tfOpName:"Split",category:"slice_join",inputs:[{start:0,name:"axis",type:"number",defaultValue:0},{start:1,name:"x",type:"tensor"}],attrs:[{tfName:"num_split",name:"numOrSizeSplits",type:"number",defaultValue:1}]},{tfOpName:"SplitV",category:"slice_join",inputs:[{start:0,name:"x",type:"tensor"},{start:1,name:"numOrSizeSplits",type:"number[]"},{start:2,name:"axis",type:"number",defaultValue:0}]},{tfOpName:"ScatterNd",category:"slice_join",inputs:[{start:0,name:"indices",type:"tensor"},{start:1,name:"values",type:"tensor"},{start:2,name:"shape",type:"number[]"}]},{tfOpName:"GatherNd",category:"slice_join",inputs:[{start:0,name:"x",type:"tensor"},{start:1,name:"indices",type:"tensor"}]},{tfOpName:"SparseToDense",category:"slice_join",inputs:[{start:0,name:"sparseIndices",type:"tensor"},{start:1,name:"outputShape",type:"number[]"},{start:2,name:"sparseValues",type:"tensor"},{start:3,name:"defaultValue",type:"tensor"}],attrs:[{tfName:"validate_indices",name:"validateIndices",type:"bool",defaultValue:!1,notSupported:!0}]}]}),ry=Object.freeze({json:[{tfOpName:"FFT",category:"spectral",inputs:[{start:0,name:"x",type:"tensor"}]},{tfOpName:"IFFT",category:"spectral",inputs:[{start:0,name:"x",type:"tensor"}]},{tfOpName:"RFFT",category:"spectral",inputs:[{start:0,name:"x",type:"tensor"},{start:1,name:"fft_length",type:"number",notSupported:!0}]},{tfOpName:"IRFFT",category:"spectral",inputs:[{start:0,name:"x",type:"tensor"},{start:1,name:"fft_length",type:"number",notSupported:!0}]}]}),iy=Object.freeze({json:[{tfOpName:"Cast",category:"transformation",inputs:[{start:0,name:"x",type:"tensor"}],attrs:[{tfName:"SrcT",name:"sdtype",type:"dtype",notSupported:!0},{tfName:"DstT",name:"dtype",type:"dtype"}]},{tfOpName:"ExpandDims",category:"transformation",inputs:[{start:0,name:"x",type:"tensor"},{start:1,name:"axis",type:"number"}]},{tfOpName:"Pad",category:"transformation",inputs:[{start:0,name:"x",type:"tensor"},{start:1,name:"padding",type:"number[]"}],attrs:[{tfName:"constant_value",name:"constantValue",type:"number",defaultValue:0}]},{tfOpName:"PadV2",category:"transformation",inputs:[{start:0,name:"x",type:"tensor"},{start:1,name:"padding",type:"number[]"},{start:2,name:"constantValue",type:"number",defaultValue:0}]},{tfOpName:"Reshape",category:"transformation",inputs:[{start:0,name:"x",type:"tensor"},{start:1,name:"shape",type:"number[]"}]},{tfOpName:"Squeeze",category:"transformation",inputs:[{start:0,name:"x",type:"tensor"}],attrs:[{tfName:"axis",tfDeprecatedName:"squeeze_dims",name:"axis",type:"number[]"}]},{tfOpName:"SpaceToBatchND",category:"transformation",inputs:[{start:0,name:"x",type:"tensor"},{start:1,name:"blockShape",type:"number[]"},{start:2,name:"paddings",type:"number[]"}]},{tfOpName:"BatchToSpaceND",category:"transformation",inputs:[{start:0,name:"x",type:"tensor"},{start:1,name:"blockShape",type:"number[]"},{start:2,name:"crops",type:"number[]"}]},{tfOpName:"DepthToSpace",category:"transformation",inputs:[{start:0,name:"x",type:"tensor"}],attrs:[{tfName:"block_size",name:"blockSize",type:"number"},{tfName:"data_format",name:"dataFormat",type:"string"}]}]}),ay=function(){function t(){var t=[jv,qv,Hv,Gv,Kv,$v,Xv,Zv,Jv,Yv,Qv,ty,ey,ny,ry,iy],e=[].concat.apply([],t.map(function(t){return t.json}));this.opMappers=e.reduce(function(t,e){return t[e.tfOpName]=e,t},{})}return Object.defineProperty(t,"Instance",{get:function(){return this._instance||(this._instance=new this)},enumerable:!0,configurable:!0}),t.prototype.transformGraph=function(t){var e=this,n=[],r=[],i=t.node.reduce(function(t,i){return t[i.name]=e.mapNode(i),"Placeholder"===i.op&&n.push(t[i.name]),"Const"===i.op&&r.push(t[i.name]),t},{}),a=[],o=[],s=Object.keys(i);return s.forEach(function(t){var e=i[t];e.inputNames.forEach(function(t){var n=Bv(t)[0];e.inputs.push(i[n]),i[n].children.push(e)}),0===e.inputs.length&&a.push(e)}),s.forEach(function(t){var e=i[t];0===e.children.length&&o.push(e)}),{nodes:i,inputs:a,outputs:o,weights:r,placeholders:n}},t.prototype.mapNode=function(t){var e=zv(t.op)||this.opMappers[t.op]||{};null==t.attr&&(t.attr={});var n={name:t.name,op:t.op,category:e.category,inputNames:(t.input||[]).map(function(t){return t.startsWith("^")?t.substr(1):t}),inputs:[],children:[],inputParams:{},attrParams:{},rawAttrs:t.attr};return null!=e.inputs&&(n.inputParams=e.inputs.reduce(function(t,e){return t[e.name]={type:e.type,inputIndexStart:e.start,inputIndexEnd:e.end},t},{})),null!=e.attrs&&(n.attrParams=e.attrs.reduce(function(e,n){var r=n.type,i=void 0;switch(n.type){case"string":void 0===(i=sy(t.attr,n.tfName,n.defaultValue))&&n.tfDeprecatedName&&(i=sy(t.attr,n.tfDeprecatedName,n.defaultValue));break;case"string[]":void 0===(i=gy(t.attr,n.tfName,n.defaultValue))&&n.tfDeprecatedName&&(i=gy(t.attr,n.tfDeprecatedName,n.defaultValue));break;case"number":void 0===(i=ly(t.attr,n.tfName,n.defaultValue||0))&&n.tfDeprecatedName&&(i=ly(t.attr,n.tfDeprecatedName,n.defaultValue));break;case"number[]":void 0===(i=my(t.attr,n.tfName,n.defaultValue))&&n.tfDeprecatedName&&(i=my(t.attr,n.tfDeprecatedName,n.defaultValue));break;case"bool":void 0===(i=uy(t.attr,n.tfName,n.defaultValue))&&n.tfDeprecatedName&&(i=uy(t.attr,n.tfDeprecatedName,n.defaultValue));break;case"bool[]":void 0===(i=yy(t.attr,n.tfName,n.defaultValue))&&n.tfDeprecatedName&&(i=yy(t.attr,n.tfDeprecatedName,n.defaultValue));break;case"shape":void 0===(i=dy(t.attr,n.tfName,n.defaultValue))&&n.tfDeprecatedName&&(i=dy(t.attr,n.tfDeprecatedName,n.defaultValue));break;case"shape[]":void 0===(i=vy(t.attr,n.tfName,n.defaultValue))&&n.tfDeprecatedName&&(i=vy(t.attr,n.tfDeprecatedName,n.defaultValue));break;case"dtype":void 0===(i=py(t.attr,n.tfName,n.defaultValue))&&n.tfDeprecatedName&&(i=py(t.attr,n.tfDeprecatedName,n.defaultValue));break;case"dtype[]":void 0===(i=hy(t.attr,n.tfName,n.defaultValue))&&n.tfDeprecatedName&&(i=hy(t.attr,n.tfDeprecatedName,n.defaultValue));break;case"tensor":case"tensors":break;default:throw new Error("Unsupported param type: "+n.type+" for op: "+t.op)}return e[n.name]={value:i,type:r},e},{})),n},t}();function oy(e,n){var r=Array.isArray(e)?String.fromCharCode.apply(null,e):function(e){var n=t.ENV.global;if(void 0!==n.atob)return n.atob(e);if("undefined"!=typeof Buffer)return new Buffer(e,"base64").toString();throw new Error("Unable to decode base64 in this environment. Missing built-in atob() or Buffer()")}(e);return n?r:r.toLowerCase()}function sy(t,e,n,r){void 0===r&&(r=!1);var i=t[e];return null!=i?oy(i.s,r):n}function uy(t,e,n){var r=t[e];return r?r.b:n}function ly(t,e,n){var r=t[e]||{},i=null!=r.i?r.i:null!=r.f?r.f:n;return"number"==typeof i?i:parseInt(i,10)}function cy(t){switch("string"==typeof t&&(t=Ov[t]),t){case Ov.DT_FLOAT:return"float32";case Ov.DT_INT32:return"int32";case Ov.DT_BOOL:return"bool";case Ov.DT_DOUBLE:return"float32";case Ov.DT_STRING:return"string";default:return null}}function py(t,e,n){var r=t[e];return r&&r.type?cy(r.type):n}function hy(t,e,n){var r=t[e];return r&&r.list&&r.list.type?r.list.type.map(function(t){return cy(t)}):n}function fy(t){if(!t.unknownRank)return null!=t.dim?t.dim.map(function(t){return"number"==typeof t.size?t.size:parseInt(t.size,10)}):[]}function dy(t,e,n){var r=t[e];return r&&r.shape?fy(r.shape):n}function my(t,e,n){var r=t[e];return r?((r.list.f&&r.list.f.length?r.list.f:r.list.i)||[]).map(function(t){return"number"==typeof t?t:parseInt(t,10)}):n}function gy(t,e,n,r){void 0===r&&(r=!1);var i=t[e];return i&&i.list&&i.list.s?i.list.s.map(function(t){return oy(t,r)}):n}function vy(t,e,n){var r=t[e];return r&&r.list&&r.list.shape?r.list.shape.map(function(t){return fy(t)}):n}function yy(t,e,n){var r=t[e];return r&&r.list&&r.list.b?r.list.b:n}var by=function(){function t(t,e,n){var r=this;this.node=t,this.tensorMap=e,this.context=n,this.inputs=[],this.attrs={},this.inputs=t.inputNames.map(function(t){return r.getInput(t)}),null!=t.rawAttrs&&(this.attrs=Object.keys(t.rawAttrs).reduce(function(t,e){return t[e]=r.getAttr(e),t},{}))}return t.prototype.getInput=function(t){return Pv(t,this.tensorMap,this.context)},t.prototype.getAttr=function(t,e){var n=this.node.rawAttrs[t];if(null!=n.tensor)return Pv(t,this.tensorMap,this.context);if(null!=n.i||null!=n.f)return ly(this.node.rawAttrs,t,e);if(null!=n.s)return sy(this.node.rawAttrs,t,e);if(null!=n.b)return uy(this.node.rawAttrs,t,e);if(null!=n.shape)return dy(this.node.rawAttrs,t,e);if(null!=n.type)return py(this.node.rawAttrs,t,e);if(null!=n.list){if(null!=n.list.i||null!=n.list.f)return my(this.node.rawAttrs,t,e);if(null!=n.list.s)return gy(this.node.rawAttrs,t,e);if(null!=n.list.shape)return vy(this.node.rawAttrs,t,e);if(null!=n.list.b)return yy(this.node.rawAttrs,t,e);if(null!=n.list.type)return hy(this.node.rawAttrs,t,e)}return e},t}(),xy=function(t,e,n){switch(t.op){case"BiasAdd":case"AddV2":case"Add":return[Ls(Lv("a",t,e,n),Lv("b",t,e,n))];case"AddN":return[Ps(Lv("tensors",t,e,n))];case"FloorMod":case"Mod":return[$s(Lv("a",t,e,n),Lv("b",t,e,n))];case"Mul":return[Ys(Lv("a",t,e,n),Lv("b",t,e,n))];case"RealDiv":case"Div":return[Ws(Lv("a",t,e,n),Lv("b",t,e,n))];case"FloorDiv":return[js(Lv("a",t,e,n),Lv("b",t,e,n))];case"Sub":return[nu(Lv("a",t,e,n),Lv("b",t,e,n))];case"Minimum":return[Gs(Lv("a",t,e,n),Lv("b",t,e,n))];case"Maximum":return[qs(Lv("a",t,e,n),Lv("b",t,e,n))];case"Pow":return[Zs(Lv("a",t,e,n),Lv("b",t,e,n))];case"SquaredDifference":return[tu(Lv("a",t,e,n),Lv("b",t,e,n))];default:throw TypeError("Node type "+t.op+" is not implemented")}},wy=function(t,e,n){switch(t.op){case"Abs":case"ComplexAbs":return[zo(Lv("x",t,e,n))];case"Acos":return[Lo(Lv("x",t,e,n))];case"Acosh":return[Po(Lv("x",t,e,n))];case"Asin":return[Bo(Lv("x",t,e,n))];case"Asinh":return[Vo(Lv("x",t,e,n))];case"Atan":return[Wo(Lv("x",t,e,n))];case"Atan2":return[Vs(Lv("x",t,e,n),Lv("y",t,e,n))];case"Atanh":return[Uo(Lv("x",t,e,n))];case"Ceil":return[jo(Lv("x",t,e,n))];case"Complex":return[tn(Lv("real",t,e,n),Lv("imag",t,e,n))];case"Cos":return[Ho(Lv("x",t,e,n))];case"Cosh":return[Go(Lv("x",t,e,n))];case"Elu":return[hl(Lv("x",t,e,n))];case"Erf":return[Ko(Lv("x",t,e,n))];case"Exp":return[$o(Lv("x",t,e,n))];case"Expm1":return[Xo(Lv("x",t,e,n))];case"Floor":return[Yo(Lv("x",t,e,n))];case"Log":return[Jo(Lv("x",t,e,n))];case"Log1p":return[Zo(Lv("x",t,e,n))];case"Imag":return[nn(Lv("x",t,e,n))];case"Neg":return[ts(Lv("x",t,e,n))];case"Reciprocal":return[es(Lv("x",t,e,n))];case"Real":return[en(Lv("x",t,e,n))];case"Relu":return[ml(Lv("x",t,e,n))];case"Round":return[ns(Lv("x",t,e,n))];case"Selu":return[gl(Lv("x",t,e,n))];case"Sigmoid":return[is(Lv("x",t,e,n))];case"Sin":return[ls(Lv("x",t,e,n))];case"Sign":return[as(Lv("x",t,e,n))];case"Sinh":return[cs(Lv("x",t,e,n))];case"Softplus":return[ps(Lv("x",t,e,n))];case"Sqrt":return[hs(Lv("x",t,e,n))];case"Square":return[fs(Lv("x",t,e,n))];case"Tanh":return[gs(Lv("x",t,e,n))];case"Tan":return[ms(Lv("x",t,e,n))];case"Relu6":case"ClipByValue":return[qo(Lv("x",t,e,n),Lv("clipValueMin",t,e,n),Lv("clipValueMax",t,e,n))];case"Rsqrt":return[rs(Pv(t.inputNames[0],e,n))];case"Prod":return[pl(Lv("x",t,e,n),Lv("axes",t,e,n))];case"LeakyRelu":return[fl(Lv("x",t,e,n),Lv("alpha",t,e,n))];default:throw TypeError("Node type "+t.op+" is not implemented")}},Ny=function(){function t(e,n,r,i,a,o,s){this.name=e,this.dtype=n,this.maxSize=r,this.elementShape=i,this.identicalElementShapes=a,this.dynamicSize=o,this.clearAfterRead=s,this.tensors=[],this.closed_=!1,this.id=t.nextId++}return Object.defineProperty(t.prototype,"closed",{get:function(){return this.closed_},enumerable:!0,configurable:!0}),t.prototype.clearAndClose=function(){this.tensors.forEach(function(t){return t.tensor.dispose()}),this.tensors=[],this.closed_=!0},t.prototype.size=function(){return this.tensors.length},t.prototype.read=function(t){if(this.closed_)throw new Error("TensorArray "+this.name+" has already been closed.");if(t<0||t>=this.tensors.length)throw new Error("Tried to read from index "+t+", but array size is: "+this.tensors.length);var e=this.tensors[t];if(e.cleared)throw new Error("TensorArray "+this.name+": Could not read index "+t+" twice because it was cleared after a previous read (perhaps try setting clear_after_read = false?).");return this.clearAfterRead&&(e.cleared=!0),e.read=!0,e.tensor},t.prototype.readMany=function(t){var e=this;return t.map(function(t){return e.read(t)})},t.prototype.write=function(t,e){if(this.closed_)throw new Error("TensorArray "+this.name+" has already been closed.");if(t<0||!this.dynamicSize&&t>=this.maxSize)throw new Error("Tried to write to index "+t+", but array is not resizeable and size is: "+this.maxSize);var n=this.tensors[t]||{};if(e.dtype!==this.dtype)throw new Error("TensorArray "+this.name+": Could not write to TensorArray index "+t+",\n          because the value dtype is "+e.dtype+", but TensorArray dtype is "+this.dtype+".");if(0!==this.size()||null!=this.elementShape&&0!==this.elementShape.length||(this.elementShape=e.shape),this.assertShapesMatchAllowUndefinedSize(this.elementShape,e.shape,"TensorArray "+this.name+": Could not write to TensorArray index "+t+"."),n&&n.read)throw new Error("TensorArray "+this.name+": Could not write to TensorArray index "+t+", because it has already been read.");if(n&&n.written)throw new Error("TensorArray "+this.name+": Could not write to TensorArray index "+t+", because it has already been written.");n.tensor=e,n.written=!0,this.tensors[t]=n},t.prototype.writeMany=function(t,e){var n=this;if(t.length!==e.length)throw new Error("TensorArray "+this.name+": could not write multiple tensors,because the index size: "+t.length+" is not the same as tensors size: "+e.length+".");t.forEach(function(t,r){return n.write(t,e[r])})},t.prototype.gather=function(t,e){if(e&&e!==this.dtype)throw new Error("TensorArray dtype is "+this.dtype+" but gather requested dtype "+e);if(!t){t=[];for(var n=0;n<this.size();n++)t.push(n)}if(0===t.length)return rn([],[0].concat(this.elementShape));var r=this.readMany(t);return this.assertShapesMatchAllowUndefinedSize(this.elementShape,r[0].shape,"TensorArray shape mismatch: "),sr(r,0)},t.prototype.concat=function(t){if(t&&t!==this.dtype)throw new Error("TensorArray dtype is "+this.dtype+" but concat requested dtype "+t);if(0===this.size())return rn([],[0].concat(this.elementShape));for(var e=[],n=0;n<this.size();n++)e.push(n);var r=this.readMany(e);return this.assertShapesMatchAllowUndefinedSize(this.elementShape,r[0].shape,"TensorArray shape mismatch: tensor array shape ("+this.elementShape+") vs first tensor shape ("+r[0].shape+")"),xn(r,0)},t.prototype.scatter=function(t,e){if(e.dtype!==this.dtype)throw new Error("TensorArray dtype is "+this.dtype+" but tensor has dtype "+e.dtype);if(t.length!==e.shape[0])throw new Error("Expected len(indices) == tensor.shape[0], but saw: "+t.length+" vs. "+e.shape[0]);var n=Math.max.apply(Math,t);if(!this.dynamicSize&&n>=this.maxSize)throw new Error("Max index must be < array size ("+n+"  vs. "+this.maxSize+")");this.writeMany(t,cr(e,0))},t.prototype.split=function(t,e){var n=this;if(e.dtype!==this.dtype)throw new Error("TensorArray dtype is "+this.dtype+" but tensor has dtype "+e.dtype);var r=0,i=t.map(function(t){return r+=t});if(r!==e.shape[0])throw new Error("Expected sum of lengths to be equal to\n          tensor.shape[0], but sum of lengths is\n        "+r+", and tensor's shape is: "+e.shape);if(!this.dynamicSize&&t.length!==this.maxSize)throw new Error("TensorArray's size is not equal to the size of lengths ("+this.maxSize+" vs. "+t.length+"), and the TensorArray is not marked as dynamically resizeable");var a=0===r?0:e.size/r,o=[];Fe(function(){e=e.reshape([1,r,a]);for(var s=0;s<t.length;++s){var u=[0,0===s?0:i[s-1],0],l=[1,t[s],a];o[s]=Xu(e,u,l).reshape(n.elementShape)}return o});for(var s=[],u=0;u<t.length;u++)s[u]=u;this.writeMany(s,o)},t.prototype.assertShapesMatchAllowUndefinedSize=function(t,e,n){void 0===n&&(n=""),J.assert(this.shapesEqualAllowUndefinedSize(t,e),function(){return n+" Shapes "+t+" and "+e+" must match"})},t.prototype.shapesEqualAllowUndefinedSize=function(t,e){if(t.length!==e.length)return!1;for(var n=0;n<t.length;n++)if(-1!==t[n]&&-1!==e[n]&&t[n]!==e[n])return!1;return!0},t.nextId=0,t}();var Cy=function(t,e,n){switch(t.op){case"Conv1D":var r=Lv("stride",t,e,n),i=Lv("pad",t,e,n),a=Lv("dataFormat",t,e,n).toUpperCase(),o=Lv("dilation",t,e,n);return[Su(Lv("x",t,e,n),Lv("filter",t,e,n),r,i,a,o)];case"Conv2D":r=Lv("strides",t,e,n),i=Lv("pad",t,e,n),a=Lv("dataFormat",t,e,n).toUpperCase();var s=Lv("dilations",t,e,n);return[ku(Lv("x",t,e,n),Lv("filter",t,e,n),[r[1],r[2]],i,a,[s[1],s[2]])];case"Conv2DBackpropInput":case"Conv2dTranspose":var u=Lv("outputShape",t,e,n);return r=Lv("strides",t,e,n),i=Lv("pad",t,e,n),[Ou(Lv("x",t,e,n),Lv("filter",t,e,n),u,[r[1],r[2]],i)];case"DepthwiseConv2dNative":case"DepthwiseConv2d":return r=Lv("strides",t,e,n),i=Lv("pad",t,e,n),s=Lv("dilations",t,e,n),a=Lv("dataFormat",t,e,n).toUpperCase(),[Tu(Lv("input",t,e,n),Lv("filter",t,e,n),[r[1],r[2]],i,a,[s[1],s[2]])];case"Conv3D":return r=Lv("strides",t,e,n),i=Lv("pad",t,e,n),a=Lv("dataFormat",t,e,n).toUpperCase(),s=Lv("dilations",t,e,n),[Iu(Lv("x",t,e,n),Lv("filter",t,e,n),[r[1],r[2],r[3]],i,a,[s[1],s[2],s[3]])];case"AvgPool":r=Lv("strides",t,e,n),i=Lv("pad",t,e,n);var l=Lv("kernelSize",t,e,n);return[Hu(Lv("x",t,e,n),[l[1],l[2]],[r[1],r[2]],i)];case"MaxPool":return r=Lv("strides",t,e,n),i=Lv("pad",t,e,n),l=Lv("kernelSize",t,e,n),[qu(Lv("x",t,e,n),[l[1],l[2]],[r[1],r[2]],i)];case"AvgPool3D":return r=Lv("strides",t,e,n),i=Lv("pad",t,e,n),l=Lv("kernelSize",t,e,n),[$u(Lv("x",t,e,n),[l[1],l[2],l[3]],[r[1],r[2],r[3]],i)];case"MaxPool3D":return r=Lv("strides",t,e,n),i=Lv("pad",t,e,n),l=Lv("kernelSize",t,e,n),[Ku(Lv("x",t,e,n),[l[1],l[2],l[3]],[r[1],r[2],r[3]],i)];default:throw TypeError("Node type "+t.op+" is not implemented")}},Ey=function(t,e,n){switch(t.op){case"Fill":var r=Lv("shape",t,e,n),i=Lv("dtype",t,e,n);return[mn(r,Lv("value",t,e,n),i)];case"LinSpace":var a=Lv("start",t,e,n);return[gn(a,Lv("stop",t,e,n),Lv("num",t,e,n))];case"OneHot":var o=Lv("indices",t,e,n),s=Lv("depth",t,e,n),u=Lv("onValue",t,e,n),l=Lv("offValue",t,e,n);return[$n(o,s,u,l)];case"Ones":return[fn(Lv("shape",t,e,n),Lv("dtype",t,e,n))];case"OnesLike":return[yn(Lv("x",t,e,n))];case"RandomUniform":return[rr(Lv("shape",t,e,n),Lv("minval",t,e,n),Lv("maxval",t,e,n),Lv("dtype",t,e,n))];case"Range":return[vn(a=Lv("start",t,e,n),Lv("stop",t,e,n),Lv("step",t,e,n),Lv("dtype",t,e,n))];case"TruncatedNormal":r=Lv("shape",t,e,n);var c=Lv("mean",t,e,n),p=Lv("stdDev",t,e,n),h=Lv("seed",t,e,n);return[lr(r,c,p,Lv("dtype",t,e,n),h)];case"Zeros":return[dn(Lv("shape",t,e,n),Lv("dtype",t,e,n))];case"ZerosLike":return[bn(Lv("x",t,e,n))];default:throw TypeError("Node type "+t.op+" is not implemented")}};var Sy=function(t,e,n){switch(t.op){case"TopKV2":var r=Lv("x",t,e,n),i=Lv("k",t,e,n),a=Lv("sorted",t,e,n),o=El(r,i,a);return[o.values,o.indices];default:throw TypeError("Node type "+t.op+" is not implemented")}},ky=function(t,e,n){switch(t.op){case"Const":return e[t.name];case"PlaceholderWithDefault":var r=Lv("default",t,e,n);return[Pv(t.name,e,n)||r];case"Placeholder":return[Pv(t.name,e,n)];case"Identity":case"StopGradient":case"FakeQuantWithMinMaxVars":return[Lv("x",t,e,n).clone()];case"IdentityN":return Lv("x",t,e,n).map(function(t){return t.clone()});case"Snapshot":return[Lv("x",t,e,n).clone()];case"Shape":return[sn(Lv("x",t,e,n).shape,"int32")];case"ShapeN":return Lv("x",t,e,n).map(function(t){return sn(t.shape)});case"Size":return[on(Lv("x",t,e,n).size,"int32")];case"Rank":return[on(Lv("x",t,e,n).rank,"int32")];case"NoOp":return[];case"Print":var i=Lv("x",t,e,n),a=Lv("data",t,e,n),o=Lv("message",t,e,n),s=Lv("summarize",t,e,n);console.warn("The graph has a tf.print() operation,usually used for debugging, which slows down performance."),console.log(o);for(var u=0;u<a.length;u++)console.log(Array.prototype.slice.call(a[u].dataSync()).slice(0,s));return[i];default:throw TypeError("Node type "+t.op+" is not implemented")}},Iy=function(t,e,n){switch(t.op){case"ResizeBilinear":var r=Lv("images",t,e,n),i=Lv("size",t,e,n),a=Lv("alignCorners",t,e,n);return[sc.resizeBilinear(r,[i[0],i[1]],a)];case"ResizeNearestNeighbor":return r=Lv("images",t,e,n),i=Lv("size",t,e,n),a=Lv("alignCorners",t,e,n),[sc.resizeNearestNeighbor(r,[i[0],i[1]],a)];case"CropAndResize":var o=Lv("image",t,e,n),s=Lv("boxes",t,e,n),u=Lv("boxInd",t,e,n),l=Lv("cropSize",t,e,n),c=Lv("method",t,e,n),p=Lv("extrapolationValue",t,e,n);return[sc.cropAndResize(o,s,u,l,c,p)];default:throw TypeError("Node type "+t.op+" is not implemented")}},Ay=function(t,e,n){switch(t.op){case"Equal":return[iu(Lv("a",t,e,n),Lv("b",t,e,n))];case"NotEqual":return[du(Lv("a",t,e,n),Lv("b",t,e,n))];case"Greater":return[ou(Lv("a",t,e,n),Lv("b",t,e,n))];case"GreaterEqual":return[su(Lv("a",t,e,n),Lv("b",t,e,n))];case"Less":return[cu(Lv("a",t,e,n),Lv("b",t,e,n))];case"LessEqual":return[pu(Lv("a",t,e,n),Lv("b",t,e,n))];case"LogicalAnd":return[Ds(Lv("a",t,e,n),Lv("b",t,e,n))];case"LogicalNot":return[Os(Lv("a",t,e,n))];case"LogicalOr":return[_s(Lv("a",t,e,n),Lv("b",t,e,n))];case"Select":return[Ms(Lv("condition",t,e,n),Lv("a",t,e,n),Lv("b",t,e,n))];default:throw TypeError("Node type "+t.op+" is not implemented")}},Ry=function(t,e,n){switch(t.op){case"BatchMatMul":case"BatchMatMulV2":case"MatMul":return[Fu(Lv("a",t,e,n),Lv("b",t,e,n),Lv("transposeA",t,e,n),Lv("transposeB",t,e,n))];case"Transpose":return[vl(Lv("x",t,e,n),Lv("perm",t,e,n))];default:throw TypeError("Node type "+t.op+" is not implemented")}},Ty=function(t,e,n){switch(t.op){case"FusedBatchNorm":case"FusedBatchNormV2":case"FusedBatchNormV3":return[Is(Lv("x",t,e,n),Lv("mean",t,e,n),Lv("variance",t,e,n),Lv("offset",t,e,n),Lv("scale",t,e,n),Lv("epsilon",t,e,n))];case"LRN":return[yl(Lv("x",t,e,n),Lv("radius",t,e,n),Lv("bias",t,e,n),Lv("alpha",t,e,n),Lv("beta",t,e,n))];case"Softmax":return[Rr(Lv("x",t,e,n))];case"LogSoftmax":return[Tr(Lv("x",t,e,n))];case"SparseToDense":return[Dl(Lv("sparseIndices",t,e,n),Lv("outputShape",t,e,n),Lv("sparseValues",t,e,n),Lv("defaultValue",t,e,n))];default:throw TypeError("Node type "+t.op+" is not implemented")}},Dy=function(t,e,n){switch(t.op){case"Max":var r=Lv("axis",t,e,n),i=Lv("keepDims",t,e,n);return[ol(Lv("x",t,e,n),r,i)];case"Mean":return r=Lv("axis",t,e,n),i=Lv("keepDims",t,e,n),[sl(Lv("x",t,e,n),r,i)];case"Min":return r=Lv("axis",t,e,n),i=Lv("keepDims",t,e,n),[ul(Lv("x",t,e,n),r,i)];case"Sum":return r=Lv("axis",t,e,n),i=Lv("keepDims",t,e,n),[cl(Lv("x",t,e,n),r,i)];case"All":return r=Lv("axis",t,e,n),i=Lv("keepDims",t,e,n),[el(Lv("x",t,e,n),r,i)];case"Any":return r=Lv("axis",t,e,n),i=Lv("keepDims",t,e,n),[nl(Lv("x",t,e,n),r,i)];case"ArgMax":return r=Lv("axis",t,e,n),[rl(Lv("x",t,e,n),r)];case"ArgMin":return r=Lv("axis",t,e,n),[il(Lv("x",t,e,n),r)];case"Prod":return r=Lv("axis",t,e,n),i=Lv("keepDims",t,e,n),[pl(Lv("x",t,e,n),r,i)];default:throw TypeError("Node type "+t.op+" is not implemented")}},Oy=function(t,e,n){switch(t.op){case"ConcatV2":case"Concat":var r=Lv("axis",t,e,n),i=Lv("tensors",t,e,n);return[xn(i,r)];case"GatherV2":case"Gather":r=Lv("axis",t,e,n);var a=Lv("x",t,e,n),o=Lv("indices",t,e,n);return[yu(a,o.asType("int32"),r)];case"ReverseV2":case"Reverse":return r=Lv("axis",t,e,n),a=Lv("x",t,e,n),[Lu(a,r)];case"Slice":var s=Lv("begin",t,e,n),u=Lv("size",t,e,n);return[Xu(Lv("x",t,e,n),s,u)];case"StridedSlice":s=Lv("begin",t,e,n);var l=Lv("end",t,e,n),c=Lv("strides",t,e,n),p=Lv("beginMask",t,e,n),h=Lv("endMask",t,e,n),f=Lv("ellipsisMask",t,e,n),d=Lv("newAxisMask",t,e,n),m=Lv("shrinkAxisMask",t,e,n),g=Lv("x",t,e,n);if(1===s.length&&g.shape.length>1)for(var v=1;v<g.shape.length;v++)s.push(0),l.push(g.shape[v]),c.push(c[0]);return[Cl(g,s,l,c,p,h,f,d,m)];case"Pack":return Fe(function(){var r=Lv("axis",t,e,n),i=Lv("tensors",t,e,n),a=i[0].shape,o=i[0].squeeze().shape,s=i.map(function(t){var e=J.arraysEqual(t.shape,a);if(!e&&!J.arraysEqual(t.squeeze().shape,o))throw new Error("the input tensors shape does not match");return e?t:t.reshape(a)});return[sr(s,r)]});case"Unpack":return Fe(function(){var r=Lv("axis",t,e,n),i=Lv("tensor",t,e,n);return cr(i,r)});case"Tile":var y=Lv("reps",t,e,n);return[ur(Lv("x",t,e,n),y)];case"Split":case"SplitV":r=Lv("axis",t,e,n);var b=Lv("numOrSizeSplits",t,e,n);return Sn(Lv("x",t,e,n),b,r);case"ScatterNd":o=Lv("indices",t,e,n);var x=Lv("values",t,e,n),w=Lv("shape",t,e,n);return[Sl(o,x,w)];case"GatherNd":var N=Lv("x",t,e,n);return o=Lv("indices",t,e,n),[Ol(N,o)];case"SparseToDense":o=Lv("sparseIndices",t,e,n),w=Lv("outputShape",t,e,n);var C=Lv("sparseValues",t,e,n),E=Lv("defaultValue",t,e,n);return[Dl(o,C,w,C.dtype===E.dtype?E:E.asType(C.dtype))];default:throw TypeError("Node type "+t.op+" is not implemented")}},_y=function(t,e,n){switch(t.op){case"FFT":return[kl(Lv("x",t,e,n))];case"IFFT":return[Il(Lv("x",t,e,n))];case"RFFT":return[Al(Lv("x",t,e,n))];case"IRFFT":return[Rl(Lv("x",t,e,n))];default:throw TypeError("Node type "+t.op+" is not implemented")}},Fy=function(t,e,n){switch(t.op){case"Cast":return[Wn(Lv("x",t,e,n),Lv("dtype",t,e,n))];case"ExpandDims":var r=Lv("axis",t,e,n);return[Hn(Lv("x",t,e,n),r)];case"Squeeze":return r=Lv("axis",t,e,n),[or(Lv("x",t,e,n),r)];case"Reshape":return[ir(Lv("x",t,e,n),Lv("shape",t,e,n))];case"PadV2":case"Pad":return[Xn(Lv("x",t,e,n),Uv(Lv("padding",t,e,n),2),Lv("constantValue",t,e,n))];case"SpaceToBatchND":var i=Lv("blockShape",t,e,n),a=Uv(Lv("paddings",t,e,n),2);return[ar(Lv("x",t,e,n),i,a)];case"BatchToSpaceND":i=Lv("blockShape",t,e,n);var o=Uv(Lv("crops",t,e,n),2);return[Vn(Lv("x",t,e,n),i,o)];case"DepthToSpace":var s=Lv("blockSize",t,e,n),u=Lv("dataFormat",t,e,n).toUpperCase();return[qn(Lv("x",t,e,n),s,u)];default:throw TypeError("Node type "+t.op+" is not implemented")}};function My(t,e,n){var r=function(t,e,n){switch(t.category){case"arithmetic":return xy(t,e,n);case"basic_math":return wy(t,e,n);case"control":return function(t,e,n){return Tv(this,void 0,void 0,function(){var r,i,a,o,s,u,l,c,p,h,f,d,m,g,v,y,b,x,w,N,C,E,S,k,I,A,R,T,D,O,_,F,M,z;return Dv(this,function(L){switch(L.label){case 0:switch(t.op){case"LoopCond":return[3,1];case"Switch":return[3,2];case"Merge":return[3,4];case"Enter":return[3,5];case"Exit":return[3,6];case"NextIteration":return[3,7];case"TensorArrayV3":return[3,8];case"TensorArrayWriteV3":return[3,9];case"TensorArrayReadV3":return[3,10];case"TensorArrayGatherV3":return[3,11];case"TensorArrayScatterV3":return[3,12];case"TensorArrayConcatV3":return[3,13];case"TensorArraySplitV3":return[3,14];case"TensorArraySizeV3":return[3,15];case"TensorArrayCloseV3":return[3,16]}return[3,17];case 1:return[2,[Lv("pred",t,e,n).clone()]];case 2:return r=Lv("pred",t,e,n),i=Lv("data",t,e,n),[4,r.data()];case 3:return[2,L.sent()[0]?[void 0,i.clone()]:[i.clone(),void 0]];case 4:return[2,(a=t.inputNames.find(function(t){return void 0!==Pv(t,e,n)}))?[Pv(a,e,n).clone()]:void 0];case 5:return o=Lv("frameName",t,e,n),s=Lv("tensor",t,e,n),n.enterFrame(o),[2,[s.clone()]];case 6:return u=Lv("tensor",t,e,n),n.exitFrame(),[2,[u.clone()]];case 7:return l=Lv("tensor",t,e,n),n.nextIteration(),[2,[l.clone()]];case 8:return c=Lv("size",t,e,n),p=Lv("dtype",t,e,n),h=Lv("elementShape",t,e,n),f=Lv("dynamicSize",t,e,n),d=Lv("clearAfterRead",t,e,n),m=Lv("identicalElementShapes",t,e,n),g=Lv("name",t,e,n),v=new Ny(g,p,c,h,m,f,d),n.addTensorArray(v),[2,[on(v.id),on(1)]];case 9:return y=Lv("tensorArrayId",t,e,n),b=Lv("index",t,e,n),x=Lv("tensor",t,e,n),n.getTensorArray(y).write(b,x),[2,[on(1)]];case 10:return w=Lv("tensorArrayId",t,e,n),N=Lv("index",t,e,n),[2,[n.getTensorArray(w).read(N)]];case 11:return C=Lv("tensorArrayId",t,e,n),E=Lv("indices",t,e,n),S=Lv("dtype",t,e,n),[2,[n.getTensorArray(C).gather(E,S)]];case 12:return k=Lv("tensorArrayId",t,e,n),I=Lv("indices",t,e,n),A=Lv("tensor",t,e,n),n.getTensorArray(k).scatter(I,A),[2,[on(1)]];case 13:return R=Lv("tensorArrayId",t,e,n),T=n.getTensorArray(R),D=Lv("dtype",t,e,n),[2,[T.concat(D)]];case 14:return O=Lv("tensorArrayId",t,e,n),_=Lv("tensor",t,e,n),F=Lv("lengths",t,e,n),n.getTensorArray(O).split(F,_),[2,[on(1)]];case 15:return M=Lv("tensorArrayId",t,e,n),[2,[on(n.getTensorArray(M).size(),"int32")]];case 16:return z=Lv("tensorArrayId",t,e,n),n.getTensorArray(z).clearAndClose(),[2,[]];case 17:throw TypeError("Node type "+t.op+" is not implemented")}})})}(t,e,n);case"convolution":return Cy(t,e,n);case"creation":return Ey(t,e,n);case"dynamic":return function(t,e,n){return Tv(this,void 0,void 0,function(){var r,i,a,o,s;return Dv(this,function(u){switch(u.label){case 0:switch(t.op){case"NonMaxSuppressionV3":case"NonMaxSuppressionV2":return[3,1];case"Where":return[3,3];case"ListDiff":return[3,5]}return[3,7];case 1:return r=Lv("boxes",t,e,n),i=Lv("scores",t,e,n),a=Lv("maxOutputSize",t,e,n),o=Lv("iouThreshold",t,e,n),s=Lv("scoreThreshold",t,e,n),[4,sc.nonMaxSuppressionAsync(r,i,a,o,s)];case 2:return[2,[u.sent()]];case 3:return[4,zs(Lv("condition",t,e,n))];case 4:return[2,[u.sent()]];case 5:return[4,pr(Lv("x",t,e,n),Lv("y",t,e,n))];case 6:return[2,u.sent()];case 7:throw TypeError("Node type "+t.op+" is not implemented")}})})}(t,e,n);case"evaluation":return Sy(t,e,n);case"image":return Iy(t,e,n);case"graph":return ky(t,e,n);case"logical":return Ay(t,e,n);case"matrices":return Ry(t,e,n);case"normalization":return Ty(t,e,n);case"reduction":return Dy(t,e,n);case"slice_join":return Oy(t,e,n);case"spectral":return _y(t,e,n);case"transformation":return Fy(t,e,n);case"custom":var r=zv(t.op);if(r&&r.customExecutor)return r.customExecutor(new by(t,e,n));throw TypeError("Custom op "+t.op+" is not registered.");default:throw TypeError("Unknown op '"+t.op+"'. File an issue at https://github.com/tensorflow/tfjs/issues so we can add it, or register a custom execution with tf.registerOp()")}}(t,e,n);return r instanceof Promise?r.then(function(t){return[].concat(t)}):[].concat(r)}var zy=function(){function t(t,e){this.weightMap=t,this.tensorArrayMap=e,this.rootContext={id:0,frameName:"",iterationId:0},this.contexts=[this.rootContext],this.lastId=0,this.generateCurrentContextIds()}return t.prototype.newFrame=function(t,e){return{id:t,frameName:e,iterationId:0}},Object.defineProperty(t.prototype,"currentContext",{get:function(){return this.contexts},set:function(t){this.contexts!==t&&(this.contexts=t,this.generateCurrentContextIds())},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"currentContextId",{get:function(){return this._currentContextIds[0]},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"currentContextIds",{get:function(){return this._currentContextIds},enumerable:!0,configurable:!0}),t.prototype.generateCurrentContextIds=function(){for(var t=[],e=0;e<this.contexts.length-1;e++){var n=this.contexts.slice(0,this.contexts.length-e);t.push(this.contextIdforContexts(n))}t.push(""),this._currentContextIds=t},t.prototype.contextIdforContexts=function(t){return t?t.map(function(t){return 0===t.id&&0===t.iterationId?"":t.frameName+"-"+t.iterationId}).join("/"):""},t.prototype.enterFrame=function(t){this.contexts&&(this.lastId++,this.contexts=this.contexts.slice(),this.contexts.push(this.newFrame(this.lastId,t)),this._currentContextIds.unshift(this.contextIdforContexts(this.contexts)))},t.prototype.exitFrame=function(){if(!(this.contexts&&this.contexts.length>1))throw new Error("Cannot exit frame, the context is empty");this.contexts=this.contexts.slice(),this.contexts.splice(-1),this.currentContextIds.shift()},t.prototype.nextIteration=function(){if(!(this.contexts&&this.contexts.length>0))throw new Error("Cannot increase frame iteration, the context is empty");this.contexts=this.contexts.slice(),this.lastId++;var t=Object.assign({},this.contexts[this.contexts.length-1]);t.iterationId+=1,t.id=this.lastId,this.contexts.splice(-1,1,t),this._currentContextIds.splice(0,1,this.contextIdforContexts(this.contexts))},t.prototype.getWeight=function(t){return this.weightMap[t]},t.prototype.addTensorArray=function(t){this.tensorArrayMap[t.id]=t},t.prototype.getTensorArray=function(t){return this.tensorArrayMap[t]},t}();function Ly(t,e,n){for(var r=new Set,i=[],a=null,o=null,s=new Set,u=e.slice();u.length>0;){var l=u.pop();(Vy(l)||Wy(l))&&null==a&&(o=(a=l).children.map(function(t){return t.name}).filter(function(t){return r.has(t)})),r.add(l.name),null==n[l.name]&&null==t[l.name]&&(0!==l.inputs.length?l.inputs.forEach(function(t){s.has(t.name)||(s.add(t.name),u.push(t))}):i.push(l.name))}return{inputs:t,outputs:e,usedNodes:r,missingInputs:i,dynamicNode:a,syncInputs:o}}var Py=["Switch","Merge","Enter","Exit","NextIteration"],By=["NonMaxSuppressionV2","NonMaxSuppressionV3","Where"];function Vy(t){return Py.indexOf(t.op)>=0}function Wy(t){return By.indexOf(t.op)>=0}var Uy=function(){function t(t){this.graph=t,this.compiledMap=new Map,this._weightMap={},this.SEPERATOR=",",this.placeholders=t.placeholders,this._outputs=t.outputs}return Object.defineProperty(t.prototype,"weightMap",{get:function(){return this._weightMap},set:function(t){var e=Object.keys(t).map(function(e){return t[e].map(function(t){return t.id})});this.weightIds=[].concat.apply([],e),this._weightMap=t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"inputs",{get:function(){return this.placeholders.map(function(t){return{name:t.name,shape:t.attrParams.shape?t.attrParams.shape.value:void 0,dtype:t.attrParams.dtype?t.attrParams.dtype.value:void 0}})},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"outputs",{get:function(){return this._outputs.map(function(t){return{name:t.name,shape:t.attrParams.shape?t.attrParams.shape.value:void 0,dtype:t.attrParams.dtype?t.attrParams.dtype.value:void 0}})},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"inputNodes",{get:function(){return this.placeholders.map(function(t){return t.name})},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"outputNodes",{get:function(){return this.outputs.map(function(t){return t.name})},enumerable:!0,configurable:!0}),t.prototype.getCompilationKey=function(t,e){var n=t.map(function(t){return t.name}).sort(),r=e.map(function(t){return t.name}).sort();return n.join(this.SEPERATOR)+"--"+r.join(this.SEPERATOR)},t.prototype.compile=function(t,e){var n=Ly(t,e,this.weightMap),r=n.missingInputs,i=n.dynamicNode,a=n.syncInputs;if(null!=i)throw new Error("This execution contains the node '"+i.name+"', which has the dynamic op '"+i.op+"'. Please use model.executeAsync() instead. Alternatively, to avoid the dynamic ops, specify the inputs ["+a+"]");if(r.length>0){var o=e.map(function(t){return t.name}),s=Object.keys(t);throw new Error("Cannot compute the outputs ["+o+"] from the provided inputs ["+s+"]. Missing the following inputs: ["+r+"]")}return function(t,e,n){var r=n.usedNodes,i=n.inputs,a=[];Object.keys(i).map(function(e){return t.nodes[e]}).forEach(function(t){r.has(t.name)&&a.push(t)}),t.weights.forEach(function(t){r.has(t.name)&&a.push(t)});for(var o=new Set,s=[];a.length>0;){var u=a.pop();o.add(u.name),e[u.name]||s.push(u),u.children.forEach(function(t){!o.has(t.name)&&r.has(t.name)&&t.inputs.every(function(t){return o.has(t.name)})&&a.push(t)})}return s}(this.graph,this.weightMap,n)},t.prototype.fusePrelu=function(){!function(t,e){var n=function(n){var r=t.nodes[n];if(null==r||"Add"!==r.op&&"AddV2"!==r.op||2!==r.inputNames.length)return"continue";var i=r.inputs.find(function(t){return"Relu"===t.op});if(null==i||1!==i.inputNames.length)return"continue";var a=r.inputs.find(function(t){return"Mul"===t.op});if(null==a||2!==a.inputNames.length)return"continue";var o=a.inputs.find(function(t){return"Const"===t.op}),s=a.inputs.find(function(t){return"Relu"===t.op});if(null==o||null==s||1!==s.inputNames.length)return"continue";var u=s.inputs[0];if(null==u||"Neg"!==u.op||1!==u.inputNames.length)return"continue";if(i.inputNames[0]!==u.inputNames[0])return"continue";var l=i.inputs[0],c=r.children,p=o.name+"_neg",h={name:p,inputNames:[],inputs:[],attrParams:{},category:"graph",children:[],op:"Const",inputParams:{},rawAttrs:{}};e[p]=[ts(e[o.name][0])],t.weights.push(h);var f={name:r.name+"_Prelu",inputNames:[l.name,h.name],inputs:[l,h],attrParams:{},category:"custom",children:c,op:"Prelu",inputParams:{x:{inputIndexStart:0,type:"tensor"},alpha:{inputIndexStart:1,type:"tensor"}}};h.children.push(f);var d=o.children.indexOf(a);d>-1&&o.children.splice(d,1);var m=l.children.indexOf(i);m>-1&&l.children.splice(m,1);var g=l.children.indexOf(u);if(g>-1&&l.children.splice(g,1),l.children.push(f),c.forEach(function(t){var e=t.inputNames.indexOf(r.name);e>-1&&(t.inputNames[e]=f.name,t.inputs[e]=f)}),0===c.length){var v=t.outputs.indexOf(r);v>-1&&t.outputs.splice(v,1),t.outputs.push(f)}delete t.nodes[r.name],delete t.nodes[a.name],delete t.nodes[i.name],delete t.nodes[s.name],delete t.nodes[u.name],t.nodes[f.name]=f,t.nodes[h.name]=h};for(var r in t.nodes)n(r)}(this.graph,this.weightMap)},t.prototype.execute=function(t,e){var n=this,r=Object.keys(t).sort();this.checkInputs(t),this.checkInputShapeAndType(t),this.checkOutputs(e);var i=r.map(function(t){return n.graph.nodes[t]}),a=e.map(function(t){return n.graph.nodes[Wv(t)[0]]}),o=this.getCompilationKey(i,a),s=this.compiledMap.get(o);null==s&&(s=this.compile(t,a),this.compiledMap.set(o,s));var u={};return Fe(function(){var r=new zy(n._weightMap,u),i=Rv({},n.weightMap);Object.keys(t).forEach(function(e){i[e]=[t[e]]});for(var a=n.getFrozenTensorIds(i),o={},l=0;l<s.length;l++){var c=s[l];if(!i[c.name]){var p=My(c,i,r);if(p instanceof Promise)throw new Error("The execution of the op '"+c.op+"' returned a promise. Please use model.executeAsync() instead.");i[c.name]=p,n.checkTensorForDisposal(c.name,c,i,r,a,e,o)}}return e.map(function(t){return Pv(t,i,r)})})},t.prototype.getFrozenTensorIds=function(t){var e=[].concat.apply([],Object.keys(t).map(function(e){return t[e]}).map(function(t){return t.map(function(t){return t.id})}));return new Set(e)},t.prototype.checkTensorForDisposal=function(t,e,n,r,i,a,o){"control"!==e.category&&-1===a.indexOf(t)&&(n[t].forEach(function(t){null!=t&&(o[t.id]=(o[t.id]||0)+e.children.length)}),e.inputs.forEach(function(t){if("control"!==t.category){var e=function(t,e,n){return e[Vv(t,n.currentContextId)]}(t.name,n,r);null!=e&&e.forEach(function(t){if(t&&!i.has(t.id)){var e=o[t.id];1===e?(t.dispose(),delete o[t.id]):null!=e&&o[t.id]--}})}}))},t.prototype.executeAsync=function(t,e){return Tv(this,void 0,void 0,function(){var n,r,i,a,o,s,u=this;return Dv(this,function(l){switch(l.label){case 0:return this.checkInputs(t),this.checkInputShapeAndType(t),this.checkOutputs(e),n={},r=new zy(this._weightMap,n),[4,this.executeWithControlFlow(t,r,e)];case 1:return i=l.sent(),a=e.map(function(t){return Pv(t,i,r)}),o=new Set(a.map(function(t){return t.id})),s=new Set(Object.keys(t).map(function(e){return t[e].id})),Object.keys(i).forEach(function(t){i[t].forEach(function(t){!t||t.isDisposed||o.has(t.id)||s.has(t.id)||-1!==u.weightIds.indexOf(t.id)||t.dispose()})}),[2,a]}})})},t.prototype.executeWithControlFlow=function(t,e,n){return Tv(this,void 0,void 0,function(){var r,i,a,o,s,u,l,c,p,h,f,d,m,g,v,y,b=this;return Dv(this,function(x){switch(x.label){case 0:r=Object.keys(t),i=r.map(function(t){return b.graph.nodes[t]}),a=n.map(function(t){return b.graph.nodes[Wv(t)[0]]}),o=Ly(t,a,this.weightMap),s=o.usedNodes,u=o.missingInputs,l=o.dynamicNode,c=o.syncInputs,p=i.concat(this.graph.weights).map(function(t){return{node:t,contexts:e.currentContext}}),h=Rv({},this.weightMap),Object.keys(t).forEach(function(e){h[e]=[t[e]]}),f={},d=this.getFrozenTensorIds(h),m={},x.label=1;case 1:return p.length>0?(g=this.processStack(i,p,e,h,m,d,n,f,s),[4,Promise.all(g)]):[3,3];case 2:return x.sent(),[3,1];case 3:if(null==l&&console.warn("This model execution did not contain any nodes with control flow or dynamic output shapes. You can use model.execute() instead."),(v=a.filter(function(t){return!Vy(t)&&!Pv(t.name,h,e)}).map(function(t){return t.name})).length>0)throw y="",null!=l&&(y="Alternatively, to avoid the dynamic ops, use model.execute() and specify the inputs ["+c+"]"),new Error("Cannot compute the outputs ["+v+"] from the provided inputs ["+r+"]. Consider providing the following inputs: ["+u+"]. "+y);return[2,h]}})})},t.prototype.processStack=function(t,e,n,r,i,a,o,s,u){for(var l=this,c=[],p=function(){var p=e.pop();n.currentContext=p.contexts;var f="";if("Enter"===p.node.op&&Lv("isConstant",p.node,r,n)&&(f=Bv(p.node.name,n)[0]),-1===t.indexOf(p.node)){var d=My(p.node,r,n);f||(f=Bv(p.node.name,n)[0]);var m=n.currentContext;d instanceof Promise?c.push(d.then(function(t){return r[f]=t,n.currentContext=m,l.checkTensorForDisposal(f,p.node,r,n,a,o,s),l.processChildNodes(p.node,e,n,r,i,u),t})):(r[f]=d,h.checkTensorForDisposal(f,p.node,r,n,a,o,s),h.processChildNodes(p.node,e,n,r,i,u))}else h.processChildNodes(p.node,e,n,r,i,u)},h=this;e.length>0;)p();return c},t.prototype.processChildNodes=function(t,e,n,r,i,a){t.children.forEach(function(t){var o=Bv(t.name,n)[0];!i[o]&&a.has(t.name)&&("Merge"===t.op?t.inputNames.some(function(t){return!!Pv(t,r,n)})&&(i[o]=!0,e.push({contexts:n.currentContext,node:t})):t.inputNames.every(function(t){return!!Pv(t,r,n)})&&(i[o]=!0,e.push({contexts:n.currentContext,node:t})))})},t.prototype.dispose=function(){var t=this;Object.keys(this.weightMap).forEach(function(e){return t.weightMap[e].forEach(function(t){return t.dispose()})})},t.prototype.checkInputShapeAndType=function(t){var e=this;Object.keys(t).forEach(function(n){var r=t[n],i=e.graph.nodes[n];if(i.attrParams.shape&&i.attrParams.shape.value){var a=i.attrParams.shape.value,o=a.length===r.shape.length&&r.shape.every(function(t,e){return-1===a[e]||a[e]===t});J.assert(o,function(){return"The shape of dict['"+i.name+"'] provided in model.execute(dict) must be ["+a+"], but was ["+r.shape+"]"})}i.attrParams.dtype&&i.attrParams.dtype.value&&J.assert(r.dtype===i.attrParams.dtype.value,function(){return"The dtype of dict['"+i.name+"'] provided in model.execute(dict) must be "+i.attrParams.dtype.value+", but was "+r.dtype})})},t.prototype.checkInputs=function(t){var e=this,n=Object.keys(t).filter(function(t){return!e.graph.nodes[t]});if(n.length>0)throw new Error("The dict provided in model.execute(dict) has keys: ["+n+"] that are not part of graph")},t.prototype.checkOutputs=function(t){var e=this;t.forEach(function(t){var n=Wv(t)[0];if(!e.graph.nodes[n])throw new Error("The output '"+t+"' is not found in the graph")})},t}(),jy="?tfjs-format=file",qy="model.json",Hy=function(){function t(t,e){void 0===e&&(e={}),this.modelUrl=t,this.loadOptions=e,this.version="n/a",null==e&&(this.loadOptions={})}return Object.defineProperty(t.prototype,"modelVersion",{get:function(){return this.version},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"inputNodes",{get:function(){return this.executor.inputNodes},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"outputNodes",{get:function(){return this.executor.outputNodes},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"inputs",{get:function(){return this.executor.inputs},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"outputs",{get:function(){return this.executor.outputs},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"weights",{get:function(){return this.executor.weightMap},enumerable:!0,configurable:!0}),t.prototype.fusePrelu=function(){this.executor.fusePrelu(),null==zv("Prelu")&&Mv("Prelu",function(t){var e=t.inputs[0],n=t.inputs[1];return dl(e,n)})},t.prototype.findIOHandler=function(){var t=this.modelUrl;if(null!=t.load)this.handler=t;else if(null!=this.loadOptions.requestInit)this.handler=cp.browserHTTPRequest(t,this.loadOptions);else{var e=cp.getLoadHandlers(t,this.loadOptions.onProgress);if(0===e.length)e.push(cp.browserHTTPRequest(t,this.loadOptions));else if(e.length>1)throw new Error("Found more than one ("+e.length+") load handlers for URL '"+[t]+"'");this.handler=e[0]}},t.prototype.load=function(){return Tv(this,void 0,void 0,function(){var t,e,n;return Dv(this,function(r){switch(r.label){case 0:if(this.findIOHandler(),null==this.handler.load)throw new Error("Cannot proceed with model loading because the IOHandler provided does not have the `load` method implemented.");return[4,this.handler.load()];case 1:return t=r.sent(),e=t.modelTopology,this.version=e.versions.producer+"."+e.versions.minConsumer,n=cp.decodeWeights(t.weightData,t.weightSpecs),this.executor=new Uy(ay.Instance.transformGraph(e)),this.executor.weightMap=this.convertTensorMapToTensorsMap(n),[2,!0]}})})},t.prototype.predict=function(t,e){return this.execute(t,this.outputNodes)},t.prototype.normalizeInputs=function(t){if(!(t instanceof ct||Array.isArray(t)))return t;if((t=Array.isArray(t)?t:[t]).length!==this.inputNodes.length)throw new Error("Input tensor count mismatch,the graph model has "+this.inputNodes.length+" placeholders, while there are "+t.length+" input tensors.");return this.inputNodes.reduce(function(e,n,r){return e[n]=t[r],e},{})},t.prototype.normalizeOutputs=function(t){return t=t||this.outputNodes,Array.isArray(t)?t:[t]},t.prototype.execute=function(t,e){t=this.normalizeInputs(t),e=this.normalizeOutputs(e);var n=this.executor.execute(t,e);return n.length>1?n:n[0]},t.prototype.executeAsync=function(t,e){return Tv(this,void 0,void 0,function(){var n;return Dv(this,function(r){switch(r.label){case 0:return t=this.normalizeInputs(t),e=this.normalizeOutputs(e),[4,this.executor.executeAsync(t,e)];case 1:return[2,(n=r.sent()).length>1?n:n[0]]}})})},t.prototype.convertTensorMapToTensorsMap=function(t){return Object.keys(t).reduce(function(e,n){return e[n]=[t[n]],e},{})},t.prototype.dispose=function(){this.executor.dispose()},t}();var Gy=function(t,e){return(Gy=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n])})(t,e)};function Ky(t,e){function n(){this.constructor=t}Gy(t,e),t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)}function $y(t,e,n,r){return new(n||(n=Promise))(function(i,a){function o(t){try{u(r.next(t))}catch(t){a(t)}}function s(t){try{u(r.throw(t))}catch(t){a(t)}}function u(t){t.done?i(t.value):new n(function(e){e(t.value)}).then(o,s)}u((r=r.apply(t,e||[])).next())})}function Xy(t,e){var n,r,i,a,o={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return a={next:s(0),throw:s(1),return:s(2)},"function"==typeof Symbol&&(a[Symbol.iterator]=function(){return this}),a;function s(a){return function(s){return function(a){if(n)throw new TypeError("Generator is already executing.");for(;o;)try{if(n=1,r&&(i=2&a[0]?r.return:a[0]?r.throw||((i=r.return)&&i.call(r),0):r.next)&&!(i=i.call(r,a[1])).done)return i;switch(r=0,i&&(a=[2&a[0],i.value]),a[0]){case 0:case 1:i=a;break;case 4:return o.label++,{value:a[1],done:!1};case 5:o.label++,r=a[1],a=[0];continue;case 7:a=o.ops.pop(),o.trys.pop();continue;default:if(!(i=(i=o.trys).length>0&&i[i.length-1])&&(6===a[0]||2===a[0])){o=0;continue}if(3===a[0]&&(!i||a[1]>i[0]&&a[1]<i[3])){o.label=a[1];break}if(6===a[0]&&o.label<i[1]){o.label=i[1],i=a;break}if(i&&o.label<i[2]){o.label=i[2],o.ops.push(a);break}i[2]&&o.ops.pop(),o.trys.pop();continue}a=e.call(t,o)}catch(t){a=[6,t],r=0}finally{n=i=0}if(5&a[0])throw a[1];return{value:a[0]?a[1]:void 0,done:!0}}([a,s])}}}function Yy(t,e){return t(e={exports:{}},e.exports),e.exports}var Jy=Yy(function(t){!function(t,e,n){function r(t,e){return e.c=t.c,e.s0=t.s0,e.s1=t.s1,e.s2=t.s2,e}function i(t,e){var n=new function(t){var e,n=this,r=(e=4022871197,function(t){t=t.toString();for(var n=0;n<t.length;n++){var r=.02519603282416938*(e+=t.charCodeAt(n));r-=e=r>>>0,e=(r*=e)>>>0,e+=4294967296*(r-=e)}return 2.3283064365386963e-10*(e>>>0)});n.next=function(){var t=2091639*n.s0+2.3283064365386963e-10*n.c;return n.s0=n.s1,n.s1=n.s2,n.s2=t-(n.c=0|t)},n.c=1,n.s0=r(" "),n.s1=r(" "),n.s2=r(" "),n.s0-=r(t),n.s0<0&&(n.s0+=1),n.s1-=r(t),n.s1<0&&(n.s1+=1),n.s2-=r(t),n.s2<0&&(n.s2+=1),r=null}(t),i=e&&e.state,a=n.next;return a.int32=function(){return 4294967296*n.next()|0},a.double=function(){return a()+1.1102230246251565e-16*(2097152*a()|0)},a.quick=a,i&&("object"==typeof i&&r(i,n),a.state=function(){return r(n,{})}),a}e&&e.exports?e.exports=i:this.alea=i}(0,t)}),Zy=Yy(function(t){!function(t,e,n){function r(t,e){return e.x=t.x,e.y=t.y,e.z=t.z,e.w=t.w,e}function i(t,e){var n=new function(t){var e=this,n="";e.x=0,e.y=0,e.z=0,e.w=0,e.next=function(){var t=e.x^e.x<<11;return e.x=e.y,e.y=e.z,e.z=e.w,e.w^=e.w>>>19^t^t>>>8},t===(0|t)?e.x=t:n+=t;for(var r=0;r<n.length+64;r++)e.x^=0|n.charCodeAt(r),e.next()}(t),i=e&&e.state,a=function(){return(n.next()>>>0)/4294967296};return a.double=function(){do{var t=((n.next()>>>11)+(n.next()>>>0)/4294967296)/(1<<21)}while(0===t);return t},a.int32=n.next,a.quick=a,i&&("object"==typeof i&&r(i,n),a.state=function(){return r(n,{})}),a}e&&e.exports?e.exports=i:this.xor128=i}(0,t)}),Qy=Yy(function(t){!function(t,e,n){function r(t,e){return e.x=t.x,e.y=t.y,e.z=t.z,e.w=t.w,e.v=t.v,e.d=t.d,e}function i(t,e){var n=new function(t){var e=this,n="";e.next=function(){var t=e.x^e.x>>>2;return e.x=e.y,e.y=e.z,e.z=e.w,e.w=e.v,(e.d=e.d+362437|0)+(e.v=e.v^e.v<<4^t^t<<1)|0},e.x=0,e.y=0,e.z=0,e.w=0,e.v=0,t===(0|t)?e.x=t:n+=t;for(var r=0;r<n.length+64;r++)e.x^=0|n.charCodeAt(r),r==n.length&&(e.d=e.x<<10^e.x>>>4),e.next()}(t),i=e&&e.state,a=function(){return(n.next()>>>0)/4294967296};return a.double=function(){do{var t=((n.next()>>>11)+(n.next()>>>0)/4294967296)/(1<<21)}while(0===t);return t},a.int32=n.next,a.quick=a,i&&("object"==typeof i&&r(i,n),a.state=function(){return r(n,{})}),a}e&&e.exports?e.exports=i:this.xorwow=i}(0,t)}),tb=Yy(function(t){!function(t,e,n){function r(t,e){return e.x=t.x.slice(),e.i=t.i,e}function i(t,e){null==t&&(t=+new Date);var n=new function(t){var e=this;e.next=function(){var t,n,r=e.x,i=e.i;return t=r[i],n=(t^=t>>>7)^t<<24,n^=(t=r[i+1&7])^t>>>10,n^=(t=r[i+3&7])^t>>>3,n^=(t=r[i+4&7])^t<<7,t=r[i+7&7],n^=(t^=t<<13)^t<<9,r[i]=n,e.i=i+1&7,n},function(t,e){var n,r=[];if(e===(0|e))r[0]=e;else for(e=""+e,n=0;n<e.length;++n)r[7&n]=r[7&n]<<15^e.charCodeAt(n)+r[n+1&7]<<13;for(;r.length<8;)r.push(0);for(n=0;n<8&&0===r[n];++n);for(8==n?r[7]=-1:r[n],t.x=r,t.i=0,n=256;n>0;--n)t.next()}(e,t)}(t),i=e&&e.state,a=function(){return(n.next()>>>0)/4294967296};return a.double=function(){do{var t=((n.next()>>>11)+(n.next()>>>0)/4294967296)/(1<<21)}while(0===t);return t},a.int32=n.next,a.quick=a,i&&(i.x&&r(i,n),a.state=function(){return r(n,{})}),a}e&&e.exports?e.exports=i:this.xorshift7=i}(0,t)}),eb=Yy(function(t){!function(t,e,n){function r(t,e){return e.i=t.i,e.w=t.w,e.X=t.X.slice(),e}function i(t,e){null==t&&(t=+new Date);var n=new function(t){var e=this;e.next=function(){var t,n,r=e.w,i=e.X,a=e.i;return e.w=r=r+1640531527|0,n=i[a+34&127],t=i[a=a+1&127],n^=n<<13,t^=t<<17,n^=n>>>15,t^=t>>>12,n=i[a]=n^t,e.i=a,n+(r^r>>>16)|0},function(t,e){var n,r,i,a,o,s=[],u=128;for(e===(0|e)?(r=e,e=null):(e+="\0",r=0,u=Math.max(u,e.length)),i=0,a=-32;a<u;++a)e&&(r^=e.charCodeAt((a+32)%e.length)),0===a&&(o=r),r^=r<<10,r^=r>>>15,r^=r<<4,r^=r>>>13,a>=0&&(o=o+1640531527|0,i=0==(n=s[127&a]^=r+o)?i+1:0);for(i>=128&&(s[127&(e&&e.length||0)]=-1),i=127,a=512;a>0;--a)r=s[i+34&127],n=s[i=i+1&127],r^=r<<13,n^=n<<17,r^=r>>>15,n^=n>>>12,s[i]=r^n;t.w=o,t.X=s,t.i=i}(e,t)}(t),i=e&&e.state,a=function(){return(n.next()>>>0)/4294967296};return a.double=function(){do{var t=((n.next()>>>11)+(n.next()>>>0)/4294967296)/(1<<21)}while(0===t);return t},a.int32=n.next,a.quick=a,i&&(i.X&&r(i,n),a.state=function(){return r(n,{})}),a}e&&e.exports?e.exports=i:this.xor4096=i}(0,t)}),nb=Yy(function(t){!function(t,e,n){function r(t,e){return e.a=t.a,e.b=t.b,e.c=t.c,e.d=t.d,e}function i(t,e){var n=new function(t){var e=this,n="";e.next=function(){var t=e.b,n=e.c,r=e.d,i=e.a;return t=t<<25^t>>>7^n,n=n-r|0,r=r<<24^r>>>8^i,i=i-t|0,e.b=t=t<<20^t>>>12^n,e.c=n=n-r|0,e.d=r<<16^n>>>16^i,e.a=i-t|0},e.a=0,e.b=0,e.c=-1640531527,e.d=1367130551,t===Math.floor(t)?(e.a=t/4294967296|0,e.b=0|t):n+=t;for(var r=0;r<n.length+20;r++)e.b^=0|n.charCodeAt(r),e.next()}(t),i=e&&e.state,a=function(){return(n.next()>>>0)/4294967296};return a.double=function(){do{var t=((n.next()>>>11)+(n.next()>>>0)/4294967296)/(1<<21)}while(0===t);return t},a.int32=n.next,a.quick=a,i&&("object"==typeof i&&r(i,n),a.state=function(){return r(n,{})}),a}e&&e.exports?e.exports=i:this.tychei=i}(0,t)}),rb=Yy(function(t){!function(e,n){var r,i=this,a=256,o=6,s="random",u=n.pow(a,o),l=n.pow(2,52),c=2*l,p=a-1;function h(t,h,g){var v=[],y=d(function t(e,n){var r,i=[],a=typeof e;if(n&&"object"==a)for(r in e)try{i.push(t(e[r],n-1))}catch(t){}return i.length?i:"string"==a?e:e+"\0"}((h=1==h?{entropy:!0}:h||{}).entropy?[t,m(e)]:null==t?function(){try{var t;return r&&(t=r.randomBytes)?t=t(a):(t=new Uint8Array(a),(i.crypto||i.msCrypto).getRandomValues(t)),m(t)}catch(t){var n=i.navigator,o=n&&n.plugins;return[+new Date,i,o,i.screen,m(e)]}}():t,3),v),b=new function(t){var e,n=t.length,r=this,i=0,o=r.i=r.j=0,s=r.S=[];for(n||(t=[n++]);i<a;)s[i]=i++;for(i=0;i<a;i++)s[i]=s[o=p&o+t[i%n]+(e=s[i])],s[o]=e;(r.g=function(t){for(var e,n=0,i=r.i,o=r.j,s=r.S;t--;)e=s[i=p&i+1],n=n*a+s[p&(s[i]=s[o=p&o+e])+(s[o]=e)];return r.i=i,r.j=o,n})(a)}(v),x=function(){for(var t=b.g(o),e=u,n=0;t<l;)t=(t+n)*a,e*=a,n=b.g(1);for(;t>=c;)t/=2,e/=2,n>>>=1;return(t+n)/e};return x.int32=function(){return 0|b.g(4)},x.quick=function(){return b.g(4)/4294967296},x.double=x,d(m(b.S),e),(h.pass||g||function(t,e,r,i){return i&&(i.S&&f(i,b),t.state=function(){return f(b,{})}),r?(n[s]=t,e):t})(x,y,"global"in h?h.global:this==n,h.state)}function f(t,e){return e.i=t.i,e.j=t.j,e.S=t.S.slice(),e}function d(t,e){for(var n,r=t+"",i=0;i<r.length;)e[p&i]=p&(n^=19*e[p&i])+r.charCodeAt(i++);return m(e)}function m(t){return String.fromCharCode.apply(0,t)}if(n["seed"+s]=h,d(n.random(),e),t.exports){t.exports=h;try{r=require("crypto")}catch(t){}}}([],Math)});rb.alea=Jy,rb.xor128=Zy,rb.xorwow=Qy,rb.xorshift7=tb,rb.xor4096=eb,rb.tychei=nb;var ib=rb.alea;function ab(t,e,n,r){if(void 0===n&&(n=new Map),void 0===r&&(r=new Set),null==t)return null;if(r.has(t))throw new Error("Circular references are not supported.");if(n.has(t))return n.get(t);var i=e(t);if(i.recurse&&null!==i.value)throw new Error("A deep map function may not return both a value and recurse=true.");if(i.recurse){if(lb(t)){var a=Array.isArray(t)?[]:{};for(var o in r.add(t),t){var s=ab(t[o],e,n,r);a[o]=s}return r.delete(t),a}throw new Error("Can't recurse into non-iterable type: "+t)}return n.set(t,i.value),i.value}function ob(t,e){return void 0===e&&(e=sb),function t(e,n,r){void 0===r&&(r=new Set);var i=e[0];if(r.has(i))throw new Error("Circular references are not supported.");var a=n(e);if(a.recurse&&null!==a.value)throw new Error("A deep zip function may not return both a value and recurse=true.");if(a.recurse){if(lb(i)){var o=Array.isArray(i)?[]:{};r.add(i);var s=function(i){var a=t(e.map(function(t){return t[i]}),n,r);o[i]=a};for(var u in i)s(u);return r.delete(i),o}throw new Error("Can't recurse into non-iterable type: "+i)}return a.value}(t,e)}function sb(t){return null===t?null:lb(t[0])?{value:null,recurse:!0}:{value:t,recurse:!1}}function ub(t,e){return $y(this,void 0,void 0,function(){var n,r,i,a,o,s;return Xy(this,function(u){switch(u.label){case 0:n=new Map,ab(t,e,n),r=0,i=Array.from(n.keys()),u.label=1;case 1:return r<i.length?(a=i[r],(o=n.get(a))instanceof Promise?[4,o]:[3,3]):[3,4];case 2:s=u.sent(),n.set(a,s),u.label=3;case 3:return r++,[3,1];case 4:return[2,ab(t,e,n)]}})})}function lb(t){return null!=t&&(Array.isArray(t)||"object"==typeof t&&!(t instanceof ct))}function cb(t){return function(t,e){return ab(t,e)}(t,pb)}function pb(t){return t instanceof ct?{value:t.clone(),recurse:!1}:lb(t)?{value:null,recurse:!0}:{value:t,recurse:!1}}var hb=function(){function t(t){if(this.capacity=t,this.begin=0,this.end=0,null==t)throw new RangeError("Can't create a ring buffer of unknown capacity.");if(t<1)throw new RangeError("Can't create ring buffer of capacity < 1.");this.data=new Array(t),this.doubledCapacity=2*t}return t.prototype.wrap=function(t){for(;t<0;)t+=this.doubledCapacity;return t%this.doubledCapacity},t.prototype.get=function(t){if(t<0)throw new RangeError("Can't get item at a negative index.");return this.data[t%this.capacity]},t.prototype.set=function(t,e){if(t<0)throw new RangeError("Can't set item at a negative index.");this.data[t%this.capacity]=e},t.prototype.length=function(){var t=this.end-this.begin;return t<0&&(t=this.doubledCapacity+t),t},t.prototype.isFull=function(){return this.length()===this.capacity},t.prototype.isEmpty=function(){return 0===this.length()},t.prototype.push=function(t){if(this.isFull())throw new RangeError("Ring buffer is full.");this.set(this.end,t),this.end=this.wrap(this.end+1)},t.prototype.pushAll=function(t){for(var e=0,n=t;e<n.length;e++){var r=n[e];this.push(r)}},t.prototype.pop=function(){if(this.isEmpty())throw new RangeError("Ring buffer is empty.");this.end=this.wrap(this.end-1);var t=this.get(this.end);return this.set(this.end,void 0),t},t.prototype.unshift=function(t){if(this.isFull())throw new RangeError("Ring buffer is full.");this.begin=this.wrap(this.begin-1),this.set(this.begin,t)},t.prototype.shift=function(){if(this.isEmpty())throw new RangeError("Ring buffer is empty.");var t=this.get(this.begin);return this.set(this.begin,void 0),this.begin=this.wrap(this.begin+1),t},t.prototype.shuffleExcise=function(t){if(this.isEmpty())throw new RangeError("Ring buffer is empty.");var e=this.wrap(this.begin+t),n=this.get(e);return this.set(e,this.pop()),n},t}(),fb=function(t){function e(){return t.call(this,e.INITIAL_CAPACITY)||this}return Ky(e,t),e.prototype.isFull=function(){return!1},e.prototype.push=function(e){t.prototype.isFull.call(this)&&this.expand(),t.prototype.push.call(this,e)},e.prototype.unshift=function(e){t.prototype.isFull.call(this)&&this.expand(),t.prototype.unshift.call(this,e)},e.prototype.expand=function(){for(var t=2*this.capacity,e=new Array(t),n=this.length(),r=0;r<n;r++)e[r]=this.get(this.wrap(this.begin+r));this.data=e,this.capacity=t,this.doubledCapacity=2*this.capacity,this.begin=0,this.end=n},e.INITIAL_CAPACITY=32,e}(hb);function db(t){return new yb(t)}function mb(t){return new bb(t)}var gb,vb=function(){function t(){}return t.prototype.toArray=function(){return $y(this,void 0,void 0,function(){var t,e;return Xy(this,function(n){switch(n.label){case 0:return t=[],[4,this.next()];case 1:e=n.sent(),n.label=2;case 2:return e.done?[3,4]:(t.push(e.value),[4,this.next()]);case 3:return e=n.sent(),[3,2];case 4:return[2,t]}})})},t.prototype.toArrayForTest=function(){return $y(this,void 0,void 0,function(){var t,e,n;return Xy(this,function(r){switch(r.label){case 0:return t=this.prefetch(100),e=[],[4,t.next()];case 1:n=r.sent(),r.label=2;case 2:return n.done?[3,4]:(e.push(n.value),[4,t.next()]);case 3:return n=r.sent(),[3,2];case 4:return[2,e]}})})},t.prototype.resolveFully=function(){return $y(this,void 0,void 0,function(){var t;return Xy(this,function(e){switch(e.label){case 0:return[4,this.next()];case 1:t=e.sent(),e.label=2;case 2:return t.done?[3,4]:[4,this.next()];case 3:return t=e.sent(),[3,2];case 4:return[2]}})})},t.prototype.resolveWhile=function(t){return $y(this,void 0,void 0,function(){var e,n;return Xy(this,function(r){switch(r.label){case 0:return[4,this.next()];case 1:e=r.sent(),n=t(e.value),r.label=2;case 2:return e.done||!n?[3,4]:[4,this.next()];case 3:return e=r.sent(),n=t(e.value),[3,2];case 4:return[2]}})})},t.prototype.handleErrors=function(t){return new kb(this,t)},t.prototype.filter=function(t){return new Eb(this,t)},t.prototype.map=function(t){return new Sb(this,t)},t.prototype.mapAsync=function(t){return new Ib(this,t)},t.prototype.serialMapAsync=function(t){return new Ib(this,t).serial()},t.prototype.flatmap=function(t){return new Rb(this,t)},t.prototype.forEachAsync=function(t){return $y(this,void 0,void 0,function(){return Xy(this,function(e){return[2,this.map(t).resolveFully()]})})},t.prototype.serialForEach=function(t){return $y(this,void 0,void 0,function(){return Xy(this,function(e){return[2,this.serialMapAsync(t).resolveWhile(function(t){return!0===t})]})})},t.prototype.rowMajorBatch=function(t,e){return void 0===e&&(e=!0),new Cb(this,t,e)},t.prototype.columnMajorBatch=function(t,e,n){return void 0===e&&(e=!0),void 0===n&&(n=sb),this.rowMajorBatch(t,e).map(function(t){return ob(t,n)})},t.prototype.concatenate=function(t,e){return new Tb(db([this,t]),e)},t.prototype.take=function(t){return t<0||null==t?this:new Nb(this,t)},t.prototype.skip=function(t){return t<0||null==t?this:new wb(this,t)},t.prototype.prefetch=function(t){return new Ob(this,t)},t.prototype.shuffle=function(t,e){return new _b(this,t,e)},t.prototype.serial=function(){return new xb(this)},t}(),yb=function(t){function e(e){var n=t.call(this)||this;return n.items=e,n.trav=0,n}return Ky(e,t),e.prototype.summary=function(){return"Array of "+this.items.length+" items"},e.prototype.next=function(){return $y(this,void 0,void 0,function(){var t;return Xy(this,function(e){return this.trav>=this.items.length?[2,{value:null,done:!0}]:(t=this.items[this.trav],this.trav++,[2,{value:cb(t),done:!1}])})})},e}(vb),bb=function(t){function e(e){var n=t.call(this)||this;return n.nextFn=e,n}return Ky(e,t),e.prototype.summary=function(){return"Function call"},e.prototype.next=function(){return $y(this,void 0,void 0,function(){return Xy(this,function(t){try{return[2,this.nextFn()]}catch(t){throw t.message="Error thrown while iterating through a dataset: "+t.message,t}return[2]})})},e}(vb),xb=function(t){function e(e){var n=t.call(this)||this;return n.upstream=e,n.lastRead=Promise.resolve({value:null,done:!1}),n}return Ky(e,t),e.prototype.summary=function(){return this.upstream.summary()+" -> Serial"},e.prototype.next=function(){return $y(this,void 0,void 0,function(){var t=this;return Xy(this,function(e){return this.lastRead=this.lastRead.then(function(){return t.serialNext()}),[2,this.lastRead]})})},e.prototype.serialNext=function(){return $y(this,void 0,void 0,function(){return Xy(this,function(t){return[2,this.upstream.next()]})})},e}(vb),wb=function(t){function e(e,n){var r=t.call(this)||this;return r.upstream=e,r.maxCount=n,r.count=0,r.lastRead=Promise.resolve({value:null,done:!1}),r}return Ky(e,t),e.prototype.summary=function(){return this.upstream.summary()+" -> Skip"},e.prototype.next=function(){return $y(this,void 0,void 0,function(){var t=this;return Xy(this,function(e){return this.lastRead=this.lastRead.then(function(){return t.serialNext()}),[2,this.lastRead]})})},e.prototype.serialNext=function(){return $y(this,void 0,void 0,function(){var t;return Xy(this,function(e){switch(e.label){case 0:return this.count++<this.maxCount?[4,this.upstream.next()]:[3,2];case 1:return(t=e.sent()).done?[2,t]:(Me(t.value),[3,0]);case 2:return[2,this.upstream.next()]}})})},e}(vb),Nb=function(t){function e(e,n){var r=t.call(this)||this;return r.upstream=e,r.maxCount=n,r.count=0,r}return Ky(e,t),e.prototype.summary=function(){return this.upstream.summary()+" -> Take"},e.prototype.next=function(){return $y(this,void 0,void 0,function(){return Xy(this,function(t){return this.count++>=this.maxCount?[2,{value:null,done:!0}]:[2,this.upstream.next()]})})},e}(vb),Cb=function(t){function e(e,n,r){void 0===r&&(r=!0);var i=t.call(this)||this;return i.upstream=e,i.batchSize=n,i.enableSmallLastBatch=r,i.lastRead=Promise.resolve({value:null,done:!1}),i}return Ky(e,t),e.prototype.summary=function(){return this.upstream.summary()+" -> RowMajorBatch"},e.prototype.next=function(){return $y(this,void 0,void 0,function(){var t=this;return Xy(this,function(e){return this.lastRead=this.lastRead.then(function(){return t.serialNext()}),[2,this.lastRead]})})},e.prototype.serialNext=function(){return $y(this,void 0,void 0,function(){var t,e;return Xy(this,function(n){switch(n.label){case 0:t=[],n.label=1;case 1:return t.length<this.batchSize?[4,this.upstream.next()]:[3,3];case 2:return(e=n.sent()).done?this.enableSmallLastBatch&&t.length>0?[2,{value:t,done:!1}]:[2,{value:null,done:!0}]:(t.push(e.value),[3,1]);case 3:return[2,{value:t,done:!1}]}})})},e}(vb),Eb=function(t){function e(e,n){var r=t.call(this)||this;return r.upstream=e,r.predicate=n,r.lastRead=Promise.resolve({value:null,done:!1}),r}return Ky(e,t),e.prototype.summary=function(){return this.upstream.summary()+" -> Filter"},e.prototype.next=function(){return $y(this,void 0,void 0,function(){var t=this;return Xy(this,function(e){return this.lastRead=this.lastRead.then(function(){return t.serialNext()}),[2,this.lastRead]})})},e.prototype.serialNext=function(){return $y(this,void 0,void 0,function(){var t;return Xy(this,function(e){switch(e.label){case 0:return[4,this.upstream.next()];case 1:return(t=e.sent()).done||this.predicate(t.value)?[2,t]:(Me(t.value),[3,0]);case 2:return[2]}})})},e}(vb),Sb=function(t){function e(e,n){var r=t.call(this)||this;return r.upstream=e,r.transform=n,r}return Ky(e,t),e.prototype.summary=function(){return this.upstream.summary()+" -> Map"},e.prototype.next=function(){return $y(this,void 0,void 0,function(){var t,e,n,r,i,a,o;return Xy(this,function(s){switch(s.label){case 0:return[4,this.upstream.next()];case 1:if((t=s.sent()).done)return[2,{value:null,done:!0}];for(e=Et.getTensorsInContainer(t.value),n=this.transform(t.value),r=Et.getTensorsInContainer(n),i=0,a=e;i<a.length;i++)o=a[i],Et.isTensorInList(o,r)||o.dispose();return[2,{value:n,done:!1}]}})})},e}(vb),kb=function(t){function e(e,n){var r=t.call(this)||this;return r.upstream=e,r.handler=n,r.count=0,r.lastRead=Promise.resolve({value:null,done:!1}),r}return Ky(e,t),e.prototype.summary=function(){return this.upstream.summary()+" -> handleErrors"},e.prototype.next=function(){return $y(this,void 0,void 0,function(){var t=this;return Xy(this,function(e){return this.lastRead=this.lastRead.then(function(){return t.serialNext()}),[2,this.lastRead]})})},e.prototype.serialNext=function(){return $y(this,void 0,void 0,function(){var t;return Xy(this,function(e){switch(e.label){case 0:e.label=1;case 1:return e.trys.push([1,3,,4]),[4,this.upstream.next()];case 2:return[2,e.sent()];case 3:return t=e.sent(),this.handler(t)?[3,4]:[2,{value:null,done:!0}];case 4:return[3,0];case 5:return[2]}})})},e}(vb),Ib=function(t){function e(e,n){var r=t.call(this)||this;return r.upstream=e,r.transform=n,r}return Ky(e,t),e.prototype.summary=function(){return this.upstream.summary()+" -> AsyncMap"},e.prototype.next=function(){return $y(this,void 0,void 0,function(){var t,e,n,r,i,a,o;return Xy(this,function(s){switch(s.label){case 0:return[4,this.upstream.next()];case 1:return(t=s.sent()).done?[2,{value:null,done:!0}]:(e=Et.getTensorsInContainer(t.value),[4,this.transform(t.value)]);case 2:for(n=s.sent(),r=Et.getTensorsInContainer(n),i=0,a=e;i<a.length;i++)o=a[i],Et.isTensorInList(o,r)||o.dispose();return[2,{value:n,done:!1}]}})})},e}(vb),Ab=function(t){function e(){var e=t.call(this)||this;return e.outputQueue=new fb,e.lastRead=Promise.resolve({value:null,done:!1}),e}return Ky(e,t),e.prototype.next=function(){return $y(this,void 0,void 0,function(){var t=this;return Xy(this,function(e){return this.lastRead=this.lastRead.then(function(){return t.serialNext()}),[2,this.lastRead]})})},e.prototype.serialNext=function(){return $y(this,void 0,void 0,function(){return Xy(this,function(t){switch(t.label){case 0:return 0!==this.outputQueue.length()?[3,2]:[4,this.pump()];case 1:return t.sent()?[3,0]:[2,{value:null,done:!0}];case 2:return[2,{value:this.outputQueue.shift(),done:!1}]}})})},e}(vb),Rb=function(t){function e(e,n){var r=t.call(this)||this;return r.upstream=e,r.transform=n,r}return Ky(e,t),e.prototype.summary=function(){return this.upstream.summary()+" -> Flatmap"},e.prototype.pump=function(){return $y(this,void 0,void 0,function(){var t,e,n,r,i,a,o;return Xy(this,function(s){switch(s.label){case 0:return[4,this.upstream.next()];case 1:if((t=s.sent()).done)return[2,!1];for(e=Et.getTensorsInContainer(t.value),n=this.transform(t.value),r=Et.getTensorsInContainer(n),this.outputQueue.pushAll(n),i=0,a=e;i<a.length;i++)o=a[i],Et.isTensorInList(o,r)||o.dispose();return[2,!0]}})})},e}(Ab),Tb=function(t){function e(e,n){var r=t.call(this)||this;return r.baseErrorHandler=n,r.lastRead=null,r.iterator=null,r.moreIterators=e,r}return Ky(e,t),e.prototype.summary=function(){return"TODO: fill in upstream of chained summaries -> Chained"},e.prototype.next=function(){return $y(this,void 0,void 0,function(){return Xy(this,function(t){return this.lastRead=this.readFromChain(this.lastRead),[2,this.lastRead]})})},e.prototype.readFromChain=function(t){return $y(this,void 0,void 0,function(){var e,n;return Xy(this,function(r){switch(r.label){case 0:return[4,t];case 1:return r.sent(),null!=this.iterator?[3,3]:[4,this.moreIterators.next()];case 2:if((e=r.sent()).done)return[2,{value:null,done:!0}];this.iterator=e.value,null!=this.baseErrorHandler&&(this.iterator=this.iterator.handleErrors(this.baseErrorHandler)),r.label=3;case 3:return[4,this.iterator.next()];case 4:return(n=r.sent()).done?(this.iterator=null,[2,this.readFromChain(t)]):[2,n]}})})},e}(vb);!function(t){t[t.FAIL=0]="FAIL",t[t.SHORTEST=1]="SHORTEST",t[t.LONGEST=2]="LONGEST"}(gb||(gb={}));var Db=function(t){function e(e,n){void 0===n&&(n=gb.FAIL);var r=t.call(this)||this;return r.iterators=e,r.mismatchMode=n,r.count=0,r.currentPromise=null,r}return Ky(e,t),e.prototype.summary=function(){return"{TODO: fill in upstream of zip summaries} -> Zip"},e.prototype.nextState=function(t){return $y(this,void 0,void 0,function(){function e(t){return t instanceof vb?{value:t.next().then(function(t){return n++,t.done&&r++,t.value}),recurse:!1}:{value:null,recurse:!0}}var n,r,i;return Xy(this,function(a){switch(a.label){case 0:return[4,t];case 1:return a.sent(),n=0,r=0,[4,ub(this.iterators,e)];case 2:if(i=a.sent(),n===r)return[2,{value:null,done:!0}];if(r>0)switch(this.mismatchMode){case gb.FAIL:throw new Error("Zipped streams should have the same length. Mismatched at element "+this.count+".");case gb.SHORTEST:return[2,{value:null,done:!0}];case gb.LONGEST:}return this.count++,[2,{value:i,done:!1}]}})})},e.prototype.next=function(){return $y(this,void 0,void 0,function(){return Xy(this,function(t){switch(t.label){case 0:return this.currentPromise=this.nextState(this.currentPromise),[4,this.currentPromise];case 1:return[2,t.sent()]}})})},e}(vb),Ob=function(t){function e(e,n){var r=t.call(this)||this;return r.upstream=e,r.bufferSize=n,r.buffer=new hb(n),r}return Ky(e,t),e.prototype.summary=function(){return this.upstream.summary()+" -> Prefetch"},e.prototype.refill=function(){for(;!this.buffer.isFull();){var t=this.upstream.next();this.buffer.push(t)}},e.prototype.next=function(){return this.refill(),this.buffer.shift()},e}(vb),_b=function(t){function e(e,n,r){var i=t.call(this,e,n)||this;return i.upstream=e,i.windowSize=n,i.upstreamExhausted=!1,i.random=ib(r||J.now().toString()),i.lastRead=Promise.resolve({value:null,done:!1}),i}return Ky(e,t),e.prototype.next=function(){return $y(this,void 0,void 0,function(){var t=this;return Xy(this,function(e){return this.lastRead=this.lastRead.then(function(){return t.serialNext()}),[2,this.lastRead]})})},e.prototype.randomInt=function(t){return Math.floor(this.random()*t)},e.prototype.chooseIndex=function(){return this.randomInt(this.buffer.length())},e.prototype.serialNext=function(){return $y(this,void 0,void 0,function(){var t,e;return Xy(this,function(n){switch(n.label){case 0:this.upstreamExhausted||this.refill(),n.label=1;case 1:return this.buffer.isEmpty()?[3,3]:(t=this.chooseIndex(),[4,this.buffer.shuffleExcise(t)]);case 2:return(e=n.sent()).done?(this.upstreamExhausted=!0,[3,1]):(this.refill(),[2,e]);case 3:return[2,{value:null,done:!0}]}})})},e}(Ob),Fb=function(){function t(){this.size=null}return t.prototype.batch=function(t,e){var n=this;void 0===e&&(e=!0);var r=this;return J.assert(t>0,function(){return"batchSize needs to be positive, but it is\n      "+t}),Mb(function(){return $y(n,void 0,void 0,function(){return Xy(this,function(n){switch(n.label){case 0:return[4,r.iterator()];case 1:return[2,n.sent().columnMajorBatch(t,e,zb)]}})})},this.size===1/0||null==this.size?this.size:e?Math.ceil(this.size/t):Math.floor(this.size/t))},t.prototype.concatenate=function(t){var e=this,n=this;return Mb(function(){return $y(e,void 0,void 0,function(){var e,r;return Xy(this,function(i){switch(i.label){case 0:return[4,n.iterator()];case 1:return r=(e=i.sent()).concatenate,[4,t.iterator()];case 2:return[2,r.apply(e,[i.sent()])]}})})},this.size===1/0||t.size===1/0?1/0:null!=this.size&&null!=t.size?this.size+t.size:null)},t.prototype.filter=function(t){var e=this,n=this;return Mb(function(){return $y(e,void 0,void 0,function(){return Xy(this,function(e){switch(e.label){case 0:return[4,n.iterator()];case 1:return[2,e.sent().filter(function(e){return Fe(function(){return t(e)})})]}})})},this.size===1/0?1/0:null)},t.prototype.forEachAsync=function(t){return $y(this,void 0,void 0,function(){return Xy(this,function(e){switch(e.label){case 0:return[4,this.iterator()];case 1:return[2,e.sent().forEachAsync(t)]}})})},t.prototype.forEach=function(t){return $y(this,void 0,void 0,function(){return Xy(this,function(e){return Oe("dataset.forEach() is deprecated and will be removed. Please use dataset.forEachAsync() instead"),[2,this.forEachAsync(t)]})})},t.prototype.map=function(t){var e=this,n=this;return Mb(function(){return $y(e,void 0,void 0,function(){return Xy(this,function(e){switch(e.label){case 0:return[4,n.iterator()];case 1:return[2,e.sent().map(function(e){return Fe(function(){return t(e)})})]}})})},this.size)},t.prototype.mapAsync=function(t){var e=this,n=this;return Mb(function(){return $y(e,void 0,void 0,function(){return Xy(this,function(e){switch(e.label){case 0:return[4,n.iterator()];case 1:return[2,e.sent().mapAsync(t)]}})})},this.size)},t.prototype.prefetch=function(t){var e=this;if(null==t)throw new RangeError("`Dataset.prefetch()` requires bufferSize to be specified.");var n=this;return Mb(function(){return $y(e,void 0,void 0,function(){return Xy(this,function(e){switch(e.label){case 0:return[4,n.iterator()];case 1:return[2,e.sent().prefetch(t)]}})})},this.size)},t.prototype.repeat=function(t){var e=this,n=this;return Mb(function(){return $y(e,void 0,void 0,function(){var e=this;return Xy(this,function(r){return[2,function(t,e){return new Tb(t,e)}(mb(function(){return $y(e,void 0,void 0,function(){var t;return Xy(this,function(e){switch(e.label){case 0:return t={},[4,n.iterator()];case 1:return[2,(t.value=e.sent(),t.done=!1,t)]}})})}).take(t))]})})},null!=this.size&&t>0?this.size*t:0===t?0:null!=this.size&&(void 0===t||t<0)?1/0:null)},t.prototype.skip=function(t){var e=this,n=this;return Mb(function(){return $y(e,void 0,void 0,function(){return Xy(this,function(e){switch(e.label){case 0:return[4,n.iterator()];case 1:return[2,e.sent().skip(t)]}})})},null!=this.size&&t>=0&&this.size>=t?this.size-t:null!=this.size&&(this.size<t||void 0===t||t<0)?0:null)},t.prototype.shuffle=function(t,e,n){var r=this;if(void 0===n&&(n=!0),null==t||t<0)throw null==this.size?new RangeError("`Dataset.shuffle()` requires bufferSize to be specified."):new RangeError("`Dataset.shuffle()` requires bufferSize to be specified.  If your data fits in main memory (for regular JS objects), and/or GPU memory (for `tf.Tensor`s), consider setting bufferSize to the dataset size ("+this.size+" elements)");var i=this,a=ib(e||J.now().toString());return Mb(function(){return $y(r,void 0,void 0,function(){var e;return Xy(this,function(r){switch(r.label){case 0:return e=a.int32(),n&&(e+=a.int32()),[4,i.iterator()];case 1:return[2,r.sent().shuffle(t,e.toString())]}})})},this.size)},t.prototype.take=function(t){var e=this,n=this;return Mb(function(){return $y(e,void 0,void 0,function(){return Xy(this,function(e){switch(e.label){case 0:return[4,n.iterator()];case 1:return[2,e.sent().take(t)]}})})},null!=this.size&&this.size>t?t:null!=this.size&&this.size<=t?this.size:null)},t.prototype.toArray=function(){return $y(this,void 0,void 0,function(){return Xy(this,function(t){switch(t.label){case 0:if(this.size===1/0)throw new Error("Can not convert infinite data stream to array.");return[4,this.iterator()];case 1:return[2,t.sent().toArray()]}})})},t.prototype.toArrayForTest=function(){return $y(this,void 0,void 0,function(){return Xy(this,function(t){switch(t.label){case 0:if(this.size===1/0)throw new Error("Can not convert infinite data stream to array.");return[4,this.iterator()];case 1:return[2,t.sent().toArrayForTest()]}})})},t.MAX_BUFFER_SIZE=1e4,t}();function Mb(t,e){return void 0===e&&(e=null),new(function(n){function r(){var t=null!==n&&n.apply(this,arguments)||this;return t.size=e,t}return Ky(r,n),r.prototype.iterator=function(){return $y(this,void 0,void 0,function(){return Xy(this,function(e){return[2,t()]})})},r}(Fb))}function zb(t){return null===t?null:function(t){return null==t||function(t){return null===t||"object"!=typeof t&&"function"!=typeof t}(t)||Array.isArray(t)||"object"==typeof t&&t instanceof ct||J.isTypedArray(t)}(t[0])?{value:function(t){if(0===t.length)throw new Error("Can't make a batch of zero elements.");return t[0]instanceof ct?sr(t):rn(t)}(t),recurse:!1}:{value:null,recurse:!0}}var Lb=function(t){function e(e){var n=t.call(this)||this;return n.input=e,n}return Ky(e,t),e.prototype.iterator=function(){return $y(this,void 0,void 0,function(){var t;return Xy(this,function(e){switch(e.label){case 0:return[4,this.input.iterator()];case 1:return t=e.sent(),[2,t.decodeUTF8().split("\n").map(function(t){return t.endsWith("\r")&&(t=t.slice(0,-1)),t})]}})})},e}(Fb),Pb=Symbol("out"),Bb=Symbol("field"),Vb=Symbol("quote"),Wb=Symbol("quoteafterquote"),Ub=Symbol("quoteinquote"),jb=function(t){function e(e,n){var r=t.call(this)||this;return r.input=e,r.hasHeader=!0,r.fullColumnNames=null,r.columnNamesValidated=!1,r.columnConfigs=null,r.configuredColumnsOnly=!1,r.delimiter=",",r.delimWhitespace=!1,r.base=new Lb(e),n||(n={}),r.hasHeader=!1!==n.hasHeader,r.fullColumnNames=n.columnNames,r.columnConfigs=n.columnConfigs,r.configuredColumnsOnly=n.configuredColumnsOnly,n.delimWhitespace?(J.assert(null==n.delimiter,function(){return"Delimiter should not be provided when delimWhitespace is true."}),r.delimWhitespace=!0,r.delimiter=" "):r.delimiter=n.delimiter?n.delimiter:",",r}return Ky(e,t),e.prototype.columnNames=function(){return $y(this,void 0,void 0,function(){return Xy(this,function(t){switch(t.label){case 0:return this.columnNamesValidated?[3,2]:[4,this.setColumnNames()];case 1:t.sent(),t.label=2;case 2:return[2,this.configuredColumnsOnly?Object.keys(this.columnConfigs):this.fullColumnNames]}})})},e.prototype.setColumnNames=function(){return $y(this,void 0,void 0,function(){var t,e,n,r,i,a,o=this;return Xy(this,function(s){switch(s.label){case 0:return[4,this.maybeReadHeaderLine()];case 1:if(t=s.sent(),!this.fullColumnNames&&!t)throw new Error("Column names must be provided if there is no header line.");if(this.fullColumnNames&&t&&J.assert(t.length===this.fullColumnNames.length,function(){return"The length of provided columnNames ("+o.fullColumnNames.length.toString()+") does not match the length of the header line read from file ("+t.length.toString()+")."}),this.fullColumnNames||(this.fullColumnNames=t),e=this.fullColumnNames.reduce(function(t,e){return t[e]=t[e]+1||1,t},{}),n=Object.keys(e).filter(function(t){return e[t]>1}),J.assert(0===n.length,function(){return"Duplicate column names found: "+n.toString()}),this.columnConfigs)for(r=0,i=Object.keys(this.columnConfigs);r<i.length;r++)if(a=i[r],-1===this.fullColumnNames.indexOf(a))throw new Error('The key "'+a+'" provided in columnConfigs does not match any of the column names ('+this.fullColumnNames.toString()+").");return this.columnNamesValidated=!0,[2]}})})},e.prototype.maybeReadHeaderLine=function(){return $y(this,void 0,void 0,function(){var t,e;return Xy(this,function(n){switch(n.label){case 0:return this.hasHeader?[4,this.base.iterator()]:[3,3];case 1:return[4,n.sent().next()];case 2:if((t=n.sent()).done)throw new Error("No data was found for CSV parsing.");return e=t.value,[2,this.parseRow(e,!1)];case 3:return[2,null]}})})},e.prototype.iterator=function(){return $y(this,void 0,void 0,function(){var t,e=this;return Xy(this,function(n){switch(n.label){case 0:return this.columnNamesValidated?[3,2]:[4,this.setColumnNames()];case 1:n.sent(),n.label=2;case 2:return[4,this.base.iterator()];case 3:return t=n.sent(),this.hasHeader&&(t=t.skip(1)),[2,t.map(function(t){return e.makeDataElement(t)})]}})})},e.prototype.makeDataElement=function(t){for(var e=this.parseRow(t),n={},r={},i=0;i<this.fullColumnNames.length;i++){var a=this.fullColumnNames[i],o=this.columnConfigs?this.columnConfigs[a]:null;if(!this.configuredColumnsOnly||o){var s=e[i],u=null;if(""===s)if(o&&void 0!==o.default)u=o.default;else{if(o&&(o.required||o.isLabel))throw new Error("Required column "+a+" is empty in this line: "+t);u=void 0}else{var l=Number(s);if(isNaN(l))u=o&&"bool"===o.dtype?this.getBoolean(s):s;else if(o&&o.dtype)switch(o.dtype){case"float32":u=l;break;case"int32":u=Math.floor(l);break;case"bool":u=this.getBoolean(s);break;default:u=l}else u=l}o&&o.isLabel?r[a]=u:n[a]=u}}return 0===Object.keys(r).length?n:{xs:n,ys:r}},e.prototype.getBoolean=function(t){return"1"===t||"true"===t.toLowerCase()?1:0},e.prototype.parseRow=function(t,e){void 0===e&&(e=!0);for(var n=[],r=0,i=t.length,a=Pb,o=0;o<i;o++)switch(a){case Pb:switch(t.charAt(o)){case'"':r=o+1,a=Vb;break;case this.delimiter:if(r=o+1," "===this.delimiter&&this.delimWhitespace)break;n.push(""),a=Pb;break;default:a=Bb,r=o}break;case Bb:switch(t.charAt(o)){case this.delimiter:n.push(t.substring(r,o)),a=Pb,r=o+1}break;case Vb:switch(t.charAt(o)){case'"':a=Wb}break;case Wb:switch(t.charAt(o)){case this.delimiter:n.push(t.substring(r,o-1)),a=Pb,r=o+1;break;case'"':a=Vb;break;default:a=Ub}break;case Ub:switch(t.charAt(o)){case'"':a=Vb}}if(a===Wb?n.push(t.substring(r,i-1)):n.push(t.substring(r)),e&&n.length!==this.fullColumnNames.length)throw new Error("Invalid row in csv file. Should have "+this.fullColumnNames.length+" elements in a row, but got "+n);return n},e}(Fb),qb=function(e){function n(t){var n=e.call(this)||this;n.microphoneConfig=t,n.isClosed=!1,n.fftSize=t.fftSize||1024;var r=Math.log2(n.fftSize);if(n.fftSize<0||r<4||r>14||!Number.isInteger(r))throw new Error("Invalid fftSize: it must be a power of 2 between 2 to 4 and 2 to 14, but got "+n.fftSize);if(n.numFrames=t.numFramesPerSpectrogram||43,n.sampleRateHz=t.sampleRateHz,n.columnTruncateLength=t.columnTruncateLength||n.fftSize,n.audioTrackConstraints=t.audioTrackConstraints,n.smoothingTimeConstant=t.smoothingTimeConstant||0,n.includeSpectrogram=!1!==t.includeSpectrogram,n.includeWaveform=!0===t.includeWaveform,!n.includeSpectrogram&&!n.includeWaveform)throw new Error("Both includeSpectrogram and includeWaveform are false. At least one type of data should be returned.");return n}return Ky(n,e),n.prototype.summary=function(){return"microphone"},n.create=function(e){return void 0===e&&(e={}),$y(this,void 0,void 0,function(){var r;return Xy(this,function(i){switch(i.label){case 0:if(t.ENV.get("IS_NODE"))throw new Error("microphone API is only supported in browser environment.");return[4,(r=new n(e)).start()];case 1:return i.sent(),[2,r]}})})},n.prototype.start=function(){return $y(this,void 0,void 0,function(){var t,e,n,r;return Xy(this,function(i){switch(i.label){case 0:return i.trys.push([0,2,,3]),t=this,[4,navigator.mediaDevices.getUserMedia({audio:null==this.audioTrackConstraints||this.audioTrackConstraints,video:!1})];case 1:return t.stream=i.sent(),[3,3];case 2:throw e=i.sent(),new Error("Error thrown while initializing video stream: "+e.message);case 3:if(!this.stream)throw new Error("Could not obtain audio from microphone.");if(n=window.AudioContext||window.webkitAudioContext,this.audioContext=new n,this.sampleRateHz){if(this.audioContext.sampleRate!==this.sampleRateHz)throw new Error("Mismatch in sampling rate: Expected: "+this.sampleRateHz+"; Actual: "+this.audioContext.sampleRate)}else this.sampleRateHz=this.audioContext.sampleRate;return r=this.audioContext.createMediaStreamSource(this.stream),this.analyser=this.audioContext.createAnalyser(),this.analyser.fftSize=2*this.fftSize,this.analyser.smoothingTimeConstant=this.smoothingTimeConstant,r.connect(this.analyser),this.freqData=new Float32Array(this.fftSize),this.timeData=new Float32Array(this.fftSize),[2]}})})},n.prototype.next=function(){return $y(this,void 0,void 0,function(){var t,e,n,r,i;return Xy(this,function(a){switch(a.label){case 0:return this.isClosed?[2,{value:null,done:!0}]:[4,this.getAudioData()];case 1:return n=a.sent(),this.includeSpectrogram&&(r=this.flattenQueue(n.freqDataQueue),t=this.getTensorFromAudioDataArray(r,[this.numFrames,this.columnTruncateLength,1])),this.includeWaveform&&(i=this.flattenQueue(n.timeDataQueue),e=this.getTensorFromAudioDataArray(i,[this.numFrames*this.fftSize,1])),[2,{value:{spectrogram:t,waveform:e},done:!1}]}})})},n.prototype.capture=function(){return $y(this,void 0,void 0,function(){return Xy(this,function(t){switch(t.label){case 0:return[4,this.next()];case 1:return[2,t.sent().value]}})})},n.prototype.getAudioData=function(){return $y(this,void 0,void 0,function(){var t,e,n,r=this;return Xy(this,function(i){return t=[],e=[],n=0,[2,new Promise(function(i){var a=setInterval(function(){r.includeSpectrogram&&(r.analyser.getFloatFrequencyData(r.freqData),r.freqData[0]===-1/0&&i({freqDataQueue:t,timeDataQueue:e}),t.push(r.freqData.slice(0,r.columnTruncateLength))),r.includeWaveform&&(r.analyser.getFloatTimeDomainData(r.timeData),e.push(r.timeData.slice())),++n===r.numFrames&&(clearInterval(a),i({freqDataQueue:t,timeDataQueue:e}))},r.fftSize/r.sampleRateHz*1e3)})]})})},n.prototype.stop=function(){this.isClosed=!0,this.analyser.disconnect(),this.audioContext.close(),null!=this.stream&&this.stream.getTracks().length>0&&this.stream.getTracks()[0].stop()},n.prototype.toArray=function(){throw new Error("Can not convert infinite audio stream to array.")},n.prototype.getSampleRate=function(){return this.sampleRateHz},n.prototype.flattenQueue=function(t){var e=t[0].length,n=new Float32Array(t.length*e);return t.forEach(function(t,r){return n.set(t,r*e)}),n},n.prototype.getTensorFromAudioDataArray=function(t,e){var n=new Float32Array(J.sizeFromShape(e));return n.set(t,n.length-t.length),rn(n,e)},n}(vb),Hb=function(e){function n(t,n){var r=e.call(this)||this;if(r.webcamVideoElement=t,r.webcamConfig=n,r.isClosed=!0,r.resize=!1,r.needToResize())if(r.resize=!0,r.cropSize=[r.webcamConfig.resizeHeight,r.webcamConfig.resizeWidth],r.cropBoxInd=sn([0],"int32"),r.webcamConfig.centerCrop){var i=1*r.webcamConfig.resizeWidth/r.webcamVideoElement.width,a=1*r.webcamConfig.resizeHeight/r.webcamVideoElement.height,o=(1-i)/2,s=(1-a)/2,u=o+i,l=a+s;r.cropBox=un([s,o,l,u],[1,4])}else r.cropBox=un([0,0,1,1],[1,4]);return r}return Ky(n,e),n.prototype.summary=function(){return"webcam"},n.create=function(e,r){return void 0===r&&(r={}),$y(this,void 0,void 0,function(){var i;return Xy(this,function(a){switch(a.label){case 0:if(t.ENV.get("IS_NODE"))throw new Error("tf.data.webcam is only supported in browser environment.");if(!e){if(e=document.createElement("video"),!r.resizeWidth||!r.resizeHeight)throw new Error("Please provide webcam video element, or resizeWidth and resizeHeight to create a hidden video element.");e.width=r.resizeWidth,e.height=r.resizeHeight}return[4,(i=new n(e,r)).start()];case 1:return a.sent(),[2,i]}})})},n.prototype.start=function(){return $y(this,void 0,void 0,function(){var t,e,n=this;return Xy(this,function(r){switch(r.label){case 0:this.webcamConfig.facingMode&&J.assert("user"===this.webcamConfig.facingMode||"environment"===this.webcamConfig.facingMode,function(){return"Invalid webcam facing mode: "+n.webcamConfig.facingMode+". Please provide 'user' or 'environment'"}),r.label=1;case 1:return r.trys.push([1,3,,4]),t=this,[4,navigator.mediaDevices.getUserMedia({video:{deviceId:this.webcamConfig.deviceId,facingMode:this.webcamConfig.facingMode?this.webcamConfig.facingMode:"user",width:this.webcamVideoElement.width,height:this.webcamVideoElement.height}})];case 2:return t.stream=r.sent(),[3,4];case 3:throw(e=r.sent()).message="Error thrown while initializing video stream: "+e.message,e;case 4:if(!this.stream)throw new Error("Could not obtain video from webcam.");try{this.webcamVideoElement.srcObject=this.stream}catch(t){console.log(t),this.webcamVideoElement.src=window.URL.createObjectURL(this.stream)}return this.webcamVideoElement.play(),this.isClosed=!1,[2,new Promise(function(t){n.webcamVideoElement.onloadedmetadata=function(){t()}})]}})})},n.prototype.next=function(){return $y(this,void 0,void 0,function(){var t;return Xy(this,function(e){if(this.isClosed)return[2,{value:null,done:!0}];try{t=dp.fromPixels(this.webcamVideoElement)}catch(t){throw new Error("Error thrown converting video to pixels: "+JSON.stringify(t))}if(!this.resize)return[2,{value:t,done:!1}];try{return[2,{value:this.cropAndResizeFrame(t),done:!1}]}catch(t){throw new Error("Error thrown cropping the video: "+t.message)}finally{t.dispose()}return[2]})})},n.prototype.needToResize=function(){return!(!this.webcamConfig.resizeWidth||!this.webcamConfig.resizeHeight||this.webcamVideoElement.width===this.webcamConfig.resizeWidth&&this.webcamVideoElement.height===this.webcamConfig.resizeHeight)},n.prototype.cropAndResizeFrame=function(t){var e=this;return Fe(function(){var n,r=t.toFloat().expandDims(0),i=(n=sc.cropAndResize(r,e.cropBox,e.cropBoxInd,e.cropSize,"bilinear")).shape;return n.reshape(i.slice(1))})},n.prototype.capture=function(){return $y(this,void 0,void 0,function(){return Xy(this,function(t){switch(t.label){case 0:return[4,this.next()];case 1:return[2,t.sent().value]}})})},n.prototype.stop=function(){this.stream.getTracks().forEach(function(t){return t.stop()});try{this.webcamVideoElement.srcObject=null}catch(t){console.log(t),this.webcamVideoElement.src=null}this.isClosed=!0},n.prototype.toArray=function(){throw new Error("Can not convert infinite video stream to array.")},n}(vb),Gb=function(){},Kb=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return Ky(e,t),e.prototype.split=function(t){return new $b(this,t)},e}(vb),$b=function(t){function e(e,n){var r=t.call(this)||this;return r.upstream=e,r.impl=new Xb(e,n),r}return Ky(e,t),e.prototype.summary=function(){return this.impl.summary()},e.prototype.next=function(){return $y(this,void 0,void 0,function(){return Xy(this,function(t){return[2,this.impl.next()]})})},e}(Kb),Xb=function(t){function e(e,n){var r=t.call(this)||this;return r.upstream=e,r.separator=n,r.carryover="",r}return Ky(e,t),e.prototype.summary=function(){return this.upstream.summary()+" -> Split('"+this.separator+"')"},e.prototype.pump=function(){return $y(this,void 0,void 0,function(){var t,e,n,r,i;return Xy(this,function(a){switch(a.label){case 0:return[4,this.upstream.next()];case 1:if((t=a.sent()).done)return""===this.carryover?[2,!1]:(this.outputQueue.push(this.carryover),this.carryover="",[2,!0]);for((e=t.value.split(this.separator))[0]=this.carryover+e[0],n=0,r=e.slice(0,-1);n<r.length;n++)i=r[n],this.outputQueue.push(i);return this.carryover=e[e.length-1],[2,!0]}})})},e}(Ab),Yb=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return Ky(e,t),e.prototype.decodeUTF8=function(){return new Jb(this)},e}(vb),Jb=function(t){function e(e){var n=t.call(this)||this;return n.upstream=e,n.impl=new Zb(e),n}return Ky(e,t),e.prototype.summary=function(){return this.impl.summary()},e.prototype.next=function(){return $y(this,void 0,void 0,function(){return Xy(this,function(t){return[2,this.impl.next()]})})},e}(Kb),Zb=function(e){function n(n){var r=e.call(this)||this;if(r.upstream=n,t.ENV.get("IS_BROWSER"))r.decoder=new TextDecoder("utf-8");else{var i=require("string_decoder").StringDecoder;r.decoder=new i("utf8")}return r}return Ky(n,e),n.prototype.summary=function(){return this.upstream.summary()+" -> Utf8"},n.prototype.pump=function(){return $y(this,void 0,void 0,function(){var e,n,r;return Xy(this,function(i){switch(i.label){case 0:return[4,this.upstream.next()];case 1:return(e=i.sent()).done?[2,!1]:(n=e.value,r=t.ENV.get("IS_BROWSER")?this.decoder.decode(n,{stream:!0}):this.decoder.write(Buffer.from(n.buffer)),this.outputQueue.push(r),[2,!0])}})})},n}(Ab),Qb=function(e){function n(n,r){void 0===r&&(r={});var i=e.call(this)||this;return i.file=n,i.options=r,J.assert(n instanceof Uint8Array||!!t.ENV.get("IS_BROWSER")&&(n instanceof File||n instanceof Blob),function(){return"FileChunkIterator only supports File, Blob and Uint8Array right now."}),i.offset=r.offset||0,i.chunkSize=r.chunkSize||1048576,i}return Ky(n,e),n.prototype.summary=function(){return"FileChunks "+this.file},n.prototype.next=function(){return $y(this,void 0,void 0,function(){var t,e,n=this;return Xy(this,function(r){switch(r.label){case 0:return this.offset>=(this.file instanceof Uint8Array?this.file.byteLength:this.file.size)?[2,{value:null,done:!0}]:(t=new Promise(function(t,e){var r=n.offset+n.chunkSize;if(n.file instanceof Uint8Array)t(new Uint8Array(n.file.slice(n.offset,r)));else{var i=new FileReader;i.onload=function(n){var r=i.result;if(r instanceof ArrayBuffer&&(r=new Uint8Array(r)),!(r instanceof Uint8Array))return e(new TypeError("FileReader returned unknown type."));t(r)},i.onabort=function(t){return e(new Error("Aborted"))},i.onerror=function(t){return e(new Error(t.type))};var a=n.file.slice(n.offset,r);i.readAsArrayBuffer(a)}n.offset=r}),e={},[4,t]);case 1:return[2,(e.value=r.sent(),e.done=!1,e)]}})})},n}(Yb);var tx=function(t){return{method:t.method,headers:t.headers,body:t.body,mode:t.mode,credentials:t.credentials,cache:t.cache,redirect:t.redirect,referrer:t.referrer,integrity:t.integrity}};function ex(t){return"string"==typeof t&&"file://"===t.substr(0,7)}var nx=function(e){function n(t,n){void 0===n&&(n={});var r=e.call(this)||this;return r.input=t,r.options=n,r}return Ky(n,e),n.prototype.iterator=function(){return $y(this,void 0,void 0,function(){var e;return Xy(this,function(n){return ex(this.input)&&t.ENV.get("IS_NODE")&&(e=require("fs"),this.input=e.readFileSync(this.input.substr(7))),[2,new Qb(this.input,this.options)]})})},n}(Gb),rx=function(t){function e(e,n){void 0===n&&(n={});var r=t.call(this)||this;return r.url=e,r.fileOptions=n,r}return Ky(e,t),e.prototype.iterator=function(){return $y(this,void 0,void 0,function(){return Xy(this,function(t){return ex(this.url)?[2,new nx(this.url,this.fileOptions).iterator()]:[2,function(t,e){return void 0===e&&(e={}),$y(this,void 0,void 0,function(){var n,r,i,a,o;return Xy(this,function(s){switch(s.label){case 0:return"string"==typeof t?n=t:(n=t.url,r=tx(t)),[4,J.fetch(n,r)];case 1:return(i=s.sent()).ok?(o=Uint8Array.bind,[4,i.arrayBuffer()]):[3,3];case 2:return a=new(o.apply(Uint8Array,[void 0,s.sent()])),[2,new Qb(a,e)];case 3:throw new Error(i.statusText)}})})}(this.url,this.fileOptions)]})})},e}(Gb);var ix=Object.freeze({array:function(t){var e=this;return Mb(function(){return $y(e,void 0,void 0,function(){return Xy(this,function(e){return[2,db(t)]})})},t.length)},Dataset:Fb,zip:function(t){var e,n=this;if(!lb(t))throw new Error("The argument to zip() must be an object or array.");if(Array.isArray(t))for(var r=0;r<t.length;r++)e=null==e?t[r].size:Math.min(e,t[r].size);else if(t instanceof Object)for(var i in t)e=null==e?t[i].size:Math.min(e,t[i].size);return Mb(function(){return $y(n,void 0,void 0,function(){return Xy(this,function(e){switch(e.label){case 0:return[4,ub(t,function(t){if(t instanceof Fb)return{value:t.iterator(),recurse:!1};if(lb(t))return{value:null,recurse:!0};throw new Error("Leaves of the structure passed to zip() must be Datasets, not primitives.")})];case 1:return[2,function(t,e){return void 0===e&&(e=gb.FAIL),new Db(t,e)}(e.sent(),gb.SHORTEST)]}})})},e)},CSVDataset:jb,TextLineDataset:Lb,csv:function(t,e){return void 0===e&&(e={}),new jb(new rx(t),e)},func:function(t){var e=this,n=mb(t);return Mb(function(){return $y(e,void 0,void 0,function(){return Xy(this,function(t){return[2,n]})})})},generator:function(t){var e=this;return Mb(function(){return $y(e,void 0,void 0,function(){var e;return Xy(this,function(n){switch(n.label){case 0:return[4,t()];case 1:return e=n.sent(),[2,mb(function(){return e.next()})]}})})})},microphone:function(t){return $y(this,void 0,void 0,function(){return Xy(this,function(e){return[2,qb.create(t)]})})},webcam:function(t,e){return $y(this,void 0,void 0,function(){return Xy(this,function(n){return[2,Hb.create(t,e)]})})},FileDataSource:nx,URLDataSource:rx,version_data:"1.2.8"}),ax={"tfjs-core":"1.2.8","tfjs-data":"1.2.8","tfjs-layers":"1.2.8","tfjs-converter":"1.2.8",tfjs:"1.2.8"};t.data=ix,t.version=ax,t.AdadeltaOptimizer=Ip,t.AdagradOptimizer=Ap,t.AdamOptimizer=Rp,t.AdamaxOptimizer=Tp,t.DataStorage=Dr,t.Environment=a,t.KernelBackend=Or,t.MomentumOptimizer=Op,t.Optimizer=kp,t.RMSPropOptimizer=_p,t.SGDOptimizer=Dp,t.Tensor=ct,t.TensorBuffer=ot,t.Variable=pt,t.abs=zo,t.acos=Lo,t.acosh=Po,t.add=Ls,t.addN=Ps,t.addStrict=Bs,t.all=el,t.any=nl,t.argMax=rl,t.argMin=il,t.asin=Bo,t.asinh=Vo,t.atan=Wo,t.atan2=Vs,t.atanh=Uo,t.avgPool=Hu,t.avgPool3d=$u,t.backend=Le,t.backend_util=Jr,t.basicLSTMCell=xl,t.batchNorm=Is,t.batchNorm2d=As,t.batchNorm3d=Rs,t.batchNorm4d=Ts,t.batchNormalization=ks,t.batchNormalization2d=Cs,t.batchNormalization3d=Es,t.batchNormalization4d=Ss,t.batchToSpaceND=Vn,t.booleanMaskAsync=xu,t.browser=dp,t.buffer=Pn,t.cast=Wn,t.ceil=jo,t.clipByValue=qo,t.clone=Un,t.complex=tn,t.concat=xn,t.concat1d=wn,t.concat2d=Nn,t.concat3d=Cn,t.concat4d=En,t.conv1d=Su,t.conv2d=ku,t.conv2dDerFilter=Au,t.conv2dDerInput=Ru,t.conv2dTranspose=Ou,t.conv3d=Iu,t.conv3dTranspose=_u,t.cos=Ho,t.cosh=Go,t.cumsum=jn,t.customGrad=Ir,t.deprecationWarn=Oe,t.depthToSpace=qn,t.depthwiseConv2d=Tu,t.diag=_l,t.disableDeprecationWarnings=function(){t.ENV.set("DEPRECATION_WARNINGS_ENABLED",!1),console.warn("TensorFlow.js deprecation warnings have been disabled.")},t.dispose=Me,t.disposeVariables=function(){It.disposeVariables()},t.div=Ws,t.divStrict=Us,t.dot=Mu,t.dropout=Fl,t.elu=hl,t.enableDebugMode=function(){t.ENV.set("DEBUG",!0)},t.enableProdMode=function(){t.ENV.set("PROD",!0)},t.environment=u,t.equal=iu,t.equalStrict=au,t.erf=Ko,t.exp=$o,t.expandDims=Hn,t.expm1=Xo,t.eye=Gn,t.fft=kl,t.fill=mn,t.findBackend=function(t){return It.findBackend(t)},t.findBackendFactory=function(t){return It.findBackendFactory(t)},t.floor=Yo,t.floorDiv=js,t.frame=Pl,t.fused=cc,t.gather=yu,t.gatherND=Ol,t.getBackend=function(){return It.backendName},t.grad=function(t){return f(V(t),function(){return"The f passed in grad(f) must be a function"}),function(e,n){var r=We(e,"x","tf.grad",null),i=null!=n?We(n,"dy","tf.grad"):null;return It.tidy(function(){var e=It.gradients(function(){return t(r)},[r],i),n=e.value,a=e.grads;return null!=i&&d(n.shape,i.shape,"The shape of dy passed in grad(f)(x, dy) must match the shape returned by f(x)"),Ar(a),a[0]})}},t.grads=function(t){return f(V(t),function(){return"The f passed in grads(f) must be a function"}),function(e,n){f(Array.isArray(e),function(){return"The args passed in grads(f)(args) must be an array of `Tensor`s or `TensorLike`s"});var r=Ue(e,"args","tf.grads",null),i=null!=n?We(n,"dy","tf.grads"):null;return It.tidy(function(){var e=It.gradients(function(){return t.apply(void 0,r)},r,i),n=e.value,a=e.grads;return null!=i&&d(n.shape,i.shape,"The shape of dy passed in grads(f)([x1,...], dy) must match the shape returned by f([x1,...])"),Ar(a),a})}},t.greater=ou,t.greaterEqual=su,t.greaterEqualStrict=uu,t.greaterStrict=lu,t.hammingWindow=Ll,t.hannWindow=zl,t.ifft=Il,t.imag=nn,t.image=sc,t.inTopKAsync=Wl,t.io=cp,t.irfft=Rl,t.isFinite=us,t.isInf=ss,t.isNaN=os,t.keep=ze,t.leakyRelu=fl,t.less=cu,t.lessEqual=pu,t.lessEqualStrict=hu,t.lessStrict=fu,t.linalg=ec,t.linspace=gn,t.localResponseNormalization=yl,t.log=Jo,t.log1p=Zo,t.logSigmoid=Qo,t.logSoftmax=Tr,t.logSumExp=al,t.logicalAnd=Ds,t.logicalNot=Os,t.logicalOr=_s,t.logicalXor=Fs,t.losses=Jl,t.matMul=Fu,t.math=hp,t.max=ol,t.maxPool=qu,t.maxPool3d=Ku,t.maximum=qs,t.maximumStrict=Hs,t.mean=sl,t.memory=_e,t.min=ul,t.minimum=Gs,t.minimumStrict=Ks,t.mod=$s,t.modStrict=Xs,t.moments=ll,t.movingAverage=Nl,t.mul=Ys,t.mulStrict=Js,t.multiRNNCell=wl,t.multinomial=Kn,t.neg=ts,t.nextFrame=Lp,t.norm=bl,t.notEqual=du,t.notEqualStrict=mu,t.oneHot=$n,t.ones=fn,t.onesLike=yn,t.op=Qe,t.outerProduct=zu,t.pad=Xn,t.pad1d=Yn,t.pad2d=Jn,t.pad3d=Zn,t.pad4d=Qn,t.pool=Gu,t.pow=Zs,t.powStrict=Qs,t.prelu=dl,t.print=Bn,t.prod=pl,t.profile=function(t){return It.profile(t)},t.rand=tr,t.randomGamma=nr,t.randomNormal=er,t.randomUniform=rr,t.range=vn,t.ready=function(){return It.ready()},t.real=en,t.reciprocal=es,t.registerBackend=function(t,e,n){return void 0===n&&(n=1),It.registerBackend(t,e,n)},t.relu=ml,t.removeBackend=function(t){It.removeBackend(t)},t.reshape=ir,t.reverse=Lu,t.reverse1d=Pu,t.reverse2d=Bu,t.reverse3d=Vu,t.reverse4d=Wu,t.rfft=Al,t.round=ns,t.rsqrt=rs,t.scalar=on,t.scatterND=Sl,t.selu=gl,t.separableConv2d=Du,t.serialization=yp,t.setBackend=function(t){return It.setBackend(t)},t.setPlatform=function(e,n){t.ENV.setPlatform(e,n)},t.setdiff1dAsync=pr,t.sigmoid=is,t.sign=as,t.signal=Vl,t.sin=ls,t.sinh=cs,t.slice=Xu,t.slice1d=Yu,t.slice2d=Ju,t.slice3d=Zu,t.slice4d=Qu,t.softmax=Rr,t.softplus=ps,t.spaceToBatchND=ar,t.sparseToDense=Dl,t.spectral=Tl,t.split=Sn,t.sqrt=hs,t.square=fs,t.squaredDifference=tu,t.squaredDifferenceStrict=eu,t.squeeze=or,t.stack=sr,t.step=ds,t.stft=Bl,t.stridedSlice=Cl,t.sub=nu,t.subStrict=ru,t.sum=cl,t.tan=ms,t.tanh=gs,t.tensor=rn,t.tensor1d=sn,t.tensor2d=un,t.tensor3d=ln,t.tensor4d=cn,t.tensor5d=pn,t.tensor6d=hn,t.tensor_util=Et,t.test_util=Ep,t.tidy=Fe,t.tile=ur,t.time=function(t){return It.time(t)},t.topk=El,t.train=Mp,t.transpose=vl,t.truncatedNormal=lr,t.unsortedSegmentSum=bu,t.unstack=cr,t.util=J,t.valueAndGrad=function(t){return f(V(t),function(){return"The f passed in valueAndGrad(f) must be a function"}),function(e,n){f(e instanceof ct,function(){return"The x passed in valueAndGrad(f)(x) must be a tensor"}),f(null==n||n instanceof ct,function(){return"The dy passed in valueAndGrad(f)(x, dy) must be a tensor"});var r=It.gradients(function(){return t(e)},[e],n),i=r.grads,a=r.value;return Ar(i),{grad:i[0],value:a}}},t.valueAndGrads=function(t){return f(V(t),function(){return"The f passed in valueAndGrads(f) must be a function"}),function(e,n){f(Array.isArray(e)&&e.every(function(t){return t instanceof ct}),function(){return"The args passed in valueAndGrads(f)(args) must be array of tensors"}),f(null==n||n instanceof ct,function(){return"The dy passed in valueAndGrads(f)(args, dy) must be a tensor"});var r=It.gradients(function(){return t.apply(void 0,e)},e,n);return null!=n&&d(r.value.shape,n.shape,"The shape of dy passed in valueAndGrads(f)([x1,...], dy) must match the shape returned by f([x1,...])"),Ar(r.grads),r}},t.variable=gt,t.variableGrads=kr,t.version_core="1.2.8",t.webgl=Sp,t.where=Ms,t.whereAsync=zs,t.zeros=dn,t.zerosLike=bn,t.constraints=Nh,t.initializers=Rf,t.layers=xv,t.metrics=wv,t.models=Nv,t.regularizers=Cv,t.CallbackList=nd,t.CustomCallback=ad,t.History=id,t.Callback=Ev,t.callbacks=Av,t.EarlyStopping=Iv,t.InputSpec=jf,t.SymbolicTensor=qf,t.LayersModel=cm,t.input=fm,t.loadLayersModel=function(t,e){return null==e&&(e={}),pm(t,e)},t.model=function(t){return new cm(t)},t.registerCallbackConstructor=function(t,e){sd.registerCallbackConstructor(t,e)},t.sequential=function(t){return new hm(t)},t.RNN=Xg,t.Sequential=hm,t.LayerVariable=Vf,t.version_layers="1.2.8",t.GraphModel=Hy,t.loadGraphModel=function(t,e){return void 0===e&&(e={}),Tv(this,void 0,void 0,function(){var n;return Dv(this,function(r){switch(r.label){case 0:if(null==t)throw new Error("modelUrl in loadGraphModel() cannot be null. Please provide a url or an IOHandler that loads the model");return null==e&&(e={}),e.fromTFHub&&null==t.load&&(t.endsWith("/")||(t+="/"),t=""+t+qy+jy),[4,(n=new Hy(t,e)).load()];case 1:return r.sent(),[2,n]}})})},t.deregisterOp=function(t){delete Fv[t]},t.registerOp=Mv,t.version_converter="1.2.8",Object.defineProperty(t,"__esModule",{value:!0})});
//# sourceMappingURL=tf.min.js.map


!function(f){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=f();else if("function"==typeof define&&define.amd)define([],f);else{("undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this).nsfwjs=f()}}(function(){return function r(e,n,t){function o(i,f){if(!n[i]){if(!e[i]){var c="function"==typeof require&&require;if(!f&&c)return c(i,!0);if(u)return u(i,!0);var a=new Error("Cannot find module '"+i+"'");throw a.code="MODULE_NOT_FOUND",a}var p=n[i]={exports:{}};e[i][0].call(p.exports,function(r){return o(e[i][1][r]||r)},p,p.exports,r,e,n,t)}return n[i].exports}for(var u="function"==typeof require&&require,i=0;i<t.length;i++)o(t[i]);return o}({1:[function(require,module,exports){"use strict";var __awaiter=this&&this.__awaiter||function(thisArg,_arguments,P,generator){return new(P=P||Promise)(function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){result.done?resolve(result.value):function(value){return value instanceof P?value:new P(function(resolve){resolve(value)})}(result.value).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())})},__generator=this&&this.__generator||function(thisArg,body){var f,y,t,g,_={label:0,sent:function(){if(1&t[0])throw t[1];return t[1]},trys:[],ops:[]};return g={next:verb(0),throw:verb(1),return:verb(2)},"function"==typeof Symbol&&(g[Symbol.iterator]=function(){return this}),g;function verb(n){return function(v){return function(op){if(f)throw new TypeError("Generator is already executing.");for(;_;)try{if(f=1,y&&(t=2&op[0]?y.return:op[0]?y.throw||((t=y.return)&&t.call(y),0):y.next)&&!(t=t.call(y,op[1])).done)return t;switch(y=0,t&&(op=[2&op[0],t.value]),op[0]){case 0:case 1:t=op;break;case 4:return _.label++,{value:op[1],done:!1};case 5:_.label++,y=op[1],op=[0];continue;case 7:op=_.ops.pop(),_.trys.pop();continue;default:if(!(t=0<(t=_.trys).length&&t[t.length-1])&&(6===op[0]||2===op[0])){_=0;continue}if(3===op[0]&&(!t||op[1]>t[0]&&op[1]<t[3])){_.label=op[1];break}if(6===op[0]&&_.label<t[1]){_.label=t[1],t=op;break}if(t&&_.label<t[2]){_.label=t[2],_.ops.push(op);break}t[2]&&_.ops.pop(),_.trys.pop();continue}op=body.call(thisArg,_)}catch(e){op=[6,e],y=0}finally{f=t=0}if(5&op[0])throw op[1];return{value:op[0]?op[1]:void 0,done:!0}}([n,v])}}};Object.defineProperty(exports,"__esModule",{value:!0});var tf=require("@tensorflow/tfjs"),nsfw_classes_1=require("./nsfw_classes"),SuperGif=require("libgif"),BASE_PATH="https://s3.amazonaws.com/ir_public/nsfwjscdn/TFJS_nsfw_mobilenet/tfjs_quant_nsfw_mobilenet/",IMAGE_SIZE=224;exports.load=function(base,options){return void 0===base&&(base=BASE_PATH),void 0===options&&(options={size:IMAGE_SIZE}),__awaiter(this,void 0,void 0,function(){var nsfwnet;return __generator(this,function(_a){switch(_a.label){case 0:if(null==tf)throw new Error("Cannot find TensorFlow.js. If you are using a <script> tag, please also include @tensorflow/tfjs on the page before using this model.");return[4,(nsfwnet=new NSFWJS(base,options)).load()];case 1:return _a.sent(),[2,nsfwnet]}})})};var NSFWJS=function(){function NSFWJS(modelPathBaseOrIOHandler,options){this.intermediateModels={},this.options=options,this.normalizationOffset=tf.scalar(255),this.pathOrIOHandler="string"==typeof modelPathBaseOrIOHandler?modelPathBaseOrIOHandler+"model.json":modelPathBaseOrIOHandler}return NSFWJS.prototype.load=function(){return __awaiter(this,void 0,void 0,function(){var _a,size,result,_this=this;return __generator(this,function(_b){switch(_b.label){case 0:return _a=this,[4,tf.loadLayersModel(this.pathOrIOHandler)];case 1:return _a.model=_b.sent(),this.endpoints=this.model.layers.map(function(l){return l.name}),size=this.options.size,[4,(result=tf.tidy(function(){return _this.model.predict(tf.zeros([1,size,size,3]))})).data()];case 2:return _b.sent(),result.dispose(),[2]}})})},NSFWJS.prototype.infer=function(img,endpoint){var _this=this;if(null!=endpoint&&-1===this.endpoints.indexOf(endpoint))throw new Error("Unknown endpoint "+endpoint+". Available endpoints: "+this.endpoints+".");return tf.tidy(function(){img instanceof tf.Tensor||(img=tf.browser.fromPixels(img));var normalized=img.toFloat().div(_this.normalizationOffset),resized=normalized,size=_this.options.size;if(img.shape[0]!==size||img.shape[1]!==size){resized=tf.image.resizeBilinear(normalized,[size,size],!0)}var model,batched=resized.reshape([1,size,size,3]);if(null==endpoint)model=_this.model;else{if(null==_this.intermediateModels[endpoint]){var layer=_this.model.layers.find(function(l){return l.name===endpoint});_this.intermediateModels[endpoint]=tf.model({inputs:_this.model.inputs,outputs:layer.output})}model=_this.intermediateModels[endpoint]}return model.predict(batched)})},NSFWJS.prototype.classify=function(img,topk){return void 0===topk&&(topk=5),__awaiter(this,void 0,void 0,function(){var logits,classes;return __generator(this,function(_a){switch(_a.label){case 0:return[4,function(logits,topK){return __awaiter(this,void 0,void 0,function(){var values,valuesAndIndices,topkValues,topkIndices,topClassesAndProbs,i;return __generator(this,function(_a){switch(_a.label){case 0:return[4,logits.data()];case 1:for(values=_a.sent(),valuesAndIndices=[],i=0;i<values.length;i++)valuesAndIndices.push({value:values[i],index:i});for(valuesAndIndices.sort(function(a,b){return b.value-a.value}),topkValues=new Float32Array(topK),topkIndices=new Int32Array(topK),i=0;i<topK;i++)topkValues[i]=valuesAndIndices[i].value,topkIndices[i]=valuesAndIndices[i].index;for(topClassesAndProbs=[],i=0;i<topkIndices.length;i++)topClassesAndProbs.push({className:nsfw_classes_1.NSFW_CLASSES[topkIndices[i]],probability:topkValues[i]});return[2,topClassesAndProbs]}})})}(logits=this.infer(img),topk)];case 1:return classes=_a.sent(),logits.dispose(),[2,classes]}})})},NSFWJS.prototype.classifyGif=function(gif,config){return void 0===config&&(config={topk:5}),__awaiter(this,void 0,void 0,function(){var gifObj,_this=this;return __generator(this,function(_a){return gifObj=new SuperGif({gif:gif}),[2,new Promise(function(resolve){gifObj.load(function(){return __awaiter(_this,void 0,void 0,function(){var arrayOfClasses,gifLength,i,classes;return __generator(this,function(_a){switch(_a.label){case 0:arrayOfClasses=[],gifLength=gifObj.get_length(),i=1,_a.label=1;case 1:return i<=gifLength?(gifObj.move_to(i),[4,this.classify(gifObj.get_canvas(),config.topk)]):[3,4];case 2:classes=_a.sent(),config.onFrame&&config.onFrame({index:i,totalFrames:gifLength,predictions:classes}),arrayOfClasses.push(classes),_a.label=3;case 3:return i++,[3,1];case 4:return config.setGifControl&&config.setGifControl(gifObj),gifObj=null,resolve(arrayOfClasses),[2]}})})})})]})})},NSFWJS}();exports.NSFWJS=NSFWJS},{"./nsfw_classes":2,"@tensorflow/tfjs":330,libgif:336}],2:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.NSFW_CLASSES={0:"Drawing",1:"Hentai",2:"Neutral",3:"Porn",4:"Sexy"}},{}],3:[function(require,module,exports){"use strict";module.exports=require("./index")},{"./index":1}],4:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),function(DataType){DataType[DataType.DT_INVALID=0]="DT_INVALID",DataType[DataType.DT_FLOAT=1]="DT_FLOAT",DataType[DataType.DT_DOUBLE=2]="DT_DOUBLE",DataType[DataType.DT_INT32=3]="DT_INT32",DataType[DataType.DT_UINT8=4]="DT_UINT8",DataType[DataType.DT_INT16=5]="DT_INT16",DataType[DataType.DT_INT8=6]="DT_INT8",DataType[DataType.DT_STRING=7]="DT_STRING",DataType[DataType.DT_COMPLEX64=8]="DT_COMPLEX64",DataType[DataType.DT_INT64=9]="DT_INT64",DataType[DataType.DT_BOOL=10]="DT_BOOL",DataType[DataType.DT_QINT8=11]="DT_QINT8",DataType[DataType.DT_QUINT8=12]="DT_QUINT8",DataType[DataType.DT_QINT32=13]="DT_QINT32",DataType[DataType.DT_BFLOAT16=14]="DT_BFLOAT16",DataType[DataType.DT_FLOAT_REF=101]="DT_FLOAT_REF",DataType[DataType.DT_DOUBLE_REF=102]="DT_DOUBLE_REF",DataType[DataType.DT_INT32_REF=103]="DT_INT32_REF",DataType[DataType.DT_UINT8_REF=104]="DT_UINT8_REF",DataType[DataType.DT_INT16_REF=105]="DT_INT16_REF",DataType[DataType.DT_INT8_REF=106]="DT_INT8_REF",DataType[DataType.DT_STRING_REF=107]="DT_STRING_REF",DataType[DataType.DT_COMPLEX64_REF=108]="DT_COMPLEX64_REF",DataType[DataType.DT_INT64_REF=109]="DT_INT64_REF",DataType[DataType.DT_BOOL_REF=110]="DT_BOOL_REF",DataType[DataType.DT_QINT8_REF=111]="DT_QINT8_REF",DataType[DataType.DT_QUINT8_REF=112]="DT_QUINT8_REF",DataType[DataType.DT_QINT32_REF=113]="DT_QINT32_REF",DataType[DataType.DT_BFLOAT16_REF=114]="DT_BFLOAT16_REF"}(exports.DataType||(exports.DataType={})),function(SaverDef){!function(CheckpointFormatVersion){CheckpointFormatVersion[CheckpointFormatVersion.LEGACY=0]="LEGACY",CheckpointFormatVersion[CheckpointFormatVersion.V1=1]="V1",CheckpointFormatVersion[CheckpointFormatVersion.V2=2]="V2"}(SaverDef.CheckpointFormatVersion||(SaverDef.CheckpointFormatVersion={}))}(exports.SaverDef||(exports.SaverDef={}))},{}],5:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var ExecutionContext=function(){function ExecutionContext(weightMap,tensorArrayMap){this.weightMap=weightMap,this.tensorArrayMap=tensorArrayMap,this.rootContext={id:0,frameName:"",iterationId:0},this.contexts=[this.rootContext],this.lastId=0,this.generateCurrentContextIds()}return ExecutionContext.prototype.newFrame=function(id,frameName){return{id:id,frameName:frameName,iterationId:0}},Object.defineProperty(ExecutionContext.prototype,"currentContext",{get:function(){return this.contexts},set:function(contexts){this.contexts!==contexts&&(this.contexts=contexts,this.generateCurrentContextIds())},enumerable:!0,configurable:!0}),Object.defineProperty(ExecutionContext.prototype,"currentContextId",{get:function(){return this._currentContextIds[0]},enumerable:!0,configurable:!0}),Object.defineProperty(ExecutionContext.prototype,"currentContextIds",{get:function(){return this._currentContextIds},enumerable:!0,configurable:!0}),ExecutionContext.prototype.generateCurrentContextIds=function(){for(var names=[],i=0;i<this.contexts.length-1;i++){var contexts=this.contexts.slice(0,this.contexts.length-i);names.push(this.contextIdforContexts(contexts))}names.push(""),this._currentContextIds=names},ExecutionContext.prototype.contextIdforContexts=function(contexts){return contexts?contexts.map(function(context){return 0===context.id&&0===context.iterationId?"":context.frameName+"-"+context.iterationId}).join("/"):""},ExecutionContext.prototype.enterFrame=function(frameId){this.contexts&&(this.lastId++,this.contexts=this.contexts.slice(),this.contexts.push(this.newFrame(this.lastId,frameId)),this._currentContextIds.unshift(this.contextIdforContexts(this.contexts)))},ExecutionContext.prototype.exitFrame=function(){if(!(this.contexts&&1<this.contexts.length))throw new Error("Cannot exit frame, the context is empty");this.contexts=this.contexts.slice(),this.contexts.splice(-1),this.currentContextIds.shift()},ExecutionContext.prototype.nextIteration=function(){if(!(this.contexts&&0<this.contexts.length))throw new Error("Cannot increase frame iteration, the context is empty");this.contexts=this.contexts.slice(),this.lastId++;var context=Object.assign({},this.contexts[this.contexts.length-1]);context.iterationId+=1,context.id=this.lastId,this.contexts.splice(-1,1,context),this._currentContextIds.splice(0,1,this.contextIdforContexts(this.contexts))},ExecutionContext.prototype.getWeight=function(name){return this.weightMap[name]},ExecutionContext.prototype.addTensorArray=function(tensorArray){this.tensorArrayMap[tensorArray.id]=tensorArray},ExecutionContext.prototype.getTensorArray=function(id){return this.tensorArrayMap[id]},ExecutionContext}();exports.ExecutionContext=ExecutionContext},{}],6:[function(require,module,exports){"use strict";var __assign=this&&this.__assign||function(){return(__assign=Object.assign||function(t){for(var s,i=1,n=arguments.length;i<n;i++)for(var p in s=arguments[i])Object.prototype.hasOwnProperty.call(s,p)&&(t[p]=s[p]);return t}).apply(this,arguments)},__awaiter=this&&this.__awaiter||function(thisArg,_arguments,P,generator){return new(P=P||Promise)(function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){result.done?resolve(result.value):new P(function(resolve){resolve(result.value)}).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())})},__generator=this&&this.__generator||function(thisArg,body){var f,y,t,g,_={label:0,sent:function(){if(1&t[0])throw t[1];return t[1]},trys:[],ops:[]};return g={next:verb(0),throw:verb(1),return:verb(2)},"function"==typeof Symbol&&(g[Symbol.iterator]=function(){return this}),g;function verb(n){return function(v){return function(op){if(f)throw new TypeError("Generator is already executing.");for(;_;)try{if(f=1,y&&(t=2&op[0]?y.return:op[0]?y.throw||((t=y.return)&&t.call(y),0):y.next)&&!(t=t.call(y,op[1])).done)return t;switch(y=0,t&&(op=[2&op[0],t.value]),op[0]){case 0:case 1:t=op;break;case 4:return _.label++,{value:op[1],done:!1};case 5:_.label++,y=op[1],op=[0];continue;case 7:op=_.ops.pop(),_.trys.pop();continue;default:if(!(t=0<(t=_.trys).length&&t[t.length-1])&&(6===op[0]||2===op[0])){_=0;continue}if(3===op[0]&&(!t||op[1]>t[0]&&op[1]<t[3])){_.label=op[1];break}if(6===op[0]&&_.label<t[1]){_.label=t[1],t=op;break}if(t&&_.label<t[2]){_.label=t[2],_.ops.push(op);break}t[2]&&_.ops.pop(),_.trys.pop();continue}op=body.call(thisArg,_)}catch(e){op=[6,e],y=0}finally{f=t=0}if(5&op[0])throw op[1];return{value:op[0]?op[1]:void 0,done:!0}}([n,v])}}};Object.defineProperty(exports,"__esModule",{value:!0});var tfjs_core_1=require("@tensorflow/tfjs-core"),utils_1=require("../operations/executors/utils"),operation_executor_1=require("../operations/operation_executor"),execution_context_1=require("./execution_context"),model_analysis_1=require("./model_analysis"),model_rewrite_1=require("./model_rewrite"),GraphExecutor=function(){function GraphExecutor(graph){this.graph=graph,this.compiledMap=new Map,this._weightMap={},this.SEPERATOR=",",this.placeholders=graph.placeholders,this._outputs=graph.outputs}return Object.defineProperty(GraphExecutor.prototype,"weightMap",{get:function(){return this._weightMap},set:function(weightMap){var weightIds=Object.keys(weightMap).map(function(key){return weightMap[key].map(function(tensor){return tensor.id})});this.weightIds=[].concat.apply([],weightIds),this._weightMap=weightMap},enumerable:!0,configurable:!0}),Object.defineProperty(GraphExecutor.prototype,"inputs",{get:function(){return this.placeholders.map(function(node){return{name:node.name,shape:node.attrParams.shape?node.attrParams.shape.value:void 0,dtype:node.attrParams.dtype?node.attrParams.dtype.value:void 0}})},enumerable:!0,configurable:!0}),Object.defineProperty(GraphExecutor.prototype,"outputs",{get:function(){return this._outputs.map(function(node){return{name:node.name,shape:node.attrParams.shape?node.attrParams.shape.value:void 0,dtype:node.attrParams.dtype?node.attrParams.dtype.value:void 0}})},enumerable:!0,configurable:!0}),Object.defineProperty(GraphExecutor.prototype,"inputNodes",{get:function(){return this.placeholders.map(function(node){return node.name})},enumerable:!0,configurable:!0}),Object.defineProperty(GraphExecutor.prototype,"outputNodes",{get:function(){return this.outputs.map(function(node){return node.name})},enumerable:!0,configurable:!0}),GraphExecutor.prototype.getCompilationKey=function(inputs,outputs){var sortedInputs=inputs.map(function(node){return node.name}).sort(),sortedOutputs=outputs.map(function(node){return node.name}).sort();return sortedInputs.join(this.SEPERATOR)+"--"+sortedOutputs.join(this.SEPERATOR)},GraphExecutor.prototype.compile=function(inputs,outputs){var executionInfo=model_analysis_1.getExecutionSubgraph(inputs,outputs,this.weightMap),missingInputs=executionInfo.missingInputs,dynamicNode=executionInfo.dynamicNode,syncInputs=executionInfo.syncInputs;if(null!=dynamicNode)throw new Error("This execution contains the node '"+dynamicNode.name+"', which has the dynamic op '"+dynamicNode.op+"'. Please use model.executeAsync() instead. Alternatively, to avoid the dynamic ops, specify the inputs ["+syncInputs+"]");if(0<missingInputs.length){var outNames=outputs.map(function(n){return n.name}),inNames=Object.keys(inputs);throw new Error("Cannot compute the outputs ["+outNames+"] from the provided inputs ["+inNames+"]. Missing the following inputs: ["+missingInputs+"]")}return model_analysis_1.getNodesInTopologicalOrder(this.graph,this.weightMap,executionInfo)},GraphExecutor.prototype.fusePrelu=function(){model_rewrite_1.rewritePrelu(this.graph,this.weightMap)},GraphExecutor.prototype.execute=function(inputs,outputs){var _this=this,names=Object.keys(inputs).sort();this.checkInputs(inputs),this.checkInputShapeAndType(inputs),this.checkOutputs(outputs);var inputNodes=names.map(function(name){return _this.graph.nodes[name]}),outputNodes=outputs.map(function(name){return _this.graph.nodes[utils_1.parseNodeName(name)[0]]}),compilationKey=this.getCompilationKey(inputNodes,outputNodes),orderedNodes=this.compiledMap.get(compilationKey);null==orderedNodes&&(orderedNodes=this.compile(inputs,outputNodes),this.compiledMap.set(compilationKey,orderedNodes));var tensorArrayMap={};return tfjs_core_1.tidy(function(){var context=new execution_context_1.ExecutionContext(_this._weightMap,tensorArrayMap),tensorsMap=__assign({},_this.weightMap);Object.keys(inputs).forEach(function(name){tensorsMap[name]=[inputs[name]]});for(var tensorsToKeep=_this.getFrozenTensorIds(tensorsMap),intermediateTensorConsumerCount={},i=0;i<orderedNodes.length;i++){var node=orderedNodes[i];if(!tensorsMap[node.name]){var tensors=operation_executor_1.executeOp(node,tensorsMap,context);if(tensors instanceof Promise)throw new Error("The execution of the op '"+node.op+"' returned a promise. Please use model.executeAsync() instead.");tensorsMap[node.name]=tensors,_this.checkTensorForDisposal(node.name,node,tensorsMap,context,tensorsToKeep,outputs,intermediateTensorConsumerCount)}}return outputs.map(function(name){return utils_1.getTensor(name,tensorsMap,context)})})},GraphExecutor.prototype.getFrozenTensorIds=function(tensorMap){var ids=[].concat.apply([],Object.keys(tensorMap).map(function(key){return tensorMap[key]}).map(function(tensors){return tensors.map(function(tensor){return tensor.id})}));return new Set(ids)},GraphExecutor.prototype.checkTensorForDisposal=function(nodeName,node,tensorMap,context,tensorsToKeep,outputNames,intermediateTensorConsumerCount){"control"!==node.category&&-1===outputNames.indexOf(nodeName)&&(tensorMap[nodeName].forEach(function(tensor){null!=tensor&&(intermediateTensorConsumerCount[tensor.id]=(intermediateTensorConsumerCount[tensor.id]||0)+node.children.length)}),node.inputs.forEach(function(input){if("control"!==input.category){var tensors=utils_1.getTensorsForCurrentContenxt(input.name,tensorMap,context);null!=tensors&&tensors.forEach(function(tensor){if(tensor&&!tensorsToKeep.has(tensor.id)){var count=intermediateTensorConsumerCount[tensor.id];1===count?(tensor.dispose(),delete intermediateTensorConsumerCount[tensor.id]):null!=count&&intermediateTensorConsumerCount[tensor.id]--}})}}))},GraphExecutor.prototype.executeAsync=function(inputs,outputs){return __awaiter(this,void 0,void 0,function(){var tensorArrayMap,context,tensorMap,results,outputIds,inputIds,_this=this;return __generator(this,function(_a){switch(_a.label){case 0:return this.checkInputs(inputs),this.checkInputShapeAndType(inputs),this.checkOutputs(outputs),tensorArrayMap={},context=new execution_context_1.ExecutionContext(this._weightMap,tensorArrayMap),[4,this.executeWithControlFlow(inputs,context,outputs)];case 1:return tensorMap=_a.sent(),results=outputs.map(function(name){return utils_1.getTensor(name,tensorMap,context)}),outputIds=new Set(results.map(function(t){return t.id})),inputIds=new Set(Object.keys(inputs).map(function(name){return inputs[name].id})),Object.keys(tensorMap).forEach(function(key){tensorMap[key].forEach(function(tensor){!tensor||tensor.isDisposed||outputIds.has(tensor.id)||inputIds.has(tensor.id)||-1!==_this.weightIds.indexOf(tensor.id)||tensor.dispose()})}),[2,results]}})})},GraphExecutor.prototype.executeWithControlFlow=function(inputs,context,outputNames){return __awaiter(this,void 0,void 0,function(){var names,inputNodes,outputNodes,_a,usedNodes,missingInputs,dynamicNode,syncInputs,stack,tensorsMap,intermediateTensorConsumerCount,tensorsToKeep,added,promises,missingOutputs,alternativeMsg,_this=this;return __generator(this,function(_b){switch(_b.label){case 0:names=Object.keys(inputs),inputNodes=names.map(function(name){return _this.graph.nodes[name]}),outputNodes=outputNames.map(function(name){return _this.graph.nodes[utils_1.parseNodeName(name)[0]]}),_a=model_analysis_1.getExecutionSubgraph(inputs,outputNodes,this.weightMap),usedNodes=_a.usedNodes,missingInputs=_a.missingInputs,dynamicNode=_a.dynamicNode,syncInputs=_a.syncInputs,stack=inputNodes.concat(this.graph.weights).map(function(node){return{node:node,contexts:context.currentContext}}),tensorsMap=__assign({},this.weightMap),Object.keys(inputs).forEach(function(name){tensorsMap[name]=[inputs[name]]}),intermediateTensorConsumerCount={},tensorsToKeep=this.getFrozenTensorIds(tensorsMap),added={},_b.label=1;case 1:return 0<stack.length?(promises=this.processStack(inputNodes,stack,context,tensorsMap,added,tensorsToKeep,outputNames,intermediateTensorConsumerCount,usedNodes),[4,Promise.all(promises)]):[3,3];case 2:return _b.sent(),[3,1];case 3:if(null==dynamicNode&&console.warn("This model execution did not contain any nodes with control flow or dynamic output shapes. You can use model.execute() instead."),0<(missingOutputs=outputNodes.filter(function(node){return!model_analysis_1.isControlFlow(node)&&!utils_1.getTensor(node.name,tensorsMap,context)}).map(function(node){return node.name})).length)throw alternativeMsg="",null!=dynamicNode&&(alternativeMsg="Alternatively, to avoid the dynamic ops, use model.execute() and specify the inputs ["+syncInputs+"]"),new Error("Cannot compute the outputs ["+missingOutputs+"] from the provided inputs ["+names+"]. Consider providing the following inputs: ["+missingInputs+"]. "+alternativeMsg);return[2,tensorsMap]}})})},GraphExecutor.prototype.processStack=function(inputNodes,stack,context,tensorMap,added,tensorsToKeep,outputNames,intermediateTensorConsumerCount,usedNodes){for(var _this=this,promises=[],_loop_1=function(){var item=stack.pop();context.currentContext=item.contexts;var nodeName="";if("Enter"===item.node.op&&utils_1.getParamValue("isConstant",item.node,tensorMap,context)&&(nodeName=utils_1.getNodeNameAndIndex(item.node.name,context)[0]),-1===inputNodes.indexOf(item.node)){var tensors=operation_executor_1.executeOp(item.node,tensorMap,context);nodeName=nodeName||utils_1.getNodeNameAndIndex(item.node.name,context)[0];var currentContext_1=context.currentContext;tensors instanceof Promise?promises.push(tensors.then(function(t){return tensorMap[nodeName]=t,context.currentContext=currentContext_1,_this.checkTensorForDisposal(nodeName,item.node,tensorMap,context,tensorsToKeep,outputNames,intermediateTensorConsumerCount),_this.processChildNodes(item.node,stack,context,tensorMap,added,usedNodes),t})):(tensorMap[nodeName]=tensors,this_1.checkTensorForDisposal(nodeName,item.node,tensorMap,context,tensorsToKeep,outputNames,intermediateTensorConsumerCount),this_1.processChildNodes(item.node,stack,context,tensorMap,added,usedNodes))}else this_1.processChildNodes(item.node,stack,context,tensorMap,added,usedNodes)},this_1=this;0<stack.length;)_loop_1();return promises},GraphExecutor.prototype.processChildNodes=function(node,stack,context,tensorMap,added,usedNodes){node.children.forEach(function(childNode){var nodeName=utils_1.getNodeNameAndIndex(childNode.name,context)[0];!added[nodeName]&&usedNodes.has(childNode.name)&&("Merge"===childNode.op?childNode.inputNames.some(function(name){return!!utils_1.getTensor(name,tensorMap,context)})&&(added[nodeName]=!0,stack.push({contexts:context.currentContext,node:childNode})):childNode.inputNames.every(function(name){return!!utils_1.getTensor(name,tensorMap,context)})&&(added[nodeName]=!0,stack.push({contexts:context.currentContext,node:childNode})))})},GraphExecutor.prototype.dispose=function(){var _this=this;Object.keys(this.weightMap).forEach(function(key){return _this.weightMap[key].forEach(function(tensor){return tensor.dispose()})})},GraphExecutor.prototype.checkInputShapeAndType=function(inputs){var _this=this;Object.keys(inputs).forEach(function(name){var input=inputs[name],node=_this.graph.nodes[name];if(node.attrParams.shape&&node.attrParams.shape.value){var shape_1=node.attrParams.shape.value,match=shape_1.length===input.shape.length&&input.shape.every(function(dim,index){return-1===shape_1[index]||shape_1[index]===dim});tfjs_core_1.util.assert(match,function(){return"The shape of dict['"+node.name+"'] provided in model.execute(dict) must be ["+shape_1+"], but was ["+input.shape+"]"})}node.attrParams.dtype&&node.attrParams.dtype.value&&tfjs_core_1.util.assert(input.dtype===node.attrParams.dtype.value,function(){return"The dtype of dict['"+node.name+"'] provided in model.execute(dict) must be "+node.attrParams.dtype.value+", but was "+input.dtype})})},GraphExecutor.prototype.checkInputs=function(inputs){var _this=this,notInGraph=Object.keys(inputs).filter(function(name){return!_this.graph.nodes[name]});if(0<notInGraph.length)throw new Error("The dict provided in model.execute(dict) has keys: ["+notInGraph+"] that are not part of graph")},GraphExecutor.prototype.checkOutputs=function(outputs){var _this=this;outputs.forEach(function(name){var normalizedName=utils_1.parseNodeName(name)[0];if(!_this.graph.nodes[normalizedName])throw new Error("The output '"+name+"' is not found in the graph")})},GraphExecutor}();exports.GraphExecutor=GraphExecutor},{"../operations/executors/utils":30,"../operations/operation_executor":47,"./execution_context":5,"./model_analysis":8,"./model_rewrite":9,"@tensorflow/tfjs-core":148}],7:[function(require,module,exports){"use strict";var __awaiter=this&&this.__awaiter||function(thisArg,_arguments,P,generator){return new(P=P||Promise)(function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){result.done?resolve(result.value):new P(function(resolve){resolve(result.value)}).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())})},__generator=this&&this.__generator||function(thisArg,body){var f,y,t,g,_={label:0,sent:function(){if(1&t[0])throw t[1];return t[1]},trys:[],ops:[]};return g={next:verb(0),throw:verb(1),return:verb(2)},"function"==typeof Symbol&&(g[Symbol.iterator]=function(){return this}),g;function verb(n){return function(v){return function(op){if(f)throw new TypeError("Generator is already executing.");for(;_;)try{if(f=1,y&&(t=2&op[0]?y.return:op[0]?y.throw||((t=y.return)&&t.call(y),0):y.next)&&!(t=t.call(y,op[1])).done)return t;switch(y=0,t&&(op=[2&op[0],t.value]),op[0]){case 0:case 1:t=op;break;case 4:return _.label++,{value:op[1],done:!1};case 5:_.label++,y=op[1],op=[0];continue;case 7:op=_.ops.pop(),_.trys.pop();continue;default:if(!(t=0<(t=_.trys).length&&t[t.length-1])&&(6===op[0]||2===op[0])){_=0;continue}if(3===op[0]&&(!t||op[1]>t[0]&&op[1]<t[3])){_.label=op[1];break}if(6===op[0]&&_.label<t[1]){_.label=t[1],t=op;break}if(t&&_.label<t[2]){_.label=t[2],_.ops.push(op);break}t[2]&&_.ops.pop(),_.trys.pop();continue}op=body.call(thisArg,_)}catch(e){op=[6,e],y=0}finally{f=t=0}if(5&op[0])throw op[1];return{value:op[0]?op[1]:void 0,done:!0}}([n,v])}}};Object.defineProperty(exports,"__esModule",{value:!0});var tf=require("@tensorflow/tfjs-core"),tfjs_core_1=require("@tensorflow/tfjs-core"),register_1=require("../operations/custom_op/register"),operation_mapper_1=require("../operations/operation_mapper"),graph_executor_1=require("./graph_executor");exports.TFHUB_SEARCH_PARAM="?tfjs-format=file",exports.DEFAULT_MODEL_NAME="model.json";var GraphModel=function(){function GraphModel(modelUrl,loadOptions){void 0===loadOptions&&(loadOptions={}),this.modelUrl=modelUrl,this.loadOptions=loadOptions,this.version="n/a",null==loadOptions&&(this.loadOptions={})}return Object.defineProperty(GraphModel.prototype,"modelVersion",{get:function(){return this.version},enumerable:!0,configurable:!0}),Object.defineProperty(GraphModel.prototype,"inputNodes",{get:function(){return this.executor.inputNodes},enumerable:!0,configurable:!0}),Object.defineProperty(GraphModel.prototype,"outputNodes",{get:function(){return this.executor.outputNodes},enumerable:!0,configurable:!0}),Object.defineProperty(GraphModel.prototype,"inputs",{get:function(){return this.executor.inputs},enumerable:!0,configurable:!0}),Object.defineProperty(GraphModel.prototype,"outputs",{get:function(){return this.executor.outputs},enumerable:!0,configurable:!0}),Object.defineProperty(GraphModel.prototype,"weights",{get:function(){return this.executor.weightMap},enumerable:!0,configurable:!0}),GraphModel.prototype.fusePrelu=function(){this.executor.fusePrelu(),null==register_1.getRegisteredOp("Prelu")&&register_1.registerOp("Prelu",function(node){var x=node.inputs[0],alpha=node.inputs[1];return tf.prelu(x,alpha)})},GraphModel.prototype.findIOHandler=function(){var path=this.modelUrl;if(null!=path.load)this.handler=path;else if(null!=this.loadOptions.requestInit)this.handler=tfjs_core_1.io.browserHTTPRequest(path,this.loadOptions);else{var handlers=tfjs_core_1.io.getLoadHandlers(path,this.loadOptions.onProgress);if(0===handlers.length)handlers.push(tfjs_core_1.io.browserHTTPRequest(path,this.loadOptions));else if(1<handlers.length)throw new Error("Found more than one ("+handlers.length+") load handlers for URL '"+[path]+"'");this.handler=handlers[0]}},GraphModel.prototype.load=function(){return __awaiter(this,void 0,void 0,function(){var artifacts,graph,weightMap;return __generator(this,function(_a){switch(_a.label){case 0:if(this.findIOHandler(),null==this.handler.load)throw new Error("Cannot proceed with model loading because the IOHandler provided does not have the `load` method implemented.");return[4,this.handler.load()];case 1:return artifacts=_a.sent(),graph=artifacts.modelTopology,this.version=graph.versions.producer+"."+graph.versions.minConsumer,weightMap=tfjs_core_1.io.decodeWeights(artifacts.weightData,artifacts.weightSpecs),this.executor=new graph_executor_1.GraphExecutor(operation_mapper_1.OperationMapper.Instance.transformGraph(graph)),this.executor.weightMap=this.convertTensorMapToTensorsMap(weightMap),[2,!0]}})})},GraphModel.prototype.predict=function(inputs,config){return this.execute(inputs,this.outputNodes)},GraphModel.prototype.normalizeInputs=function(inputs){if(!(inputs instanceof tfjs_core_1.Tensor||Array.isArray(inputs)))return inputs;if((inputs=Array.isArray(inputs)?inputs:[inputs]).length!==this.inputNodes.length)throw new Error("Input tensor count mismatch,the graph model has "+this.inputNodes.length+" placeholders, while there are "+inputs.length+" input tensors.");return this.inputNodes.reduce(function(map,inputName,i){return map[inputName]=inputs[i],map},{})},GraphModel.prototype.normalizeOutputs=function(outputs){return outputs=outputs||this.outputNodes,Array.isArray(outputs)?outputs:[outputs]},GraphModel.prototype.execute=function(inputs,outputs){inputs=this.normalizeInputs(inputs),outputs=this.normalizeOutputs(outputs);var result=this.executor.execute(inputs,outputs);return 1<result.length?result:result[0]},GraphModel.prototype.executeAsync=function(inputs,outputs){return __awaiter(this,void 0,void 0,function(){var result;return __generator(this,function(_a){switch(_a.label){case 0:return inputs=this.normalizeInputs(inputs),outputs=this.normalizeOutputs(outputs),[4,this.executor.executeAsync(inputs,outputs)];case 1:return[2,1<(result=_a.sent()).length?result:result[0]]}})})},GraphModel.prototype.convertTensorMapToTensorsMap=function(map){return Object.keys(map).reduce(function(newMap,key){return newMap[key]=[map[key]],newMap},{})},GraphModel.prototype.dispose=function(){this.executor.dispose()},GraphModel}();exports.GraphModel=GraphModel,exports.loadGraphModel=function(modelUrl,options){return void 0===options&&(options={}),__awaiter(this,void 0,void 0,function(){var model;return __generator(this,function(_a){switch(_a.label){case 0:if(null==modelUrl)throw new Error("modelUrl in loadGraphModel() cannot be null. Please provide a url or an IOHandler that loads the model");return null==options&&(options={}),options.fromTFHub&&null==modelUrl.load&&(modelUrl.endsWith("/")||(modelUrl+="/"),modelUrl=""+modelUrl+exports.DEFAULT_MODEL_NAME+exports.TFHUB_SEARCH_PARAM),[4,(model=new GraphModel(modelUrl,options)).load()];case 1:return _a.sent(),[2,model]}})})}},{"../operations/custom_op/register":13,"../operations/operation_mapper":48,"./graph_executor":6,"@tensorflow/tfjs-core":148}],8:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.getExecutionSubgraph=function(inputs,outputs,weightMap){for(var usedNodes=new Set,missingInputs=[],dynamicNode=null,syncInputs=null,seen=new Set,frontier=outputs.slice();0<frontier.length;){var node=frontier.pop();(isControlFlow(node)||isDynamicShape(node))&&null==dynamicNode&&(syncInputs=(dynamicNode=node).children.map(function(child){return child.name}).filter(function(name){return usedNodes.has(name)})),usedNodes.add(node.name),null==weightMap[node.name]&&null==inputs[node.name]&&(0!==node.inputs.length?node.inputs.forEach(function(input){seen.has(input.name)||(seen.add(input.name),frontier.push(input))}):missingInputs.push(node.name))}return{inputs:inputs,outputs:outputs,usedNodes:usedNodes,missingInputs:missingInputs,dynamicNode:dynamicNode,syncInputs:syncInputs}},exports.getNodesInTopologicalOrder=function(graph,weightMap,executionInfo){var usedNodes=executionInfo.usedNodes,inputs=executionInfo.inputs,frontier=[];Object.keys(inputs).map(function(name){return graph.nodes[name]}).forEach(function(input){usedNodes.has(input.name)&&frontier.push(input)}),graph.weights.forEach(function(weight){usedNodes.has(weight.name)&&frontier.push(weight)});for(var seen=new Set,orderedNodes=[];0<frontier.length;){var node=frontier.pop();seen.add(node.name),weightMap[node.name]||orderedNodes.push(node),node.children.forEach(function(child){!seen.has(child.name)&&usedNodes.has(child.name)&&child.inputs.every(function(input){return seen.has(input.name)})&&frontier.push(child)})}return orderedNodes};var CONTROL_FLOW_OPS=["Switch","Merge","Enter","Exit","NextIteration"],DYNAMIC_SHAPE_OPS=["NonMaxSuppressionV2","NonMaxSuppressionV3","Where"];function isControlFlow(node){return 0<=CONTROL_FLOW_OPS.indexOf(node.op)}function isDynamicShape(node){return 0<=DYNAMIC_SHAPE_OPS.indexOf(node.op)}exports.isControlFlow=isControlFlow,exports.isDynamicShape=isDynamicShape},{}],9:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var tfjs_core_1=require("@tensorflow/tfjs-core");exports.rewritePrelu=function(graph,weightMap){function _loop_1(key){var addNode=graph.nodes[key];if(null==addNode||"Add"!==addNode.op&&"AddV2"!==addNode.op||2!==addNode.inputNames.length)return"continue";var reluNode=addNode.inputs.find(function(input){return"Relu"===input.op});if(null==reluNode||1!==reluNode.inputNames.length)return"continue";var mulOp=addNode.inputs.find(function(input){return"Mul"===input.op});if(null==mulOp||2!==mulOp.inputNames.length)return"continue";var negAlphaTensorNode=mulOp.inputs.find(function(input){return"Const"===input.op}),reluNegInputNode=mulOp.inputs.find(function(input){return"Relu"===input.op});if(null==negAlphaTensorNode||null==reluNegInputNode||1!==reluNegInputNode.inputNames.length)return"continue";var negInputNode=reluNegInputNode.inputs[0];if(null==negInputNode||"Neg"!==negInputNode.op||1!==negInputNode.inputNames.length)return"continue";if(reluNode.inputNames[0]!==negInputNode.inputNames[0])return"continue";var inputNode=reluNode.inputs[0],outputNodes=addNode.children,alphaTensorName=negAlphaTensorNode.name+"_neg",negNode={name:alphaTensorName,inputNames:[],inputs:[],attrParams:{},category:"graph",children:[],op:"Const",inputParams:{},rawAttrs:{}};weightMap[alphaTensorName]=[tfjs_core_1.neg(weightMap[negAlphaTensorNode.name][0])],graph.weights.push(negNode);var preluNode={name:addNode.name+"_Prelu",inputNames:[inputNode.name,negNode.name],inputs:[inputNode,negNode],attrParams:{},category:"custom",children:outputNodes,op:"Prelu",inputParams:{x:{inputIndexStart:0,type:"tensor"},alpha:{inputIndexStart:1,type:"tensor"}}};negNode.children.push(preluNode);var mulIndex=negAlphaTensorNode.children.indexOf(mulOp);-1<mulIndex&&negAlphaTensorNode.children.splice(mulIndex,1);var reluIndex=inputNode.children.indexOf(reluNode);-1<reluIndex&&inputNode.children.splice(reluIndex,1);var negIndex=inputNode.children.indexOf(negInputNode);if(-1<negIndex&&inputNode.children.splice(negIndex,1),inputNode.children.push(preluNode),outputNodes.forEach(function(node){var addIndex=node.inputNames.indexOf(addNode.name);-1<addIndex&&(node.inputNames[addIndex]=preluNode.name,node.inputs[addIndex]=preluNode)}),0===outputNodes.length){var addIndex=graph.outputs.indexOf(addNode);-1<addIndex&&graph.outputs.splice(addIndex,1),graph.outputs.push(preluNode)}delete graph.nodes[addNode.name],delete graph.nodes[mulOp.name],delete graph.nodes[reluNode.name],delete graph.nodes[reluNegInputNode.name],delete graph.nodes[negInputNode.name],graph.nodes[preluNode.name]=preluNode,graph.nodes[negNode.name]=negNode}for(var key in graph.nodes)_loop_1(key)}},{"@tensorflow/tfjs-core":148}],10:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var tfjs_core_1=require("@tensorflow/tfjs-core"),TensorArray=function(){function TensorArray(name,dtype,maxSize,elementShape,identicalElementShapes,dynamicSize,clearAfterRead){this.name=name,this.dtype=dtype,this.maxSize=maxSize,this.elementShape=elementShape,this.identicalElementShapes=identicalElementShapes,this.dynamicSize=dynamicSize,this.clearAfterRead=clearAfterRead,this.tensors=[],this.closed_=!1,this.id=TensorArray.nextId++}return Object.defineProperty(TensorArray.prototype,"closed",{get:function(){return this.closed_},enumerable:!0,configurable:!0}),TensorArray.prototype.clearAndClose=function(){this.tensors.forEach(function(tensor){return tensor.tensor.dispose()}),this.tensors=[],this.closed_=!0},TensorArray.prototype.size=function(){return this.tensors.length},TensorArray.prototype.read=function(index){if(this.closed_)throw new Error("TensorArray "+this.name+" has already been closed.");if(index<0||index>=this.tensors.length)throw new Error("Tried to read from index "+index+", but array size is: "+this.tensors.length);var tensorWithState=this.tensors[index];if(tensorWithState.cleared)throw new Error("TensorArray "+this.name+": Could not read index "+index+" twice because it was cleared after a previous read (perhaps try setting clear_after_read = false?).");return this.clearAfterRead&&(tensorWithState.cleared=!0),tensorWithState.read=!0,tensorWithState.tensor},TensorArray.prototype.readMany=function(indices){var _this=this;return indices.map(function(index){return _this.read(index)})},TensorArray.prototype.write=function(index,tensor){if(this.closed_)throw new Error("TensorArray "+this.name+" has already been closed.");if(index<0||!this.dynamicSize&&index>=this.maxSize)throw new Error("Tried to write to index "+index+", but array is not resizeable and size is: "+this.maxSize);var t=this.tensors[index]||{};if(tensor.dtype!==this.dtype)throw new Error("TensorArray "+this.name+": Could not write to TensorArray index "+index+",\n          because the value dtype is "+tensor.dtype+", but TensorArray dtype is "+this.dtype+".");if(0!==this.size()||null!=this.elementShape&&0!==this.elementShape.length||(this.elementShape=tensor.shape),this.assertShapesMatchAllowUndefinedSize(this.elementShape,tensor.shape,"TensorArray "+this.name+": Could not write to TensorArray index "+index+"."),t&&t.read)throw new Error("TensorArray "+this.name+": Could not write to TensorArray index "+index+", because it has already been read.");if(t&&t.written)throw new Error("TensorArray "+this.name+": Could not write to TensorArray index "+index+", because it has already been written.");t.tensor=tensor,t.written=!0,this.tensors[index]=t},TensorArray.prototype.writeMany=function(indices,tensors){var _this=this;if(indices.length!==tensors.length)throw new Error("TensorArray "+this.name+": could not write multiple tensors,because the index size: "+indices.length+" is not the same as tensors size: "+tensors.length+".");indices.forEach(function(i,index){return _this.write(i,tensors[index])})},TensorArray.prototype.gather=function(indices,dtype){if(dtype&&dtype!==this.dtype)throw new Error("TensorArray dtype is "+this.dtype+" but gather requested dtype "+dtype);if(!indices){indices=[];for(var i=0;i<this.size();i++)indices.push(i)}if(0===indices.length)return tfjs_core_1.tensor([],[0].concat(this.elementShape));var tensors=this.readMany(indices);return this.assertShapesMatchAllowUndefinedSize(this.elementShape,tensors[0].shape,"TensorArray shape mismatch: "),tfjs_core_1.stack(tensors,0)},TensorArray.prototype.concat=function(dtype){if(dtype&&dtype!==this.dtype)throw new Error("TensorArray dtype is "+this.dtype+" but concat requested dtype "+dtype);if(0===this.size())return tfjs_core_1.tensor([],[0].concat(this.elementShape));for(var indices=[],i=0;i<this.size();i++)indices.push(i);var tensors=this.readMany(indices);return this.assertShapesMatchAllowUndefinedSize(this.elementShape,tensors[0].shape,"TensorArray shape mismatch: tensor array shape ("+this.elementShape+") vs first tensor shape ("+tensors[0].shape+")"),tfjs_core_1.concat(tensors,0)},TensorArray.prototype.scatter=function(indices,tensor){if(tensor.dtype!==this.dtype)throw new Error("TensorArray dtype is "+this.dtype+" but tensor has dtype "+tensor.dtype);if(indices.length!==tensor.shape[0])throw new Error("Expected len(indices) == tensor.shape[0], but saw: "+indices.length+" vs. "+tensor.shape[0]);var maxIndex=Math.max.apply(Math,indices);if(!this.dynamicSize&&maxIndex>=this.maxSize)throw new Error("Max index must be < array size ("+maxIndex+"  vs. "+this.maxSize+")");this.writeMany(indices,tfjs_core_1.unstack(tensor,0))},TensorArray.prototype.split=function(length,tensor){var _this=this;if(tensor.dtype!==this.dtype)throw new Error("TensorArray dtype is "+this.dtype+" but tensor has dtype "+tensor.dtype);var totalLength=0,cumulativeLengths=length.map(function(len){return totalLength+=len});if(totalLength!==tensor.shape[0])throw new Error("Expected sum of lengths to be equal to\n          tensor.shape[0], but sum of lengths is\n        "+totalLength+", and tensor's shape is: "+tensor.shape);if(!this.dynamicSize&&length.length!==this.maxSize)throw new Error("TensorArray's size is not equal to the size of lengths ("+this.maxSize+" vs. "+length.length+"), and the TensorArray is not marked as dynamically resizeable");var elementPerRow=0===totalLength?0:tensor.size/totalLength,tensors=[];tfjs_core_1.tidy(function(){tensor=tensor.reshape([1,totalLength,elementPerRow]);for(var i=0;i<length.length;++i){var indices_1=[0,0===i?0:cumulativeLengths[i-1],0],sizes=[1,length[i],elementPerRow];tensors[i]=tfjs_core_1.slice(tensor,indices_1,sizes).reshape(_this.elementShape)}return tensors});for(var indices=[],i=0;i<length.length;i++)indices[i]=i;this.writeMany(indices,tensors)},TensorArray.prototype.assertShapesMatchAllowUndefinedSize=function(shapeA,shapeB,errorMessagePrefix){void 0===errorMessagePrefix&&(errorMessagePrefix=""),tfjs_core_1.util.assert(this.shapesEqualAllowUndefinedSize(shapeA,shapeB),function(){return errorMessagePrefix+" Shapes "+shapeA+" and "+shapeB+" must match"})},TensorArray.prototype.shapesEqualAllowUndefinedSize=function(n1,n2){if(n1.length!==n2.length)return!1;for(var i=0;i<n1.length;i++)if(-1!==n1[i]&&-1!==n2[i]&&n1[i]!==n2[i])return!1;return!0},TensorArray.nextId=0,TensorArray}();exports.TensorArray=TensorArray},{"@tensorflow/tfjs-core":148}],11:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var graph_model_1=require("./executor/graph_model");exports.GraphModel=graph_model_1.GraphModel,exports.loadGraphModel=graph_model_1.loadGraphModel;var register_1=require("./operations/custom_op/register");exports.deregisterOp=register_1.deregisterOp,exports.registerOp=register_1.registerOp;var version_1=require("./version");exports.version_converter=version_1.version},{"./executor/graph_model":7,"./operations/custom_op/register":13,"./version":49}],12:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var utils_1=require("../executors/utils"),operation_mapper_1=require("../operation_mapper"),NodeValueImpl=function(){function NodeValueImpl(node,tensorMap,context){var _this=this;this.node=node,this.tensorMap=tensorMap,this.context=context,this.inputs=[],this.attrs={},this.inputs=node.inputNames.map(function(name){return _this.getInput(name)}),null!=node.rawAttrs&&(this.attrs=Object.keys(node.rawAttrs).reduce(function(attrs,key){return attrs[key]=_this.getAttr(key),attrs},{}))}return NodeValueImpl.prototype.getInput=function(name){return utils_1.getTensor(name,this.tensorMap,this.context)},NodeValueImpl.prototype.getAttr=function(name,defaultValue){var value=this.node.rawAttrs[name];if(null!=value.tensor)return utils_1.getTensor(name,this.tensorMap,this.context);if(null!=value.i||null!=value.f)return operation_mapper_1.getNumberParam(this.node.rawAttrs,name,defaultValue);if(null!=value.s)return operation_mapper_1.getStringParam(this.node.rawAttrs,name,defaultValue);if(null!=value.b)return operation_mapper_1.getBoolParam(this.node.rawAttrs,name,defaultValue);if(null!=value.shape)return operation_mapper_1.getTensorShapeParam(this.node.rawAttrs,name,defaultValue);if(null!=value.type)return operation_mapper_1.getDtypeParam(this.node.rawAttrs,name,defaultValue);if(null!=value.list){if(null!=value.list.i||null!=value.list.f)return operation_mapper_1.getNumericArrayParam(this.node.rawAttrs,name,defaultValue);if(null!=value.list.s)return operation_mapper_1.getStringArrayParam(this.node.rawAttrs,name,defaultValue);if(null!=value.list.shape)return operation_mapper_1.getTensorShapeArrayParam(this.node.rawAttrs,name,defaultValue);if(null!=value.list.b)return operation_mapper_1.getBoolArrayParam(this.node.rawAttrs,name,defaultValue);if(null!=value.list.type)return operation_mapper_1.getDtypeArrayParam(this.node.rawAttrs,name,defaultValue)}return defaultValue},NodeValueImpl}();exports.NodeValueImpl=NodeValueImpl},{"../executors/utils":30,"../operation_mapper":48}],13:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var CUSTOM_OPS={};exports.registerOp=function(name,opFunc){var opMapper={tfOpName:name,category:"custom",inputs:[],attrs:[],customExecutor:opFunc};CUSTOM_OPS[name]=opMapper},exports.getRegisteredOp=function(name){return CUSTOM_OPS[name]},exports.deregisterOp=function(name){delete CUSTOM_OPS[name]}},{}],14:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var tfc=require("@tensorflow/tfjs-core"),utils_1=require("./utils");exports.executeOp=function(node,tensorMap,context){switch(node.op){case"BiasAdd":case"AddV2":case"Add":return[tfc.add(utils_1.getParamValue("a",node,tensorMap,context),utils_1.getParamValue("b",node,tensorMap,context))];case"AddN":return[tfc.addN(utils_1.getParamValue("tensors",node,tensorMap,context))];case"FloorMod":case"Mod":return[tfc.mod(utils_1.getParamValue("a",node,tensorMap,context),utils_1.getParamValue("b",node,tensorMap,context))];case"Mul":return[tfc.mul(utils_1.getParamValue("a",node,tensorMap,context),utils_1.getParamValue("b",node,tensorMap,context))];case"RealDiv":case"Div":return[tfc.div(utils_1.getParamValue("a",node,tensorMap,context),utils_1.getParamValue("b",node,tensorMap,context))];case"FloorDiv":return[tfc.floorDiv(utils_1.getParamValue("a",node,tensorMap,context),utils_1.getParamValue("b",node,tensorMap,context))];case"Sub":return[tfc.sub(utils_1.getParamValue("a",node,tensorMap,context),utils_1.getParamValue("b",node,tensorMap,context))];case"Minimum":return[tfc.minimum(utils_1.getParamValue("a",node,tensorMap,context),utils_1.getParamValue("b",node,tensorMap,context))];case"Maximum":return[tfc.maximum(utils_1.getParamValue("a",node,tensorMap,context),utils_1.getParamValue("b",node,tensorMap,context))];case"Pow":return[tfc.pow(utils_1.getParamValue("a",node,tensorMap,context),utils_1.getParamValue("b",node,tensorMap,context))];case"SquaredDifference":return[tfc.squaredDifference(utils_1.getParamValue("a",node,tensorMap,context),utils_1.getParamValue("b",node,tensorMap,context))];default:throw TypeError("Node type "+node.op+" is not implemented")}},exports.CATEGORY="arithmetic"},{"./utils":30,"@tensorflow/tfjs-core":148}],15:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var tfc=require("@tensorflow/tfjs-core"),utils_1=require("./utils");exports.executeOp=function(node,tensorMap,context){switch(node.op){case"Abs":case"ComplexAbs":return[tfc.abs(utils_1.getParamValue("x",node,tensorMap,context))];case"Acos":return[tfc.acos(utils_1.getParamValue("x",node,tensorMap,context))];case"Acosh":return[tfc.acosh(utils_1.getParamValue("x",node,tensorMap,context))];case"Asin":return[tfc.asin(utils_1.getParamValue("x",node,tensorMap,context))];case"Asinh":return[tfc.asinh(utils_1.getParamValue("x",node,tensorMap,context))];case"Atan":return[tfc.atan(utils_1.getParamValue("x",node,tensorMap,context))];case"Atan2":return[tfc.atan2(utils_1.getParamValue("x",node,tensorMap,context),utils_1.getParamValue("y",node,tensorMap,context))];case"Atanh":return[tfc.atanh(utils_1.getParamValue("x",node,tensorMap,context))];case"Ceil":return[tfc.ceil(utils_1.getParamValue("x",node,tensorMap,context))];case"Complex":return[tfc.complex(utils_1.getParamValue("real",node,tensorMap,context),utils_1.getParamValue("imag",node,tensorMap,context))];case"Cos":return[tfc.cos(utils_1.getParamValue("x",node,tensorMap,context))];case"Cosh":return[tfc.cosh(utils_1.getParamValue("x",node,tensorMap,context))];case"Elu":return[tfc.elu(utils_1.getParamValue("x",node,tensorMap,context))];case"Erf":return[tfc.erf(utils_1.getParamValue("x",node,tensorMap,context))];case"Exp":return[tfc.exp(utils_1.getParamValue("x",node,tensorMap,context))];case"Expm1":return[tfc.expm1(utils_1.getParamValue("x",node,tensorMap,context))];case"Floor":return[tfc.floor(utils_1.getParamValue("x",node,tensorMap,context))];case"Log":return[tfc.log(utils_1.getParamValue("x",node,tensorMap,context))];case"Log1p":return[tfc.log1p(utils_1.getParamValue("x",node,tensorMap,context))];case"Imag":return[tfc.imag(utils_1.getParamValue("x",node,tensorMap,context))];case"Neg":return[tfc.neg(utils_1.getParamValue("x",node,tensorMap,context))];case"Reciprocal":return[tfc.reciprocal(utils_1.getParamValue("x",node,tensorMap,context))];case"Real":return[tfc.real(utils_1.getParamValue("x",node,tensorMap,context))];case"Relu":return[tfc.relu(utils_1.getParamValue("x",node,tensorMap,context))];case"Round":return[tfc.round(utils_1.getParamValue("x",node,tensorMap,context))];case"Selu":return[tfc.selu(utils_1.getParamValue("x",node,tensorMap,context))];case"Sigmoid":return[tfc.sigmoid(utils_1.getParamValue("x",node,tensorMap,context))];case"Sin":return[tfc.sin(utils_1.getParamValue("x",node,tensorMap,context))];case"Sign":return[tfc.sign(utils_1.getParamValue("x",node,tensorMap,context))];case"Sinh":return[tfc.sinh(utils_1.getParamValue("x",node,tensorMap,context))];case"Softplus":return[tfc.softplus(utils_1.getParamValue("x",node,tensorMap,context))];case"Sqrt":return[tfc.sqrt(utils_1.getParamValue("x",node,tensorMap,context))];case"Square":return[tfc.square(utils_1.getParamValue("x",node,tensorMap,context))];case"Tanh":return[tfc.tanh(utils_1.getParamValue("x",node,tensorMap,context))];case"Tan":return[tfc.tan(utils_1.getParamValue("x",node,tensorMap,context))];case"Relu6":case"ClipByValue":return[tfc.clipByValue(utils_1.getParamValue("x",node,tensorMap,context),utils_1.getParamValue("clipValueMin",node,tensorMap,context),utils_1.getParamValue("clipValueMax",node,tensorMap,context))];case"Rsqrt":return[tfc.rsqrt(utils_1.getTensor(node.inputNames[0],tensorMap,context))];case"Prod":return[tfc.prod(utils_1.getParamValue("x",node,tensorMap,context),utils_1.getParamValue("axes",node,tensorMap,context))];case"LeakyRelu":return[tfc.leakyRelu(utils_1.getParamValue("x",node,tensorMap,context),utils_1.getParamValue("alpha",node,tensorMap,context))];default:throw TypeError("Node type "+node.op+" is not implemented")}},exports.CATEGORY="basic_math"},{"./utils":30,"@tensorflow/tfjs-core":148}],16:[function(require,module,exports){"use strict";var __awaiter=this&&this.__awaiter||function(thisArg,_arguments,P,generator){return new(P=P||Promise)(function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){result.done?resolve(result.value):new P(function(resolve){resolve(result.value)}).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())})},__generator=this&&this.__generator||function(thisArg,body){var f,y,t,g,_={label:0,sent:function(){if(1&t[0])throw t[1];return t[1]},trys:[],ops:[]};return g={next:verb(0),throw:verb(1),return:verb(2)},"function"==typeof Symbol&&(g[Symbol.iterator]=function(){return this}),g;function verb(n){return function(v){return function(op){if(f)throw new TypeError("Generator is already executing.");for(;_;)try{if(f=1,y&&(t=2&op[0]?y.return:op[0]?y.throw||((t=y.return)&&t.call(y),0):y.next)&&!(t=t.call(y,op[1])).done)return t;switch(y=0,t&&(op=[2&op[0],t.value]),op[0]){case 0:case 1:t=op;break;case 4:return _.label++,{value:op[1],done:!1};case 5:_.label++,y=op[1],op=[0];continue;case 7:op=_.ops.pop(),_.trys.pop();continue;default:if(!(t=0<(t=_.trys).length&&t[t.length-1])&&(6===op[0]||2===op[0])){_=0;continue}if(3===op[0]&&(!t||op[1]>t[0]&&op[1]<t[3])){_.label=op[1];break}if(6===op[0]&&_.label<t[1]){_.label=t[1],t=op;break}if(t&&_.label<t[2]){_.label=t[2],_.ops.push(op);break}t[2]&&_.ops.pop(),_.trys.pop();continue}op=body.call(thisArg,_)}catch(e){op=[6,e],y=0}finally{f=t=0}if(5&op[0])throw op[1];return{value:op[0]?op[1]:void 0,done:!0}}([n,v])}}};Object.defineProperty(exports,"__esModule",{value:!0});var tfjs_core_1=require("@tensorflow/tfjs-core"),tensor_array_1=require("../../executor/tensor_array"),utils_1=require("./utils");exports.executeOp=function(node,tensorMap,context){return __awaiter(this,void 0,void 0,function(){var pred,data_1,inputName,frameId,data,tensor,input,size,dtype,elementShape,dynamicSize,clearAfterRead,identicalElementShapes,name_1,tensorArray,id,index,writeTensor,readId,readIndex,gatherId,gatherIndices,gatherDtype,scatterId,scatterIndices,scatterTensor,concatId,concatTensorArray,concatDtype,splitId,splitTensor,lengths,sizeId,sizeTensorArray,closeId;return __generator(this,function(_b){switch(_b.label){case 0:switch(node.op){case"LoopCond":return[3,1];case"Switch":return[3,2];case"Merge":return[3,4];case"Enter":return[3,5];case"Exit":return[3,6];case"NextIteration":return[3,7];case"TensorArrayV3":return[3,8];case"TensorArrayWriteV3":return[3,9];case"TensorArrayReadV3":return[3,10];case"TensorArrayGatherV3":return[3,11];case"TensorArrayScatterV3":return[3,12];case"TensorArrayConcatV3":return[3,13];case"TensorArraySplitV3":return[3,14];case"TensorArraySizeV3":return[3,15];case"TensorArrayCloseV3":return[3,16]}return[3,17];case 1:return[2,[utils_1.getParamValue("pred",node,tensorMap,context).clone()]];case 2:return pred=utils_1.getParamValue("pred",node,tensorMap,context),data_1=utils_1.getParamValue("data",node,tensorMap,context),[4,pred.data()];case 3:return[2,_b.sent()[0]?[void 0,data_1.clone()]:[data_1.clone(),void 0]];case 4:return[2,(inputName=node.inputNames.find(function(name){return void 0!==utils_1.getTensor(name,tensorMap,context)}))?[utils_1.getTensor(inputName,tensorMap,context).clone()]:void 0];case 5:return frameId=utils_1.getParamValue("frameName",node,tensorMap,context),data=utils_1.getParamValue("tensor",node,tensorMap,context),context.enterFrame(frameId),[2,[data.clone()]];case 6:return tensor=utils_1.getParamValue("tensor",node,tensorMap,context),context.exitFrame(),[2,[tensor.clone()]];case 7:return input=utils_1.getParamValue("tensor",node,tensorMap,context),context.nextIteration(),[2,[input.clone()]];case 8:return size=utils_1.getParamValue("size",node,tensorMap,context),dtype=utils_1.getParamValue("dtype",node,tensorMap,context),elementShape=utils_1.getParamValue("elementShape",node,tensorMap,context),dynamicSize=utils_1.getParamValue("dynamicSize",node,tensorMap,context),clearAfterRead=utils_1.getParamValue("clearAfterRead",node,tensorMap,context),identicalElementShapes=utils_1.getParamValue("identicalElementShapes",node,tensorMap,context),name_1=utils_1.getParamValue("name",node,tensorMap,context),tensorArray=new tensor_array_1.TensorArray(name_1,dtype,size,elementShape,identicalElementShapes,dynamicSize,clearAfterRead),context.addTensorArray(tensorArray),[2,[tfjs_core_1.scalar(tensorArray.id),tfjs_core_1.scalar(1)]];case 9:return id=utils_1.getParamValue("tensorArrayId",node,tensorMap,context),index=utils_1.getParamValue("index",node,tensorMap,context),writeTensor=utils_1.getParamValue("tensor",node,tensorMap,context),context.getTensorArray(id).write(index,writeTensor),[2,[tfjs_core_1.scalar(1)]];case 10:return readId=utils_1.getParamValue("tensorArrayId",node,tensorMap,context),readIndex=utils_1.getParamValue("index",node,tensorMap,context),[2,[context.getTensorArray(readId).read(readIndex)]];case 11:return gatherId=utils_1.getParamValue("tensorArrayId",node,tensorMap,context),gatherIndices=utils_1.getParamValue("indices",node,tensorMap,context),gatherDtype=utils_1.getParamValue("dtype",node,tensorMap,context),[2,[context.getTensorArray(gatherId).gather(gatherIndices,gatherDtype)]];case 12:return scatterId=utils_1.getParamValue("tensorArrayId",node,tensorMap,context),scatterIndices=utils_1.getParamValue("indices",node,tensorMap,context),scatterTensor=utils_1.getParamValue("tensor",node,tensorMap,context),context.getTensorArray(scatterId).scatter(scatterIndices,scatterTensor),[2,[tfjs_core_1.scalar(1)]];case 13:return concatId=utils_1.getParamValue("tensorArrayId",node,tensorMap,context),concatTensorArray=context.getTensorArray(concatId),concatDtype=utils_1.getParamValue("dtype",node,tensorMap,context),[2,[concatTensorArray.concat(concatDtype)]];case 14:return splitId=utils_1.getParamValue("tensorArrayId",node,tensorMap,context),splitTensor=utils_1.getParamValue("tensor",node,tensorMap,context),lengths=utils_1.getParamValue("lengths",node,tensorMap,context),context.getTensorArray(splitId).split(lengths,splitTensor),[2,[tfjs_core_1.scalar(1)]];case 15:return sizeId=utils_1.getParamValue("tensorArrayId",node,tensorMap,context),sizeTensorArray=context.getTensorArray(sizeId),[2,[tfjs_core_1.scalar(sizeTensorArray.size(),"int32")]];case 16:return closeId=utils_1.getParamValue("tensorArrayId",node,tensorMap,context),context.getTensorArray(closeId).clearAndClose(),[2,[]];case 17:throw TypeError("Node type "+node.op+" is not implemented")}})})},exports.CATEGORY="control"},{"../../executor/tensor_array":10,"./utils":30,"@tensorflow/tfjs-core":148}],17:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var tfc=require("@tensorflow/tfjs-core"),utils_1=require("./utils");exports.executeOp=function(node,tensorMap,context){switch(node.op){case"Conv1D":var stride=utils_1.getParamValue("stride",node,tensorMap,context),pad=utils_1.getParamValue("pad",node,tensorMap,context),dataFormat=utils_1.getParamValue("dataFormat",node,tensorMap,context).toUpperCase(),dilation=utils_1.getParamValue("dilation",node,tensorMap,context);return[tfc.conv1d(utils_1.getParamValue("x",node,tensorMap,context),utils_1.getParamValue("filter",node,tensorMap,context),stride,pad,dataFormat,dilation)];case"Conv2D":stride=utils_1.getParamValue("strides",node,tensorMap,context),pad=utils_1.getParamValue("pad",node,tensorMap,context),dataFormat=utils_1.getParamValue("dataFormat",node,tensorMap,context).toUpperCase();var dilations=utils_1.getParamValue("dilations",node,tensorMap,context);return[tfc.conv2d(utils_1.getParamValue("x",node,tensorMap,context),utils_1.getParamValue("filter",node,tensorMap,context),[stride[1],stride[2]],pad,dataFormat,[dilations[1],dilations[2]])];case"Conv2DBackpropInput":case"Conv2dTranspose":var shape=utils_1.getParamValue("outputShape",node,tensorMap,context);stride=utils_1.getParamValue("strides",node,tensorMap,context),pad=utils_1.getParamValue("pad",node,tensorMap,context);return[tfc.conv2dTranspose(utils_1.getParamValue("x",node,tensorMap,context),utils_1.getParamValue("filter",node,tensorMap,context),shape,[stride[1],stride[2]],pad)];case"DepthwiseConv2dNative":case"DepthwiseConv2d":stride=utils_1.getParamValue("strides",node,tensorMap,context),pad=utils_1.getParamValue("pad",node,tensorMap,context),dilations=utils_1.getParamValue("dilations",node,tensorMap,context),dataFormat=utils_1.getParamValue("dataFormat",node,tensorMap,context).toUpperCase();return[tfc.depthwiseConv2d(utils_1.getParamValue("input",node,tensorMap,context),utils_1.getParamValue("filter",node,tensorMap,context),[stride[1],stride[2]],pad,dataFormat,[dilations[1],dilations[2]])];case"Conv3D":stride=utils_1.getParamValue("strides",node,tensorMap,context),pad=utils_1.getParamValue("pad",node,tensorMap,context),dataFormat=utils_1.getParamValue("dataFormat",node,tensorMap,context).toUpperCase(),dilations=utils_1.getParamValue("dilations",node,tensorMap,context);return[tfc.conv3d(utils_1.getParamValue("x",node,tensorMap,context),utils_1.getParamValue("filter",node,tensorMap,context),[stride[1],stride[2],stride[3]],pad,dataFormat,[dilations[1],dilations[2],dilations[3]])];case"AvgPool":stride=utils_1.getParamValue("strides",node,tensorMap,context),pad=utils_1.getParamValue("pad",node,tensorMap,context);var kernelSize=utils_1.getParamValue("kernelSize",node,tensorMap,context);return[tfc.avgPool(utils_1.getParamValue("x",node,tensorMap,context),[kernelSize[1],kernelSize[2]],[stride[1],stride[2]],pad)];case"MaxPool":stride=utils_1.getParamValue("strides",node,tensorMap,context),pad=utils_1.getParamValue("pad",node,tensorMap,context),kernelSize=utils_1.getParamValue("kernelSize",node,tensorMap,context);return[tfc.maxPool(utils_1.getParamValue("x",node,tensorMap,context),[kernelSize[1],kernelSize[2]],[stride[1],stride[2]],pad)];case"AvgPool3D":stride=utils_1.getParamValue("strides",node,tensorMap,context),pad=utils_1.getParamValue("pad",node,tensorMap,context),kernelSize=utils_1.getParamValue("kernelSize",node,tensorMap,context);return[tfc.avgPool3d(utils_1.getParamValue("x",node,tensorMap,context),[kernelSize[1],kernelSize[2],kernelSize[3]],[stride[1],stride[2],stride[3]],pad)];case"MaxPool3D":stride=utils_1.getParamValue("strides",node,tensorMap,context),pad=utils_1.getParamValue("pad",node,tensorMap,context),kernelSize=utils_1.getParamValue("kernelSize",node,tensorMap,context);return[tfc.maxPool3d(utils_1.getParamValue("x",node,tensorMap,context),[kernelSize[1],kernelSize[2],kernelSize[3]],[stride[1],stride[2],stride[3]],pad)];default:throw TypeError("Node type "+node.op+" is not implemented")}},exports.CATEGORY="convolution"},{"./utils":30,"@tensorflow/tfjs-core":148}],18:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var tfc=require("@tensorflow/tfjs-core"),utils_1=require("./utils");exports.executeOp=function(node,tensorMap,context){switch(node.op){case"Fill":var shape=utils_1.getParamValue("shape",node,tensorMap,context),dtype=utils_1.getParamValue("dtype",node,tensorMap,context),value=utils_1.getParamValue("value",node,tensorMap,context);return[tfc.fill(shape,value,dtype)];case"LinSpace":var start=utils_1.getParamValue("start",node,tensorMap,context),stop_1=utils_1.getParamValue("stop",node,tensorMap,context),num=utils_1.getParamValue("num",node,tensorMap,context);return[tfc.linspace(start,stop_1,num)];case"OneHot":var indices=utils_1.getParamValue("indices",node,tensorMap,context),depth=utils_1.getParamValue("depth",node,tensorMap,context),onValue=utils_1.getParamValue("onValue",node,tensorMap,context),offValue=utils_1.getParamValue("offValue",node,tensorMap,context);return[tfc.oneHot(indices,depth,onValue,offValue)];case"Ones":return[tfc.ones(utils_1.getParamValue("shape",node,tensorMap,context),utils_1.getParamValue("dtype",node,tensorMap,context))];case"OnesLike":return[tfc.onesLike(utils_1.getParamValue("x",node,tensorMap,context))];case"RandomUniform":return[tfc.randomUniform(utils_1.getParamValue("shape",node,tensorMap,context),utils_1.getParamValue("minval",node,tensorMap,context),utils_1.getParamValue("maxval",node,tensorMap,context),utils_1.getParamValue("dtype",node,tensorMap,context))];case"Range":start=utils_1.getParamValue("start",node,tensorMap,context);var stop_2=utils_1.getParamValue("stop",node,tensorMap,context),step=utils_1.getParamValue("step",node,tensorMap,context);return[tfc.range(start,stop_2,step,utils_1.getParamValue("dtype",node,tensorMap,context))];case"TruncatedNormal":shape=utils_1.getParamValue("shape",node,tensorMap,context);var mean=utils_1.getParamValue("mean",node,tensorMap,context),stdDev=utils_1.getParamValue("stdDev",node,tensorMap,context),seed=utils_1.getParamValue("seed",node,tensorMap,context);return[tfc.truncatedNormal(shape,mean,stdDev,utils_1.getParamValue("dtype",node,tensorMap,context),seed)];case"Zeros":return[tfc.zeros(utils_1.getParamValue("shape",node,tensorMap,context),utils_1.getParamValue("dtype",node,tensorMap,context))];case"ZerosLike":return[tfc.zerosLike(utils_1.getParamValue("x",node,tensorMap,context))];default:throw TypeError("Node type "+node.op+" is not implemented")}},exports.CATEGORY="creation"},{"./utils":30,"@tensorflow/tfjs-core":148}],19:[function(require,module,exports){"use strict";var __awaiter=this&&this.__awaiter||function(thisArg,_arguments,P,generator){return new(P=P||Promise)(function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){result.done?resolve(result.value):new P(function(resolve){resolve(result.value)}).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())})},__generator=this&&this.__generator||function(thisArg,body){var f,y,t,g,_={label:0,sent:function(){if(1&t[0])throw t[1];return t[1]},trys:[],ops:[]};return g={next:verb(0),throw:verb(1),return:verb(2)},"function"==typeof Symbol&&(g[Symbol.iterator]=function(){return this}),g;function verb(n){return function(v){return function(op){if(f)throw new TypeError("Generator is already executing.");for(;_;)try{if(f=1,y&&(t=2&op[0]?y.return:op[0]?y.throw||((t=y.return)&&t.call(y),0):y.next)&&!(t=t.call(y,op[1])).done)return t;switch(y=0,t&&(op=[2&op[0],t.value]),op[0]){case 0:case 1:t=op;break;case 4:return _.label++,{value:op[1],done:!1};case 5:_.label++,y=op[1],op=[0];continue;case 7:op=_.ops.pop(),_.trys.pop();continue;default:if(!(t=0<(t=_.trys).length&&t[t.length-1])&&(6===op[0]||2===op[0])){_=0;continue}if(3===op[0]&&(!t||op[1]>t[0]&&op[1]<t[3])){_.label=op[1];break}if(6===op[0]&&_.label<t[1]){_.label=t[1],t=op;break}if(t&&_.label<t[2]){_.label=t[2],_.ops.push(op);break}t[2]&&_.ops.pop(),_.trys.pop();continue}op=body.call(thisArg,_)}catch(e){op=[6,e],y=0}finally{f=t=0}if(5&op[0])throw op[1];return{value:op[0]?op[1]:void 0,done:!0}}([n,v])}}};Object.defineProperty(exports,"__esModule",{value:!0});var tfc=require("@tensorflow/tfjs-core"),utils_1=require("./utils");exports.executeOp=function(node,tensorMap,context){return __awaiter(this,void 0,void 0,function(){var boxes,scores,maxOutputSize,iouThreshold,scoreThreshold;return __generator(this,function(_b){switch(_b.label){case 0:switch(node.op){case"NonMaxSuppressionV3":case"NonMaxSuppressionV2":return[3,1];case"Where":return[3,3];case"ListDiff":return[3,5]}return[3,7];case 1:return boxes=utils_1.getParamValue("boxes",node,tensorMap,context),scores=utils_1.getParamValue("scores",node,tensorMap,context),maxOutputSize=utils_1.getParamValue("maxOutputSize",node,tensorMap,context),iouThreshold=utils_1.getParamValue("iouThreshold",node,tensorMap,context),scoreThreshold=utils_1.getParamValue("scoreThreshold",node,tensorMap,context),[4,tfc.image.nonMaxSuppressionAsync(boxes,scores,maxOutputSize,iouThreshold,scoreThreshold)];case 2:return[2,[_b.sent()]];case 3:return[4,tfc.whereAsync(utils_1.getParamValue("condition",node,tensorMap,context))];case 4:return[2,[_b.sent()]];case 5:return[4,tfc.setdiff1dAsync(utils_1.getParamValue("x",node,tensorMap,context),utils_1.getParamValue("y",node,tensorMap,context))];case 6:return[2,_b.sent()];case 7:throw TypeError("Node type "+node.op+" is not implemented")}})})},exports.CATEGORY="dynamic"},{"./utils":30,"@tensorflow/tfjs-core":148}],20:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var tfc=require("@tensorflow/tfjs-core"),utils_1=require("./utils");exports.executeOp=function(node,tensorMap,context){switch(node.op){case"TopKV2":var x=utils_1.getParamValue("x",node,tensorMap,context),k=utils_1.getParamValue("k",node,tensorMap,context),sorted=utils_1.getParamValue("sorted",node,tensorMap,context),result=tfc.topk(x,k,sorted);return[result.values,result.indices];default:throw TypeError("Node type "+node.op+" is not implemented")}},exports.CATEGORY="evaluation"},{"./utils":30,"@tensorflow/tfjs-core":148}],21:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var tfc=require("@tensorflow/tfjs-core"),utils_1=require("./utils");exports.executeOp=function(node,tensorMap,context){switch(node.op){case"Const":return tensorMap[node.name];case"PlaceholderWithDefault":var def=utils_1.getParamValue("default",node,tensorMap,context);return[utils_1.getTensor(node.name,tensorMap,context)||def];case"Placeholder":return[utils_1.getTensor(node.name,tensorMap,context)];case"Identity":case"StopGradient":case"FakeQuantWithMinMaxVars":return[utils_1.getParamValue("x",node,tensorMap,context).clone()];case"IdentityN":return utils_1.getParamValue("x",node,tensorMap,context).map(function(t){return t.clone()});case"Snapshot":return[utils_1.getParamValue("x",node,tensorMap,context).clone()];case"Shape":return[tfc.tensor1d(utils_1.getParamValue("x",node,tensorMap,context).shape,"int32")];case"ShapeN":return utils_1.getParamValue("x",node,tensorMap,context).map(function(t){return tfc.tensor1d(t.shape)});case"Size":return[tfc.scalar(utils_1.getParamValue("x",node,tensorMap,context).size,"int32")];case"Rank":return[tfc.scalar(utils_1.getParamValue("x",node,tensorMap,context).rank,"int32")];case"NoOp":return[];case"Print":var input=utils_1.getParamValue("x",node,tensorMap,context),data=utils_1.getParamValue("data",node,tensorMap,context),message=utils_1.getParamValue("message",node,tensorMap,context),summarize=utils_1.getParamValue("summarize",node,tensorMap,context);console.warn("The graph has a tf.print() operation,usually used for debugging, which slows down performance."),console.log(message);for(var i=0;i<data.length;i++)console.log(Array.prototype.slice.call(data[i].dataSync()).slice(0,summarize));return[input];default:throw TypeError("Node type "+node.op+" is not implemented")}},exports.CATEGORY="graph"},{"./utils":30,"@tensorflow/tfjs-core":148}],22:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var tfc=require("@tensorflow/tfjs-core"),utils_1=require("./utils");exports.executeOp=function(node,tensorMap,context){switch(node.op){case"ResizeBilinear":var images=utils_1.getParamValue("images",node,tensorMap,context),size=utils_1.getParamValue("size",node,tensorMap,context),alignCorners=utils_1.getParamValue("alignCorners",node,tensorMap,context);return[tfc.image.resizeBilinear(images,[size[0],size[1]],alignCorners)];case"ResizeNearestNeighbor":images=utils_1.getParamValue("images",node,tensorMap,context),size=utils_1.getParamValue("size",node,tensorMap,context),alignCorners=utils_1.getParamValue("alignCorners",node,tensorMap,context);return[tfc.image.resizeNearestNeighbor(images,[size[0],size[1]],alignCorners)];case"CropAndResize":var image=utils_1.getParamValue("image",node,tensorMap,context),boxes=utils_1.getParamValue("boxes",node,tensorMap,context),boxInd=utils_1.getParamValue("boxInd",node,tensorMap,context),cropSize=utils_1.getParamValue("cropSize",node,tensorMap,context),method=utils_1.getParamValue("method",node,tensorMap,context),extrapolationValue=utils_1.getParamValue("extrapolationValue",node,tensorMap,context);return[tfc.image.cropAndResize(image,boxes,boxInd,cropSize,method,extrapolationValue)];default:throw TypeError("Node type "+node.op+" is not implemented")}},exports.CATEGORY="image"},{"./utils":30,"@tensorflow/tfjs-core":148}],23:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var tfc=require("@tensorflow/tfjs-core"),utils_1=require("./utils");exports.executeOp=function(node,tensorMap,context){switch(node.op){case"Equal":return[tfc.equal(utils_1.getParamValue("a",node,tensorMap,context),utils_1.getParamValue("b",node,tensorMap,context))];case"NotEqual":return[tfc.notEqual(utils_1.getParamValue("a",node,tensorMap,context),utils_1.getParamValue("b",node,tensorMap,context))];case"Greater":return[tfc.greater(utils_1.getParamValue("a",node,tensorMap,context),utils_1.getParamValue("b",node,tensorMap,context))];case"GreaterEqual":return[tfc.greaterEqual(utils_1.getParamValue("a",node,tensorMap,context),utils_1.getParamValue("b",node,tensorMap,context))];case"Less":return[tfc.less(utils_1.getParamValue("a",node,tensorMap,context),utils_1.getParamValue("b",node,tensorMap,context))];case"LessEqual":return[tfc.lessEqual(utils_1.getParamValue("a",node,tensorMap,context),utils_1.getParamValue("b",node,tensorMap,context))];case"LogicalAnd":return[tfc.logicalAnd(utils_1.getParamValue("a",node,tensorMap,context),utils_1.getParamValue("b",node,tensorMap,context))];case"LogicalNot":return[tfc.logicalNot(utils_1.getParamValue("a",node,tensorMap,context))];case"LogicalOr":return[tfc.logicalOr(utils_1.getParamValue("a",node,tensorMap,context),utils_1.getParamValue("b",node,tensorMap,context))];case"Select":return[tfc.where(utils_1.getParamValue("condition",node,tensorMap,context),utils_1.getParamValue("a",node,tensorMap,context),utils_1.getParamValue("b",node,tensorMap,context))];default:throw TypeError("Node type "+node.op+" is not implemented")}},exports.CATEGORY="logical"},{"./utils":30,"@tensorflow/tfjs-core":148}],24:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var tfc=require("@tensorflow/tfjs-core"),utils_1=require("./utils");exports.executeOp=function(node,tensorMap,context){switch(node.op){case"BatchMatMul":case"BatchMatMulV2":case"MatMul":return[tfc.matMul(utils_1.getParamValue("a",node,tensorMap,context),utils_1.getParamValue("b",node,tensorMap,context),utils_1.getParamValue("transposeA",node,tensorMap,context),utils_1.getParamValue("transposeB",node,tensorMap,context))];case"Transpose":return[tfc.transpose(utils_1.getParamValue("x",node,tensorMap,context),utils_1.getParamValue("perm",node,tensorMap,context))];default:throw TypeError("Node type "+node.op+" is not implemented")}},exports.CATEGORY="matrices"},{"./utils":30,"@tensorflow/tfjs-core":148}],25:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var tfc=require("@tensorflow/tfjs-core"),utils_1=require("./utils");exports.executeOp=function(node,tensorMap,context){switch(node.op){case"FusedBatchNorm":case"FusedBatchNormV2":case"FusedBatchNormV3":return[tfc.batchNorm(utils_1.getParamValue("x",node,tensorMap,context),utils_1.getParamValue("mean",node,tensorMap,context),utils_1.getParamValue("variance",node,tensorMap,context),utils_1.getParamValue("offset",node,tensorMap,context),utils_1.getParamValue("scale",node,tensorMap,context),utils_1.getParamValue("epsilon",node,tensorMap,context))];case"LRN":return[tfc.localResponseNormalization(utils_1.getParamValue("x",node,tensorMap,context),utils_1.getParamValue("radius",node,tensorMap,context),utils_1.getParamValue("bias",node,tensorMap,context),utils_1.getParamValue("alpha",node,tensorMap,context),utils_1.getParamValue("beta",node,tensorMap,context))];case"Softmax":return[tfc.softmax(utils_1.getParamValue("x",node,tensorMap,context))];case"LogSoftmax":return[tfc.logSoftmax(utils_1.getParamValue("x",node,tensorMap,context))];case"SparseToDense":return[tfc.sparseToDense(utils_1.getParamValue("sparseIndices",node,tensorMap,context),utils_1.getParamValue("outputShape",node,tensorMap,context),utils_1.getParamValue("sparseValues",node,tensorMap,context),utils_1.getParamValue("defaultValue",node,tensorMap,context))];default:throw TypeError("Node type "+node.op+" is not implemented")}},exports.CATEGORY="normalization"},{"./utils":30,"@tensorflow/tfjs-core":148}],26:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var tfc=require("@tensorflow/tfjs-core"),utils_1=require("./utils");exports.executeOp=function(node,tensorMap,context){switch(node.op){case"Max":var axis=utils_1.getParamValue("axis",node,tensorMap,context),keepDims=utils_1.getParamValue("keepDims",node,tensorMap,context);return[tfc.max(utils_1.getParamValue("x",node,tensorMap,context),axis,keepDims)];case"Mean":axis=utils_1.getParamValue("axis",node,tensorMap,context),keepDims=utils_1.getParamValue("keepDims",node,tensorMap,context);return[tfc.mean(utils_1.getParamValue("x",node,tensorMap,context),axis,keepDims)];case"Min":axis=utils_1.getParamValue("axis",node,tensorMap,context),keepDims=utils_1.getParamValue("keepDims",node,tensorMap,context);return[tfc.min(utils_1.getParamValue("x",node,tensorMap,context),axis,keepDims)];case"Sum":axis=utils_1.getParamValue("axis",node,tensorMap,context),keepDims=utils_1.getParamValue("keepDims",node,tensorMap,context);return[tfc.sum(utils_1.getParamValue("x",node,tensorMap,context),axis,keepDims)];case"All":axis=utils_1.getParamValue("axis",node,tensorMap,context),keepDims=utils_1.getParamValue("keepDims",node,tensorMap,context);return[tfc.all(utils_1.getParamValue("x",node,tensorMap,context),axis,keepDims)];case"Any":axis=utils_1.getParamValue("axis",node,tensorMap,context),keepDims=utils_1.getParamValue("keepDims",node,tensorMap,context);return[tfc.any(utils_1.getParamValue("x",node,tensorMap,context),axis,keepDims)];case"ArgMax":axis=utils_1.getParamValue("axis",node,tensorMap,context);return[tfc.argMax(utils_1.getParamValue("x",node,tensorMap,context),axis)];case"ArgMin":axis=utils_1.getParamValue("axis",node,tensorMap,context);return[tfc.argMin(utils_1.getParamValue("x",node,tensorMap,context),axis)];case"Prod":axis=utils_1.getParamValue("axis",node,tensorMap,context),keepDims=utils_1.getParamValue("keepDims",node,tensorMap,context);return[tfc.prod(utils_1.getParamValue("x",node,tensorMap,context),axis,keepDims)];default:throw TypeError("Node type "+node.op+" is not implemented")}},exports.CATEGORY="reduction"},{"./utils":30,"@tensorflow/tfjs-core":148}],27:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var tfc=require("@tensorflow/tfjs-core"),utils_1=require("./utils");exports.executeOp=function(node,tensorMap,context){switch(node.op){case"ConcatV2":case"Concat":var axis=utils_1.getParamValue("axis",node,tensorMap,context),inputs=utils_1.getParamValue("tensors",node,tensorMap,context);return[tfc.concat(inputs,axis)];case"GatherV2":case"Gather":axis=utils_1.getParamValue("axis",node,tensorMap,context);var input=utils_1.getParamValue("x",node,tensorMap,context),indices=utils_1.getParamValue("indices",node,tensorMap,context);return[tfc.gather(input,indices.asType("int32"),axis)];case"ReverseV2":case"Reverse":axis=utils_1.getParamValue("axis",node,tensorMap,context),input=utils_1.getParamValue("x",node,tensorMap,context);return[tfc.reverse(input,axis)];case"Slice":var begin=utils_1.getParamValue("begin",node,tensorMap,context),size=utils_1.getParamValue("size",node,tensorMap,context);return[tfc.slice(utils_1.getParamValue("x",node,tensorMap,context),begin,size)];case"StridedSlice":begin=utils_1.getParamValue("begin",node,tensorMap,context);var end=utils_1.getParamValue("end",node,tensorMap,context),strides=utils_1.getParamValue("strides",node,tensorMap,context),beginMask=utils_1.getParamValue("beginMask",node,tensorMap,context),endMask=utils_1.getParamValue("endMask",node,tensorMap,context),ellipsisMask=utils_1.getParamValue("ellipsisMask",node,tensorMap,context),newAxisMask=utils_1.getParamValue("newAxisMask",node,tensorMap,context),shrinkAxisMask=utils_1.getParamValue("shrinkAxisMask",node,tensorMap,context),tensor=utils_1.getParamValue("x",node,tensorMap,context);if(1===begin.length&&1<tensor.shape.length)for(var i=1;i<tensor.shape.length;i++)begin.push(0),end.push(tensor.shape[i]),strides.push(strides[0]);return[tfc.stridedSlice(tensor,begin,end,strides,beginMask,endMask,ellipsisMask,newAxisMask,shrinkAxisMask)];case"Pack":return tfc.tidy(function(){var axis=utils_1.getParamValue("axis",node,tensorMap,context),tensors=utils_1.getParamValue("tensors",node,tensorMap,context),shape=tensors[0].shape,squeezedShape=tensors[0].squeeze().shape,mapped=tensors.map(function(tensor){var sameShape=tfc.util.arraysEqual(tensor.shape,shape);if(!sameShape&&!tfc.util.arraysEqual(tensor.squeeze().shape,squeezedShape))throw new Error("the input tensors shape does not match");return sameShape?tensor:tensor.reshape(shape)});return[tfc.stack(mapped,axis)]});case"Unpack":return tfc.tidy(function(){var axis=utils_1.getParamValue("axis",node,tensorMap,context),tensor=utils_1.getParamValue("tensor",node,tensorMap,context);return tfc.unstack(tensor,axis)});case"Tile":var reps=utils_1.getParamValue("reps",node,tensorMap,context);return[tfc.tile(utils_1.getParamValue("x",node,tensorMap,context),reps)];case"Split":case"SplitV":axis=utils_1.getParamValue("axis",node,tensorMap,context);var numOrSizeSplits=utils_1.getParamValue("numOrSizeSplits",node,tensorMap,context);return tfc.split(utils_1.getParamValue("x",node,tensorMap,context),numOrSizeSplits,axis);case"ScatterNd":indices=utils_1.getParamValue("indices",node,tensorMap,context);var values=utils_1.getParamValue("values",node,tensorMap,context),shape=utils_1.getParamValue("shape",node,tensorMap,context);return[tfc.scatterND(indices,values,shape)];case"GatherNd":var x=utils_1.getParamValue("x",node,tensorMap,context);indices=utils_1.getParamValue("indices",node,tensorMap,context);return[tfc.gatherND(x,indices)];case"SparseToDense":indices=utils_1.getParamValue("sparseIndices",node,tensorMap,context),shape=utils_1.getParamValue("outputShape",node,tensorMap,context);var sparseValues=utils_1.getParamValue("sparseValues",node,tensorMap,context),defaultValue=utils_1.getParamValue("defaultValue",node,tensorMap,context);return[tfc.sparseToDense(indices,sparseValues,shape,sparseValues.dtype===defaultValue.dtype?defaultValue:defaultValue.asType(sparseValues.dtype))];default:throw TypeError("Node type "+node.op+" is not implemented")}},exports.CATEGORY="slice_join"},{"./utils":30,"@tensorflow/tfjs-core":148}],28:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var tfc=require("@tensorflow/tfjs-core"),utils_1=require("./utils");exports.executeOp=function(node,tensorMap,context){switch(node.op){case"FFT":return[tfc.fft(utils_1.getParamValue("x",node,tensorMap,context))];case"IFFT":return[tfc.ifft(utils_1.getParamValue("x",node,tensorMap,context))];case"RFFT":return[tfc.rfft(utils_1.getParamValue("x",node,tensorMap,context))];case"IRFFT":return[tfc.irfft(utils_1.getParamValue("x",node,tensorMap,context))];default:throw TypeError("Node type "+node.op+" is not implemented")}},exports.CATEGORY="spectral"},{"./utils":30,"@tensorflow/tfjs-core":148}],29:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var tfc=require("@tensorflow/tfjs-core"),utils_1=require("./utils");exports.executeOp=function(node,tensorMap,context){switch(node.op){case"Cast":return[tfc.cast(utils_1.getParamValue("x",node,tensorMap,context),utils_1.getParamValue("dtype",node,tensorMap,context))];case"ExpandDims":var axis=utils_1.getParamValue("axis",node,tensorMap,context);return[tfc.expandDims(utils_1.getParamValue("x",node,tensorMap,context),axis)];case"Squeeze":axis=utils_1.getParamValue("axis",node,tensorMap,context);return[tfc.squeeze(utils_1.getParamValue("x",node,tensorMap,context),axis)];case"Reshape":return[tfc.reshape(utils_1.getParamValue("x",node,tensorMap,context),utils_1.getParamValue("shape",node,tensorMap,context))];case"PadV2":case"Pad":return[tfc.pad(utils_1.getParamValue("x",node,tensorMap,context),utils_1.split(utils_1.getParamValue("padding",node,tensorMap,context),2),utils_1.getParamValue("constantValue",node,tensorMap,context))];case"SpaceToBatchND":var blockShape=utils_1.getParamValue("blockShape",node,tensorMap,context),paddings=utils_1.split(utils_1.getParamValue("paddings",node,tensorMap,context),2);return[tfc.spaceToBatchND(utils_1.getParamValue("x",node,tensorMap,context),blockShape,paddings)];case"BatchToSpaceND":blockShape=utils_1.getParamValue("blockShape",node,tensorMap,context);var crops=utils_1.split(utils_1.getParamValue("crops",node,tensorMap,context),2);return[tfc.batchToSpaceND(utils_1.getParamValue("x",node,tensorMap,context),blockShape,crops)];case"DepthToSpace":var blockSize=utils_1.getParamValue("blockSize",node,tensorMap,context),dataFormat=utils_1.getParamValue("dataFormat",node,tensorMap,context).toUpperCase();return[tfc.depthToSpace(utils_1.getParamValue("x",node,tensorMap,context),blockSize,dataFormat)];default:throw TypeError("Node type "+node.op+" is not implemented")}},exports.CATEGORY="transformation"},{"./utils":30,"@tensorflow/tfjs-core":148}],30:[function(require,module,exports){"use strict";function getTensor(name,tensorsMap,context){var _a=parseNodeName(name),nodeName=_a[0],index=_a[1],contextId=context.currentContextIds.find(function(contextId){return!!tensorsMap[getNodeNameWithContextId(nodeName,contextId)]});return void 0!==contextId?tensorsMap[getNodeNameWithContextId(nodeName,contextId)][index]:void 0}function getNodeNameWithContextId(name,contextId){return contextId?name+"-"+contextId:name}function parseNodeName(name){var index=name.lastIndexOf(":");return-1===index?[name,0]:[name.substring(0,index),Number(name.substring(index+1))]}Object.defineProperty(exports,"__esModule",{value:!0}),exports.getParamValue=function(paramName,node,tensorMap,context){var inputParam=node.inputParams[paramName];if(inputParam&&void 0!==inputParam.inputIndexStart){var start=inputParam.inputIndexStart,end=0===inputParam.inputIndexEnd?void 0:void 0===inputParam.inputIndexEnd?start+1:inputParam.inputIndexEnd;if("tensor"===inputParam.type)return getTensor(node.inputNames[inputParam.inputIndexStart],tensorMap,context);if("tensors"===inputParam.type)return node.inputNames.slice(start,end).map(function(name){return getTensor(name,tensorMap,context)});var data=Array.prototype.slice.call(getTensor(node.inputNames.slice(start)[0],tensorMap,context).dataSync());return"number"===inputParam.type?data[0]:data}var attrParam=node.attrParams[paramName];return attrParam&&attrParam.value},exports.getTensor=getTensor,exports.getTensorsForCurrentContenxt=function(name,tensorsMap,context){return tensorsMap[getNodeNameWithContextId(name,context.currentContextId)]},exports.getNodeNameAndIndex=function(inputName,context){var _a=parseNodeName(inputName),nodeName=_a[0],index=_a[1];return[getNodeNameWithContextId(nodeName,context&&context.currentContextId),index]},exports.parseNodeName=parseNodeName,exports.split=function(arr,size){for(var res=[],i=0;i<arr.length;i+=size)res.push(arr.slice(i,i+size));return res}},{}],31:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.json=[{tfOpName:"Add",category:"arithmetic",inputs:[{start:0,name:"a",type:"tensor"},{start:1,name:"b",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"AddV2",category:"arithmetic",inputs:[{start:0,name:"a",type:"tensor"},{start:1,name:"b",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"AddN",category:"arithmetic",inputs:[{start:0,end:0,name:"tensors",type:"tensors"}]},{tfOpName:"BiasAdd",category:"arithmetic",inputs:[{start:0,name:"a",type:"tensor"},{start:1,name:"b",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"Sub",category:"arithmetic",inputs:[{start:0,name:"a",type:"tensor"},{start:1,name:"b",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"RealDiv",category:"arithmetic",inputs:[{start:0,name:"a",type:"tensor"},{start:1,name:"b",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"Div",category:"arithmetic",inputs:[{start:0,name:"a",type:"tensor"},{start:1,name:"b",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"FloorDiv",category:"arithmetic",inputs:[{start:0,name:"a",type:"tensor"},{start:1,name:"b",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"Mul",category:"arithmetic",inputs:[{start:0,name:"a",type:"tensor"},{start:1,name:"b",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"Maximum",category:"arithmetic",inputs:[{start:0,name:"a",type:"tensor"},{start:1,name:"b",type:"tensor"}]},{tfOpName:"Minimum",category:"arithmetic",inputs:[{start:0,name:"a",type:"tensor"},{start:1,name:"b",type:"tensor"}]},{tfOpName:"Pow",category:"arithmetic",inputs:[{start:0,name:"a",type:"tensor"},{start:1,name:"b",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"SquaredDifference",category:"arithmetic",inputs:[{start:0,name:"a",type:"tensor"},{start:1,name:"b",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"Mod",category:"arithmetic",inputs:[{start:0,name:"a",type:"tensor"},{start:1,name:"b",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"FloorMod",category:"arithmetic",inputs:[{start:0,name:"a",type:"tensor"},{start:1,name:"b",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]}]},{}],32:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.json=[{tfOpName:"Abs",category:"basic_math",inputs:[{start:0,name:"x",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"Acos",category:"basic_math",inputs:[{start:0,name:"x",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"Asin",category:"basic_math",inputs:[{start:0,name:"x",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"Atan",category:"basic_math",inputs:[{start:0,name:"x",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"Atan2",category:"basic_math",inputs:[{start:0,name:"x",type:"tensor"},{start:1,name:"y",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"Ceil",category:"basic_math",inputs:[{start:0,name:"x",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"ClipByValue",category:"basic_math",inputs:[{start:0,name:"x",type:"tensor"}],attrs:[{tfName:"clip_value_min",name:"clipValueMin",type:"number"},{tfName:"clip_value_max",name:"clipValueMax",type:"number"}]},{tfOpName:"Complex",category:"basic_math",inputs:[{start:0,name:"real",type:"tensor"},{start:1,name:"imag",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"ComplexAbs",category:"basic_math",inputs:[{start:0,name:"x",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"Cos",category:"basic_math",inputs:[{start:0,name:"x",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"Cosh",category:"basic_math",inputs:[{start:0,name:"x",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"Elu",category:"basic_math",inputs:[{start:0,name:"x",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"Exp",category:"basic_math",inputs:[{start:0,name:"x",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"Floor",category:"basic_math",inputs:[{start:0,name:"x",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"Log",category:"basic_math",inputs:[{start:0,name:"x",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"Imag",category:"basic_math",inputs:[{start:0,name:"x",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0},{tfName:"Tout",name:"outputType",type:"dtype",notSupported:!0}]},{tfOpName:"Neg",category:"basic_math",inputs:[{start:0,name:"x",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"Real",category:"basic_math",inputs:[{start:0,name:"x",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0},{tfName:"Tout",name:"outputType",type:"dtype",notSupported:!0}]},{tfOpName:"Relu",category:"basic_math",inputs:[{start:0,name:"x",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"Relu6",category:"basic_math",inputs:[{start:0,name:"x",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0},{tfName:"clipValueMin",name:"clipValueMin",type:"number",defaultValue:0},{tfName:"clipValueMax",name:"clipValueMax",type:"number",defaultValue:6}]},{tfOpName:"Selu",category:"basic_math",inputs:[{start:0,name:"x",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"Sigmoid",category:"basic_math",inputs:[{start:0,name:"x",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"Sin",category:"basic_math",inputs:[{start:0,name:"x",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"Sinh",category:"basic_math",inputs:[{start:0,name:"x",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"Sqrt",category:"basic_math",inputs:[{start:0,name:"x",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"Rsqrt",category:"basic_math",inputs:[{start:0,name:"x",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"Square",category:"basic_math",inputs:[{start:0,name:"x",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"Tan",category:"basic_math",inputs:[{start:0,name:"x",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"Tanh",category:"basic_math",inputs:[{start:0,name:"x",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"Sign",category:"basic_math",inputs:[{start:0,name:"x",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"Round",category:"basic_math",inputs:[{start:0,name:"x",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"Expm1",category:"basic_math",inputs:[{start:0,name:"x",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"Log1p",category:"basic_math",inputs:[{start:0,name:"x",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"Reciprocal",category:"basic_math",inputs:[{start:0,name:"x",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"Softplus",category:"basic_math",inputs:[{start:0,name:"x",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"Asinh",category:"basic_math",inputs:[{start:0,name:"x",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"Acosh",category:"basic_math",inputs:[{start:0,name:"x",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"Atanh",category:"basic_math",inputs:[{start:0,name:"x",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"Erf",category:"basic_math",inputs:[{start:0,name:"x",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"Prod",category:"basic_math",inputs:[{start:0,name:"x",type:"tensor"},{start:1,name:"axes",type:"number[]"}],attrs:[{tfName:"keep_dims",name:"keepDims",type:"bool",notSupported:!0},{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"LeakyRelu",category:"basic_math",inputs:[{start:0,name:"x",type:"tensor"}],attrs:[{tfName:"alpha",name:"alpha",type:"number",defaultValue:.2},{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]}]},{}],33:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.json=[{tfOpName:"LoopCond",category:"control",inputs:[{start:0,name:"pred",type:"tensor"}]},{tfOpName:"Switch",category:"control",inputs:[{start:0,name:"data",type:"tensor"},{start:1,name:"pred",type:"tensor"}]},{tfOpName:"Merge",category:"control",inputs:[{start:0,end:0,name:"tensors",type:"tensors"}]},{tfOpName:"Enter",category:"control",inputs:[{start:0,name:"tensor",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0},{tfName:"frame_name",name:"frameName",type:"string"},{tfName:"is_constant",name:"isConstant",type:"bool"}]},{tfOpName:"Exit",category:"control",inputs:[{start:0,name:"tensor",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"NextIteration",category:"control",inputs:[{start:0,name:"tensor",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"TensorArrayV3",category:"control",inputs:[{start:0,name:"size",type:"number"}],attrs:[{tfName:"dtype",name:"dtype",type:"dtype"},{tfName:"element_shape",name:"elementShape",type:"shape"},{tfName:"dynamic_size",name:"dynamicSize",type:"bool"},{tfName:"clear_after_read",name:"clearAfterRead",type:"bool"},{tfName:"identical_element_shapes",name:"identicalElementShapes",type:"bool"},{tfName:"tensor_array_name",name:"name",type:"string"}]},{tfOpName:"TensorArrayWriteV3",category:"control",inputs:[{start:0,name:"tensorArrayId",type:"number"},{start:1,name:"index",type:"number"},{start:2,name:"tensor",type:"tensor"},{start:3,name:"flowIn",type:"number"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"TensorArrayReadV3",category:"control",inputs:[{start:0,name:"tensorArrayId",type:"number"},{start:1,name:"index",type:"number"},{start:2,name:"flowIn",type:"number"}],attrs:[{tfName:"dtype",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"TensorArrayGatherV3",category:"control",inputs:[{start:0,name:"tensorArrayId",type:"number"},{start:1,name:"indices",type:"number[]"},{start:2,name:"flowIn",type:"number"}],attrs:[{tfName:"dtype",name:"dtype",type:"dtype"},{tfName:"element_shape",name:"elementShape",type:"shape"}]},{tfOpName:"TensorArrayScatterV3",category:"control",inputs:[{start:0,name:"tensorArrayId",type:"number"},{start:1,name:"indices",type:"number[]"},{start:2,name:"tensor",type:"tensor"},{start:3,name:"flowIn",type:"number"}],attrs:[{tfName:"T",name:"dtype",type:"dtype"}]},{tfOpName:"TensorArrayConcatV3",category:"control",inputs:[{start:0,name:"tensorArrayId",type:"number"},{start:1,name:"flowIn",type:"number"}],attrs:[{tfName:"dtype",name:"dtype",type:"dtype"},{tfName:"element_shape_except0",name:"elementShapeExcept0",type:"shape",notSupported:!0}]},{tfOpName:"TensorArraySplitV3",category:"control",inputs:[{start:0,name:"tensorArrayId",type:"number"},{start:1,name:"tensor",type:"tensor"},{start:2,name:"lengths",type:"number[]"},{start:3,name:"flowIn",type:"number"}],attrs:[{tfName:"T",name:"dtype",type:"dtype"}]},{tfOpName:"TensorArraySizeV3",category:"control",inputs:[{start:0,name:"tensorArrayId",type:"number"},{start:1,name:"flowIn",type:"number"}]},{tfOpName:"TensorArrayCloseV3",category:"control",inputs:[{start:0,name:"tensorArrayId",type:"number"}]}]},{}],34:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.json=[{tfOpName:"AvgPool",category:"convolution",inputs:[{start:0,name:"x",type:"tensor"}],attrs:[{tfName:"strides",name:"strides",type:"number[]"},{tfName:"padding",name:"pad",type:"string"},{tfName:"data_format",name:"dataFormat",type:"string",notSupported:!0},{tfName:"ksize",name:"kernelSize",type:"number[]"},{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"MaxPool",category:"convolution",inputs:[{start:0,name:"x",type:"tensor"}],attrs:[{tfName:"strides",name:"strides",type:"number[]"},{tfName:"padding",name:"pad",type:"string"},{tfName:"data_format",name:"dataFormat",type:"string",notSupported:!0},{tfName:"ksize",name:"kernelSize",type:"number[]"},{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"AvgPool3D",category:"convolution",inputs:[{start:0,name:"x",type:"tensor"}],attrs:[{tfName:"strides",name:"strides",type:"number[]"},{tfName:"padding",name:"pad",type:"string"},{tfName:"data_format",name:"dataFormat",type:"string",notSupported:!0},{tfName:"ksize",name:"kernelSize",type:"number[]"},{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"MaxPool3D",category:"convolution",inputs:[{start:0,name:"x",type:"tensor"}],attrs:[{tfName:"strides",name:"strides",type:"number[]"},{tfName:"padding",name:"pad",type:"string"},{tfName:"data_format",name:"dataFormat",type:"string",notSupported:!0},{tfName:"ksize",name:"kernelSize",type:"number[]"},{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"Conv1D",category:"convolution",inputs:[{start:0,name:"x",type:"tensor"},{start:1,name:"filter",type:"tensor"}],attrs:[{tfName:"stride",name:"stride",type:"number"},{tfName:"padding",name:"pad",type:"string"},{tfName:"data_format",name:"dataFormat",type:"string",defaultValue:"NWC"},{tfName:"T",name:"dtype",type:"dtype",notSupported:!0},{tfName:"dilation",name:"dilation",type:"number",defaultValue:1}]},{tfOpName:"Conv2D",category:"convolution",inputs:[{start:0,name:"x",type:"tensor"},{start:1,name:"filter",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0},{tfName:"strides",name:"strides",type:"number[]"},{tfName:"padding",name:"pad",type:"string"},{tfName:"useCudnnOnGpu",name:"useCudnnOnGpu",type:"bool"},{tfName:"data_format",name:"dataFormat",type:"string",defaultValue:"NHWC"},{tfName:"dilations",name:"dilations",type:"number[]"}]},{tfOpName:"Conv2DBackpropInput",category:"convolution",inputs:[{start:2,name:"x",type:"tensor"},{start:1,name:"filter",type:"tensor"},{start:0,name:"outputShape",type:"number[]"}],attrs:[{tfName:"strides",name:"strides",type:"number[]"},{tfName:"padding",name:"pad",type:"string"},{tfName:"data_format",name:"dataFormat",type:"string",notSupported:!0}]},{tfOpName:"DepthwiseConv2d",category:"convolution",inputs:[{start:0,name:"input",type:"tensor"},{start:1,name:"filter",type:"tensor"}],attrs:[{tfName:"strides",name:"strides",type:"number[]"},{tfName:"padding",name:"pad",type:"string"},{tfName:"data_format",name:"dataFormat",type:"string",defaultValue:"NHWC"},{tfName:"dilations",name:"dilations",type:"number[]"}]},{tfOpName:"DepthwiseConv2dNative",category:"convolution",inputs:[{start:0,name:"input",type:"tensor"},{start:1,name:"filter",type:"tensor"}],attrs:[{tfName:"strides",name:"strides",type:"number[]"},{tfName:"padding",name:"pad",type:"string"},{tfName:"data_format",name:"dataFormat",type:"string",defaultValue:"NHWC"},{tfName:"dilations",name:"dilations",type:"number[]"}]},{tfOpName:"Conv3D",category:"convolution",inputs:[{start:0,name:"x",type:"tensor"},{start:1,name:"filter",type:"tensor"}],attrs:[{tfName:"strides",name:"strides",type:"number[]"},{tfName:"padding",name:"pad",type:"string"},{tfName:"data_format",name:"dataFormat",type:"string",defaultValue:"NHWC"},{tfName:"dilations",name:"dilations",type:"number[]"}]}]},{}],35:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.json=[{tfOpName:"Fill",category:"creation",inputs:[{start:0,name:"shape",type:"number[]"},{start:1,name:"value",type:"number"}],attrs:[{tfName:"T",name:"dtype",type:"dtype"}]},{tfOpName:"LinSpace",category:"creation",inputs:[{start:0,name:"start",type:"number"},{start:1,name:"stop",type:"number"},{start:2,name:"num",type:"number"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"OneHot",category:"creation",inputs:[{start:0,name:"indices",type:"tensor"},{start:1,name:"depth",type:"number"},{start:2,name:"onValue",type:"number",defaultValue:1},{start:3,name:"offValue",type:"number",defaultValue:0}],attrs:[{tfName:"axis",name:"axis",type:"number",notSupported:!0},{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"Ones",category:"creation",inputs:[{start:0,name:"shape",type:"number[]"}],attrs:[{tfName:"T",name:"dtype",type:"dtype"}]},{tfOpName:"OnesLike",category:"creation",inputs:[{start:0,name:"x",type:"tensor"}],attrs:[{tfName:"dtype",name:"dtype",type:"dtype"}]},{tfOpName:"RandomUniform",category:"creation",inputs:[{start:0,name:"shape",type:"number[]"}],attrs:[{tfName:"minval",name:"minval",type:"number",defaultValue:0},{tfName:"maxval",name:"maxval",type:"number",defaultValue:1},{tfName:"dtype",name:"dtype",type:"dtype"},{tfName:"seed",name:"seed",type:"number",defaultValue:0},{tfName:"seed2",name:"seed2",type:"number",defaultValue:0,notSupported:!0},{tfName:"T",name:"T",type:"number",notSupported:!0}]},{tfOpName:"Range",category:"creation",inputs:[{start:0,name:"start",type:"number"},{start:1,name:"stop",type:"number"},{start:2,name:"step",type:"number",defaultValue:0}],attrs:[{tfName:"Tidx",name:"dtype",type:"dtype"}]},{tfOpName:"TruncatedNormal",category:"creation",inputs:[{start:0,name:"shape",type:"number[]"}],attrs:[{tfName:"means",name:"mean",type:"number",defaultValue:0},{tfName:"stddev",name:"stdDev",type:"number",defaultValue:1},{tfName:"seed",name:"seed",type:"number"},{tfName:"seed2",name:"seed2",type:"number",defaultValue:0,notSupported:!0},{tfName:"dtype",name:"dtype",type:"dtype"},{tfName:"T",name:"T",type:"number",notSupported:!0}]},{tfOpName:"Zeros",category:"creation",inputs:[{start:0,name:"shape",type:"number[]"}],attrs:[{tfName:"T",name:"dtype",type:"dtype"}]},{tfOpName:"ZerosLike",category:"creation",inputs:[{start:0,name:"x",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype"}]}]},{}],36:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.json=[{tfOpName:"NonMaxSuppressionV2",category:"dynamic",inputs:[{start:0,name:"boxes",type:"tensor"},{start:1,name:"scores",type:"tensor"},{start:2,name:"maxOutputSize",type:"number"},{start:3,name:"iouThreshold",type:"number"}]},{tfOpName:"NonMaxSuppressionV3",category:"dynamic",inputs:[{start:0,name:"boxes",type:"tensor"},{start:1,name:"scores",type:"tensor"},{start:2,name:"maxOutputSize",type:"number"},{start:3,name:"iouThreshold",type:"number"},{start:4,name:"scoreThreshold",type:"number"}]},{tfOpName:"Where",category:"dynamic",inputs:[{start:0,name:"condition",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"ListDiff",category:"dynamic",inputs:[{start:0,name:"x",type:"tensor"},{start:1,name:"y",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]}]},{}],37:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.json=[{tfOpName:"TopKV2",category:"evaluation",inputs:[{start:0,name:"x",type:"tensor"},{start:1,name:"k",type:"number"}],attrs:[{tfName:"sorted",name:"sorted",type:"bool"}]}]},{}],38:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.json=[{tfOpName:"PlaceholderWithDefault",category:"graph",inputs:[{start:0,name:"default",type:"tensor"}],attrs:[{tfName:"shape",name:"shape",type:"shape"},{tfName:"dtype",name:"dtype",type:"dtype"}]},{tfOpName:"Placeholder",category:"graph",attrs:[{tfName:"shape",name:"shape",type:"shape"},{tfName:"dtype",name:"dtype",type:"dtype"}]},{tfOpName:"Const",category:"graph"},{tfOpName:"Identity",category:"graph",inputs:[{start:0,name:"x",type:"tensor"}]},{tfOpName:"IdentityN",category:"graph",inputs:[{start:0,end:0,name:"x",type:"tensors"}]},{tfOpName:"Snapshot",category:"graph",inputs:[{start:0,name:"x",type:"tensor"}]},{tfOpName:"Rank",category:"graph",inputs:[{start:0,name:"x",type:"tensor"}]},{tfOpName:"Size",category:"graph",inputs:[{start:0,name:"x",type:"tensor"}]},{tfOpName:"Shape",category:"graph",inputs:[{start:0,name:"x",type:"tensor"}]},{tfOpName:"ShapeN",category:"graph",inputs:[{start:0,end:0,name:"x",type:"tensors"}]},{tfOpName:"Print",category:"graph",inputs:[{start:0,name:"x",type:"tensor"},{start:1,name:"data",type:"tensors"}],attrs:[{tfName:"message",name:"message",type:"string"},{tfName:"first_n",name:"firstN",type:"number",notSupported:!0},{tfName:"summarize",name:"summarize",type:"number",defaultValue:3}]},{tfOpName:"NoOp",category:"graph",inputs:[]},{tfOpName:"StopGradient",category:"graph",inputs:[{start:0,name:"x",type:"tensor"}]},{tfOpName:"FakeQuantWithMinMaxVars",category:"graph",inputs:[{start:0,name:"x",type:"tensor"}],attrs:[{tfName:"min",name:"min",type:"number"},{tfName:"max",name:"max",type:"number"}]}]},{}],39:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.json=[{tfOpName:"ResizeBilinear",category:"image",inputs:[{start:0,name:"images",type:"tensor"},{start:1,name:"size",type:"number[]"}],attrs:[{tfName:"align_corners",name:"alignCorners",type:"bool"},{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"ResizeNearestNeighbor",category:"image",inputs:[{start:0,name:"images",type:"tensor"},{start:1,name:"size",type:"number[]"}],attrs:[{tfName:"align_corners",name:"alignCorners",type:"bool"},{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"CropAndResize",category:"image",inputs:[{start:0,name:"image",type:"tensor"},{start:1,name:"boxes",type:"tensor"},{start:2,name:"boxInd",type:"tensor"},{start:3,name:"cropSize",type:"number[]"}],attrs:[{tfName:"method",name:"method",type:"string"},{tfName:"extrapolation_value",name:"extrapolationValue",type:"number"}]}]},{}],40:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.json=[{tfOpName:"Equal",category:"logical",inputs:[{start:0,name:"a",type:"tensor"},{start:1,name:"b",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"NotEqual",category:"logical",inputs:[{start:0,name:"a",type:"tensor"},{start:1,name:"b",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"Greater",category:"logical",inputs:[{start:0,name:"a",type:"tensor"},{start:1,name:"b",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"GreaterEqual",category:"logical",inputs:[{start:0,name:"a",type:"tensor"},{start:1,name:"b",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"Less",category:"logical",inputs:[{start:0,name:"a",type:"tensor"},{start:1,name:"b",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"LessEqual",category:"logical",inputs:[{start:0,name:"a",type:"tensor"},{start:1,name:"b",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"LogicalAnd",category:"logical",inputs:[{start:0,name:"a",type:"tensor"},{start:1,name:"b",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"LogicalNot",category:"logical",inputs:[{start:0,name:"a",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"LogicalOr",category:"logical",inputs:[{start:0,name:"a",type:"tensor"},{start:1,name:"b",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"Select",category:"logical",inputs:[{start:0,name:"condition",type:"tensor"},{start:1,name:"a",type:"tensor"},{start:2,name:"b",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]}]},{}],41:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.json=[{tfOpName:"MatMul",category:"matrices",inputs:[{start:0,name:"a",type:"tensor"},{start:1,name:"b",type:"tensor"}],attrs:[{tfName:"transpose_a",name:"transposeA",type:"bool",defaultValue:!1},{tfName:"transpose_b",name:"transposeB",type:"bool",defaultValue:!1},{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"BatchMatMul",category:"matrices",inputs:[{start:0,name:"a",type:"tensor"},{start:1,name:"b",type:"tensor"}],attrs:[{tfName:"adj_x",name:"transposeA",type:"bool",defaultValue:!1},{tfName:"adj_y",name:"transposeB",type:"bool",defaultValue:!1},{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"BatchMatMulV2",category:"matrices",inputs:[{start:0,name:"a",type:"tensor"},{start:1,name:"b",type:"tensor"}],attrs:[{tfName:"adj_x",name:"transposeA",type:"bool",defaultValue:!1},{tfName:"adj_y",name:"transposeB",type:"bool",defaultValue:!1},{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"Transpose",category:"matrices",inputs:[{start:0,name:"x",type:"tensor"},{start:1,name:"perm",type:"number[]"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]}]},{}],42:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.json=[{tfOpName:"FusedBatchNorm",category:"normalization",inputs:[{start:0,name:"x",type:"tensor"},{start:1,name:"scale",type:"tensor"},{start:2,name:"offset",type:"tensor"},{start:3,name:"mean",type:"tensor"},{start:4,name:"variance",type:"tensor"}],attrs:[{tfName:"epsilon",name:"epsilon",type:"number",defaultValue:.001},{tfName:"data_format",name:"dataFormat",type:"string",notSupported:!0}]},{tfOpName:"FusedBatchNormV2",category:"normalization",inputs:[{start:0,name:"x",type:"tensor"},{start:1,name:"scale",type:"tensor"},{start:2,name:"offset",type:"tensor"},{start:3,name:"mean",type:"tensor"},{start:4,name:"variance",type:"tensor"}],attrs:[{tfName:"epsilon",name:"epsilon",type:"number",defaultValue:.001},{tfName:"data_format",name:"dataFormat",type:"string",notSupported:!0}]},{tfOpName:"FusedBatchNormV3",category:"normalization",inputs:[{start:0,name:"x",type:"tensor"},{start:1,name:"scale",type:"tensor"},{start:2,name:"offset",type:"tensor"},{start:3,name:"mean",type:"tensor"},{start:4,name:"variance",type:"tensor"}],attrs:[{tfName:"epsilon",name:"epsilon",type:"number",defaultValue:.001},{tfName:"data_format",name:"dataFormat",type:"string",notSupported:!0}]},{tfOpName:"LRN",category:"normalization",inputs:[{start:0,name:"x",type:"tensor"}],attrs:[{tfName:"depth_radius",name:"radius",type:"number",defaultValue:5},{tfName:"bias",name:"bias",type:"number",defaultValue:1},{tfName:"alpha",name:"alpha",type:"number",defaultValue:1},{tfName:"beta",name:"beta",type:"number",defaultValue:.5}]},{tfOpName:"Softmax",category:"normalization",inputs:[{start:0,name:"x",type:"tensor"}]},{tfOpName:"LogSoftmax",category:"normalization",inputs:[{start:0,name:"x",type:"tensor"}]},{tfOpName:"SparseToDense",category:"normalization",inputs:[{start:0,name:"sparseIndices",type:"tensor"},{start:1,name:"outputShape",type:"number[]"},{start:2,name:"sparseValues",type:"tensor"},{start:3,name:"defaultValue",type:"tensor"}],attrs:[{tfName:"validate_indices",name:"validateIndices",type:"bool",defaultValue:!0,notSupported:!0}]}]},{}],43:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.json=[{tfOpName:"Max",category:"reduction",inputs:[{start:0,name:"x",type:"tensor"},{start:1,name:"axis",type:"number[]"}],attrs:[{tfName:"keep_dims",name:"keepDims",type:"bool"}]},{tfOpName:"Mean",category:"reduction",inputs:[{start:0,name:"x",type:"tensor"},{start:1,name:"axis",type:"number[]"}],attrs:[{tfName:"keep_dims",name:"keepDims",type:"bool"}]},{tfOpName:"Min",category:"reduction",inputs:[{start:0,name:"x",type:"tensor"},{start:1,name:"axis",type:"number[]"}],attrs:[{tfName:"keep_dims",name:"keepDims",type:"bool"}]},{tfOpName:"Sum",category:"reduction",inputs:[{start:0,name:"x",type:"tensor"},{start:1,name:"axis",type:"number[]"}],attrs:[{tfName:"keep_dims",name:"keepDims",type:"bool"}]},{tfOpName:"All",category:"reduction",inputs:[{start:0,name:"x",type:"tensor"},{start:1,name:"axis",type:"number[]"}],attrs:[{tfName:"keep_dims",name:"keepDims",type:"bool"}]},{tfOpName:"Any",category:"reduction",inputs:[{start:0,name:"x",type:"tensor"},{start:1,name:"axis",type:"number[]"}],attrs:[{tfName:"keep_dims",name:"keepDims",type:"bool"}]},{tfOpName:"ArgMax",category:"reduction",inputs:[{start:0,name:"x",type:"tensor"},{start:1,name:"axis",type:"number"}]},{tfOpName:"ArgMin",category:"reduction",inputs:[{start:0,name:"x",type:"tensor"},{start:1,name:"axis",type:"number"}]},{tfOpName:"Prod",category:"reduction",inputs:[{start:0,name:"x",type:"tensor"},{start:1,name:"axis",type:"number[]"}],attrs:[{tfName:"keep_dims",name:"keepDims",type:"bool"}]}]},{}],44:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.json=[{tfOpName:"ConcatV2",category:"slice_join",inputs:[{start:0,end:-1,name:"tensors",type:"tensors"},{start:-1,name:"axis",type:"number"}]},{tfOpName:"Concat",category:"slice_join",inputs:[{start:1,end:0,name:"tensors",type:"tensors"},{start:0,name:"axis",type:"number"}]},{tfOpName:"GatherV2",category:"slice_join",inputs:[{start:0,name:"x",type:"tensor"},{start:1,name:"indices",type:"tensor"},{start:2,name:"axis",type:"number",defaultValue:0}]},{tfOpName:"Gather",category:"slice_join",inputs:[{start:0,name:"x",type:"tensor"},{start:1,name:"indices",type:"tensor"}],attrs:[{tfName:"axis",name:"axis",type:"number",defaultValue:0},{tfName:"validate_indices",name:"validateIndices",type:"bool",notSupported:!0}]},{tfOpName:"Reverse",category:"slice_join",inputs:[{start:0,name:"x",type:"tensor"},{start:1,name:"dims",type:"bool",notSupported:!0}]},{tfOpName:"ReverseV2",category:"slice_join",inputs:[{start:0,name:"x",type:"tensor"},{start:1,name:"axis",type:"number[]"}]},{tfOpName:"Slice",category:"slice_join",inputs:[{start:0,name:"x",type:"tensor"},{start:1,name:"begin",type:"number[]"},{start:2,name:"size",type:"number[]"}]},{tfOpName:"StridedSlice",category:"slice_join",inputs:[{start:0,name:"x",type:"tensor"},{start:1,name:"begin",type:"number[]"},{start:2,name:"end",type:"number[]"},{start:3,name:"strides",type:"number[]"}],attrs:[{tfName:"begin_mask",name:"beginMask",type:"number",defaultValue:0},{tfName:"end_mask",name:"endMask",type:"number",defaultValue:0},{tfName:"new_axis_mask",name:"newAxisMask",type:"number",defaultValue:0},{tfName:"ellipsis_mask",name:"ellipsisMask",type:"number",defaultValue:0},{tfName:"shrink_axis_mask",name:"shrinkAxisMask",type:"number",defaultValue:0}]},{tfOpName:"Pack",category:"slice_join",inputs:[{start:0,end:0,name:"tensors",type:"tensors"}],attrs:[{tfName:"axis",name:"axis",type:"number",defaultValue:0}]},{tfOpName:"Unpack",category:"slice_join",inputs:[{start:0,name:"tensor",type:"tensor"}],attrs:[{tfName:"axis",name:"axis",type:"number",defaultValue:0},{tfName:"num",name:"num",type:"number",defaultValue:0,notSupported:!0}]},{tfOpName:"Tile",category:"slice_join",inputs:[{start:0,name:"x",type:"tensor"},{start:1,name:"reps",type:"number[]"}]},{tfOpName:"Split",category:"slice_join",inputs:[{start:0,name:"axis",type:"number",defaultValue:0},{start:1,name:"x",type:"tensor"}],attrs:[{tfName:"num_split",name:"numOrSizeSplits",type:"number",defaultValue:1}]},{tfOpName:"SplitV",category:"slice_join",inputs:[{start:0,name:"x",type:"tensor"},{start:1,name:"numOrSizeSplits",type:"number[]"},{start:2,name:"axis",type:"number",defaultValue:0}]},{tfOpName:"ScatterNd",category:"slice_join",inputs:[{start:0,name:"indices",type:"tensor"},{start:1,name:"values",type:"tensor"},{start:2,name:"shape",type:"number[]"}]},{tfOpName:"GatherNd",category:"slice_join",inputs:[{start:0,name:"x",type:"tensor"},{start:1,name:"indices",type:"tensor"}]},{tfOpName:"SparseToDense",category:"slice_join",inputs:[{start:0,name:"sparseIndices",type:"tensor"},{start:1,name:"outputShape",type:"number[]"},{start:2,name:"sparseValues",type:"tensor"},{start:3,name:"defaultValue",type:"tensor"}],attrs:[{tfName:"validate_indices",name:"validateIndices",type:"bool",defaultValue:!1,notSupported:!0}]}]},{}],45:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.json=[{tfOpName:"FFT",category:"spectral",inputs:[{start:0,name:"x",type:"tensor"}]},{tfOpName:"IFFT",category:"spectral",inputs:[{start:0,name:"x",type:"tensor"}]},{tfOpName:"RFFT",category:"spectral",inputs:[{start:0,name:"x",type:"tensor"},{start:1,name:"fft_length",type:"number",notSupported:!0}]},{tfOpName:"IRFFT",category:"spectral",inputs:[{start:0,name:"x",type:"tensor"},{start:1,name:"fft_length",type:"number",notSupported:!0}]}]},{}],46:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.json=[{tfOpName:"Cast",category:"transformation",inputs:[{start:0,name:"x",type:"tensor"}],attrs:[{tfName:"SrcT",name:"sdtype",type:"dtype",notSupported:!0},{tfName:"DstT",name:"dtype",type:"dtype"}]},{tfOpName:"ExpandDims",category:"transformation",inputs:[{start:0,name:"x",type:"tensor"},{start:1,name:"axis",type:"number"}]},{tfOpName:"Pad",category:"transformation",inputs:[{start:0,name:"x",type:"tensor"},{start:1,name:"padding",type:"number[]"}],attrs:[{tfName:"constant_value",name:"constantValue",type:"number",defaultValue:0}]},{tfOpName:"PadV2",category:"transformation",inputs:[{start:0,name:"x",type:"tensor"},{start:1,name:"padding",type:"number[]"},{start:2,name:"constantValue",type:"number",defaultValue:0}]},{tfOpName:"Reshape",category:"transformation",inputs:[{start:0,name:"x",type:"tensor"},{start:1,name:"shape",type:"number[]"}]},{tfOpName:"Squeeze",category:"transformation",inputs:[{start:0,name:"x",type:"tensor"}],attrs:[{tfName:"axis",tfDeprecatedName:"squeeze_dims",name:"axis",type:"number[]"}]},{tfOpName:"SpaceToBatchND",category:"transformation",inputs:[{start:0,name:"x",type:"tensor"},{start:1,name:"blockShape",type:"number[]"},{start:2,name:"paddings",type:"number[]"}]},{tfOpName:"BatchToSpaceND",category:"transformation",inputs:[{start:0,name:"x",type:"tensor"},{start:1,name:"blockShape",type:"number[]"},{start:2,name:"crops",type:"number[]"}]},{tfOpName:"DepthToSpace",category:"transformation",inputs:[{start:0,name:"x",type:"tensor"}],attrs:[{tfName:"block_size",name:"blockSize",type:"number"},{tfName:"data_format",name:"dataFormat",type:"string"}]}]},{}],47:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var node_value_impl_1=require("./custom_op/node_value_impl"),register_1=require("./custom_op/register"),arithmetic=require("./executors/arithmetic_executor"),basicMath=require("./executors/basic_math_executor"),control=require("./executors/control_executor"),convolution=require("./executors/convolution_executor"),creation=require("./executors/creation_executor"),dynamic=require("./executors/dynamic_executor"),evaluation=require("./executors/evaluation_executor"),graph=require("./executors/graph_executor"),image=require("./executors/image_executor"),logical=require("./executors/logical_executor"),matrices=require("./executors/matrices_executor"),normalization=require("./executors/normalization_executor"),reduction=require("./executors/reduction_executor"),sliceJoin=require("./executors/slice_join_executor"),spectral=require("./executors/spectral_executor"),transformation=require("./executors/transformation_executor");exports.executeOp=function(node,tensorMap,context){var value=function(node,tensorMap,context){switch(node.category){case"arithmetic":return arithmetic.executeOp(node,tensorMap,context);case"basic_math":return basicMath.executeOp(node,tensorMap,context);case"control":return control.executeOp(node,tensorMap,context);case"convolution":return convolution.executeOp(node,tensorMap,context);case"creation":return creation.executeOp(node,tensorMap,context);case"dynamic":return dynamic.executeOp(node,tensorMap,context);case"evaluation":return evaluation.executeOp(node,tensorMap,context);case"image":return image.executeOp(node,tensorMap,context);case"graph":return graph.executeOp(node,tensorMap,context);case"logical":return logical.executeOp(node,tensorMap,context);case"matrices":return matrices.executeOp(node,tensorMap,context);case"normalization":return normalization.executeOp(node,tensorMap,context);case"reduction":return reduction.executeOp(node,tensorMap,context);case"slice_join":return sliceJoin.executeOp(node,tensorMap,context);case"spectral":return spectral.executeOp(node,tensorMap,context);case"transformation":return transformation.executeOp(node,tensorMap,context);case"custom":var opMapper=register_1.getRegisteredOp(node.op);if(opMapper&&opMapper.customExecutor)return opMapper.customExecutor(new node_value_impl_1.NodeValueImpl(node,tensorMap,context));throw TypeError("Custom op "+node.op+" is not registered.");default:throw TypeError("Unknown op '"+node.op+"'. File an issue at https://github.com/tensorflow/tfjs/issues so we can add it, or register a custom execution with tf.registerOp()")}}(node,tensorMap,context);return value instanceof Promise?value.then(function(data){return[].concat(data)}):[].concat(value)}},{"./custom_op/node_value_impl":12,"./custom_op/register":13,"./executors/arithmetic_executor":14,"./executors/basic_math_executor":15,"./executors/control_executor":16,"./executors/convolution_executor":17,"./executors/creation_executor":18,"./executors/dynamic_executor":19,"./executors/evaluation_executor":20,"./executors/graph_executor":21,"./executors/image_executor":22,"./executors/logical_executor":23,"./executors/matrices_executor":24,"./executors/normalization_executor":25,"./executors/reduction_executor":26,"./executors/slice_join_executor":27,"./executors/spectral_executor":28,"./executors/transformation_executor":29}],48:[function(require,module,exports){(function(Buffer){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var tfjs_core_1=require("@tensorflow/tfjs-core"),tensorflow=require("../data/compiled_api"),register_1=require("./custom_op/register"),utils_1=require("./executors/utils"),arithmetic=require("./op_list/arithmetic"),basicMath=require("./op_list/basic_math"),control=require("./op_list/control"),convolution=require("./op_list/convolution"),creation=require("./op_list/creation"),dynamic=require("./op_list/dynamic"),evaluation=require("./op_list/evaluation"),graph=require("./op_list/graph"),image=require("./op_list/image"),logical=require("./op_list/logical"),matrices=require("./op_list/matrices"),normalization=require("./op_list/normalization"),reduction=require("./op_list/reduction"),sliceJoin=require("./op_list/slice_join"),spectral=require("./op_list/spectral"),transformation=require("./op_list/transformation"),OperationMapper=function(){function OperationMapper(){var ops=[arithmetic,basicMath,control,convolution,creation,dynamic,evaluation,logical,image,graph,matrices,normalization,reduction,sliceJoin,spectral,transformation],mappersJson=[].concat.apply([],ops.map(function(op){return op.json}));this.opMappers=mappersJson.reduce(function(map,mapper){return map[mapper.tfOpName]=mapper,map},{})}return Object.defineProperty(OperationMapper,"Instance",{get:function(){return this._instance||(this._instance=new this)},enumerable:!0,configurable:!0}),OperationMapper.prototype.transformGraph=function(graph){var _this=this,tfNodes=graph.node,placeholders=[],weights=[],nodes=tfNodes.reduce(function(map,node){return map[node.name]=_this.mapNode(node),"Placeholder"===node.op&&placeholders.push(map[node.name]),"Const"===node.op&&weights.push(map[node.name]),map},{}),inputs=[],outputs=[],allNodes=Object.keys(nodes);return allNodes.forEach(function(key){var node=nodes[key];node.inputNames.forEach(function(name){var nodeName=utils_1.getNodeNameAndIndex(name)[0];node.inputs.push(nodes[nodeName]),nodes[nodeName].children.push(node)}),0===node.inputs.length&&inputs.push(node)}),allNodes.forEach(function(key){var node=nodes[key];0===node.children.length&&outputs.push(node)}),{nodes:nodes,inputs:inputs,outputs:outputs,weights:weights,placeholders:placeholders}},OperationMapper.prototype.mapNode=function(node){var mapper=register_1.getRegisteredOp(node.op)||this.opMappers[node.op]||{};null==node.attr&&(node.attr={});var newNode={name:node.name,op:node.op,category:mapper.category,inputNames:(node.input||[]).map(function(input){return input.startsWith("^")?input.substr(1):input}),inputs:[],children:[],inputParams:{},attrParams:{},rawAttrs:node.attr};return null!=mapper.inputs&&(newNode.inputParams=mapper.inputs.reduce(function(map,param){return map[param.name]={type:param.type,inputIndexStart:param.start,inputIndexEnd:param.end},map},{})),null!=mapper.attrs&&(newNode.attrParams=mapper.attrs.reduce(function(map,param){var type=param.type,value=void 0;switch(param.type){case"string":void 0===(value=getStringParam(node.attr,param.tfName,param.defaultValue))&&param.tfDeprecatedName&&(value=getStringParam(node.attr,param.tfDeprecatedName,param.defaultValue));break;case"string[]":void 0===(value=getStringArrayParam(node.attr,param.tfName,param.defaultValue))&&param.tfDeprecatedName&&(value=getStringArrayParam(node.attr,param.tfDeprecatedName,param.defaultValue));break;case"number":void 0===(value=getNumberParam(node.attr,param.tfName,param.defaultValue||0))&&param.tfDeprecatedName&&(value=getNumberParam(node.attr,param.tfDeprecatedName,param.defaultValue));break;case"number[]":void 0===(value=getNumericArrayParam(node.attr,param.tfName,param.defaultValue))&&param.tfDeprecatedName&&(value=getNumericArrayParam(node.attr,param.tfDeprecatedName,param.defaultValue));break;case"bool":void 0===(value=getBoolParam(node.attr,param.tfName,param.defaultValue))&&param.tfDeprecatedName&&(value=getBoolParam(node.attr,param.tfDeprecatedName,param.defaultValue));break;case"bool[]":void 0===(value=getBoolArrayParam(node.attr,param.tfName,param.defaultValue))&&param.tfDeprecatedName&&(value=getBoolArrayParam(node.attr,param.tfDeprecatedName,param.defaultValue));break;case"shape":void 0===(value=getTensorShapeParam(node.attr,param.tfName,param.defaultValue))&&param.tfDeprecatedName&&(value=getTensorShapeParam(node.attr,param.tfDeprecatedName,param.defaultValue));break;case"shape[]":void 0===(value=getTensorShapeArrayParam(node.attr,param.tfName,param.defaultValue))&&param.tfDeprecatedName&&(value=getTensorShapeArrayParam(node.attr,param.tfDeprecatedName,param.defaultValue));break;case"dtype":void 0===(value=getDtypeParam(node.attr,param.tfName,param.defaultValue))&&param.tfDeprecatedName&&(value=getDtypeParam(node.attr,param.tfDeprecatedName,param.defaultValue));break;case"dtype[]":void 0===(value=getDtypeArrayParam(node.attr,param.tfName,param.defaultValue))&&param.tfDeprecatedName&&(value=getDtypeArrayParam(node.attr,param.tfDeprecatedName,param.defaultValue));break;case"tensor":case"tensors":break;default:throw new Error("Unsupported param type: "+param.type+" for op: "+node.op)}return map[param.name]={value:value,type:type},map},{})),newNode},OperationMapper}();function decodeBase64(text){var global=tfjs_core_1.ENV.global;if(void 0!==global.atob)return global.atob(text);if(void 0!==Buffer)return new Buffer(text,"base64").toString();throw new Error("Unable to decode base64 in this environment. Missing built-in atob() or Buffer()")}function parseStringParam(s,keepCase){var value=Array.isArray(s)?String.fromCharCode.apply(null,s):decodeBase64(s);return keepCase?value:value.toLowerCase()}function getStringParam(attrs,name,def,keepCase){void 0===keepCase&&(keepCase=!1);var param=attrs[name];return null!=param?parseStringParam(param.s,keepCase):def}function getBoolParam(attrs,name,def){var param=attrs[name];return param?param.b:def}function getNumberParam(attrs,name,def){var param=attrs[name]||{},value=null!=param.i?param.i:null!=param.f?param.f:def;return"number"==typeof value?value:parseInt(value,10)}function parseDtypeParam(value){switch("string"==typeof value&&(value=tensorflow.DataType[value]),value){case tensorflow.DataType.DT_FLOAT:return"float32";case tensorflow.DataType.DT_INT32:return"int32";case tensorflow.DataType.DT_BOOL:return"bool";case tensorflow.DataType.DT_DOUBLE:return"float32";case tensorflow.DataType.DT_STRING:return"string";default:return null}}function getDtypeParam(attrs,name,def){var param=attrs[name];return param&&param.type?parseDtypeParam(param.type):def}function getDtypeArrayParam(attrs,name,def){var param=attrs[name];return param&&param.list&&param.list.type?param.list.type.map(function(v){return parseDtypeParam(v)}):def}function parseTensorShapeParam(shape){if(!shape.unknownRank)return null!=shape.dim?shape.dim.map(function(dim){return"number"==typeof dim.size?dim.size:parseInt(dim.size,10)}):[]}function getTensorShapeParam(attrs,name,def){var param=attrs[name];return param&&param.shape?parseTensorShapeParam(param.shape):def}function getNumericArrayParam(attrs,name,def){var param=attrs[name];return param?((param.list.f&&param.list.f.length?param.list.f:param.list.i)||[]).map(function(v){return"number"==typeof v?v:parseInt(v,10)}):def}function getStringArrayParam(attrs,name,def,keepCase){void 0===keepCase&&(keepCase=!1);var param=attrs[name];return param&&param.list&&param.list.s?param.list.s.map(function(v){return parseStringParam(v,keepCase)}):def}function getTensorShapeArrayParam(attrs,name,def){var param=attrs[name];return param&&param.list&&param.list.shape?param.list.shape.map(function(v){return parseTensorShapeParam(v)}):def}function getBoolArrayParam(attrs,name,def){var param=attrs[name];return param&&param.list&&param.list.b?param.list.b:def}exports.OperationMapper=OperationMapper,exports.decodeBase64=decodeBase64,exports.parseStringParam=parseStringParam,exports.getStringParam=getStringParam,exports.getBoolParam=getBoolParam,exports.getNumberParam=getNumberParam,exports.parseDtypeParam=parseDtypeParam,exports.getDtypeParam=getDtypeParam,exports.getDtypeArrayParam=getDtypeArrayParam,exports.parseTensorShapeParam=parseTensorShapeParam,exports.getTensorShapeParam=getTensorShapeParam,exports.getNumericArrayParam=getNumericArrayParam,exports.getStringArrayParam=getStringArrayParam,exports.getTensorShapeArrayParam=getTensorShapeArrayParam,exports.getBoolArrayParam=getBoolArrayParam}).call(this,require("buffer").Buffer)},{"../data/compiled_api":4,"./custom_op/register":13,"./executors/utils":30,"./op_list/arithmetic":31,"./op_list/basic_math":32,"./op_list/control":33,"./op_list/convolution":34,"./op_list/creation":35,"./op_list/dynamic":36,"./op_list/evaluation":37,"./op_list/graph":38,"./op_list/image":39,"./op_list/logical":40,"./op_list/matrices":41,"./op_list/normalization":42,"./op_list/reduction":43,"./op_list/slice_join":44,"./op_list/spectral":45,"./op_list/transformation":46,"@tensorflow/tfjs-core":148,buffer:334}],49:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});exports.version="1.2.8"},{}],50:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.EPSILON_FLOAT32=1e-7,exports.EPSILON_FLOAT16=1e-4;var DataStorage=function(){function DataStorage(backend,dataMover){this.backend=backend,this.dataMover=dataMover,this.data=new WeakMap}return DataStorage.prototype.get=function(dataId){return this.data.has(dataId)||this.dataMover.moveData(this.backend,dataId),this.data.get(dataId)},DataStorage.prototype.set=function(dataId,value){this.data.set(dataId,value)},DataStorage.prototype.has=function(dataId){return this.data.has(dataId)},DataStorage.prototype.delete=function(dataId){return this.data.delete(dataId)},DataStorage}();exports.DataStorage=DataStorage;var KernelBackend=function(){function KernelBackend(){}return KernelBackend.prototype.time=function(f){throw new Error("Not yet implemented.")},KernelBackend.prototype.read=function(dataId){throw new Error("Not yet implemented.")},KernelBackend.prototype.readSync=function(dataId){throw new Error("Not yet implemented.")},KernelBackend.prototype.disposeData=function(dataId){throw new Error("Not yet implemented.")},KernelBackend.prototype.write=function(dataId,values){throw new Error("Not yet implemented.")},KernelBackend.prototype.fromPixels=function(pixels,numChannels){throw new Error("Not yet implemented.")},KernelBackend.prototype.register=function(dataId,shape,dtype){throw new Error("Not yet implemented.")},KernelBackend.prototype.memory=function(){throw new Error("Not yet implemented.")},KernelBackend.prototype.floatPrecision=function(){throw new Error("Not yet implemented")},KernelBackend.prototype.epsilon=function(){return 32===this.floatPrecision()?exports.EPSILON_FLOAT32:exports.EPSILON_FLOAT16},KernelBackend.prototype.batchMatMul=function(a,b,transposeA,transposeB){throw new Error("Not yet implemented")},KernelBackend.prototype.fusedBatchMatMul=function(_a){_a.a,_a.b,_a.transposeA,_a.transposeB,_a.bias,_a.activation,_a.preluActivationWeights;throw new Error("Not yet implemented")},KernelBackend.prototype.slice=function(x,begin,size){throw new Error("Not yet implemented")},KernelBackend.prototype.stridedSlice=function(x,begin,end,strides,beginMask,endMask,ellipsisMask,newAxisMask,shrinkAxisMask){throw new Error("Not yet implemented")},KernelBackend.prototype.unstack=function(x,axis){throw new Error("Not yet implemented")},KernelBackend.prototype.reverse=function(a,axis){throw new Error("Not yet implemented")},KernelBackend.prototype.concat=function(tensors,axis){throw new Error("Not yet implemented")},KernelBackend.prototype.neg=function(a){throw new Error("Not yet implemented")},KernelBackend.prototype.add=function(a,b){throw new Error("Not yet implemented")},KernelBackend.prototype.addN=function(tensors){throw new Error("Not yet implemented")},KernelBackend.prototype.subtract=function(a,b){throw new Error("Not yet implemented")},KernelBackend.prototype.multiply=function(a,b){throw new Error("Not yet implemented")},KernelBackend.prototype.realDivide=function(a,b){throw new Error("Not yet implemented")},KernelBackend.prototype.floorDiv=function(a,b){throw new Error("Not yet implemented")},KernelBackend.prototype.sum=function(x,axes){throw new Error("Not yet implemented")},KernelBackend.prototype.prod=function(x,axes){throw new Error("Not yet implemented")},KernelBackend.prototype.unsortedSegmentSum=function(x,segmentIds,numSegments){throw new Error("Not yet implemented")},KernelBackend.prototype.argMin=function(x,axis){throw new Error("Not yet implemented")},KernelBackend.prototype.argMax=function(x,axis){throw new Error("Not yet implemented")},KernelBackend.prototype.equal=function(a,b){throw new Error("Not yet implemented")},KernelBackend.prototype.notEqual=function(a,b){throw new Error("Not yet implemented")},KernelBackend.prototype.less=function(a,b){throw new Error("Not yet implemented")},KernelBackend.prototype.lessEqual=function(a,b){throw new Error("Not yet implemented")},KernelBackend.prototype.greater=function(a,b){throw new Error("Not yet implemented")},KernelBackend.prototype.greaterEqual=function(a,b){throw new Error("Not yet implemented")},KernelBackend.prototype.logicalNot=function(a){throw new Error("Not yet implemented")},KernelBackend.prototype.logicalAnd=function(a,b){throw new Error("Not yet implemented")},KernelBackend.prototype.logicalOr=function(a,b){throw new Error("Not yet implemented")},KernelBackend.prototype.where=function(condition){throw new Error("Not yet implemented")},KernelBackend.prototype.select=function(condition,a,b){throw new Error("Not yet implemented")},KernelBackend.prototype.topk=function(x,k,sorted){throw new Error("Not yet implemented")},KernelBackend.prototype.min=function(x,axes){throw new Error("Not yet implemented")},KernelBackend.prototype.minimum=function(a,b){throw new Error("Not yet implemented")},KernelBackend.prototype.mod=function(a,b){throw new Error("Not yet implemented")},KernelBackend.prototype.max=function(x,axes){throw new Error("Not yet implemented")},KernelBackend.prototype.maximum=function(a,b){throw new Error("Not yet implemented")},KernelBackend.prototype.all=function(x,axes){throw new Error("Not yet implemented")},KernelBackend.prototype.any=function(x,axes){throw new Error("Not yet implemented")},KernelBackend.prototype.squaredDifference=function(a,b){throw new Error("Not yet implemented")},KernelBackend.prototype.ceil=function(x){throw new Error("Not yet implemented")},KernelBackend.prototype.floor=function(x){throw new Error("Not yet implemented")},KernelBackend.prototype.round=function(x){throw new Error("Not yet implemented")},KernelBackend.prototype.sign=function(x){throw new Error("Not yet implemented")},KernelBackend.prototype.isNaN=function(x){throw new Error("Not yet implemented")},KernelBackend.prototype.isInf=function(x){throw new Error("Not yet implemented")},KernelBackend.prototype.isFinite=function(x){throw new Error("Not yet implemented")},KernelBackend.prototype.pow=function(a,b){throw new Error("Not yet implemented")},KernelBackend.prototype.exp=function(x){throw new Error("Not yet implemented")},KernelBackend.prototype.expm1=function(x){throw new Error("Not yet implemented")},KernelBackend.prototype.log=function(x){throw new Error("Not yet implemented")},KernelBackend.prototype.log1p=function(x){throw new Error("Not yet implemented")},KernelBackend.prototype.sqrt=function(x){throw new Error("Not yet implemented")},KernelBackend.prototype.rsqrt=function(x){throw new Error("Not yet implemented")},KernelBackend.prototype.square=function(x){throw new Error("Not yet implemented")},KernelBackend.prototype.reciprocal=function(x){throw new Error("Not yet implemented")},KernelBackend.prototype.relu=function(x){throw new Error("Not yet implemented")},KernelBackend.prototype.prelu=function(x,a){throw new Error("Not yet implemented")},KernelBackend.prototype.elu=function(x){throw new Error("Not yet implemented")},KernelBackend.prototype.eluDer=function(dy,y){throw new Error("Not yet implemented")},KernelBackend.prototype.selu=function(x){throw new Error("Not yet implemented")},KernelBackend.prototype.int=function(x){throw new Error("Not yet implemented")},KernelBackend.prototype.clip=function(x,min,max){throw new Error("Not yet implemented")},KernelBackend.prototype.abs=function(x){throw new Error("Not yet implemented")},KernelBackend.prototype.complexAbs=function(x){throw new Error("Not yet implemented")},KernelBackend.prototype.sigmoid=function(x){throw new Error("Not yet implemented")},KernelBackend.prototype.softplus=function(x){throw new Error("Not yet implemented")},KernelBackend.prototype.sin=function(x){throw new Error("Not yet implemented")},KernelBackend.prototype.cos=function(x){throw new Error("Not yet implemented")},KernelBackend.prototype.tan=function(x){throw new Error("Not yet implemented")},KernelBackend.prototype.asin=function(x){throw new Error("Not yet implemented")},KernelBackend.prototype.acos=function(x){throw new Error("Not yet implemented")},KernelBackend.prototype.atan=function(x){throw new Error("Not yet implemented")},KernelBackend.prototype.atan2=function(a,b){throw new Error("Not yet implemented")},KernelBackend.prototype.sinh=function(x){throw new Error("Not yet implemented")},KernelBackend.prototype.cosh=function(x){throw new Error("Not yet implemented")},KernelBackend.prototype.tanh=function(x){throw new Error("Not yet implemented")},KernelBackend.prototype.asinh=function(x){throw new Error("Not yet implemented")},KernelBackend.prototype.acosh=function(x){throw new Error("Not yet implemented")},KernelBackend.prototype.atanh=function(x){throw new Error("Not yet implemented")},KernelBackend.prototype.erf=function(x){throw new Error("Not yet implemented")},KernelBackend.prototype.step=function(x,alpha){throw new Error("Not yet implemented")},KernelBackend.prototype.fusedConv2d=function(x,filter,convInfo,bias,activation,preluActivationWeights){throw new Error("Not yet implemented")},KernelBackend.prototype.conv2d=function(x,filter,convInfo){throw new Error("Not yet implemented")},KernelBackend.prototype.conv2dDerInput=function(dy,filter,convInfo){throw new Error("Not yet implemented")},KernelBackend.prototype.conv2dDerFilter=function(x,dY,convInfo){throw new Error("Not yet implemented")},KernelBackend.prototype.depthwiseConv2D=function(input,filter,convInfo){throw new Error("Not yet implemented")},KernelBackend.prototype.depthwiseConv2DDerInput=function(dy,filter,convInfo){throw new Error("Not yet implemented")},KernelBackend.prototype.depthwiseConv2DDerFilter=function(x,dY,convInfo){throw new Error("Not yet implemented")},KernelBackend.prototype.conv3d=function(x,filter,convInfo){throw new Error("Not yet implemented")},KernelBackend.prototype.conv3dDerInput=function(dy,filter,convInfo){throw new Error("Not yet implemented")},KernelBackend.prototype.conv3dDerFilter=function(x,dY,convInfo){throw new Error("Not yet implemented")},KernelBackend.prototype.maxPool=function(x,convInfo){throw new Error("Not yet implemented")},KernelBackend.prototype.maxPoolBackprop=function(dy,x,y,convInfo){throw new Error("Not yet implemented")},KernelBackend.prototype.avgPool=function(x,convInfo){throw new Error("Not yet implemented")},KernelBackend.prototype.avgPoolBackprop=function(dy,x,convInfo){throw new Error("Not yet implemented")},KernelBackend.prototype.avgPool3d=function(x,convInfo){throw new Error("Not yet implemented")},KernelBackend.prototype.avgPool3dBackprop=function(dy,x,convInfo){throw new Error("Not yet implemented")},KernelBackend.prototype.maxPool3d=function(x,convInfo){throw new Error("Not yet implemented")},KernelBackend.prototype.maxPool3dBackprop=function(dy,x,y,convInfo){throw new Error("Not yet implemented")},KernelBackend.prototype.reshape=function(x,shape){throw new Error("Not yet implemented")},KernelBackend.prototype.cast=function(x,dtype){throw new Error("Not yet implemented")},KernelBackend.prototype.tile=function(x,reps){throw new Error("Not yet implemented")},KernelBackend.prototype.pad=function(x,paddings,constantValue){throw new Error("Not yet implemented")},KernelBackend.prototype.transpose=function(x,perm){throw new Error("Not yet implemented")},KernelBackend.prototype.gather=function(x,indices,axis){throw new Error("Not yet implemented")},KernelBackend.prototype.gatherND=function(x,indices){throw new Error("Not yet implemented")},KernelBackend.prototype.scatterND=function(indices,updates,shape){throw new Error("Not yet implemented")},KernelBackend.prototype.batchToSpaceND=function(x,blockShape,crops){throw new Error("Not yet implemented")},KernelBackend.prototype.spaceToBatchND=function(x,blockShape,paddings){throw new Error("Not yet implemented")},KernelBackend.prototype.resizeBilinear=function(x,newHeight,newWidth,alignCorners){throw new Error("Not yet implemented")},KernelBackend.prototype.resizeBilinearBackprop=function(dy,x,alignCorners){throw new Error("Not yet implemented")},KernelBackend.prototype.resizeNearestNeighbor=function(x,newHEight,newWidth,alignCorners){throw new Error("Not yet implemented")},KernelBackend.prototype.resizeNearestNeighborBackprop=function(dy,x,alignCorners){throw new Error("Not yet implemented")},KernelBackend.prototype.batchNormalization=function(x,mean,variance,varianceEpsilon,scale,offset){throw new Error("Not yet implemented")},KernelBackend.prototype.localResponseNormalization4D=function(x,radius,bias,alpha,beta){throw new Error("Not yet implemented")},KernelBackend.prototype.LRNGrad=function(dy,inputImage,outputImage,radius,bias,alpha,beta){throw new Error("Not yet implemented")},KernelBackend.prototype.multinomial=function(logits,normalized,numSamples,seed){throw new Error("Not yet implemented")},KernelBackend.prototype.oneHot=function(indices,depth,onValue,offValue){throw new Error("Not yet implemented")},KernelBackend.prototype.cumsum=function(x,axis,exclusive,reverse){throw new Error("Not yet implemented")},KernelBackend.prototype.nonMaxSuppression=function(boxes,scores,maxOutputSize,iouThreshold,scoreThreshold){throw new Error("Not yet implemented")},KernelBackend.prototype.fft=function(x){throw new Error("Not yet implemented")},KernelBackend.prototype.ifft=function(x){throw new Error("Not yet implemented")},KernelBackend.prototype.complex=function(real,imag){throw new Error("Not yet implemented")},KernelBackend.prototype.real=function(input){throw new Error("Not yet implemented")},KernelBackend.prototype.imag=function(input){throw new Error("Not yet implemented")},KernelBackend.prototype.cropAndResize=function(image,boxes,boxIndex,cropSize,method,extrapolationValue){throw new Error("Not yet implemented")},KernelBackend.prototype.depthToSpace=function(x,blockSize,dataFormat){throw new Error("Not yet implemented")},KernelBackend.prototype.split=function(value,sizeSplits,axis){throw new Error("Not yet implemented")},KernelBackend.prototype.sparseToDense=function(sparseIndices,sparseValues,outputShape,defaultValue){throw new Error("Not yet implemented")},KernelBackend.prototype.diag=function(x){throw new Error("Not yet implemented")},KernelBackend.prototype.fill=function(shape,value,dtype){throw new Error("Not yet implemented.")},KernelBackend.prototype.onesLike=function(x){throw new Error("Not yet implemented")},KernelBackend.prototype.zerosLike=function(x){throw new Error("Not yet implemented")},KernelBackend.prototype.linspace=function(start,stop,num){throw new Error("Not yet implemented")},KernelBackend.prototype.dispose=function(){throw new Error("Not yet implemented")},KernelBackend}();exports.KernelBackend=KernelBackend},{}],51:[function(require,module,exports){"use strict";function __export(m){for(var p in m)exports.hasOwnProperty(p)||(exports[p]=m[p])}Object.defineProperty(exports,"__esModule",{value:!0});var tensor_ops_1=require("../ops/tensor_ops"),tensor_1=require("../tensor"),util_1=require("../util");__export(require("../ops/axis_util")),__export(require("../ops/broadcast_util")),__export(require("../ops/concat_util")),__export(require("../ops/conv_util"));var types_1=require("../types");exports.upcastType=types_1.upcastType,exports.castTensor=function(x,dtype,backend){if("complex64"===dtype){if("complex64"===x.dtype)return x.clone();var zerosTensor=tensor_ops_1.zeros(x.shape),floatX=x.toFloat(),result=backend.complex(floatX,zerosTensor);return zerosTensor.dispose(),floatX.dispose(),result}if(!util_1.hasEncodingLoss(x.dtype,dtype))return tensor_1.Tensor.make(x.shape,{dataId:x.dataId},dtype);if("complex64"===x.dtype){var real=backend.real(x);result=real.cast(dtype);return real.dispose(),result}if("int32"===dtype)return backend.int(x);if("bool"!==dtype)throw new Error("Error in Cast: failed to cast "+x.dtype+" to "+dtype);var zero=tensor_ops_1.scalar(0,x.dtype);return result=backend.notEqual(x,zero),zero.dispose(),result},exports.reshapeTensor=function(x,shape){return tensor_1.Tensor.make(shape,{dataId:x.dataId},x.dtype)},exports.linspaceImpl=function(start,stop,num){var step=(stop-start)/(num-1),values=util_1.makeZerosTypedArray(num,"float32");values[0]=start;for(var i=1;i<values.length;i++)values[i]=values[i-1]+step;return tensor_ops_1.tensor1d(values,"float32")}},{"../ops/axis_util":165,"../ops/broadcast_util":169,"../ops/concat_util":174,"../ops/conv_util":177,"../ops/tensor_ops":216,"../tensor":234,"../types":240,"../util":241}],52:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.mergeRealAndImagArrays=function(real,imag){if(real.length!==imag.length)throw new Error("Cannot merge real and imag arrays of different lengths. real:"+real.length+", imag: "+imag.length+".");for(var result=new Float32Array(2*real.length),i=0;i<result.length;i+=2)result[i]=real[i/2],result[i+1]=imag[i/2];return result},exports.splitRealAndImagArrays=function(complex){for(var real=new Float32Array(complex.length/2),imag=new Float32Array(complex.length/2),i=0;i<complex.length;i+=2)real[i/2]=complex[i],imag[i/2]=complex[i+1];return{real:real,imag:imag}},exports.complexWithEvenIndex=function(complex){for(var len=Math.ceil(complex.length/4),real=new Float32Array(len),imag=new Float32Array(len),i=0;i<complex.length;i+=4)real[Math.floor(i/4)]=complex[i],imag[Math.floor(i/4)]=complex[i+1];return{real:real,imag:imag}},exports.complexWithOddIndex=function(complex){for(var len=Math.floor(complex.length/4),real=new Float32Array(len),imag=new Float32Array(len),i=2;i<complex.length;i+=4)real[Math.floor(i/4)]=complex[i],imag[Math.floor(i/4)]=complex[i+1];return{real:real,imag:imag}},exports.getComplexWithIndex=function(complex,index){return{real:complex[2*index],imag:complex[2*index+1]}},exports.assignToTypedArray=function(data,real,imag,index){data[2*index]=real,data[2*index+1]=imag},exports.exponents=function(n,inverse){for(var real=new Float32Array(n/2),imag=new Float32Array(n/2),i=0;i<Math.ceil(n/2);i++){var x=(inverse?2:-2)*Math.PI*(i/n);real[i]=Math.cos(x),imag[i]=Math.sin(x)}return{real:real,imag:imag}},exports.exponent=function(k,n,inverse){var x=(inverse?2:-2)*Math.PI*(k/n);return{real:Math.cos(x),imag:Math.sin(x)}}},{}],53:[function(require,module,exports){"use strict";var __awaiter=this&&this.__awaiter||function(thisArg,_arguments,P,generator){return new(P=P||Promise)(function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){result.done?resolve(result.value):new P(function(resolve){resolve(result.value)}).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())})},__generator=this&&this.__generator||function(thisArg,body){var f,y,t,g,_={label:0,sent:function(){if(1&t[0])throw t[1];return t[1]},trys:[],ops:[]};return g={next:verb(0),throw:verb(1),return:verb(2)},"function"==typeof Symbol&&(g[Symbol.iterator]=function(){return this}),g;function verb(n){return function(v){return function(op){if(f)throw new TypeError("Generator is already executing.");for(;_;)try{if(f=1,y&&(t=2&op[0]?y.return:op[0]?y.throw||((t=y.return)&&t.call(y),0):y.next)&&!(t=t.call(y,op[1])).done)return t;switch(y=0,t&&(op=[2&op[0],t.value]),op[0]){case 0:case 1:t=op;break;case 4:return _.label++,{value:op[1],done:!1};case 5:_.label++,y=op[1],op=[0];continue;case 7:op=_.ops.pop(),_.trys.pop();continue;default:if(!(t=0<(t=_.trys).length&&t[t.length-1])&&(6===op[0]||2===op[0])){_=0;continue}if(3===op[0]&&(!t||op[1]>t[0]&&op[1]<t[3])){_.label=op[1];break}if(6===op[0]&&_.label<t[1]){_.label=t[1],t=op;break}if(t&&_.label<t[2]){_.label=t[2],_.ops.push(op);break}t[2]&&_.ops.pop(),_.trys.pop();continue}op=body.call(thisArg,_)}catch(e){op=[6,e],y=0}finally{f=t=0}if(5&op[0])throw op[1];return{value:op[0]?op[1]:void 0,done:!0}}([n,v])}}};Object.defineProperty(exports,"__esModule",{value:!0});var seedrandom=require("seedrandom"),engine_1=require("../../engine"),environment_1=require("../../environment"),log_1=require("../../log"),array_ops_util=require("../../ops/array_ops_util"),axis_util=require("../../ops/axis_util"),broadcast_util=require("../../ops/broadcast_util"),complex_ops_1=require("../../ops/complex_ops"),concat_util=require("../../ops/concat_util"),erf_util=require("../../ops/erf_util"),gather_nd_util=require("../../ops/gather_nd_util"),ops=require("../../ops/ops"),ops_1=require("../../ops/ops"),scatter_nd_util=require("../../ops/scatter_nd_util"),selu_util=require("../../ops/selu_util"),slice_util_1=require("../../ops/slice_util"),tensor_1=require("../../tensor"),types_1=require("../../types"),util=require("../../util"),util_1=require("../../util"),backend_1=require("../backend"),backend_util=require("../backend_util"),complex_util=require("../complex_util"),non_max_suppression_impl_1=require("../non_max_suppression_impl"),split_shared_1=require("../split_shared"),tile_impl_1=require("../tile_impl"),topk_impl_1=require("../topk_impl"),where_impl_1=require("../where_impl");function mapActivation(backend,x,activation,preluActivationWeights){if("linear"===activation)return backend.linear(x);if("relu"===activation)return backend.relu(x);if("prelu"===activation)return backend.prelu(x,preluActivationWeights);throw new Error("Activation "+activation+" has not been implemented for the CPU backend.")}var MathBackendCPU=function(){function MathBackendCPU(){if(this.blockSize=48,this.firstUse=!0,environment_1.ENV.get("IS_BROWSER")){var canvas="undefined"!=typeof OffscreenCanvas?new OffscreenCanvas(300,150):"undefined"!=typeof document?document.createElement("canvas"):null;null!==canvas&&(this.fromPixels2DContext=canvas.getContext("2d"))}this.data=new backend_1.DataStorage(this,engine_1.ENGINE)}return MathBackendCPU.prototype.register=function(dataId,shape,dtype){if(this.firstUse&&(this.firstUse=!1,environment_1.ENV.get("IS_NODE")&&log_1.warn("\n============================\nHi there . Looks like you are running TensorFlow.js in Node.js. To speed things up dramatically, install our node backend, which binds to TensorFlow C++, by running npm i @tensorflow/tfjs-node, or npm i @tensorflow/tfjs-node-gpu if you have CUDA. Then call require('@tensorflow/tfjs-node'); (-gpu suffix for CUDA) at the start of your program. Visit https://github.com/tensorflow/tfjs-node for more details.\n============================\n")),this.data.has(dataId))throw new Error("Data buffer is already registered");this.data.set(dataId,{dtype:dtype})},MathBackendCPU.prototype.write=function(dataId,values){if(null==values)throw new Error("MathBackendCPU.write(): values can not be null");this.data.get(dataId).values=values},MathBackendCPU.prototype.fromPixels=function(pixels,numChannels){if(null==pixels)throw new Error("pixels passed to tf.browser.fromPixels() can not be null");var vals,values,isPixelData=pixels.data instanceof Uint8Array,isImageData="undefined"!=typeof ImageData&&pixels instanceof ImageData,isVideo="undefined"!=typeof HTMLVideoElement&&pixels instanceof HTMLVideoElement,isImage="undefined"!=typeof HTMLImageElement&&pixels instanceof HTMLImageElement;if(environment_1.ENV.get("IS_NODE")&&null==pixels.getContext)throw new Error("When running in node, pixels must be an HTMLCanvasElement like the one returned by the `canvas` npm package");if(null!=pixels.getContext)vals=pixels.getContext("2d").getImageData(0,0,pixels.width,pixels.height).data;else if(isImageData||isPixelData)vals=pixels.data;else{if(!isImage&&!isVideo)throw new Error("pixels passed to tf.browser.fromPixels() must be either an HTMLVideoElement, HTMLImageElement, HTMLCanvasElement, ImageData or {data: Uint32Array, width: number, height: number}, but was "+pixels.constructor.name);if(null==this.fromPixels2DContext)throw new Error("Can't read pixels from HTMLImageElement outside the browser.");this.fromPixels2DContext.canvas.width=pixels.width,this.fromPixels2DContext.canvas.height=pixels.height,this.fromPixels2DContext.drawImage(pixels,0,0,pixels.width,pixels.height),vals=this.fromPixels2DContext.getImageData(0,0,pixels.width,pixels.height).data}if(4===numChannels)values=new Int32Array(vals);else{var numPixels=pixels.width*pixels.height;values=new Int32Array(numPixels*numChannels);for(var i=0;i<numPixels;i++)for(var channel=0;channel<numChannels;++channel)values[i*numChannels+channel]=vals[4*i+channel]}var outShape=[pixels.height,pixels.width,numChannels];return ops_1.tensor3d(values,outShape,"int32")},MathBackendCPU.prototype.read=function(dataId){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(_a){return[2,this.readSync(dataId)]})})},MathBackendCPU.prototype.readSync=function(dataId){var _a=this.data.get(dataId),dtype=_a.dtype,complexTensors=_a.complexTensors;if("complex64"!==dtype)return this.data.get(dataId).values;var realValues=this.readSync(complexTensors.real.dataId),imagValues=this.readSync(complexTensors.imag.dataId);return complex_util.mergeRealAndImagArrays(realValues,imagValues)},MathBackendCPU.prototype.bufferSync=function(t){var data=this.readSync(t.dataId),decodedData=data;if("string"===t.dtype)try{decodedData=data.map(function(d){return util.decodeString(d)})}catch(_a){throw new Error("Failed to decode encoded string bytes into utf-8")}return ops_1.buffer(t.shape,t.dtype,decodedData)},MathBackendCPU.prototype.disposeData=function(dataId){if(this.data.has(dataId)){var complexTensors=this.data.get(dataId).complexTensors;null!=complexTensors&&(complexTensors.real.dispose(),complexTensors.imag.dispose()),this.data.delete(dataId)}},MathBackendCPU.prototype.time=function(f){return __awaiter(this,void 0,void 0,function(){var start;return __generator(this,function(_a){return start=util_1.now(),f(),[2,{kernelMs:util_1.now()-start}]})})},MathBackendCPU.prototype.memory=function(){return{unreliable:!0,reasons:["The reported memory is an upper bound. Due to automatic garbage collection, the true allocated memory may be less."]}},MathBackendCPU.prototype.complex=function(real,imag){var result=tensor_1.Tensor.make(real.shape,{},"complex64");return this.data.get(result.dataId).complexTensors={real:engine_1.ENGINE.keep(real.clone()),imag:engine_1.ENGINE.keep(imag.clone())},result},MathBackendCPU.prototype.real=function(input){return this.data.get(input.dataId).complexTensors.real.clone()},MathBackendCPU.prototype.imag=function(input){return this.data.get(input.dataId).complexTensors.imag.clone()},MathBackendCPU.prototype.assertNotComplex=function(tensor,opName){Array.isArray(tensor)||(tensor=[tensor]),tensor.forEach(function(t){null!=t&&util.assert("complex64"!==t.dtype,function(){return opName+" does not support complex64 tensors."})})},MathBackendCPU.prototype.slice=function(x,begin,size){if(this.assertNotComplex(x,"slice"),slice_util_1.isSliceContinous(x.shape,begin,size)){var flatOffset=slice_util_1.computeFlatOffset(begin,x.strides),length_1=util.sizeFromShape(size),vals=this.readSync(x.dataId);return ops_1.tensor(vals.subarray(flatOffset,flatOffset+length_1),size,x.dtype)}for(var buffer=ops.buffer(size,x.dtype),xBuf=this.bufferSync(x),i=0;i<buffer.size;++i){var xLoc=buffer.indexToLoc(i).map(function(idx,j){return idx+begin[j]});buffer.values[i]=xBuf.get.apply(xBuf,xLoc)}return buffer.toTensor()},MathBackendCPU.prototype.stridedSlice=function(x,begin,end,strides,beginMask,endMask,ellipsisMask,newAxisMask,shrinkAxisMask){this.assertNotComplex(x,"stridedSlice");var _a=slice_util_1.getStridedSlicedInfo(x.shape,begin,end,strides,beginMask,endMask,ellipsisMask,newAxisMask,shrinkAxisMask),beginIndex=_a[0],size=_a[1],shrinkAxis=_a[2],shape=size.filter(function(v,index){return-1===shrinkAxis.indexOf(index)});if(shape.some(function(axis){return 0===axis}))return ops.tensor([],shape);for(var buffer=ops.buffer(size,x.dtype),xBuf=this.bufferSync(x),i=0;i<buffer.size;i++){for(var loc=buffer.indexToLoc(i),newLoc=new Array(loc.length),j=0;j<newLoc.length;j++)newLoc[j]=loc[j]*strides[j]+beginIndex[j];buffer.set.apply(buffer,[xBuf.get.apply(xBuf,newLoc)].concat(loc))}return buffer.toTensor().reshape(shape)},MathBackendCPU.prototype.diag=function(x){for(var xVals=this.readSync(x.dataId),buffer=ops.buffer([x.size,x.size],x.dtype),vals=buffer.values,i=0;i<xVals.length;i++)vals[i*x.size+i]=xVals[i];return buffer.toTensor()},MathBackendCPU.prototype.unstack=function(x,axis){for(var num=x.shape[axis],outShape=new Array(x.rank-1),outIndex=0,i=0;i<x.rank;i++)i!==axis&&(outShape[outIndex++]=x.shape[i]);var begin=new Array(x.rank).fill(0),size=x.shape.slice();size[axis]=1;var res=new Array(num);for(i=0;i<res.length;i++)res[begin[axis]=i]=this.slice(x,begin,size).reshape(outShape);return res},MathBackendCPU.prototype.reverse=function(x,axis){this.assertNotComplex(x,"reverse");for(var buffer=ops.buffer(x.shape,x.dtype),xBuf=this.bufferSync(x),_loop_1=function(i){var outLoc=buffer.indexToLoc(i),inLoc=outLoc.slice();axis.forEach(function(ax){return inLoc[ax]=x.shape[ax]-1-inLoc[ax]}),buffer.set.apply(buffer,[xBuf.get.apply(xBuf,inLoc)].concat(outLoc))},i=0;i<buffer.size;i++)_loop_1(i);return buffer.toTensor()},MathBackendCPU.prototype.concat=function(tensors,axis){var _this=this;if("complex64"===tensors[0].dtype){var reals=tensors.map(function(t){return complex_ops_1.real(t)}),imags=tensors.map(function(t){return complex_ops_1.imag(t)});return complex_ops_1.complex(this.concat(reals,axis),this.concat(imags,axis))}var tensors2D=tensors.map(function(t){var innerSize=util.sizeFromShape(t.shape.slice(axis));return t.as2D(-1,innerSize)}),outShape=concat_util.computeOutShape(tensors2D.map(function(t){return t.shape}),1),values=ops.buffer(outShape,tensors[0].dtype).values;if(1===tensors2D[0].shape[0]){var offset_1=0;tensors2D.forEach(function(t){values.set(_this.readSync(t.dataId),offset_1),offset_1+=t.size})}else{var colOffset_1=0;tensors2D.forEach(function(t){for(var tVals=_this.readSync(t.dataId),tIdx=0,row=0;row<t.shape[0];++row)for(var resIdx=row*outShape[1]+colOffset_1,col=0;col<t.shape[1];++col)values[resIdx+col]=tVals[tIdx++];colOffset_1+=t.shape[1]})}var finalOutShape=concat_util.computeOutShape(tensors.map(function(t){return t.shape}),axis);return ops_1.tensor(values,finalOutShape,tensors[0].dtype)},MathBackendCPU.prototype.neg=function(x){return this.assertNotComplex(x,"neg"),this.multiply(ops.scalar(-1),x)},MathBackendCPU.prototype.add=function(a,b){return"complex64"===a.dtype||"complex64"===b.dtype?this.broadcastedBinaryComplexOp(a.cast("complex64"),b.cast("complex64"),function(aReal,aImag,bReal,bImag){return{real:aReal+bReal,imag:aImag+bImag}}):this.broadcastedBinaryOp(a,b,types_1.upcastType(a.dtype,b.dtype),function(aValue,bValue){return aValue+bValue})},MathBackendCPU.prototype.addN=function(tensors){var _this=this;this.assertNotComplex(tensors,"addN");for(var vals=tensors.map(function(t){return _this.readSync(t.dataId)}),result=ops.buffer(tensors[0].shape,tensors[0].dtype),resultVals=result.values,i=0;i<tensors.length;i++)for(var currVals=vals[i],j=0;j<resultVals.length;j++)resultVals[j]+=currVals[j];return result.toTensor()},MathBackendCPU.prototype.subtract=function(a,b){return"complex64"===a.dtype||"complex64"===b.dtype?this.broadcastedBinaryComplexOp(a.cast("complex64"),b.cast("complex64"),function(aReal,aImag,bReal,bImag){return{real:aReal-bReal,imag:aImag-bImag}}):this.broadcastedBinaryOp(a,b,types_1.upcastType(a.dtype,b.dtype),function(aValue,bValue){return aValue-bValue})},MathBackendCPU.prototype.pow=function(a,b){return this.assertNotComplex([a,b],"pow"),this.broadcastedBinaryOp(a,b,a.dtype,function(aValue,bValue){return Math.pow(aValue,bValue)})},MathBackendCPU.prototype.batchMatMul=function(a,b,transposeA,transposeB){this.assertNotComplex([a,b],"matMul");for(var sharedDim=transposeA?a.shape[1]:a.shape[2],leftDim=transposeA?a.shape[2]:a.shape[1],rightDim=transposeB?b.shape[1]:b.shape[2],batchDim=a.shape[0],aValues=this.readSync(a.dataId),bValues=this.readSync(b.dataId),_a=transposeA?[a.strides[0],1,a.strides[1]]:[a.strides[0],a.strides[1],1],aBatch=_a[0],aOuterStep=_a[1],aInnerStep=_a[2],_b=transposeB?[1,b.strides[1],b.strides[0]]:[b.strides[1],1,b.strides[0]],bInnerStep=_b[0],bOuterStep=_b[1],bBatch=_b[2],size=leftDim*rightDim,result=ops_1.buffer([batchDim,leftDim,rightDim],a.dtype),resVals=result.values,blockSize=this.blockSize,b_1=0;b_1<batchDim;b_1++)for(var i0=0;i0<leftDim;i0+=blockSize)for(var j0=0;j0<rightDim;j0+=blockSize)for(var k0=0;k0<sharedDim;k0+=blockSize)for(var iBlock=Math.min(i0+blockSize,leftDim),jBlock=Math.min(j0+blockSize,rightDim),kBlock=Math.min(k0+blockSize,sharedDim),i=i0;i<iBlock;i++)for(var j=j0;j<jBlock;j++){for(var sum=0,k=k0;k<kBlock;k++)sum+=aValues[b_1*aBatch+i*aOuterStep+k*aInnerStep]*bValues[k*bInnerStep+j*bOuterStep+b_1*bBatch];resVals[b_1*size+(i*rightDim+j)]+=sum}return result.toTensor()},MathBackendCPU.prototype.fusedBatchMatMul=function(_a){var a=_a.a,b=_a.b,transposeA=_a.transposeA,transposeB=_a.transposeB,bias=_a.bias,activation=_a.activation,preluActivationWeights=_a.preluActivationWeights,result=this.batchMatMul(a,b,transposeA,transposeB);return bias&&(result=this.add(result,bias)),activation&&(result=mapActivation(this,result,activation,preluActivationWeights)),result},MathBackendCPU.prototype.multiply=function(a,b){return"complex64"===a.dtype||"complex64"===b.dtype?this.broadcastedBinaryComplexOp(a.cast("complex64"),b.cast("complex64"),function(aReal,aImag,bReal,bImag){return{real:aReal*bReal-aImag*bImag,imag:aReal*bImag+aImag*bReal}}):this.broadcastedBinaryOp(a,b,types_1.upcastType(a.dtype,b.dtype),function(aValue,bValue){return aValue*bValue})},MathBackendCPU.prototype.realDivide=function(a,b){this.assertNotComplex([a,b],"realDivide");return this.broadcastedBinaryOp(a,b,"float32",function(a,b){return a/b})},MathBackendCPU.prototype.floorDiv=function(a,b){this.assertNotComplex([a,b],"floorDiv");return this.broadcastedBinaryOp(a,b,"int32",function(a,b){return Math.floor(a/b)})},MathBackendCPU.prototype.sum=function(x,axes){this.assertNotComplex(x,"sum"),axis_util.assertAxesAreInnerMostDims("sum",axes,x.rank);for(var _a=axis_util.computeOutAndReduceShapes(x.shape,axes),outShape=_a[0],reduceShape=_a[1],resultDtype=types_1.upcastType(x.dtype,"int32"),result=ops.zeros(outShape,resultDtype),reduceSize=util.sizeFromShape(reduceShape),vals=this.readSync(result.dataId),aVals=this.readSync(x.dataId),i=0;i<vals.length;++i){for(var offset=i*reduceSize,sum=0,j=0;j<reduceSize;++j)sum+=aVals[offset+j];vals[i]=sum}return result},MathBackendCPU.prototype.prod=function(x,axes){this.assertNotComplex(x,"sum");for(var _a=axis_util.computeOutAndReduceShapes(x.shape,axes),outShape=_a[0],reduceShape=_a[1],resultDtype=types_1.upcastType(x.dtype,"int32"),result=ops.zeros(outShape,resultDtype),reduceSize=util.sizeFromShape(reduceShape),vals=this.readSync(result.dataId),aVals=this.readSync(x.dataId),i=0;i<vals.length;++i){for(var offset=i*reduceSize,prod=1,j=0;j<reduceSize;++j)prod*=aVals[offset+j];vals[i]=prod}return result},MathBackendCPU.prototype.unsortedSegmentSum=function(x,segmentIds,numSegments){this.assertNotComplex(x,"unsortedSegmentSum");for(var res=[],numIters=x.rank-segmentIds.rank,i=0;i<numIters;++i)segmentIds=segmentIds.expandDims(i+1);for(i=0;i<numSegments;++i){var segmentId=ops.scalar(i,"int32"),sum=ops.equal(segmentId,segmentIds).asType("float32").mul(x).sum(0);res.push(sum)}return ops.stack(res)},MathBackendCPU.prototype.argMin=function(x,axis){this.assertNotComplex(x,"argMin");var axes=[axis];axis_util.assertAxesAreInnerMostDims("argMin",axes,x.rank);for(var _a=axis_util.computeOutAndReduceShapes(x.shape,axes),outShape=_a[0],reduceShape=_a[1],result=ops.zeros(outShape,"int32"),reduceSize=util.sizeFromShape(reduceShape),vals=this.readSync(result.dataId),aVals=this.readSync(x.dataId),i=0;i<vals.length;++i){for(var offset=i*reduceSize,min=aVals[offset],minIndex=0,j=0;j<reduceSize;++j){var value=aVals[offset+j];value<min&&(min=value,minIndex=j)}vals[i]=minIndex}return result},MathBackendCPU.prototype.argMax=function(x,axis){this.assertNotComplex(x,"argMax");var axes=[axis];axis_util.assertAxesAreInnerMostDims("argMax",axes,x.rank);for(var _a=axis_util.computeOutAndReduceShapes(x.shape,axes),outShape=_a[0],reduceShape=_a[1],result=ops.zeros(outShape,"int32"),reduceSize=util.sizeFromShape(reduceShape),vals=this.readSync(result.dataId),aVals=this.readSync(x.dataId),i=0;i<vals.length;++i){for(var offset=i*reduceSize,max=aVals[offset],maxIndex=0,j=0;j<reduceSize;++j){var value=aVals[offset+j];max<value&&(max=value,maxIndex=j)}vals[i]=maxIndex}return result},MathBackendCPU.prototype.cumsum=function(x,axis,exclusive,reverse){if(this.assertNotComplex(x,"cumsum"),axis!==x.rank-1)throw new Error("backend.cumsum in CPU expects an inner-most axis="+(x.rank-1)+" but got axis="+axis);for(var resultDtype=types_1.upcastType(x.dtype,"int32"),result=ops.zeros(x.shape,resultDtype),vals=this.readSync(result.dataId),aVals=this.readSync(x.dataId),finalDim=x.shape[x.rank-1],indexAdjuster=reverse?function(i,j){return i+finalDim-j-1}:function(i,j){return i+j},i=0;i<aVals.length;i+=finalDim)for(var j=0;j<finalDim;j++){var idx=indexAdjuster(i,j);if(0===j)vals[idx]=exclusive?0:aVals[idx];else{var prevIdx=indexAdjuster(i,j-1);vals[idx]=exclusive?aVals[prevIdx]+vals[prevIdx]:aVals[idx]+vals[prevIdx]}}return result},MathBackendCPU.prototype.equal=function(a,b){return this.assertNotComplex([a,b],"equal"),this.broadcastedBinaryOp(a,b,"bool",function(aVal,bVal){return aVal===bVal?1:0})},MathBackendCPU.prototype.notEqual=function(a,b){return this.assertNotComplex([a,b],"notEqual"),this.broadcastedBinaryOp(a,b,"bool",function(aVal,bVal){return aVal!==bVal?1:0})},MathBackendCPU.prototype.less=function(a,b){return this.assertNotComplex([a,b],"less"),this.broadcastedBinaryOp(a,b,"bool",function(aVal,bVal){return aVal<bVal?1:0})},MathBackendCPU.prototype.lessEqual=function(a,b){return this.assertNotComplex([a,b],"lessEqual"),this.broadcastedBinaryOp(a,b,"bool",function(aVal,bVal){return aVal<=bVal?1:0})},MathBackendCPU.prototype.greater=function(a,b){return this.assertNotComplex([a,b],"greater"),this.broadcastedBinaryOp(a,b,"bool",function(aVal,bVal){return bVal<aVal?1:0})},MathBackendCPU.prototype.greaterEqual=function(a,b){return this.assertNotComplex([a,b],"greaterEqual"),this.broadcastedBinaryOp(a,b,"bool",function(aVal,bVal){return bVal<=aVal?1:0})},MathBackendCPU.prototype.logicalNot=function(x){this.assertNotComplex(x,"logicalNot");for(var values=this.readSync(x.dataId),newValues=new Uint8Array(values.length),i=0;i<values.length;++i)newValues[i]=values[i]?0:1;return tensor_1.Tensor.make(x.shape,{values:newValues},"bool")},MathBackendCPU.prototype.logicalAnd=function(a,b){return this.assertNotComplex([a,b],"logicalAnd"),this.broadcastedBinaryOp(a,b,"bool",function(aVal,bVal){return aVal&&bVal})},MathBackendCPU.prototype.logicalOr=function(a,b){return this.assertNotComplex([a,b],"logicalOr"),this.broadcastedBinaryOp(a,b,"bool",function(aVal,bVal){return aVal||bVal})},MathBackendCPU.prototype.select=function(condition,a,b){this.assertNotComplex([condition,a,b],"select");for(var values=this.readSync(condition.dataId),aValues=this.readSync(a.dataId),bValues=this.readSync(b.dataId),result=ops.zeros(a.shape,types_1.upcastType(a.dtype,b.dtype)),newValues=this.readSync(result.dataId),index=0,offset=0===condition.rank||1<condition.rank||1===a.rank?1:a.shape[1],i=0;i<values.length;i++)for(var j=0;j<offset;j++)1===values[i]?newValues[index++]=aValues[i]:newValues[index++]=bValues[i];return result},MathBackendCPU.prototype.where=function(condition){this.assertNotComplex([condition],"where");var condVals=this.readSync(condition.dataId);return where_impl_1.whereImpl(condition.shape,condVals)},MathBackendCPU.prototype.topk=function(x,k,sorted){this.assertNotComplex(x,"topk");var xVals=this.readSync(x.dataId);return topk_impl_1.topkImpl(xVals,x.shape,x.dtype,k,sorted)},MathBackendCPU.prototype.min=function(x,axes){this.assertNotComplex(x,"min"),axis_util.assertAxesAreInnerMostDims("min",axes,x.rank);for(var _a=axis_util.computeOutAndReduceShapes(x.shape,axes),outShape=_a[0],reduceShape=_a[1],result=ops.zeros(outShape,x.dtype),reduceSize=util.sizeFromShape(reduceShape),vals=this.readSync(result.dataId),aVals=this.readSync(x.dataId),i=0;i<vals.length;++i){for(var offset=i*reduceSize,min=aVals[offset],j=0;j<reduceSize;++j){var value=aVals[offset+j];value<min&&(min=value)}vals[i]=min}return result},MathBackendCPU.prototype.minimum=function(a,b){return this.assertNotComplex([a,b],"minimum"),this.broadcastedBinaryOp(a,b,a.dtype,function(aVal,bVal){return Math.min(aVal,bVal)})},MathBackendCPU.prototype.mod=function(a,b){return this.assertNotComplex([a,b],"mod"),this.broadcastedBinaryOp(a,b,a.dtype,function(aVal,bVal){var rem=aVal%bVal;return aVal<0&&bVal<0||0<=aVal&&0<=bVal?rem:(rem+bVal)%bVal})},MathBackendCPU.prototype.max=function(x,axes){this.assertNotComplex(x,"max"),axis_util.assertAxesAreInnerMostDims("max",axes,x.rank);for(var _a=axis_util.computeOutAndReduceShapes(x.shape,axes),outShape=_a[0],reduceShape=_a[1],result=ops.zeros(outShape,x.dtype),reduceSize=util.sizeFromShape(reduceShape),vals=this.readSync(result.dataId),aVals=this.readSync(x.dataId),i=0;i<vals.length;++i){for(var offset=i*reduceSize,max=aVals[offset],j=0;j<reduceSize;++j){var value=aVals[offset+j];max<value&&(max=value)}vals[i]=max}return result},MathBackendCPU.prototype.maximum=function(a,b){return this.assertNotComplex([a,b],"maximum"),this.broadcastedBinaryOp(a,b,a.dtype,function(aVal,bVal){return Math.max(aVal,bVal)})},MathBackendCPU.prototype.all=function(x,axes){this.assertNotComplex(x,"all"),axis_util.assertAxesAreInnerMostDims("all",axes,x.rank);for(var _a=axis_util.computeOutAndReduceShapes(x.shape,axes),outShape=_a[0],reduceShape=_a[1],result=ops.zeros(outShape,x.dtype),reduceSize=util.sizeFromShape(reduceShape),vals=this.readSync(result.dataId),aVals=this.readSync(x.dataId),i=0;i<vals.length;++i){for(var offset=i*reduceSize,all=aVals[offset],j=0;j<reduceSize;++j){var value=aVals[offset+j];all=all&&value}vals[i]=all}return result},MathBackendCPU.prototype.any=function(x,axes){this.assertNotComplex(x,"any"),axis_util.assertAxesAreInnerMostDims("any",axes,x.rank);for(var _a=axis_util.computeOutAndReduceShapes(x.shape,axes),outShape=_a[0],reduceShape=_a[1],result=ops.zeros(outShape,x.dtype),reduceSize=util.sizeFromShape(reduceShape),vals=this.readSync(result.dataId),aVals=this.readSync(x.dataId),i=0;i<vals.length;++i){for(var offset=i*reduceSize,anyVal=aVals[offset],j=0;j<reduceSize;++j){var value=aVals[offset+j];anyVal=anyVal||value}vals[i]=anyVal}return result},MathBackendCPU.prototype.squaredDifference=function(a,b){return this.assertNotComplex([a,b],"squaredDifference"),this.broadcastedBinaryOp(a,b,a.dtype,function(aVal,bVal){var diff=aVal-bVal;return diff*diff})},MathBackendCPU.prototype.ceil=function(x){this.assertNotComplex(x,"ceil");for(var values=this.readSync(x.dataId),newValues=new Float32Array(values.length),i=0;i<values.length;++i)newValues[i]=Math.ceil(values[i]);return tensor_1.Tensor.make(x.shape,{values:newValues})},MathBackendCPU.prototype.floor=function(x){this.assertNotComplex(x,"floor");for(var values=this.readSync(x.dataId),newValues=new Float32Array(values.length),i=0;i<values.length;++i)newValues[i]=Math.floor(values[i]);return tensor_1.Tensor.make(x.shape,{values:newValues})},MathBackendCPU.prototype.sign=function(x){this.assertNotComplex(x,"x");for(var values=this.readSync(x.dataId),newValues=new Float32Array(values.length),i=0;i<values.length;++i)values[i]<0?newValues[i]=-1:0<values[i]?newValues[i]=1:newValues[i]=0;return tensor_1.Tensor.make(x.shape,{values:newValues})},MathBackendCPU.prototype.isNaN=function(x){this.assertNotComplex(x,"x");for(var values=this.readSync(x.dataId),newValues=new Uint8Array(values.length),i=0;i<values.length;++i)Number.isNaN(values[i])&&(newValues[i]=1);return tensor_1.Tensor.make(x.shape,{values:newValues},"bool")},MathBackendCPU.prototype.isInf=function(x){this.assertNotComplex(x,"x");for(var values=this.readSync(x.dataId),newValues=new Uint8Array(values.length),i=0;i<values.length;++i)Math.abs(values[i])===1/0&&(newValues[i]=1);return tensor_1.Tensor.make(x.shape,{values:newValues},"bool")},MathBackendCPU.prototype.isFinite=function(x){this.assertNotComplex(x,"x");for(var values=this.readSync(x.dataId),newValues=new Uint8Array(values.length),i=0;i<values.length;++i)Number.isFinite(values[i])&&(newValues[i]=1);return tensor_1.Tensor.make(x.shape,{values:newValues},"bool")},MathBackendCPU.prototype.round=function(x){this.assertNotComplex(x,"round");for(var values=this.readSync(x.dataId),newValues=new Float32Array(values.length),i=0;i<values.length;++i){var base=Math.floor(values[i]);values[i]-base<.5?newValues[i]=Math.floor(values[i]):.5<values[i]-base?newValues[i]=Math.ceil(values[i]):newValues[i]=base%2==0?base:base+1}return tensor_1.Tensor.make(x.shape,{values:newValues})},MathBackendCPU.prototype.exp=function(x){this.assertNotComplex(x,"exp");for(var values=this.readSync(x.dataId),newValues=new Float32Array(values.length),i=0;i<values.length;++i)newValues[i]=Math.exp(values[i]);return tensor_1.Tensor.make(x.shape,{values:newValues})},MathBackendCPU.prototype.expm1=function(x){this.assertNotComplex(x,"expm1");for(var values=this.readSync(x.dataId),newValues=new Float32Array(values.length),i=0;i<values.length;++i)newValues[i]=Math.expm1(values[i]);return tensor_1.Tensor.make(x.shape,{values:newValues})},MathBackendCPU.prototype.log=function(x){this.assertNotComplex(x,"log");for(var values=this.readSync(x.dataId),newValues=new Float32Array(values.length),i=0;i<values.length;++i){var value=values[i];newValues[i]=Math.log(value)}return tensor_1.Tensor.make(x.shape,{values:newValues})},MathBackendCPU.prototype.log1p=function(x){this.assertNotComplex(x,"log1p");for(var values=this.readSync(x.dataId),newValues=new Float32Array(values.length),i=0;i<values.length;++i){var value=values[i];newValues[i]=Math.log1p(value)}return tensor_1.Tensor.make(x.shape,{values:newValues})},MathBackendCPU.prototype.sqrt=function(x){this.assertNotComplex(x,"sqrt");for(var values=this.readSync(x.dataId),newValues=new Float32Array(values.length),i=0;i<values.length;++i){var value=values[i];newValues[i]=Math.sqrt(value)}return tensor_1.Tensor.make(x.shape,{values:newValues})},MathBackendCPU.prototype.rsqrt=function(x){this.assertNotComplex(x,"rsqrt");for(var values=this.readSync(x.dataId),newValues=new Float32Array(values.length),i=0;i<values.length;++i){var value=values[i];newValues[i]=1/Math.sqrt(value)}return tensor_1.Tensor.make(x.shape,{values:newValues})},MathBackendCPU.prototype.square=function(x){this.assertNotComplex(x,"square");for(var values=this.readSync(x.dataId),newValues=new Float32Array(values.length),i=0;i<values.length;++i){var value=values[i];newValues[i]=value*value}return tensor_1.Tensor.make(x.shape,{values:newValues})},MathBackendCPU.prototype.reciprocal=function(x){this.assertNotComplex(x,"reciprocal");for(var values=this.readSync(x.dataId),newValues=new Float32Array(values.length),i=0;i<values.length;++i)newValues[i]=1/values[i];return tensor_1.Tensor.make(x.shape,{values:newValues})},MathBackendCPU.prototype.linear=function(x){return x},MathBackendCPU.prototype.relu=function(x){this.assertNotComplex(x,"relu");for(var res=ops.zeros(x.shape,x.dtype),resVals=this.readSync(res.dataId),inVals=this.readSync(x.dataId),i=0;i<inVals.length;++i)resVals[i]=Math.max(0,inVals[i]);return res},MathBackendCPU.prototype.prelu=function(x,a){return this.assertNotComplex([x,a],"prelu"),this.broadcastedBinaryOp(x,a,x.dtype,function(xValue,aValue){return xValue<0?aValue*xValue:xValue})},MathBackendCPU.prototype.elu=function(x){this.assertNotComplex(x,"elu");for(var resultValues=new Float32Array(x.size),values=this.readSync(x.dataId),i=0;i<values.length;++i){var v=values[i];resultValues[i]=0<=v?v:Math.exp(v)-1}return tensor_1.Tensor.make(x.shape,{values:resultValues})},MathBackendCPU.prototype.eluDer=function(dy,y){this.assertNotComplex([dy,y],"eluDer");for(var resultValues=new Float32Array(y.size),values=this.readSync(y.dataId),dyValues=this.readSync(dy.dataId),i=0;i<values.length;++i){var v=values[i];resultValues[i]=1<=v?dyValues[i]:dyValues[i]*(v+1)}return tensor_1.Tensor.make(y.shape,{values:resultValues})},MathBackendCPU.prototype.selu=function(x){this.assertNotComplex(x,"selu");for(var scaleAlpha=selu_util.SELU_SCALEALPHA,scale=selu_util.SELU_SCALE,resultValues=new Float32Array(x.size),values=this.readSync(x.dataId),i=0;i<values.length;++i){var v=values[i];resultValues[i]=0<=v?scale*v:scaleAlpha*(Math.exp(v)-1)}return tensor_1.Tensor.make(x.shape,{values:resultValues})},MathBackendCPU.prototype.clip=function(x,min,max){this.assertNotComplex(x,"clip");for(var resultValues=new Float32Array(x.size),values=this.readSync(x.dataId),i=0;i<values.length;++i){var v=values[i];resultValues[i]=max<v?max:v<min?min:v}return tensor_1.Tensor.make(x.shape,{values:resultValues})},MathBackendCPU.prototype.abs=function(x){for(var resultValues=new Float32Array(x.size),values=this.readSync(x.dataId),i=0;i<values.length;++i)resultValues[i]=Math.abs(values[i]);return tensor_1.Tensor.make(x.shape,{values:resultValues})},MathBackendCPU.prototype.complexAbs=function(x){for(var resultValues=new Float32Array(x.size),values=this.readSync(x.dataId),i=0;i<x.size;++i){var real_1=values[2*i],imag_1=values[2*i+1];resultValues[i]=Math.hypot(real_1,imag_1)}return tensor_1.Tensor.make(x.shape,{values:resultValues})},MathBackendCPU.prototype.int=function(x){this.assertNotComplex(x,"int");for(var resultValues=new Int32Array(x.size),values=this.readSync(x.dataId),i=0;i<values.length;++i)resultValues[i]=values[i];return tensor_1.Tensor.make(x.shape,{values:resultValues},"int32")},MathBackendCPU.prototype.sigmoid=function(x){this.assertNotComplex(x,"sigmoid");for(var resultValues=new Float32Array(x.size),values=this.readSync(x.dataId),i=0;i<values.length;++i)resultValues[i]=1/(1+Math.exp(-values[i]));return tensor_1.Tensor.make(x.shape,{values:resultValues})},MathBackendCPU.prototype.softplus=function(x){this.assertNotComplex(x,"softplus");for(var threshold=Math.log(1.1920928955078125e-7)+2,resultValues=new Float32Array(x.size),values=this.readSync(x.dataId),i=0;i<values.length;++i){var tooLarge=values[i]>-threshold,tooSmall=values[i]<threshold,expX=Math.exp(values[i]),result=void 0;result=tooSmall?expX:tooLarge?values[i]:Math.log(1+expX),resultValues[i]=result}return tensor_1.Tensor.make(x.shape,{values:resultValues})},MathBackendCPU.prototype.sin=function(x){this.assertNotComplex(x,"sin");for(var resultValues=new Float32Array(x.size),values=this.readSync(x.dataId),i=0;i<values.length;++i)resultValues[i]=Math.sin(values[i]);return tensor_1.Tensor.make(x.shape,{values:resultValues})},MathBackendCPU.prototype.cos=function(x){this.assertNotComplex(x,"cos");for(var resultValues=new Float32Array(x.size),values=this.readSync(x.dataId),i=0;i<values.length;++i)resultValues[i]=Math.cos(values[i]);return tensor_1.Tensor.make(x.shape,{values:resultValues})},MathBackendCPU.prototype.tan=function(x){this.assertNotComplex(x,"tan");for(var resultValues=new Float32Array(x.size),values=this.readSync(x.dataId),i=0;i<values.length;++i)resultValues[i]=Math.tan(values[i]);return tensor_1.Tensor.make(x.shape,{values:resultValues})},MathBackendCPU.prototype.asin=function(x){this.assertNotComplex(x,"asin");for(var resultValues=new Float32Array(x.size),values=this.readSync(x.dataId),i=0;i<values.length;++i)resultValues[i]=Math.asin(values[i]);return tensor_1.Tensor.make(x.shape,{values:resultValues})},MathBackendCPU.prototype.acos=function(x){this.assertNotComplex(x,"acos");for(var resultValues=new Float32Array(x.size),values=this.readSync(x.dataId),i=0;i<values.length;++i)resultValues[i]=Math.acos(values[i]);return tensor_1.Tensor.make(x.shape,{values:resultValues})},MathBackendCPU.prototype.atan=function(x){this.assertNotComplex(x,"atan");for(var resultValues=new Float32Array(x.size),values=this.readSync(x.dataId),i=0;i<values.length;++i)resultValues[i]=Math.atan(values[i]);return tensor_1.Tensor.make(x.shape,{values:resultValues})},MathBackendCPU.prototype.atan2=function(a,b){return this.assertNotComplex([a,b],"atan2"),this.broadcastedBinaryOp(a,b,a.dtype,function(aValue,bValue){return Math.atan2(aValue,bValue)})},MathBackendCPU.prototype.sinh=function(x){this.assertNotComplex(x,"sinh");for(var resultValues=new Float32Array(x.size),values=this.readSync(x.dataId),i=0;i<values.length;++i)resultValues[i]=Math.sinh(values[i]);return tensor_1.Tensor.make(x.shape,{values:resultValues})},MathBackendCPU.prototype.cosh=function(x){this.assertNotComplex(x,"cosh");for(var resultValues=new Float32Array(x.size),values=this.readSync(x.dataId),i=0;i<values.length;++i)resultValues[i]=Math.cosh(values[i]);return tensor_1.Tensor.make(x.shape,{values:resultValues})},MathBackendCPU.prototype.tanh=function(x){this.assertNotComplex(x,"tanh");for(var resultValues=new Float32Array(x.size),values=this.readSync(x.dataId),i=0;i<values.length;++i)resultValues[i]=util.tanh(values[i]);return tensor_1.Tensor.make(x.shape,{values:resultValues})},MathBackendCPU.prototype.asinh=function(x){this.assertNotComplex(x,"asinh");for(var resultValues=new Float32Array(x.size),values=this.readSync(x.dataId),i=0;i<values.length;++i)resultValues[i]=Math.asinh(values[i]);return tensor_1.Tensor.make(x.shape,{values:resultValues})},MathBackendCPU.prototype.acosh=function(x){this.assertNotComplex(x,"acosh");for(var resultValues=new Float32Array(x.size),values=this.readSync(x.dataId),i=0;i<values.length;++i)resultValues[i]=Math.acosh(values[i]);return tensor_1.Tensor.make(x.shape,{values:resultValues})},MathBackendCPU.prototype.atanh=function(x){this.assertNotComplex(x,"atanh");for(var resultValues=new Float32Array(x.size),values=this.readSync(x.dataId),i=0;i<values.length;++i)resultValues[i]=Math.atanh(values[i]);return tensor_1.Tensor.make(x.shape,{values:resultValues})},MathBackendCPU.prototype.erf=function(x){this.assertNotComplex(x,"erf");for(var resultValues=new Float32Array(x.size),values=this.readSync(x.dataId),p=erf_util.ERF_P,a1=erf_util.ERF_A1,a2=erf_util.ERF_A2,a3=erf_util.ERF_A3,a4=erf_util.ERF_A4,a5=erf_util.ERF_A5,i=0;i<values.length;++i){var v=values[i],t=1/(1+p*v);resultValues[i]=1-((((a5*t+a4)*t+a3)*t+a2)*t+a1)*t*Math.exp(-v*v)}return tensor_1.Tensor.make(x.shape,{values:resultValues})},MathBackendCPU.prototype.step=function(x,alpha){void 0===alpha&&(alpha=0),this.assertNotComplex(x,"step");for(var resultValues=new Float32Array(x.size),values=this.readSync(x.dataId),i=0;i<values.length;++i){var value=values[i];isNaN(value)?resultValues[i]=NaN:resultValues[i]=0<value?1:alpha}return tensor_1.Tensor.make(x.shape,{values:resultValues})},MathBackendCPU.prototype.fusedConv2d=function(x,filter,convInfo,bias,activation,preluActivationWeights){var result=this.conv2d(x,filter,convInfo);return bias&&(result=this.add(result,bias)),activation&&(result=mapActivation(this,result,activation,preluActivationWeights)),result},MathBackendCPU.prototype.conv2d=function(x,filter,convInfo){this.assertNotComplex([x,filter],"conv2d");for(var filterHeight=convInfo.filterHeight,filterWidth=convInfo.filterWidth,dilationHeight=convInfo.dilationHeight,dilationWidth=convInfo.dilationWidth,padLeft=convInfo.padInfo.left,padTop=convInfo.padInfo.top,isChannelsLast="channelsLast"===convInfo.dataFormat,y=ops.buffer(convInfo.outShape,x.dtype),xBatchStride=x.strides[0],xRowStride=isChannelsLast?x.strides[1]:x.strides[2],xColStride=isChannelsLast?x.strides[2]:1,xChannelStride=isChannelsLast?1:x.strides[1],yBatchStride=y.strides[0],yRowStride=isChannelsLast?y.strides[1]:y.strides[2],yColStride=isChannelsLast?y.strides[2]:1,yChannelStride=isChannelsLast?1:y.strides[1],xVals=this.readSync(x.dataId),wVals=this.readSync(filter.dataId),yVals=y.values,b=0;b<convInfo.batchSize;++b)for(var xOffset1=b*xBatchStride,yOffset1=b*yBatchStride,yR=0;yR<convInfo.outHeight;++yR)for(var yOffset2=yOffset1+yR*yRowStride,xRCorner=yR*convInfo.strideHeight-padTop,wR=0;wR<filterHeight;wR++){var xR=xRCorner+wR*dilationHeight;if(!(xR<0||xR>=convInfo.inHeight))for(var wOffset1=wR*filter.strides[0],xOffset2=xOffset1+xR*xRowStride,yC=0;yC<convInfo.outWidth;++yC)for(var yOffset3=yOffset2+yC*yColStride,xCCorner=yC*convInfo.strideWidth-padLeft,wC=0;wC<filterWidth;wC++){var xC=xCCorner+wC*dilationWidth;if(!(xC<0||xC>=convInfo.inWidth))for(var xOffset3=xOffset2+xC*xColStride,wOffset3=wOffset1+wC*filter.strides[1],d1=0;d1<convInfo.inChannels;++d1){for(var xVal=xVals[xOffset3+d1*xChannelStride],d2=0;d2<convInfo.outChannels;++d2)yVals[yOffset3+d2*yChannelStride]+=xVal*wVals[wOffset3+d2];wOffset3+=convInfo.outChannels}}}return y.toTensor()},MathBackendCPU.prototype.conv3d=function(x,filter,convInfo){for(var filterDepth=convInfo.filterDepth,filterHeight=convInfo.filterHeight,filterWidth=convInfo.filterWidth,dilationDepth=convInfo.dilationDepth,dilationHeight=convInfo.dilationHeight,dilationWidth=convInfo.dilationWidth,padFront=convInfo.padInfo.front,padLeft=convInfo.padInfo.left,padTop=convInfo.padInfo.top,y=ops.buffer(convInfo.outShape,x.dtype),xVals=this.readSync(x.dataId),wVals=this.readSync(filter.dataId),yVals=y.values,b=0;b<convInfo.batchSize;++b)for(var xOffset1=b*x.strides[0],yOffset1=b*y.strides[0],yF=0;yF<convInfo.outDepth;++yF)for(var yOffset2=yOffset1+yF*y.strides[1],xFCorner=yF*convInfo.strideDepth-padFront,wF=0;wF<filterDepth;wF++){var xF=xFCorner+wF*dilationDepth;if(!(xF<0||xF>=convInfo.inDepth))for(var wOffset1=wF*filter.strides[0],xOffset2=xOffset1+xF*x.strides[1],yR=0;yR<convInfo.outHeight;++yR)for(var yOffset3=yOffset2+yR*y.strides[2],xRCorner=yR*convInfo.strideHeight-padTop,wR=0;wR<filterHeight;wR++){var xR=xRCorner+wR*dilationHeight;if(!(xR<0||xR>=convInfo.inHeight))for(var wOffset2=wOffset1+wR*filter.strides[1],xOffset3=xOffset2+xR*x.strides[2],yC=0;yC<convInfo.outWidth;++yC)for(var yOffset4=yOffset3+yC*convInfo.outChannels,xCCorner=yC*convInfo.strideWidth-padLeft,wC=0;wC<filterWidth;wC++){var xC=xCCorner+wC*dilationWidth;if(!(xC<0||xC>=convInfo.inWidth))for(var wOffset3=wOffset2+wC*filter.strides[2],xOffset4=xOffset3+xC*convInfo.inChannels,wOffset4=wOffset3,d1=0;d1<convInfo.inChannels;++d1){for(var xVal=xVals[xOffset4+d1],d2=0;d2<convInfo.outChannels;++d2)yVals[yOffset4+d2]+=xVal*wVals[wOffset4+d2];wOffset4+=convInfo.outChannels}}}}return y.toTensor()},MathBackendCPU.prototype.conv2dDerInput=function(dy,filter,convInfo){this.assertNotComplex([dy,filter],"conv2dDerInput");for(var dx=ops.buffer(convInfo.inShape,"float32"),dxValues=dx.values,dyValues=this.readSync(dy.dataId),fltValues=this.readSync(filter.dataId),_a=filter.strides,fltS0=_a[0],fltS1=_a[1],fltS2=_a[2],batchSize=convInfo.batchSize,filterHeight=convInfo.filterHeight,filterWidth=convInfo.filterWidth,inChannels=convInfo.inChannels,inHeight=convInfo.inHeight,inWidth=convInfo.inWidth,outChannels=convInfo.outChannels,outHeight=convInfo.outHeight,outWidth=convInfo.outWidth,strideHeight=convInfo.strideHeight,strideWidth=convInfo.strideWidth,dataFormat=convInfo.dataFormat,topPad=filterHeight-1-convInfo.padInfo.top,leftPad=filterWidth-1-convInfo.padInfo.left,isChannelsLast="channelsLast"===dataFormat,xBatchStride=dx.strides[0],xRowStride=isChannelsLast?dx.strides[1]:dx.strides[2],xColStride=isChannelsLast?dx.strides[2]:1,xChannelStride=isChannelsLast?1:dx.strides[1],yBatchStride=dy.strides[0],yRowStride=isChannelsLast?dy.strides[1]:dy.strides[2],yColStride=isChannelsLast?dy.strides[2]:1,yChannelStride=isChannelsLast?1:dy.strides[1],b=0;b<batchSize;++b)for(var d1=0;d1<inChannels;++d1)for(var xR=0;xR<inHeight;++xR)for(var xRCorner=xR-topPad,xRMin=Math.max(0,Math.ceil(xRCorner/strideHeight)),yRMax=Math.min(outHeight,(filterHeight+xRCorner)/strideHeight),xC=0;xC<inWidth;++xC){for(var xCCorner=xC-leftPad,xCMin=Math.max(0,Math.ceil(xCCorner/strideWidth)),yCMax=Math.min(outWidth,(filterWidth+xCCorner)/strideWidth),dotProd=0,yR=xRMin;yR<yRMax;++yR)for(var wR=yR*strideHeight-xRCorner,yC=xCMin;yC<yCMax;++yC)for(var dyOffset=yBatchStride*b+yRowStride*yR+yColStride*yC,fltOffset=fltS0*(filterHeight-1-wR)+fltS1*(filterWidth-1-(yC*strideWidth-xCCorner))+fltS2*d1,d2=0;d2<outChannels;++d2){dotProd+=dyValues[dyOffset+yChannelStride*d2]*fltValues[fltOffset+d2]}dxValues[xBatchStride*b+xRowStride*xR+xColStride*xC+xChannelStride*d1]=dotProd}return dx.toTensor()},MathBackendCPU.prototype.conv3dDerInput=function(dy,filter,convInfo){for(var dx=ops.buffer(convInfo.inShape,"float32"),dxValues=dx.values,_a=dx.strides,dxS0=_a[0],dxS1=_a[1],dxS2=_a[2],dxS3=_a[3],dyValues=this.readSync(dy.dataId),_b=dy.strides,dyS0=_b[0],dyS1=_b[1],dyS2=_b[2],dyS3=_b[3],fltValues=this.readSync(filter.dataId),_c=filter.strides,fltS0=_c[0],fltS1=_c[1],fltS2=_c[2],fltS3=_c[3],batchSize=convInfo.batchSize,filterDepth=convInfo.filterDepth,filterHeight=convInfo.filterHeight,filterWidth=convInfo.filterWidth,inChannels=convInfo.inChannels,inDepth=convInfo.inDepth,inHeight=convInfo.inHeight,inWidth=convInfo.inWidth,outChannels=convInfo.outChannels,outDepth=convInfo.outDepth,outHeight=convInfo.outHeight,outWidth=convInfo.outWidth,strideDepth=convInfo.strideDepth,strideHeight=convInfo.strideHeight,strideWidth=convInfo.strideWidth,frontPad=filterDepth-1-convInfo.padInfo.front,topPad=filterHeight-1-convInfo.padInfo.top,leftPad=filterWidth-1-convInfo.padInfo.left,b=0;b<batchSize;++b)for(var d1=0;d1<inChannels;++d1)for(var xF=0;xF<inDepth;++xF)for(var xFCorner=xF-frontPad,xFMin=Math.max(0,Math.ceil(xFCorner/strideDepth)),yFMax=Math.min(outDepth,(filterDepth+xFCorner)/strideDepth),xR=0;xR<inHeight;++xR)for(var xRCorner=xR-topPad,xRMin=Math.max(0,Math.ceil(xRCorner/strideHeight)),yRMax=Math.min(outHeight,(filterHeight+xRCorner)/strideHeight),xC=0;xC<inWidth;++xC){for(var xCCorner=xC-leftPad,xCMin=Math.max(0,Math.ceil(xCCorner/strideWidth)),yCMax=Math.min(outWidth,(filterWidth+xCCorner)/strideWidth),dotProd=0,yF=xFMin;yF<yFMax;++yF)for(var wF=yF*strideDepth-xFCorner,yR=xRMin;yR<yRMax;++yR)for(var wR=yR*strideHeight-xRCorner,yC=xCMin;yC<yCMax;++yC)for(var dyOffset=dyS0*b+dyS1*yF+dyS2*yR+dyS3*yC,fltOffset=fltS0*(filterDepth-1-wF)+fltS1*(filterHeight-1-wR)+fltS2*(filterWidth-1-(yC*strideWidth-xCCorner))+fltS3*d1,d2=0;d2<outChannels;++d2){dotProd+=dyValues[dyOffset+d2]*fltValues[fltOffset+d2]}dxValues[dxS0*b+dxS1*xF+dxS2*xR+dxS3*xC+d1]=dotProd}return dx.toTensor()},MathBackendCPU.prototype.conv2dDerFilter=function(x,dy,convInfo){this.assertNotComplex([x,dy],"conv2dDerFilter");for(var strideHeight=convInfo.strideHeight,strideWidth=convInfo.strideWidth,filterHeight=convInfo.filterHeight,filterWidth=convInfo.filterWidth,isChannelsLast="channelsLast"===convInfo.dataFormat,dW=ops.buffer(convInfo.filterShape,"float32"),leftPad=convInfo.padInfo.left,topPad=convInfo.padInfo.top,xBuf=this.bufferSync(x),dyBuf=this.bufferSync(dy),wR=0;wR<filterHeight;++wR)for(var yRMin=Math.max(0,Math.ceil((topPad-wR)/strideHeight)),yRMax=Math.min(convInfo.outHeight,(convInfo.inHeight+topPad-wR)/strideHeight),wC=0;wC<filterWidth;++wC)for(var yCMin=Math.max(0,Math.ceil((leftPad-wC)/strideWidth)),yCMax=Math.min(convInfo.outWidth,(convInfo.inWidth+leftPad-wC)/strideWidth),d1=0;d1<convInfo.inChannels;++d1)for(var d2=0;d2<convInfo.outChannels;++d2){for(var dotProd=0,b=0;b<convInfo.batchSize;++b)for(var yR=yRMin;yR<yRMax;++yR)for(var xR=wR+yR*strideHeight-topPad,yC=yCMin;yC<yCMax;++yC){var xC=wC+yC*strideWidth-leftPad;dotProd+=isChannelsLast?xBuf.get(b,xR,xC,d1)*dyBuf.get(b,yR,yC,d2):xBuf.get(b,d1,xR,xC)*dyBuf.get(b,d2,yR,yC)}dW.set(dotProd,wR,wC,d1,d2)}return dW.toTensor()},MathBackendCPU.prototype.conv3dDerFilter=function(x,dy,convInfo){for(var strideDepth=convInfo.strideDepth,strideHeight=convInfo.strideHeight,strideWidth=convInfo.strideWidth,filterDepth=convInfo.filterDepth,filterHeight=convInfo.filterHeight,filterWidth=convInfo.filterWidth,dw=ops.buffer(convInfo.filterShape,"float32"),dwValues=dw.values,_a=dw.strides,dwS0=_a[0],dwS1=_a[1],dwS2=_a[2],dwS3=_a[3],dyValues=this.readSync(dy.dataId),_b=dy.strides,dyS0=_b[0],dyS1=_b[1],dyS2=_b[2],dyS3=_b[3],xValues=this.readSync(x.dataId),_c=x.strides,xS0=_c[0],xS1=_c[1],xS2=_c[2],xS3=_c[3],frontPad=convInfo.padInfo.front,leftPad=convInfo.padInfo.left,topPad=convInfo.padInfo.top,wF=0;wF<filterDepth;++wF)for(var yFMin=Math.max(0,Math.ceil((frontPad-wF)/strideDepth)),yFMax=Math.min(convInfo.outDepth,(convInfo.inDepth+frontPad-wF)/strideDepth),wOffset1=wF*dwS0,wR=0;wR<filterHeight;++wR)for(var yRMin=Math.max(0,Math.ceil((topPad-wR)/strideHeight)),yRMax=Math.min(convInfo.outHeight,(convInfo.inHeight+topPad-wR)/strideHeight),wOffset2=wR*dwS1+wOffset1,wC=0;wC<filterWidth;++wC)for(var yCMin=Math.max(0,Math.ceil((leftPad-wC)/strideWidth)),yCMax=Math.min(convInfo.outWidth,(convInfo.inWidth+leftPad-wC)/strideWidth),wOffset3=wC*dwS2+wOffset2,d1=0;d1<convInfo.inChannels;++d1)for(var wOffset4=d1*dwS3+wOffset3,d2=0;d2<convInfo.outChannels;++d2){for(var dotProd=0,b=0;b<convInfo.batchSize;++b)for(var xOffset1=b*xS0,yOffset1=b*dyS0,yF=yFMin;yF<yFMax;++yF)for(var xOffset2=(wF+yF*strideDepth-frontPad)*xS1+xOffset1,yOffset2=yF*dyS1+yOffset1,yR=yRMin;yR<yRMax;++yR)for(var xOffset3=(wR+yR*strideHeight-topPad)*xS2+xOffset2,yOffset3=yR*dyS2+yOffset2,yC=yCMin;yC<yCMax;++yC){var yOffset4=yC*dyS3+yOffset3;dotProd+=xValues[(wC+yC*strideWidth-leftPad)*xS3+xOffset3+d1]*dyValues[yOffset4+d2]}dwValues[wOffset4+d2]=dotProd}return dw.toTensor()},MathBackendCPU.prototype.depthwiseConv2D=function(x,filter,convInfo){this.assertNotComplex([x,filter],"depthwiseConv2D");for(var filterHeight=convInfo.filterHeight,filterWidth=convInfo.filterWidth,dilationHeight=convInfo.dilationHeight,dilationWidth=convInfo.dilationWidth,padLeft=convInfo.padInfo.left,padTop=convInfo.padInfo.top,chMul=convInfo.outChannels/convInfo.inChannels,y=ops.buffer(convInfo.outShape,x.dtype),xVals=this.readSync(x.dataId),wVals=this.readSync(filter.dataId),yVals=y.values,b=0;b<convInfo.batchSize;++b)for(var xOffset1=b*x.strides[0],yOffset1=b*y.strides[0],yR=0;yR<convInfo.outHeight;++yR)for(var yOffset2=yOffset1+yR*y.strides[1],xRCorner=yR*convInfo.strideHeight-padLeft,wR=0;wR<filterHeight;++wR){var xR=xRCorner+wR*dilationHeight;if(!(xR<0||xR>=convInfo.inHeight))for(var wOffset1=wR*filter.strides[0],xOffset2=xOffset1+xR*x.strides[1],yC=0;yC<convInfo.outWidth;++yC)for(var yOffset3=yOffset2+yC*y.strides[2],xCCorner=yC*convInfo.strideWidth-padTop,wC=0;wC<filterWidth;++wC){var xC=xCCorner+wC*dilationWidth;if(!(xC<0||xC>=convInfo.inWidth))for(var wOffset2=wOffset1+wC*filter.strides[1],xOffset3=xOffset2+xC*convInfo.inChannels,yOffset4=yOffset3,wOffset3=wOffset2,d1=0;d1<convInfo.inChannels;++d1){for(var xVal=xVals[xOffset3+d1],q=0;q<chMul;++q)yVals[yOffset4+q]+=xVal*wVals[wOffset3+q];yOffset4+=chMul,wOffset3+=chMul}}}return y.toTensor()},MathBackendCPU.prototype.depthwiseConv2DDerInput=function(dy,filter,convInfo){this.assertNotComplex([dy,filter],"depthwiseConv2DDerInput");for(var dx=ops.buffer(convInfo.inShape,"float32"),dxValues=dx.values,_a=dx.strides,dxS0=_a[0],dxS1=_a[1],dxS2=_a[2],dyValues=this.readSync(dy.dataId),_b=dy.strides,dyS0=_b[0],dyS1=_b[1],dyS2=_b[2],fltValues=this.readSync(filter.dataId),_c=filter.strides,fltS0=_c[0],fltS1=_c[1],fltS2=_c[2],batchSize=convInfo.batchSize,filterHeight=convInfo.filterHeight,filterWidth=convInfo.filterWidth,inChannels=convInfo.inChannels,inHeight=convInfo.inHeight,inWidth=convInfo.inWidth,outChannels=convInfo.outChannels,outHeight=convInfo.outHeight,outWidth=convInfo.outWidth,strideHeight=convInfo.strideHeight,strideWidth=convInfo.strideWidth,topPad=filterHeight-1-convInfo.padInfo.top,leftPad=filterWidth-1-convInfo.padInfo.left,chMul=outChannels/inChannels,b=0;b<batchSize;++b)for(var d1=0;d1<inChannels;++d1)for(var xR=0;xR<inHeight;++xR)for(var xRCorner=xR-topPad,xRMin=Math.max(0,Math.ceil(xRCorner/strideHeight)),yRMax=Math.min(outHeight,(filterHeight+xRCorner)/strideHeight),xC=0;xC<inWidth;++xC){for(var xCCorner=xC-leftPad,xCMin=Math.max(0,Math.ceil(xCCorner/strideWidth)),yCMax=Math.min(outWidth,(filterWidth+xCCorner)/strideWidth),dotProd=0,yR=xRMin;yR<yRMax;++yR)for(var wR=yR*strideHeight-xRCorner,yC=xCMin;yC<yCMax;++yC)for(var dyOffset=dyS0*b+dyS1*yR+dyS2*yC,fltOffset=fltS0*(filterHeight-1-wR)+fltS1*(filterWidth-1-(yC*strideWidth-xCCorner))+fltS2*d1,dm=0;dm<chMul;++dm){dotProd+=dyValues[dyOffset+(d1*chMul+dm)]*fltValues[fltOffset+dm]}dxValues[dxS0*b+dxS1*xR+dxS2*xC+d1]=dotProd}return dx.toTensor()},MathBackendCPU.prototype.depthwiseConv2DDerFilter=function(x,dy,convInfo){this.assertNotComplex([x,dy],"depthwiseConv2DDerFilter");for(var strideHeight=convInfo.strideHeight,strideWidth=convInfo.strideWidth,filterHeight=convInfo.filterHeight,filterWidth=convInfo.filterWidth,dW=ops.buffer(convInfo.filterShape,"float32"),leftPad=convInfo.padInfo.left,topPad=convInfo.padInfo.top,chMul=convInfo.outChannels/convInfo.inChannels,xBuf=this.bufferSync(x),dyBuf=this.bufferSync(dy),wR=0;wR<filterHeight;++wR)for(var yRMin=Math.max(0,Math.ceil((topPad-wR)/strideHeight)),yRMax=Math.min(convInfo.outHeight,(convInfo.inHeight+topPad-wR)/strideHeight),wC=0;wC<filterWidth;++wC)for(var yCMin=Math.max(0,Math.ceil((leftPad-wC)/strideWidth)),yCMax=Math.min(convInfo.outWidth,(convInfo.inWidth+leftPad-wC)/strideWidth),d2=0;d2<convInfo.outChannels;++d2){for(var d1=Math.trunc(d2/chMul),dm=d2%chMul,dotProd=0,b=0;b<convInfo.batchSize;++b)for(var yR=yRMin;yR<yRMax;++yR)for(var xR=wR+yR*strideHeight-topPad,yC=yCMin;yC<yCMax;++yC){var xC=wC+yC*strideWidth-leftPad;dotProd+=xBuf.get(b,xR,xC,d1)*dyBuf.get(b,yR,yC,d2)}dW.set(dotProd,wR,wC,d1,dm)}return dW.toTensor()},MathBackendCPU.prototype.tile=function(x,reps){return this.assertNotComplex(x,"tile"),tile_impl_1.tile(this.bufferSync(x),reps)},MathBackendCPU.prototype.pad=function(x,paddings,constantValue){this.assertNotComplex(x,"pad");var outShape=paddings.map(function(p,i){return p[0]+x.shape[i]+p[1]}),start=paddings.map(function(p){return p[0]}),xBuffer=this.bufferSync(x),buffer=ops.buffer(outShape,x.dtype);0!==constantValue&&buffer.values.fill(constantValue);for(var i=0;i<x.size;i++){var coords=xBuffer.indexToLoc(i),outCoords=coords.map(function(c,i){return c+start[i]});buffer.set.apply(buffer,[xBuffer.get.apply(xBuffer,coords)].concat(outCoords))}return buffer.toTensor()},MathBackendCPU.prototype.transpose=function(x,perm){this.assertNotComplex(x,"transpose");for(var newShape=new Array(x.rank),i=0;i<newShape.length;i++)newShape[i]=x.shape[perm[i]];var values=this.readSync(x.dataId),result=ops_1.buffer(newShape,x.dtype),xBuf=this.bufferSync(x);for(i=0;i<x.size;++i){for(var loc=xBuf.indexToLoc(i),newLoc=new Array(loc.length),i_1=0;i_1<newLoc.length;i_1++)newLoc[i_1]=loc[perm[i_1]];var newIndex=result.locToIndex(newLoc);result.values[newIndex]=values[i]}return result.toTensor()},MathBackendCPU.prototype.gather=function(x,indices,axis){this.assertNotComplex([x,indices],"gather");var newShape=x.shape.slice(),indicesValues=this.readSync(indices.dataId);newShape[axis]=indicesValues.length;for(var result=ops_1.buffer(newShape,x.dtype),xBuf=this.bufferSync(x),i=0;i<result.size;++i){var newLoc=result.indexToLoc(i),originalLoc=newLoc.slice();originalLoc[axis]=indicesValues[newLoc[axis]];var originalIndex=xBuf.locToIndex(originalLoc);result.values[i]=xBuf.values[originalIndex]}return result.toTensor()},MathBackendCPU.prototype.batchToSpaceND=function(x,blockShape,crops){this.assertNotComplex([x],"batchToSpaceND");var prod=blockShape.reduce(function(a,b){return a*b}),reshaped=array_ops_util.getReshaped(x.shape,blockShape,prod),permuted=array_ops_util.getPermuted(reshaped.length,blockShape.length),reshapedPermuted=array_ops_util.getReshapedPermuted(x.shape,blockShape,prod),sliceBeginCoords=array_ops_util.getSliceBeginCoords(crops,blockShape.length),sliceSize=array_ops_util.getSliceSize(reshapedPermuted,crops,blockShape.length);return x.reshape(reshaped).transpose(permuted).reshape(reshapedPermuted).slice(sliceBeginCoords,sliceSize)},MathBackendCPU.prototype.spaceToBatchND=function(x,blockShape,paddings){this.assertNotComplex([x],"spaceToBatchND");var prod=blockShape.reduce(function(a,b){return a*b}),completePaddings=[[0,0]];completePaddings.push.apply(completePaddings,paddings);for(var i=1+blockShape.length;i<x.shape.length;++i)completePaddings.push([0,0]);var paddedX=x.pad(completePaddings),reshapedPaddedShape=array_ops_util.getReshaped(paddedX.shape,blockShape,prod,!1),permutedReshapedPaddedPermutation=array_ops_util.getPermuted(reshapedPaddedShape.length,blockShape.length,!1),flattenShape=array_ops_util.getReshapedPermuted(paddedX.shape,blockShape,prod,!1);return paddedX.reshape(reshapedPaddedShape).transpose(permutedReshapedPaddedPermutation).reshape(flattenShape)},MathBackendCPU.prototype.pool=function(x,convInfo,poolType){this.assertNotComplex(x,"pool");for(var strideHeight=convInfo.strideHeight,strideWidth=convInfo.strideWidth,dilationHeight=convInfo.dilationHeight,dilationWidth=convInfo.dilationWidth,effectiveFilterHeight=convInfo.effectiveFilterHeight,effectiveFilterWidth=convInfo.effectiveFilterWidth,padTop=convInfo.padInfo.top,padLeft=convInfo.padInfo.left,initialValue="max"===poolType?Number.NEGATIVE_INFINITY:Number.POSITIVE_INFINITY,xValues=this.readSync(x.dataId),output=ops.buffer(convInfo.outShape,x.dtype),outputVals=output.values,outputBatchStrides=convInfo.outShape[1]*convInfo.outShape[2]*convInfo.outShape[3],outputRowStrides=convInfo.outShape[2]*convInfo.outShape[3],outputColStrides=convInfo.outShape[3],b=0;b<convInfo.batchSize;++b)for(var outputBatchOffset=b*outputBatchStrides,inputBatchOffset=b*x.strides[0],d=0;d<convInfo.inChannels;++d)for(var yR=0;yR<convInfo.outHeight;++yR)for(var xRCorner=yR*strideHeight-padTop,xRMin=Math.max(0,xRCorner),xRMax=Math.min(convInfo.inHeight,effectiveFilterHeight+xRCorner),outputRowOffset=outputBatchOffset+yR*outputRowStrides,yC=0;yC<convInfo.outWidth;++yC){for(var xCCorner=yC*strideWidth-padLeft,xCMin=Math.max(0,xCCorner),xCMax=Math.min(convInfo.inWidth,effectiveFilterWidth+xCCorner),minMaxValue=initialValue,avgValue=0,count=0,xR=xRMin;xR<xRMax;xR+=dilationHeight){for(var xROffset=inputBatchOffset+xR*x.strides[1],xC=xCMin;xC<xCMax;xC+=dilationWidth){var pixel=xValues[xROffset+xC*x.strides[2]+d];"max"===poolType&&minMaxValue<pixel?minMaxValue=pixel:"avg"===poolType&&(avgValue+=pixel,count++)}if(isNaN(minMaxValue))break}outputVals[outputRowOffset+yC*outputColStrides+d]="avg"===poolType?avgValue/count:minMaxValue}return output.toTensor()},MathBackendCPU.prototype.maxPool=function(x,convInfo){return this.pool(x,convInfo,"max")},MathBackendCPU.prototype.maxPoolPositions=function(x,convInfo){for(var maxPositions=ops.buffer(convInfo.outShape,"int32"),strideHeight=convInfo.strideHeight,strideWidth=convInfo.strideWidth,dilationHeight=convInfo.dilationHeight,dilationWidth=convInfo.dilationWidth,effectiveFilterHeight=convInfo.effectiveFilterHeight,effectiveFilterWidth=convInfo.effectiveFilterWidth,padTop=convInfo.padInfo.top,padLeft=convInfo.padInfo.left,xBuf=this.bufferSync(x),b=0;b<convInfo.batchSize;++b)for(var d=0;d<convInfo.inChannels;++d)for(var yR=0;yR<convInfo.outHeight;++yR){for(var xRCorner=yR*strideHeight-padTop,xRMin=xRCorner;xRMin<0;)xRMin+=dilationHeight;for(var xRMax=Math.min(convInfo.inHeight,effectiveFilterHeight+xRCorner),yC=0;yC<convInfo.outWidth;++yC){for(var xCCorner=yC*strideWidth-padLeft,xCMin=xCCorner;xCMin<0;)xCMin+=dilationWidth;for(var xCMax=Math.min(convInfo.inWidth,effectiveFilterWidth+xCCorner),maxValue=Number.NEGATIVE_INFINITY,maxPosition=-1,xR=xRMin;xR<xRMax;xR+=dilationHeight)for(var wR=xR-xRCorner,xC=xCMin;xC<xCMax;xC+=dilationWidth){var wC=xC-xCCorner,pixel=xBuf.get(b,xR,xC,d);maxValue<pixel&&(maxValue=pixel,maxPosition=wR*effectiveFilterWidth+wC)}maxPositions.set(maxPosition,b,yR,yC,d)}}return maxPositions.toTensor()},MathBackendCPU.prototype.maxPoolBackprop=function(dy,x,y,convInfo){this.assertNotComplex([x,y],"maxPoolBackprop");for(var maxPositions=this.maxPoolPositions(x,convInfo),strideHeight=convInfo.strideHeight,strideWidth=convInfo.strideWidth,dilationHeight=convInfo.dilationHeight,dilationWidth=convInfo.dilationWidth,effectiveFilterHeight=convInfo.effectiveFilterHeight,effectiveFilterWidth=convInfo.effectiveFilterWidth,padLeft=effectiveFilterWidth-1-convInfo.padInfo.left,padTop=effectiveFilterHeight-1-convInfo.padInfo.top,dx=ops.buffer(x.shape,"float32"),maxPosBuf=this.bufferSync(maxPositions),dyBuf=this.bufferSync(dy),b=0;b<convInfo.batchSize;++b)for(var d=0;d<convInfo.inChannels;++d)for(var dxR=0;dxR<convInfo.inHeight;++dxR)for(var dxC=0;dxC<convInfo.inWidth;++dxC){for(var dyRCorner=dxR-padTop,dyCCorner=dxC-padLeft,dotProd=0,wR=0;wR<effectiveFilterHeight;wR+=dilationHeight){var dyR=(dyRCorner+wR)/strideHeight;if(!(dyR<0||dyR>=convInfo.outHeight||Math.floor(dyR)!==dyR))for(var wC=0;wC<effectiveFilterWidth;wC+=dilationWidth){var dyC=(dyCCorner+wC)/strideWidth;if(!(dyC<0||dyC>=convInfo.outWidth||Math.floor(dyC)!==dyC)){var mask=effectiveFilterHeight*effectiveFilterWidth-1-maxPosBuf.get(b,dyR,dyC,d)===wR*effectiveFilterWidth+wC?1:0;if(0!=mask)dotProd+=dyBuf.get(b,dyR,dyC,d)*mask}}}dx.set(dotProd,b,dxR,dxC,d)}return dx.toTensor()},MathBackendCPU.prototype.avgPoolBackprop=function(dy,x,convInfo){this.assertNotComplex([dy,x],"avgPoolBackprop");for(var strideHeight=convInfo.strideHeight,strideWidth=convInfo.strideWidth,filterHeight=convInfo.filterHeight,filterWidth=convInfo.filterWidth,dilationHeight=convInfo.dilationHeight,dilationWidth=convInfo.dilationWidth,effectiveFilterHeight=convInfo.effectiveFilterHeight,effectiveFilterWidth=convInfo.effectiveFilterWidth,padLeft=effectiveFilterWidth-1-convInfo.padInfo.left,padTop=effectiveFilterHeight-1-convInfo.padInfo.top,dx=ops.buffer(x.shape,"float32"),avgMultiplier=1/(filterHeight*filterWidth),dyBuf=this.bufferSync(dy),b=0;b<convInfo.batchSize;++b)for(var d=0;d<convInfo.inChannels;++d)for(var dxR=0;dxR<convInfo.inHeight;++dxR)for(var dxC=0;dxC<convInfo.inWidth;++dxC){for(var dyRCorner=dxR-padTop,dyCCorner=dxC-padLeft,dotProd=0,wR=0;wR<effectiveFilterHeight;wR+=dilationHeight){var dyR=(dyRCorner+wR)/strideHeight;if(!(dyR<0||dyR>=convInfo.outHeight||Math.floor(dyR)!==dyR))for(var wC=0;wC<effectiveFilterWidth;wC+=dilationWidth){var dyC=(dyCCorner+wC)/strideWidth;if(!(dyC<0||dyC>=convInfo.outWidth||Math.floor(dyC)!==dyC))dotProd+=dyBuf.get(b,dyR,dyC,d)}}dx.set(dotProd*avgMultiplier,b,dxR,dxC,d)}return dx.toTensor()},MathBackendCPU.prototype.pool3d=function(x,convInfo,poolType){this.assertNotComplex(x,"pool3d");for(var strideDepth=convInfo.strideDepth,strideHeight=convInfo.strideHeight,strideWidth=convInfo.strideWidth,dilationDepth=convInfo.dilationDepth,dilationHeight=convInfo.dilationHeight,dilationWidth=convInfo.dilationWidth,effectiveFilterDepth=convInfo.effectiveFilterDepth,effectiveFilterHeight=convInfo.effectiveFilterHeight,effectiveFilterWidth=convInfo.effectiveFilterWidth,padFront=convInfo.padInfo.front,padTop=convInfo.padInfo.top,padLeft=convInfo.padInfo.left,initialValue="max"===poolType?Number.NEGATIVE_INFINITY:Number.POSITIVE_INFINITY,xValues=this.readSync(x.dataId),output=ops.buffer(convInfo.outShape,x.dtype),outputVals=output.values,outputBatchStrides=convInfo.outShape[1]*convInfo.outShape[2]*convInfo.outShape[3]*convInfo.outShape[4],outputDepthStrides=convInfo.outShape[2]*convInfo.outShape[3]*convInfo.outShape[4],outputRowStrides=convInfo.outShape[3]*convInfo.outShape[4],outputColStrides=convInfo.outShape[4],batch=0;batch<convInfo.batchSize;++batch)for(var outputBatchOffset=batch*outputBatchStrides,inputBatchOffset=batch*x.strides[0],channel=0;channel<convInfo.inChannels;++channel)for(var yDepth=0;yDepth<convInfo.outDepth;++yDepth){for(var xDepthCorner=yDepth*strideDepth-padFront,xDepthMin=xDepthCorner;xDepthMin<0;)xDepthMin+=dilationDepth;for(var xDepthMax=Math.min(convInfo.inDepth,effectiveFilterDepth+xDepthCorner),outputDepthOffset=outputBatchOffset+yDepth*outputDepthStrides,yRow=0;yRow<convInfo.outHeight;++yRow){for(var xRowCorner=yRow*strideHeight-padTop,xRowMin=xRowCorner;xRowMin<0;)xRowMin+=dilationHeight;for(var xRowMax=Math.min(convInfo.inHeight,effectiveFilterHeight+xRowCorner),outputRowOffset=outputDepthOffset+yRow*outputRowStrides,yCol=0;yCol<convInfo.outWidth;++yCol){for(var xColCorner=yCol*strideWidth-padLeft,xColMin=xColCorner;xColMin<0;)xColMin+=dilationWidth;for(var xColMax=Math.min(convInfo.inWidth,effectiveFilterWidth+xColCorner),outputColOffset=outputRowOffset+yCol*outputColStrides,minMaxValue=initialValue,avgValue=0,count=0,xDepth=xDepthMin;xDepth<xDepthMax;xDepth+=dilationDepth){for(var xDepthOffset=inputBatchOffset+xDepth*x.strides[1],xRow=xRowMin;xRow<xRowMax;xRow+=dilationHeight){for(var xRowOffset=xDepthOffset+xRow*x.strides[2],xCol=xColMin;xCol<xColMax;xCol+=dilationWidth){var pixel=xValues[xRowOffset+xCol*x.strides[3]+channel];if("max"===poolType&&minMaxValue<pixel?minMaxValue=pixel:"avg"===poolType&&(avgValue+=pixel,count++),isNaN(minMaxValue))break}if(isNaN(minMaxValue))break}if(isNaN(minMaxValue))break}outputVals[outputColOffset+channel]="avg"===poolType?avgValue/count:minMaxValue}}}return output.toTensor()},MathBackendCPU.prototype.avgPool3d=function(x,convInfo){return this.assertNotComplex(x,"avgPool3d"),this.pool3d(x,convInfo,"avg").toFloat()},MathBackendCPU.prototype.avgPool3dBackprop=function(dy,x,convInfo){this.assertNotComplex([dy,x],"avgPool3dBackprop");for(var strideDepth=convInfo.strideDepth,strideHeight=convInfo.strideHeight,strideWidth=convInfo.strideWidth,filterDepth=convInfo.filterDepth,filterHeight=convInfo.filterHeight,filterWidth=convInfo.filterWidth,dilationDepth=convInfo.dilationDepth,dilationHeight=convInfo.dilationHeight,dilationWidth=convInfo.dilationWidth,effectiveFilterDepth=convInfo.effectiveFilterDepth,effectiveFilterHeight=convInfo.effectiveFilterHeight,effectiveFilterWidth=convInfo.effectiveFilterWidth,padFront=effectiveFilterDepth-1-convInfo.padInfo.front,padLeft=effectiveFilterWidth-1-convInfo.padInfo.left,padTop=effectiveFilterHeight-1-convInfo.padInfo.top,dx=ops.buffer(x.shape,"float32"),avgMultiplier=1/(filterDepth*filterHeight*filterWidth),dyBuf=this.bufferSync(dy),batch=0;batch<convInfo.batchSize;++batch)for(var channel=0;channel<convInfo.inChannels;++channel)for(var dxDepth=0;dxDepth<convInfo.inDepth;++dxDepth)for(var dxRow=0;dxRow<convInfo.inHeight;++dxRow)for(var dxCol=0;dxCol<convInfo.inWidth;++dxCol){for(var dyDepthCorner=dxDepth-padFront,dyRowCorner=dxRow-padTop,dyColCorner=dxCol-padLeft,dotProd=0,wDepth=0;wDepth<effectiveFilterDepth;wDepth+=dilationDepth){var dyDepth=(dyDepthCorner+wDepth)/strideDepth;if(!(dyDepth<0||dyDepth>=convInfo.outDepth||Math.floor(dyDepth)!==dyDepth))for(var wRow=0;wRow<effectiveFilterHeight;wRow+=dilationHeight){var dyRow=(dyRowCorner+wRow)/strideHeight;if(!(dyRow<0||dyRow>=convInfo.outHeight||Math.floor(dyRow)!==dyRow))for(var wCol=0;wCol<effectiveFilterWidth;wCol+=dilationWidth){var dyCol=(dyColCorner+wCol)/strideWidth;if(!(dyCol<0||dyCol>=convInfo.outWidth||Math.floor(dyCol)!==dyCol))dotProd+=dyBuf.get(batch,dyDepth,dyRow,dyCol,channel)}}}dx.set(dotProd*avgMultiplier,batch,dxDepth,dxRow,dxCol,channel)}return dx.toTensor()},MathBackendCPU.prototype.maxPool3d=function(x,convInfo){return this.assertNotComplex(x,"maxPool3d"),this.pool3d(x,convInfo,"max").toFloat()},MathBackendCPU.prototype.maxPool3dPositions=function(x,convInfo){for(var maxPositions=ops.buffer(convInfo.outShape,"int32"),strideDepth=convInfo.strideDepth,strideHeight=convInfo.strideHeight,strideWidth=convInfo.strideWidth,dilationDepth=convInfo.dilationDepth,dilationHeight=convInfo.dilationHeight,dilationWidth=convInfo.dilationWidth,effectiveFilterDepth=convInfo.effectiveFilterDepth,effectiveFilterHeight=convInfo.effectiveFilterHeight,effectiveFilterWidth=convInfo.effectiveFilterWidth,padFront=convInfo.padInfo.front,padTop=convInfo.padInfo.top,padLeft=convInfo.padInfo.left,xBuf=this.bufferSync(x),batch=0;batch<convInfo.batchSize;++batch)for(var channel=0;channel<convInfo.inChannels;++channel)for(var yDepth=0;yDepth<convInfo.outDepth;++yDepth){for(var xDepthCorner=yDepth*strideDepth-padFront,xDepthMin=xDepthCorner;xDepthMin<0;)xDepthMin+=dilationDepth;for(var xDepthMax=Math.min(convInfo.inDepth,effectiveFilterDepth+xDepthCorner),yRow=0;yRow<convInfo.outHeight;++yRow){for(var xRowCorner=yRow*strideHeight-padTop,xRowMin=xRowCorner;xRowMin<0;)xRowMin+=dilationHeight;for(var xRowMax=Math.min(convInfo.inHeight,effectiveFilterHeight+xRowCorner),yCol=0;yCol<convInfo.outWidth;++yCol){for(var xColCorner=yCol*strideWidth-padLeft,xColMin=xColCorner;xColMin<0;)xColMin+=dilationWidth;for(var xColMax=Math.min(convInfo.inWidth,effectiveFilterWidth+xColCorner),maxValue=Number.NEGATIVE_INFINITY,maxPosition=-1,xDepth=xDepthMin;xDepth<xDepthMax;xDepth+=dilationDepth)for(var wDepth=xDepth-xDepthCorner,xRow=xRowMin;xRow<xRowMax;xRow+=dilationHeight)for(var wRow=xRow-xRowCorner,xCol=xColMin;xCol<xColMax;xCol+=dilationWidth){var wCol=xCol-xColCorner,pixel=xBuf.get(batch,xDepth,xRow,xCol,channel);maxValue<=pixel&&(maxValue=pixel,maxPosition=wDepth*effectiveFilterHeight*effectiveFilterWidth+wRow*effectiveFilterHeight+wCol)}maxPositions.set(maxPosition,batch,yDepth,yRow,yCol,channel)}}}return maxPositions.toTensor()},MathBackendCPU.prototype.maxPool3dBackprop=function(dy,x,y,convInfo){this.assertNotComplex([x,y],"maxPool3dBackprop");for(var maxPositions=this.maxPool3dPositions(x,convInfo),strideDepth=convInfo.strideDepth,strideHeight=convInfo.strideHeight,strideWidth=convInfo.strideWidth,dilationDepth=convInfo.dilationDepth,dilationHeight=convInfo.dilationHeight,dilationWidth=convInfo.dilationWidth,effectiveFilterDepth=convInfo.effectiveFilterDepth,effectiveFilterHeight=convInfo.effectiveFilterHeight,effectiveFilterWidth=convInfo.effectiveFilterWidth,padFront=effectiveFilterDepth-1-convInfo.padInfo.front,padLeft=effectiveFilterWidth-1-convInfo.padInfo.left,padTop=effectiveFilterHeight-1-convInfo.padInfo.top,dx=ops.buffer(x.shape,"float32"),maxPosBuf=this.bufferSync(maxPositions),dyBuf=this.bufferSync(dy),batch=0;batch<convInfo.batchSize;++batch)for(var channel=0;channel<convInfo.inChannels;++channel)for(var dxDepth=0;dxDepth<convInfo.inDepth;++dxDepth)for(var dxRow=0;dxRow<convInfo.inHeight;++dxRow)for(var dxCol=0;dxCol<convInfo.inWidth;++dxCol){for(var dyDepthCorner=dxDepth-padFront,dyRowCorner=dxRow-padTop,dyColCorner=dxCol-padLeft,dotProd=0,wDepth=0;wDepth<effectiveFilterDepth;wDepth+=dilationDepth){var dyDepth=(dyDepthCorner+wDepth)/strideDepth;if(!(dyDepth<0||dyDepth>=convInfo.outDepth||Math.floor(dyDepth)!==dyDepth))for(var wRow=0;wRow<effectiveFilterHeight;wRow+=dilationHeight){var dyRow=(dyRowCorner+wRow)/strideHeight;if(!(dyRow<0||dyRow>=convInfo.outHeight||Math.floor(dyRow)!==dyRow))for(var wCol=0;wCol<effectiveFilterWidth;wCol+=dilationWidth){var dyCol=(dyColCorner+wCol)/strideWidth;if(!(dyCol<0||dyCol>=convInfo.outWidth||Math.floor(dyCol)!==dyCol)){var mask=effectiveFilterDepth*effectiveFilterHeight*effectiveFilterWidth-1-maxPosBuf.get(batch,dyDepth,dyRow,dyCol,channel)===wDepth*effectiveFilterHeight*effectiveFilterWidth+wRow*effectiveFilterWidth+wCol?1:0;if(0!=mask)dotProd+=dyBuf.get(batch,dyDepth,dyRow,dyCol,channel)*mask}}}}dx.set(dotProd,batch,dxDepth,dxRow,dxCol,channel)}return dx.toTensor()},MathBackendCPU.prototype.cast=function(x,dtype){return backend_util.castTensor(x,dtype,this)},MathBackendCPU.prototype.reshape=function(x,shape){return backend_util.reshapeTensor(x,shape)},MathBackendCPU.prototype.avgPool=function(x,convInfo){return this.assertNotComplex(x,"avgPool"),this.pool(x,convInfo,"avg").toFloat()},MathBackendCPU.prototype.resizeBilinear=function(x,newHeight,newWidth,alignCorners){this.assertNotComplex(x,"resizeBilinear");for(var _a=x.shape,batch=_a[0],oldHeight=_a[1],oldWidth=_a[2],numChannels=_a[3],xValues=this.readSync(x.dataId),result=new Float32Array(util.sizeFromShape([batch,newHeight,newWidth,numChannels])),effectiveInputSize=[alignCorners&&1<newHeight?oldHeight-1:oldHeight,alignCorners&&1<newWidth?oldWidth-1:oldWidth],effectiveOutputSize=[alignCorners&&1<newHeight?newHeight-1:newHeight,alignCorners&&1<newWidth?newWidth-1:newWidth],outputIdx=0,effectiveRowSizeRatio=effectiveInputSize[0]/effectiveOutputSize[0],effectiveColSizeRatio=effectiveInputSize[1]/effectiveOutputSize[1],b=0;b<batch;b++)for(var r=0;r<newHeight;r++)for(var sourceFracRow=effectiveRowSizeRatio*r,sourceRowFloor=Math.floor(sourceFracRow),rowFrac=sourceFracRow-sourceRowFloor,sourceRowCeil=Math.min(oldHeight-1,Math.ceil(sourceFracRow)),topRowOffset=b*x.strides[0]+sourceRowFloor*x.strides[1],botRowOffset=b*x.strides[0]+sourceRowCeil*x.strides[1],c=0;c<newWidth;c++)for(var sourceFracCol=effectiveColSizeRatio*c,sourceColFloor=Math.floor(sourceFracCol),colFrac=sourceFracCol-sourceColFloor,sourceColCeil=Math.min(oldWidth-1,Math.ceil(sourceFracCol)),topLeftOffest=topRowOffset+sourceColFloor*x.strides[2],botLeftOffset=botRowOffset+sourceColFloor*x.strides[2],topRightOffset=topRowOffset+ +sourceColCeil*x.strides[2],botRightOffest=botRowOffset+sourceColCeil*x.strides[2],d=0;d<numChannels;d++){var topLeft=xValues[topLeftOffest+d],bottomLeft=xValues[botLeftOffset+d],top_1=topLeft+(xValues[topRightOffset+d]-topLeft)*colFrac,newValue=top_1+(bottomLeft+(xValues[botRightOffest+d]-bottomLeft)*colFrac-top_1)*rowFrac;result[outputIdx++]=newValue}return ops.tensor(result,[batch,newHeight,newWidth,numChannels])},MathBackendCPU.prototype.resizeBilinearBackprop=function(dy,x,alignCorners){this.assertNotComplex([dy,x],"resizeBilinearBackprop");for(var _a=x.shape,batch=_a[0],xHeight=_a[1],xWidth=_a[2],depth=_a[3],_b=dy.shape,yHeight=_b[1],yWidth=_b[2],output=new Float32Array(batch*xHeight*xWidth*depth),effectiveXSize=[alignCorners&&1<yHeight?xHeight-1:xHeight,alignCorners&&1<yWidth?xWidth-1:xWidth],effectiveYSize=[alignCorners&&1<yHeight?yHeight-1:yHeight,alignCorners&&1<yWidth?yWidth-1:yWidth],heightScale=effectiveXSize[0]/effectiveYSize[0],widthScale=effectiveXSize[1]/effectiveYSize[1],dyValues=this.readSync(dy.dataId),offset=0,b=0;b<batch;b++)for(var bOffset=b*x.strides[0],r=0;r<yHeight;r++)for(var dxR=r*heightScale,topDxRIndex=Math.floor(dxR),bottomDxRIndex=Math.min(Math.ceil(dxR),xHeight-1),topDxROffset=bOffset+topDxRIndex*x.strides[1],bottomDxROffset=bOffset+bottomDxRIndex*x.strides[1],dxRLerp=dxR-topDxRIndex,inverseDxRLerp=1-dxRLerp,c=0;c<yWidth;c++)for(var dxC=c*widthScale,leftDxCIndex=Math.floor(dxC),rightDxCIndex=Math.min(Math.ceil(dxC),xWidth-1),dxCLerp=dxC-leftDxCIndex,inverseDxCLerp=1-dxCLerp,topLeftRCOffset=topDxROffset+leftDxCIndex*x.strides[2],topRightRCOffset=topDxROffset+rightDxCIndex*x.strides[2],bottomLeftRCOffset=bottomDxROffset+leftDxCIndex*x.strides[2],bottomRightRCOffset=bottomDxROffset+rightDxCIndex*x.strides[2],inverseDxRLerpTimesInverseDxCLerp=inverseDxRLerp*inverseDxCLerp,inverseDxRLerpTimesDxCLerp=inverseDxRLerp*dxCLerp,dxRLerpTimesInverseDxCLerp=dxRLerp*inverseDxCLerp,dxRLerpTimesDxCLerp=dxRLerp*dxCLerp,d=0;d<depth;d++){var dyVal=dyValues[offset++];output[topLeftRCOffset+d]+=dyVal*inverseDxRLerpTimesInverseDxCLerp,output[topRightRCOffset+d]+=dyVal*inverseDxRLerpTimesDxCLerp,output[bottomLeftRCOffset+d]+=dyVal*dxRLerpTimesInverseDxCLerp,output[bottomRightRCOffset+d]+=dyVal*dxRLerpTimesDxCLerp}return ops.tensor4d(output,[batch,xWidth,xHeight,depth],x.dtype)},MathBackendCPU.prototype.resizeNearestNeighbor=function(x,newHeight,newWidth,alignCorners){this.assertNotComplex(x,"resizeNearestNeighbor");for(var _a=x.shape,batch=_a[0],oldHeight=_a[1],oldWidth=_a[2],numChannels=_a[3],xValues=this.readSync(x.dataId),output=new Float32Array(batch*newHeight*newWidth*numChannels),effectiveInputSize=[alignCorners&&1<newHeight?oldHeight-1:oldHeight,alignCorners&&1<newWidth?oldWidth-1:oldWidth],effectiveOutputSize=[alignCorners&&1<newHeight?newHeight-1:newHeight,alignCorners&&1<newWidth?newWidth-1:newWidth],effectiveRowSizeRatio=effectiveInputSize[0]/effectiveOutputSize[0],effectiveColSizeRatio=effectiveInputSize[1]/effectiveOutputSize[1],outputOffset=0,b=0;b<batch;b++)for(var batchOffset=b*x.strides[0],r=0;r<newHeight;r++)for(var sourceFracRow=effectiveRowSizeRatio*r,rowOffset=batchOffset+Math.min(oldHeight-1,alignCorners?Math.round(sourceFracRow):Math.floor(sourceFracRow))*x.strides[1],c=0;c<newWidth;c++)for(var sourceFracCol=effectiveColSizeRatio*c,colOffset=rowOffset+Math.min(oldWidth-1,alignCorners?Math.round(sourceFracCol):Math.floor(sourceFracCol))*x.strides[2],d=0;d<numChannels;d++){var newVal=xValues[colOffset+d];output[outputOffset++]=newVal}return ops.tensor(output,[batch,newHeight,newWidth,numChannels],x.dtype)},MathBackendCPU.prototype.resizeNearestNeighborBackprop=function(dy,x,alignCorners){this.assertNotComplex([dy,x],"resizeNearestNeighborBackprop");for(var _a=x.shape,batch=_a[0],xHeight=_a[1],xWidth=_a[2],depth=_a[3],_b=dy.shape,yHeight=_b[1],yWidth=_b[2],output=new Float32Array(batch*xHeight*xWidth*depth),dyValues=this.readSync(dy.dataId),effectiveXSize=[alignCorners&&1<yHeight?xHeight-1:xHeight,alignCorners&&1<yWidth?xWidth-1:xWidth],effectiveYSize=[alignCorners&&1<yHeight?yHeight-1:yHeight,alignCorners&&1<yWidth?yWidth-1:yWidth],heightScale=effectiveXSize[0]/effectiveYSize[0],widthScale=effectiveXSize[1]/effectiveYSize[1],invHeightScale=1/heightScale,invWidthScale=1/widthScale,winHeight=2*Math.ceil(invHeightScale)+2,winWidth=2*Math.ceil(invWidthScale)+2,b=0;b<batch;b++)for(var batchOffset=b*x.strides[0],r=0;r<xHeight;r++)for(var rowOffset=batchOffset+r*x.strides[1],startRLerp=Math.floor(r*invHeightScale),startDyR=Math.floor(startRLerp-winHeight/2),c=0;c<xWidth;c++)for(var colOffset=rowOffset+c*x.strides[2],startCLerp=Math.floor(c*invWidthScale),startDyC=Math.floor(startCLerp-winWidth/2),d=0;d<depth;d++){for(var accum=0,dyRIndex=0;dyRIndex<winHeight;dyRIndex++){var dyR=dyRIndex+startDyR;if(!(dyR<0||yHeight<=dyR)){var dyROffset=batchOffset+dyR*dy.strides[1],sourceFracRow=dyR*heightScale;if(r===Math.min(xHeight-1,alignCorners?Math.round(sourceFracRow):Math.floor(sourceFracRow)))for(var dyCIndex=0;dyCIndex<winWidth;dyCIndex++){var dyC=dyCIndex+startDyC;if(!(dyC<0||yWidth<=dyC)){var dyCOffset=dyROffset+dyC*dy.strides[2],sourceFracCol=dyC*widthScale;c===Math.min(xWidth-1,alignCorners?Math.round(sourceFracCol):Math.floor(sourceFracCol))&&(accum+=dyValues[dyCOffset+d])}}}}output[colOffset+d]=accum}return ops.tensor4d(output,x.shape,x.dtype)},MathBackendCPU.prototype.batchNormalization=function(x,mean,variance,varianceEpsilon,scale,offset){this.assertNotComplex([x,mean,variance,scale,offset],"batchNorm");for(var xVals=this.readSync(x.dataId),mVals=this.readSync(mean.dataId),varVals=this.readSync(variance.dataId),sVals=scale?this.readSync(scale.dataId):new Float32Array([1]),offVals=offset?this.readSync(offset.dataId):new Float32Array([0]),outVals=new Float32Array(xVals.length),offValsLength=offVals.length,sValsLength=sVals.length,varValsLength=varVals.length,mValsLength=mVals.length,offi=0,mi=0,si=0,vi=0,i=0;i<xVals.length;++i)outVals[i]=offVals[offi++]+(xVals[i]-mVals[mi++])*sVals[si++]/Math.sqrt(varVals[vi++]+varianceEpsilon),offValsLength<=offi&&(offi=0),mValsLength<=mi&&(mi=0),sValsLength<=si&&(si=0),varValsLength<=vi&&(vi=0);return ops_1.tensor4d(outVals,x.shape)},MathBackendCPU.prototype.localResponseNormalization4D=function(x,depthRadius,bias,alpha,beta){this.assertNotComplex(x,"localResponseNormalization4D");var channels=x.shape[3],maxD=channels-1,xValues=this.readSync(x.dataId),size=x.size,result=new Float32Array(size);function sumAcrossChannels(offset){for(var currentChannel=offset%channels,beginSumOffset=offset-currentChannel+Math.max(0,currentChannel-depthRadius),endSumOffset=offset-currentChannel+Math.min(currentChannel+depthRadius,maxD),sum=0;beginSumOffset<=endSumOffset;beginSumOffset++){var z=xValues[beginSumOffset];sum+=z*z}return sum}for(var offset=0;offset<size;offset++){var sum=sumAcrossChannels(offset),val=xValues[offset]*Math.pow(bias+alpha*sum,-beta);result[offset]=val}return ops.tensor4d(result,x.shape)},MathBackendCPU.prototype.LRNGrad=function(dy,inputImage,outputImage,depthRadius,bias,alpha,beta){this.assertNotComplex(dy,"LRNGrad");for(var channels=dy.shape[3],dyValues=this.readSync(dy.dataId),inputImageValues=this.readSync(inputImage.dataId),outputImageValues=this.readSync(outputImage.dataId),result=new Float32Array(dy.size),size=dy.size,offset=0;offset<size;offset++){for(var currentChannel=offset%channels,depthBegin=offset-currentChannel+Math.max(0,currentChannel-depthRadius),depthEnd=offset-currentChannel+Math.min(channels,currentChannel+depthRadius+1),norm=0,k=depthBegin;k<depthEnd;k++)norm+=Math.pow(inputImageValues[k],2);norm=alpha*norm+bias;for(k=depthBegin;k<depthEnd;k++){var dyi=-2*alpha*beta*inputImageValues[k]*outputImageValues[offset]/norm;offset===k&&(dyi+=Math.pow(norm,-beta)),dyi*=dyValues[offset],result[k]+=dyi}}return ops.tensor4d(result,dy.shape)},MathBackendCPU.prototype.multinomial=function(logits,normalized,numSamples,seed){this.assertNotComplex(logits,"multinomial");for(var probabilities=normalized?logits:ops.softmax(logits),batchSize=probabilities.shape[0],numEvents=probabilities.shape[1],res=ops.zeros([batchSize,numSamples],"int32"),resVals=this.readSync(res.dataId),probVals=this.readSync(probabilities.dataId),b=0;b<batchSize;++b){var offset=b*numEvents,cdf=new Float32Array(numEvents-1);cdf[0]=probVals[offset];for(var event_1=1;event_1<cdf.length;++event_1)cdf[event_1]=cdf[event_1-1]+probVals[offset+event_1];for(var random=seedrandom.alea(seed.toString()),outOffset=b*numSamples,sampleId=0;sampleId<numSamples;++sampleId){var r=random();resVals[outOffset+sampleId]=cdf.length;for(var event_2=0;event_2<cdf.length;event_2++)if(r<cdf[event_2]){resVals[outOffset+sampleId]=event_2;break}}}return res},MathBackendCPU.prototype.oneHot=function(indices,depth,onValue,offValue){this.assertNotComplex(indices,"oneHot");var res=new Float32Array(indices.size*depth);res.fill(offValue);for(var indicesVal=this.readSync(indices.dataId),event_3=0;event_3<indices.size;++event_3)0<=indicesVal[event_3]&&indicesVal[event_3]<depth&&(res[event_3*depth+indicesVal[event_3]]=onValue);return ops.tensor2d(res,[indices.size,depth],"int32")},MathBackendCPU.prototype.nonMaxSuppression=function(boxes,scores,maxOutputSize,iouThreshold,scoreThreshold){this.assertNotComplex(boxes,"nonMaxSuppression");var boxesVals=this.readSync(boxes.dataId),scoresVals=this.readSync(scores.dataId);return non_max_suppression_impl_1.nonMaxSuppressionImpl(boxesVals,scoresVals,maxOutputSize,iouThreshold,scoreThreshold)},MathBackendCPU.prototype.fft=function(x){return this.fftBatch(x,!1)},MathBackendCPU.prototype.ifft=function(x){return this.fftBatch(x,!0)},MathBackendCPU.prototype.fftBatch=function(x,inverse){for(var batch=x.shape[0],innerDim=x.shape[1],realResult=ops.buffer(x.shape,"float32"),imagResult=ops.buffer(x.shape,"float32"),real=ops.real(x).as2D(batch,innerDim),imag=ops.imag(x).as2D(batch,innerDim),b=0;b<batch;b++)for(var r=real.slice([b,0],[1,innerDim]),i=imag.slice([b,0],[1,innerDim]),input=ops.complex(r,i),res=this.readSync(this.fftImpl(input,inverse).dataId),d=0;d<innerDim;d++){var c=complex_util.getComplexWithIndex(res,d);realResult.values[b*innerDim+d]=c.real,imagResult.values[b*innerDim+d]=c.imag}return ops.complex(realResult.toTensor(),imagResult.toTensor()).as2D(batch,innerDim)},MathBackendCPU.prototype.fftImpl=function(x,inverse){var x1D=x.as1D(),n=x1D.size;if(this.isExponentOf2(n)){var result=this.fftRadix2(x1D,n,inverse).as2D(x.shape[0],x.shape[1]);return inverse&&(result=ops.complex(ops.real(result).div(ops_1.scalar(n)),ops.imag(result).div(ops_1.scalar(n)))),result}var data=this.readSync(x.dataId),rawOutput=this.fourierTransformByMatmul(data,n,inverse),output=complex_util.splitRealAndImagArrays(rawOutput);return ops.complex(output.real,output.imag).as2D(x.shape[0],x.shape[1])},MathBackendCPU.prototype.isExponentOf2=function(size){return 0==(size&size-1)},MathBackendCPU.prototype.fftRadix2=function(input,size,inverse){if(1===size)return input;var data=this.readSync(input.dataId),half=size/2,evenComplex=complex_util.complexWithEvenIndex(data),evenTensor=ops.complex(evenComplex.real,evenComplex.imag).as1D(),oddComplex=complex_util.complexWithOddIndex(data),oddTensor=ops.complex(oddComplex.real,oddComplex.imag).as1D();evenTensor=this.fftRadix2(evenTensor,half,inverse),oddTensor=this.fftRadix2(oddTensor,half,inverse);var e=complex_util.exponents(size,inverse),exponent=ops.complex(e.real,e.imag).mul(oddTensor),addPart=evenTensor.add(exponent),subPart=evenTensor.sub(exponent),realTensor=ops.real(addPart).concat(ops.real(subPart)),imagTensor=ops.imag(addPart).concat(ops.imag(subPart));return ops.complex(realTensor,imagTensor).as1D()},MathBackendCPU.prototype.fourierTransformByMatmul=function(data,size,inverse){for(var ret=new Float32Array(2*size),r=0;r<size;r++){for(var real_2=0,imag_2=0,c=0;c<size;c++){var e=complex_util.exponent(r*c,size,inverse),term=complex_util.getComplexWithIndex(data,c);real_2+=term.real*e.real-term.imag*e.imag,imag_2+=term.real*e.imag+term.imag*e.real}inverse&&(real_2/=size,imag_2/=size),complex_util.assignToTypedArray(ret,real_2,imag_2,r)}return ret},MathBackendCPU.prototype.depthToSpace=function(x,blockSize,dataFormat){util.assert("NHWC"===dataFormat,function(){return"Only NHWC dataFormat supported on CPU for depthToSpace. Got "+dataFormat}),util.assert(1<blockSize,function(){return"blockSize should be > 1 for depthToSpace, but was: "+blockSize});for(var batchSize=x.shape[0],inputHeight=x.shape[1],inputWidth=x.shape[2],inputDepth=x.shape[3],outputHeight=inputHeight*blockSize,outputWidth=inputWidth*blockSize,outputDepth=inputDepth/(blockSize*blockSize),xValues=this.readSync(x.dataId),result=new Float32Array(batchSize*outputHeight*outputWidth*outputDepth),outputIdx=0,b=0;b<batchSize;++b)for(var h=0;h<outputHeight;++h)for(var inH=Math.floor(h/blockSize),offsetH=h%blockSize,w=0;w<outputWidth;++w)for(var inW=Math.floor(w/blockSize),offsetD=(offsetH*blockSize+w%blockSize)*outputDepth,d=0;d<outputDepth;++d){var inputIdx=d+offsetD+inputDepth*(inW+inputWidth*(inH+inputHeight*b));result[outputIdx++]=xValues[inputIdx]}return ops.tensor4d(result,[batchSize,outputHeight,outputWidth,outputDepth])},MathBackendCPU.prototype.broadcastedBinaryOp=function(a,b,dtype,op){var newShape=broadcast_util.assertAndGetBroadcastShape(a.shape,b.shape),result=ops.buffer(newShape,dtype),aVals=this.readSync(a.dataId),bVals=this.readSync(b.dataId),aBroadcastDims=broadcast_util.getBroadcastDims(a.shape,newShape),bBroadcastDims=broadcast_util.getBroadcastDims(b.shape,newShape),resVals=result.values;if(aBroadcastDims.length+bBroadcastDims.length===0)for(var i=0;i<resVals.length;++i)resVals[i]=op(aVals[i%aVals.length],bVals[i%bVals.length]);else{var aBuf=this.bufferSync(a),bBuf=this.bufferSync(b),_loop_2=function(i){var loc=result.indexToLoc(i),aLoc=loc.slice(-a.rank);aBroadcastDims.forEach(function(d){return aLoc[d]=0});var aIndex=aBuf.locToIndex(aLoc),bLoc=loc.slice(-b.rank);bBroadcastDims.forEach(function(d){return bLoc[d]=0});var bIndex=bBuf.locToIndex(bLoc);resVals[i]=op(aVals[aIndex],bVals[bIndex])};for(i=0;i<resVals.length;++i)_loop_2(i)}return result.toTensor()},MathBackendCPU.prototype.broadcastedBinaryComplexOp=function(a,b,op){var newShape=broadcast_util.assertAndGetBroadcastShape(a.shape,b.shape),realResult=ops.buffer(newShape,"float32"),imagResult=ops.buffer(newShape,"float32"),aVals=this.readSync(a.dataId),bVals=this.readSync(b.dataId),aBroadcastDims=broadcast_util.getBroadcastDims(a.shape,newShape),bBroadcastDims=broadcast_util.getBroadcastDims(b.shape,newShape),realVals=realResult.values,imagVals=imagResult.values;if(aBroadcastDims.length+bBroadcastDims.length===0)for(var i=0;i<realVals.length;i++){var aIdx=i%aVals.length,bIdx=i%bVals.length,result=op(aVals[2*aIdx],aVals[2*aIdx+1],bVals[2*bIdx],bVals[2*bIdx+1]);realVals[i]=result.real,imagVals[i]=result.imag}else{var aRealBuf=this.bufferSync(this.data.get(a.dataId).complexTensors.real),bRealBuf=this.bufferSync(this.data.get(b.dataId).complexTensors.real),_loop_3=function(i){var loc=realResult.indexToLoc(i),aLoc=loc.slice(-a.rank);aBroadcastDims.forEach(function(d){return aLoc[d]=0});var aIndex=aRealBuf.locToIndex(aLoc),bLoc=loc.slice(-b.rank);bBroadcastDims.forEach(function(d){return bLoc[d]=0});var bIndex=bRealBuf.locToIndex(bLoc),opResult=op(aVals[2*aIndex],aVals[2*aIndex+1],bVals[2*bIndex],bVals[2*bIndex+1]);realVals[i]=opResult.real,imagVals[i]=opResult.imag};for(i=0;i<realVals.length;i++)_loop_3(i)}return this.complex(realResult.toTensor(),imagResult.toTensor())},MathBackendCPU.prototype.split=function(x,sizeSplits,axis){return split_shared_1.split(x,sizeSplits,axis)},MathBackendCPU.prototype.dispose=function(){},MathBackendCPU.prototype.floatPrecision=function(){return 32},MathBackendCPU.prototype.epsilon=function(){return backend_1.EPSILON_FLOAT32},MathBackendCPU.prototype.cropAndResize=function(images,boxes,boxIndex,cropSize,method,extrapolationValue){for(var _a=images.shape,batch=_a[0],imageHeight=_a[1],imageWidth=_a[2],numChannels=_a[3],numBoxes=boxes.shape[0],cropHeight=cropSize[0],cropWidth=cropSize[1],output=ops.buffer([numBoxes,cropHeight,cropWidth,numChannels],images.dtype),boxVals=this.readSync(boxes.dataId),boxIndVals=this.readSync(boxIndex.dataId),imageVals=this.readSync(images.dataId),inStride=images.strides,outStride=output.strides,b=0;b<numBoxes;b++){var startInd=4*b,y1=boxVals[startInd],x1=boxVals[1+startInd],y2=boxVals[2+startInd],x2=boxVals[3+startInd],bInd=boxIndVals[b];if(!(batch<=bInd))for(var heightScale=1<cropHeight?(y2-y1)*(imageHeight-1)/(cropHeight-1):0,widthScale=1<cropWidth?(x2-x1)*(imageWidth-1)/(cropWidth-1):0,y=0;y<cropHeight;y++){var yInd=1<cropHeight?y1*(imageHeight-1)+y*heightScale:.5*(y1+y2)*(imageHeight-1);if(yInd<0||imageHeight-1<yInd)for(var x=0;x<cropWidth;x++)for(var c=0;c<numChannels;c++){var ind=c+x*outStride[2]+y*outStride[1]+b*outStride[0];output.values[ind]=extrapolationValue}else if("bilinear"===method){var topInd=Math.floor(yInd),bottomInd=Math.ceil(yInd),yLerp=yInd-topInd;for(x=0;x<cropWidth;x++){if((xInd=1<cropWidth?x1*(imageWidth-1)+x*widthScale:.5*(x1+x2)*(imageWidth-1))<0||imageWidth-1<xInd)for(c=0;c<numChannels;c++){ind=c+x*outStride[2]+y*outStride[1]+b*outStride[0];output.values[ind]=extrapolationValue}else{var leftInd=Math.floor(xInd),rightInd=Math.ceil(xInd),xLerp=xInd-leftInd;for(c=0;c<numChannels;c++){var topLeft=imageVals[ind=c+leftInd*inStride[2]+topInd*inStride[1]+bInd*inStride[0]],topRight=imageVals[ind=c+rightInd*inStride[2]+topInd*inStride[1]+bInd*inStride[0]],bottomLeft=imageVals[ind=c+leftInd*inStride[2]+bottomInd*inStride[1]+bInd*inStride[0]],top_2=topLeft+(topRight-topLeft)*xLerp,bottom=bottomLeft+(imageVals[ind=c+rightInd*inStride[2]+bottomInd*inStride[1]+bInd*inStride[0]]-bottomLeft)*xLerp;ind=c+x*outStride[2]+y*outStride[1]+b*outStride[0],output.values[ind]=top_2+(bottom-top_2)*yLerp}}}}else for(x=0;x<cropWidth;++x){var xInd;if((xInd=1<cropWidth?x1*(imageWidth-1)+x*widthScale:.5*(x1+x2)*(imageWidth-1))<0||imageWidth-1<xInd)for(c=0;c<numChannels;c++){ind=c+x*outStride[2]+y*outStride[1]+b*outStride[0];output.values[ind]=extrapolationValue}else{var closestX=Math.round(xInd),closestY=Math.round(yInd);for(c=0;c<numChannels;c++){var inInd=c+closestX*inStride[2]+closestY*inStride[1]+bInd*inStride[0],outInd=c+x*outStride[2]+y*outStride[1]+b*outStride[0];output.values[outInd]=imageVals[inInd]}}}}}return output.toTensor()},MathBackendCPU.prototype.sparseToDense=function(sparseIndices,sparseValues,outputShape,defaultValue){var _a=scatter_nd_util.calculateShapes(sparseValues,sparseIndices,outputShape),sliceRank=_a.sliceRank,numUpdates=_a.numUpdates,sliceSize=_a.sliceSize,strides=_a.strides,outputSize=_a.outputSize;return this.scatter(sparseIndices,sparseValues,outputShape,outputSize,sliceSize,numUpdates,sliceRank,strides,defaultValue,!1)},MathBackendCPU.prototype.gatherND=function(x,indices){var indicesShape=indices.shape,sliceRank=indicesShape[indicesShape.length-1],_a=gather_nd_util.prepareAndValidate(x,indices),resultShape=_a[0],numSlices=_a[1],sliceSize=_a[2],strides=_a[3];if(0===numSlices)return ops_1.tensor([],resultShape,x.dtype);for(var buffer=new tensor_1.TensorBuffer([numSlices,sliceSize],x.dtype),indicesData=this.readSync(indices.dataId),xData=this.readSync(x.dataId),i=0;i<numSlices;i++){for(var index=[],flattenIndex=0,j=0;j<sliceRank;j++){var dim=indicesData[i*sliceRank+j];flattenIndex+=dim*strides[j],index.push(dim)}if(flattenIndex<0||flattenIndex>=x.size/sliceSize)throw new Error("Invalid indices: "+index+" does not index into "+x.shape);for(var k=0;k<sliceSize;k++)buffer.values[i*sliceSize+k]=xData[flattenIndex*sliceSize+k]}return buffer.toTensor().reshape(resultShape)},MathBackendCPU.prototype.scatterND=function(indices,updates,shape){var _a=scatter_nd_util.calculateShapes(updates,indices,shape),sliceRank=_a.sliceRank,numUpdates=_a.numUpdates,sliceSize=_a.sliceSize,strides=_a.strides,outputSize=_a.outputSize,defaultValue=ops_1.scalar(0);return this.scatter(indices,updates,shape,outputSize,sliceSize,numUpdates,sliceRank,strides,defaultValue,!0)},MathBackendCPU.prototype.fill=function(shape,value,dtype){dtype=dtype||util_1.inferDtype(value);var values=util_1.getArrayFromDType(dtype,util_1.sizeFromShape(shape));return values.fill(value),tensor_1.Tensor.make(shape,{values:values},dtype)},MathBackendCPU.prototype.onesLike=function(x){if("string"===x.dtype)throw new Error("onesLike is not supported for string tensors");return this.fill(x.shape,1,x.dtype)},MathBackendCPU.prototype.zerosLike=function(x){var values=util_1.getArrayFromDType(x.dtype,util_1.sizeFromShape(x.shape));return tensor_1.Tensor.make(x.shape,{values:values},x.dtype)},MathBackendCPU.prototype.linspace=function(start,stop,num){return backend_util.linspaceImpl(start,stop,num)},MathBackendCPU.prototype.scatter=function(indices,updates,shape,outputSize,sliceSize,numUpdates,sliceRank,strides,defaultValue,sumDupeIndices){var flattenShape=[outputSize/sliceSize,sliceSize],indicesData=this.readSync(indices.dataId),updatesData=this.readSync(updates.dataId);if(0===outputSize)return ops_1.tensor([],shape,updates.dtype);var buffer=new tensor_1.TensorBuffer(flattenShape,updates.dtype);buffer.values.fill(this.readSync(defaultValue.dataId)[0]);for(var i=0;i<numUpdates;i++){for(var index=[],flattenIndex=0,j=0;j<sliceRank;j++){var dim=indicesData[i*sliceRank+j];index.push(dim),flattenIndex+=dim*strides[j]}if(flattenIndex<0||outputSize/sliceSize<=flattenIndex)throw new Error("Invalid indices: "+index+" does not index into "+shape);for(var k=0;k<sliceSize;k++)sumDupeIndices?buffer.values[flattenIndex*sliceSize+k]+=updatesData[i*sliceSize+k]:buffer.values[flattenIndex*sliceSize+k]=0===updates.rank?updatesData[0]:updatesData[i*sliceSize+k]}return buffer.toTensor().reshape(shape)},MathBackendCPU}();exports.MathBackendCPU=MathBackendCPU,engine_1.ENGINE.registerBackend("cpu",function(){return new MathBackendCPU},1)},{"../../engine":143,"../../environment":144,"../../log":161,"../../ops/array_ops_util":164,"../../ops/axis_util":165,"../../ops/broadcast_util":169,"../../ops/complex_ops":172,"../../ops/concat_util":174,"../../ops/erf_util":181,"../../ops/gather_nd_util":184,"../../ops/ops":196,"../../ops/scatter_nd_util":204,"../../ops/selu_util":207,"../../ops/slice_util":210,"../../tensor":234,"../../types":240,"../../util":241,"../backend":50,"../backend_util":51,"../complex_util":52,"../non_max_suppression_impl":54,"../split_shared":56,"../tile_impl":57,"../topk_impl":58,"../where_impl":140,seedrandom:244}],54:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var tensor_ops_1=require("../ops/tensor_ops");function intersectionOverUnion(boxes,i,j){var iCoord=boxes.subarray(4*i,4*i+4),jCoord=boxes.subarray(4*j,4*j+4),yminI=Math.min(iCoord[0],iCoord[2]),xminI=Math.min(iCoord[1],iCoord[3]),ymaxI=Math.max(iCoord[0],iCoord[2]),xmaxI=Math.max(iCoord[1],iCoord[3]),yminJ=Math.min(jCoord[0],jCoord[2]),xminJ=Math.min(jCoord[1],jCoord[3]),ymaxJ=Math.max(jCoord[0],jCoord[2]),xmaxJ=Math.max(jCoord[1],jCoord[3]),areaI=(ymaxI-yminI)*(xmaxI-xminI),areaJ=(ymaxJ-yminJ)*(xmaxJ-xminJ);if(areaI<=0||areaJ<=0)return 0;var intersectionYmin=Math.max(yminI,yminJ),intersectionXmin=Math.max(xminI,xminJ),intersectionYmax=Math.min(ymaxI,ymaxJ),intersectionXmax=Math.min(xmaxI,xmaxJ),intersectionArea=Math.max(intersectionYmax-intersectionYmin,0)*Math.max(intersectionXmax-intersectionXmin,0);return intersectionArea/(areaI+areaJ-intersectionArea)}exports.nonMaxSuppressionImpl=function(boxes,scores,maxOutputSize,iouThreshold,scoreThreshold){for(var candidates=Array.from(scores).map(function(score,boxIndex){return{score:score,boxIndex:boxIndex}}).filter(function(c){return c.score>scoreThreshold}).sort(function(c1,c2){return c2.score-c1.score}),selected=[],i=0;i<candidates.length;i++){var _a=candidates[i],score=_a.score,boxIndex=_a.boxIndex;if(score<scoreThreshold)break;for(var ignoreCandidate=!1,j=selected.length-1;0<=j;--j){if(iouThreshold<=intersectionOverUnion(boxes,boxIndex,selected[j])){ignoreCandidate=!0;break}}if(!ignoreCandidate&&(selected.push(boxIndex),selected.length>=maxOutputSize))break}return tensor_ops_1.tensor1d(selected,"int32")}},{"../ops/tensor_ops":216}],55:[function(require,module,exports){"use strict";function getVecChannels(name,rank){return["x","y","z","w","u","v"].slice(0,rank).map(function(d){return name+"."+d})}Object.defineProperty(exports,"__esModule",{value:!0}),exports.getVecChannels=getVecChannels,exports.getChannels=function(name,rank){return 1===rank?[name]:getVecChannels(name,rank)},exports.getSourceCoords=function(rank,dims){if(1===rank)return"rc";for(var coords="",i=0;i<rank;i++)coords+=dims[i],i<rank-1&&(coords+=",");return coords}},{}],56:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.split=function(x,sizeSplits,axis){var begin=new Array(x.rank).fill(0),size=x.shape.slice();return sizeSplits.map(function(s){size[axis]=s;var slice=x.slice(begin,size);return begin[axis]+=s,slice})}},{}],57:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var array_ops_1=require("../ops/array_ops");exports.tile=function(xBuf,reps){for(var newShape=new Array(xBuf.rank),i=0;i<newShape.length;i++)newShape[i]=xBuf.shape[i]*reps[i];var result=array_ops_1.buffer(newShape,xBuf.dtype);for(i=0;i<result.values.length;++i){for(var newLoc=result.indexToLoc(i),originalLoc=new Array(xBuf.rank),i_1=0;i_1<originalLoc.length;i_1++)originalLoc[i_1]=newLoc[i_1]%xBuf.shape[i_1];var originalIndex=xBuf.locToIndex(originalLoc);result.values[i]=xBuf.values[originalIndex]}return result.toTensor()}},{"../ops/array_ops":163}],58:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var tensor_ops_1=require("../ops/tensor_ops"),util_1=require("../util");exports.topkImpl=function(x,xShape,xDtype,k,sorted){for(var lastDim=xShape[xShape.length-1],_a=[x.length/lastDim,lastDim],batch=_a[0],size=_a[1],allTopKVals=util_1.getTypedArrayFromDType(xDtype,batch*k),allTopKIndices=util_1.getTypedArrayFromDType("int32",batch*k),b=0;b<batch;b++){for(var offset=b*size,vals=x.subarray(offset,offset+size),valAndInd=[],i=0;i<vals.length;i++)valAndInd.push({value:vals[i],index:i});valAndInd.sort(function(a,b){return b.value-a.value});var outOffset=b*k,topKVals=allTopKVals.subarray(outOffset,outOffset+k),topKIndices=allTopKIndices.subarray(outOffset,outOffset+k);for(i=0;i<k;i++)topKVals[i]=valAndInd[i].value,topKIndices[i]=valAndInd[i].index}var outputShape=xShape.slice();return outputShape[outputShape.length-1]=k,[tensor_ops_1.tensor(allTopKVals,outputShape,xDtype),tensor_ops_1.tensor(allTopKIndices,outputShape,"int32")]}},{"../ops/tensor_ops":216,"../util":241}],59:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});function AddNProgram(outputShape,shapes){this.outputShape=[],this.outputShape=outputShape,this.variableNames=shapes.map(function(_,i){return"T"+i});var snippets=[];this.variableNames.forEach(function(variable){snippets.push("float v"+variable+" = get"+variable+"AtOutCoords();")});var operation=this.variableNames.map(function(variable){return"v"+variable}).join(" + ");this.userCode="\n      void main() {\n        "+snippets.join("\n        ")+"\n\n        float result = "+operation+";\n        setOutput(result);\n      }\n    "}exports.AddNProgram=AddNProgram},{}],60:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});function AddNPackedProgram(outputShape,shapes){this.outputShape=[],this.usesPackedTextures=!0,this.outputShape=outputShape,this.variableNames=shapes.map(function(_,i){return"T"+i});var snippets=[];this.variableNames.forEach(function(variable){snippets.push("vec4 v"+variable+" = get"+variable+"AtOutCoords();")});var operation=this.variableNames.map(function(variable){return"v"+variable}).join(" + ");this.userCode="\n      void main() {\n        "+snippets.join("\n        ")+"\n\n        vec4 result = "+operation+";\n        setOutput(result);\n      }\n    "}exports.AddNPackedProgram=AddNPackedProgram},{}],61:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});function ArgMinMaxProgram(reduceInfo,op,firstPass){this.variableNames=["A"];var windowSize=reduceInfo.windowSize,batchSize=reduceInfo.batchSize,inSize=reduceInfo.inSize,outSize=Math.ceil(inSize/windowSize);firstPass||this.variableNames.push("bestIndicesA"),this.outputShape=[batchSize,outSize];var compOp="max"===op?">":"<",indexSnippet=firstPass?"inOffset + i;":"round(getBestIndicesA(batch, inOffset + i));";this.userCode="\n      void main() {\n        ivec2 coords = getOutputCoords();\n        int batch = coords[0];\n        int outIdx = coords[1];\n        int inOffset = outIdx * "+windowSize+";\n\n        int bestIndex = inOffset;\n        float bestValue = getA(batch, bestIndex);\n\n        for (int i = 0; i < "+windowSize+"; i++) {\n          int inIdx = "+indexSnippet+";\n          float candidate = getA(batch, inIdx);\n          if (candidate "+compOp+" bestValue) {\n            bestValue = candidate;\n            bestIndex = inIdx;\n          }\n        }\n        setOutput(float(bestIndex));\n      }\n    "}exports.ArgMinMaxProgram=ArgMinMaxProgram},{}],62:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});function ArgMinMaxPackedProgram(shape,windowSize,op,firstPass){this.variableNames=["A"],this.usesPackedTextures=!0,util_1.assert(2<shape.length,function(){return"Packed arg"+(op.charAt(0).toUpperCase()+op.slice(1))+" supports only inputs with rank above 2."});var inSize=shape[shape.length-1],outSize=Math.ceil(inSize/windowSize);this.outputShape=shape.slice(0,-1),1<outSize&&this.outputShape.push(outSize),firstPass||this.variableNames.push("bestIndicesA");var sourceLocSetup,sourceRank,outShape=this.outputShape,rank=outShape.length,dtype=shader_compiler_1.getCoordsDataType(rank),coords=packing_util_1.getChannels("coords",rank);if(1===outSize){sourceRank=rank+1;var sourceLocDType=shader_compiler_1.getCoordsDataType(sourceRank);sourceLocSetup="\n        "+sourceLocDType+" sourceLocR = "+sourceLocDType+"("+coords.join()+", 0);\n        ++"+coords[rank-1]+";\n        "+sourceLocDType+" sourceLocG = "+sourceLocDType+"("+coords.join()+", 0);\n        ++"+coords[rank-2]+";\n        "+sourceLocDType+" sourceLocA = "+sourceLocDType+"("+coords.join()+", 0);\n        --"+coords[rank-1]+";\n        "+sourceLocDType+" sourceLocB = "+sourceLocDType+"("+coords.join()+", 0);\n        --"+coords[rank-2]+";"}else sourceLocSetup="\n        "+dtype+" sourceLocR = coords;\n        ++"+coords[(sourceRank=rank)-1]+";\n        "+dtype+" sourceLocG = coords;\n        ++"+coords[rank-2]+";\n        "+dtype+" sourceLocA = coords;\n        --"+coords[rank-1]+";\n        "+dtype+" sourceLocB = coords;\n        --"+coords[rank-2]+";";var channels=["x","y","z","w","u","v"].slice(0,sourceRank),inChannel="."+channels[sourceRank-1],intChannels=channels.map(function(x){return"int "+x}),srcRCoords=packing_util_1.getChannels("sourceLocR",sourceRank-1).concat("inIdx.r"),srcGCoords=packing_util_1.getChannels("sourceLocG",sourceRank-1).concat("inIdx.g"),srcBCoords=packing_util_1.getChannels("sourceLocB",sourceRank-1).concat("inIdx.b"),srcACoords=packing_util_1.getChannels("sourceLocA",sourceRank-1).concat("inIdx.a"),compOp="max"===op?"greaterThan":"lessThan",fetchCandidateIdx=firstPass?"":"\n          inIdx = round(vec4(getBestIndicesAChannel("+srcRCoords.join()+"),\n                             getBestIndicesAChannel("+srcGCoords.join()+"),\n                             getBestIndicesAChannel("+srcBCoords.join()+"),\n                             getBestIndicesAChannel("+srcACoords.join()+")));",fetchValue="vec4(\n            getAChannel("+srcRCoords.join()+"),\n            hasNextCol ? getAChannel("+srcGCoords.join()+") : 0.,\n            hasNextRow ? getAChannel("+srcBCoords.join()+") : 0.,\n            hasNextRow && hasNextCol ? getAChannel("+srcACoords.join()+") : 0.)",getBestIndicesAChannelSnippet=firstPass?"":"\n      float getBestIndicesAChannel("+intChannels.join()+") {\n        return getChannel(getBestIndicesA("+channels.join()+"),\n                                          vec2("+channels.slice(-2).join()+"));\n      }";this.userCode="\n      float getAChannel("+intChannels.join()+") {\n        return getChannel(getA("+channels.join()+"),\n                               vec2("+channels.slice(-2).join()+"));\n      }\n      "+getBestIndicesAChannelSnippet+"\n      void main() {\n        "+dtype+" coords = getOutputCoords();\n        bool hasNextCol = "+coords[rank-1]+" < "+(outShape[rank-1]-1)+";\n        bool hasNextRow = "+coords[rank-2]+" < "+(outShape[rank-2]-1)+";\n        "+sourceLocSetup+"\n        ivec4 srcIdx = ivec4(sourceLocR"+inChannel+", sourceLocG"+inChannel+",\n          sourceLocB"+inChannel+", sourceLocA"+inChannel+") * "+windowSize+";\n        ivec4 inIdx = srcIdx;\n        vec4 bestIndex = vec4(inIdx);\n        vec4 bestValue = "+fetchValue+";\n\n        for (int i = 0; i < "+windowSize+"; i++) {\n          inIdx = srcIdx;\n          "+fetchCandidateIdx+"\n          vec4 candidate = "+fetchValue+";\n          bvec4 nan = isnan(candidate);\n          bvec4 replace = bvec4(\n            vec4("+compOp+"(candidate, bestValue)) * (vec4(1.0) - vec4(nan)));\n\n          bestValue = vec4(replace.x  ? candidate.x : bestValue.x,\n                           replace.y  ? candidate.y : bestValue.y,\n                           replace.z  ? candidate.z : bestValue.z,\n                           replace.w  ? candidate.w : bestValue.w);\n          bestIndex = mix(bestIndex, vec4(inIdx), vec4(replace));\n          srcIdx++;\n        }\n        setOutput(bestIndex);\n      }\n    "}var util_1=require("../../util"),packing_util_1=require("../packing_util"),shader_compiler_1=require("./shader_compiler");exports.ArgMinMaxPackedProgram=ArgMinMaxPackedProgram},{"../../util":241,"../packing_util":55,"./shader_compiler":126}],63:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});function AvgPool2DBackpropProgram(convInfo){this.variableNames=["dy"],this.outputShape=convInfo.inShape;var filterHeight=convInfo.filterHeight,filterWidth=convInfo.filterWidth,strideHeight=convInfo.strideHeight,strideWidth=convInfo.strideWidth,dilationHeight=convInfo.dilationHeight,dilationWidth=convInfo.dilationWidth,effectiveFilterHeight=convInfo.effectiveFilterHeight,effectiveFilterWidth=convInfo.effectiveFilterWidth,padTop=effectiveFilterHeight-1-convInfo.padInfo.top,padLeft=effectiveFilterWidth-1-convInfo.padInfo.left,avgMultiplier=1/(filterHeight*filterWidth);this.userCode="\n      const ivec2 pads = ivec2("+padTop+", "+padLeft+");\n      const float avgMultiplier = float("+avgMultiplier+");\n\n      void main() {\n        ivec4 coords = getOutputCoords();\n        int b = coords[0];\n        int d = coords[3];\n\n        ivec2 dyRCCorner = coords.yz - pads;\n        int dyRCorner = dyRCCorner.x;\n        int dyCCorner = dyRCCorner.y;\n\n        // Convolve dy(?, ?, d) with pos mask(:, :, d) to get dx(xR, xC, d).\n        // ? = to be determined. : = across all values in that axis.\n        float dotProd = 0.0;\n        for (int wR = 0; wR < "+effectiveFilterHeight+";\n            wR += "+dilationHeight+") {\n          float dyR = float(dyRCorner + wR) / "+strideHeight+".0;\n\n          if (dyR < 0.0 || dyR >= "+convInfo.outHeight+".0 || fract(dyR) > 0.0) {\n            continue;\n          }\n          int idyR = int(dyR);\n\n          for (int wC = 0; wC < "+effectiveFilterWidth+";\n            wC+= "+dilationWidth+") {\n            float dyC = float(dyCCorner + wC) / "+strideWidth+".0;\n\n            if (dyC < 0.0 || dyC >= "+convInfo.outWidth+".0 ||\n                fract(dyC) > 0.0) {\n              continue;\n            }\n            int idyC = int(dyC);\n\n            float dyValue = getDy(b, idyR, idyC, d);\n\n            dotProd += dyValue * avgMultiplier;\n          }\n        }\n        setOutput(dotProd);\n      }\n    "}exports.AvgPool2DBackpropProgram=AvgPool2DBackpropProgram;function AvgPool3DBackpropProgram(convInfo){this.variableNames=["dy"],this.outputShape=convInfo.inShape;var filterDepth=convInfo.filterDepth,filterHeight=convInfo.filterHeight,filterWidth=convInfo.filterWidth,strideDepth=convInfo.strideDepth,strideHeight=convInfo.strideHeight,strideWidth=convInfo.strideWidth,dilationDepth=convInfo.dilationDepth,dilationHeight=convInfo.dilationHeight,dilationWidth=convInfo.dilationWidth,effectiveFilterDepth=convInfo.effectiveFilterDepth,effectiveFilterHeight=convInfo.effectiveFilterHeight,effectiveFilterWidth=convInfo.effectiveFilterWidth,padFront=effectiveFilterDepth-1-convInfo.padInfo.front,padTop=effectiveFilterHeight-1-convInfo.padInfo.top,padLeft=effectiveFilterWidth-1-convInfo.padInfo.left,avgMultiplier=1/(filterDepth*filterHeight*filterWidth);this.userCode="\n      const ivec3 pads = ivec3("+padFront+", "+padTop+", "+padLeft+");\n      const float avgMultiplier = float("+avgMultiplier+");\n\n      void main() {\n        ivec5 coords = getOutputCoords();\n        int batch = coords.x;\n        int ch = coords.u;\n\n        ivec3 dyCorner = ivec3(coords.y, coords.z, coords.w) - pads;\n        int dyDCorner = dyCorner.x;\n        int dyRCorner = dyCorner.y;\n        int dyCCorner = dyCorner.z;\n\n        // Convolve dy(?, ?, ?, d) with pos mask(:, :, :, ch) to get\n        // dx(xD, xR, xC, ch).\n        // ? = to be determined. : = across all values in that axis.\n        float dotProd = 0.0;\n\n        for (int wD = 0; wD < "+effectiveFilterDepth+";\n            wD += "+dilationDepth+") {\n          float dyD = float(dyDCorner + wD) / "+strideDepth+".0;\n\n          if (dyD < 0.0 || dyD >= "+convInfo.outDepth+".0 || fract(dyD) > 0.0) {\n            continue;\n          }\n          int idyD = int(dyD);\n\n          for (int wR = 0; wR < "+effectiveFilterHeight+";\n              wR += "+dilationHeight+") {\n            float dyR = float(dyRCorner + wR) / "+strideHeight+".0;\n\n            if (dyR < 0.0 || dyR >= "+convInfo.outHeight+".0 ||\n                fract(dyR) > 0.0) {\n              continue;\n            }\n            int idyR = int(dyR);\n\n            for (int wC = 0; wC < "+effectiveFilterWidth+";\n                wC += "+dilationWidth+") {\n              float dyC = float(dyCCorner + wC) / "+strideWidth+".0;\n\n              if (dyC < 0.0 || dyC >= "+convInfo.outWidth+".0 ||\n                  fract(dyC) > 0.0) {\n                continue;\n              }\n              int idyC = int(dyC);\n\n              float dyValue = getDy(batch, idyD, idyR, idyC, ch);\n\n              dotProd += dyValue * avgMultiplier;\n            }\n          }\n        }\n        setOutput(dotProd);\n      }\n    "}exports.AvgPool3DBackpropProgram=AvgPool3DBackpropProgram},{}],64:[function(require,module,exports){"use strict";var __awaiter=this&&this.__awaiter||function(thisArg,_arguments,P,generator){return new(P=P||Promise)(function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){result.done?resolve(result.value):new P(function(resolve){resolve(result.value)}).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())})},__generator=this&&this.__generator||function(thisArg,body){var f,y,t,g,_={label:0,sent:function(){if(1&t[0])throw t[1];return t[1]},trys:[],ops:[]};return g={next:verb(0),throw:verb(1),return:verb(2)},"function"==typeof Symbol&&(g[Symbol.iterator]=function(){return this}),g;function verb(n){return function(v){return function(op){if(f)throw new TypeError("Generator is already executing.");for(;_;)try{if(f=1,y&&(t=2&op[0]?y.return:op[0]?y.throw||((t=y.return)&&t.call(y),0):y.next)&&!(t=t.call(y,op[1])).done)return t;switch(y=0,t&&(op=[2&op[0],t.value]),op[0]){case 0:case 1:t=op;break;case 4:return _.label++,{value:op[1],done:!1};case 5:_.label++,y=op[1],op=[0];continue;case 7:op=_.ops.pop(),_.trys.pop();continue;default:if(!(t=0<(t=_.trys).length&&t[t.length-1])&&(6===op[0]||2===op[0])){_=0;continue}if(3===op[0]&&(!t||op[1]>t[0]&&op[1]<t[3])){_.label=op[1];break}if(6===op[0]&&_.label<t[1]){_.label=t[1],t=op;break}if(t&&_.label<t[2]){_.label=t[2],_.ops.push(op);break}t[2]&&_.ops.pop(),_.trys.pop();continue}op=body.call(thisArg,_)}catch(e){op=[6,e],y=0}finally{f=t=0}if(5&op[0])throw op[1];return{value:op[0]?op[1]:void 0,done:!0}}([n,v])}}};Object.defineProperty(exports,"__esModule",{value:!0}),require("./flags_webgl");var device_util=require("../../device_util"),engine_1=require("../../engine"),environment_1=require("../../environment"),globals_1=require("../../globals"),log_1=require("../../log"),array_ops_1=require("../../ops/array_ops"),array_ops_util=require("../../ops/array_ops_util"),axis_util=require("../../ops/axis_util"),complex_ops_1=require("../../ops/complex_ops"),concat_util_1=require("../../ops/concat_util"),gather_nd_util=require("../../ops/gather_nd_util"),reduce_util=require("../../ops/reduce_util"),scatter_nd_util=require("../../ops/scatter_nd_util"),segment_util=require("../../ops/segment_util"),slice_util_1=require("../../ops/slice_util"),softmax_1=require("../../ops/softmax"),tensor_ops_1=require("../../ops/tensor_ops"),tensor_1=require("../../tensor"),types_1=require("../../types"),util=require("../../util"),util_1=require("../../util"),backend_1=require("../backend"),backend_util=require("../backend_util"),complex_util_1=require("../complex_util"),non_max_suppression_impl_1=require("../non_max_suppression_impl"),split_shared_1=require("../split_shared"),tile_impl_1=require("../tile_impl"),topk_impl_1=require("../topk_impl"),where_impl_1=require("../where_impl"),addn_gpu_1=require("./addn_gpu"),addn_packed_gpu_1=require("./addn_packed_gpu"),argminmax_gpu_1=require("./argminmax_gpu"),argminmax_packed_gpu_1=require("./argminmax_packed_gpu"),avg_pool_backprop_gpu_1=require("./avg_pool_backprop_gpu"),batchnorm_gpu_1=require("./batchnorm_gpu"),batchnorm_packed_gpu_1=require("./batchnorm_packed_gpu"),binaryop_complex_gpu=require("./binaryop_complex_gpu"),binaryop_complex_gpu_1=require("./binaryop_complex_gpu"),binaryop_gpu=require("./binaryop_gpu"),binaryop_gpu_1=require("./binaryop_gpu"),binaryop_packed_gpu=require("./binaryop_packed_gpu"),binaryop_packed_gpu_1=require("./binaryop_packed_gpu"),canvas_util_1=require("./canvas_util"),clip_gpu_1=require("./clip_gpu"),clip_packed_gpu_1=require("./clip_packed_gpu"),complex_abs_gpu_1=require("./complex_abs_gpu"),concat_gpu_1=require("./concat_gpu"),concat_packed_gpu_1=require("./concat_packed_gpu"),conv_backprop_gpu_1=require("./conv_backprop_gpu"),conv_backprop_gpu_depthwise_1=require("./conv_backprop_gpu_depthwise"),conv_gpu_1=require("./conv_gpu"),conv_gpu_depthwise_1=require("./conv_gpu_depthwise"),conv_packed_gpu_depthwise_1=require("./conv_packed_gpu_depthwise"),crop_and_resize_gpu_1=require("./crop_and_resize_gpu"),cumsum_gpu_1=require("./cumsum_gpu"),decode_matrix_gpu_1=require("./decode_matrix_gpu"),decode_matrix_packed_gpu_1=require("./decode_matrix_packed_gpu"),depth_to_space_gpu_1=require("./depth_to_space_gpu"),diag_gpu_1=require("./diag_gpu"),encode_float_gpu_1=require("./encode_float_gpu"),encode_float_packed_gpu_1=require("./encode_float_packed_gpu"),encode_matrix_gpu_1=require("./encode_matrix_gpu"),encode_matrix_packed_gpu_1=require("./encode_matrix_packed_gpu"),fft_gpu=require("./fft_gpu"),fft_gpu_1=require("./fft_gpu"),fill_gpu_1=require("./fill_gpu"),from_pixels_gpu_1=require("./from_pixels_gpu"),from_pixels_packed_gpu_1=require("./from_pixels_packed_gpu"),gather_gpu_1=require("./gather_gpu"),gather_nd_gpu_1=require("./gather_nd_gpu"),gpgpu_context_1=require("./gpgpu_context"),gpgpu_math=require("./gpgpu_math"),im2col_packed_gpu_1=require("./im2col_packed_gpu"),lrn_gpu_1=require("./lrn_gpu"),lrn_grad_gpu_1=require("./lrn_grad_gpu"),lrn_packed_gpu_1=require("./lrn_packed_gpu"),max_pool_backprop_gpu_1=require("./max_pool_backprop_gpu"),mulmat_packed_gpu_1=require("./mulmat_packed_gpu"),multinomial_gpu_1=require("./multinomial_gpu"),onehot_gpu_1=require("./onehot_gpu"),pack_gpu_1=require("./pack_gpu"),pad_gpu_1=require("./pad_gpu"),pad_packed_gpu_1=require("./pad_packed_gpu"),pool_gpu_1=require("./pool_gpu"),reduce_gpu_1=require("./reduce_gpu"),reshape_packed_gpu_1=require("./reshape_packed_gpu"),resize_bilinear_backprop_gpu_1=require("./resize_bilinear_backprop_gpu"),resize_bilinear_gpu_1=require("./resize_bilinear_gpu"),resize_bilinear_packed_gpu_1=require("./resize_bilinear_packed_gpu"),resize_nearest_neighbor_backprop_gpu_1=require("./resize_nearest_neighbor_backprop_gpu"),resize_nearest_neighbor_gpu_1=require("./resize_nearest_neighbor_gpu"),reverse_gpu_1=require("./reverse_gpu"),reverse_packed_gpu_1=require("./reverse_packed_gpu"),scatter_gpu_1=require("./scatter_gpu"),segment_gpu_1=require("./segment_gpu"),select_gpu_1=require("./select_gpu"),slice_gpu_1=require("./slice_gpu"),slice_packed_gpu_1=require("./slice_packed_gpu"),strided_slice_gpu_1=require("./strided_slice_gpu"),tex_util=require("./tex_util"),tex_util_1=require("./tex_util"),texture_manager_1=require("./texture_manager"),tile_gpu_1=require("./tile_gpu"),transpose_gpu_1=require("./transpose_gpu"),transpose_packed_gpu_1=require("./transpose_packed_gpu"),unary_op=require("./unaryop_gpu"),unaryop_gpu_1=require("./unaryop_gpu"),unary_packed_op=require("./unaryop_packed_gpu"),unaryop_packed_gpu_1=require("./unaryop_packed_gpu"),unpack_gpu_1=require("./unpack_gpu"),webgl_util=require("./webgl_util"),binaryCaches={};function mapActivationToShaderProgram(activation,packed){if(void 0===packed&&(packed=!1),"linear"===activation)return packed?unary_packed_op.LINEAR:unary_op.LINEAR;if("relu"===activation)return packed?unary_packed_op.RELU:unary_op.RELU;if("prelu"===activation)return packed?binaryop_packed_gpu.PRELU:binaryop_gpu.PRELU;throw new Error("Activation "+activation+" has not been implemented for the WebGL backend.")}var BEFORE_PAGING_CONSTANT=600;exports.MATMUL_SHARED_DIM_THRESHOLD=1e3;var MathBackendWebGL=function(){function MathBackendWebGL(gpgpu){if(this.gpgpu=gpgpu,this.pendingRead=new WeakMap,this.pendingDisposal=new WeakSet,this.dataRefCount=new WeakMap,this.numBytesInGPU=0,this.uploadWaitMs=0,this.downloadWaitMs=0,this.warnedAboutMemory=!1,this.disposed=!1,!environment_1.ENV.getBool("HAS_WEBGL"))throw new Error("WebGL is not supported on this device");if(null==gpgpu){var gl=canvas_util_1.getWebGLContext(environment_1.ENV.getNumber("WEBGL_VERSION"));this.binaryCache=function(webGLVersion){return webGLVersion in binaryCaches||(binaryCaches[webGLVersion]={}),binaryCaches[webGLVersion]}(environment_1.ENV.getNumber("WEBGL_VERSION")),this.gpgpu=new gpgpu_context_1.GPGPUContext(gl),this.canvas=gl.canvas,this.gpgpuCreatedLocally=!0}else this.binaryCache={},this.gpgpuCreatedLocally=!1,this.canvas=gpgpu.gl.canvas;this.textureManager=new texture_manager_1.TextureManager(this.gpgpu),this.numMBBeforeWarning=null==environment_1.ENV.global.screen?1024:environment_1.ENV.global.screen.height*environment_1.ENV.global.screen.width*window.devicePixelRatio*BEFORE_PAGING_CONSTANT/1024/1024,this.texData=new backend_1.DataStorage(this,engine_1.ENGINE)}return MathBackendWebGL.prototype.register=function(dataId,shape,dtype){if(this.texData.has(dataId))throw new Error("Data buffer is already registered");this.texData.set(dataId,{shape:shape,dtype:dtype})},MathBackendWebGL.prototype.fromPixels=function(pixels,numChannels){if(null==pixels)throw new Error("pixels passed to tf.browser.fromPixels() can not be null");var texShape=[pixels.height,pixels.width],outShape=[pixels.height,pixels.width,numChannels],isCanvas="undefined"!=typeof OffscreenCanvas&&pixels instanceof OffscreenCanvas||"undefined"!=typeof HTMLCanvasElement&&pixels instanceof HTMLCanvasElement,isPixelData=pixels.data instanceof Uint8Array,isImageData="undefined"!=typeof ImageData&&pixels instanceof ImageData,isVideo="undefined"!=typeof HTMLVideoElement&&pixels instanceof HTMLVideoElement,isImage="undefined"!=typeof HTMLImageElement&&pixels instanceof HTMLImageElement;if(!(isCanvas||isPixelData||isImageData||isVideo||isImage))throw new Error("pixels passed to tf.browser.fromPixels() must be either an HTMLVideoElement, HTMLImageElement, HTMLCanvasElement, ImageData in browser, or OffscreenCanvas, ImageData in webworker or {data: Uint32Array, width: number, height: number}, but was "+pixels.constructor.name);if(isImage||isVideo){if(null==this.fromPixels2DContext){if("complete"!==document.readyState)throw new Error("The DOM is not ready yet. Please call tf.browser.fromPixels() once the DOM is ready. One way to do that is to add an event listener for `DOMContentLoaded` on the document object");this.fromPixels2DContext=canvas_util_1.createCanvas(environment_1.ENV.getNumber("WEBGL_VERSION")).getContext("2d")}this.fromPixels2DContext.canvas.width=pixels.width,this.fromPixels2DContext.canvas.height=pixels.height,this.fromPixels2DContext.drawImage(pixels,0,0,pixels.width,pixels.height),pixels=this.fromPixels2DContext.canvas}var program,res,tempPixelHandle=this.makeTensorHandle(texShape,"int32");if(this.texData.get(tempPixelHandle.dataId).usage=tex_util_1.TextureUsage.PIXELS,this.gpgpu.uploadPixelDataToTexture(this.getTexture(tempPixelHandle.dataId),pixels),environment_1.ENV.getBool("WEBGL_PACK")){program=new from_pixels_packed_gpu_1.FromPixelsPackedProgram(outShape);var packedOutput=this.makePackedTensor(program.outputShape,tempPixelHandle.dtype);res=this.compileAndRun(program,[tempPixelHandle],packedOutput)}else program=new from_pixels_gpu_1.FromPixelsProgram(outShape),res=this.compileAndRun(program,[tempPixelHandle]);return this.disposeData(tempPixelHandle.dataId),res},MathBackendWebGL.prototype.makeTensorHandle=function(shape,dtype){var dataId={};return this.register(dataId,shape,dtype),{dataId:dataId,shape:shape,dtype:dtype}},MathBackendWebGL.prototype.write=function(dataId,values){if(null==values)throw new Error("MathBackendWebGL.write(): values can not be null");if(environment_1.ENV.getBool("DEBUG"))for(var i=0;i<values.length;i++){var num=values[i];if(!webgl_util.canBeRepresented(num))throw Error("The value "+num+" cannot be represented on this device.")}var texData=this.texData.get(dataId);if("complex64"===texData.dtype)throw new Error("Cannot write to a complex64 dtype. Please use tf.complex(real, imag).");this.releaseGPUData(dataId),texData.usage=tex_util_1.TextureUsage.UPLOAD,texData.values=values},MathBackendWebGL.prototype.readSync=function(dataId){var texData=this.texData.get(dataId),values=texData.values,dtype=texData.dtype,complexTensors=texData.complexTensors,slice=texData.slice,shape=texData.shape;if(null!=slice){var program=new unaryop_gpu_1.UnaryOpProgram(shape,unary_op.CLONE),res=this.compileAndRun(program,[{dataId:dataId,shape:shape,dtype:dtype}]),data=this.readSync(res.dataId);return res.dispose(),data}if(null!=values)return this.convertAndCacheOnCPU(dataId);if("string"===dtype)return values;var start,result,shouldTimeProgram=null!=this.activeTimers;if(shouldTimeProgram&&(start=util.now()),"complex64"===dtype){var realValues=complexTensors.real.dataSync(),imagValues=complexTensors.imag.dataSync();result=complex_util_1.mergeRealAndImagArrays(realValues,imagValues)}else result=this.getValuesFromTexture(dataId);return shouldTimeProgram&&(this.downloadWaitMs+=util.now()-start),this.convertAndCacheOnCPU(dataId,result)},MathBackendWebGL.prototype.read=function(dataId){return __awaiter(this,void 0,void 0,function(){var _a,subscribers_1,texData,values,shape,slice,dtype,complexTensors,program,res,data,buffer,tmpTarget,tmpData,vals,_b,realValues,imagValues,size,dTypeVals,subscribers;return __generator(this,function(_c){switch(_c.label){case 0:if(this.pendingRead.has(dataId))return subscribers_1=this.pendingRead.get(dataId),[2,new Promise(function(resolve){return subscribers_1.push(resolve)})];if(texData=this.texData.get(dataId),values=texData.values,shape=texData.shape,slice=texData.slice,dtype=texData.dtype,complexTensors=texData.complexTensors,null!=slice)return program=new unaryop_gpu_1.UnaryOpProgram(shape,unary_op.CLONE),res=this.compileAndRun(program,[{dataId:dataId,shape:shape,dtype:dtype}]),data=this.read(res.dataId),res.dispose(),[2,data];if(null!=values)return[2,this.convertAndCacheOnCPU(dataId)];if(!environment_1.ENV.getBool("WEBGL_DOWNLOAD_FLOAT_ENABLED")&&2===environment_1.ENV.getNumber("WEBGL_VERSION"))throw new Error("tensor.data() with WEBGL_DOWNLOAD_FLOAT_ENABLED=false and WEBGL_VERSION=2 not yet supported.");return buffer=null,"complex64"!==dtype&&environment_1.ENV.get("WEBGL_BUFFER_SUPPORTED")&&(tmpTarget=this.decode(dataId),dataId=tmpTarget.dataId,tmpData=this.texData.get(tmpTarget.dataId),buffer=(_a=this.gpgpu).createBufferFromTexture.apply(_a,[tmpData.texture].concat(tex_util.getDenseTexShape(shape)))),this.pendingRead.set(dataId,[]),"complex64"===dtype?[3,2]:[4,this.gpgpu.createAndWaitForFence()];case 1:_c.sent(),_c.label=2;case 2:return"complex64"!==dtype?[3,4]:[4,Promise.all([complexTensors.real.data(),complexTensors.imag.data()])];case 3:return _b=_c.sent(),realValues=_b[0],imagValues=_b[1],vals=complex_util_1.mergeRealAndImagArrays(realValues,imagValues),[3,5];case 4:null==buffer?vals=this.getValuesFromTexture(dataId):(size=util.sizeFromShape(shape),vals=this.gpgpu.downloadFloat32MatrixFromBuffer(buffer,size),this.disposeData(dataId)),_c.label=5;case 5:return dTypeVals=this.convertAndCacheOnCPU(dataId,vals),subscribers=this.pendingRead.get(dataId),this.pendingRead.delete(dataId),subscribers.forEach(function(resolve){return resolve(dTypeVals)}),this.pendingDisposal.has(dataId)&&(this.pendingDisposal.delete(dataId),this.disposeData(dataId)),[2,dTypeVals]}})})},MathBackendWebGL.prototype.getValuesFromTexture=function(dataId){var _a,_this=this,_b=this.texData.get(dataId),shape=_b.shape,dtype=_b.dtype,isPacked=_b.isPacked,size=util.sizeFromShape(shape);if(environment_1.ENV.getBool("WEBGL_DOWNLOAD_FLOAT_ENABLED")){var tmpTarget_1=this.decode(dataId),tmpData_1=this.texData.get(tmpTarget_1.dataId),vals_1=(_a=this.gpgpu).downloadMatrixFromPackedTexture.apply(_a,[tmpData_1.texture].concat(tex_util.getDenseTexShape(shape))).subarray(0,size);return this.disposeData(tmpTarget_1.dataId),vals_1}var shouldUsePackedProgram=environment_1.ENV.getBool("WEBGL_PACK")&&!0===isPacked,outputShape=shouldUsePackedProgram?webgl_util.getShapeAs3D(shape):shape,tmpTarget=this.makeTensorHandle(outputShape,"float32");tmpTarget.size=util_1.sizeFromShape(shape),this.texData.get(tmpTarget.dataId).usage=tex_util_1.TextureUsage.DOWNLOAD;var output=globals_1.tidy(function(){var program=shouldUsePackedProgram?new encode_float_packed_gpu_1.EncodeFloatPackedProgram(outputShape):new encode_float_gpu_1.EncodeFloatProgram(outputShape);return _this.compileAndRun(program,[{shape:outputShape,dtype:dtype,dataId:dataId}],tmpTarget,null)}),tmpData=this.texData.get(output.dataId),vals=this.gpgpu.downloadByteEncodedFloatMatrixFromOutputTexture(tmpData.texture,tmpData.texShape[0],tmpData.texShape[1]).subarray(0,size);return this.disposeData(tmpTarget.dataId),vals},MathBackendWebGL.prototype.time=function(f){return __awaiter(this,void 0,void 0,function(){var oldActiveTimers,newActiveTimers,outerMostTime,flattenedActiveTimerQueries,flattenedActiveTimerNames,kernelMs,res;return __generator(this,function(_a){switch(_a.label){case 0:return oldActiveTimers=this.activeTimers,outerMostTime=!(newActiveTimers=[]),null==this.programTimersStack?(this.programTimersStack=newActiveTimers,outerMostTime=!0):this.activeTimers.push(newActiveTimers),this.activeTimers=newActiveTimers,f(),flattenedActiveTimerQueries=util.flatten(this.activeTimers.map(function(d){return d.query})).filter(function(d){return null!=d}),flattenedActiveTimerNames=util.flatten(this.activeTimers.map(function(d){return d.name})).filter(function(d){return null!=d}),this.activeTimers=oldActiveTimers,outerMostTime&&(this.programTimersStack=null),[4,Promise.all(flattenedActiveTimerQueries)];case 1:return kernelMs=_a.sent(),res={uploadWaitMs:this.uploadWaitMs,downloadWaitMs:this.downloadWaitMs,kernelMs:util.sum(kernelMs),getExtraProfileInfo:function(){return kernelMs.map(function(d,i){return{name:flattenedActiveTimerNames[i],ms:d}}).map(function(d){return d.name+": "+d.ms}).join(", ")},wallMs:null},this.uploadWaitMs=0,this.downloadWaitMs=0,[2,res]}})})},MathBackendWebGL.prototype.memory=function(){return{unreliable:!1,numBytesInGPU:this.numBytesInGPU}},MathBackendWebGL.prototype.startTimer=function(){return 0<environment_1.ENV.getNumber("WEBGL_DISJOINT_QUERY_TIMER_EXTENSION_VERSION")?this.gpgpu.beginQuery():{startMs:util.now(),endMs:null}},MathBackendWebGL.prototype.endTimer=function(query){return 0<environment_1.ENV.getNumber("WEBGL_DISJOINT_QUERY_TIMER_EXTENSION_VERSION")?this.gpgpu.endQuery():query.endMs=util.now(),query},MathBackendWebGL.prototype.getQueryTime=function(query){return __awaiter(this,void 0,void 0,function(){var timerQuery;return __generator(this,function(_a){return 0<environment_1.ENV.getNumber("WEBGL_DISJOINT_QUERY_TIMER_EXTENSION_VERSION")?[2,this.gpgpu.waitForQueryAndGetTime(query)]:[2,(timerQuery=query).endMs-timerQuery.startMs]})})},MathBackendWebGL.prototype.disposeData=function(dataId){if(!this.pendingDisposal.has(dataId))if(this.pendingRead.has(dataId))this.pendingDisposal.add(dataId);else if(this.texData.has(dataId)){this.releaseGPUData(dataId);var complexTensors=this.texData.get(dataId).complexTensors;null!=complexTensors&&(complexTensors.real.dispose(),complexTensors.imag.dispose()),this.texData.delete(dataId)}},MathBackendWebGL.prototype.releaseGPUData=function(dataId){var _a=this.texData.get(dataId),texture=_a.texture,dtype=_a.dtype,texShape=_a.texShape,usage=_a.usage,isPacked=_a.isPacked,slice=_a.slice,key=slice&&slice.origDataId||dataId,refCount=this.dataRefCount.get(key);1<refCount?this.dataRefCount.set(key,refCount-1):(this.dataRefCount.delete(key),null!=texture&&(this.numBytesInGPU-=this.computeBytes(texShape,dtype),this.textureManager.releaseTexture(texture,texShape,usage,isPacked)));var texData=this.texData.get(dataId);texData.texture=null,texData.texShape=null,texData.isPacked=!1,texData.slice=null},MathBackendWebGL.prototype.getTexture=function(dataId){return this.uploadToGPU(dataId),this.texData.get(dataId).texture},MathBackendWebGL.prototype.getCPUBackend=function(){return environment_1.ENV.getBool("WEBGL_CPU_FORWARD")?(null==this.cpuBackend&&(this.cpuBackend=engine_1.ENGINE.findBackend("cpu")),this.cpuBackend):null},MathBackendWebGL.prototype.shouldExecuteOnCPU=function(inputs,sizeThreshold){var _this=this;return void 0===sizeThreshold&&(sizeThreshold=128),null!=this.getCPUBackend()&&inputs.every(function(input){return null==_this.texData.get(input.dataId).texture&&input.size<sizeThreshold})},MathBackendWebGL.prototype.getGPGPUContext=function(){return this.gpgpu},MathBackendWebGL.prototype.complex=function(real,imag){var result=this.makeOutputArray(real.shape,"complex64");return this.texData.get(result.dataId).complexTensors={real:engine_1.ENGINE.keep(real.clone()),imag:engine_1.ENGINE.keep(imag.clone())},result},MathBackendWebGL.prototype.real=function(input){return this.texData.get(input.dataId).complexTensors.real.clone()},MathBackendWebGL.prototype.imag=function(input){return this.texData.get(input.dataId).complexTensors.imag.clone()},MathBackendWebGL.prototype.slice=function(x,begin,size){if(this.shouldExecuteOnCPU([x]))return this.cpuBackend.slice(x,begin,size);if(0===util.sizeFromShape(size))return tensor_ops_1.tensor([],size,x.dtype);var isPacked=this.texData.get(x.dataId).isPacked,isContinous=slice_util_1.isSliceContinous(x.shape,begin,size);if(!isPacked&&isContinous)return this.uploadToGPU(x.dataId),this.shallowSlice(x,begin,size);var program=environment_1.ENV.getBool("WEBGL_PACK_ARRAY_OPERATIONS")?new slice_packed_gpu_1.SlicePackedProgram(size):new slice_gpu_1.SliceProgram(size),customSetup=program.getCustomSetupFunc(begin);return this.compileAndRun(program,[x],null,customSetup)},MathBackendWebGL.prototype.shallowSlice=function(x,begin,size){var xTexData=this.texData.get(x.dataId),t=tensor_1.Tensor.make(size,{},x.dtype,this),newTexData=this.texData.get(t.dataId);Object.assign(newTexData,xTexData),newTexData.shape=size,newTexData.dtype=x.dtype;var flatOffset=slice_util_1.computeFlatOffset(begin,x.strides);xTexData.slice&&(flatOffset+=xTexData.slice.flatOffset),newTexData.slice={flatOffset:flatOffset,origDataId:xTexData.slice&&xTexData.slice.origDataId||x.dataId};var refCount=this.dataRefCount.get(newTexData.slice.origDataId)||1;return this.dataRefCount.set(newTexData.slice.origDataId,refCount+1),t},MathBackendWebGL.prototype.stridedSlice=function(x,begin,end,strides,beginMask,endMask,ellipsisMask,newAxisMask,shrinkAxisMask){if(this.shouldExecuteOnCPU([x]))return this.cpuBackend.stridedSlice(x,begin,end,strides,beginMask,endMask,ellipsisMask,newAxisMask,shrinkAxisMask);var _a=slice_util_1.getStridedSlicedInfo(x.shape,begin,end,strides,beginMask,endMask,ellipsisMask,newAxisMask,shrinkAxisMask),beginIndex=_a[0],size=_a[1],shrinkAxis=_a[2],shape=size.filter(function(v,index){return-1===shrinkAxis.indexOf(index)});if(shape.some(function(axis){return 0===axis}))return tensor_ops_1.tensor([],shape);var program=new strided_slice_gpu_1.StridedSliceProgram(beginIndex,strides,size,shrinkAxis);return this.compileAndRun(program,[x])},MathBackendWebGL.prototype.reverse=function(x,axis){var program=environment_1.ENV.getBool("WEBGL_PACK_ARRAY_OPERATIONS")?new reverse_packed_gpu_1.ReversePackedProgram(x.shape,axis):new reverse_gpu_1.ReverseProgram(x.shape,axis);return this.compileAndRun(program,[x])},MathBackendWebGL.prototype.concat=function(tensors,axis){if("complex64"===tensors[0].dtype){var reals=tensors.map(function(t){return complex_ops_1.real(t)}),imags=tensors.map(function(t){return complex_ops_1.imag(t)});return complex_ops_1.complex(this.concat(reals,axis),this.concat(imags,axis))}if(this.shouldExecuteOnCPU(tensors))return this.cpuBackend.concat(tensors,axis);if(1===tensors.length)return tensors[0];if(tensors.length>environment_1.ENV.getNumber("WEBGL_MAX_TEXTURES_IN_SHADER")){var midIndex=Math.floor(tensors.length/2),leftSide=this.concat(tensors.slice(0,midIndex),axis),rightSide=this.concat(tensors.slice(midIndex),axis);return this.concat([leftSide,rightSide],axis)}if(environment_1.ENV.getBool("WEBGL_PACK_ARRAY_OPERATIONS")&&1<tensors[0].rank){var program_1=new concat_packed_gpu_1.ConcatPackedProgram(tensors.map(function(t){return t.shape}),axis);return this.compileAndRun(program_1,tensors)}var outShape=concat_util_1.computeOutShape(tensors.map(function(t){return t.shape}),axis),tensors2D=tensors.map(function(t){return t.as2D(-1,util_1.sizeFromShape(t.shape.slice(axis)))}),program=new concat_gpu_1.ConcatProgram(tensors2D.map(function(t){return t.shape}));return this.compileAndRun(program,tensors2D).reshape(outShape)},MathBackendWebGL.prototype.neg=function(x){var program=new unaryop_gpu_1.UnaryOpProgram(x.shape,unary_op.NEG);return this.compileAndRun(program,[x])},MathBackendWebGL.prototype.batchMatMul=function(a,b,transposeA,transposeB){var outerShapeA=transposeA?a.shape[2]:a.shape[1],outerShapeB=transposeB?b.shape[1]:b.shape[2],sharedDim=transposeA?a.shape[1]:a.shape[2],batch=a.shape[0];if((1===outerShapeA||1===outerShapeB)&&sharedDim>exports.MATMUL_SHARED_DIM_THRESHOLD){transposeA&&(a=a.transpose([0,2,1])),transposeB&&(b=b.transpose([0,2,1]));var a3D=1===outerShapeB?a:a.as3D(batch,sharedDim,1),axis=1===outerShapeB?2:1,b3D=1===outerShapeB?b.as3D(batch,1,sharedDim):b;return this.multiply(a3D,b3D).sum(axis,!0)}var dtype=types_1.upcastType(a.dtype,b.dtype),program=new mulmat_packed_gpu_1.MatMulPackedProgram(a.shape,[batch,outerShapeA,outerShapeB],transposeA,transposeB),output=this.makePackedTensor(program.outputShape,dtype);return this.compileAndRun(program,[a,b],output)},MathBackendWebGL.prototype.fusedBatchMatMul=function(_a){var a=_a.a,b=_a.b,transposeA=_a.transposeA,transposeB=_a.transposeB,bias=_a.bias,activation=_a.activation,preluActivationWeights=_a.preluActivationWeights,outerShapeA=transposeA?a.shape[2]:a.shape[1],outerShapeB=transposeB?b.shape[1]:b.shape[2],batch=a.shape[0],dtype=types_1.upcastType(a.dtype,b.dtype),hasBias=null!=bias,hasPreluActivationWeights=null!=preluActivationWeights,fusedActivation=activation?mapActivationToShaderProgram(activation,!0):null,program=new mulmat_packed_gpu_1.MatMulPackedProgram(a.shape,[batch,outerShapeA,outerShapeB],transposeA,transposeB,hasBias,fusedActivation,hasPreluActivationWeights),output=this.makePackedTensor(program.outputShape,dtype),inputs=[a,b];return bias&&inputs.push(bias),preluActivationWeights&&inputs.push(preluActivationWeights),this.compileAndRun(program,inputs,output)},MathBackendWebGL.prototype.multiply=function(a,b){if("complex64"===a.dtype){var aData=this.texData.get(a.dataId),bData=this.texData.get(b.dataId),realProgram=new binaryop_complex_gpu_1.BinaryOpComplexProgram(binaryop_complex_gpu.COMPLEX_MULTIPLY.REAL,a.shape,b.shape),imagProgram=new binaryop_complex_gpu_1.BinaryOpComplexProgram(binaryop_complex_gpu.COMPLEX_MULTIPLY.IMAG,a.shape,b.shape),inputs=[this.makeComplexComponentTensorHandle(a,aData.complexTensors.real),this.makeComplexComponentTensorHandle(a,aData.complexTensors.imag),this.makeComplexComponentTensorHandle(b,bData.complexTensors.real),this.makeComplexComponentTensorHandle(b,bData.complexTensors.imag)],real_1=this.compileAndRun(realProgram,inputs),imag_1=this.compileAndRun(imagProgram,inputs),complex_1=this.complex(real_1,imag_1);return real_1.dispose(),imag_1.dispose(),complex_1}if(this.shouldExecuteOnCPU([a,b]))return this.cpuBackend.multiply(a,b);if(environment_1.ENV.getBool("WEBGL_PACK_BINARY_OPERATIONS"))return this.packedBinaryOp(a,b,binaryop_gpu.MUL,a.dtype);var program=new binaryop_gpu_1.BinaryOpProgram(binaryop_gpu.MUL,a.shape,b.shape),output=this.makeOutputArray(program.outputShape,a.dtype);return this.compileAndRun(program,[a,b],output)},MathBackendWebGL.prototype.batchNormalization=function(x,mean,variance,varianceEpsilon,scale,offset){var inputs=[x,mean,variance],offsetShape=null;null!=offset&&(offsetShape=offset.shape,inputs.push(offset));var scaleShape=null;if(null!=scale&&(scaleShape=scale.shape,inputs.push(scale)),environment_1.ENV.getBool("WEBGL_PACK_NORMALIZATION")){var batchNormPackedProgram=new batchnorm_packed_gpu_1.BatchNormPackedProgram(x.shape,mean.shape,variance.shape,offsetShape,scaleShape,varianceEpsilon);return this.compileAndRun(batchNormPackedProgram,inputs)}var batchNormProgram=new batchnorm_gpu_1.BatchNormProgram(x.shape,mean.shape,variance.shape,offsetShape,scaleShape,varianceEpsilon);return this.compileAndRun(batchNormProgram,inputs)},MathBackendWebGL.prototype.localResponseNormalization4D=function(x,radius,bias,alpha,beta){var program=environment_1.ENV.getBool("WEBGL_PACK_NORMALIZATION")?new lrn_packed_gpu_1.LRNPackedProgram(x.shape,radius,bias,alpha,beta):new lrn_gpu_1.LRNProgram(x.shape,radius,bias,alpha,beta);return this.compileAndRun(program,[x])},MathBackendWebGL.prototype.LRNGrad=function(dy,inputImage,outputImage,depthRadius,bias,alpha,beta){var program=new lrn_grad_gpu_1.LRNGradProgram(inputImage.shape,depthRadius,bias,alpha,beta);return this.compileAndRun(program,[inputImage,outputImage,dy])},MathBackendWebGL.prototype.tile=function(x,reps){if("string"===x.dtype){var decodedData=this.readSync(x.dataId).map(function(d){return util.decodeString(d)}),buf=array_ops_1.buffer(x.shape,x.dtype,decodedData);return tile_impl_1.tile(buf,reps)}var program=new tile_gpu_1.TileProgram(x.shape,reps);return this.compileAndRun(program,[x])},MathBackendWebGL.prototype.pad=function(x,paddings,constantValue){var program=environment_1.ENV.getBool("WEBGL_PACK_ARRAY_OPERATIONS")?new pad_packed_gpu_1.PadPackedProgram(x.shape,paddings,constantValue):new pad_gpu_1.PadProgram(x.shape,paddings,constantValue);return this.compileAndRun(program,[x])},MathBackendWebGL.prototype.transpose=function(x,perm){if(this.shouldExecuteOnCPU([x]))return this.cpuBackend.transpose(x,perm);var program=environment_1.ENV.getBool("WEBGL_PACK_ARRAY_OPERATIONS")?new transpose_packed_gpu_1.TransposePackedProgram(x.shape,perm):new transpose_gpu_1.TransposeProgram(x.shape,perm);return this.compileAndRun(program,[x])},MathBackendWebGL.prototype.gather=function(x,indices,axis){if(this.shouldExecuteOnCPU([x,indices]))return this.cpuBackend.gather(x,indices,axis);var program=new gather_gpu_1.GatherProgram(x.shape,indices.size,axis);return this.compileAndRun(program,[x,indices])},MathBackendWebGL.prototype.batchToSpaceND=function(x,blockShape,crops){util.assert(x.rank<=4,function(){return"batchToSpaceND for rank > 4 with a WebGL backend not implemented yet"});var prod=blockShape.reduce(function(a,b){return a*b}),reshaped=array_ops_util.getReshaped(x.shape,blockShape,prod),permuted=array_ops_util.getPermuted(reshaped.length,blockShape.length),reshapedPermuted=array_ops_util.getReshapedPermuted(x.shape,blockShape,prod),sliceBeginCoords=array_ops_util.getSliceBeginCoords(crops,blockShape.length),sliceSize=array_ops_util.getSliceSize(reshapedPermuted,crops,blockShape.length);return x.reshape(reshaped).transpose(permuted).reshape(reshapedPermuted).slice(sliceBeginCoords,sliceSize)},MathBackendWebGL.prototype.spaceToBatchND=function(x,blockShape,paddings){util.assert(x.rank<=4,function(){return"spaceToBatchND for rank > 4 with a WebGL backend not implemented yet"});var prod=blockShape.reduce(function(a,b){return a*b}),completePaddings=[[0,0]];completePaddings.push.apply(completePaddings,paddings);for(var i=1+blockShape.length;i<x.shape.length;++i)completePaddings.push([0,0]);var paddedX=x.pad(completePaddings),reshapedPaddedShape=array_ops_util.getReshaped(paddedX.shape,blockShape,prod,!1),permutedReshapedPaddedPermutation=array_ops_util.getPermuted(reshapedPaddedShape.length,blockShape.length,!1),flattenShape=array_ops_util.getReshapedPermuted(paddedX.shape,blockShape,prod,!1);return paddedX.reshape(reshapedPaddedShape).transpose(permutedReshapedPaddedPermutation).reshape(flattenShape)},MathBackendWebGL.prototype.reduce=function(x,reduceType,dtype){var batchSize=x.shape[0],inSize=x.shape[1],reduceInfo={windowSize:reduce_util.computeOptimalWindowSize(inSize),inSize:inSize,batchSize:batchSize},program=new reduce_gpu_1.ReduceProgram(reduceInfo,reduceType),_a=program.outputShape,rows=_a[0],cols=_a[1],output=this.makeOutputArray([rows,cols],dtype);return this.compileAndRun(program,[x],output),1===output.shape[1]?output:this.reduce(output,reduceType,dtype)},MathBackendWebGL.prototype.argReduce=function(x,reduceType,bestIndicesA){void 0===bestIndicesA&&(bestIndicesA=null);var batchSize=x.shape[0],inSize=x.shape[1];null!=bestIndicesA&&(batchSize=bestIndicesA.shape[0],inSize=bestIndicesA.shape[1]);var reduceInfo={windowSize:reduce_util.computeOptimalWindowSize(inSize),inSize:inSize,batchSize:batchSize},program=new argminmax_gpu_1.ArgMinMaxProgram(reduceInfo,reduceType,null==bestIndicesA),_a=program.outputShape,rows=_a[0],cols=_a[1],output=this.makeOutputArray([rows,cols],"int32"),inputs=[x];return null!=bestIndicesA&&inputs.push(bestIndicesA),this.compileAndRun(program,inputs,output),1===output.shape[1]?output:this.argReduce(x,reduceType,output)},MathBackendWebGL.prototype.argReducePacked=function(x,reduceType,bestIndicesA){void 0===bestIndicesA&&(bestIndicesA=null);var inShape=null!=bestIndicesA?bestIndicesA.shape:x.shape,inSize=inShape[inShape.length-1],windowSize=reduce_util.computeOptimalWindowSize(inSize),program=new argminmax_packed_gpu_1.ArgMinMaxPackedProgram(inShape,windowSize,reduceType,null==bestIndicesA),output=this.makePackedTensor(program.outputShape,"int32"),inputs=null==bestIndicesA?[x]:[x,bestIndicesA];return this.compileAndRun(program,inputs,output),output.rank===x.rank?this.argReducePacked(x,reduceType,output):output},MathBackendWebGL.prototype.sum=function(x,axes){axis_util.assertAxesAreInnerMostDims("sum",axes,x.rank);var _a=axis_util.computeOutAndReduceShapes(x.shape,axes),outShape=_a[0],reduceShape=_a[1],inSize=util.sizeFromShape(reduceShape),a2D=x.as2D(-1,inSize),outputDType=types_1.sumOutType(x.dtype);return this.reduce(a2D,"sum",outputDType).reshape(outShape)},MathBackendWebGL.prototype.prod=function(x,axes){if(this.shouldExecuteOnCPU([x]))return this.cpuBackend.prod(x,axes);var _a=axis_util.computeOutAndReduceShapes(x.shape,axes),outShape=_a[0],reduceShape=_a[1],inSize=util.sizeFromShape(reduceShape),a2D=x.as2D(-1,inSize),outputDType=types_1.sumOutType(x.dtype);return this.reduce(a2D,"prod",outputDType).reshape(outShape)},MathBackendWebGL.prototype.unsortedSegmentSum=function(x,segmentIds,numSegments){var axis=0,permutation=axis_util.getAxesPermutation([axis],x.rank),permutedX=x;null!=permutation&&(permutedX=x.transpose(permutation),axis=axis_util.getInnerMostAxes(1,x.rank)[0]);var outShape=segment_util.computeOutShape(permutedX.shape,axis,numSegments),inSize=util.sizeFromShape([permutedX.shape[axis]]),a2D=permutedX.as2D(-1,inSize),outputDType=types_1.sumOutType(x.dtype),result=this.segOpCompute(a2D,"unsortedSegmentSum",segmentIds,outputDType,numSegments).reshape(outShape);return null!=permutation&&(result=result.transpose(axis_util.getUndoAxesPermutation(permutation))),result},MathBackendWebGL.prototype.segOpCompute=function(x,segOpType,segmentIds,dtype,numSegments){var batchSize=x.shape[0],inSize=x.shape[1],windowSize=segment_util.segOpComputeOptimalWindowSize(inSize,numSegments),segOpInfo={windowSize:windowSize,inSize:inSize,batchSize:batchSize,numSegments:numSegments},program=new segment_gpu_1.SegmentOpProgram(segOpInfo,segOpType),_a=program.outputShape,rows=_a[0],cols=_a[1],output=this.makeOutputArray([rows,cols],dtype);return this.compileAndRun(program,[x,segmentIds],output),output.shape[1]===numSegments?output:(segmentIds=tensor_ops_1.range(0,numSegments).tile([inSize/windowSize]),this.segOpCompute(output,segOpType,segmentIds,dtype,numSegments))},MathBackendWebGL.prototype.argMinMaxReduce=function(x,axis,reduceType){var axes=[axis];if(axis_util.assertAxesAreInnerMostDims("arg"+reduceType.charAt(0).toUpperCase()+reduceType.slice(1),axes,x.rank),!environment_1.ENV.getBool("WEBGL_PACK_REDUCE")||x.rank<=2){var _a=axis_util.computeOutAndReduceShapes(x.shape,axes),outShape=_a[0],reduceShape=_a[1],inSize=util.sizeFromShape(reduceShape),a2D=x.as2D(-1,inSize);return this.argReduce(a2D,reduceType).reshape(outShape)}return this.argReducePacked(x,reduceType)},MathBackendWebGL.prototype.argMin=function(x,axis){return this.argMinMaxReduce(x,axis,"min")},MathBackendWebGL.prototype.argMax=function(x,axis){return this.argMinMaxReduce(x,axis,"max")},MathBackendWebGL.prototype.cumsum=function(x,axis,exclusive,reverse){if(axis!==x.rank-1)throw new Error("WebGL cumsum shader expects an inner-most axis="+(x.rank-1)+" but got axis="+axis);var program=new cumsum_gpu_1.CumSumProgram(x.shape,exclusive,reverse);return this.compileAndRun(program,[x])},MathBackendWebGL.prototype.equal=function(a,b){if(environment_1.ENV.getBool("WEBGL_PACK_BINARY_OPERATIONS"))return this.packedBinaryOp(a,b,binaryop_packed_gpu.EQUAL,"bool");var program=new binaryop_gpu_1.BinaryOpProgram(binaryop_gpu.EQUAL,a.shape,b.shape),output=this.makeOutputArray(program.outputShape,"bool");return this.compileAndRun(program,[a,b],output)},MathBackendWebGL.prototype.notEqual=function(a,b){if(environment_1.ENV.getBool("WEBGL_PACK_BINARY_OPERATIONS"))return this.packedBinaryOp(a,b,binaryop_packed_gpu.NOT_EQUAL,"bool");var program=new binaryop_gpu_1.BinaryOpProgram(binaryop_gpu.NOT_EQUAL,a.shape,b.shape),output=this.makeOutputArray(program.outputShape,"bool");return this.compileAndRun(program,[a,b],output)},MathBackendWebGL.prototype.less=function(a,b){if(this.shouldExecuteOnCPU([a,b]))return this.cpuBackend.less(a,b);if(environment_1.ENV.getBool("WEBGL_PACK_BINARY_OPERATIONS"))return this.packedBinaryOp(a,b,binaryop_packed_gpu.LESS,"bool");var program=new binaryop_gpu_1.BinaryOpProgram(binaryop_gpu.LESS,a.shape,b.shape),output=this.makeOutputArray(program.outputShape,"bool");return this.compileAndRun(program,[a,b],output)},MathBackendWebGL.prototype.lessEqual=function(a,b){if(environment_1.ENV.getBool("WEBGL_PACK_BINARY_OPERATIONS"))return this.packedBinaryOp(a,b,binaryop_packed_gpu.LESS_EQUAL,"bool");var program=new binaryop_gpu_1.BinaryOpProgram(binaryop_gpu.LESS_EQUAL,a.shape,b.shape),output=this.makeOutputArray(program.outputShape,"bool");return this.compileAndRun(program,[a,b],output)},MathBackendWebGL.prototype.greater=function(a,b){if(this.shouldExecuteOnCPU([a,b]))return this.cpuBackend.greater(a,b);if(environment_1.ENV.getBool("WEBGL_PACK_BINARY_OPERATIONS"))return this.packedBinaryOp(a,b,binaryop_packed_gpu.GREATER,"bool");var program=new binaryop_gpu_1.BinaryOpProgram(binaryop_gpu.GREATER,a.shape,b.shape),output=this.makeOutputArray(program.outputShape,"bool");return this.compileAndRun(program,[a,b],output)},MathBackendWebGL.prototype.greaterEqual=function(a,b){if(environment_1.ENV.getBool("WEBGL_PACK_BINARY_OPERATIONS"))return this.packedBinaryOp(a,b,binaryop_packed_gpu.GREATER_EQUAL,"bool");var program=new binaryop_gpu_1.BinaryOpProgram(binaryop_gpu.GREATER_EQUAL,a.shape,b.shape),output=this.makeOutputArray(program.outputShape,"bool");return this.compileAndRun(program,[a,b],output)},MathBackendWebGL.prototype.logicalNot=function(x){var program=new unaryop_gpu_1.UnaryOpProgram(x.shape,unary_op.LOGICAL_NOT);return this.compileAndRun(program,[x])},MathBackendWebGL.prototype.logicalAnd=function(a,b){if(environment_1.ENV.getBool("WEBGL_PACK_BINARY_OPERATIONS"))return this.packedBinaryOp(a,b,binaryop_packed_gpu.LOGICAL_AND,"bool");var program=new binaryop_gpu_1.BinaryOpProgram(binaryop_gpu.LOGICAL_AND,a.shape,b.shape),output=this.makeOutputArray(program.outputShape,"bool");return this.compileAndRun(program,[a,b],output)},MathBackendWebGL.prototype.logicalOr=function(a,b){if(environment_1.ENV.getBool("WEBGL_PACK_BINARY_OPERATIONS"))return this.packedBinaryOp(a,b,binaryop_packed_gpu.LOGICAL_OR,"bool");var program=new binaryop_gpu_1.BinaryOpProgram(binaryop_gpu.LOGICAL_OR,a.shape,b.shape),output=this.makeOutputArray(program.outputShape,"bool");return this.compileAndRun(program,[a,b],output)},MathBackendWebGL.prototype.select=function(condition,a,b){var program=new select_gpu_1.SelectProgram(condition.rank,a.shape,a.rank),output=this.makeOutputArray(program.outputShape,types_1.upcastType(a.dtype,b.dtype));return this.compileAndRun(program,[condition,a,b],output)},MathBackendWebGL.prototype.where=function(condition){log_1.warn("tf.where() in webgl locks the UI thread. Call tf.whereAsync() instead");var condVals=condition.dataSync();return where_impl_1.whereImpl(condition.shape,condVals)},MathBackendWebGL.prototype.topk=function(x,k,sorted){var xVals=x.dataSync();return topk_impl_1.topkImpl(xVals,x.shape,x.dtype,k,sorted)},MathBackendWebGL.prototype.min=function(x,axes){axis_util.assertAxesAreInnerMostDims("min",axes,x.rank);var _a=axis_util.computeOutAndReduceShapes(x.shape,axes),outShape=_a[0],reduceShape=_a[1],inSize=util.sizeFromShape(reduceShape),a2D=x.as2D(-1,inSize);return this.reduce(a2D,"min",a2D.dtype).reshape(outShape)},MathBackendWebGL.prototype.minimum=function(a,b){if(this.shouldExecuteOnCPU([a,b]))return this.cpuBackend.minimum(a,b);var program=environment_1.ENV.getBool("WEBGL_PACK_BINARY_OPERATIONS")?new binaryop_packed_gpu_1.BinaryOpPackedProgram(binaryop_packed_gpu.MIN,a.shape,b.shape):new binaryop_gpu_1.BinaryOpProgram(binaryop_gpu.MIN,a.shape,b.shape);return this.compileAndRun(program,[a,b])},MathBackendWebGL.prototype.mod=function(a,b){var program=environment_1.ENV.getBool("WEBGL_PACK_BINARY_OPERATIONS")?new binaryop_packed_gpu_1.BinaryOpPackedProgram(binaryop_packed_gpu.MOD,a.shape,b.shape):new binaryop_gpu_1.BinaryOpProgram(binaryop_gpu.MOD,a.shape,b.shape);return this.compileAndRun(program,[a,b])},MathBackendWebGL.prototype.max=function(x,axes){if(this.shouldExecuteOnCPU([x]))return this.cpuBackend.max(x,axes);axis_util.assertAxesAreInnerMostDims("max",axes,x.rank);var _a=axis_util.computeOutAndReduceShapes(x.shape,axes),outShape=_a[0],reduceShape=_a[1],inSize=util.sizeFromShape(reduceShape),a2D=x.as2D(-1,inSize);return this.reduce(a2D,"max",a2D.dtype).reshape(outShape)},MathBackendWebGL.prototype.maximum=function(a,b){if(this.shouldExecuteOnCPU([a,b]))return this.cpuBackend.maximum(a,b);var program=environment_1.ENV.getBool("WEBGL_PACK_BINARY_OPERATIONS")?new binaryop_packed_gpu_1.BinaryOpPackedProgram(binaryop_packed_gpu.MAX,a.shape,b.shape):new binaryop_gpu_1.BinaryOpProgram(binaryop_gpu.MAX,a.shape,b.shape);return this.compileAndRun(program,[a,b])},MathBackendWebGL.prototype.all=function(x,axes){axis_util.assertAxesAreInnerMostDims("all",axes,x.rank);var _a=axis_util.computeOutAndReduceShapes(x.shape,axes),outShape=_a[0],reduceShape=_a[1],inSize=util.sizeFromShape(reduceShape),a2D=x.as2D(-1,inSize);return this.reduce(a2D,"all",a2D.dtype).reshape(outShape)},MathBackendWebGL.prototype.any=function(x,axes){axis_util.assertAxesAreInnerMostDims("any",axes,x.rank);var _a=axis_util.computeOutAndReduceShapes(x.shape,axes),outShape=_a[0],reduceShape=_a[1],inSize=util.sizeFromShape(reduceShape),a2D=x.as2D(-1,inSize);return this.reduce(a2D,"any",a2D.dtype).reshape(outShape)},MathBackendWebGL.prototype.squaredDifference=function(a,b){var program=environment_1.ENV.getBool("WEBGL_PACK_BINARY_OPERATIONS")?new binaryop_packed_gpu_1.BinaryOpPackedProgram(binaryop_gpu.SQUARED_DIFFERENCE,a.shape,b.shape):new binaryop_gpu_1.BinaryOpProgram(binaryop_gpu.SQUARED_DIFFERENCE,a.shape,b.shape);return this.compileAndRun(program,[a,b])},MathBackendWebGL.prototype.realDivide=function(a,b){var op=binaryop_gpu.DIV;if(environment_1.ENV.getBool("WEBGL_PACK_BINARY_OPERATIONS")){return this.packedBinaryOp(a,b,binaryop_packed_gpu.DIV,"float32",!0)}var program=new binaryop_gpu_1.BinaryOpProgram(op,a.shape,b.shape),output=this.makeOutputArray(program.outputShape,"float32");return this.compileAndRun(program,[a,b],output)},MathBackendWebGL.prototype.floorDiv=function(a,b){var op=binaryop_gpu.INT_DIV;if(environment_1.ENV.getBool("WEBGL_PACK_BINARY_OPERATIONS"))return this.packedBinaryOp(a,b,binaryop_packed_gpu.INT_DIV,"int32");var program=new binaryop_gpu_1.BinaryOpProgram(op,a.shape,b.shape),output=this.makeOutputArray(program.outputShape,"int32");return this.compileAndRun(program,[a,b],output)},MathBackendWebGL.prototype.add=function(a,b){if("complex64"===a.dtype&&"complex64"===b.dtype)return this.complexSeparableBinaryOp(a,b,binaryop_gpu.ADD);if(this.shouldExecuteOnCPU([a,b]))return this.cpuBackend.add(a,b);var dtype=types_1.upcastType(a.dtype,b.dtype);if(environment_1.ENV.getBool("WEBGL_PACK_BINARY_OPERATIONS"))return this.packedBinaryOp(a,b,binaryop_gpu.ADD,dtype);var program=new binaryop_gpu_1.BinaryOpProgram(binaryop_gpu.ADD,a.shape,b.shape),output=this.makeOutputArray(program.outputShape,dtype);return this.compileAndRun(program,[a,b],output)},MathBackendWebGL.prototype.packedBinaryOp=function(a,b,op,dtype,checkOutOfBounds){void 0===checkOutOfBounds&&(checkOutOfBounds=!1);var program=new binaryop_packed_gpu_1.BinaryOpPackedProgram(op,a.shape,b.shape,checkOutOfBounds),output=this.makePackedTensor(program.outputShape,dtype);return this.compileAndRun(program,[a,b],output)},MathBackendWebGL.prototype.complexSeparableBinaryOp=function(a,b,op){var _this=this,aData=this.texData.get(a.dataId),bData=this.texData.get(b.dataId),_a=[[aData.complexTensors.real,bData.complexTensors.real],[aData.complexTensors.imag,bData.complexTensors.imag]].map(function(complexParts){var aPart=complexParts[0],bPart=complexParts[1],aHandle=_this.makeComplexComponentTensorHandle(a,aPart),bHandle=_this.makeComplexComponentTensorHandle(b,bPart),program=new binaryop_gpu_1.BinaryOpProgram(op,a.shape,b.shape),output=_this.makeOutputArray(program.outputShape,types_1.upcastType(aPart.dtype,bPart.dtype));return _this.compileAndRun(program,[aHandle,bHandle],output)}),real=_a[0],imag=_a[1],complex=this.complex(real,imag);return real.dispose(),imag.dispose(),complex},MathBackendWebGL.prototype.makeComplexComponentTensorHandle=function(complexTensor,complexPart){return{dataId:complexPart.dataId,dtype:complexPart.dtype,shape:complexTensor.shape}},MathBackendWebGL.prototype.addN=function(tensors){if(1===tensors.length)return tensors[0];if(tensors.length>environment_1.ENV.get("WEBGL_MAX_TEXTURES_IN_SHADER")){var midIndex=Math.floor(tensors.length/2),leftSide=this.addN(tensors.slice(0,midIndex)),rightSide=this.addN(tensors.slice(midIndex));return this.addN([leftSide,rightSide])}var dtype=tensors.map(function(t){return t.dtype}).reduce(function(d1,d2){return types_1.upcastType(d1,d2)}),shapes=tensors.map(function(t){return t.shape}),usePackedOp=environment_1.ENV.getBool("WEBGL_PACK"),program=usePackedOp?new addn_packed_gpu_1.AddNPackedProgram(tensors[0].shape,shapes):new addn_gpu_1.AddNProgram(tensors[0].shape,shapes),output=usePackedOp?this.makePackedTensor(program.outputShape,dtype):this.makeOutputArray(program.outputShape,dtype);return this.compileAndRun(program,tensors,output)},MathBackendWebGL.prototype.subtract=function(a,b){if("complex64"===a.dtype&&"complex64"===b.dtype)return this.complexSeparableBinaryOp(a,b,binaryop_gpu.SUB);if(this.shouldExecuteOnCPU([a,b]))return this.cpuBackend.subtract(a,b);var dtype=types_1.upcastType(a.dtype,b.dtype);if(environment_1.ENV.getBool("WEBGL_PACK_BINARY_OPERATIONS"))return this.packedBinaryOp(a,b,binaryop_gpu.SUB,a.dtype);var program=new binaryop_gpu_1.BinaryOpProgram(binaryop_gpu.SUB,a.shape,b.shape),output=this.makeOutputArray(program.outputShape,dtype);return this.compileAndRun(program,[a,b],output)},MathBackendWebGL.prototype.pow=function(a,b){var usePackedOp=environment_1.ENV.getBool("WEBGL_PACK_BINARY_OPERATIONS"),program=usePackedOp?new binaryop_packed_gpu_1.BinaryOpPackedProgram(binaryop_packed_gpu.POW,a.shape,b.shape):new binaryop_gpu_1.BinaryOpProgram(binaryop_gpu.POW,a.shape,b.shape),dtype=types_1.upcastType(a.dtype,b.dtype),output=usePackedOp?this.makePackedTensor(program.outputShape,dtype):this.makeOutputArray(program.outputShape,dtype);return this.compileAndRun(program,[a,b],output)},MathBackendWebGL.prototype.ceil=function(x){var program=new unaryop_gpu_1.UnaryOpProgram(x.shape,unary_op.CEIL);return this.compileAndRun(program,[x])},MathBackendWebGL.prototype.floor=function(x){var program=new unaryop_gpu_1.UnaryOpProgram(x.shape,unary_op.FLOOR);return this.compileAndRun(program,[x])},MathBackendWebGL.prototype.sign=function(x){var program=new unaryop_gpu_1.UnaryOpProgram(x.shape,unary_op.SIGN);return this.compileAndRun(program,[x])},MathBackendWebGL.prototype.isNaN=function(x){var program=new unaryop_gpu_1.UnaryOpProgram(x.shape,unary_op.IS_NAN),output=this.makeOutputArray(program.outputShape,"bool");return this.compileAndRun(program,[x],output)},MathBackendWebGL.prototype.isInf=function(x){var program=new unaryop_gpu_1.UnaryOpProgram(x.shape,unary_op.IS_INF),output=this.makeOutputArray(program.outputShape,"bool");return this.compileAndRun(program,[x],output)},MathBackendWebGL.prototype.isFinite=function(x){var program=new unaryop_gpu_1.UnaryOpProgram(x.shape,unary_op.IS_FINITE),output=this.makeOutputArray(program.outputShape,"bool");return this.compileAndRun(program,[x],output)},MathBackendWebGL.prototype.round=function(x){var program=new unaryop_gpu_1.UnaryOpProgram(x.shape,unary_op.ROUND);return this.compileAndRun(program,[x])},MathBackendWebGL.prototype.exp=function(x){var program;return program=environment_1.ENV.getBool("WEBGL_PACK")?new unaryop_packed_gpu_1.UnaryOpPackedProgram(x.shape,unary_op.EXP):new unaryop_gpu_1.UnaryOpProgram(x.shape,unary_op.EXP),this.compileAndRun(program,[x])},MathBackendWebGL.prototype.expm1=function(x){var program=new unaryop_gpu_1.UnaryOpProgram(x.shape,unary_op.EXPM1);return this.compileAndRun(program,[x])},MathBackendWebGL.prototype.log=function(x){var program;return program=environment_1.ENV.getBool("WEBGL_PACK")?new unaryop_packed_gpu_1.UnaryOpPackedProgram(x.shape,unary_packed_op.LOG):new unaryop_gpu_1.UnaryOpProgram(x.shape,unary_op.LOG),this.compileAndRun(program,[x])},MathBackendWebGL.prototype.log1p=function(x){var program=new unaryop_gpu_1.UnaryOpProgram(x.shape,unary_op.LOG1P);return this.compileAndRun(program,[x])},MathBackendWebGL.prototype.sqrt=function(x){var program=new unaryop_gpu_1.UnaryOpProgram(x.shape,unary_op.SQRT);return this.compileAndRun(program,[x])},MathBackendWebGL.prototype.rsqrt=function(x){if(this.shouldExecuteOnCPU([x]))return this.cpuBackend.rsqrt(x);var program=new unaryop_gpu_1.UnaryOpProgram(x.shape,unary_op.RSQRT);return this.compileAndRun(program,[x])},MathBackendWebGL.prototype.square=function(x){var program=new unaryop_gpu_1.UnaryOpProgram(x.shape,unary_op.SQUARE);return this.compileAndRun(program,[x])},MathBackendWebGL.prototype.reciprocal=function(x){var program=new unaryop_gpu_1.UnaryOpProgram(x.shape,unary_op.RECIPROCAL);return this.compileAndRun(program,[x])},MathBackendWebGL.prototype.relu=function(x){var program;return program=environment_1.ENV.getBool("WEBGL_PACK")?new unaryop_packed_gpu_1.UnaryOpPackedProgram(x.shape,unary_packed_op.RELU):new unaryop_gpu_1.UnaryOpProgram(x.shape,unary_op.RELU),this.compileAndRun(program,[x])},MathBackendWebGL.prototype.prelu=function(x,alpha){var program=environment_1.ENV.getBool("WEBGL_PACK_BINARY_OPERATIONS")?new binaryop_packed_gpu_1.BinaryOpPackedProgram(binaryop_packed_gpu.PRELU,x.shape,alpha.shape):new binaryop_gpu_1.BinaryOpProgram(binaryop_gpu.PRELU,x.shape,alpha.shape);return this.compileAndRun(program,[x,alpha])},MathBackendWebGL.prototype.elu=function(x){var program=new unaryop_gpu_1.UnaryOpProgram(x.shape,unary_op.ELU);return this.compileAndRun(program,[x])},MathBackendWebGL.prototype.eluDer=function(dy,y){var program=environment_1.ENV.getBool("WEBGL_PACK_BINARY_OPERATIONS")?new binaryop_packed_gpu_1.BinaryOpPackedProgram(binaryop_packed_gpu.ELU_DER,dy.shape,y.shape):new binaryop_gpu_1.BinaryOpProgram(binaryop_gpu.ELU_DER,dy.shape,y.shape);return this.compileAndRun(program,[dy,y])},MathBackendWebGL.prototype.selu=function(x){var program=new unaryop_gpu_1.UnaryOpProgram(x.shape,unary_op.SELU);return this.compileAndRun(program,[x])},MathBackendWebGL.prototype.int=function(x){var program=new unaryop_gpu_1.UnaryOpProgram(x.shape,unary_op.TO_INT),output=this.makeOutputArray(program.outputShape,"int32");return this.compileAndRun(program,[x],output)},MathBackendWebGL.prototype.clip=function(x,min,max){var program,customSetup=(program=environment_1.ENV.getBool("WEBGL_PACK_CLIP")?new clip_packed_gpu_1.ClipPackedProgram(x.shape):new clip_gpu_1.ClipProgram(x.shape)).getCustomSetupFunc(min,max);return this.compileAndRun(program,[x],null,customSetup)},MathBackendWebGL.prototype.abs=function(x){var program=new unaryop_gpu_1.UnaryOpProgram(x.shape,unary_op.ABS);return this.compileAndRun(program,[x])},MathBackendWebGL.prototype.complexAbs=function(x){var xData=this.texData.get(x.dataId),program=new complex_abs_gpu_1.ComplexAbsProgram(x.shape),inputs=[this.makeComplexComponentTensorHandle(x,xData.complexTensors.real),this.makeComplexComponentTensorHandle(x,xData.complexTensors.imag)];return this.compileAndRun(program,inputs)},MathBackendWebGL.prototype.sigmoid=function(x){var program=new unaryop_gpu_1.UnaryOpProgram(x.shape,unary_op.SIGMOID);return this.compileAndRun(program,[x])},MathBackendWebGL.prototype.softplus=function(x){var program=new unaryop_gpu_1.UnaryOpProgram(x.shape,unary_op.SOFTPLUS);return this.compileAndRun(program,[x])},MathBackendWebGL.prototype.sin=function(x){var program=new unaryop_gpu_1.UnaryOpProgram(x.shape,unary_op.SIN);return this.compileAndRun(program,[x])},MathBackendWebGL.prototype.cos=function(x){var program=new unaryop_gpu_1.UnaryOpProgram(x.shape,unary_op.COS);return this.compileAndRun(program,[x])},MathBackendWebGL.prototype.tan=function(x){var program=new unaryop_gpu_1.UnaryOpProgram(x.shape,unary_op.TAN);return this.compileAndRun(program,[x])},MathBackendWebGL.prototype.asin=function(x){var program=new unaryop_gpu_1.UnaryOpProgram(x.shape,unary_op.ASIN);return this.compileAndRun(program,[x])},MathBackendWebGL.prototype.acos=function(x){var program=new unaryop_gpu_1.UnaryOpProgram(x.shape,unary_op.ACOS);return this.compileAndRun(program,[x])},MathBackendWebGL.prototype.atan=function(x){var program=new unaryop_gpu_1.UnaryOpProgram(x.shape,unary_op.ATAN);return this.compileAndRun(program,[x])},MathBackendWebGL.prototype.atan2=function(a,b){var program=environment_1.ENV.getBool("WEBGL_PACK_BINARY_OPERATIONS")?new binaryop_packed_gpu_1.BinaryOpPackedProgram(binaryop_packed_gpu.ATAN2,a.shape,b.shape):new binaryop_gpu_1.BinaryOpProgram(binaryop_gpu.ATAN2,a.shape,b.shape);return this.compileAndRun(program,[a,b])},MathBackendWebGL.prototype.sinh=function(x){var program=new unaryop_gpu_1.UnaryOpProgram(x.shape,unary_op.SINH);return this.compileAndRun(program,[x])},MathBackendWebGL.prototype.cosh=function(x){var program=new unaryop_gpu_1.UnaryOpProgram(x.shape,unary_op.COSH);return this.compileAndRun(program,[x])},MathBackendWebGL.prototype.tanh=function(x){var program=new unaryop_gpu_1.UnaryOpProgram(x.shape,unary_op.TANH);return this.compileAndRun(program,[x])},MathBackendWebGL.prototype.asinh=function(x){var program=new unaryop_gpu_1.UnaryOpProgram(x.shape,unary_op.ASINH);return this.compileAndRun(program,[x])},MathBackendWebGL.prototype.acosh=function(x){var program=new unaryop_gpu_1.UnaryOpProgram(x.shape,unary_op.ACOSH);return this.compileAndRun(program,[x])},MathBackendWebGL.prototype.atanh=function(x){var program=new unaryop_gpu_1.UnaryOpProgram(x.shape,unary_op.ATANH);return this.compileAndRun(program,[x])},MathBackendWebGL.prototype.erf=function(x){var program=new unaryop_gpu_1.UnaryOpProgram(x.shape,unary_op.ERF);return this.compileAndRun(program,[x])},MathBackendWebGL.prototype.step=function(x,alpha){var program=new unaryop_gpu_1.UnaryOpProgram(x.shape,unary_op.STEP(alpha));return this.compileAndRun(program,[x])},MathBackendWebGL.prototype.conv2dByMatMul=function(x,filter,convInfo,bias,activation,preluActivationWeights){var xShape=x.shape,xTexData=this.texData.get(x.dataId),sharedMatMulDim=convInfo.inChannels,outerShapeX=xShape[0]*xShape[1]*xShape[2],outerShapeFilter=convInfo.outChannels,isChannelsLast="channelsLast"===convInfo.dataFormat,batchMatMulWillBeUnpacked=(1==outerShapeX||1===outerShapeFilter)&&sharedMatMulDim>exports.MATMUL_SHARED_DIM_THRESHOLD,reshapeWillBeExpensive=xShape[2]%2!=0&&!!xTexData.isPacked;if(batchMatMulWillBeUnpacked||!environment_1.ENV.getBool("WEBGL_LAZILY_UNPACK")||!environment_1.ENV.getBool("WEBGL_PACK_BINARY_OPERATIONS")||!reshapeWillBeExpensive){var targetShape_1=isChannelsLast?xShape[0]*xShape[1]*xShape[2]:xShape[0]*xShape[2]*xShape[3],xReshaped_1=this.reshape(x,[1,targetShape_1,convInfo.inChannels]),filterReshaped_1=this.reshape(filter,[1,convInfo.inChannels,convInfo.outChannels]);return this.reshape(this.fusedBatchMatMul({a:xReshaped_1,b:filterReshaped_1,transposeA:!1,transposeB:!1,bias:bias,activation:activation,preluActivationWeights:preluActivationWeights}),convInfo.outShape)}var targetShape=isChannelsLast?xShape[0]*xShape[1]*(xShape[2]+1):xShape[0]*xShape[2]*(xShape[3]+1),xReshaped=tensor_1.Tensor.make([1,targetShape,convInfo.inChannels],{dataId:x.dataId},x.dtype,this),originalXTexDataShape=xTexData.shape;xTexData.shape=xTexData.shape.slice(),xTexData.shape[xTexData.shape.length-2]++,util.assert(webgl_util.isReshapeFree(xTexData.shape,xReshaped.shape),function(){return"packed reshape "+xTexData.shape+" to "+xReshaped.shape+" isn't free"});var filterReshaped=this.reshape(filter,[1,convInfo.inChannels,convInfo.outChannels]),pointwiseConv=this.fusedBatchMatMul({a:xReshaped,b:filterReshaped,transposeA:!1,transposeB:!1,bias:bias,activation:activation,preluActivationWeights:preluActivationWeights}),pointwiseConvTexData=this.texData.get(pointwiseConv.dataId);return util.assert(pointwiseConvTexData.isPacked,function(){return"batchMatMul result is expected to be packed"}),xTexData.shape=originalXTexDataShape,pointwiseConvTexData.shape=convInfo.outShape,tensor_1.Tensor.make(convInfo.outShape,{dataId:pointwiseConv.dataId},pointwiseConv.dtype,this)},MathBackendWebGL.prototype.conv2dWithIm2Row=function(x,filter,convInfo,bias,activation,preluActivationWeights){var filterWidth=convInfo.filterWidth,filterHeight=convInfo.filterHeight,inChannels=convInfo.inChannels,outWidth=convInfo.outWidth,outHeight=convInfo.outHeight,isChannelsLast="channelsLast"===convInfo.dataFormat,sharedDim=filterWidth*filterHeight*inChannels,numCols=outHeight*outWidth,x2ColShape=[sharedDim,numCols],xSqueezed=x.squeeze([0]),w2Row=filter.reshape([1,sharedDim,-1]),im2ColProgram=new im2col_packed_gpu_1.Im2ColPackedProgram(x2ColShape,xSqueezed.shape,convInfo),im2Col=this.compileAndRun(im2ColProgram,[xSqueezed]).reshape([1,x2ColShape[0],x2ColShape[1]]),hasBias=null!=bias,hasPreluActivationWeights=null!=preluActivationWeights,fusedActivation=activation?mapActivationToShaderProgram(activation,!0):null,matmulProgram=new mulmat_packed_gpu_1.MatMulPackedProgram(im2Col.shape,[1,numCols,convInfo.outChannels],!0,!1,hasBias,fusedActivation,hasPreluActivationWeights),inputs=[im2Col,w2Row];bias&&inputs.push(bias),hasPreluActivationWeights&&inputs.push(preluActivationWeights);var product=this.compileAndRun(matmulProgram,inputs);return isChannelsLast?product.reshape([1,outHeight,outWidth,convInfo.outChannels]):product.reshape([1,convInfo.outChannels,outHeight,outWidth])},MathBackendWebGL.prototype.fusedConv2d=function(x,filter,convInfo,bias,activation,preluActivationWeights){if(1===convInfo.filterHeight&&1===convInfo.filterWidth&&1===convInfo.dilationHeight&&1===convInfo.dilationWidth&&1===convInfo.strideHeight&&1===convInfo.strideWidth&&("SAME"===convInfo.padInfo.type||"VALID"===convInfo.padInfo.type))return this.conv2dByMatMul(x,filter,convInfo,bias,activation,preluActivationWeights);if(environment_1.ENV.getBool("WEBGL_CONV_IM2COL")&&1===x.shape[0])return this.conv2dWithIm2Row(x,filter,convInfo,bias,activation,preluActivationWeights);var hasBias=null!=bias,hasPreluActivationWeights=null!=preluActivationWeights,fusedActivation=activation?mapActivationToShaderProgram(activation,!1):null,program=new conv_gpu_1.Conv2DProgram(convInfo,hasBias,fusedActivation,hasPreluActivationWeights),inputs=[x,filter];return bias&&inputs.push(bias),preluActivationWeights&&inputs.push(preluActivationWeights),this.compileAndRun(program,inputs)},MathBackendWebGL.prototype.conv2d=function(x,filter,convInfo){if(1===convInfo.filterHeight&&1===convInfo.filterWidth&&1===convInfo.dilationHeight&&1===convInfo.dilationWidth&&1===convInfo.strideHeight&&1===convInfo.strideWidth&&("SAME"===convInfo.padInfo.type||"VALID"===convInfo.padInfo.type))return this.conv2dByMatMul(x,filter,convInfo);if(environment_1.ENV.getBool("WEBGL_CONV_IM2COL")&&1===x.shape[0])return this.conv2dWithIm2Row(x,filter,convInfo);var program=new conv_gpu_1.Conv2DProgram(convInfo);return this.compileAndRun(program,[x,filter])},MathBackendWebGL.prototype.conv2dDerInput=function(dy,filter,convInfo){var program=new conv_backprop_gpu_1.Conv2DDerInputProgram(convInfo);return this.compileAndRun(program,[dy,filter])},MathBackendWebGL.prototype.conv2dDerFilter=function(x,dy,convInfo){var program=new conv_backprop_gpu_1.Conv2DDerFilterProgram(convInfo);return this.compileAndRun(program,[x,dy])},MathBackendWebGL.prototype.depthwiseConv2D=function(x,filter,convInfo){var program;return environment_1.ENV.getBool("WEBGL_PACK_DEPTHWISECONV")&&convInfo.strideWidth<=2&&convInfo.outChannels/convInfo.inChannels==1?(program=new conv_packed_gpu_depthwise_1.DepthwiseConvPacked2DProgram(convInfo),this.compileAndRun(program,[x,filter],this.makePackedTensor(convInfo.outShape,x.dtype))):(program=new conv_gpu_depthwise_1.DepthwiseConv2DProgram(convInfo),this.compileAndRun(program,[x,filter]))},MathBackendWebGL.prototype.depthwiseConv2DDerInput=function(dy,filter,convInfo){var program=new conv_backprop_gpu_depthwise_1.DepthwiseConv2DDerInputProgram(convInfo);return this.compileAndRun(program,[dy,filter])},MathBackendWebGL.prototype.depthwiseConv2DDerFilter=function(x,dy,convInfo){var program=new conv_backprop_gpu_depthwise_1.DepthwiseConv2DDerFilterProgram(convInfo);return this.compileAndRun(program,[x,dy])},MathBackendWebGL.prototype.conv3d=function(x,filter,convInfo){var program=new conv_gpu_1.Conv3DProgram(convInfo);return this.compileAndRun(program,[x,filter])},MathBackendWebGL.prototype.conv3dDerInput=function(dy,filter,convInfo){var program=new conv_backprop_gpu_1.Conv3DDerInputProgram(convInfo);return this.compileAndRun(program,[dy,filter])},MathBackendWebGL.prototype.conv3dDerFilter=function(x,dy,convInfo){var program=new conv_backprop_gpu_1.Conv3DDerFilterProgram(convInfo);return this.compileAndRun(program,[x,dy])},MathBackendWebGL.prototype.maxPool=function(x,convInfo){var program=new pool_gpu_1.Pool2DProgram(convInfo,"max",!1),output=this.makeOutputArray(program.outputShape,x.dtype);return this.compileAndRun(program,[x],output)},MathBackendWebGL.prototype.avgPool=function(x,convInfo){var program=new pool_gpu_1.Pool2DProgram(convInfo,"avg",!1),output=this.makeOutputArray(program.outputShape,"float32");return this.compileAndRun(program,[x],output)},MathBackendWebGL.prototype.maxPoolBackprop=function(dy,x,y,convInfo){var maxPoolPositionsProgram=new pool_gpu_1.Pool2DProgram(convInfo,"max",!0),maxPoolPositions=this.compileAndRun(maxPoolPositionsProgram,[x]),maxPoolBackPropProgram=new max_pool_backprop_gpu_1.MaxPool2DBackpropProgram(convInfo),output=this.makeOutputArray(maxPoolBackPropProgram.outputShape,x.dtype),result=this.compileAndRun(maxPoolBackPropProgram,[dy,maxPoolPositions],output);return maxPoolPositions.dispose(),result},MathBackendWebGL.prototype.avgPoolBackprop=function(dy,x,convInfo){var avgPoolBackpropProgram=new avg_pool_backprop_gpu_1.AvgPool2DBackpropProgram(convInfo),output=this.makeOutputArray(avgPoolBackpropProgram.outputShape,x.dtype);return this.compileAndRun(avgPoolBackpropProgram,[dy],output)},MathBackendWebGL.prototype.cast=function(x,dtype){return backend_util.castTensor(x,dtype,this)},MathBackendWebGL.prototype.unstack=function(x,axis){for(var num=x.shape[axis],outShape=new Array(x.rank-1),outIndex=0,i=0;i<x.rank;i++)i!==axis&&(outShape[outIndex++]=x.shape[i]);var begin=new Array(x.rank).fill(0),size=x.shape.slice();size[axis]=1;var res=new Array(num);for(i=0;i<res.length;i++)res[begin[axis]=i]=this.slice(x,begin,size).reshape(outShape);return res},MathBackendWebGL.prototype.avgPool3d=function(x,convInfo){var program=new pool_gpu_1.Pool3DProgram(convInfo,"avg",!1),output=this.makeOutputArray(program.outputShape,"float32");return this.compileAndRun(program,[x],output)},MathBackendWebGL.prototype.avgPool3dBackprop=function(dy,x,convInfo){var avgPool3dBackpropProgram=new avg_pool_backprop_gpu_1.AvgPool3DBackpropProgram(convInfo),output=this.makeOutputArray(avgPool3dBackpropProgram.outputShape,x.dtype);return this.compileAndRun(avgPool3dBackpropProgram,[dy],output)},MathBackendWebGL.prototype.maxPool3d=function(x,convInfo){var program=new pool_gpu_1.Pool3DProgram(convInfo,"max",!1),output=this.makeOutputArray(program.outputShape,"float32");return this.compileAndRun(program,[x],output)},MathBackendWebGL.prototype.maxPool3dBackprop=function(dy,x,y,convInfo){var maxPool3dPositionsProgram=new pool_gpu_1.Pool3DProgram(convInfo,"max",!0),maxPool3dPositions=this.compileAndRun(maxPool3dPositionsProgram,[x]),maxPool3dBackPropProgram=new max_pool_backprop_gpu_1.MaxPool3DBackpropProgram(convInfo),output=this.makeOutputArray(maxPool3dBackPropProgram.outputShape,x.dtype),result=this.compileAndRun(maxPool3dBackPropProgram,[dy,maxPool3dPositions],output);return maxPool3dPositions.dispose(),result},MathBackendWebGL.prototype.reshape=function(x,shape){var texData=this.texData.get(x.dataId);return!texData.isPacked||webgl_util.isReshapeFree(x.shape,shape)||null!==texData.texture&&webgl_util.isReshapeFree(texData.shape,shape)?backend_util.reshapeTensor(x,shape):this.packedReshape(x,shape)},MathBackendWebGL.prototype.resizeBilinear=function(x,newHeight,newWidth,alignCorners){var program=environment_1.ENV.getBool("WEBGL_PACK_IMAGE_OPERATIONS")?new resize_bilinear_packed_gpu_1.ResizeBilinearPackedProgram(x.shape,newHeight,newWidth,alignCorners):new resize_bilinear_gpu_1.ResizeBilinearProgram(x.shape,newHeight,newWidth,alignCorners);return this.compileAndRun(program,[x])},MathBackendWebGL.prototype.resizeBilinearBackprop=function(dy,x,alignCorners){var program=new resize_bilinear_backprop_gpu_1.ResizeBilinearBackpropProgram(dy,x,alignCorners);return this.compileAndRun(program,[dy])},MathBackendWebGL.prototype.resizeNearestNeighbor=function(x,newHeight,newWidth,alignCorners){var program=new resize_nearest_neighbor_gpu_1.ResizeNearestNeighborProgram(x.shape,newHeight,newWidth,alignCorners);return this.compileAndRun(program,[x])},MathBackendWebGL.prototype.resizeNearestNeighborBackprop=function(dy,x,alignCorners){var program=new resize_nearest_neighbor_backprop_gpu_1.ResizeNearestNeigborBackpropProgram(dy,x,alignCorners);return this.compileAndRun(program,[dy])},MathBackendWebGL.prototype.multinomial=function(logits,normalized,numSamples,seed){var probs=normalized?logits:softmax_1.softmax(logits),batchSize=probs.shape[0],numOutcomes=probs.shape[1],program=new multinomial_gpu_1.MultinomialProgram(batchSize,numOutcomes,numSamples),output=this.makeOutputArray(program.outputShape,"int32"),customSetup=program.getCustomSetupFunc(seed);return this.compileAndRun(program,[probs],output,customSetup)},MathBackendWebGL.prototype.oneHot=function(indices,depth,onValue,offValue){var program=new onehot_gpu_1.OneHotProgram(indices.size,depth,onValue,offValue);return this.compileAndRun(program,[indices])},MathBackendWebGL.prototype.diag=function(x){var program=new diag_gpu_1.DiagProgram(x.size);return this.compileAndRun(program,[x])},MathBackendWebGL.prototype.nonMaxSuppression=function(boxes,scores,maxOutputSize,iouThreshold,scoreThreshold){log_1.warn("tf.nonMaxSuppression() in webgl locks the UI thread. Call tf.nonMaxSuppressionAsync() instead");var boxesVals=boxes.dataSync(),scoresVals=scores.dataSync();return non_max_suppression_impl_1.nonMaxSuppressionImpl(boxesVals,scoresVals,maxOutputSize,iouThreshold,scoreThreshold)},MathBackendWebGL.prototype.cropAndResize=function(image,boxes,boxIndex,cropSize,method,extrapolationValue){var program=new crop_and_resize_gpu_1.CropAndResizeProgram(image.shape,boxes.shape,cropSize,method,extrapolationValue);return this.compileAndRun(program,[image,boxes,boxIndex])},MathBackendWebGL.prototype.depthToSpace=function(x,blockSize,dataFormat){util.assert(1<blockSize,function(){return"blockSize should be > 1 for depthToSpace, but was: "+blockSize});var batchSize=x.shape[0],inputHeight="NHWC"===dataFormat?x.shape[1]:x.shape[2],inputWidth="NHWC"===dataFormat?x.shape[2]:x.shape[3],inputDepth="NHWC"===dataFormat?x.shape[3]:x.shape[1],outputHeight=inputHeight*blockSize,outputWidth=inputWidth*blockSize,outputDepth=inputDepth/(blockSize*blockSize),outputShape="NHWC"===dataFormat?[batchSize,outputHeight,outputWidth,outputDepth]:[batchSize,outputDepth,outputHeight,outputWidth],program=new depth_to_space_gpu_1.DepthToSpaceProgram(outputShape,blockSize,dataFormat);return this.compileAndRun(program,[x])},MathBackendWebGL.prototype.split=function(x,sizeSplits,axis){return split_shared_1.split(x,sizeSplits,axis)},MathBackendWebGL.prototype.scatterND=function(indices,updates,shape){var _a=scatter_nd_util.calculateShapes(updates,indices,shape),sliceRank=_a.sliceRank,numUpdates=_a.numUpdates,sliceSize=_a.sliceSize,strides=_a.strides,outputSize=_a.outputSize,flattenShape=[outputSize/sliceSize,sliceSize],flattenIndices=indices.reshape([numUpdates,sliceRank]),flattenX=updates.reshape([numUpdates,sliceSize]);if(0===outputSize)return backend_util.reshapeTensor(tensor_ops_1.tensor([]),shape);var defaultValue=tensor_ops_1.scalar(0),program=new scatter_gpu_1.ScatterProgram(numUpdates,sliceRank,flattenIndices.rank,flattenX.rank,strides,flattenShape);return this.compileAndRun(program,[flattenX,flattenIndices,defaultValue]).reshape(shape)},MathBackendWebGL.prototype.sparseToDense=function(sparseIndices,sparseValues,outputShape,defaultValue){var _a=scatter_nd_util.calculateShapes(sparseValues,sparseIndices,outputShape),sliceRank=_a.sliceRank,numUpdates=_a.numUpdates,strides=_a.strides,outputSize=_a.outputSize,program=new scatter_gpu_1.ScatterProgram(numUpdates,sliceRank,sparseIndices.rank,sparseValues.rank,strides,[outputSize,1],!1);return this.compileAndRun(program,[sparseValues,sparseIndices,defaultValue]).reshape(outputShape)},MathBackendWebGL.prototype.fft=function(x){return this.fftImpl(x,!1)},MathBackendWebGL.prototype.ifft=function(x){return this.fftImpl(x,!0)},MathBackendWebGL.prototype.fftImpl=function(x,inverse){var xData=this.texData.get(x.dataId),realProgram=new fft_gpu_1.FFTProgram(fft_gpu.COMPLEX_FFT.REAL,x.shape,inverse),imagProgram=new fft_gpu_1.FFTProgram(fft_gpu.COMPLEX_FFT.IMAG,x.shape,inverse),inputs=[this.makeComplexComponentTensorHandle(x,xData.complexTensors.real),this.makeComplexComponentTensorHandle(x,xData.complexTensors.imag)],real=this.compileAndRun(realProgram,inputs),imag=this.compileAndRun(imagProgram,inputs),complex=this.complex(real,imag).as2D(x.shape[0],x.shape[1]);return real.dispose(),imag.dispose(),complex},MathBackendWebGL.prototype.gatherND=function(x,indices){var indicesShape=indices.shape,sliceRank=indicesShape[indicesShape.length-1],_a=gather_nd_util.prepareAndValidate(x,indices),resultShape=_a[0],numSlices=_a[1],sliceSize=_a[2],strides=_a[3],flattenIndices=indices.reshape([numSlices,sliceRank]),flattenX=x.reshape([x.size/sliceSize,sliceSize]),program=new gather_nd_gpu_1.GatherNDProgram(sliceRank,strides,[numSlices,sliceSize]);return this.compileAndRun(program,[flattenX,flattenIndices]).reshape(resultShape)},MathBackendWebGL.prototype.fill=function(shape,value,dtype){if("string"===(dtype=dtype||util_1.inferDtype(value))){var values=util_1.getArrayFromDType(dtype,util_1.sizeFromShape(shape));return values.fill(value),tensor_1.Tensor.make(shape,{values:values},dtype)}var program=new fill_gpu_1.FillProgram(shape,value),customSetup=program.getCustomSetupFunc(value),output=this.makeOutputArray(shape,dtype);return this.compileAndRun(program,[],output,customSetup)},MathBackendWebGL.prototype.onesLike=function(x){if("string"===x.dtype)throw new Error("onesLike is not supported under string dtype");return this.fill(x.shape,1,x.dtype)},MathBackendWebGL.prototype.zerosLike=function(x){return this.fill(x.shape,"string"===x.dtype?"":0,x.dtype)},MathBackendWebGL.prototype.linspace=function(start,stop,num){return backend_util.linspaceImpl(start,stop,num)},MathBackendWebGL.prototype.makeOutputArray=function(shape,dtype){return tensor_1.Tensor.make(shape,{},dtype,this)},MathBackendWebGL.prototype.makePackedTensor=function(shape,dtype){var packedTensor=tensor_1.Tensor.make(shape,{},dtype,this);return this.texData.get(packedTensor.dataId).isPacked=!0,packedTensor},MathBackendWebGL.prototype.unpackTensor=function(input){var program=new unpack_gpu_1.UnpackProgram(input.shape);return this.compileAndRun(program,[input],tensor_1.Tensor.make(program.outputShape,{},input.dtype,this))},MathBackendWebGL.prototype.packTensor=function(input){var program=new pack_gpu_1.PackProgram(input.shape);return this.compileAndRun(program,[input],this.makePackedTensor(input.shape,input.dtype),null,!0)},MathBackendWebGL.prototype.packedReshape=function(input,afterShape){var inputAs3D=input.reshape([webgl_util.getBatchDim(input.shape)].concat(webgl_util.getRowsCols(input.shape))),afterShapeAs3D=[webgl_util.getBatchDim(afterShape)].concat(webgl_util.getRowsCols(afterShape)),program=new reshape_packed_gpu_1.ReshapePackedProgram(afterShapeAs3D,inputAs3D.shape);return this.compileAndRun(program,[inputAs3D]).reshape(afterShape)},MathBackendWebGL.prototype.decode=function(dataId){var program,texData=this.texData.get(dataId),isPacked=texData.isPacked,shape=texData.shape,dtype=texData.dtype,shapeAs3D=webgl_util.getShapeAs3D(shape),denseTexShape=tex_util.getDenseTexShape(shape),tmpTarget=this.makeTensorHandle(shape,"float32");return this.texData.get(tmpTarget.dataId).isPacked=!0,this.texData.get(tmpTarget.dataId).dtype=dtype,this.texData.get(tmpTarget.dataId).texShape=denseTexShape.map(function(d){return 2*d}),program=isPacked?new decode_matrix_packed_gpu_1.DecodeMatrixPackedProgram(shapeAs3D,denseTexShape):new decode_matrix_gpu_1.DecodeMatrixProgram(shapeAs3D,denseTexShape),this.compileAndRun(program,[{shape:shapeAs3D,dtype:dtype,dataId:dataId}],tmpTarget,null,!0),tmpTarget},MathBackendWebGL.prototype.compileAndRun=function(program,inputs,output,customSetup,preventEagerUnpackingOfOutput){var _this=this;if(void 0===preventEagerUnpackingOfOutput&&(preventEagerUnpackingOfOutput=!1),null==output&&(output=program.usesPackedTextures?this.makePackedTensor(program.outputShape,inputs[0].dtype):this.makeOutputArray(program.outputShape,inputs[0].dtype)),0===output.size)return this.texData.get(output.dataId).values=util_1.getTypedArrayFromDType(output.dtype,0),output;var inputsData=inputs.map(function(input){if("complex64"===input.dtype)throw new Error("GPGPUProgram does not support complex64 input. For complex64 dtypes, please separate the program into real and imaginary parts.");var texData=_this.texData.get(input.dataId);if(null==texData.texture){if(!program.usesPackedTextures&&util.sizeFromShape(input.shape)<=environment_1.ENV.getNumber("WEBGL_SIZE_UPLOAD_UNIFORM"))return{shape:input.shape,texData:null,isUniform:!0,uniformValues:texData.values};program.usesPackedTextures&&(texData.isPacked=!0,texData.shape=input.shape)}else if(!!texData.isPacked!=!!program.usesPackedTextures)input=texData.isPacked?_this.unpackTensor(input):_this.packTensor(input),texData=_this.texData.get(input.dataId);else if(texData.isPacked&&!webgl_util.isReshapeFree(texData.shape,input.shape)){var savedInput=input,targetShape=input.shape;input.shape=texData.shape,input=_this.packedReshape(input,targetShape),texData=_this.texData.get(input.dataId),savedInput.shape=targetShape}return _this.uploadToGPU(input.dataId),{shape:input.shape,texData:texData,isUniform:!1}});this.uploadToGPU(output.dataId);var query,outputData={shape:output.shape,texData:this.texData.get(output.dataId),isUniform:!1},key=gpgpu_math.makeShaderKey(program,inputsData,outputData),binary=this.getAndSaveBinary(key,function(){return gpgpu_math.compileProgram(_this.gpgpu,program,inputsData,outputData)}),shouldTimeProgram=null!=this.activeTimers;return shouldTimeProgram&&(query=this.startTimer()),gpgpu_math.runProgram(this.gpgpu,binary,inputsData,outputData,customSetup),shouldTimeProgram&&(query=this.endTimer(query),this.activeTimers.push({name:program.constructor.name,query:this.getQueryTime(query)})),!environment_1.ENV.getBool("WEBGL_LAZILY_UNPACK")&&this.texData.get(output.dataId).isPacked&&!1===preventEagerUnpackingOfOutput?this.unpackTensor(output):output},MathBackendWebGL.prototype.getAndSaveBinary=function(key,getBinary){return key in this.binaryCache||(this.binaryCache[key]=getBinary()),this.binaryCache[key]},MathBackendWebGL.prototype.getTextureManager=function(){return this.textureManager},MathBackendWebGL.prototype.dispose=function(){this.disposed||(this.textureManager.dispose(),null!=this.canvas&&null!=this.canvas.remove?this.canvas.remove():this.canvas=null,null!=this.fromPixels2DContext&&this.fromPixels2DContext.canvas.remove&&this.fromPixels2DContext.canvas.remove(),this.gpgpuCreatedLocally&&(this.gpgpu.program=null,this.gpgpu.dispose()),this.disposed=!0)},MathBackendWebGL.prototype.floatPrecision=function(){var _this=this;return null==this.floatPrecisionValue&&(this.floatPrecisionValue=globals_1.tidy(function(){var debugFlag=environment_1.ENV.getBool("DEBUG");environment_1.ENV.set("DEBUG",!1);var underflowCheckValue=_this.abs(tensor_ops_1.scalar(1e-8)).dataSync()[0];return environment_1.ENV.set("DEBUG",debugFlag),0<underflowCheckValue?32:16})),this.floatPrecisionValue},MathBackendWebGL.prototype.epsilon=function(){return 32===this.floatPrecision()?backend_1.EPSILON_FLOAT32:backend_1.EPSILON_FLOAT16},MathBackendWebGL.prototype.uploadToGPU=function(dataId){var _a,texData=this.texData.get(dataId),shape=texData.shape,dtype=texData.dtype,values=texData.values,texture=texData.texture,usage=texData.usage,isPacked=texData.isPacked;if(null==texture){var start,shouldTimeProgram=null!=this.activeTimers;shouldTimeProgram&&(start=util.now());var texShape=texData.texShape;if(null==texShape&&(texShape=webgl_util.getTextureShapeFromLogicalShape(shape,isPacked),texData.texShape=texShape),null!=values){var shapeAs3D=webgl_util.getShapeAs3D(shape),program=void 0,width=texShape[1],height=texShape[0],isByteArray=values instanceof Uint8Array;program=isPacked?(width=(_a=tex_util.getPackedMatrixTextureShapeWidthHeight(texShape[0],texShape[1]))[0],height=_a[1],new encode_matrix_packed_gpu_1.EncodeMatrixPackedProgram(shapeAs3D,[height,width],isByteArray)):new encode_matrix_gpu_1.EncodeMatrixProgram(shapeAs3D,[height,width],isByteArray);var tempDenseInputHandle=this.makeTensorHandle([height,width],dtype);this.texData.get(tempDenseInputHandle.dataId).usage=isByteArray?tex_util_1.TextureUsage.PIXELS:tex_util_1.TextureUsage.UPLOAD,this.gpgpu.uploadDenseMatrixToTexture(this.getTexture(tempDenseInputHandle.dataId),width,height,values);var encodedOutputTarget=this.makeTensorHandle(program.outputShape,tempDenseInputHandle.dtype);encodedOutputTarget.size=util_1.sizeFromShape(program.outputShape),this.texData.get(encodedOutputTarget.dataId).isPacked=isPacked,this.compileAndRun(program,[tempDenseInputHandle],encodedOutputTarget);var outputTexData=this.texData.get(encodedOutputTarget.dataId);texData.texture=outputTexData.texture,texData.texShape=outputTexData.texShape,texData.isPacked=outputTexData.isPacked,texData.usage=outputTexData.usage,this.disposeData(tempDenseInputHandle.dataId),this.texData.delete(encodedOutputTarget.dataId),texData.values=null,shouldTimeProgram&&(this.uploadWaitMs+=util.now()-start)}else{var newTexture=this.acquireTexture(texShape,usage,dtype,isPacked);texData.texture=newTexture}}},MathBackendWebGL.prototype.convertAndCacheOnCPU=function(dataId,float32Values){var texData=this.texData.get(dataId),dtype=texData.dtype;return this.releaseGPUData(dataId),null!=float32Values&&(texData.values=function(a,dtype){{if("float32"===dtype||"complex64"===dtype)return a;if("int32"!==dtype&&"bool"!==dtype)throw new Error("Unknown dtype "+dtype);for(var result="int32"===dtype?new Int32Array(a.length):new Uint8Array(a.length),i=0;i<result.length;++i)result[i]=Math.round(a[i]);return result}}(float32Values,dtype)),texData.values},MathBackendWebGL.prototype.acquireTexture=function(texShape,texType,dtype,isPacked){if(this.numBytesInGPU+=this.computeBytes(texShape,dtype),!this.warnedAboutMemory&&this.numBytesInGPU>1024*this.numMBBeforeWarning*1024){var mb=(this.numBytesInGPU/1024/1024).toFixed(2);this.warnedAboutMemory=!0,console.warn("High memory usage in GPU: "+mb+" MB, most likely due to a memory leak")}return this.textureManager.acquireTexture(texShape,texType,isPacked)},MathBackendWebGL.prototype.computeBytes=function(shape,dtype){return shape[0]*shape[1]*util.bytesPerElement(dtype)},MathBackendWebGL}();exports.MathBackendWebGL=MathBackendWebGL,device_util.isBrowser()&&engine_1.ENGINE.registerBackend("webgl",function(){return new MathBackendWebGL},2)},{"../../device_util":142,"../../engine":143,"../../environment":144,"../../globals":146,"../../log":161,"../../ops/array_ops":163,"../../ops/array_ops_util":164,"../../ops/axis_util":165,"../../ops/complex_ops":172,"../../ops/concat_util":174,"../../ops/gather_nd_util":184,"../../ops/reduce_util":199,"../../ops/scatter_nd_util":204,"../../ops/segment_util":206,"../../ops/slice_util":210,"../../ops/softmax":211,"../../ops/tensor_ops":216,"../../tensor":234,"../../types":240,"../../util":241,"../backend":50,"../backend_util":51,"../complex_util":52,"../non_max_suppression_impl":54,"../split_shared":56,"../tile_impl":57,"../topk_impl":58,"../where_impl":140,"./addn_gpu":59,"./addn_packed_gpu":60,"./argminmax_gpu":61,"./argminmax_packed_gpu":62,"./avg_pool_backprop_gpu":63,"./batchnorm_gpu":65,"./batchnorm_packed_gpu":66,"./binaryop_complex_gpu":67,"./binaryop_gpu":68,"./binaryop_packed_gpu":69,"./canvas_util":70,"./clip_gpu":71,"./clip_packed_gpu":72,"./complex_abs_gpu":73,"./concat_gpu":74,"./concat_packed_gpu":75,"./conv_backprop_gpu":76,"./conv_backprop_gpu_depthwise":77,"./conv_gpu":78,"./conv_gpu_depthwise":79,"./conv_packed_gpu_depthwise":80,"./crop_and_resize_gpu":81,"./cumsum_gpu":82,"./decode_matrix_gpu":83,"./decode_matrix_packed_gpu":84,"./depth_to_space_gpu":85,"./diag_gpu":86,"./encode_float_gpu":87,"./encode_float_packed_gpu":88,"./encode_matrix_gpu":89,"./encode_matrix_packed_gpu":90,"./fft_gpu":91,"./fill_gpu":92,"./flags_webgl":93,"./from_pixels_gpu":94,"./from_pixels_packed_gpu":95,"./gather_gpu":96,"./gather_nd_gpu":97,"./gpgpu_context":99,"./gpgpu_math":100,"./im2col_packed_gpu":102,"./lrn_gpu":103,"./lrn_grad_gpu":104,"./lrn_packed_gpu":105,"./max_pool_backprop_gpu":106,"./mulmat_packed_gpu":107,"./multinomial_gpu":108,"./onehot_gpu":109,"./pack_gpu":110,"./pad_gpu":111,"./pad_packed_gpu":112,"./pool_gpu":113,"./reduce_gpu":114,"./reshape_packed_gpu":115,"./resize_bilinear_backprop_gpu":116,"./resize_bilinear_gpu":117,"./resize_bilinear_packed_gpu":118,"./resize_nearest_neighbor_backprop_gpu":119,"./resize_nearest_neighbor_gpu":120,"./reverse_gpu":121,"./reverse_packed_gpu":122,"./scatter_gpu":123,"./segment_gpu":124,"./select_gpu":125,"./slice_gpu":128,"./slice_packed_gpu":129,"./strided_slice_gpu":130,"./tex_util":131,"./texture_manager":132,"./tile_gpu":133,"./transpose_gpu":134,"./transpose_packed_gpu":135,"./unaryop_gpu":136,"./unaryop_packed_gpu":137,"./unpack_gpu":138,"./webgl_util":139}],65:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});function BatchNormProgram(xShape,meanShape,varianceShape,offsetShape,scaleShape,varianceEpsilon){this.outputShape=[],this.variableNames=["x","mean","variance"],broadcast_util.assertAndGetBroadcastShape(xShape,meanShape),broadcast_util.assertAndGetBroadcastShape(xShape,varianceShape);var offsetSnippet="0.0";null!=offsetShape&&(broadcast_util.assertAndGetBroadcastShape(xShape,offsetShape),this.variableNames.push("offset"),offsetSnippet="getOffsetAtOutCoords()");var scaleSnippet="1.0";null!=scaleShape&&(broadcast_util.assertAndGetBroadcastShape(xShape,scaleShape),this.variableNames.push("scale"),scaleSnippet="getScaleAtOutCoords()"),this.outputShape=xShape,this.userCode="\n      void main() {\n        float x = getXAtOutCoords();\n        float mean = getMeanAtOutCoords();\n        float variance = getVarianceAtOutCoords();\n        float offset = "+offsetSnippet+";\n        float scale = "+scaleSnippet+";\n        float inv = scale * inversesqrt(variance + float("+varianceEpsilon+"));\n        setOutput(dot(vec3(x, -mean, offset), vec3(inv, inv, 1)));\n      }\n    "}var broadcast_util=require("../../ops/broadcast_util");exports.BatchNormProgram=BatchNormProgram},{"../../ops/broadcast_util":169}],66:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});function BatchNormPackedProgram(xShape,meanShape,varianceShape,offsetShape,scaleShape,varianceEpsilon){this.usesPackedTextures=!0,this.variableNames=["x","mean","variance"],broadcast_util.assertAndGetBroadcastShape(xShape,meanShape),broadcast_util.assertAndGetBroadcastShape(xShape,varianceShape);var offsetSnippet="vec4(0.0)";null!=offsetShape&&(broadcast_util.assertAndGetBroadcastShape(xShape,offsetShape),this.variableNames.push("offset"),offsetSnippet="getOffsetAtOutCoords()");var scaleSnippet="vec4(1.0)";null!=scaleShape&&(broadcast_util.assertAndGetBroadcastShape(xShape,scaleShape),this.variableNames.push("scale"),scaleSnippet="getScaleAtOutCoords()"),this.outputShape=xShape,this.userCode="\n      void main() {\n        vec4 offset = "+offsetSnippet+";\n        vec4 scale = "+scaleSnippet+";\n\n        vec4 x = getXAtOutCoords();\n        vec4 mean = getMeanAtOutCoords();\n        vec4 variance = getVarianceAtOutCoords();\n\n        vec4 inv = scale * inversesqrt(variance + vec4("+varianceEpsilon+"));\n\n        setOutput((x - mean) * inv + offset);\n      }\n    "}var broadcast_util=require("../../ops/broadcast_util");exports.BatchNormPackedProgram=BatchNormPackedProgram},{"../../ops/broadcast_util":169}],67:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var broadcast_util=require("../../ops/broadcast_util");exports.COMPLEX_MULTIPLY={REAL:"return areal * breal - aimag * bimag;",IMAG:"return areal * bimag + aimag * breal;"};function BinaryOpComplexProgram(op,aShape,bShape){this.variableNames=["AReal","AImag","BReal","BImag"],this.outputShape=broadcast_util.assertAndGetBroadcastShape(aShape,bShape),this.userCode="\n      float binaryOpComplex(\n          float areal, float aimag, float breal, float bimag) {\n        "+op+"\n      }\n\n      void main() {\n        float areal = getARealAtOutCoords();\n        float aimag = getAImagAtOutCoords();\n        float breal = getBRealAtOutCoords();\n        float bimag = getBImagAtOutCoords();\n        setOutput(binaryOpComplex(areal, aimag, breal, bimag));\n      }\n    "}exports.BinaryOpComplexProgram=BinaryOpComplexProgram},{"../../ops/broadcast_util":169}],68:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var broadcast_util=require("../../ops/broadcast_util"),CHECK_NAN_SNIPPET="\n  if (isnan(a)) return a;\n  if (isnan(b)) return b;\n";exports.ADD="return a + b;",exports.SUB="return a - b;",exports.MUL="return a * b;",exports.DIV="\nif (b == 0.0) {\n  return NAN;\n}\nif (a == b) {\n  return 1.0;\n};\nreturn a / b;",exports.INT_DIV="\n  float s = sign(a) * sign(b);\n  int ia = round(a);\n  int ib = round(b);\n  if (ib != 0) {\n    // Windows (D3D) wants guaranteed non-zero int division at compile-time.\n    return float(idiv(ia, ib, s));\n  } else {\n    return NAN;\n  }\n",exports.POW="\nif(a < 0.0 && floor(b) < b){\n  return NAN;\n}\nif (b == 0.0) {\n  return 1.0;\n}\nreturn (round(mod(b, 2.0)) != 1) ?\n    pow(abs(a), b) : sign(a) * pow(abs(a), b);\n",exports.SQUARED_DIFFERENCE="return (a - b) * (a - b);",exports.EQUAL="return float(a == b);",exports.NOT_EQUAL="return float(a != b);",exports.LESS="return float(a < b);",exports.LESS_EQUAL="return float(a <= b);",exports.GREATER="return float(a > b);",exports.GREATER_EQUAL="return float(a >= b);",exports.LOGICAL_AND="return float(a >= 1.0 && b >= 1.0);",exports.LOGICAL_OR="return float(a >= 1.0 || b >= 1.0);",exports.MAX=CHECK_NAN_SNIPPET+"\n  return max(a, b);\n",exports.MIN=CHECK_NAN_SNIPPET+"\n  return min(a, b);\n",exports.MOD="if (b == 0.0) return NAN;\n  return mod(a, b);",exports.ATAN2=CHECK_NAN_SNIPPET+"\n  return atan(a, b);\n",exports.ELU_DER="return (b >= 1.0) ? a : a * (b + 1.0);",exports.PRELU="return (a < 0.) ? b * a : a;";function BinaryOpProgram(op,aShape,bShape){this.variableNames=["A","B"],this.outputShape=broadcast_util.assertAndGetBroadcastShape(aShape,bShape),this.userCode="\n      float binaryOperation(float a, float b) {\n        "+op+"\n      }\n\n      void main() {\n        float a = getAAtOutCoords();\n        float b = getBAtOutCoords();\n        setOutput(binaryOperation(a, b));\n      }\n    "}exports.BinaryOpProgram=BinaryOpProgram},{"../../ops/broadcast_util":169}],69:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var broadcast_util=require("../../ops/broadcast_util"),util_1=require("../../util"),packing_util_1=require("../packing_util"),shader_compiler_1=require("./shader_compiler"),CHECK_NAN_SNIPPET="\n  result.r = isNaN.r > 0. ? NAN : result.r;\n  result.g = isNaN.g > 0. ? NAN : result.g;\n  result.b = isNaN.b > 0. ? NAN : result.b;\n  result.a = isNaN.a > 0. ? NAN : result.a;\n";exports.DIV="\n  // vec4 one = vec4(equal(a, b));\n  // return one + (vec4(1.0) - one) * a / b;\n  vec4 result = a / b;\n  if(b.x == 0.0) {\n    result.x = NAN;\n  } else if(a.x == b.x) {\n    result.x = 1.;\n  }\n  if(b.y == 0.0) {\n    result.y = NAN;\n  } else if(a.y == b.y) {\n    result.y = 1.;\n  }\n  if(b.z == 0.0) {\n    result.z = NAN;\n  } else if(a.z == b.z) {\n    result.z = 1.;\n  }\n  if(b.w == 0.0) {\n    result.w = NAN;\n  } else if(a.w == b.w) {\n    result.w = 1.;\n  }\n\n  return result;\n",exports.INT_DIV="\n  ivec4 ia = round(a);\n  ivec4 ib = round(b);\n  bvec4 cond = notEqual(ib, ivec4(0));\n  ivec4 result = ivec4(0);\n  vec4 s = sign(a) * sign(b);\n\n  // Windows (D3D) wants guaranteed non-zero int division at compile-time.\n  if (cond[0]) {\n    result[0] = idiv(ia[0], ib[0], s[0]);\n  }\n  if (cond[1]) {\n    result[1] = idiv(ia[1], ib[1], s[1]);\n  }\n  if (cond[2]) {\n    result[2] = idiv(ia[2], ib[2], s[2]);\n  }\n  if (cond[3]) {\n    result[3] = idiv(ia[3], ib[3], s[3]);\n  }\n  return vec4(result);\n",exports.POW="\n  // isModRound1 has 1 for components with round(mod(b, 2.0)) == 1, 0 otherwise.\n  vec4 isModRound1 = vec4(equal(round(mod(b, 2.0)), ivec4(1)));\n  vec4 multiplier = sign(a) * isModRound1 + (vec4(1.0) - isModRound1);\n  vec4 result = multiplier * pow(abs(a), b);\n\n  // Ensure that a^0 = 1, including 0^0 = 1 as this correspond to TF and JS\n  bvec4 isExpZero = equal(b, vec4(0.0));\n  result.r = isExpZero.r ? 1.0 : result.r;\n  result.g = isExpZero.g ? 1.0 : result.g;\n  result.b = isExpZero.b ? 1.0 : result.b;\n  result.a = isExpZero.a ? 1.0 : result.a;\n\n  vec4 isNaN = vec4(lessThan(a, vec4(0.0))) * vec4(lessThan(floor(b), b));\n  "+CHECK_NAN_SNIPPET+"\n  return result;\n",exports.PRELU="\n  vec4 aLessThanZero = vec4(lessThan(a, vec4(0.)));\n  return (aLessThanZero * (b * a)) + ((vec4(1.0) - aLessThanZero) * a);\n",exports.ELU_DER="\n  vec4 bGTEZero = vec4(greaterThanEqual(b, vec4(0.)));\n  return (bGTEZero * a) + ((vec4(1.0) - bGTEZero) * (a * (b + vec4(1.0))));\n",exports.ATAN2="\n  vec4 result = atan(a, b);\n  vec4 isNaN = min(vec4(isnan(a)) + vec4(isnan(b)), vec4(1.0));\n  "+CHECK_NAN_SNIPPET+"\n  return result;\n",exports.EQUAL="\n  return vec4(equal(a, b));\n",exports.NOT_EQUAL="\n  return vec4(notEqual(a, b));\n",exports.LESS="\n  return vec4(lessThan(a, b));\n",exports.LESS_EQUAL="\n  return vec4(lessThanEqual(a, b));\n",exports.GREATER="\n  return vec4(greaterThan(a, b));\n",exports.GREATER_EQUAL="\n  return vec4(greaterThanEqual(a, b));\n",exports.LOGICAL_AND="\n  return vec4(\n    vec4(greaterThanEqual(a, vec4(1.0))) *\n    vec4(greaterThanEqual(b, vec4(1.0))));\n",exports.LOGICAL_OR="\n  return min(\n    vec4(greaterThanEqual(a, vec4(1.0))) +\n    vec4(greaterThanEqual(b, vec4(1.0))),\n    vec4(1.0));\n",exports.MAX="\n  vec4 result = vec4(max(a, b));\n  vec4 isNaN = min(vec4(isnan(a)) + vec4(isnan(b)), vec4(1.0));\n  "+CHECK_NAN_SNIPPET+"\n  return result;\n",exports.MIN="\n  vec4 result = vec4(min(a, b));\n  vec4 isNaN = min(vec4(isnan(a)) + vec4(isnan(b)), vec4(1.0));\n  "+CHECK_NAN_SNIPPET+"\n  return result;\n",exports.MOD="\n  vec4 result = mod(a, b);\n  vec4 isNaN = vec4(equal(b, vec4(0.0)));\n  "+CHECK_NAN_SNIPPET+"\n  return result;\n";function BinaryOpPackedProgram(op,aShape,bShape,checkOutOfBounds){void 0===checkOutOfBounds&&(checkOutOfBounds=!1),this.variableNames=["A","B"],this.supportsBroadcasting=!0,this.usesPackedTextures=!0,this.outputShape=broadcast_util.assertAndGetBroadcastShape(aShape,bShape);var rank=this.outputShape.length,checkOutOfBoundsString="";if(checkOutOfBounds)if(0===rank||1===util_1.sizeFromShape(this.outputShape))checkOutOfBoundsString="\n          result.y = 0.;\n          result.z = 0.;\n          result.w = 0.;\n        ";else if(checkOutOfBoundsString="\n          "+shader_compiler_1.getCoordsDataType(rank)+" coords = getOutputCoords();\n        ",1===rank)checkOutOfBoundsString+="\n            result.y = (coords + 1) >= "+this.outputShape[0]+" ? 0. : result.y;\n            result.z = 0.;\n            result.w = 0.;\n          ";else{var channels=packing_util_1.getChannels("coords",rank);checkOutOfBoundsString+="\n            bool nextRowOutOfBounds =\n              ("+channels[rank-2]+" + 1) >= "+this.outputShape[rank-2]+";\n            bool nextColOutOfBounds =\n              ("+channels[rank-1]+" + 1) >= "+this.outputShape[rank-1]+";\n            result.y = nextColOutOfBounds ? 0. : result.y;\n            result.z = nextRowOutOfBounds ? 0. : result.z;\n            result.w = nextColOutOfBounds || nextRowOutOfBounds ? 0. : result.w;\n          "}this.userCode="\n      vec4 binaryOperation(vec4 a, vec4 b) {\n        "+op+"\n      }\n\n      void main() {\n        vec4 a = getAAtOutCoords();\n        vec4 b = getBAtOutCoords();\n\n        vec4 result = binaryOperation(a, b);\n        "+checkOutOfBoundsString+"\n\n        setOutput(result);\n      }\n    "}exports.BinaryOpPackedProgram=BinaryOpPackedProgram},{"../../ops/broadcast_util":169,"../../util":241,"../packing_util":55,"./shader_compiler":126}],70:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var contexts={},WEBGL_ATTRIBUTES={alpha:!1,antialias:!1,premultipliedAlpha:!1,preserveDrawingBuffer:!1,depth:!1,stencil:!1,failIfMajorPerformanceCaveat:!0};function createCanvas(webGLVersion){if("undefined"!=typeof OffscreenCanvas&&2===webGLVersion)return new OffscreenCanvas(300,150);if("undefined"!=typeof document)return document.createElement("canvas");throw new Error("Cannot create a canvas in this context")}exports.setWebGLContext=function(webGLVersion,gl){contexts[webGLVersion]=gl},exports.getWebGLContext=function getWebGLContext(webGLVersion){webGLVersion in contexts||(contexts[webGLVersion]=function(webGLVersion){if(1!==webGLVersion&&2!==webGLVersion)throw new Error("Cannot get WebGL rendering context, WebGL is disabled.");var canvas=createCanvas(webGLVersion);return canvas.addEventListener("webglcontextlost",function(ev){ev.preventDefault(),delete contexts[webGLVersion]},!1),1!==webGLVersion?canvas.getContext("webgl2",WEBGL_ATTRIBUTES):canvas.getContext("webgl",WEBGL_ATTRIBUTES)||canvas.getContext("experimental-webgl",WEBGL_ATTRIBUTES)}(webGLVersion));var gl=contexts[webGLVersion];return gl.isContextLost()?(delete contexts[webGLVersion],getWebGLContext(webGLVersion)):(gl.disable(gl.DEPTH_TEST),gl.disable(gl.STENCIL_TEST),gl.disable(gl.BLEND),gl.disable(gl.DITHER),gl.disable(gl.POLYGON_OFFSET_FILL),gl.disable(gl.SAMPLE_COVERAGE),gl.enable(gl.SCISSOR_TEST),gl.enable(gl.CULL_FACE),gl.cullFace(gl.BACK),contexts[webGLVersion])},exports.createCanvas=createCanvas},{}],71:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var ClipProgram=function(){function ClipProgram(aShape){this.variableNames=["A"],this.outputShape=aShape,this.userCode="\n      uniform float minVal;\n      uniform float maxVal;\n\n      void main() {\n        float value = getAAtOutCoords();\n        if (isnan(value)) {\n          setOutput(value);\n          return;\n        }\n\n        setOutput(clamp(value, minVal, maxVal));\n      }\n    "}return ClipProgram.prototype.getCustomSetupFunc=function(min,max){var _this=this;return function(gpgpu,webGLProgram){null==_this.minLoc&&(_this.minLoc=gpgpu.getUniformLocationNoThrow(webGLProgram,"minVal"),_this.maxLoc=gpgpu.getUniformLocationNoThrow(webGLProgram,"maxVal")),gpgpu.gl.uniform1f(_this.minLoc,min),gpgpu.gl.uniform1f(_this.maxLoc,max)}},ClipProgram}();exports.ClipProgram=ClipProgram},{}],72:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var ClipPackedProgram=function(){function ClipPackedProgram(aShape){this.variableNames=["A"],this.usesPackedTextures=!0,this.outputShape=aShape,this.userCode="\n      uniform float minVal;\n      uniform float maxVal;\n\n      void main() {\n        vec4 value = getAAtOutCoords();\n\n        if (any(isnan(value))) {\n          setOutput(value);\n          return;\n        }\n\n        setOutput(clamp(value, vec4(minVal), vec4(maxVal)));\n      }\n    "}return ClipPackedProgram.prototype.getCustomSetupFunc=function(min,max){var _this=this;return function(gpgpu,webGLProgram){null==_this.minLoc&&(_this.minLoc=gpgpu.getUniformLocationNoThrow(webGLProgram,"minVal"),_this.maxLoc=gpgpu.getUniformLocationNoThrow(webGLProgram,"maxVal")),gpgpu.gl.uniform1f(_this.minLoc,min),gpgpu.gl.uniform1f(_this.maxLoc,max)}},ClipPackedProgram}();exports.ClipPackedProgram=ClipPackedProgram},{}],73:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});function ComplexAbsProgram(shape){this.variableNames=["real","imag"],this.outputShape=shape,this.userCode="\n      void main() {\n        float re = abs(getRealAtOutCoords());\n        float im = abs(getImagAtOutCoords());\n        float mx = max(re, im);\n\n        // sadly the length function in glsl is not underflow-safe\n        // (at least not on Intel GPUs). So the safe solution is\n        // to ensure underflow-safety in all cases.\n        setOutput(\n          mx == 0.0 ? 0.0 : mx * length(vec2(1, min(re, im)/mx))\n        );\n      }\n    "}exports.ComplexAbsProgram=ComplexAbsProgram},{}],74:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});function ConcatProgram(shapes){this.outputShape=[],this.outputShape=concat_util.computeOutShape(shapes,1),this.variableNames=shapes.map(function(_,i){return"T"+i});var offsets=new Array(shapes.length-1);offsets[0]=shapes[0][1];for(var i=1;i<offsets.length;i++)offsets[i]=offsets[i-1]+shapes[i][1];var snippets=["if (yC < "+offsets[0]+") setOutput(getT0(yR, yC));"];for(i=1;i<offsets.length;i++){var shift=offsets[i-1];snippets.push("else if (yC < "+offsets[i]+") setOutput(getT"+i+"(yR, yC-"+shift+"));")}var lastIndex=offsets.length,lastShift=offsets[offsets.length-1];snippets.push("else setOutput(getT"+lastIndex+"(yR, yC-"+lastShift+"));"),this.userCode="\n      void main() {\n        ivec2 coords = getOutputCoords();\n        int yR = coords.x;\n        int yC = coords.y;\n\n        "+snippets.join("\n        ")+"\n      }\n    "}var concat_util=require("../../ops/concat_util");exports.ConcatProgram=ConcatProgram},{"../../ops/concat_util":174}],75:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});function ConcatPackedProgram(shapes,axis){this.usesPackedTextures=!0,this.outputShape=[],this.outputShape=concat_util.computeOutShape(shapes,axis);var shape=this.outputShape,rank=shape.length,dtype=shader_compiler_1.getCoordsDataType(rank),coords=packing_util_1.getChannels("coords",rank),channels=["x","y","z","w","u","v"].slice(0,rank);this.variableNames=shapes.map(function(_,i){return"T"+i});var offsets=new Array(shapes.length-1);offsets[0]=shapes[0][axis];for(var i=1;i<offsets.length;i++)offsets[i]=offsets[i-1]+shapes[i][axis];var channel=channels[axis],lastChannels="vec2("+channels.slice(-2).join()+")",allChannels=channels.join(),getValueSnippet="if ("+channel+" < "+offsets[0]+")\n          return getChannel(getT0("+allChannels+"), "+lastChannels+");";for(i=1;i<offsets.length;i++){var shift_1=offsets[i-1];getValueSnippet+="\n        else if ("+channel+" < "+offsets[i]+") {\n          "+channel+" -= "+shift_1+";\n          return getChannel(getT"+i+"("+allChannels+"), "+lastChannels+");\n        }"}var lastIndex=offsets.length;getValueSnippet+="\n        else {\n          "+channel+" -= "+offsets[offsets.length-1]+";\n          return getChannel(getT"+lastIndex+"("+allChannels+"), "+lastChannels+");\n        }",this.userCode="\n      float getValue("+channels.map(function(x){return"int "+x})+") {\n        "+getValueSnippet+"\n      }\n\n      void main() {\n        "+dtype+" coords = getOutputCoords();\n        vec4 result = vec4(getValue("+coords+"), 0., 0., 0.);\n        if (++"+coords[rank-1]+" < "+shape[rank-1]+") {\n          result.g = getValue("+coords+");\n        }\n        if (++"+coords[rank-2]+" < "+shape[rank-2]+") {\n          result.a = getValue("+coords+");\n        }\n        if ("+coords[rank-2]+" < "+shape[rank-2]+" &&\n            --"+coords[rank-1]+" < "+shape[rank-1]+") {\n          result.b = getValue("+coords+");\n        }\n        setOutput(result);\n      }\n    "}var concat_util=require("../../ops/concat_util"),packing_util_1=require("../packing_util"),shader_compiler_1=require("./shader_compiler");exports.ConcatPackedProgram=ConcatPackedProgram},{"../../ops/concat_util":174,"../packing_util":55,"./shader_compiler":126}],76:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});function Conv2DDerFilterProgram(convInfo){this.variableNames=["x","dy"],this.outputShape=convInfo.filterShape;var strideHeight=convInfo.strideHeight,strideWidth=convInfo.strideWidth,padTop=convInfo.padInfo.top,padLeft=convInfo.padInfo.left,isChannelsLast="channelsLast"===convInfo.dataFormat;this.userCode="\n      void main() {\n        ivec4 coords = getOutputCoords();\n        int wR = coords.x;\n        int wC = coords.y;\n        int d1 = coords.z;\n        int d2 = coords.w;\n\n        // Convolve x(?, ?, d1) with dy(:, :, d2) to get dw(wR, wC, d1, d2).\n        // ? = to be determined. : = across all values in that axis.\n        float dotProd = 0.0;\n\n        for (int b = 0; b < "+convInfo.batchSize+"; b++) {\n          for (int yR = 0; yR < "+convInfo.outHeight+"; yR++) {\n            int xR = wR + yR * "+strideHeight+" - "+padTop+";\n\n            if (xR < 0 || xR >= "+convInfo.inHeight+") {\n              continue;\n            }\n\n            for (int yC = 0; yC < "+convInfo.outWidth+"; yC++) {\n              int xC = wC + yC * "+strideWidth+" - "+padLeft+";\n\n              if (xC < 0 || xC >= "+convInfo.inWidth+") {\n                continue;\n              }\n\n              if ("+isChannelsLast+") {\n                float dyValue = getDy(b, yR, yC, d2);\n                float xValue = getX(b, xR, xC, d1);\n                dotProd += (xValue * dyValue);\n              } else {\n                float dyValue = getDy(b, d2, yR, yC);\n                float xValue = getX(b, d1, xR, xC);\n                dotProd += (xValue * dyValue);\n              }\n\n            }\n          }\n        }\n        setOutput(dotProd);\n      }\n    "}exports.Conv2DDerFilterProgram=Conv2DDerFilterProgram;function Conv2DDerInputProgram(convInfo){this.variableNames=["dy","W"],this.outputShape=convInfo.inShape;var filterHeight=convInfo.filterHeight,filterWidth=convInfo.filterWidth,strideHeight=convInfo.strideHeight,strideWidth=convInfo.strideWidth,isChannelsLast="channelsLast"===convInfo.dataFormat,padTop=filterHeight-1-convInfo.padInfo.top,padLeft=filterWidth-1-convInfo.padInfo.left,rowDim=isChannelsLast?1:2,colDim=isChannelsLast?2:3,channelDim=isChannelsLast?3:1;this.userCode="\n      const ivec2 pads = ivec2("+padTop+", "+padLeft+");\n\n      void main() {\n        ivec4 coords = getOutputCoords();\n        int batch = coords[0];\n        int d1 = coords["+channelDim+"];\n\n        ivec2 dyCorner = ivec2(coords["+rowDim+"], coords["+colDim+"]) - pads;\n        int dyRCorner = dyCorner.x;\n        int dyCCorner = dyCorner.y;\n\n        // Convolve dy(?, ?, d2) with w(:, :, d1, d2) to compute dx(xR, xC, d1).\n        // ? = to be determined. : = across all values in that axis.\n        float dotProd = 0.0;\n        for (int wR = 0; wR < "+filterHeight+"; wR++) {\n          float dyR = float(dyRCorner + wR) / "+strideHeight+".0;\n\n          if (dyR < 0.0 || dyR >= "+convInfo.outHeight+".0 || fract(dyR) > 0.0) {\n            continue;\n          }\n          int idyR = int(dyR);\n\n          int wRPerm = "+filterHeight+" - 1 - wR;\n\n          for (int wC = 0; wC < "+filterWidth+"; wC++) {\n            float dyC = float(dyCCorner + wC) / "+strideWidth+".0;\n\n            if (dyC < 0.0 || dyC >= "+convInfo.outWidth+".0 ||\n                fract(dyC) > 0.0) {\n              continue;\n            }\n            int idyC = int(dyC);\n\n            int wCPerm = "+filterWidth+" - 1 - wC;\n\n            for (int d2 = 0; d2 < "+convInfo.outChannels+"; d2++) {\n\n              if ("+isChannelsLast+") {\n                float xValue = getDy(batch, idyR, idyC, d2);\n                float wValue = getW(wRPerm, wCPerm, d1, d2);\n                dotProd += xValue * wValue;\n              } else {\n                float xValue = getDy(batch, d2, idyR, idyC);\n                float wValue = getW(wRPerm, wCPerm, d1, d2);\n                dotProd += xValue * wValue;\n              }\n\n            }\n          }\n        }\n        setOutput(dotProd);\n      }\n    "}exports.Conv2DDerInputProgram=Conv2DDerInputProgram;function Conv3DDerFilterProgram(convInfo){this.variableNames=["x","dy"],this.outputShape=convInfo.filterShape;var strideDepth=convInfo.strideDepth,strideHeight=convInfo.strideHeight,strideWidth=convInfo.strideWidth,padFront=convInfo.padInfo.front,padTop=convInfo.padInfo.top,padLeft=convInfo.padInfo.left;this.userCode="\n      void main() {\n        ivec5 coords = getOutputCoords();\n        int wF = coords.x;\n        int wR = coords.y;\n        int wC = coords.z;\n        int d1 = coords.w;\n        int d2 = coords.u;\n\n        float dotProd = 0.0;\n\n        for (int b = 0; b < "+convInfo.batchSize+"; b++) {\n          for (int yF = 0; yF < "+convInfo.outDepth+"; yF++) {\n            int xF = wF + yF * "+strideDepth+" - "+padFront+";\n\n            if (xF < 0 || xF >= "+convInfo.inDepth+") {\n              continue;\n            }\n\n            for (int yR = 0; yR < "+convInfo.outHeight+"; yR++) {\n              int xR = wR + yR * "+strideHeight+" - "+padTop+";\n\n              if (xR < 0 || xR >= "+convInfo.inHeight+") {\n                continue;\n              }\n\n              for (int yC = 0; yC < "+convInfo.outWidth+"; yC++) {\n                int xC = wC + yC * "+strideWidth+" - "+padLeft+";\n\n                if (xC < 0 || xC >= "+convInfo.inWidth+") {\n                  continue;\n                }\n\n                float dyValue = getDy(b, yF, yR, yC, d2);\n                float xValue = getX(b, xF, xR, xC, d1);\n                dotProd += (xValue * dyValue);\n              }\n            }\n          }\n        }\n        setOutput(dotProd);\n      }\n    "}exports.Conv3DDerFilterProgram=Conv3DDerFilterProgram;function Conv3DDerInputProgram(convInfo){this.variableNames=["dy","W"],this.outputShape=convInfo.inShape;var filterDepth=convInfo.filterDepth,filterHeight=convInfo.filterHeight,filterWidth=convInfo.filterWidth,strideDepth=convInfo.strideDepth,strideHeight=convInfo.strideHeight,strideWidth=convInfo.strideWidth,padFront=filterDepth-1-convInfo.padInfo.front,padTop=filterHeight-1-convInfo.padInfo.top,padLeft=filterWidth-1-convInfo.padInfo.left;this.userCode="\n      const ivec3 pads = ivec3("+padFront+", "+padTop+", "+padLeft+");\n\n      void main() {\n        ivec5 coords = getOutputCoords();\n        int batch = coords.x;\n        int d1 = coords.u;\n\n\n        ivec3 dyCorner = ivec3(coords.y, coords.z, coords.w) - pads;\n        int dyFCorner = dyCorner.x;\n        int dyRCorner = dyCorner.y;\n        int dyCCorner = dyCorner.z;\n\n        float dotProd = 0.0;\n        for (int wF = 0; wF < "+filterDepth+"; wF++) {\n          float dyF = float(dyFCorner + wF) / "+strideDepth+".0;\n\n          if (dyF < 0.0 || dyF >= "+convInfo.outDepth+".0 || fract(dyF) > 0.0) {\n            continue;\n          }\n          int idyF = int(dyF);\n\n          int wFPerm = "+filterDepth+" - 1 - wF;\n\n          for (int wR = 0; wR < "+filterHeight+"; wR++) {\n            float dyR = float(dyRCorner + wR) / "+strideHeight+".0;\n\n            if (dyR < 0.0 || dyR >= "+convInfo.outHeight+".0 ||\n              fract(dyR) > 0.0) {\n              continue;\n            }\n            int idyR = int(dyR);\n\n            int wRPerm = "+filterHeight+" - 1 - wR;\n\n            for (int wC = 0; wC < "+filterWidth+"; wC++) {\n              float dyC = float(dyCCorner + wC) / "+strideWidth+".0;\n\n              if (dyC < 0.0 || dyC >= "+convInfo.outWidth+".0 ||\n                  fract(dyC) > 0.0) {\n                continue;\n              }\n              int idyC = int(dyC);\n\n              int wCPerm = "+filterWidth+" - 1 - wC;\n\n              for (int d2 = 0; d2 < "+convInfo.outChannels+"; d2++) {\n                float xValue = getDy(batch, idyF, idyR, idyC, d2);\n                float wValue = getW(wFPerm, wRPerm, wCPerm, d1, d2);\n                dotProd += xValue * wValue;\n              }\n            }\n          }\n        }\n        setOutput(dotProd);\n      }\n    "}exports.Conv3DDerInputProgram=Conv3DDerInputProgram},{}],77:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});function DepthwiseConv2DDerFilterProgram(convInfo){this.variableNames=["x","dy"],this.outputShape=convInfo.filterShape;var strideHeight=convInfo.strideHeight,strideWidth=convInfo.strideWidth,padTop=convInfo.padInfo.top,padLeft=convInfo.padInfo.left,channelMul=convInfo.outChannels/convInfo.inChannels;this.userCode="\n      void main() {\n        ivec4 coords = getOutputCoords();\n        int wR = coords.x;\n        int wC = coords.y;\n        int d1 = coords.z;\n        int dm = coords.w;\n        int d2 = d1 * "+channelMul+" + dm;\n\n        float dotProd = 0.0;\n\n        // TODO: Vec4 over the batch size\n        for (int b = 0; b < "+convInfo.batchSize+"; b++) {\n          for (int yR = 0; yR < "+convInfo.outHeight+"; yR++) {\n            int xR = wR + yR * "+strideHeight+" - "+padTop+";\n\n            if (xR < 0 || xR >= "+convInfo.inHeight+") {\n              continue;\n            }\n\n            for (int yC = 0; yC < "+convInfo.outWidth+"; yC++) {\n              int xC = wC + yC * "+strideWidth+" - "+padLeft+";\n\n              if (xC < 0 || xC >= "+convInfo.inWidth+") {\n                continue;\n              }\n\n              float dyValue = getDy(b, yR, yC, d2);\n              float xValue = getX(b, xR, xC, d1);\n              dotProd += (xValue * dyValue);\n            }\n          }\n        }\n        setOutput(dotProd);\n      }\n    "}exports.DepthwiseConv2DDerFilterProgram=DepthwiseConv2DDerFilterProgram;function DepthwiseConv2DDerInputProgram(convInfo){this.variableNames=["dy","W"],this.outputShape=convInfo.inShape;var filterHeight=convInfo.filterHeight,filterWidth=convInfo.filterWidth,strideHeight=convInfo.strideHeight,strideWidth=convInfo.strideWidth,padTop=filterHeight-1-convInfo.padInfo.top,padLeft=filterWidth-1-convInfo.padInfo.left,channelMul=convInfo.outChannels/convInfo.inChannels;this.userCode="\n      const ivec2 pads = ivec2("+padTop+", "+padLeft+");\n\n      void main() {\n        ivec4 coords = getOutputCoords();\n        int batch = coords[0];\n        int d1 = coords[3];\n        ivec2 dyCorner = coords.yz - pads;\n        int dyRCorner = dyCorner.x;\n        int dyCCorner = dyCorner.y;\n\n        float dotProd = 0.0;\n\n        for (int wR = 0; wR < "+filterHeight+"; wR++) {\n          float dyR = float(dyRCorner + wR) / "+strideHeight+".0;\n\n          if (dyR < 0.0 || dyR >= "+convInfo.outHeight+".0 || fract(dyR) > 0.0) {\n            continue;\n          }\n          int idyR = int(dyR);\n\n          int wRPerm = "+filterHeight+" - 1 - wR;\n\n          for (int wC = 0; wC < "+filterWidth+"; wC++) {\n            float dyC = float(dyCCorner + wC) / "+strideWidth+".0;\n\n            if (dyC < 0.0 || dyC >= "+convInfo.outWidth+".0 ||\n                fract(dyC) > 0.0) {\n              continue;\n            }\n            int idyC = int(dyC);\n\n            int wCPerm = "+filterWidth+" - 1 - wC;\n\n            // TODO: Vec4 over the channelMul\n            for (int dm = 0; dm < "+channelMul+"; dm++) {\n              int d2 = d1 * "+channelMul+" + dm;\n              float xValue = getDy(batch, idyR, idyC, d2);\n              float wValue = getW(wRPerm, wCPerm, d1, dm);\n              dotProd += xValue * wValue;\n            }\n          }\n        }\n        setOutput(dotProd);\n      }\n    "}exports.DepthwiseConv2DDerInputProgram=DepthwiseConv2DDerInputProgram},{}],78:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});function Conv2DProgram(convInfo,addBias,activation,hasPreluActivationWeights){void 0===addBias&&(addBias=!1),void 0===activation&&(activation=null),void 0===hasPreluActivationWeights&&(hasPreluActivationWeights=!1),this.variableNames=["x","W"],this.outputShape=convInfo.outShape;var padTop=convInfo.padInfo.top,padLeft=convInfo.padInfo.left,strideHeight=convInfo.strideHeight,strideWidth=convInfo.strideWidth,dilationHeight=convInfo.dilationHeight,dilationWidth=convInfo.dilationWidth,filterHeight=convInfo.filterHeight,filterWidth=convInfo.filterWidth,inputDepthNearestVec4=4*Math.floor(convInfo.inChannels/4),inputDepthVec4Remainder=convInfo.inChannels%4,isChannelsLast="channelsLast"===convInfo.dataFormat,rowDim=isChannelsLast?1:2,colDim=isChannelsLast?2:3,channelDim=isChannelsLast?3:1,activationSnippet="",applyActivationSnippet="";activation&&(activationSnippet=hasPreluActivationWeights?"float activation(float a) {\n          float b = getPreluActivationWeightsAtOutCoords();\n          "+activation+"\n        }":"\n          float activation(float x) {\n            "+activation+"\n          }\n        ",applyActivationSnippet="result = activation(result);");var addBiasSnippet=addBias?"result += getBiasAtOutCoords();":"";addBias&&this.variableNames.push("bias"),hasPreluActivationWeights&&this.variableNames.push("preluActivationWeights"),this.userCode="\n      "+activationSnippet+"\n\n      const ivec2 strides = ivec2("+strideHeight+", "+strideWidth+");\n      const ivec2 pads = ivec2("+padTop+", "+padLeft+");\n\n      void main() {\n        ivec4 coords = getOutputCoords();\n        int batch = coords[0];\n        int d2 = coords["+channelDim+"];\n\n        ivec2 xRCCorner =\n            ivec2(coords["+rowDim+"], coords["+colDim+"]) * strides - pads;\n        int xRCorner = xRCCorner.x;\n        int xCCorner = xRCCorner.y;\n\n        // Convolve x(?, ?, d1) with w(:, :, d1, d2) to get y(yR, yC, d2).\n        // ? = to be determined. : = across all values in that axis.\n        float dotProd = 0.0;\n        for (int wR = 0; wR < "+filterHeight+"; wR++) {\n          int xR = xRCorner + wR * "+dilationHeight+";\n\n          if (xR < 0 || xR >= "+convInfo.inHeight+") {\n            continue;\n          }\n\n          for (int wC = 0; wC < "+filterWidth+"; wC++) {\n            int xC = xCCorner + wC * "+dilationWidth+";\n\n            if (xC < 0 || xC >= "+convInfo.inWidth+") {\n              continue;\n            }\n\n            for (int d1 = 0; d1 < "+inputDepthNearestVec4+"; d1 += 4) {\n              vec4 wValues = vec4(\n                getW(wR, wC, d1, d2),\n                getW(wR, wC, d1 + 1, d2),\n                getW(wR, wC, d1 + 2, d2),\n                getW(wR, wC, d1 + 3, d2)\n              );\n\n              if ("+isChannelsLast+") {\n                vec4 xValues = vec4(\n                  getX(batch, xR, xC, d1),\n                  getX(batch, xR, xC, d1 + 1),\n                  getX(batch, xR, xC, d1 + 2),\n                  getX(batch, xR, xC, d1 + 3)\n                );\n                dotProd += dot(xValues, wValues);\n              } else {\n                vec4 xValues = vec4(\n                  getX(batch, d1, xR, xC),\n                  getX(batch, d1 + 1, xR, xC),\n                  getX(batch, d1 + 2, xR, xC),\n                  getX(batch, d1 + 3, xR, xC)\n                );\n                dotProd += dot(xValues, wValues);\n              }\n            }\n\n            if ("+(1==inputDepthVec4Remainder)+") {\n\n              if ("+isChannelsLast+") {\n                dotProd +=\n                    getX(batch, xR, xC, "+inputDepthNearestVec4+") *\n                    getW(wR, wC, "+inputDepthNearestVec4+", d2);\n              } else {\n                dotProd +=\n                    getX(batch, "+inputDepthNearestVec4+", xR, xC) *\n                    getW(wR, wC, "+inputDepthNearestVec4+", d2);\n              }\n\n            } else if ("+(2==inputDepthVec4Remainder)+") {\n              vec2 wValues = vec2(\n                getW(wR, wC, "+inputDepthNearestVec4+", d2),\n                getW(wR, wC, "+inputDepthNearestVec4+" + 1, d2)\n              );\n\n              if ("+isChannelsLast+") {\n                vec2 xValues = vec2(\n                  getX(batch, xR, xC, "+inputDepthNearestVec4+"),\n                  getX(batch, xR, xC, "+inputDepthNearestVec4+" + 1)\n                );\n                dotProd += dot(xValues, wValues);\n              } else {\n                vec2 xValues = vec2(\n                  getX(batch, "+inputDepthNearestVec4+", xR, xC),\n                  getX(batch, "+inputDepthNearestVec4+" + 1, xR, xC)\n                );\n                dotProd += dot(xValues, wValues);\n              }\n\n            } else if ("+(3==inputDepthVec4Remainder)+") {\n              vec3 wValues = vec3(\n                getW(wR, wC, "+inputDepthNearestVec4+", d2),\n                getW(wR, wC, "+inputDepthNearestVec4+" + 1, d2),\n                getW(wR, wC, "+inputDepthNearestVec4+" + 2, d2)\n              );\n\n              if ("+isChannelsLast+") {\n                vec3 xValues = vec3(\n                  getX(batch, xR, xC, "+inputDepthNearestVec4+"),\n                  getX(batch, xR, xC, "+inputDepthNearestVec4+" + 1),\n                  getX(batch, xR, xC, "+inputDepthNearestVec4+" + 2)\n                );\n                dotProd += dot(xValues, wValues);\n              } else {\n                vec3 xValues = vec3(\n                  getX(batch, "+inputDepthNearestVec4+", xR, xC),\n                  getX(batch, "+inputDepthNearestVec4+" + 1, xR, xC),\n                  getX(batch, "+inputDepthNearestVec4+" + 2, xR, xC)\n                );\n                dotProd += dot(xValues, wValues);\n              }\n\n            }\n          }\n        }\n\n        float result = dotProd;\n        "+addBiasSnippet+"\n        "+applyActivationSnippet+"\n        setOutput(result);\n      }\n    "}exports.Conv2DProgram=Conv2DProgram;function Conv3DProgram(convInfo){this.variableNames=["x","W"],this.outputShape=convInfo.outShape;var padFront=convInfo.padInfo.front,padTop=convInfo.padInfo.top,padLeft=convInfo.padInfo.left,strideDepth=convInfo.strideDepth,strideHeight=convInfo.strideHeight,strideWidth=convInfo.strideWidth,dilationDepth=convInfo.dilationDepth,dilationHeight=convInfo.dilationHeight,dilationWidth=convInfo.dilationWidth,filterDepth=convInfo.filterDepth,filterHeight=convInfo.filterHeight,filterWidth=convInfo.filterWidth,inputDepthNearestVec4=4*Math.floor(convInfo.inChannels/4),inputDepthVec4Remainder=convInfo.inChannels%4;this.userCode="\n      const ivec3 strides = ivec3("+strideDepth+", "+strideHeight+", "+strideWidth+");\n      const ivec3 pads = ivec3("+padFront+", "+padTop+", "+padLeft+");\n\n      void main() {\n        ivec5 coords = getOutputCoords();\n        int batch = coords.x;\n        int d2 = coords.u;\n\n        ivec3 xFRCCorner = ivec3(coords.y, coords.z, coords.w) * strides - pads;\n        int xFCorner = xFRCCorner.x;\n        int xRCorner = xFRCCorner.y;\n        int xCCorner = xFRCCorner.z;\n\n        // Convolve x(?, ?, ?, d1) with w(:, :, :, d1, d2) to get\n        // y(yF, yR, yC, d2). ? = to be determined. : = across all\n        // values in that axis.\n        float dotProd = 0.0;\n        for (int wF = 0; wF < "+filterDepth+"; wF++) {\n          int xF = xFCorner + wF * "+dilationDepth+";\n\n          if (xF < 0 || xF >= "+convInfo.inDepth+") {\n            continue;\n          }\n\n          for (int wR = 0; wR < "+filterHeight+"; wR++) {\n            int xR = xRCorner + wR * "+dilationHeight+";\n\n            if (xR < 0 || xR >= "+convInfo.inHeight+") {\n              continue;\n            }\n\n            for (int wC = 0; wC < "+filterWidth+"; wC++) {\n              int xC = xCCorner + wC * "+dilationWidth+";\n\n              if (xC < 0 || xC >= "+convInfo.inWidth+") {\n                continue;\n              }\n\n              for (int d1 = 0; d1 < "+inputDepthNearestVec4+"; d1 += 4) {\n                vec4 xValues = vec4(\n                  getX(batch, xF, xR, xC, d1),\n                  getX(batch, xF, xR, xC, d1 + 1),\n                  getX(batch, xF, xR, xC, d1 + 2),\n                  getX(batch, xF, xR, xC, d1 + 3)\n                );\n                vec4 wValues = vec4(\n                  getW(wF, wR, wC, d1, d2),\n                  getW(wF, wR, wC, d1 + 1, d2),\n                  getW(wF, wR, wC, d1 + 2, d2),\n                  getW(wF, wR, wC, d1 + 3, d2)\n                );\n\n                dotProd += dot(xValues, wValues);\n              }\n\n              if ("+(1==inputDepthVec4Remainder)+") {\n                dotProd +=\n                  getX(batch, xF, xR, xC, "+inputDepthNearestVec4+") *\n                  getW(wF, wR, wC, "+inputDepthNearestVec4+", d2);\n              } else if ("+(2==inputDepthVec4Remainder)+") {\n                vec2 xValues = vec2(\n                  getX(batch, xF, xR, xC, "+inputDepthNearestVec4+"),\n                  getX(batch, xF, xR, xC, "+inputDepthNearestVec4+" + 1)\n                );\n                vec2 wValues = vec2(\n                  getW(wF, wR, wC, "+inputDepthNearestVec4+", d2),\n                  getW(wF, wR, wC, "+inputDepthNearestVec4+" + 1, d2)\n                );\n                dotProd += dot(xValues, wValues);\n              } else if ("+(3==inputDepthVec4Remainder)+") {\n                vec3 xValues = vec3(\n                  getX(batch, xF, xR, xC, "+inputDepthNearestVec4+"),\n                  getX(batch, xF, xR, xC, "+inputDepthNearestVec4+" + 1),\n                  getX(batch, xF, xR, xC, "+inputDepthNearestVec4+" + 2)\n                );\n                vec3 wValues = vec3(\n                  getW(wF, wR, wC, "+inputDepthNearestVec4+", d2),\n                  getW(wF, wR, wC, "+inputDepthNearestVec4+" + 1, d2),\n                  getW(wF, wR, wC, "+inputDepthNearestVec4+" + 2, d2)\n                );\n                dotProd += dot(xValues, wValues);\n              }\n            }\n          }\n        }\n        setOutput(dotProd);\n      }\n    "}exports.Conv3DProgram=Conv3DProgram},{}],79:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});function DepthwiseConv2DProgram(convInfo){this.variableNames=["x","W"],this.outputShape=convInfo.outShape;var xNumRows=convInfo.inHeight,xNumCols=convInfo.inWidth,padTop=convInfo.padInfo.top,padLeft=convInfo.padInfo.left,strideHeight=convInfo.strideHeight,strideWidth=convInfo.strideWidth,dilationHeight=convInfo.dilationHeight,dilationWidth=convInfo.dilationWidth,filterHeight=convInfo.filterHeight,filterWidth=convInfo.filterWidth,channelMul=convInfo.outChannels/convInfo.inChannels;this.userCode="\n      const ivec2 strides = ivec2("+strideHeight+", "+strideWidth+");\n      const ivec2 pads = ivec2("+padTop+", "+padLeft+");\n\n      void main() {\n        ivec4 coords = getOutputCoords();\n        int batch = coords.x;\n        ivec2 xRCCorner = coords.yz * strides - pads;\n        int d2 = coords.w;\n        int d1 = d2 / "+channelMul+";\n        int q = d2 - d1 * "+channelMul+";\n\n        int xRCorner = xRCCorner.x;\n        int xCCorner = xRCCorner.y;\n\n        // Convolve x(?, ?, d1) with w(:, :, d1, q) to get y(yR, yC, d2).\n        // ? = to be determined. : = across all values in that axis.\n        float dotProd = 0.0;\n        // TODO(dsmilkov): Flatten the two for loops and vec4 the operations.\n        for (int wR = 0; wR < "+filterHeight+"; wR++) {\n          int xR = xRCorner + wR * "+dilationHeight+";\n\n          if (xR < 0 || xR >= "+xNumRows+") {\n            continue;\n          }\n\n          for (int wC = 0; wC < "+filterWidth+"; wC++) {\n            int xC = xCCorner + wC * "+dilationWidth+";\n\n            if (xC < 0 || xC >= "+xNumCols+") {\n              continue;\n            }\n\n            float xVal = getX(batch, xR, xC, d1);\n            float wVal = getW(wR, wC, d1, q);\n            dotProd += xVal * wVal;\n          }\n        }\n        setOutput(dotProd);\n      }\n    "}exports.DepthwiseConv2DProgram=DepthwiseConv2DProgram},{}],80:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});function DepthwiseConvPacked2DProgram(convInfo){this.variableNames=["x","W"],this.usesPackedTextures=!0,this.outputShape=convInfo.outShape;for(var xNumRows=convInfo.inHeight,xNumCols=convInfo.inWidth,padTop=convInfo.padInfo.top,padLeft=convInfo.padInfo.left,strideHeight=convInfo.strideHeight,strideWidth=convInfo.strideWidth,dilationHeight=convInfo.dilationHeight,dilationWidth=convInfo.dilationWidth,filterHeight=convInfo.filterHeight,filterWidth=convInfo.filterWidth,texelsAcross=filterWidth,mainLoop="int xR; int xC; int xCOffset;",r=0;r<filterHeight;r++)for(var c=0;c<filterWidth;c++)mainLoop+="\n          vec4 xTexelR"+r+"C"+2*c+" = vec4(0.);\n          vec4 wR"+r+"C"+c+" = vec4(0.);\n          vec4 xR"+r+"C"+c+" = vec4(0.);";for(r=0;r<filterHeight;r++)for(var texelC=0;texelC<texelsAcross;texelC++){if(mainLoop+="\n          xR = xRCorner + "+r*dilationHeight+";\n          xC = xCCorner + "+(c=2*texelC)*dilationWidth+";\n        ",1===strideWidth){if(c<filterWidth&&(mainLoop+=padLeft%2==1?"\n                xCOffset = xC + 1;\n                if(xR >= 0 && xR < "+xNumRows+" && xCOffset >= 0 && xCOffset < "+xNumCols+") {\n                  xTexelR"+r+"C"+c+" = getX(batch, xR, xCOffset, d1);\n                } else {\n                  xTexelR"+r+"C"+c+" = vec4(0.);\n                }\n\n                xCOffset = xC + 1 - 2;\n                if(xR >= 0 && xR < "+xNumRows+" && xCOffset >= 0 && xCOffset < "+xNumCols+") {\n                  vec4 previous = getX(batch, xR, xCOffset, d1);\n                  xR"+r+"C"+c+" = vec4(previous.zw, xTexelR"+r+"C"+c+".xy);\n                } else {\n                  xR"+r+"C"+c+" = vec4(0, 0, xTexelR"+r+"C"+c+".xy);\n                }\n              ":"\n                if(xR >= 0 && xR < "+xNumRows+" && xC >= 0 && xC < "+xNumCols+") {\n                  xTexelR"+r+"C"+c+" = getX(batch, xR, xC, d1);\n                } else {\n                  xTexelR"+r+"C"+c+" = vec4(0.);\n                }\n\n                xR"+r+"C"+c+" = xTexelR"+r+"C"+c+";\n              ",c+1<filterWidth)){var nextTexelOffset=padLeft%2==0?util.nearestLargerEven(dilationWidth):dilationWidth;dilationWidth%2==0&&padLeft%2==1||dilationWidth%2!=0&&padLeft%2!=1?(mainLoop+="\n                  xCOffset = xC + "+padLeft%2+" + "+nextTexelOffset+";\n\n                  if(xR >= 0 && xR < "+xNumRows+" &&\n                    xCOffset >= 0 && xCOffset < "+xNumCols+") {\n                    xTexelR"+r+"C"+(c+2)+" = getX(batch, xR, xCOffset, d1);\n                  }\n                ",1<dilationWidth&&(mainLoop+="\n                    xCOffset -= 2;\n                    if(xR >= 0 && xR < "+xNumRows+" &&\n                      xCOffset >= 0 && xCOffset < "+xNumCols+") {\n                      xTexelR"+r+"C"+c+" = getX(batch, xR, xCOffset, d1);\n                    } else {\n                      xTexelR"+r+"C"+c+" = vec4(0.);\n                    }\n                  "),mainLoop+="\n                  xR"+r+"C"+(c+1)+" = vec4(\n                    xTexelR"+r+"C"+c+".zw, xTexelR"+r+"C"+(c+2)+".xy);\n                "):mainLoop+="\n                  xCOffset = xC + "+nextTexelOffset+";\n\n                  if(xR >= 0 && xR < "+xNumRows+" &&\n                    xCOffset >= 0 && xCOffset < "+xNumCols+") {\n                    xTexelR"+r+"C"+(c+2)+" = getX(batch, xR, xCOffset, d1);\n                  }\n\n                  xR"+r+"C"+(c+1)+" = xTexelR"+r+"C"+(c+2)+";\n                "}}else c<filterWidth&&(mainLoop+="\n              if(xR >= 0 && xR < "+xNumRows+") {\n            ",padLeft%2==1?(mainLoop+="\n                xCOffset = xC + 1 - "+strideWidth+";\n                if(xCOffset >= 0 && xCOffset < "+xNumCols+") {\n                  xTexelR"+r+"C"+c+" = getX(batch, xR, xCOffset, d1);\n                } else {\n                  xTexelR"+r+"C"+c+" = vec4(0.);\n                }\n\n                if(xC + 1 >= 0 && xC + 1 < "+xNumCols+") {\n                  xTexelR"+r+"C"+(c+2)+" = getX(batch, xR, xC + 1, d1);\n                } else {\n                  xTexelR"+r+"C"+(c+2)+" = vec4(0.);\n                }\n\n                xR"+r+"C"+c+" = vec4(\n                  xTexelR"+r+"C"+c+".zw, xTexelR"+r+"C"+(c+2)+".zw);\n              ",c+1<filterWidth&&(mainLoop+="\n                  vec4 final = vec4(0.);\n                  xCOffset = xC + 1 + "+strideWidth+";\n                  if(xCOffset >= 0 && xCOffset < "+xNumCols+") {\n                    final = getX(batch, xR, xCOffset, d1);\n                  }\n                  xR"+r+"C"+(c+1)+" = vec4(xTexelR"+r+"C"+(c+2)+".xy, final.xy);\n                ")):(mainLoop+="\n                if(xC >= 0 && xC < "+xNumCols+") {\n                  xTexelR"+r+"C"+c+" = getX(batch, xR, xC, d1);\n                } else {\n                  xTexelR"+r+"C"+c+" = vec4(0.);\n                }\n\n                xCOffset = xC + "+strideWidth+";\n                if(xCOffset >= 0 && xCOffset < "+xNumCols+") {\n                  xTexelR"+r+"C"+(c+2)+" = getX(batch, xR, xCOffset, d1);\n                } else {\n                  xTexelR"+r+"C"+(c+2)+" = vec4(0.);\n                }\n\n                xR"+r+"C"+c+" = vec4(\n                  xTexelR"+r+"C"+c+".xy, xTexelR"+r+"C"+(c+2)+".xy);\n              ",c+1<filterWidth&&(mainLoop+="\n                  xR"+r+"C"+(c+1)+" = vec4(\n                    xTexelR"+r+"C"+c+".zw, xTexelR"+r+"C"+(c+2)+".zw);\n                ")),mainLoop+="}");c<filterWidth&&(mainLoop+="\n            vec4 wTexelR"+r+"C"+c+" = getW("+r+", "+c+", d1, q);\n            wR"+r+"C"+c+" = vec4(wTexelR"+r+"C"+c+".xz, wTexelR"+r+"C"+c+".xz);\n          ",c+1<filterWidth&&(mainLoop+="\n              vec4 wTexelR"+r+"C"+(c+1)+" = getW("+r+", "+(c+1)+", d1, q);\n              wR"+r+"C"+(c+1)+" =\n                vec4(wTexelR"+r+"C"+(c+1)+".xz, wTexelR"+r+"C"+(c+1)+".xz);"))}for(r=0;r<filterHeight;r++)for(c=0;c<filterWidth;c++)mainLoop+="result += xR"+r+"C"+c+" * wR"+r+"C"+c+";";this.userCode="\n      const ivec2 strides = ivec2("+strideHeight+", "+strideWidth+");\n      const ivec2 pads = ivec2("+padTop+", "+padLeft+");\n\n      void main() {\n\n        ivec4 coords = getOutputCoords();\n        int batch = coords.x;\n        ivec2 xRCCorner = coords.yz * strides - pads;\n        int d2 = coords.w;\n        int d1 = d2;\n        int q = 0;\n        int xRCorner = xRCCorner.x;\n        int xCCorner = xRCCorner.y;\n\n        vec4 result = vec4(0.);\n\n        "+mainLoop+"\n\n        setOutput(result);\n      }\n    "}var util=require("../../util");exports.DepthwiseConvPacked2DProgram=DepthwiseConvPacked2DProgram},{"../../util":241}],81:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});function CropAndResizeProgram(imageShape,boxShape,cropSize,method,extrapolationValue){this.variableNames=["Image","Boxes","BoxInd"],this.outputShape=[];var batch=imageShape[0],imageHeight=imageShape[1],imageWidth=imageShape[2],depth=imageShape[3],numBoxes=boxShape[0],cropHeight=cropSize[0],cropWidth=cropSize[1];this.outputShape=[numBoxes,cropHeight,cropWidth,depth];var methodId="bilinear"===method?1:0,_a=[imageHeight-1+".0",imageWidth-1+".0"],inputHeightFloat=_a[0],inputWidthFloat=_a[1],_b=1<cropHeight?[""+(imageHeight-1)/(cropHeight-1),"(y2-y1) * height_ratio","y1*"+inputHeightFloat+" + float(y)*(height_scale)"]:["0.0","0.0","0.5 * (y1+y2) * "+inputHeightFloat],heightRatio=_b[0],heightScale=_b[1],inY=_b[2],_c=1<cropWidth?[""+(imageWidth-1)/(cropWidth-1),"(x2-x1) * width_ratio","x1*"+inputWidthFloat+" + float(x)*(width_scale)"]:["0.0","0.0","0.5 * (x1+x2) * "+inputWidthFloat],widthRatio=_c[0],widthScale=_c[1],inX=_c[2];this.userCode="\n      const float height_ratio = float("+heightRatio+");\n      const float width_ratio = float("+widthRatio+");\n      void main() {\n        ivec4 coords = getOutputCoords();\n        int b = coords[0];\n        int y = coords[1];\n        int x = coords[2];\n        int d = coords[3];\n\n        // get box vals\n        float y1 = getBoxes(b,0);\n        float x1 = getBoxes(b,1);\n        float y2 = getBoxes(b,2);\n        float x2 = getBoxes(b,3);\n\n        // get image in batch index\n        int bInd = round(getBoxInd(b));\n        if(bInd < 0 || bInd >= "+batch+") {\n          return;\n        }\n\n        float height_scale = "+heightScale+";\n        float width_scale = "+widthScale+";\n\n        float in_y = "+inY+";\n        if( in_y < 0.0 || in_y > "+inputHeightFloat+" ) {\n          setOutput(float("+extrapolationValue+"));\n          return;\n        }\n        float in_x = "+inX+";\n        if( in_x < 0.0 || in_x > "+inputWidthFloat+" ) {\n          setOutput(float("+extrapolationValue+"));\n          return;\n        }\n\n        vec2 sourceFracIndexCR = vec2(in_x,in_y);\n        if("+methodId+" == 1) {\n          // Compute the four integer indices.\n          ivec2 sourceFloorCR = ivec2(sourceFracIndexCR);\n          ivec2 sourceCeilCR = ivec2(ceil(sourceFracIndexCR));\n\n          float topLeft = getImage(b, sourceFloorCR.y, sourceFloorCR.x, d);\n          float bottomLeft = getImage(b, sourceCeilCR.y, sourceFloorCR.x, d);\n          float topRight = getImage(b, sourceFloorCR.y, sourceCeilCR.x, d);\n          float bottomRight = getImage(b, sourceCeilCR.y, sourceCeilCR.x, d);\n\n          vec2 fracCR = sourceFracIndexCR - vec2(sourceFloorCR);\n\n          float top = topLeft + (topRight - topLeft) * fracCR.x;\n          float bottom = bottomLeft + (bottomRight - bottomLeft) * fracCR.x;\n          float newValue = top + (bottom - top) * fracCR.y;\n          setOutput(newValue);\n        } else {\n          // Compute the coordinators of nearest neighbor point.\n          ivec2 sourceNearestCR = ivec2(floor(\n            sourceFracIndexCR + vec2(0.5,0.5)));\n          float newValue = getImage(b, sourceNearestCR.y, sourceNearestCR.x, d);\n          setOutput(newValue);\n        }\n      }\n    "}exports.CropAndResizeProgram=CropAndResizeProgram},{}],82:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});function CumSumProgram(shape,exclusive,reverse){this.variableNames=["x"];var rank=(this.outputShape=shape).length,finalDim=shape[shape.length-1],comparator=reverse?"<":">";this.userCode="\n      int getIndex(int i) {\n        "+(reverse?"return "+finalDim+" -i - 1;":"return i;")+"\n      }\n\n      void main() {\n        "+shader_compiler_1.getCoordsDataType(rank)+" coords = getOutputCoords();\n        int end = "+getFinalCoord(rank,"coords")+";\n        float val = 0.0;\n        for (int i = "+finalDim+" - 1; i >= 0; i -= 1) {\n          int idx = getIndex(i);\n          if (idx "+comparator+" end) {\n            continue;\n          }\n          if (idx == end && "+exclusive+") {\n            continue;\n          }\n          "+getFinalCoord(rank,"coords")+" = idx;\n          val += getX("+function(rank,name){if(1===rank)return""+name;if(2===rank)return name+".x, "+name+".y";if(3===rank)return name+".x, "+name+".y, "+name+".z";if(4===rank)return name+".x, "+name+".y, "+name+".z, "+name+".w";throw Error("Cumulative sum for rank "+rank+" is not yet supported")}(rank,"coords")+");\n        }\n        setOutput(val);\n      }\n    "}var shader_compiler_1=require("./shader_compiler");function getFinalCoord(rank,name){if(1===rank)return""+name;if(2===rank)return name+".y";if(3===rank)return name+".z";if(4===rank)return name+".w";throw Error("Cumulative sum for rank "+rank+" is not yet supported")}exports.CumSumProgram=CumSumProgram},{"./shader_compiler":126}],83:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});function DecodeMatrixProgram(outputShape,texShape){this.variableNames=["A"];var glsl=glsl_version_1.getGlslDifferences();this.outputShape=outputShape,this.userCode="\n      ivec3 outCoordsFromFlatIndex(int index) {\n        "+shader_util.getLogicalCoordinatesFromFlatIndex(["r","c","d"],outputShape)+"\n        return ivec3(r, c, d);\n      }\n\n      void main() {\n        ivec2 resTexRC = ivec2(resultUV.yx *\n          vec2("+texShape[0]+", "+texShape[1]+"));\n        int index = 4 * (resTexRC.x * "+texShape[1]+" + resTexRC.y);\n\n        vec4 result = vec4(0.);\n\n        for (int i=0; i<4; i++) {\n          int flatIndex = index + i;\n          ivec3 rc = outCoordsFromFlatIndex(flatIndex);\n          result[i] = getA(rc.x, rc.y, rc.z);\n        }\n\n        "+glsl.output+" = result;\n      }\n    "}var glsl_version_1=require("./glsl_version"),shader_util=require("./shader_compiler_util");exports.DecodeMatrixProgram=DecodeMatrixProgram},{"./glsl_version":98,"./shader_compiler_util":127}],84:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});function DecodeMatrixPackedProgram(outputShape,texShape){this.variableNames=["A"],this.usesPackedTextures=!0;var glsl=glsl_version_1.getGlslDifferences();this.outputShape=outputShape,this.userCode="\n      ivec3 outCoordsFromFlatIndex(int index) {\n        "+shader_util.getLogicalCoordinatesFromFlatIndex(["r","c","d"],outputShape)+"\n        return ivec3(r, c, d);\n      }\n\n      void main() {\n        ivec2 resTexRC = ivec2(resultUV.yx *\n          vec2("+texShape[0]+", "+texShape[1]+"));\n        int index = 4 * (resTexRC.x * "+texShape[1]+" + resTexRC.y);\n\n        vec4 result = vec4(0.);\n\n        for (int i=0; i<4; i++) {\n          int flatIndex = index + i;\n          ivec3 rc = outCoordsFromFlatIndex(flatIndex);\n          result[i] = getChannel(getA(rc.x, rc.y, rc.z), vec2(rc.y, rc.z));\n        }\n\n        "+glsl.output+" = result;\n      }\n    "}var glsl_version_1=require("./glsl_version"),shader_util=require("./shader_compiler_util");exports.DecodeMatrixPackedProgram=DecodeMatrixPackedProgram},{"./glsl_version":98,"./shader_compiler_util":127}],85:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var DepthToSpaceProgram=function(){function DepthToSpaceProgram(outputShape,blockSize,dataFormat){this.variableNames=["x"],this.outputShape=[],this.outputShape=outputShape,this.blockSize=blockSize,this.dataFormat=dataFormat,this.userCode="\n    void main() {\n      ivec4 coords = getOutputCoords();\n      int b = coords[0];\n      int h = "+this.getHeightCoordString()+";\n      int w = "+this.getWidthCoordString()+";\n      int d = "+this.getDepthCoordString()+";\n\n      int in_h = h / "+blockSize+";\n      int offset_h = imod(h, "+blockSize+");\n      int in_w = w / "+blockSize+";\n      int offset_w = imod(w, "+blockSize+");\n      int offset_d = (offset_h * "+blockSize+" + offset_w) *\n        "+this.getOutputDepthSize()+";\n      int in_d = d + offset_d;\n\n      float result = "+this.getInputSamplingString()+";\n      setOutput(result);\n    }\n  "}return DepthToSpaceProgram.prototype.getHeightCoordString=function(){return"NHWC"===this.dataFormat?"coords[1]":"coords[2]"},DepthToSpaceProgram.prototype.getWidthCoordString=function(){return"NHWC"===this.dataFormat?"coords[2]":"coords[3]"},DepthToSpaceProgram.prototype.getDepthCoordString=function(){return"NHWC"===this.dataFormat?"coords[3]":"coords[1]"},DepthToSpaceProgram.prototype.getOutputDepthSize=function(){return"NHWC"===this.dataFormat?this.outputShape[3]:this.outputShape[1]},DepthToSpaceProgram.prototype.getInputSamplingString=function(){return"NHWC"===this.dataFormat?"getX(b, in_h, in_w, in_d)":"getX(b, in_d, in_h, in_w)"},DepthToSpaceProgram}();exports.DepthToSpaceProgram=DepthToSpaceProgram},{}],86:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});function DiagProgram(size){this.variableNames=["X"],this.outputShape=[size,size],this.userCode="\n      void main() {\n          ivec2 coords = getOutputCoords();\n          float val = coords[0] == coords[1] ? getX(coords[0]) : 0.0;\n          setOutput(val);\n      }\n    "}exports.DiagProgram=DiagProgram},{}],87:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});function EncodeFloatProgram(outputShape){this.variableNames=["A"];var glsl=glsl_version_1.getGlslDifferences();this.outputShape=outputShape,this.userCode="\n      "+shader_compiler_util_1.ENCODE_FLOAT_SNIPPET+"\n\n      void main() {\n        float x = getAAtOutCoords();\n        "+glsl.output+" = encode_float(x);\n      }\n    "}var glsl_version_1=require("./glsl_version"),shader_compiler_util_1=require("./shader_compiler_util");exports.EncodeFloatProgram=EncodeFloatProgram},{"./glsl_version":98,"./shader_compiler_util":127}],88:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});function EncodeFloatPackedProgram(outputShape){this.variableNames=["A"],this.usesPackedTextures=!0;var glsl=glsl_version_1.getGlslDifferences();this.outputShape=outputShape,this.userCode="\n      "+shader_compiler_util_1.ENCODE_FLOAT_SNIPPET+"\n\n      void main() {\n        ivec3 coords = getOutputCoords();\n        float x = getChannel(getAAtOutCoords(), vec2(coords.y, coords.z));\n        "+glsl.output+" = encode_float(x);\n      }\n    "}var glsl_version_1=require("./glsl_version"),shader_compiler_util_1=require("./shader_compiler_util");exports.EncodeFloatPackedProgram=EncodeFloatPackedProgram},{"./glsl_version":98,"./shader_compiler_util":127}],89:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});function EncodeMatrixProgram(outputShape,texShape,inputIsUnsignedByte){void 0===inputIsUnsignedByte&&(inputIsUnsignedByte=!1),this.variableNames=["A"];var glsl=glsl_version_1.getGlslDifferences(),height=texShape[0],width=texShape[1];this.outputShape=outputShape;var output="result";inputIsUnsignedByte&&(output="floor(result * 255. + 0.5)"),this.userCode="\n      "+shader_util.getFlatIndexFrom3D(outputShape)+"\n\n      void main() {\n        ivec3 coords = getOutputCoords();\n\n        int flatIndex = getFlatIndex(coords);\n        int offset = imod(flatIndex, 4);\n\n        flatIndex = idiv(flatIndex, 4, 1.);\n        \n        int r = flatIndex / "+width+";\n        int c = imod(flatIndex, "+width+");\n        vec2 uv = (vec2(c, r) + halfCR) / vec2("+width+".0, "+height+".0);\n        vec4 values = "+glsl.texture2D+"(A, uv);\n\n        float result;\n\n        if(offset == 0) {\n          result = values[0];\n        } else if(offset == 1) {\n          result = values[1];\n        } else if(offset == 2) {\n          result = values[2];\n        } else {\n          result = values[3];\n        }\n\n        "+glsl.output+" = vec4("+output+", 0., 0., 0.);\n      }\n    "}var glsl_version_1=require("./glsl_version"),shader_util=require("./shader_compiler_util");exports.EncodeMatrixProgram=EncodeMatrixProgram},{"./glsl_version":98,"./shader_compiler_util":127}],90:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});function EncodeMatrixPackedProgram(outputShape,texShape,inputIsUnsignedByte){void 0===inputIsUnsignedByte&&(inputIsUnsignedByte=!1),this.variableNames=["A"];var glsl=glsl_version_1.getGlslDifferences(),height=texShape[0],width=texShape[1];this.outputShape=outputShape;var mainLoop="",output="result";inputIsUnsignedByte&&(output="floor(result * 255. + 0.5)");for(var row=0;row<=1;row++)for(var col=0;col<=1;col++){var channel=2*row+col;mainLoop+="\n          localCoords = coords;\n          if(localCoords[2] + "+col+" < "+outputShape[2]+") {\n            localCoords[2] += "+col+";\n            if(localCoords[1] + "+row+" < "+outputShape[1]+") {\n              localCoords[1] += "+row+";\n\n              flatIndex = getFlatIndex(localCoords);\n              offset = imod(flatIndex, 4);\n    \n              flatIndex = idiv(flatIndex, 4, 1.);\n\n              r = flatIndex / "+width+";\n              c = imod(flatIndex, "+width+");\n              uv = (vec2(c, r) + halfCR) / vec2("+width+".0, "+height+".0);\n              values = "+glsl.texture2D+"(A, uv);\n\n              if(offset == 0) {\n                result["+channel+"] = values[0];\n              } else if(offset == 1) {\n                result["+channel+"] = values[1];\n              } else if(offset == 2) {\n                result["+channel+"] = values[2];\n              } else {\n                result["+channel+"] = values[3];\n              }\n            }\n          }\n        "}this.userCode="\n      "+shader_util.getFlatIndexFrom3D(outputShape)+"\n\n      void main() {\n        ivec3 coords = getOutputCoords();\n\n        vec4 result = vec4(0.);\n        int flatIndex, r, c, offset;\n        ivec3 localCoords;\n        vec2 uv;\n        vec4 values;\n        \n        "+mainLoop+"\n\n        "+glsl.output+" = "+output+";\n      }\n    "}var glsl_version_1=require("./glsl_version"),shader_util=require("./shader_compiler_util");exports.EncodeMatrixPackedProgram=EncodeMatrixPackedProgram},{"./glsl_version":98,"./shader_compiler_util":127}],91:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.COMPLEX_FFT={REAL:"return real * expR - imag * expI;",IMAG:"return real * expI + imag * expR;"};function FFTProgram(op,inputShape,inverse){this.variableNames=["real","imag"];var innerDim=inputShape[1];this.outputShape=inputShape;var exponentMultiplierSnippet=inverse?"2.0 * "+Math.PI:"-2.0 * "+Math.PI,resultDenominator=inverse?innerDim+".0":"1.0";this.userCode="\n      const float exponentMultiplier = "+exponentMultiplierSnippet+";\n\n      float unaryOpComplex(float real, float expR, float imag, float expI) {\n        "+op+"\n      }\n\n      float mulMatDFT(int batch, int index) {\n        float indexRatio = float(index) / float("+innerDim+");\n        float exponentMultiplierTimesIndexRatio =\n            exponentMultiplier * indexRatio;\n\n        float result = 0.0;\n\n        for (int i = 0; i < "+innerDim+"; i++) {\n          // x = (-2|2 * PI / N) * index * i;\n          float x = exponentMultiplierTimesIndexRatio * float(i);\n          float expR = cos(x);\n          float expI = sin(x);\n          float real = getReal(batch, i);\n          float imag = getImag(batch, i);\n\n          result +=\n              unaryOpComplex(real, expR, imag, expI) / "+resultDenominator+";\n        }\n\n        return result;\n      }\n\n      void main() {\n        ivec2 coords = getOutputCoords();\n        setOutput(mulMatDFT(coords[0], coords[1]));\n      }\n    "}exports.FFTProgram=FFTProgram},{}],92:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var FillProgram=function(){function FillProgram(shape,value){this.outputShape=[],this.variableNames=["x"],this.outputShape=shape,this.userCode="\n      uniform float value;\n      void main() {\n        // Input can be obtained from uniform value.\n        setOutput(value);\n      }\n    "}return FillProgram.prototype.getCustomSetupFunc=function(value){var _this=this;return function(gpgpu,webGLProgram){null==_this.valueLoc&&(_this.valueLoc=gpgpu.getUniformLocationNoThrow(webGLProgram,"value")),gpgpu.gl.uniform1f(_this.valueLoc,value)}},FillProgram}();exports.FillProgram=FillProgram},{}],93:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var device_util=require("../../device_util"),environment_1=require("../../environment"),webgl_util=require("./webgl_util");environment_1.ENV.registerFlag("HAS_WEBGL",function(){return 0<environment_1.ENV.getNumber("WEBGL_VERSION")}),environment_1.ENV.registerFlag("WEBGL_VERSION",function(){return webgl_util.isWebGLVersionEnabled(2)?2:webgl_util.isWebGLVersionEnabled(1)?1:0}),environment_1.ENV.registerFlag("WEBGL_BUFFER_SUPPORTED",function(){return 2===environment_1.ENV.get("WEBGL_VERSION")}),environment_1.ENV.registerFlag("WEBGL_CPU_FORWARD",function(){return!0}),environment_1.ENV.registerFlag("WEBGL_PACK",function(){return environment_1.ENV.getBool("HAS_WEBGL")}),environment_1.ENV.registerFlag("WEBGL_PACK_NORMALIZATION",function(){return environment_1.ENV.getBool("WEBGL_PACK")}),environment_1.ENV.registerFlag("WEBGL_PACK_CLIP",function(){return environment_1.ENV.getBool("WEBGL_PACK")}),environment_1.ENV.registerFlag("WEBGL_PACK_DEPTHWISECONV",function(){return!1}),environment_1.ENV.registerFlag("WEBGL_PACK_BINARY_OPERATIONS",function(){return environment_1.ENV.getBool("WEBGL_PACK")}),environment_1.ENV.registerFlag("WEBGL_PACK_ARRAY_OPERATIONS",function(){return environment_1.ENV.getBool("WEBGL_PACK")}),environment_1.ENV.registerFlag("WEBGL_PACK_IMAGE_OPERATIONS",function(){return environment_1.ENV.getBool("WEBGL_PACK")}),environment_1.ENV.registerFlag("WEBGL_PACK_REDUCE",function(){return environment_1.ENV.getBool("WEBGL_PACK")}),environment_1.ENV.registerFlag("WEBGL_LAZILY_UNPACK",function(){return environment_1.ENV.getBool("WEBGL_PACK")}),environment_1.ENV.registerFlag("WEBGL_CONV_IM2COL",function(){return environment_1.ENV.getBool("WEBGL_PACK")}),environment_1.ENV.registerFlag("WEBGL_MAX_TEXTURE_SIZE",function(){return webgl_util.getWebGLMaxTextureSize(environment_1.ENV.getNumber("WEBGL_VERSION"))}),environment_1.ENV.registerFlag("WEBGL_MAX_TEXTURES_IN_SHADER",function(){return webgl_util.getMaxTexturesInShader(environment_1.ENV.getNumber("WEBGL_VERSION"))}),environment_1.ENV.registerFlag("WEBGL_DISJOINT_QUERY_TIMER_EXTENSION_VERSION",function(){var webGLVersion=environment_1.ENV.getNumber("WEBGL_VERSION");return 0===webGLVersion?0:webgl_util.getWebGLDisjointQueryTimerVersion(webGLVersion)}),environment_1.ENV.registerFlag("WEBGL_DISJOINT_QUERY_TIMER_EXTENSION_RELIABLE",function(){return 0<environment_1.ENV.getNumber("WEBGL_DISJOINT_QUERY_TIMER_EXTENSION_VERSION")&&!device_util.isMobile()}),environment_1.ENV.registerFlag("WEBGL_RENDER_FLOAT32_ENABLED",function(){return webgl_util.isRenderToFloatTextureEnabled(environment_1.ENV.getNumber("WEBGL_VERSION"))}),environment_1.ENV.registerFlag("WEBGL_DOWNLOAD_FLOAT_ENABLED",function(){return webgl_util.isDownloadFloatTextureEnabled(environment_1.ENV.getNumber("WEBGL_VERSION"))}),environment_1.ENV.registerFlag("WEBGL_FENCE_API_ENABLED",function(){return webgl_util.isWebGLFenceEnabled(environment_1.ENV.getNumber("WEBGL_VERSION"))}),environment_1.ENV.registerFlag("WEBGL_SIZE_UPLOAD_UNIFORM",function(){return environment_1.ENV.getBool("WEBGL_RENDER_FLOAT32_ENABLED")?4:0})},{"../../device_util":142,"../../environment":144,"./webgl_util":139}],94:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});function FromPixelsProgram(outputShape){this.variableNames=["A"];var glsl=glsl_version_1.getGlslDifferences(),height=outputShape[0],width=outputShape[1];this.outputShape=outputShape,this.userCode="\n      void main() {\n        ivec3 coords = getOutputCoords();\n        int texR = coords[0];\n        int texC = coords[1];\n        int depth = coords[2];\n        vec2 uv = (vec2(texC, texR) + halfCR) / vec2("+width+".0, "+height+".0);\n\n        vec4 values = "+glsl.texture2D+"(A, uv);\n        float value;\n        if (depth == 0) {\n          value = values.r;\n        } else if (depth == 1) {\n          value = values.g;\n        } else if (depth == 2) {\n          value = values.b;\n        } else if (depth == 3) {\n          value = values.a;\n        }\n\n        setOutput(floor(value * 255.0 + 0.5));\n      }\n    "}var glsl_version_1=require("./glsl_version");exports.FromPixelsProgram=FromPixelsProgram},{"./glsl_version":98}],95:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});function FromPixelsPackedProgram(outputShape){this.variableNames=["A"];var glsl=glsl_version_1.getGlslDifferences(),height=outputShape[0],width=outputShape[1];this.outputShape=outputShape,this.userCode="\n      void main() {\n        ivec3 coords = getOutputCoords();\n        int texR = coords[0];\n        int texC = coords[1];\n        int depth = coords[2];\n\n        vec4 result = vec4(0.);\n\n        for(int row=0; row<=1; row++) {\n          for(int col=0; col<=1; col++) {\n            texC = coords[1] + row;\n            depth = coords[2] + col;\n\n            vec2 uv = (vec2(texC, texR) + halfCR) / vec2("+width+".0, "+height+".0);\n            vec4 values = "+glsl.texture2D+"(A, uv);\n            float value;\n            if (depth == 0) {\n              value = values.r;\n            } else if (depth == 1) {\n              value = values.g;\n            } else if (depth == 2) {\n              value = values.b;\n            } else if (depth == 3) {\n              value = values.a;\n            }\n\n            result[row * 2 + col] = floor(value * 255.0 + 0.5);\n          }\n        }\n\n        "+glsl.output+" = result;\n      }\n    "}var glsl_version_1=require("./glsl_version");exports.FromPixelsPackedProgram=FromPixelsPackedProgram},{"./glsl_version":98}],96:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});function GatherProgram(aShape,indicesLength,axis){this.variableNames=["A","indices"];var outputShape=aShape.slice();outputShape[axis]=indicesLength,this.outputShape=outputShape,this.rank=outputShape.length;var dtype=shader_compiler_1.getCoordsDataType(this.rank),sourceCoords=function(aShape,axis){var rank=aShape.length;if(4<rank)throw Error("Gather for rank "+rank+" is not yet supported");if(1===rank)return"int(getIndices(resRC))";for(var currentCoords=["resRC.x","resRC.y","resRC.z","resRC.w"],sourceCoords=[],i=0;i<aShape.length;i++)i===axis?sourceCoords.push("int(getIndices("+currentCoords[i]+"))"):sourceCoords.push(""+currentCoords[i]);return sourceCoords.join()}(aShape,axis);this.userCode="\n      void main() {\n        "+dtype+" resRC = getOutputCoords();\n        setOutput(getA("+sourceCoords+"));\n      }\n    "}var shader_compiler_1=require("./shader_compiler");exports.GatherProgram=GatherProgram},{"./shader_compiler":126}],97:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});function GatherNDProgram(sliceDim,strides,shape){this.sliceDim=sliceDim,this.strides=strides,this.variableNames=["x","indices"],this.outputShape=shape;var stridesType=shader_compiler_1.getCoordsDataType(strides.length),dtype=shader_compiler_1.getCoordsDataType(shape.length),strideString=1<this.sliceDim?"strides[j]":"strides";this.userCode="\n        "+stridesType+" strides = "+stridesType+"("+this.strides+");\n         void main() {\n          "+dtype+" coords = getOutputCoords();\n          int flattenIndex = 0;\n          for (int j = 0; j < "+this.sliceDim+"; j++) {\n            int index = round(getIndices(coords[0], j));\n            flattenIndex += index * "+strideString+";\n          }\n          setOutput(getX(flattenIndex, coords[1]));\n        }\n      "}var shader_compiler_1=require("./shader_compiler");exports.GatherNDProgram=GatherNDProgram},{"./shader_compiler":126}],98:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var environment_1=require("../../environment");exports.getGlslDifferences=function(){var version,attribute,varyingVs,varyingFs,texture2D,output,defineOutput,defineSpecialNaN,defineSpecialInf,defineRound;return defineRound=2===environment_1.ENV.getNumber("WEBGL_VERSION")?(version="#version 300 es",varyingVs="out",varyingFs=attribute="in",texture2D="texture",output="outputColor",defineOutput="out vec4 outputColor;",defineSpecialNaN="\n      bool isnan_custom(float val) {\n        return (val > 0. || val < 0. || val == 0.) ? false : true;\n      }\n    ",defineSpecialInf="","\n      #define round(value) newRound(value)\n      int newRound(float value) {\n        return int(floor(value + 0.5));\n      }\n\n      ivec4 newRound(vec4 value) {\n        return ivec4(floor(value + vec4(0.5)));\n      }\n    "):(attribute="attribute",varyingFs=varyingVs="varying",texture2D="texture2D",output="gl_FragColor",defineOutput=version="",defineSpecialNaN="\n      bool isnan_custom(float val) {\n        return (val > 0. || val < 1. || val == 0.) ? false : true;\n      }\n    ",defineSpecialInf="\n      uniform float INFINITY;\n\n      bool isinf(float val) {\n        return abs(val) == INFINITY;\n      }\n      bvec4 isinf(vec4 val) {\n        return equal(abs(val), vec4(INFINITY));\n      }\n    ","\n      int round(float value) {\n        return int(floor(value + 0.5));\n      }\n\n      ivec4 round(vec4 value) {\n        return ivec4(floor(value + vec4(0.5)));\n      }\n    "),{version:version,attribute:attribute,varyingVs:varyingVs,varyingFs:varyingFs,texture2D:texture2D,output:output,defineOutput:defineOutput,defineSpecialNaN:defineSpecialNaN,defineSpecialInf:defineSpecialInf,defineRound:defineRound}}},{"../../environment":144}],99:[function(require,module,exports){"use strict";var __awaiter=this&&this.__awaiter||function(thisArg,_arguments,P,generator){return new(P=P||Promise)(function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){result.done?resolve(result.value):new P(function(resolve){resolve(result.value)}).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())})},__generator=this&&this.__generator||function(thisArg,body){var f,y,t,g,_={label:0,sent:function(){if(1&t[0])throw t[1];return t[1]},trys:[],ops:[]};return g={next:verb(0),throw:verb(1),return:verb(2)},"function"==typeof Symbol&&(g[Symbol.iterator]=function(){return this}),g;function verb(n){return function(v){return function(op){if(f)throw new TypeError("Generator is already executing.");for(;_;)try{if(f=1,y&&(t=2&op[0]?y.return:op[0]?y.throw||((t=y.return)&&t.call(y),0):y.next)&&!(t=t.call(y,op[1])).done)return t;switch(y=0,t&&(op=[2&op[0],t.value]),op[0]){case 0:case 1:t=op;break;case 4:return _.label++,{value:op[1],done:!1};case 5:_.label++,y=op[1],op=[0];continue;case 7:op=_.ops.pop(),_.trys.pop();continue;default:if(!(t=0<(t=_.trys).length&&t[t.length-1])&&(6===op[0]||2===op[0])){_=0;continue}if(3===op[0]&&(!t||op[1]>t[0]&&op[1]<t[3])){_.label=op[1];break}if(6===op[0]&&_.label<t[1]){_.label=t[1],t=op;break}if(t&&_.label<t[2]){_.label=t[2],_.ops.push(op);break}t[2]&&_.ops.pop(),_.trys.pop();continue}op=body.call(thisArg,_)}catch(e){op=[6,e],y=0}finally{f=t=0}if(5&op[0])throw op[1];return{value:op[0]?op[1]:void 0,done:!0}}([n,v])}}};Object.defineProperty(exports,"__esModule",{value:!0});var environment_1=require("../../environment"),util=require("../../util"),canvas_util_1=require("./canvas_util"),gpgpu_util=require("./gpgpu_util"),tex_util=require("./tex_util"),webgl_util=require("./webgl_util"),GPGPUContext=function(){function GPGPUContext(gl){this.outputTexture=null,this.program=null,this.disposed=!1,this.vertexAttrsAreBound=!1,this.itemsToPoll=[];var glVersion=environment_1.ENV.getNumber("WEBGL_VERSION");if(null!=gl?(this.gl=gl,canvas_util_1.setWebGLContext(glVersion,gl)):this.gl=canvas_util_1.getWebGLContext(glVersion),1===environment_1.ENV.getNumber("WEBGL_VERSION"))this.textureFloatExtension=webgl_util.getExtensionOrThrow(this.gl,this.debug,"OES_texture_float"),this.colorBufferFloatExtension=this.gl.getExtension("WEBGL_color_buffer_float"),environment_1.ENV.getBool("WEBGL_RENDER_FLOAT32_ENABLED")||(this.textureHalfFloatExtension=webgl_util.getExtensionOrThrow(this.gl,this.debug,"OES_texture_half_float"),this.colorBufferHalfFloatExtension=this.gl.getExtension("EXT_color_buffer_half_float"));else{if(webgl_util.hasExtension(this.gl,"EXT_color_buffer_float"))this.colorBufferFloatExtension=this.gl.getExtension("EXT_color_buffer_float");else{if(!webgl_util.hasExtension(this.gl,"EXT_color_buffer_half_float"))throw new Error("GL context does not support color renderable floats");this.colorBufferHalfFloatExtension=this.gl.getExtension("EXT_color_buffer_half_float")}}this.vertexBuffer=gpgpu_util.createVertexBuffer(this.gl,this.debug),this.indexBuffer=gpgpu_util.createIndexBuffer(this.gl,this.debug),this.framebuffer=webgl_util.createFramebuffer(this.gl,this.debug),this.textureConfig=tex_util.getTextureConfig(this.gl,this.textureHalfFloatExtension)}return Object.defineProperty(GPGPUContext.prototype,"debug",{get:function(){return environment_1.ENV.getBool("DEBUG")},enumerable:!0,configurable:!0}),GPGPUContext.prototype.dispose=function(){var _this=this;if(!this.disposed){null!=this.program&&console.warn("Disposing a GPGPUContext that still has a bound WebGLProgram. This is probably a resource leak, delete the program with GPGPUContext.deleteProgram before disposing."),null!=this.outputTexture&&console.warn("Disposing a GPGPUContext that still has a bound output matrix texture.  This is probably a resource leak, delete the output matrix texture with GPGPUContext.deleteMatrixTexture before disposing.");var gl=this.gl;webgl_util.callAndCheck(gl,this.debug,function(){return gl.finish()}),webgl_util.callAndCheck(gl,this.debug,function(){return gl.bindFramebuffer(gl.FRAMEBUFFER,null)}),webgl_util.callAndCheck(gl,this.debug,function(){return gl.deleteFramebuffer(_this.framebuffer)}),webgl_util.callAndCheck(gl,this.debug,function(){return gl.bindBuffer(gl.ARRAY_BUFFER,null)}),webgl_util.callAndCheck(gl,this.debug,function(){return gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER,null)}),webgl_util.callAndCheck(gl,this.debug,function(){return gl.deleteBuffer(_this.indexBuffer)}),this.disposed=!0}},GPGPUContext.prototype.createFloat32MatrixTexture=function(rows,columns){return this.throwIfDisposed(),gpgpu_util.createFloat32MatrixTexture(this.gl,this.debug,rows,columns,this.textureConfig)},GPGPUContext.prototype.createFloat16MatrixTexture=function(rows,columns){return this.throwIfDisposed(),gpgpu_util.createFloat16MatrixTexture(this.gl,this.debug,rows,columns,this.textureConfig)},GPGPUContext.prototype.createUnsignedBytesMatrixTexture=function(rows,columns){return this.throwIfDisposed(),gpgpu_util.createUnsignedBytesMatrixTexture(this.gl,this.debug,rows,columns,this.textureConfig)},GPGPUContext.prototype.uploadPixelDataToTexture=function(texture,pixels){this.throwIfDisposed(),gpgpu_util.uploadPixelDataToTexture(this.gl,this.debug,texture,pixels)},GPGPUContext.prototype.uploadDenseMatrixToTexture=function(texture,width,height,data){this.throwIfDisposed(),gpgpu_util.uploadDenseMatrixToTexture(this.gl,this.debug,texture,width,height,data,this.textureConfig)},GPGPUContext.prototype.createFloat16PackedMatrixTexture=function(rows,columns){return this.throwIfDisposed(),gpgpu_util.createFloat16PackedMatrixTexture(this.gl,this.debug,rows,columns,this.textureConfig)},GPGPUContext.prototype.createPackedMatrixTexture=function(rows,columns){return this.throwIfDisposed(),gpgpu_util.createPackedMatrixTexture(this.gl,this.debug,rows,columns,this.textureConfig)},GPGPUContext.prototype.deleteMatrixTexture=function(texture){var _this=this;this.throwIfDisposed(),this.outputTexture===texture&&(webgl_util.unbindColorTextureFromFramebuffer(this.gl,this.debug,this.framebuffer),this.outputTexture=null),webgl_util.callAndCheck(this.gl,this.debug,function(){return _this.gl.deleteTexture(texture)})},GPGPUContext.prototype.downloadByteEncodedFloatMatrixFromOutputTexture=function(texture,rows,columns){var _this=this;return this.downloadMatrixDriver(texture,function(){return gpgpu_util.downloadByteEncodedFloatMatrixFromOutputTexture(_this.gl,_this.debug,rows,columns,_this.textureConfig)})},GPGPUContext.prototype.downloadPackedMatrixFromBuffer=function(buffer,batch,rows,columns,physicalRows,physicalCols){return gpgpu_util.downloadPackedMatrixFromBuffer(this.gl,buffer,batch,rows,columns,physicalRows,physicalCols,this.textureConfig)},GPGPUContext.prototype.downloadFloat32MatrixFromBuffer=function(buffer,size){return gpgpu_util.downloadFloat32MatrixFromBuffer(this.gl,buffer,size)},GPGPUContext.prototype.createBufferFromTexture=function(texture,rows,columns){this.bindTextureToFrameBuffer(texture);var result=gpgpu_util.createBufferFromOutputTexture(this.gl,this.debug,rows,columns,this.textureConfig);return this.unbindTextureToFrameBuffer(),result},GPGPUContext.prototype.createAndWaitForFence=function(){var fenceContext=this.createFence(this.gl);return this.pollFence(fenceContext)},GPGPUContext.prototype.createFence=function(gl){var query,isFencePassed,_this=this;if(environment_1.ENV.getBool("WEBGL_FENCE_API_ENABLED")){var gl2_1=gl,sync_1=gl2_1.fenceSync(gl2_1.SYNC_GPU_COMMANDS_COMPLETE,0);gl.flush(),isFencePassed=function(){var status=gl2_1.clientWaitSync(sync_1,0,0);return status===gl2_1.ALREADY_SIGNALED||status===gl2_1.CONDITION_SATISFIED},query=sync_1}else isFencePassed=0<environment_1.ENV.getNumber("WEBGL_DISJOINT_QUERY_TIMER_EXTENSION_VERSION")?(query=this.beginQuery(),this.endQuery(),function(){return _this.isQueryAvailable(query,environment_1.ENV.getNumber("WEBGL_DISJOINT_QUERY_TIMER_EXTENSION_VERSION"))}):function(){return!0};return{query:query,isFencePassed:isFencePassed}},GPGPUContext.prototype.downloadMatrixFromPackedTexture=function(texture,physicalRows,physicalCols){var _this=this;return this.downloadMatrixDriver(texture,function(){return gpgpu_util.downloadMatrixFromPackedOutputTexture(_this.gl,_this.debug,physicalRows,physicalCols)})},GPGPUContext.prototype.createProgram=function(fragmentShaderSource){this.throwIfDisposed();var gl=this.gl,fragmentShader=webgl_util.createFragmentShader(gl,this.debug,fragmentShaderSource),vertexShader=gpgpu_util.createVertexShader(gl,this.debug),program=webgl_util.createProgram(gl,this.debug);return webgl_util.callAndCheck(gl,this.debug,function(){return gl.attachShader(program,vertexShader)}),webgl_util.callAndCheck(gl,this.debug,function(){return gl.attachShader(program,fragmentShader)}),webgl_util.linkProgram(gl,this.debug,program),this.debug&&webgl_util.validateProgram(gl,this.debug,program),this.vertexAttrsAreBound||(this.setProgram(program),this.vertexAttrsAreBound=gpgpu_util.bindVertexProgramAttributeStreams(gl,this.debug,this.program,this.vertexBuffer)),program},GPGPUContext.prototype.deleteProgram=function(program){var _this=this;this.throwIfDisposed(),program===this.program&&(this.program=null),null!=program&&webgl_util.callAndCheck(this.gl,this.debug,function(){return _this.gl.deleteProgram(program)})},GPGPUContext.prototype.setProgram=function(program){var _this=this;this.throwIfDisposed(),this.program=program,null!=this.program&&this.debug&&webgl_util.validateProgram(this.gl,this.debug,this.program),webgl_util.callAndCheck(this.gl,this.debug,function(){return _this.gl.useProgram(program)})},GPGPUContext.prototype.getUniformLocation=function(program,uniformName,shouldThrow){return void 0===shouldThrow&&(shouldThrow=!0),this.throwIfDisposed(),shouldThrow?webgl_util.getProgramUniformLocationOrThrow(this.gl,this.debug,program,uniformName):webgl_util.getProgramUniformLocation(this.gl,program,uniformName)},GPGPUContext.prototype.getAttributeLocation=function(program,attribute){var _this=this;return this.throwIfDisposed(),webgl_util.callAndCheck(this.gl,this.debug,function(){return _this.gl.getAttribLocation(program,attribute)})},GPGPUContext.prototype.getUniformLocationNoThrow=function(program,uniformName){return this.throwIfDisposed(),this.gl.getUniformLocation(program,uniformName)},GPGPUContext.prototype.setInputMatrixTexture=function(inputMatrixTexture,uniformLocation,textureUnit){this.throwIfDisposed(),this.throwIfNoProgram(),webgl_util.bindTextureToProgramUniformSampler(this.gl,this.debug,this.program,inputMatrixTexture,uniformLocation,textureUnit)},GPGPUContext.prototype.setOutputMatrixTexture=function(outputMatrixTexture,rows,columns){this.setOutputMatrixTextureDriver(outputMatrixTexture,columns,rows)},GPGPUContext.prototype.setOutputPackedMatrixTexture=function(outputPackedMatrixTexture,rows,columns){this.throwIfDisposed();var _a=tex_util.getPackedMatrixTextureShapeWidthHeight(rows,columns),width=_a[0],height=_a[1];this.setOutputMatrixTextureDriver(outputPackedMatrixTexture,width,height)},GPGPUContext.prototype.setOutputMatrixWriteRegion=function(startRow,numRows,startColumn,numColumns){this.setOutputMatrixWriteRegionDriver(startColumn,startRow,numColumns,numRows)},GPGPUContext.prototype.setOutputPackedMatrixWriteRegion=function(startRow,numRows,startColumn,numColumns){throw new Error("setOutputPackedMatrixWriteRegion not implemented.")},GPGPUContext.prototype.debugValidate=function(){null!=this.program&&webgl_util.validateProgram(this.gl,this.debug,this.program),webgl_util.validateFramebuffer(this.gl)},GPGPUContext.prototype.executeProgram=function(){this.throwIfDisposed(),this.throwIfNoProgram();var gl=this.gl;this.debug&&this.debugValidate(),webgl_util.callAndCheck(gl,this.debug,function(){return gl.drawElements(gl.TRIANGLES,6,gl.UNSIGNED_SHORT,0)})},GPGPUContext.prototype.blockUntilAllProgramsCompleted=function(){var _this=this;this.throwIfDisposed(),webgl_util.callAndCheck(this.gl,this.debug,function(){return _this.gl.finish()})},GPGPUContext.prototype.getQueryTimerExtension=function(){return null==this.disjointQueryTimerExtension&&(this.disjointQueryTimerExtension=webgl_util.getExtensionOrThrow(this.gl,this.debug,2===environment_1.ENV.getNumber("WEBGL_DISJOINT_QUERY_TIMER_EXTENSION_VERSION")?"EXT_disjoint_timer_query_webgl2":"EXT_disjoint_timer_query")),this.disjointQueryTimerExtension},GPGPUContext.prototype.getQueryTimerExtensionWebGL2=function(){return this.getQueryTimerExtension()},GPGPUContext.prototype.getQueryTimerExtensionWebGL1=function(){return this.getQueryTimerExtension()},GPGPUContext.prototype.beginQuery=function(){if(2===environment_1.ENV.getNumber("WEBGL_DISJOINT_QUERY_TIMER_EXTENSION_VERSION")){var gl2=this.gl,ext_1=this.getQueryTimerExtensionWebGL2(),query_1=gl2.createQuery();return gl2.beginQuery(ext_1.TIME_ELAPSED_EXT,query_1),query_1}var ext=this.getQueryTimerExtensionWebGL1(),query=ext.createQueryEXT();return ext.beginQueryEXT(ext.TIME_ELAPSED_EXT,query),query},GPGPUContext.prototype.endQuery=function(){if(2!==environment_1.ENV.getNumber("WEBGL_DISJOINT_QUERY_TIMER_EXTENSION_VERSION")){var ext=this.getQueryTimerExtensionWebGL1();ext.endQueryEXT(ext.TIME_ELAPSED_EXT)}else{var gl2=this.gl,ext_2=this.getQueryTimerExtensionWebGL2();gl2.endQuery(ext_2.TIME_ELAPSED_EXT)}},GPGPUContext.prototype.waitForQueryAndGetTime=function(query){return __awaiter(this,void 0,void 0,function(){var _this=this;return __generator(this,function(_a){switch(_a.label){case 0:return[4,util.repeatedTry(function(){return _this.disposed||_this.isQueryAvailable(query,environment_1.ENV.getNumber("WEBGL_DISJOINT_QUERY_TIMER_EXTENSION_VERSION"))})];case 1:return _a.sent(),[2,this.getQueryTime(query,environment_1.ENV.getNumber("WEBGL_DISJOINT_QUERY_TIMER_EXTENSION_VERSION"))]}})})},GPGPUContext.prototype.getQueryTime=function(query,queryTimerVersion){if(0===queryTimerVersion)return null;if(2===queryTimerVersion){var gl2=this.gl;return gl2.getQueryParameter(query,gl2.QUERY_RESULT)/1e6}var ext=this.getQueryTimerExtensionWebGL1();return ext.getQueryObjectEXT(query,ext.QUERY_RESULT_EXT)/1e6},GPGPUContext.prototype.isQueryAvailable=function(query,queryTimerVersion){if(0===queryTimerVersion)return!0;if(2===queryTimerVersion){var gl2=this.gl,ext=this.getQueryTimerExtensionWebGL2(),available=gl2.getQueryParameter(query,gl2.QUERY_RESULT_AVAILABLE);return null==this.disjoint&&(this.disjoint=this.gl.getParameter(ext.GPU_DISJOINT_EXT)),available&&!this.disjoint}available=(ext=this.getQueryTimerExtensionWebGL1()).getQueryObjectEXT(query,ext.QUERY_RESULT_AVAILABLE_EXT);return null==this.disjoint&&(this.disjoint=this.gl.getParameter(ext.GPU_DISJOINT_EXT)),available&&!this.disjoint},GPGPUContext.prototype.pollFence=function(fenceContext){var _this=this;return new Promise(function(resolve){_this.addItemToPoll(function(){return fenceContext.isFencePassed()},function(){return resolve()})})},GPGPUContext.prototype.pollItems=function(){for(var index=linearSearchLastTrue(this.itemsToPoll.map(function(x){return x.isDoneFn})),i=0;i<=index;++i){(0,this.itemsToPoll[i].resolveFn)()}this.itemsToPoll=this.itemsToPoll.slice(index+1)},GPGPUContext.prototype.addItemToPoll=function(isDoneFn,resolveFn){var _this=this;this.itemsToPoll.push({isDoneFn:isDoneFn,resolveFn:resolveFn}),1<this.itemsToPoll.length||util.repeatedTry(function(){return _this.pollItems(),0===_this.itemsToPoll.length})},GPGPUContext.prototype.bindTextureToFrameBuffer=function(texture){this.throwIfDisposed(),webgl_util.bindColorTextureToFramebuffer(this.gl,this.debug,texture,this.framebuffer),this.debug&&webgl_util.validateFramebuffer(this.gl)},GPGPUContext.prototype.unbindTextureToFrameBuffer=function(){null!=this.outputTexture?(webgl_util.bindColorTextureToFramebuffer(this.gl,this.debug,this.outputTexture,this.framebuffer),this.debug&&webgl_util.validateFramebuffer(this.gl)):webgl_util.unbindColorTextureFromFramebuffer(this.gl,this.debug,this.framebuffer)},GPGPUContext.prototype.downloadMatrixDriver=function(texture,downloadAndDecode){this.bindTextureToFrameBuffer(texture);var result=downloadAndDecode();return this.unbindTextureToFrameBuffer(),result},GPGPUContext.prototype.setOutputMatrixTextureDriver=function(outputMatrixTextureMaybePacked,width,height){this.throwIfDisposed();var gl=this.gl;webgl_util.bindColorTextureToFramebuffer(gl,this.debug,outputMatrixTextureMaybePacked,this.framebuffer),this.debug&&webgl_util.validateFramebuffer(gl),this.outputTexture=outputMatrixTextureMaybePacked,webgl_util.callAndCheck(gl,this.debug,function(){return gl.viewport(0,0,width,height)}),webgl_util.callAndCheck(gl,this.debug,function(){return gl.scissor(0,0,width,height)})},GPGPUContext.prototype.setOutputMatrixWriteRegionDriver=function(x,y,width,height){var _this=this;this.throwIfDisposed(),webgl_util.callAndCheck(this.gl,this.debug,function(){return _this.gl.scissor(x,y,width,height)})},GPGPUContext.prototype.throwIfDisposed=function(){if(this.disposed)throw new Error("Attempted to use disposed GPGPUContext.")},GPGPUContext.prototype.throwIfNoProgram=function(){if(null==this.program)throw new Error("No GPU program is currently set.")},GPGPUContext}();function linearSearchLastTrue(arr){for(var i=0;i<arr.length;++i){if(!arr[i]())break}return i-1}exports.GPGPUContext=GPGPUContext,exports.linearSearchLastTrue=linearSearchLastTrue},{"../../environment":144,"../../util":241,"./canvas_util":70,"./gpgpu_util":101,"./tex_util":131,"./webgl_util":139}],100:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var environment_1=require("../../environment"),util=require("../../util"),shader_compiler=require("./shader_compiler");function validateBinaryAndProgram(shapeInfos,inputs){if(shapeInfos.length!==inputs.length)throw Error("Binary was compiled with "+shapeInfos.length+" inputs, but was executed with "+inputs.length+" inputs");shapeInfos.forEach(function(s,i){var shapeA=s.logicalShape,input=inputs[i],shapeB=input.shape;if(!util.arraysEqual(shapeA,shapeB))throw Error("Binary was compiled with different shapes than the current args. Shapes "+shapeA+" and "+shapeB+" must match");if(!s.isUniform||!input.isUniform){var texShapeA=s.texShape,texShapeB=input.isUniform?null:input.texData.texShape;if(!util.arraysEqual(texShapeA,texShapeB))throw Error("Binary was compiled with different texture shapes than the current args. Shape "+texShapeA+" and "+texShapeB+" must match")}})}exports.compileProgram=function(gpgpu,program,inputs,output){var userCode=program.userCode,inputInfos=inputs.map(function(input,i){var shapeInfo={logicalShape:input.shape,texShape:input.isUniform?null:input.texData.texShape,isUniform:input.isUniform,isPacked:!input.isUniform&&input.texData.isPacked,flatOffset:null};return null!=input.texData&&null!=input.texData.slice&&0<input.texData.slice.flatOffset&&(shapeInfo.flatOffset=input.texData.slice.flatOffset),{name:program.variableNames[i],shapeInfo:shapeInfo}}),inShapeInfos=inputInfos.map(function(x){return x.shapeInfo}),outShapeInfo={logicalShape:output.shape,texShape:output.texData.texShape,isUniform:!1,isPacked:output.texData.isPacked,flatOffset:null},source=shader_compiler.makeShader(inputInfos,outShapeInfo,userCode,program.usesPackedTextures),webGLProgram=gpgpu.createProgram(source),infLoc=null,nanLoc=gpgpu.getUniformLocation(webGLProgram,"NAN",!1);1===environment_1.ENV.getNumber("WEBGL_VERSION")&&(infLoc=gpgpu.getUniformLocation(webGLProgram,"INFINITY",!1));for(var uniformLocations={},i=0;i<program.variableNames.length;i++){var varName=program.variableNames[i];uniformLocations[varName]=gpgpu.getUniformLocation(webGLProgram,varName,!1),uniformLocations["offset"+varName]=gpgpu.getUniformLocation(webGLProgram,"offset"+varName,!1)}return{program:program,source:source,webGLProgram:webGLProgram,uniformLocations:uniformLocations,inShapeInfos:inShapeInfos,outShapeInfo:outShapeInfo,infLoc:infLoc,nanLoc:nanLoc}},exports.runProgram=function(gpgpu,binary,inputs,output,customSetup){validateBinaryAndProgram(binary.inShapeInfos,inputs),validateBinaryAndProgram([binary.outShapeInfo],[output]);var outTex=output.texData.texture,outTexShape=output.texData.texShape;output.texData.isPacked?gpgpu.setOutputPackedMatrixTexture(outTex,outTexShape[0],outTexShape[1]):gpgpu.setOutputMatrixTexture(outTex,outTexShape[0],outTexShape[1]),gpgpu.setProgram(binary.webGLProgram),1===environment_1.ENV.getNumber("WEBGL_VERSION")&&null!==binary.infLoc&&gpgpu.gl.uniform1f(binary.infLoc,1/0),null!==binary.nanLoc&&gpgpu.gl.uniform1f(binary.nanLoc,NaN),inputs.forEach(function(input,i){var varName=binary.program.variableNames[i],varLoc=binary.uniformLocations[varName],varOffsetLoc=binary.uniformLocations["offset"+varName];if(null!=varLoc)if(input.isUniform)if(util.sizeFromShape(input.shape)<2)gpgpu.gl.uniform1f(varLoc,input.uniformValues[0]);else{var vals=input.uniformValues;vals instanceof Float32Array||(vals=new Float32Array(vals)),gpgpu.gl.uniform1fv(varLoc,vals)}else null!=input.texData.slice&&null!=varOffsetLoc&&gpgpu.gl.uniform1i(varOffsetLoc,input.texData.slice.flatOffset),gpgpu.setInputMatrixTexture(input.texData.texture,varLoc,i)}),null!=customSetup&&customSetup(gpgpu,binary.webGLProgram),gpgpu.executeProgram()},exports.makeShaderKey=function(program,inputs,output){var keyInputs="";inputs.concat(output).forEach(function(x){var hasOffset=null!=x.texData&&null!=x.texData.slice&&0<x.texData.slice.flatOffset,texShape=x.isUniform?"uniform":x.texData.texShape;keyInputs+=x.shape+"_"+texShape+"_"+hasOffset});var keyUserCode=program.userCode,key=program.constructor.name;return key+="_"+keyInputs+"_"+keyUserCode}},{"../../environment":144,"../../util":241,"./shader_compiler":126}],101:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var glsl_version_1=require("./glsl_version"),tex_util=require("./tex_util"),webgl_util=require("./webgl_util");function createAndConfigureTexture(gl,debug,width,height,internalFormat,textureFormat,textureType){webgl_util.validateTextureSize(width,height);var texture=webgl_util.createTexture(gl,debug),tex2d=gl.TEXTURE_2D;return webgl_util.callAndCheck(gl,debug,function(){return gl.bindTexture(tex2d,texture)}),webgl_util.callAndCheck(gl,debug,function(){return gl.texParameteri(tex2d,gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE)}),webgl_util.callAndCheck(gl,debug,function(){return gl.texParameteri(tex2d,gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE)}),webgl_util.callAndCheck(gl,debug,function(){return gl.texParameteri(tex2d,gl.TEXTURE_MIN_FILTER,gl.NEAREST)}),webgl_util.callAndCheck(gl,debug,function(){return gl.texParameteri(tex2d,gl.TEXTURE_MAG_FILTER,gl.NEAREST)}),webgl_util.callAndCheck(gl,debug,function(){return gl.texImage2D(tex2d,0,internalFormat,width,height,0,textureFormat,textureType,null)}),webgl_util.callAndCheck(gl,debug,function(){return gl.bindTexture(gl.TEXTURE_2D,null)}),texture}exports.createVertexShader=function(gl,debug){var glsl=glsl_version_1.getGlslDifferences(),vertexShaderSource=glsl.version+"\n    precision highp float;\n    "+glsl.attribute+" vec3 clipSpacePos;\n    "+glsl.attribute+" vec2 uv;\n    "+glsl.varyingVs+" vec2 resultUV;\n\n    void main() {\n      gl_Position = vec4(clipSpacePos, 1);\n      resultUV = uv;\n    }";return webgl_util.createVertexShader(gl,debug,vertexShaderSource)},exports.createVertexBuffer=function(gl,debug){var vertexArray=new Float32Array([-1,1,0,0,1,-1,-1,0,0,0,1,1,0,1,1,1,-1,0,1,0]);return webgl_util.createStaticVertexBuffer(gl,debug,vertexArray)},exports.createIndexBuffer=function(gl,debug){var triangleVertexIndices=new Uint16Array([0,1,2,2,1,3]);return webgl_util.createStaticIndexBuffer(gl,debug,triangleVertexIndices)},exports.createFloat32MatrixTexture=function(gl,debug,rows,columns,textureConfig){var _a=tex_util.getUnpackedMatrixTextureShapeWidthHeight(rows,columns);return createAndConfigureTexture(gl,debug,_a[0],_a[1],textureConfig.internalFormatFloat,textureConfig.textureFormatFloat,gl.FLOAT)},exports.createFloat16MatrixTexture=function(gl,debug,rows,columns,textureConfig){var _a=tex_util.getUnpackedMatrixTextureShapeWidthHeight(rows,columns);return createAndConfigureTexture(gl,debug,_a[0],_a[1],textureConfig.internalFormatHalfFloat,textureConfig.textureFormatFloat,textureConfig.textureTypeHalfFloat)},exports.createUnsignedBytesMatrixTexture=function(gl,debug,rows,columns,textureConfig){var _a=tex_util.getUnpackedMatrixTextureShapeWidthHeight(rows,columns);return createAndConfigureTexture(gl,debug,_a[0],_a[1],gl.RGBA,gl.RGBA,gl.UNSIGNED_BYTE)},exports.createPackedMatrixTexture=function(gl,debug,rows,columns,textureConfig){var _a=tex_util.getPackedMatrixTextureShapeWidthHeight(rows,columns);return createAndConfigureTexture(gl,debug,_a[0],_a[1],textureConfig.internalFormatPackedFloat,gl.RGBA,gl.FLOAT)},exports.createFloat16PackedMatrixTexture=function(gl,debug,rows,columns,textureConfig){var _a=tex_util.getPackedMatrixTextureShapeWidthHeight(rows,columns);return createAndConfigureTexture(gl,debug,_a[0],_a[1],textureConfig.internalFormatPackedHalfFloat,gl.RGBA,textureConfig.textureTypeHalfFloat)},exports.bindVertexProgramAttributeStreams=function(gl,debug,program,vertexBuffer){return webgl_util.callAndCheck(gl,debug,function(){return gl.bindBuffer(gl.ARRAY_BUFFER,vertexBuffer)}),webgl_util.bindVertexBufferToProgramAttribute(gl,debug,program,"clipSpacePos",vertexBuffer,3,20,0)&&webgl_util.bindVertexBufferToProgramAttribute(gl,debug,program,"uv",vertexBuffer,2,20,12)},exports.uploadDenseMatrixToTexture=function(gl,debug,texture,width,height,data,textureConfig){var dataForUpload,texelDataType,internalFormat;webgl_util.callAndCheck(gl,debug,function(){return gl.bindTexture(gl.TEXTURE_2D,texture)}),internalFormat=data instanceof Uint8Array?(dataForUpload=new Uint8Array(width*height*4),texelDataType=gl.UNSIGNED_BYTE,gl.RGBA):(dataForUpload=new Float32Array(width*height*4),texelDataType=gl.FLOAT,textureConfig.internalFormatPackedFloat),dataForUpload.set(data),webgl_util.callAndCheck(gl,debug,function(){return gl.texImage2D(gl.TEXTURE_2D,0,internalFormat,width,height,0,gl.RGBA,texelDataType,dataForUpload)}),webgl_util.callAndCheck(gl,debug,function(){return gl.bindTexture(gl.TEXTURE_2D,null)})},exports.uploadPixelDataToTexture=function(gl,debug,texture,pixels){webgl_util.callAndCheck(gl,debug,function(){return gl.bindTexture(gl.TEXTURE_2D,texture)}),pixels.data instanceof Uint8Array?webgl_util.callAndCheck(gl,debug,function(){return gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,pixels.width,pixels.height,0,gl.RGBA,gl.UNSIGNED_BYTE,pixels.data)}):webgl_util.callAndCheck(gl,debug,function(){return gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,gl.RGBA,gl.UNSIGNED_BYTE,pixels)}),webgl_util.callAndCheck(gl,debug,function(){return gl.bindTexture(gl.TEXTURE_2D,null)})},exports.createBufferFromOutputTexture=function(gl2,debug,rows,columns,textureConfig){var buffer=gl2.createBuffer();webgl_util.callAndCheck(gl2,debug,function(){return gl2.bindBuffer(gl2.PIXEL_PACK_BUFFER,buffer)});var bufferSizeBytes=16*rows*columns;return webgl_util.callAndCheck(gl2,debug,function(){return gl2.bufferData(gl2.PIXEL_PACK_BUFFER,bufferSizeBytes,gl2.STREAM_READ)}),webgl_util.callAndCheck(gl2,debug,function(){return gl2.readPixels(0,0,columns,rows,gl2.RGBA,gl2.FLOAT,0)}),webgl_util.callAndCheck(gl2,debug,function(){return gl2.bindBuffer(gl2.PIXEL_PACK_BUFFER,null)}),buffer},exports.downloadFloat32MatrixFromBuffer=function(gl,buffer,size){var gl2=gl,downloadTarget=new Float32Array(size);return gl2.bindBuffer(gl2.PIXEL_PACK_BUFFER,buffer),gl2.getBufferSubData(gl2.PIXEL_PACK_BUFFER,0,downloadTarget),gl2.bindBuffer(gl2.PIXEL_PACK_BUFFER,null),downloadTarget},exports.downloadByteEncodedFloatMatrixFromOutputTexture=function(gl,debug,rows,columns,textureConfig){var _a=tex_util.getUnpackedMatrixTextureShapeWidthHeight(rows,columns),w=_a[0],h=_a[1],downloadTarget=new Uint8Array(tex_util.getUnpackedArraySizeFromMatrixSize(rows*columns,4));return webgl_util.callAndCheck(gl,debug,function(){return gl.readPixels(0,0,w,h,textureConfig.downloadTextureFormat,gl.UNSIGNED_BYTE,downloadTarget)}),new Float32Array(downloadTarget.buffer)},exports.downloadPackedMatrixFromBuffer=function(gl,buffer,batch,rows,cols,physicalRows,physicalCols,textureConfig){var gl2=gl,downloadTarget=new Float32Array(tex_util.getPackedRGBAArraySizeFromMatrixShape(physicalRows,physicalCols));return gl2.bindBuffer(gl2.PIXEL_PACK_BUFFER,buffer),gl2.getBufferSubData(gl2.PIXEL_PACK_BUFFER,0,downloadTarget),gl2.bindBuffer(gl2.PIXEL_PACK_BUFFER,null),downloadTarget},exports.downloadMatrixFromPackedOutputTexture=function(gl,debug,physicalRows,physicalCols){var packedRGBA=new Float32Array(physicalRows*physicalCols*4);return webgl_util.callAndCheck(gl,debug,function(){return gl.readPixels(0,0,physicalCols,physicalRows,gl.RGBA,gl.FLOAT,packedRGBA)}),packedRGBA}},{"./glsl_version":98,"./tex_util":131,"./webgl_util":139}],102:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});function Im2ColPackedProgram(outputShape,inputShape,convInfo){this.variableNames=["A"],this.usesPackedTextures=!0,this.outputShape=outputShape;for(var filterWidth=convInfo.filterWidth,inChannels=convInfo.inChannels,strideWidth=convInfo.strideWidth,strideHeight=convInfo.strideHeight,padInfo=convInfo.padInfo,outWidth=convInfo.outWidth,dilationWidth=convInfo.dilationWidth,dilationHeight=convInfo.dilationHeight,dataFormat=convInfo.dataFormat,left=padInfo.left,top=padInfo.top,itemsPerBlockRow=inChannels*filterWidth,glsl=glsl_version_1.getGlslDifferences(),isChannelsLast="channelsLast"===dataFormat,rowDim=isChannelsLast?0:1,colDim=isChannelsLast?1:2,unrolled="",row=0;row<=1;row++)for(var col=0;col<=1;col++)unrolled+="\n          blockIndex = rc.y + "+col+";\n          pos = rc.x + "+row+";\n\n          if(blockIndex < "+outputShape[1]+" && pos < "+outputShape[0]+") {\n            offsetY = int(blockIndex / ("+outWidth+")) * "+strideHeight+" - "+top+";\n            d0 = offsetY + "+dilationHeight+" * (pos / "+itemsPerBlockRow+");\n\n            if(d0 < "+inputShape[rowDim]+" && d0 >= 0) {\n\n              offsetX = int(mod(float(blockIndex), "+outWidth+".) * "+strideWidth+". - "+left+".);\n              d1 = offsetX + "+dilationWidth+" * (int(mod(float(pos), "+itemsPerBlockRow+".) / "+inChannels+".));\n\n              if(d1 < "+inputShape[colDim]+" && d1 >= 0) {\n\n                ch = int(mod(float(pos), "+inChannels+".));\n\n                if ("+isChannelsLast+") {\n                  innerDims = vec2(d1, ch);\n                  result["+(2*row+col)+"] = getChannel(\n                    getA(d0, int(innerDims.x),\n                    int(innerDims.y)), innerDims);\n                } else {\n                  innerDims = vec2(d0, d1);\n                  result["+(2*row+col)+"] = getChannel(\n                    getA(ch, int(innerDims.x),\n                    int(innerDims.y)), innerDims);\n                }\n              }\n            }\n          }\n        ";this.userCode="\n      void main() {\n        ivec2 rc = getOutputCoords();\n\n        vec4 result = vec4(0);\n\n        int blockIndex, pos, offsetY, d0, offsetX, d1, ch;\n        vec2 innerDims;\n\n        "+unrolled+"\n\n        "+glsl.output+" = result;\n      }\n    "}var glsl_version_1=require("./glsl_version");exports.Im2ColPackedProgram=Im2ColPackedProgram},{"./glsl_version":98}],103:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});function LRNProgram(xShape,radius,bias,alpha,beta){this.variableNames=["x"],this.outputShape=[];var powOperator,rad=radius,maxD=xShape[3]-1;this.outputShape=xShape;var basis="float("+bias+") + float("+alpha+") * sum";powOperator=.5===beta?"inversesqrt("+basis+")":1===beta?"1.0/("+basis+")":"exp(log("+basis+") * float(-"+beta+"));",this.userCode="\n      void main() {\n        ivec4 coords = getOutputCoords();\n        int b = coords[0];\n        int r = coords[1];\n        int c = coords[2];\n        int d = coords[3];\n        float x = getX(b, r, c, d);\n        float sum = 0.0;\n        for (int j = -"+rad+"; j <= "+rad+"; j++) {\n          int idx = d + j;\n          if (idx >= 0 && idx <=  "+maxD+") {\n            float z = getX(b, r, c, idx);\n            sum += z * z;\n          }\n        }\n        float val = x * "+powOperator+";\n        setOutput(val);\n      }\n    "}exports.LRNProgram=LRNProgram},{}],104:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});function LRNGradProgram(inputShape,depthRadius,bias,alpha,beta){this.variableNames=["inputImage","outputImage","dy"],this.outputShape=[],this.outputShape=inputShape,this.depth=inputShape[3],this.depthRadius=depthRadius,this.bias=bias,this.alpha=alpha,this.beta=beta,this.userCode="\n      void main() {\n        ivec4 coords = getOutputCoords();\n        int b = coords[0];\n        int r = coords[1];\n        int c = coords[2];\n\n        float result = 0.0;\n        for (int d = 0; d < "+this.depth+"; ++d) {\n          int depthBegin = int(max(0.0, float(d - "+depthRadius+")));\n          int depthEnd = int(min(float("+this.depth+"),\n              float(d + "+depthRadius+" + 1)));\n\n          const int MIN_DEPTH_BEGIN = 0;\n          const int MAX_DEPTH_END = "+this.depth+";\n\n          float norm = 0.0;\n          for (int k = MIN_DEPTH_BEGIN; k < MAX_DEPTH_END; ++k) {\n            if (k < depthBegin){\n              continue;\n            }\n            else if (k >= depthBegin && k < depthEnd) {\n              norm += getInputImage(b, r, c, k) * getInputImage(b, r, c, k);\n            }\n            else {\n              break;\n            }\n          }\n\n          norm = float("+alpha+") * norm + float("+bias+");\n\n          for(int k = MIN_DEPTH_BEGIN; k < MAX_DEPTH_END; ++k){\n            if (k < depthBegin){\n              continue;\n            }\n            else if (k >= depthBegin && k < depthEnd){\n              float dyi = -2.0 * float("+alpha+")\n                * float("+beta+")\n                * getInputImage(b ,r ,c, k) * getOutputImage(b, r, c, d)\n                / norm;\n              if (k == d) {\n                dyi += pow(norm, -1.0 * "+beta+");\n              }\n              if (k == coords[3]) {\n                dyi *= getDy(b, r, c, d);\n                result += dyi;\n              }\n            }\n            else {\n              break;\n            }\n          }\n      }\n      setOutput(result);\n      }\n    "}exports.LRNGradProgram=LRNGradProgram},{}],105:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});function LRNPackedProgram(xShape,radius,bias,alpha,beta){this.variableNames=["x"],this.outputShape=[],this.usesPackedTextures=!0;var powOperator,rad=radius,maxD=xShape[3]-1;this.outputShape=xShape;var basis="float("+bias+") + float("+alpha+") * sum";powOperator=.5===beta?"inversesqrt("+basis+")":1===beta?"1.0/("+basis+")":"exp(log("+basis+") * float(-"+beta+"));",this.userCode="\n      void main() {\n        ivec4 coords = getOutputCoords();\n        int b = coords.x;\n        int r = coords.y;\n        int c = coords.z;\n        int d = coords.w;\n\n        bool hasNextCol = d < "+this.outputShape[3]+";\n        bool hasNextRow = c < "+this.outputShape[2]+";\n\n        vec4 sum = vec4(0.);\n        vec4 xFragAtOutputCoords = getX(b, r, c, d);\n\n        vec4 xAtOutputCoords = vec4(\n          getChannel(xFragAtOutputCoords, vec2(c, d)),\n          hasNextCol ?\n            getChannel(xFragAtOutputCoords, vec2(c, d + 1)) : 0.0,\n          hasNextRow ?\n            getChannel(xFragAtOutputCoords , vec2(c + 1, d)) : 0.0,\n          (hasNextRow && hasNextCol) ?\n            getChannel(xFragAtOutputCoords, vec2(c + 1, d + 1)) : 0.0\n        );\n\n        int firstChannel = d - "+rad+";\n        vec2 cache = vec2(0.);\n        if(firstChannel >= 0){\n          vec4 firstChannelFrag = getX(b, r, c, firstChannel);\n          cache.x = getChannel(firstChannelFrag, vec2(c, firstChannel));\n            if(hasNextRow){\n              cache.y = getChannel(firstChannelFrag, vec2(c + 1, firstChannel));\n            }\n        }\n\n        ivec2 depth = ivec2(d, d + 1);\n        for (int j = - "+rad+"; j <= "+rad+"; j++) {\n          ivec2 idx = depth + j;\n          bvec2 aboveLowerBound = greaterThanEqual(idx, ivec2(0));\n          bvec2 belowUpperBound = lessThanEqual(idx, ivec2("+maxD+"));\n\n          bool depthInRange = aboveLowerBound.x && belowUpperBound.x;\n          bool depthPlusOneInRange = aboveLowerBound.y && belowUpperBound.y;\n\n          if(depthInRange || depthPlusOneInRange){\n            vec4 z = vec4(0.);\n            vec4 xFragAtCurrentDepth;\n            z.xz = cache.xy;\n            if(depthPlusOneInRange && hasNextCol){\n              xFragAtCurrentDepth = idx.y != d ?\n                getX(b, r, c, idx.y) : xFragAtOutputCoords;\n              z.y = getChannel(xFragAtCurrentDepth, vec2(c, idx.y));\n              if(hasNextRow){\n                z.w = getChannel(xFragAtCurrentDepth, vec2(c + 1, idx.y));\n              }\n            }\n            cache.xy = z.yw;\n            sum += z * z;\n          }\n        }\n        vec4 result = xAtOutputCoords * "+powOperator+";\n        setOutput(result);\n      }\n    "}exports.LRNPackedProgram=LRNPackedProgram},{}],106:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});function MaxPool2DBackpropProgram(convInfo){this.variableNames=["dy","maxPos"],this.outputShape=convInfo.inShape;var strideHeight=convInfo.strideHeight,strideWidth=convInfo.strideWidth,dilationHeight=convInfo.dilationHeight,effectiveFilterHeight=convInfo.effectiveFilterHeight,effectiveFilterWidth=convInfo.effectiveFilterWidth,padTop=effectiveFilterHeight-1-convInfo.padInfo.top,padLeft=effectiveFilterWidth-1-convInfo.padInfo.left,lastIndex=effectiveFilterHeight*effectiveFilterWidth-1;this.userCode="\n      const ivec2 pads = ivec2("+padTop+", "+padLeft+");\n\n      void main() {\n        ivec4 coords = getOutputCoords();\n        int b = coords[0];\n        int d = coords[3];\n\n        ivec2 dyRCCorner = coords.yz - pads;\n        int dyRCorner = dyRCCorner.x;\n        int dyCCorner = dyRCCorner.y;\n\n        // Convolve dy(?, ?, d) with pos mask(:, :, d) to get dx(xR, xC, d).\n        // ? = to be determined. : = across all values in that axis.\n        float dotProd = 0.0;\n        for (int wR = 0; wR < "+effectiveFilterHeight+";\n          wR += "+dilationHeight+") {\n          float dyR = float(dyRCorner + wR) / "+strideHeight+".0;\n\n          if (dyR < 0.0 || dyR >= "+convInfo.outHeight+".0 || fract(dyR) > 0.0) {\n            continue;\n          }\n          int idyR = int(dyR);\n\n          for (int wC = 0; wC < "+effectiveFilterWidth+"; wC++) {\n            float dyC = float(dyCCorner + wC) / "+strideWidth+".0;\n\n            if (dyC < 0.0 || dyC >= "+convInfo.outWidth+".0 ||\n                fract(dyC) > 0.0) {\n              continue;\n            }\n            int idyC = int(dyC);\n\n            float dyValue = getDy(b, idyR, idyC, d);\n            int maxPosValue = "+lastIndex+" - int(getMaxPos(b, idyR, idyC, d));\n\n            // Get the current value, check it against the value from the\n            // position matrix.\n            int curPosValue = wR * "+effectiveFilterWidth+" + wC;\n            float mask = float(maxPosValue == curPosValue ? 1.0 : 0.0);\n\n            dotProd += dyValue * mask;\n          }\n        }\n        setOutput(dotProd);\n      }\n    "}exports.MaxPool2DBackpropProgram=MaxPool2DBackpropProgram;function MaxPool3DBackpropProgram(convInfo){this.variableNames=["dy","maxPos"],this.outputShape=convInfo.inShape;var strideDepth=convInfo.strideDepth,strideHeight=convInfo.strideHeight,strideWidth=convInfo.strideWidth,dilationDepth=convInfo.dilationDepth,dilationHeight=convInfo.dilationHeight,dilationWidth=convInfo.dilationWidth,effectiveFilterDepth=convInfo.effectiveFilterDepth,effectiveFilterHeight=convInfo.effectiveFilterHeight,effectiveFilterWidth=convInfo.effectiveFilterWidth,padFront=effectiveFilterDepth-1-convInfo.padInfo.front,padTop=effectiveFilterHeight-1-convInfo.padInfo.top,padLeft=effectiveFilterWidth-1-convInfo.padInfo.left,lastIndex=effectiveFilterDepth*effectiveFilterHeight*effectiveFilterWidth-1;this.userCode="\n      const ivec3 pads = ivec3("+padFront+", "+padTop+", "+padLeft+");\n\n      void main() {\n        ivec5 coords = getOutputCoords();\n        int batch = coords.x;\n        int ch = coords.u;\n\n        ivec3 dyCorner = ivec3(coords.y, coords.z, coords.w) - pads;\n        int dyDCorner = dyCorner.x;\n        int dyRCorner = dyCorner.y;\n        int dyCCorner = dyCorner.z;\n\n        // Convolve dy(?, ?, ?, ch) with pos mask(:, :, :, d) to get\n        // dx(xD, xR, xC, ch).\n        // ? = to be determined. : = across all values in that axis.\n        float dotProd = 0.0;\n\n        for (int wD = 0; wD < "+effectiveFilterDepth+";\n           wD += "+dilationDepth+") {\n          float dyD = float(dyDCorner + wD) / "+strideDepth+".0;\n\n          if (dyD < 0.0 || dyD >= "+convInfo.outDepth+".0 || fract(dyD) > 0.0) {\n            continue;\n          }\n          int idyD = int(dyD);\n\n          for (int wR = 0; wR < "+effectiveFilterHeight+";\n              wR += "+dilationHeight+") {\n            float dyR = float(dyRCorner + wR) / "+strideHeight+".0;\n\n            if (dyR < 0.0 || dyR >= "+convInfo.outHeight+".0 ||\n                fract(dyR) > 0.0) {\n              continue;\n            }\n            int idyR = int(dyR);\n\n            for (int wC = 0; wC < "+effectiveFilterWidth+";\n                wC += "+dilationWidth+") {\n              float dyC = float(dyCCorner + wC) / "+strideWidth+".0;\n\n              if (dyC < 0.0 || dyC >= "+convInfo.outWidth+".0 ||\n                  fract(dyC) > 0.0) {\n                continue;\n              }\n              int idyC = int(dyC);\n\n              float dyValue = getDy(batch, idyD, idyR, idyC, ch);\n              int maxPosValue = "+lastIndex+" -\n                  int(getMaxPos(batch, idyD, idyR, idyC, ch));\n\n              // Get the current value, check it against the value from the\n              // position matrix.\n              int curPosValue =\n                  wD * "+effectiveFilterHeight+" * "+effectiveFilterWidth+" +\n                  wR * "+effectiveFilterWidth+" + wC;\n              float mask = float(maxPosValue == curPosValue ? 1.0 : 0.0);\n\n              dotProd += dyValue * mask;\n            }\n          }\n        }\n        setOutput(dotProd);\n      }\n    "}exports.MaxPool3DBackpropProgram=MaxPool3DBackpropProgram},{}],107:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});function MatMulPackedProgram(aShape,outputShape,transposeA,transposeB,addBias,activation,hasPreluActivation){void 0===transposeA&&(transposeA=!1),void 0===transposeB&&(transposeB=!1),void 0===addBias&&(addBias=!1),void 0===activation&&(activation=null),void 0===hasPreluActivation&&(hasPreluActivation=!1),this.variableNames=["matrixA","matrixB"],this.usesPackedTextures=!0,this.outputShape=outputShape;var sharedDim=transposeA?aShape[1]:aShape[2],sharedDimensionPacked=Math.ceil(sharedDim/2),aSample=transposeA?"i * 2, rc.y":"rc.y, i * 2",bSample=transposeB?"rc.z, i * 2":"i * 2, rc.z",aSwizzle=transposeA?["a.xxyy","a.zzww"]:["a.xxzz","a.yyww"],bSwizzle=transposeB?["b.xzxz","b.ywyw"]:["b.xyxy","b.zwzw"],activationSnippet="",applyActivationSnippet="";activation&&(activationSnippet=hasPreluActivation?"vec4 activation(vec4 a) {\n          vec4 b = getPreluActivationWeightsAtOutCoords();\n          "+activation+"\n        }":"vec4 activation(vec4 x) {\n          "+activation+"\n        }",applyActivationSnippet="result = activation(result);");var addBiasSnippet=addBias?"result += getBiasAtOutCoords();":"";addBias&&this.variableNames.push("bias"),hasPreluActivation&&this.variableNames.push("preluActivationWeights"),this.userCode="\n      "+activationSnippet+"\n\n      const float sharedDimension = "+sharedDimensionPacked+".0;\n\n      vec4 dot2x2ARowBCol(ivec3 rc) {\n        vec4 result = vec4(0);\n        for (int i = 0; i < "+sharedDimensionPacked+"; i++) {\n          vec4 a = getMatrixA(rc.x, "+aSample+");\n          vec4 b = getMatrixB(rc.x, "+bSample+");\n\n          // These swizzled products need to be separately added.\n          // See: https://github.com/tensorflow/tfjs/issues/1735\n          result += ("+aSwizzle[0]+" * "+bSwizzle[0]+");\n          result += ("+aSwizzle[1]+" * "+bSwizzle[1]+");\n        }\n        return result;\n      }\n\n      void main() {\n        ivec3 rc = getOutputCoords();\n        vec4 result = dot2x2ARowBCol(rc);\n\n        "+addBiasSnippet+"\n\n        "+applyActivationSnippet+"\n\n        setOutput(result);\n      }\n    "}exports.MatMulPackedProgram=MatMulPackedProgram},{}],108:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var MultinomialProgram=function(){function MultinomialProgram(batchSize,numOutcomes,numSamples){this.variableNames=["probs"],this.outputShape=[batchSize,numSamples],this.userCode="\n      uniform float seed;\n\n      void main() {\n        ivec2 coords = getOutputCoords();\n        int batch = coords[0];\n\n        float r = random(seed);\n        float cdf = 0.0;\n\n        for (int i = 0; i < "+(numOutcomes-1)+"; i++) {\n          cdf += getProbs(batch, i);\n\n          if (r < cdf) {\n            setOutput(float(i));\n            return;\n          }\n        }\n\n        // If no other event happened, last event happened.\n        setOutput(float("+(numOutcomes-1)+"));\n      }\n    "}return MultinomialProgram.prototype.getCustomSetupFunc=function(seed){var _this=this;return function(gpgpu,webGLProgram){null==_this.seedLoc&&(_this.seedLoc=gpgpu.getUniformLocation(webGLProgram,"seed")),gpgpu.gl.uniform1f(_this.seedLoc,seed)}},MultinomialProgram}();exports.MultinomialProgram=MultinomialProgram},{}],109:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});function OneHotProgram(numIndices,depth,onValue,offValue){this.variableNames=["indices"],this.outputShape=[numIndices,depth],this.userCode="\n      void main() {\n        ivec2 coords = getOutputCoords();\n        int index = round(getIndices(coords.x));\n        setOutput(mix(float("+offValue+"), float("+onValue+"),\n                      float(index == coords.y)));\n      }\n    "}exports.OneHotProgram=OneHotProgram},{}],110:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});function PackProgram(outputShape){this.variableNames=["A"];var rank=(this.outputShape=outputShape).length;if(0===rank)this.userCode="\n        void main() {\n          setOutput(vec4(getA(), 0., 0., 0.));\n        }\n      ";else{var channels=packing_util_1.getChannels("rc",rank),dtype=shader_compiler_1.getCoordsDataType(rank),outOfBoundsCondition=function(rank,shape,dims){if(1===rank)return"rc > "+shape[0];for(var cond="",i=rank-2;i<rank;i++)cond+=dims[i]+" >= "+shape[i],i<rank-1&&(cond+="||");return cond}(rank,outputShape,channels),setup=function(rank,cols,rows,dims){if(1===rank)return"";var innerDims=dims.slice(-2);return"\n    int r = "+innerDims[0]+";\n    int c = "+innerDims[1]+";\n    int rp1 = r + 1;\n    int cp1 = c + 1;\n\n    bool cEdge = cp1 >= "+cols+";\n    bool rEdge = rp1 >= "+rows+";\n  "}(rank,outputShape[outputShape.length-1],outputShape[outputShape.length-2],channels),output=function(shape,dims){var rank=shape.length,sourceCoords=function(rank,dims){for(var coords=[],row=0;row<=1;row++)for(var col=0;col<=1;col++){for(var coord=(0===row?"r":"rp1")+", "+(0===col?"c":"cp1"),d=2;d<rank;d++)coord=dims[dims.length-1-d]+","+coord;coords.push(coord)}return coords}(rank,dims);return 1!==rank?"getA("+sourceCoords[0]+"),\n          cEdge ? 0. : getA("+sourceCoords[1]+"),\n          rEdge ? 0. : getA("+sourceCoords[2]+"),\n          rEdge || cEdge ? 0. : getA("+sourceCoords[3]+")":"getA(rc),\n            rc + 1 >= "+shape[0]+" ? 0. : getA(rc + 1),\n            0, 0"}(outputShape,channels);this.userCode="\n        void main() {\n          "+dtype+" rc = getOutputCoords();\n\n          if("+outOfBoundsCondition+") {\n            setOutput(vec4(0));\n          } else {\n            "+setup+"\n\n            setOutput(vec4("+output+"));\n          }\n        }\n      "}}var packing_util_1=require("../packing_util"),shader_compiler_1=require("./shader_compiler");exports.PackProgram=PackProgram},{"../packing_util":55,"./shader_compiler":126}],111:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});function PadProgram(xShape,paddings,constantValue){this.variableNames=["x"],this.outputShape=paddings.map(function(p,i){return p[0]+xShape[i]+p[1]});var rank=xShape.length,type=shader_compiler_1.getCoordsDataType(rank),start=paddings.map(function(p){return p[0]}).join(","),end=paddings.map(function(p,i){return p[0]+xShape[i]}).join(","),unpackedCoords=["coords[0]","coords[1]","coords[2]","coords[3]"].slice(0,rank);this.userCode=1!==rank?"\n      "+type+" start = "+type+"("+start+");\n      "+type+" end = "+type+"("+end+");\n\n      void main() {\n        "+type+" outC = getOutputCoords();\n        if (any(lessThan(outC, start)) || any(greaterThanEqual(outC, end))) {\n          setOutput(float("+constantValue+"));\n        } else {\n          "+type+" coords = outC - start;\n          setOutput(getX("+unpackedCoords+"));\n        }\n      }\n    ":"\n        int start = "+start+";\n        int end = "+end+";\n\n        void main() {\n          int outC = getOutputCoords();\n          if (outC < start || outC >= end) {\n            setOutput(float("+constantValue+"));\n          } else {\n            setOutput(getX(outC - start));\n          }\n        }\n      "}var shader_compiler_1=require("./shader_compiler");exports.PadProgram=PadProgram},{"./shader_compiler":126}],112:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});function PadPackedProgram(xShape,paddings,constantValue){this.variableNames=["x"],this.usesPackedTextures=!0,this.outputShape=paddings.map(function(p,i){return p[0]+xShape[i]+p[1]});for(var rank=xShape.length,dtype=shader_compiler_1.getCoordsDataType(rank),start=paddings.map(function(p){return p[0]}).join(","),end=paddings.map(function(p,i){return p[0]+xShape[i]}).join(","),coords=packing_util_1.getChannels("rc",rank),source=packing_util_1.getChannels("source",rank),cLimit=coords[rank-1]+" < "+this.outputShape[rank-1],innerDims=1===rank?"source":"vec2("+source.slice(-2).join()+")",componentSetup=[dtype+" rc = outputLoc;",coords[rank-1]+" += 1;\n       if("+cLimit+") {\n      ",1===rank?"":"}\n       rc = outputLoc;\n       "+coords[rank-2]+" += 1;\n       if("+coords[rank-2]+" < "+this.outputShape[rank-2]+") {",1===rank?"":"  "+coords[rank-1]+" += 1;\n         if("+cLimit+") {"],paddingArea=1===rank?"rc < start || rc >= end":"any(lessThan(rc, start)) || any(greaterThanEqual(rc, end))",mainLoop="",i=0,j=1===rank?2:4;i<j;i++)mainLoop+="\n        "+componentSetup[i]+"\n        if ("+paddingArea+") {\n          result["+i+"] = float("+constantValue+");\n        } else {\n          "+dtype+" source = rc - start;\n          result["+i+"] = getChannel(getX("+source.join()+"), "+innerDims+");\n        }\n      ";mainLoop+=1===rank?"} ":"}}",this.userCode="\n      const "+dtype+" start = "+dtype+"("+start+");\n      const "+dtype+" end = "+dtype+"("+end+");\n\n      void main() {\n        "+dtype+" outputLoc = getOutputCoords();\n        vec4 result = vec4(0.);\n        "+mainLoop+"\n        setOutput(result);\n      }\n    "}var packing_util_1=require("../packing_util"),shader_compiler_1=require("./shader_compiler");exports.PadPackedProgram=PadPackedProgram},{"../packing_util":55,"./shader_compiler":126}],113:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});function Pool2DProgram(convInfo,poolType,computePositions){if(this.variableNames=["x"],"avg"===poolType&&computePositions)throw new Error("Cannot compute positions for average pool.");var filterWidth=convInfo.filterWidth,strideHeight=convInfo.strideHeight,strideWidth=convInfo.strideWidth,dilationHeight=convInfo.dilationHeight,dilationWidth=convInfo.dilationWidth,effectiveFilterHeight=convInfo.effectiveFilterHeight,effectiveFilterWidth=convInfo.effectiveFilterWidth,padTop=convInfo.padInfo.top,padLeft=convInfo.padInfo.left;this.outputShape=convInfo.outShape;var isAvgPool="avg"===poolType,initializationValue="0.0";if(isAvgPool||(initializationValue="-1.0 / 1e-20"),computePositions)this.userCode="\n        const ivec2 strides = ivec2("+strideHeight+", "+strideWidth+");\n        const ivec2 pads = ivec2("+padTop+", "+padLeft+");\n\n        void main() {\n          ivec4 coords = getOutputCoords();\n          int batch = coords[0];\n          int d = coords[3];\n\n          ivec2 xRCCorner = coords.yz * strides - pads;\n          int xRCorner = xRCCorner.x;\n          int xCCorner = xRCCorner.y;\n\n          // max/min x(?, ?, d) to get y(yR, yC, d).\n          // ? = to be determined\n          float minMaxValue = 0.0;\n          float minMaxValueFound = 0.0;\n          int minMaxPosition = 0;\n          float avgValue = 0.0;\n\n          for (int wR = 0; wR < "+effectiveFilterHeight+";\n              wR += "+dilationHeight+") {\n            int xR = xRCorner + wR;\n\n            if (xR < 0 || xR >= "+convInfo.inHeight+") {\n              continue;\n            }\n\n            for (int wC = 0; wC < "+effectiveFilterWidth+";\n                wC += "+dilationWidth+") {\n              int xC = xCCorner + wC;\n\n              if (xC < 0 || xC >= "+convInfo.inWidth+") {\n                continue;\n              }\n\n              float value = getX(batch, xR, xC, d);\n\n              // If a min / max value has already been found, use it. If not,\n              // use the current value.\n              float currMinMaxValue = mix(\n                  value, minMaxValue, minMaxValueFound);\n              if (value >= currMinMaxValue) {\n                minMaxValue = value;\n                minMaxValueFound = 1.0;\n                minMaxPosition = wR * "+effectiveFilterWidth+" + wC;\n              }\n            }\n          }\n          setOutput(float(minMaxPosition));\n        }\n      ";else{var returnValue=poolType+"("+poolType+"("+poolType+"(minMaxValue[0], minMaxValue[1]), minMaxValue[2]), minMaxValue[3])";"avg"===poolType&&(returnValue="avgValue / count");var filterWidthNearestVec4=4*Math.floor(filterWidth/4),filterWidthVec4Remainder=filterWidth%4,updateSnippet="\n      if ("+isAvgPool+") {\n        avgValue += dot(values, ones);\n      } else {\n        minMaxValue = max(values, minMaxValue);\n      }\n    ";this.userCode="\n      const ivec2 strides = ivec2("+strideHeight+", "+strideWidth+");\n      const ivec2 pads = ivec2("+padTop+", "+padLeft+");\n      const float initializationValue = "+initializationValue+";\n      const vec4 ones = vec4(1.0, 1.0, 1.0, 1.0);\n\n      float count = 0.0;\n\n      float getValue(int batch, int xR, int xC, int d) {\n        if (xC < 0 || xC >= "+convInfo.inWidth+") {\n          return initializationValue;\n        }\n        count += 1.0;\n        return getX(batch, xR, xC, d);\n      }\n\n      void main() {\n        ivec4 coords = getOutputCoords();\n        int batch = coords[0];\n        int d = coords[3];\n\n        ivec2 xRCCorner = coords.yz * strides - pads;\n        int xRCorner = xRCCorner.x;\n        int xCCorner = xRCCorner.y;\n\n        // max/min x(?, ?, d) to get y(yR, yC, d).\n        // ? = to be determined\n        vec4 minMaxValue = vec4("+initializationValue+");\n        float avgValue = 0.0;\n        count = 0.0;\n\n        for (int wR = 0; wR < "+effectiveFilterHeight+";\n            wR += "+dilationHeight+") {\n          int xR = xRCorner + wR;\n\n          if (xR < 0 || xR >= "+convInfo.inHeight+") {\n            continue;\n          }\n\n          for (int wC = 0; wC < "+filterWidthNearestVec4+"; wC += 4) {\n            int xC = xCCorner + wC * "+dilationWidth+";\n\n            vec4 values = vec4(\n              getValue(batch, xR, xC, d),\n              getValue(batch, xR, xC + "+dilationWidth+", d),\n              getValue(batch, xR, xC + 2 * "+dilationWidth+", d),\n              getValue(batch, xR, xC + 3 * "+dilationWidth+", d)\n            );\n\n            "+updateSnippet+"\n          }\n\n          int xC = xCCorner + "+filterWidthNearestVec4+";\n          if ("+(1==filterWidthVec4Remainder)+") {\n            vec4 values = vec4(\n              getValue(batch, xR, xC, d),\n              initializationValue,\n              initializationValue,\n              initializationValue\n            );\n\n            "+updateSnippet+"\n          } else if ("+(2==filterWidthVec4Remainder)+") {\n            vec4 values = vec4(\n              getValue(batch, xR, xC, d),\n              getValue(batch, xR, xC + "+dilationWidth+", d),\n              initializationValue,\n              initializationValue\n            );\n\n            "+updateSnippet+"\n          } else if ("+(3==filterWidthVec4Remainder)+") {\n            vec4 values = vec4(\n              getValue(batch, xR, xC, d),\n              getValue(batch, xR, xC + "+dilationWidth+", d),\n              getValue(batch, xR, xC + 2 * "+dilationWidth+", d),\n              initializationValue\n            );\n\n            "+updateSnippet+"\n          }\n        }\n        setOutput("+returnValue+");\n      }\n    "}}exports.Pool2DProgram=Pool2DProgram;function Pool3DProgram(convInfo,poolType,computePositions){if(this.variableNames=["x"],"avg"===poolType&&computePositions)throw new Error("Cannot compute positions for average pool.");var filterWidth=convInfo.filterWidth,strideDepth=convInfo.strideDepth,strideHeight=convInfo.strideHeight,strideWidth=convInfo.strideWidth,dilationDepth=convInfo.dilationDepth,dilationHeight=convInfo.dilationHeight,dilationWidth=convInfo.dilationWidth,effectiveFilterDepth=convInfo.effectiveFilterDepth,effectiveFilterHeight=convInfo.effectiveFilterHeight,effectiveFilterWidth=convInfo.effectiveFilterWidth,padFront=convInfo.padInfo.front,padTop=convInfo.padInfo.top,padLeft=convInfo.padInfo.left;this.outputShape=convInfo.outShape;var isAvgPool="avg"===poolType,initializationValue="0.0";if(isAvgPool||(initializationValue="-1.0 / 1e-20"),computePositions)this.userCode="\n        const ivec3 strides =\n            ivec3("+strideDepth+", "+strideHeight+", "+strideWidth+");\n        const ivec3 pads = ivec3("+padFront+", "+padTop+", "+padLeft+");\n\n        void main() {\n          ivec5 coords = getOutputCoords();\n          int batch = coords.x;\n          int ch = coords.u;\n\n          ivec3 xCorner = ivec3(coords.y, coords.z, coords.w) * strides - pads;\n          int xDCorner = xCorner.x;\n          int xRCorner = xCorner.y;\n          int xCCorner = xCorner.z;\n\n          // max/min x(?, ?, ?, ch) to get y(yD, yR, yC, ch).\n          // ? = to be determined\n          float minMaxValue = 0.0;\n          float minMaxValueFound = 0.0;\n          int minMaxPosition = 0;\n\n          for (int wD = 0; wD < "+effectiveFilterDepth+";\n              wD += "+dilationDepth+") {\n            int xD = xDCorner + wD;\n\n            if (xD < 0 || xD >= "+convInfo.inDepth+") {\n              continue;\n            }\n\n            for (int wR = 0; wR < "+effectiveFilterHeight+";\n                wR += "+dilationHeight+") {\n              int xR = xRCorner + wR;\n\n              if (xR < 0 || xR >= "+convInfo.inHeight+") {\n                continue;\n              }\n\n              for (int wC = 0; wC < "+effectiveFilterWidth+";\n                  wC += "+dilationWidth+") {\n                int xC = xCCorner + wC;\n\n                if (xC < 0 || xC >= "+convInfo.inWidth+") {\n                  continue;\n                }\n\n                float value = getX(batch, xD, xR, xC, ch);\n\n                // If a min / max value has already been found, use it. If not,\n                // use the current value.\n                float currMinMaxValue = mix(\n                    value, minMaxValue, minMaxValueFound);\n                if (value >= currMinMaxValue) {\n                  minMaxValue = value;\n                  minMaxValueFound = 1.0;\n                  minMaxPosition =\n                      wD * "+effectiveFilterHeight+" * "+effectiveFilterWidth+" +\n                      wR * "+effectiveFilterWidth+" + wC;;\n                }\n              }\n            }\n          }\n          setOutput(float(minMaxPosition));\n        }\n      ";else{var returnValue=poolType+"("+poolType+"("+poolType+"(minMaxValue[0], minMaxValue[1]), minMaxValue[2]), minMaxValue[3])";"avg"===poolType&&(returnValue="avgValue / count");var filterWidthNearestVec4=4*Math.floor(filterWidth/4),filterWidthVec4Remainder=filterWidth%4,updateSnippet="\n      if ("+isAvgPool+") {\n        avgValue += dot(values, ones);\n      } else {\n        minMaxValue = max(values, minMaxValue);\n      }\n    ";this.userCode="\n      const ivec3 strides =\n        ivec3("+strideDepth+", "+strideHeight+", "+strideWidth+");\n      const ivec3 pads = ivec3("+padFront+", "+padTop+", "+padLeft+");\n      const float initializationValue = "+initializationValue+";\n      const vec4 ones = vec4(1.0, 1.0, 1.0, 1.0);\n\n      float count = 0.0;\n\n      float getValue(int batch, int xD, int xR, int xC, int ch) {\n        if (xC < 0 || xC >= "+convInfo.inWidth+") {\n          return initializationValue;\n        }\n        count += 1.0;\n        return getX(batch, xD, xR, xC, ch);\n      }\n\n      void main() {\n        ivec5 coords = getOutputCoords();\n        int batch = coords.x;\n        int ch = coords.u;\n\n        ivec3 xCorner = ivec3(coords.y, coords.z, coords.w) * strides - pads;\n        int xDCorner = xCorner.x;\n        int xRCorner = xCorner.y;\n        int xCCorner = xCorner.z;\n\n        // max/min x(?, ?, ?, d) to get y(yD, yR, yC, ch).\n        // ? = to be determined\n        vec4 minMaxValue = vec4("+initializationValue+");\n        float avgValue = 0.0;\n        count = 0.0;\n\n        for (int wD = 0; wD < "+effectiveFilterDepth+";\n            wD += "+dilationDepth+") {\n          int xD = xDCorner + wD;\n\n          if (xD < 0 || xD >= "+convInfo.inDepth+") {\n            continue;\n          }\n\n          for (int wR = 0; wR < "+effectiveFilterHeight+";\n            wR += "+dilationHeight+") {\n            int xR = xRCorner + wR;\n\n            if (xR < 0 || xR >= "+convInfo.inHeight+") {\n              continue;\n            }\n\n            for (int wC = 0; wC < "+filterWidthNearestVec4+"; wC += 4) {\n              int xC = xCCorner + wC * "+dilationWidth+";\n\n              vec4 values = vec4(\n                getValue(batch, xD, xR, xC, ch),\n                getValue(batch, xD, xR, xC + "+dilationWidth+", ch),\n                getValue(batch, xD, xR, xC + 2 * "+dilationWidth+", ch),\n                getValue(batch, xD, xR, xC + 3 * "+dilationWidth+", ch)\n              );\n\n              "+updateSnippet+"\n            }\n\n            int xC = xCCorner + "+filterWidthNearestVec4+";\n            if ("+(1==filterWidthVec4Remainder)+") {\n              vec4 values = vec4(\n                getValue(batch, xD, xR, xC, ch),\n                initializationValue,\n                initializationValue,\n                initializationValue\n              );\n\n              "+updateSnippet+"\n            } else if ("+(2==filterWidthVec4Remainder)+") {\n              vec4 values = vec4(\n                getValue(batch, xD, xR, xC, ch),\n                getValue(batch, xD, xR, xC + "+dilationWidth+", ch),\n                initializationValue,\n                initializationValue\n              );\n\n              "+updateSnippet+"\n            } else if ("+(3==filterWidthVec4Remainder)+") {\n              vec4 values = vec4(\n                getValue(batch, xD, xR, xC, ch),\n                getValue(batch, xD, xR, xC + "+dilationWidth+", ch),\n                getValue(batch, xD, xR, xC + 2 * "+dilationWidth+", ch),\n                initializationValue\n              );\n\n              "+updateSnippet+"\n            }\n          }\n          setOutput("+returnValue+");\n        }\n      }\n    "}}exports.Pool3DProgram=Pool3DProgram},{}],114:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});function ReduceProgram(reduceInfo,reduceType){this.variableNames=["x"];var windowSize=reduceInfo.windowSize,batchSize=reduceInfo.batchSize,inSize=reduceInfo.inSize,outSize=Math.ceil(inSize/windowSize);this.outputShape=[batchSize,outSize];var initializationValue="0.0",compareOp="";"prod"===reduceType?initializationValue="1.0":"min"===reduceType?(initializationValue="1.0 / 1e-20",compareOp="min"):"max"===reduceType&&(initializationValue="-1.0 / 1e-20",compareOp="max");var returnValue=reduceType+"("+reduceType+"("+reduceType+"(minMaxValue[0], minMaxValue[1]), minMaxValue[2]), minMaxValue[3])";"sum"===reduceType?returnValue="sumValue":"prod"===reduceType?returnValue="prodValue":"all"===reduceType?returnValue="allValue":"any"===reduceType&&(returnValue="anyValue");var windowSizeNearestVec4=4*Math.floor(windowSize/4),windowSizeVec4Remainder=windowSize%4,updateSnippet="\n      if ("+("sum"===reduceType)+") {\n        sumValue += dot(values, ones);\n      } else if ("+("prod"===reduceType)+") {\n        vec2 tmp = vec2(values[0], values[1]) * vec2(values[2], values[3]);\n        prodValue *= tmp[0] * tmp[1];\n      } else {\n        minMaxValue = "+compareOp+"(values, minMaxValue);\n      }\n    ",vecType="vec4";"all"===reduceType?(initializationValue="1.0",updateSnippet="\n        bool reducedAllValue = all(values);\n        float floatedReducedAllValue = float(reducedAllValue);\n        allValue = float(allValue >= 1.0 && floatedReducedAllValue >= 1.0);\n      ",vecType="bvec4"):"any"===reduceType&&(initializationValue="0.0",updateSnippet="\n        bool reducedAnyValue = any(values);\n        float floatedReducedAnyValue = float(reducedAnyValue);\n        anyValue = float(anyValue >= 1.0 || floatedReducedAnyValue >= 1.0);\n      ",vecType="bvec4");var checkOutOfBounds="";0<inSize%windowSize&&(checkOutOfBounds="\n        if (inIdx < 0 || inIdx >= "+inSize+") {\n          return initializationValue;\n        }\n      "),this.userCode="\n      const float initializationValue = "+initializationValue+";\n      const vec4 ones = vec4(1.0, 1.0, 1.0, 1.0);\n\n      float getValue(int batch, int inIdx) {\n        "+checkOutOfBounds+"\n        return getX(batch, inIdx);\n      }\n\n      void main() {\n        ivec2 coords = getOutputCoords();\n        int batch = coords[0];\n        int outIdx = coords[1];\n        int inOffset = outIdx * "+windowSize+";\n\n        vec4 minMaxValue = vec4("+initializationValue+");\n        float prodValue = 1.0;\n        float sumValue = 0.0;\n        float allValue = 1.0;\n        float anyValue = 0.0;\n\n        for (int i = 0; i < "+windowSizeNearestVec4+"; i += 4) {\n          int inIdx = inOffset + i;\n          "+vecType+" values = "+vecType+"(\n            getValue(batch, inIdx),\n            getValue(batch, inIdx + 1),\n            getValue(batch, inIdx + 2),\n            getValue(batch, inIdx + 3)\n          );\n\n          "+updateSnippet+"\n        }\n\n        int inIdx = inOffset + "+windowSizeNearestVec4+";\n        if ("+(1==windowSizeVec4Remainder)+") {\n          "+vecType+" values = "+vecType+"(\n            getValue(batch, inIdx),\n            initializationValue,\n            initializationValue,\n            initializationValue\n          );\n\n          "+updateSnippet+"\n        } else if ("+(2==windowSizeVec4Remainder)+") {\n          "+vecType+" values = "+vecType+"(\n            getValue(batch, inIdx),\n            getValue(batch, inIdx + 1),\n            initializationValue,\n            initializationValue\n          );\n\n          "+updateSnippet+"\n        } else if ("+(3==windowSizeVec4Remainder)+") {\n          "+vecType+" values = "+vecType+"(\n            getValue(batch, inIdx),\n            getValue(batch, inIdx + 1),\n            getValue(batch, inIdx + 2),\n            initializationValue\n          );\n\n          "+updateSnippet+"\n        }\n        setOutput("+returnValue+");\n      }\n    "}exports.ReduceProgram=ReduceProgram},{}],115:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});function ReshapePackedProgram(outputShape,inputShape){this.variableNames=["A"],this.usesPackedTextures=!0,this.outputShape=outputShape;for(var mainLoop="",i=0;i<4;i++){var thisRC="thisRC = rc;";i%2==1&&(thisRC+="thisRC.z += 1;"),1<i&&(thisRC+="thisRC.y += 1;"),mainLoop+="\n        "+thisRC+"\n        "+(0<i?"if(thisRC.y < rows && thisRC.z < cols){":"")+"\n          int flatIndex = getFlatIndex(thisRC);\n\n          ivec3 inputRC = inputCoordsFromReshapedOutCoords(flatIndex);\n          vec2 inputRCInnerDims = vec2(float(inputRC.y),float(inputRC.z));\n\n          result["+i+"] =\n            getChannel(getA(inputRC.x, inputRC.y, inputRC.z), inputRCInnerDims);\n        "+(0<i?"}":"")+"\n      "}this.userCode="\n      "+function(shape){return"\n    ivec3 inputCoordsFromReshapedOutCoords(int index) {\n      "+shader_util.getLogicalCoordinatesFromFlatIndex(["r","c","d"],shape)+"\n      return ivec3(r, c, d);\n    }\n  "}(inputShape)+"\n      "+shader_util.getFlatIndexFrom3D(outputShape)+"\n\n      void main() {\n        ivec3 rc = getOutputCoords();\n\n        vec4 result = vec4(0.);\n\n        ivec3 thisRC;\n        int rows = "+outputShape[1]+";\n        int cols = "+outputShape[2]+";\n\n        "+mainLoop+"\n\n        setOutput(result);\n      }\n    "}var shader_util=require("./shader_compiler_util");exports.ReshapePackedProgram=ReshapePackedProgram},{"./shader_compiler_util":127}],116:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});function ResizeBilinearBackpropProgram(dy,x,alignCorners){this.variableNames=["dy"],this.outputShape=[],this.outputShape=x.shape;var _a=x.shape,xHeight=_a[1],xWidth=_a[2],_b=dy.shape,yHeight=_b[1],yWidth=_b[2],effectiveXSize=[alignCorners&&1<yHeight?xHeight-1:xHeight,alignCorners&&1<yWidth?xWidth-1:xWidth],effectiveYSize=[alignCorners&&1<yHeight?yHeight-1:yHeight,alignCorners&&1<yWidth?yWidth-1:yWidth],heightScale=effectiveXSize[0]/effectiveYSize[0],widthScale=effectiveXSize[1]/effectiveYSize[1],invHeightScale=1/heightScale,invWidthScale=1/widthScale,winHeight=2*Math.ceil(invHeightScale)+2,winWidth=2*Math.ceil(invWidthScale)+2;this.userCode="\n      void main() {\n        ivec4 coords = getOutputCoords();\n        int b = coords[0];\n        int d = coords[3];\n        int r = coords[1];\n        int c = coords[2];\n\n        float accumulator = 0.0;\n\n        const float heightScale = float("+heightScale+");\n        const float widthScale = float("+widthScale+");\n\n        const float invHeightScale = float("+invHeightScale+");\n        const float invWidthScale = float("+invWidthScale+");\n\n        const int winHeight = int("+winHeight+");\n        const int winWidth = int("+winWidth+");\n\n        // Compute bounds for where in dy we will look\n        float startRLerp = floor(float(r) * invHeightScale);\n        int startDyR = int(startRLerp - float(winHeight / 2));\n\n        float startCLerp = floor(float(c) * invWidthScale);\n        int startDyC = int(startCLerp - float(winWidth / 2));\n\n        // Loop over dy\n        for (int dyROffset = 0; dyROffset < winHeight; dyROffset++) {\n          int dyR = dyROffset + startDyR;\n\n          // Guard against the window exceeding the bounds of dy\n          if (dyR < 0 || dyR >= "+yHeight+") {\n            continue;\n          }\n\n          for (int dyCOffset = 0; dyCOffset < winWidth; dyCOffset++) {\n            int dyC = dyCOffset + startDyC;\n\n            // Guard against the window exceeding the bounds of dy\n            if (dyC < 0 || dyC >= "+yWidth+") {\n              continue;\n            }\n\n            float dxR = float(dyR) * heightScale;\n            int topDxRIndex = int(floor(dxR));\n            int bottomDxRIndex = int(min(ceil(dxR), "+(xHeight-1)+".0));\n            float dxRLerp = dxR - float(topDxRIndex);\n            float inverseDxRLerp = 1.0 - dxRLerp;\n\n            float dxC = float(dyC) * widthScale;\n            int leftDxCIndex = int(floor(dxC));\n            int rightDxCIndex = int(min(ceil(dxC), "+(xWidth-1)+".0));\n            float dxCLerp = dxC - float(leftDxCIndex);\n            float inverseDxCLerp = 1.0 - dxCLerp;\n\n            if (r == topDxRIndex && c == leftDxCIndex) {\n              // topLeft\n              accumulator +=\n                getDy(b, dyR, dyC, d) * inverseDxRLerp * inverseDxCLerp;\n            }\n\n            if (r == topDxRIndex && c == rightDxCIndex) {\n              // topRight\n              accumulator += getDy(b, dyR, dyC, d) * inverseDxRLerp * dxCLerp;\n            }\n\n            if (r == bottomDxRIndex && c == leftDxCIndex) {\n              // bottomLeft\n              accumulator += getDy(b, dyR, dyC, d) * dxRLerp * inverseDxCLerp;\n            }\n\n            if (r == bottomDxRIndex && c == rightDxCIndex) {\n              // bottomRight\n              accumulator += getDy(b, dyR, dyC, d) * dxRLerp * dxCLerp;\n            }\n          }\n        }\n        // End loop over dy\n\n        setOutput(accumulator);\n      }\n    "}exports.ResizeBilinearBackpropProgram=ResizeBilinearBackpropProgram},{}],117:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});function ResizeBilinearProgram(inputShape,newHeight,newWidth,alignCorners){this.variableNames=["A"],this.outputShape=[];var batch=inputShape[0],oldHeight=inputShape[1],oldWidth=inputShape[2],depth=inputShape[3];this.outputShape=[batch,newHeight,newWidth,depth];var effectiveInSize=[alignCorners&&1<newHeight?oldHeight-1:oldHeight,alignCorners&&1<newWidth?oldWidth-1:oldWidth],effectiveOutSize=[alignCorners&&1<newHeight?newHeight-1:newHeight,alignCorners&&1<newWidth?newWidth-1:newWidth];this.userCode="\n      const vec2 effectiveInputOverOutputRatioRC = vec2(\n          "+effectiveInSize[0]/effectiveOutSize[0]+",\n          "+effectiveInSize[1]/effectiveOutSize[1]+");\n      const vec2 inputShapeRC = vec2("+oldHeight+".0, "+oldWidth+".0);\n\n      void main() {\n        ivec4 coords = getOutputCoords();\n        int b = coords[0];\n        int d = coords[3];\n        ivec2 yRC = coords.yz;\n\n        // Fractional source index.\n        vec2 sourceFracIndexRC = vec2(yRC) * effectiveInputOverOutputRatioRC;\n\n        // Compute the four integer indices.\n        ivec2 sourceFloorRC = ivec2(sourceFracIndexRC);\n        ivec2 sourceCeilRC = ivec2(\n          min(inputShapeRC - 1.0, ceil(sourceFracIndexRC)));\n\n        float topLeft = getA(b, sourceFloorRC.x, sourceFloorRC.y, d);\n        float bottomLeft = getA(b, sourceCeilRC.x, sourceFloorRC.y, d);\n        float topRight = getA(b, sourceFloorRC.x, sourceCeilRC.y, d);\n        float bottomRight = getA(b, sourceCeilRC.x, sourceCeilRC.y, d);\n\n        vec2 fracRC = sourceFracIndexRC - vec2(sourceFloorRC);\n\n        float top = topLeft + (topRight - topLeft) * fracRC.y;\n        float bottom = bottomLeft + (bottomRight - bottomLeft) * fracRC.y;\n        float newValue = top + (bottom - top) * fracRC.x;\n\n        setOutput(newValue);\n      }\n    "}exports.ResizeBilinearProgram=ResizeBilinearProgram},{}],118:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});function ResizeBilinearPackedProgram(inputShape,newHeight,newWidth,alignCorners){this.variableNames=["A"],this.usesPackedTextures=!0,this.outputShape=[];var batch=inputShape[0],oldHeight=inputShape[1],oldWidth=inputShape[2],depth=inputShape[3];this.outputShape=[batch,newHeight,newWidth,depth];var effectiveInSize=[alignCorners&&1<newHeight?oldHeight-1:oldHeight,alignCorners&&1<newWidth?oldWidth-1:oldWidth],effectiveOutSize=[alignCorners&&1<newHeight?newHeight-1:newHeight,alignCorners&&1<newWidth?newWidth-1:newWidth];this.userCode="\n      const vec3 effectiveInputOverOutputRatioRC = vec3(\n          "+effectiveInSize[0]/effectiveOutSize[0]+",\n          "+effectiveInSize[1]/effectiveOutSize[1]+",\n          "+effectiveInSize[1]/effectiveOutSize[1]+");\n      const vec3 inputShapeRC = vec3("+oldHeight+".0, "+oldWidth+".0,\n                                     "+oldWidth+".0);\n\n      float getAValue(int b, int r, int c, int d) {\n        return getChannel(getA(b, r, c, d), vec2(c, d));\n      }\n\n      void main() {\n        ivec4 coords = getOutputCoords();\n        int b = coords[0];\n        int d = coords[3];\n        // Calculate values for next column in yRC.z.\n        ivec3 yRC = coords.yzz + ivec3(0, 0, 1);\n\n        // Fractional source index.\n        vec3 sourceFracIndexRC = vec3(yRC) * effectiveInputOverOutputRatioRC;\n\n        // Compute the four integer indices.\n        ivec3 sourceFloorRC = ivec3(sourceFracIndexRC);\n        ivec3 sourceCeilRC = ivec3(\n          min(inputShapeRC - 1.0, ceil(sourceFracIndexRC)));\n        \n        // Should we calculate next column and row elements in 2x2 packed cell.\n        bool hasNextCol = d < "+(depth-1)+"; \n        bool hasNextRow = coords.z < "+(newWidth-1)+";\n\n        // In parallel, construct four corners for all four components in\n        // packed 2x2 cell.\n        vec4 topLeft = vec4(\n          getAValue(b, sourceFloorRC.x, sourceFloorRC.y, d),\n          hasNextCol ? getAValue(b, sourceFloorRC.x, sourceFloorRC.y, d + 1)\n                     : 0.0,\n          hasNextRow ? getAValue(b, sourceFloorRC.x, sourceFloorRC.z, d)\n                     : 0.0,\n          (hasNextRow && hasNextCol) ?\n            getAValue(b, sourceFloorRC.x, sourceFloorRC.z, d + 1) : 0.0);\n\n        vec4 bottomLeft = vec4(\n          getAValue(b, sourceCeilRC.x, sourceFloorRC.y, d),\n          hasNextCol ? getAValue(b, sourceCeilRC.x, sourceFloorRC.y, d + 1)\n                     : 0.0,\n          hasNextRow ? getAValue(b, sourceCeilRC.x, sourceFloorRC.z, d)\n                     : 0.0,\n          (hasNextRow && hasNextCol) ?\n            getAValue(b, sourceCeilRC.x, sourceFloorRC.z, d + 1) : 0.0);\n\n        vec4 topRight = vec4(\n          getAValue(b, sourceFloorRC.x, sourceCeilRC.y, d),\n          hasNextCol ? getAValue(b, sourceFloorRC.x, sourceCeilRC.y, d + 1)\n                     : 0.0,\n          hasNextRow ? getAValue(b, sourceFloorRC.x, sourceCeilRC.z, d)\n                     : 0.0,\n          (hasNextRow && hasNextCol) ?\n            getAValue(b, sourceFloorRC.x, sourceCeilRC.z, d + 1) : 0.0);\n\n        vec4 bottomRight = vec4(\n          getAValue(b, sourceCeilRC.x, sourceCeilRC.y, d),\n          hasNextCol ? getAValue(b, sourceCeilRC.x, sourceCeilRC.y, d + 1)\n                     : 0.0,\n          hasNextRow ? getAValue(b, sourceCeilRC.x, sourceCeilRC.z, d)\n                     : 0.0,\n          (hasNextRow && hasNextCol) ?\n            getAValue(b, sourceCeilRC.x, sourceCeilRC.z, d + 1) : 0.0);\n\n        vec3 fracRC = sourceFracIndexRC - vec3(sourceFloorRC);\n\n        vec4 top = mix(topLeft, topRight, fracRC.yyzz);\n        vec4 bottom = mix(bottomLeft, bottomRight, fracRC.yyzz);\n        vec4 newValue = mix(top, bottom, fracRC.x);\n\n        setOutput(newValue);\n      }\n    "}exports.ResizeBilinearPackedProgram=ResizeBilinearPackedProgram},{}],119:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});function ResizeNearestNeigborBackpropProgram(dy,x,alignCorners){this.variableNames=["dy"],this.outputShape=[],this.outputShape=x.shape;var _a=x.shape,xHeight=_a[1],xWidth=_a[2],_b=dy.shape,yHeight=_b[1],yWidth=_b[2],effectiveXSize=[alignCorners&&1<yHeight?xHeight-1:xHeight,alignCorners&&1<yWidth?xWidth-1:xWidth],effectiveYSize=[alignCorners&&1<yHeight?yHeight-1:yHeight,alignCorners&&1<yWidth?yWidth-1:yWidth],heightScale=effectiveXSize[0]/effectiveYSize[0],widthScale=effectiveXSize[1]/effectiveYSize[1],invHeightScale=1/heightScale,invWidthScale=1/widthScale,winHeight=2*Math.ceil(invHeightScale)+2,winWidth=2*Math.ceil(invWidthScale)+2;this.userCode="\n      void main() {\n        ivec4 coords = getOutputCoords();\n        int b = coords[0];\n        int d = coords[3];\n        int r = coords[1];\n        int c = coords[2];\n\n        float accumulator = 0.0;\n\n        const float heightScale = float("+heightScale+");\n        const float widthScale = float("+widthScale+");\n\n        const float invHeightScale = float("+invHeightScale+");\n        const float invWidthScale = float("+invWidthScale+");\n\n        const int winHeight = int("+winHeight+");\n        const int winWidth = int("+winWidth+");\n\n        // Compute bounds for where in dy we will look\n        float startRLerp = floor(float(r) * invHeightScale);\n        int startDyR = int(floor(startRLerp - float(winHeight / 2)));\n\n        float startCLerp = floor(float(c) * invWidthScale);\n        int startDyC = int(floor(startCLerp - float(winWidth / 2)));\n\n        // Loop over dy\n        for (int dyROffset = 0; dyROffset < winHeight; dyROffset++) {\n          int dyR = dyROffset + startDyR;\n\n          // Guard against the window exceeding the bounds of dy\n          if (dyR < 0 || dyR >= "+yHeight+") {\n            continue;\n          }\n\n          for (int dyCOffset = 0; dyCOffset < winWidth; dyCOffset++) {\n            int dyC = dyCOffset + startDyC;\n\n            // Guard against the window exceeding the bounds of dy\n            if (dyC < 0 || dyC >= "+yWidth+") {\n              continue;\n            }\n\n            float sourceFracRow =\n              float("+effectiveXSize[0]+") *\n                (float(dyR) / float("+effectiveYSize[0]+"));\n\n            float sourceFracCol =\n                float("+effectiveXSize[1]+") *\n                  (float(dyC) / float("+effectiveYSize[1]+"));\n\n            int sourceNearestRow = int(min(\n                float(int("+xHeight+") - 1),\n                "+alignCorners+" ? float(round(sourceFracRow)) :\n                                  float(floor(sourceFracRow))));\n\n            int sourceNearestCol = int(min(\n                float(int("+xWidth+") - 1),\n                "+alignCorners+" ? float(round(sourceFracCol)) :\n                                  float(floor(sourceFracCol))));\n\n            if (r == sourceNearestRow && c == sourceNearestCol) {\n              accumulator += getDy(b, dyR, dyC, d);\n            }\n          }\n        }\n        // End loop over dy\n\n        setOutput(accumulator);\n      }\n    "}exports.ResizeNearestNeigborBackpropProgram=ResizeNearestNeigborBackpropProgram},{}],120:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});function ResizeNearestNeighborProgram(inputShape,newHeight,newWidth,alignCorners){this.variableNames=["A"],this.outputShape=[];var batch=inputShape[0],oldHeight=inputShape[1],oldWidth=inputShape[2],depth=inputShape[3];this.outputShape=[batch,newHeight,newWidth,depth];var effectiveInSize=[alignCorners&&1<newHeight?oldHeight-1:oldHeight,alignCorners&&1<newWidth?oldWidth-1:oldWidth],effectiveOutSize=[alignCorners&&1<newHeight?newHeight-1:newHeight,alignCorners&&1<newWidth?newWidth-1:newWidth],roundBase=alignCorners?"0.5":"0.0";this.userCode="\n      const vec2 effectiveInputOverOutputRatioRC = vec2(\n          "+effectiveInSize[0]/effectiveOutSize[0]+",\n          "+effectiveInSize[1]/effectiveOutSize[1]+");\n      const vec2 inputShapeRC = vec2("+oldHeight+".0, "+oldWidth+".0);\n\n      void main() {\n        ivec4 coords = getOutputCoords();\n        int b = coords[0];\n        int d = coords[3];\n        ivec2 yRC = coords.yz;\n\n        // Fractional source index.\n        vec2 sourceFracIndexRC = vec2(yRC) * effectiveInputOverOutputRatioRC;\n\n        // Compute the coordinators of nearest neighbor point.\n        ivec2 sourceNearestRC = ivec2(\n          min(inputShapeRC - 1.0, floor(sourceFracIndexRC + "+roundBase+")));\n\n        float newValue = getA(b, sourceNearestRC.x, sourceNearestRC.y, d);\n\n        setOutput(newValue);\n      }\n    "}exports.ResizeNearestNeighborProgram=ResizeNearestNeighborProgram},{}],121:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});function ReverseProgram(xShape,axis){this.variableNames=["x"];var rank=xShape.length;if(4<rank)throw new Error("WebGL backend: Reverse of rank-"+rank+" tensor is not yet supported");if(this.outputShape=xShape,1!==rank){var inCoords=xShape.map(function(_,i){return function(i){return-1!==axis.indexOf(i)&&1!==xShape[i]?xShape[i]+" - coords["+i+"] - 1":"coords["+i+"]"}(i)}).join(","),type=shader_compiler_1.getCoordsDataType(rank);this.userCode="\n      void main() {\n        "+type+" coords = getOutputCoords();\n        setOutput(getX("+inCoords+"));\n      }\n    "}else this.userCode="\n        void main() {\n          int coord = getOutputCoords();\n          setOutput(getX("+xShape[0]+" - coord - 1));\n        }\n      "}var shader_compiler_1=require("./shader_compiler");exports.ReverseProgram=ReverseProgram},{"./shader_compiler":126}],122:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});function ReversePackedProgram(xShape,axis){this.variableNames=["x"],this.usesPackedTextures=!0;var rank=xShape.length;if(4<rank)throw new Error("WebGL backend: Reverse of rank-"+rank+" tensor is not yet supported");this.outputShape=xShape;var channels=packing_util_1.getChannels("rc",rank),nextColumn=channels[rank-1]+" + 1 < "+this.outputShape[rank-1],nextRow=channels[rank-2]+" + 1 < "+this.outputShape[rank-2],type=shader_compiler_1.getCoordsDataType(rank);function getChannel(channels){var inCoordsArray=xShape.map(function(_,i){return function(i,channels1){return-1!==axis.indexOf(i)&&1!==xShape[i]?xShape[i]+" - "+channels1[i]+" - 1":""+channels1[i]}(i,channels)});return"getChannel(getX("+inCoordsArray.join(",")+"), vec2("+inCoordsArray.slice(-2).join(",")+"))"}this.userCode=1===rank?"\n        void main(){\n          int rc = getOutputCoords();\n          vec4 result = vec4(0.);\n          result.r = getChannel(getX("+xShape[0]+" - rc - 1),\n            "+xShape[0]+" - rc - 1);\n          if("+nextColumn+"){\n              result.g = getChannel(getX("+xShape[0]+" - (rc  + 1) - 1),\n                "+xShape[0]+" - (rc  + 1) - 1);\n          }\n          setOutput(result);\n        }\n      ":"\n        void main() {\n          "+type+" rc = getOutputCoords();\n          vec4 result = vec4(0.);\n          result.r = "+function(channels){return getChannel(channels)}(channels.slice())+";\n          if("+nextColumn+"){\n            result.g = "+function(channels){return channels[rank-1]="("+channels[rank-1]+" + 1)",getChannel(channels)}(channels.slice())+";\n          }\n          if("+nextRow+") {\n            result.b = "+function(channels){return channels[rank-2]="("+channels[rank-2]+" + 1)",getChannel(channels)}(channels.slice())+";\n            if("+nextColumn+") {\n              result.a = "+function(channels){return channels[rank-1]="("+channels[rank-1]+" + 1)",channels[rank-2]="("+channels[rank-2]+" + 1)",getChannel(channels)}(channels.slice())+";\n            }\n          }\n          setOutput(result);\n        }\n    "}var packing_util_1=require("../packing_util"),shader_compiler_1=require("./shader_compiler");exports.ReversePackedProgram=ReversePackedProgram},{"../packing_util":55,"./shader_compiler":126}],123:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});function ScatterProgram(updateSize,sliceDim,indicesRank,updatesRank,strides,shape,summingDupeIndex){void 0===summingDupeIndex&&(summingDupeIndex=!0),this.variableNames=["updates","indices","defaultValue"],this.outputShape=shape;var stridesType=shader_compiler_1.getCoordsDataType(strides.length),dtype=shader_compiler_1.getCoordsDataType(shape.length),indicesString="";1===indicesRank?indicesString="i":2===indicesRank&&(indicesString="i, j");var indicesSnippet="getIndices("+indicesString+")",updatesString="";1===updatesRank?updatesString="i":2===updatesRank&&(updatesString="i, coords[1]");var updatesSnippet="getUpdates("+updatesString+")",strideString=1<sliceDim?"strides[j]":"strides";this.userCode="\n        "+stridesType+" strides = "+stridesType+"("+strides+");\n\n        void main() {\n          "+dtype+" coords = getOutputCoords();\n          float sum = 0.0;\n          bool found = false;\n          for (int i = 0; i < "+updateSize+"; i++) {\n            int flattenedIndex = 0;\n            for (int j = 0; j < "+sliceDim+"; j++) {\n              int index = round("+indicesSnippet+");\n              flattenedIndex += index * "+strideString+";\n            }\n            if (flattenedIndex == coords[0]) {\n              sum += "+updatesSnippet+";\n              found = true;\n            }\n          }\n          setOutput(mix(getDefaultValue(), sum, float(found)));\n        }\n      "}var shader_compiler_1=require("./shader_compiler");exports.ScatterProgram=ScatterProgram},{"./shader_compiler":126}],124:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});function SegmentOpProgram(segOpInfo,segOpType){this.variableNames=["x","segmentIds"];var windowSize=segOpInfo.windowSize,batchSize=segOpInfo.batchSize,inSize=segOpInfo.inSize,numSegments=segOpInfo.numSegments,outSize=numSegments*Math.ceil(inSize/windowSize);this.outputShape=[batchSize,outSize];var windowSizeNearestVec4=4*Math.floor(windowSize/4),windowSizeVec4Remainder=windowSize%4,updateSnippet="\n        sumValue += dot(values, segFilter);\n    ",checkValueOutOfBounds="";0<inSize%windowSize&&(checkValueOutOfBounds="\n        if (inIdx < 0 || inIdx >= "+inSize+") {\n          return initializationValue;\n        }\n      ");var checkSegmentIdOutOfBounds="";0<inSize%windowSize&&(checkSegmentIdOutOfBounds="\n        if (inIdx < 0 || inIdx >= "+inSize+") {\n          return -1.0;\n        }\n      "),this.userCode="\n      const float initializationValue = 0.0;\n\n      float getValue(int batch, int inIdx) {\n        "+checkValueOutOfBounds+"\n        return getX(batch, inIdx);\n      }\n\n      float getSegmentIdAtIndex(int inIdx) {\n        "+checkSegmentIdOutOfBounds+"\n        return getSegmentIds(inIdx);\n      }\n\n      void main() {\n        ivec2 coords = getOutputCoords();\n        int batch = coords[0];\n        int outIdx = coords[1];\n        int inOffset = int(floor(float(outIdx) / float(\n          "+numSegments+")) * float("+windowSize+"));\n        int currentSeg = int(mod(float(outIdx), float("+numSegments+")));\n\n        float sumValue = 0.0;\n\n        for (int i = 0; i < "+windowSizeNearestVec4+"; i += 4) {\n          int inIdx = inOffset + i;\n          vec4 values = vec4(\n            getValue(batch, inIdx),\n            getValue(batch, inIdx + 1),\n            getValue(batch, inIdx + 2),\n            getValue(batch, inIdx + 3)\n          );\n\n          vec4 segFilter = vec4(\n            int(getSegmentIdAtIndex(inIdx)) == currentSeg ? 1 : 0,\n            int(getSegmentIdAtIndex(inIdx + 1)) == currentSeg ? 1 : 0,\n            int(getSegmentIdAtIndex(inIdx + 2)) == currentSeg ? 1 : 0,\n            int(getSegmentIdAtIndex(inIdx + 3)) == currentSeg ? 1 : 0\n          );\n\n          "+updateSnippet+"\n        }\n\n        int inIdx = inOffset + "+windowSizeNearestVec4+";\n        if ("+(1==windowSizeVec4Remainder)+") {\n          vec4 values = vec4(\n            getValue(batch, inIdx),\n            initializationValue,\n            initializationValue,\n            initializationValue\n          );\n\n          int inIdxSeg = int(getSegmentIdAtIndex(inIdx));\n\n          vec4 segFilter = vec4(\n            int(getSegmentIdAtIndex(inIdx)) == currentSeg ? 1 : 0,\n            0,\n            0,\n            0\n          );\n\n          "+updateSnippet+"\n        } else if ("+(2==windowSizeVec4Remainder)+") {\n          vec4 values = vec4(\n            getValue(batch, inIdx),\n            getValue(batch, inIdx + 1),\n            initializationValue,\n            initializationValue\n          );\n\n          vec4 segFilter = vec4(\n            int(getSegmentIdAtIndex(inIdx)) == currentSeg ? 1 : 0,\n            int(getSegmentIdAtIndex(inIdx + 1)) == currentSeg ? 1 : 0,\n              0,\n              0\n          );\n\n          "+updateSnippet+"\n        } else if ("+(3==windowSizeVec4Remainder)+") {\n          vec4 values = vec4(\n            getValue(batch, inIdx),\n            getValue(batch, inIdx + 1),\n            getValue(batch, inIdx + 2),\n            initializationValue\n          );\n\n          vec4 segFilter = vec4(\n            int(getSegmentIdAtIndex(inIdx)) == currentSeg ? 1 : 0,\n            int(getSegmentIdAtIndex(inIdx + 1)) == currentSeg ? 1 : 0,\n            int(getSegmentIdAtIndex(inIdx + 2)) == currentSeg ? 1 : 0,\n            0\n          );\n\n          "+updateSnippet+"\n        }\n        setOutput(sumValue);\n      }\n    "}exports.SegmentOpProgram=SegmentOpProgram},{}],125:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});function SelectProgram(cRank,shape,rank){var cCoords,abCoords;if(this.variableNames=["c","a","b"],this.outputShape=shape,4<rank)throw Error("Where for rank "+rank+" is not yet supported");if(1===rank)cCoords=abCoords="resRC";else{for(var currentCoords=["resRC.x","resRC.y","resRC.z","resRC.w"],cCoordVars=[],abCoordVars=[],i=0;i<shape.length;i++)abCoordVars.push(""+currentCoords[i]),i<cRank&&cCoordVars.push(""+currentCoords[i]);cCoords=cCoordVars.join(),abCoords=abCoordVars.join()}var dtype=shader_compiler_1.getCoordsDataType(rank);this.userCode="\n      void main() {\n        "+dtype+" resRC = getOutputCoords();\n        float cVal = getC("+cCoords+");\n        if (cVal >= 1.0) {\n          setOutput(getA("+abCoords+"));\n        } else {\n          setOutput(getB("+abCoords+"));\n        }\n      }\n    "}var shader_compiler_1=require("./shader_compiler");exports.SelectProgram=SelectProgram},{"./shader_compiler":126}],126:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var broadcast_util_1=require("../../ops/broadcast_util"),util=require("../../util"),glsl_version_1=require("./glsl_version"),shader_util=require("./shader_compiler_util");function getSamplerFromInInfo(inInfo){var shape=inInfo.shapeInfo.logicalShape;switch(shape.length){case 0:return function(inputInfo){var texName=inputInfo.name,funcName="get"+texName.charAt(0).toUpperCase()+texName.slice(1);if(inputInfo.shapeInfo.isUniform)return"float "+funcName+"() {return "+texName+";}";var _a=inputInfo.shapeInfo.texShape,texNumR=_a[0],texNumC=_a[1];if(1===texNumR&&1===texNumC)return"\n      float "+funcName+"() {\n        return sampleTexture("+texName+", halfCR);\n      }\n    ";var _b=inputInfo.shapeInfo.texShape,tNumR=_b[0],tNumC=_b[1],offset=getFlatOffsetUniformName(texName);return"\n    float "+funcName+"() {\n      vec2 uv = uvFromFlat("+tNumR+", "+tNumC+", "+offset+");\n      return sampleTexture("+texName+", uv);\n    }\n  "}(inInfo);case 1:return function(inputInfo){var texName=inputInfo.name,funcName="get"+texName.charAt(0).toUpperCase()+texName.slice(1);if(inputInfo.shapeInfo.isUniform)return"\n      float "+funcName+"(int index) {\n        "+getUniformSampler(inputInfo)+"\n      }\n    ";var texShape=inputInfo.shapeInfo.texShape,tNumR=texShape[0],tNumC=texShape[1];if(1===tNumC&&1===tNumR)return"\n      float "+funcName+"(int index) {\n        return sampleTexture("+texName+", halfCR);\n      }\n    ";var offset=getFlatOffsetUniformName(texName);return 1!==tNumC?1!==tNumR?"\n    float "+funcName+"(int index) {\n      vec2 uv = uvFromFlat("+tNumR+", "+tNumC+", index + "+offset+");\n      return sampleTexture("+texName+", uv);\n    }\n  ":"\n      float "+funcName+"(int index) {\n        vec2 uv = vec2((float(index + "+offset+") + 0.5) / "+tNumC+".0, 0.5);\n        return sampleTexture("+texName+", uv);\n      }\n    ":"\n      float "+funcName+"(int index) {\n        vec2 uv = vec2(0.5, (float(index + "+offset+") + 0.5) / "+tNumR+".0);\n        return sampleTexture("+texName+", uv);\n      }\n    "}(inInfo);case 2:return function(inputInfo){var shape=inputInfo.shapeInfo.logicalShape,texName=inputInfo.name,funcName="get"+texName.charAt(0).toUpperCase()+texName.slice(1),texShape=inputInfo.shapeInfo.texShape;if(null!=texShape&&util.arraysEqual(shape,texShape)){var texNumR_1=texShape[0],texNumC_1=texShape[1];return"\n    float "+funcName+"(int row, int col) {\n      vec2 uv = (vec2(col, row) + halfCR) / vec2("+texNumC_1+".0, "+texNumR_1+".0);\n      return sampleTexture("+texName+", uv);\n    }\n  "}var _a=util.squeezeShape(shape),newShape=_a.newShape,keptDims=_a.keptDims,squeezedShape=newShape;if(squeezedShape.length<shape.length){var newInputInfo=squeezeInputInfo(inputInfo,squeezedShape);return"\n      "+getSamplerFromInInfo(newInputInfo)+"\n      float "+funcName+"(int row, int col) {\n        return "+funcName+"("+getSqueezedParams(["row","col"],keptDims)+");\n      }\n    "}if(inputInfo.shapeInfo.isUniform)return"\n      float "+funcName+"(int row, int col) {\n        int index = round(dot(vec2(row, col), vec2("+shape[1]+", 1)));\n        "+getUniformSampler(inputInfo)+"\n      }\n    ";var texNumR=texShape[0],texNumC=texShape[1],offset=getFlatOffsetUniformName(texName);return 1!==texNumC?1!==texNumR?"\n  float "+funcName+"(int row, int col) {\n    // Explicitly use integer operations as dot() only works on floats.\n    int index = row * "+shape[1]+" + col + "+offset+";\n    vec2 uv = uvFromFlat("+texNumR+", "+texNumC+", index);\n    return sampleTexture("+texName+", uv);\n  }\n":"\n    float "+funcName+"(int row, int col) {\n      float index = dot(vec3(row, col, "+offset+"), vec3("+shape[1]+", 1, 1));\n      vec2 uv = vec2((index + 0.5) / "+texNumC+".0, 0.5);\n      return sampleTexture("+texName+", uv);\n    }\n  ":"\n    float "+funcName+"(int row, int col) {\n      float index = dot(vec3(row, col, "+offset+"), vec3("+shape[1]+", 1, 1));\n      vec2 uv = vec2(0.5, (index + 0.5) / "+texNumR+".0);\n      return sampleTexture("+texName+", uv);\n    }\n  "}(inInfo);case 3:return function(inputInfo){var shape=inputInfo.shapeInfo.logicalShape,texName=inputInfo.name,funcName="get"+texName.charAt(0).toUpperCase()+texName.slice(1),stride0=shape[1]*shape[2],stride1=shape[2],_a=util.squeezeShape(shape),newShape=_a.newShape,keptDims=_a.keptDims,squeezedShape=newShape;if(squeezedShape.length<shape.length){var newInputInfo=squeezeInputInfo(inputInfo,squeezedShape);return"\n        "+getSamplerFromInInfo(newInputInfo)+"\n        float "+funcName+"(int row, int col, int depth) {\n          return "+funcName+"("+getSqueezedParams(["row","col","depth"],keptDims)+");\n        }\n      "}if(inputInfo.shapeInfo.isUniform)return"\n      float "+funcName+"(int row, int col, int depth) {\n        int index = round(dot(vec3(row, col, depth),\n                          vec3("+stride0+", "+stride1+", 1)));\n        "+getUniformSampler(inputInfo)+"\n      }\n    ";var texShape=inputInfo.shapeInfo.texShape,texNumR=texShape[0],texNumC=texShape[1],flatOffset=inputInfo.shapeInfo.flatOffset;if(texNumC===stride0&&null==flatOffset)return"\n        float "+funcName+"(int row, int col, int depth) {\n          float texR = float(row);\n          float texC = dot(vec2(col, depth), vec2("+stride1+", 1));\n          vec2 uv = (vec2(texC, texR) + halfCR) /\n                     vec2("+texNumC+".0, "+texNumR+".0);\n          return sampleTexture("+texName+", uv);\n        }\n      ";if(texNumC===stride1&&null==flatOffset)return"\n    float "+funcName+"(int row, int col, int depth) {\n      float texR = dot(vec2(row, col), vec2("+shape[1]+", 1));\n      float texC = float(depth);\n      vec2 uv = (vec2(texC, texR) + halfCR) / vec2("+texNumC+".0, "+texNumR+".0);\n      return sampleTexture("+texName+", uv);\n    }\n  ";var offset=getFlatOffsetUniformName(texName);return"\n      float "+funcName+"(int row, int col, int depth) {\n        // Explicitly use integer operations as dot() only works on floats.\n        int index = row * "+stride0+" + col * "+stride1+" + depth + "+offset+";\n        vec2 uv = uvFromFlat("+texNumR+", "+texNumC+", index);\n        return sampleTexture("+texName+", uv);\n      }\n  "}(inInfo);case 4:return function(inputInfo){var shape=inputInfo.shapeInfo.logicalShape,texName=inputInfo.name,funcName="get"+texName.charAt(0).toUpperCase()+texName.slice(1),stride2=shape[3],stride1=shape[2]*stride2,stride0=shape[1]*stride1,_a=util.squeezeShape(shape),newShape=_a.newShape,keptDims=_a.keptDims;if(newShape.length<shape.length){var newInputInfo=squeezeInputInfo(inputInfo,newShape);return"\n      "+getSamplerFromInInfo(newInputInfo)+"\n      float "+funcName+"(int row, int col, int depth, int depth2) {\n        return "+funcName+"("+getSqueezedParams(["row","col","depth","depth2"],keptDims)+");\n      }\n    "}if(inputInfo.shapeInfo.isUniform)return"\n      float "+funcName+"(int row, int col, int depth, int depth2) {\n        int index = round(dot(vec4(row, col, depth, depth2),\n                          vec4("+stride0+", "+stride1+", "+stride2+", 1)));\n        "+getUniformSampler(inputInfo)+"\n      }\n    ";var flatOffset=inputInfo.shapeInfo.flatOffset,texShape=inputInfo.shapeInfo.texShape,texNumR=texShape[0],texNumC=texShape[1];if(texNumC===stride0&&null==flatOffset)return"\n      float "+funcName+"(int row, int col, int depth, int depth2) {\n        float texR = float(row);\n        float texC =\n            dot(vec3(col, depth, depth2),\n                vec3("+stride1+", "+stride2+", 1));\n        vec2 uv = (vec2(texC, texR) + halfCR) /\n                   vec2("+texNumC+".0, "+texNumR+".0);\n        return sampleTexture("+texName+", uv);\n      }\n    ";if(texNumC===stride2&&null==flatOffset)return"\n      float "+funcName+"(int row, int col, int depth, int depth2) {\n        float texR = dot(vec3(row, col, depth),\n                         vec3("+shape[1]*shape[2]+", "+shape[2]+", 1));\n        float texC = float(depth2);\n        vec2 uv = (vec2(texC, texR) + halfCR) /\n                  vec2("+texNumC+".0, "+texNumR+".0);\n        return sampleTexture("+texName+", uv);\n      }\n    ";var offset=getFlatOffsetUniformName(texName);return"\n    float "+funcName+"(int row, int col, int depth, int depth2) {\n      // Explicitly use integer operations as dot() only works on floats.\n      int index = row * "+stride0+" + col * "+stride1+" +\n          depth * "+stride2+" + depth2;\n      vec2 uv = uvFromFlat("+texNumR+", "+texNumC+", index + "+offset+");\n      return sampleTexture("+texName+", uv);\n    }\n  "}(inInfo);case 5:return function(inputInfo){var shape=inputInfo.shapeInfo.logicalShape,texName=inputInfo.name,funcName="get"+texName.charAt(0).toUpperCase()+texName.slice(1),stride3=shape[4],stride2=shape[3]*stride3,stride1=shape[2]*stride2,stride0=shape[1]*stride1,_a=util.squeezeShape(shape),newShape=_a.newShape,keptDims=_a.keptDims;if(newShape.length<shape.length){var newInputInfo=squeezeInputInfo(inputInfo,newShape);return"\n      "+getSamplerFromInInfo(newInputInfo)+"\n      float "+funcName+"(int row, int col, int depth, int depth2, int depth3) {\n        return "+funcName+"("+getSqueezedParams(["row","col","depth","depth2","depth3"],keptDims)+");\n      }\n    "}if(inputInfo.shapeInfo.isUniform)return"\n      float "+funcName+"(int row, int col, int depth, int depth2, int depth3) {\n        float index = dot(\n          vec4(row, col, depth, depth2),\n          vec4("+stride0+", "+stride1+", "+stride2+", "+stride3+")) +\n          depth3;\n        "+getUniformSampler(inputInfo)+"\n      }\n    ";var flatOffset=inputInfo.shapeInfo.flatOffset,texShape=inputInfo.shapeInfo.texShape,texNumR=texShape[0],texNumC=texShape[1];if(texNumC===stride0&&null==flatOffset)return"\n      float "+funcName+"(int row, int col, int depth, int depth2, int depth3) {\n        int texR = row;\n        float texC = dot(vec4(col, depth, depth2, depth3),\n                         vec4("+stride1+", "+stride2+", "+stride3+", 1));\n        vec2 uv = (vec2(texC, texR) + halfCR) /\n                   vec2("+texNumC+".0, "+texNumR+".0);\n        return sampleTexture("+texName+", uv);\n      }\n    ";if(texNumC===stride3&&null==flatOffset)return"\n      float "+funcName+"(int row, int col, int depth, int depth2, int depth3) {\n        float texR = dot(\n          vec4(row, col, depth, depth2),\n          vec4("+shape[1]*shape[2]*shape[3]+",\n               "+shape[2]*shape[3]+", "+shape[3]+", 1));\n        int texC = depth3;\n        vec2 uv = (vec2(texC, texR) + halfCR) /\n                  vec2("+texNumC+".0, "+texNumR+".0);\n        return sampleTexture("+texName+", uv);\n      }\n    ";var offset=getFlatOffsetUniformName(texName);return"\n    float "+funcName+"(int row, int col, int depth, int depth2, int depth3) {\n      // Explicitly use integer operations as dot() only works on floats.\n      int index = row * "+stride0+" + col * "+stride1+" + depth * "+stride2+" +\n          depth2 * "+stride3+" + depth3 + "+offset+";\n      vec2 uv = uvFromFlat("+texNumR+", "+texNumC+", index);\n      return sampleTexture("+texName+", uv);\n    }\n  "}(inInfo);case 6:return function(inputInfo){var shape=inputInfo.shapeInfo.logicalShape,texName=inputInfo.name,funcName="get"+texName.charAt(0).toUpperCase()+texName.slice(1),_a=util.squeezeShape(shape),newShape=_a.newShape,keptDims=_a.keptDims;if(newShape.length<shape.length){var newInputInfo=squeezeInputInfo(inputInfo,newShape);return"\n      "+getSamplerFromInInfo(newInputInfo)+"\n      float "+funcName+"(int row, int col, int depth,\n                    int depth2, int depth3, int depth4) {\n        return "+funcName+"("+getSqueezedParams(["row","col","depth","depth2","depth3","depth4"],keptDims)+");\n      }\n    "}var stride4=shape[5],stride3=shape[4]*stride4,stride2=shape[3]*stride3,stride1=shape[2]*stride2,stride0=shape[1]*stride1;if(inputInfo.shapeInfo.isUniform)return"\n      float "+funcName+"(int row, int col, int depth,\n                  int depth2, int depth3, int depth4) {\n        int index = round(dot(\n          vec4(row, col, depth, depth2),\n          vec4("+stride0+", "+stride1+", "+stride2+", "+stride3+")) +\n          dot(\n            vec2(depth3, depth4),\n            vec2("+stride4+", 1)));\n        "+getUniformSampler(inputInfo)+"\n      }\n    ";var flatOffset=inputInfo.shapeInfo.flatOffset,texShape=inputInfo.shapeInfo.texShape,texNumR=texShape[0],texNumC=texShape[1];if(texNumC===stride0&&null==flatOffset)return"\n      float "+funcName+"(int row, int col, int depth,\n                    int depth2, int depth3, int depth4) {\n        int texR = row;\n        float texC = dot(vec4(col, depth, depth2, depth3),\n          vec4("+stride1+", "+stride2+", "+stride3+", "+stride4+")) +\n               float(depth4);\n        vec2 uv = (vec2(texC, texR) + halfCR) /\n                   vec2("+texNumC+".0, "+texNumR+".0);\n        return sampleTexture("+texName+", uv);\n      }\n    ";if(texNumC===stride4&&null==flatOffset)return"\n      float "+funcName+"(int row, int col, int depth,\n                    int depth2, int depth3, int depth4) {\n        float texR = dot(vec4(row, col, depth, depth2),\n          vec4("+shape[1]*shape[2]*shape[3]*shape[4]+",\n               "+shape[2]*shape[3]*shape[4]+",\n               "+shape[3]*shape[4]+",\n               "+shape[4]+")) + float(depth3);\n        int texC = depth4;\n        vec2 uv = (vec2(texC, texR) + halfCR) /\n                  vec2("+texNumC+".0, "+texNumR+".0);\n        return sampleTexture("+texName+", uv);\n      }\n    ";var offset=getFlatOffsetUniformName(texName);return"\n    float "+funcName+"(int row, int col, int depth,\n                  int depth2, int depth3, int depth4) {\n      // Explicitly use integer operations as dot() only works on floats.\n      int index = row * "+stride0+" + col * "+stride1+" + depth * "+stride2+" +\n          depth2 * "+stride3+" + depth3 * "+stride4+" + depth4 + "+offset+";\n      vec2 uv = uvFromFlat("+texNumR+", "+texNumC+", index);\n      return sampleTexture("+texName+", uv);\n    }\n  "}(inInfo);default:throw new Error(shape.length+"-D input sampling is not yet supported")}}function getPackedSamplerFromInInfo(inInfo){switch(inInfo.shapeInfo.logicalShape.length){case 0:return function(inputInfo){var texName=inputInfo.name,funcName="get"+texName.charAt(0).toUpperCase()+texName.slice(1),glsl=glsl_version_1.getGlslDifferences();return"\n    vec4 "+funcName+"() {\n      return "+glsl.texture2D+"("+texName+", halfCR);\n    }\n  "}(inInfo);case 1:return function(inputInfo){var texName=inputInfo.name,funcName="get"+texName.charAt(0).toUpperCase()+texName.slice(1),texShape=inputInfo.shapeInfo.texShape,packedTexShape=[Math.ceil(texShape[0]/2),Math.ceil(texShape[1]/2)],glsl=glsl_version_1.getGlslDifferences();return"\n    vec4 "+funcName+"(int index) {\n      vec2 uv = packedUVfrom1D(\n        "+packedTexShape[0]+", "+packedTexShape[1]+", index);\n      return "+glsl.texture2D+"("+texName+", uv);\n    }\n  "}(inInfo);case 2:return function(inputInfo){var shape=inputInfo.shapeInfo.logicalShape,texName=inputInfo.name,funcName="get"+texName.charAt(0).toUpperCase()+texName.slice(1),texShape=inputInfo.shapeInfo.texShape,texNumR=texShape[0],texNumC=texShape[1],glsl=glsl_version_1.getGlslDifferences();if(null!=texShape&&util.arraysEqual(shape,texShape))return"\n      vec4 "+funcName+"(int row, int col) {\n        vec2 uv = (vec2(col, row) + halfCR) / vec2("+texNumC+".0, "+texNumR+".0);\n\n        return "+glsl.texture2D+"("+texName+", uv);\n      }\n    ";var packedTexShape=[Math.ceil(texShape[0]/2),Math.ceil(texShape[1]/2)],valuesPerRow=Math.ceil(shape[1]/2);return"\n    vec4 "+funcName+"(int row, int col) {\n      vec2 uv = packedUVfrom2D("+valuesPerRow+", "+packedTexShape[0]+", "+packedTexShape[1]+", row, col);\n      return "+glsl.texture2D+"("+texName+", uv);\n    }\n  "}(inInfo);case 3:return function(inputInfo){var shape=inputInfo.shapeInfo.logicalShape,texName=inputInfo.name,funcName="get"+texName.charAt(0).toUpperCase()+texName.slice(1),texShape=inputInfo.shapeInfo.texShape,packedTexShape=[Math.ceil(texShape[0]/2),Math.ceil(texShape[1]/2)];if(1===shape[0]){var squeezedShape=shape.slice(1),newInputInfo=squeezeInputInfo(inputInfo,squeezedShape);return"\n        "+getPackedSamplerFromInInfo(newInputInfo)+"\n        vec4 "+funcName+"(int b, int row, int col) {\n          return "+funcName+"("+getSqueezedParams(["b","row","col"],[1,2])+");\n        }\n      "}var texNumR=packedTexShape[0],texNumC=packedTexShape[1],valuesPerRow=Math.ceil(shape[2]/2),texelsInBatch=valuesPerRow*Math.ceil(shape[1]/2),glsl=glsl_version_1.getGlslDifferences();return"\n    vec4 "+funcName+"(int b, int row, int col) {\n      vec2 uv = packedUVfrom3D(\n        "+texNumR+", "+texNumC+", "+texelsInBatch+", "+valuesPerRow+", b, row, col);\n      return "+glsl.texture2D+"("+texName+", uv);\n    }\n  "}(inInfo);default:return function(inputInfo){for(var shape=inputInfo.shapeInfo.logicalShape,rank=shape.length,texName=inputInfo.name,funcName="get"+texName.charAt(0).toUpperCase()+texName.slice(1),texShape=inputInfo.shapeInfo.texShape,packedTexShape=[Math.ceil(texShape[0]/2),Math.ceil(texShape[1]/2)],texNumR=packedTexShape[0],texNumC=packedTexShape[1],valuesPerRow=Math.ceil(shape[rank-1]/2),texelsInBatch=valuesPerRow*Math.ceil(shape[rank-2]/2),params="int b, int row, int col",index="b * "+texelsInBatch+" + (row / 2) * "+valuesPerRow+" + (col / 2)",b=2;b<rank-1;b++)params="int b"+b+", "+params,texelsInBatch*=shape[rank-b-1],index="b"+b+" * "+texelsInBatch+" + "+index;var glsl=glsl_version_1.getGlslDifferences();return"\n    vec4 "+funcName+"("+params+") {\n      int index = "+index+";\n      int texR = index / "+texNumC+";\n      int texC = index - texR * "+texNumC+";\n      vec2 uv = (vec2(texC, texR) + halfCR) / vec2("+texNumC+", "+texNumR+");\n      return "+glsl.texture2D+"("+texName+", uv);\n    }\n  "}(inInfo)}}exports.makeShader=function(inputsInfo,outputShape,userCode,usesPackedTextures){var prefixSnippets=[];inputsInfo.forEach(function(x){var size=util.sizeFromShape(x.shapeInfo.logicalShape);x.shapeInfo.isUniform?prefixSnippets.push("uniform float "+x.name+(1<size?"["+size+"]":"")+";"):(prefixSnippets.push("uniform sampler2D "+x.name+";"),prefixSnippets.push("uniform int offset"+x.name+";"))});var outputSamplingSnippet,floatTextureSetOutputSnippet,inputPrefixSnippet=prefixSnippets.join("\n"),inputSamplingSnippet=inputsInfo.map(function(x){return function(inInfo,outShapeInfo,usesPackedTextures){void 0===usesPackedTextures&&(usesPackedTextures=!1);var res="";res+=usesPackedTextures?getPackedSamplerFromInInfo(inInfo):getSamplerFromInInfo(inInfo);var inShape=inInfo.shapeInfo.logicalShape,outShape=outShapeInfo.logicalShape;inShape.length<=outShape.length&&(res+=usesPackedTextures?function(inputInfo,outShapeInfo){var coordsSnippet,texName=inputInfo.name,texFuncSnippet=texName.charAt(0).toUpperCase()+texName.slice(1),funcName="get"+texFuncSnippet+"AtOutCoords",inRank=inputInfo.shapeInfo.logicalShape.length,outRank=outShapeInfo.logicalShape.length,broadcastDims=broadcast_util_1.getBroadcastDims(inputInfo.shapeInfo.logicalShape,outShapeInfo.logicalShape),type=getCoordsDataType(outRank),rankDiff=outRank-inRank,fields=["x","y","z","w","u","v"];coordsSnippet=0===inRank?"":outRank<2&&1<=broadcastDims.length?"coords = 0;":broadcastDims.map(function(d){return"coords."+fields[d+rankDiff]+" = 0;"}).join("\n");var unpackedCoordsSnippet="";unpackedCoordsSnippet=outRank<2&&0<inRank?"coords":inputInfo.shapeInfo.logicalShape.map(function(s,i){return"coords."+fields[i+rankDiff]}).join(", ");var output="return outputValue;",isInputScalar=1===util.sizeFromShape(inputInfo.shapeInfo.logicalShape),isOutputScalar=1===util.sizeFromShape(outShapeInfo.logicalShape);if(1!==inRank||isInputScalar||isOutputScalar){if(isInputScalar&&!isOutputScalar)output=1===outRank?"\n        return vec4(outputValue.x, outputValue.x, 0., 0.);\n      ":"\n        return vec4(outputValue.x);\n      ";else if(broadcastDims.length){var rows=inRank-2,cols=inRank-1;-1<broadcastDims.indexOf(rows)&&-1<broadcastDims.indexOf(cols)?output="return vec4(outputValue.x);":-1<broadcastDims.indexOf(rows)?output="return vec4(outputValue.x, outputValue.y, outputValue.x, outputValue.y);":-1<broadcastDims.indexOf(cols)&&(output="return vec4(outputValue.xx, outputValue.zz);")}}else output="\n      return vec4(outputValue.xy, outputValue.xy);\n    ";return"\n    vec4 "+funcName+"() {\n      "+type+" coords = getOutputCoords();\n      "+coordsSnippet+"\n      vec4 outputValue = get"+texFuncSnippet+"("+unpackedCoordsSnippet+");\n      "+output+"\n    }\n  "}(inInfo,outShapeInfo):function(inputInfo,outShapeInfo){var texName=inputInfo.name,texFuncSnippet=texName.charAt(0).toUpperCase()+texName.slice(1),funcName="get"+texFuncSnippet+"AtOutCoords",outTexShape=outShapeInfo.texShape,inTexShape=inputInfo.shapeInfo.texShape,inRank=inputInfo.shapeInfo.logicalShape.length,outRank=outShapeInfo.logicalShape.length;if(!inputInfo.shapeInfo.isUniform&&inRank===outRank&&null==inputInfo.shapeInfo.flatOffset&&util.arraysEqual(inTexShape,outTexShape))return"\n      float "+funcName+"() {\n        return sampleTexture("+texName+", resultUV);\n      }\n    ";var coordsSnippet,type=getCoordsDataType(outRank),broadcastDims=broadcast_util_1.getBroadcastDims(inputInfo.shapeInfo.logicalShape,outShapeInfo.logicalShape),rankDiff=outRank-inRank,fields=["x","y","z","w","u","v"];coordsSnippet=0===inRank?"":outRank<2&&1<=broadcastDims.length?"coords = 0;":broadcastDims.map(function(d){return"coords."+fields[d+rankDiff]+" = 0;"}).join("\n");var unpackedCoordsSnippet="";unpackedCoordsSnippet=outRank<2&&0<inRank?"coords":inputInfo.shapeInfo.logicalShape.map(function(s,i){return"coords."+fields[i+rankDiff]}).join(", ");return"\n    float "+funcName+"() {\n      "+type+" coords = getOutputCoords();\n      "+coordsSnippet+"\n      return get"+texFuncSnippet+"("+unpackedCoordsSnippet+");\n    }\n  "}(inInfo,outShapeInfo));return res}(x,outputShape,usesPackedTextures)}).join("\n"),outTexShape=outputShape.texShape,glsl=glsl_version_1.getGlslDifferences(),floatTextureSampleSnippet=function(glsl){return"\n    float sampleTexture(sampler2D textureSampler, vec2 uv) {\n      return "+glsl.texture2D+"(textureSampler, uv).r;\n    }\n  "}(glsl),shaderPrefix=function(glsl){return glsl.version+"\n    precision highp float;\n    precision highp int;\n    precision highp sampler2D;\n    "+glsl.varyingFs+" vec2 resultUV;\n    "+glsl.defineOutput+"\n    const vec2 halfCR = vec2(0.5, 0.5);\n\n    struct ivec5\n    {\n      int x;\n      int y;\n      int z;\n      int w;\n      int u;\n    };\n\n    struct ivec6\n    {\n      int x;\n      int y;\n      int z;\n      int w;\n      int u;\n      int v;\n    };\n\n    uniform float NAN;\n    #define isnan(value) isnan_custom(value)\n    "+glsl.defineSpecialNaN+"\n    bvec4 isnan_custom(vec4 val) {\n      return bvec4(isnan(val.x), isnan(val.y), isnan(val.z), isnan(val.w));\n    }\n\n    "+glsl.defineSpecialInf+"\n    "+glsl.defineRound+"\n\n    int imod(int x, int y) {\n      return x - y * (x / y);\n    }\n\n    int idiv(int a, int b, float sign) {\n      int res = a / b;\n      int mod = imod(a, b);\n      if (sign < 0. && mod != 0) {\n        res -= 1;\n      }\n      return res;\n    }\n\n    //Based on the work of Dave Hoskins\n    //https://www.shadertoy.com/view/4djSRW\n    #define HASHSCALE1 443.8975\n    float random(float seed){\n      vec2 p = resultUV * seed;\n      vec3 p3  = fract(vec3(p.xyx) * HASHSCALE1);\n      p3 += dot(p3, p3.yzx + 19.19);\n      return fract((p3.x + p3.y) * p3.z);\n    }\n\n    "+SAMPLE_1D_SNIPPET+"\n    "+SAMPLE_2D_SNIPPET+"\n    "+SAMPLE_3D_SNIPPET+"\n  "}(glsl);return floatTextureSetOutputSnippet=outputShape.isPacked?(outputSamplingSnippet=function(outShape,outTexShape){switch(outShape.length){case 0:return"\n    int getOutputCoords() {\n      return 0;\n    }\n  ";case 1:return function(shape,texShape){var packedTexShape=[Math.ceil(texShape[0]/2),Math.ceil(texShape[1]/2)];return 1!==packedTexShape[0]?1!==packedTexShape[1]?"\n    int getOutputCoords() {\n      ivec2 resTexRC = ivec2(resultUV.yx *\n                             vec2("+packedTexShape[0]+", "+packedTexShape[1]+"));\n      return 2 * (resTexRC.x * "+packedTexShape[1]+" + resTexRC.y);\n    }\n  ":"\n      int getOutputCoords() {\n        return 2 * int(resultUV.y * "+packedTexShape[0]+".0);\n      }\n    ":"\n      int getOutputCoords() {\n        return 2 * int(resultUV.x * "+packedTexShape[1]+".0);\n      }\n    "}(0,outTexShape);case 2:return function(shape,texShape){var packedTexShape=[Math.ceil(texShape[0]/2),Math.ceil(texShape[1]/2)];if(util.arraysEqual(shape,texShape))return"\n      ivec2 getOutputCoords() {\n        return 2 * ivec2(resultUV.yx * vec2("+packedTexShape[0]+", "+packedTexShape[1]+"));\n      }\n    ";var texelsInLogicalRow=Math.ceil(shape[1]/2);return"\n    ivec2 getOutputCoords() {\n      ivec2 resTexRC = ivec2(resultUV.yx *\n                             vec2("+packedTexShape[0]+", "+packedTexShape[1]+"));\n\n      int index = resTexRC.x * "+packedTexShape[1]+" + resTexRC.y;\n      int r = 2 * (index / "+texelsInLogicalRow+");\n      int c = imod(index, "+texelsInLogicalRow+") * 2;\n\n      return ivec2(r, c);\n    }\n  "}(outShape,outTexShape);case 3:return function(shape,texShape){var packedTexShape=[Math.ceil(texShape[0]/2),Math.ceil(texShape[1]/2)],texelsInLogicalRow=Math.ceil(shape[2]/2),texelsInBatch=texelsInLogicalRow*Math.ceil(shape[1]/2);return"\n    ivec3 getOutputCoords() {\n      ivec2 resTexRC = ivec2(resultUV.yx *\n                             vec2("+packedTexShape[0]+", "+packedTexShape[1]+"));\n      int index = resTexRC.x * "+packedTexShape[1]+" + resTexRC.y;\n\n      int b = index / "+texelsInBatch+";\n      index -= b * "+texelsInBatch+";\n\n      int r = 2 * (index / "+texelsInLogicalRow+");\n      int c = imod(index, "+texelsInLogicalRow+") * 2;\n\n      return ivec3(b, r, c);\n    }\n  "}(outShape,outTexShape);default:return function(shape,texShape){for(var packedTexShape=[Math.ceil(texShape[0]/2),Math.ceil(texShape[1]/2)],texelsInLogicalRow=Math.ceil(shape[shape.length-1]/2),texelsInBatch=texelsInLogicalRow*Math.ceil(shape[shape.length-2]/2),texelsInBatchN=texelsInBatch,batches="",coords="b, r, c",b=2;b<shape.length-1;b++)texelsInBatchN*=shape[shape.length-b-1],batches="\n      int b"+b+" = index / "+texelsInBatchN+";\n      index -= b"+b+" * "+texelsInBatchN+";\n    "+batches,coords="b"+b+", "+coords;return"\n    ivec"+shape.length+" getOutputCoords() {\n      ivec2 resTexRC = ivec2(resultUV.yx *\n                             vec2("+packedTexShape[0]+", "+packedTexShape[1]+"));\n      int index = resTexRC.x * "+packedTexShape[1]+" + resTexRC.y;\n\n      "+batches+"\n\n      int b = index / "+texelsInBatch+";\n      index -= b * "+texelsInBatch+";\n\n      int r = 2 * (index / "+texelsInLogicalRow+");\n      int c = imod(index, "+texelsInLogicalRow+") * 2;\n\n      return ivec"+shape.length+"("+coords+");\n    }\n  "}(outShape,outTexShape)}}(outputShape.logicalShape,outTexShape),function(glsl){return"\n    void setOutput(vec4 val) {\n      "+glsl.output+" = val;\n    }\n  "}(glsl)):(outputSamplingSnippet=function(outShape,outTexShape){switch(outShape.length){case 0:return"\n    int getOutputCoords() {\n      return 0;\n    }\n  ";case 1:return function(shape,texShape){return 1!==texShape[0]?1!==texShape[1]?"\n    int getOutputCoords() {\n      ivec2 resTexRC = ivec2(resultUV.yx *\n                             vec2("+texShape[0]+", "+texShape[1]+"));\n      return resTexRC.x * "+texShape[1]+" + resTexRC.y;\n    }\n  ":"\n      int getOutputCoords() {\n        return int(resultUV.y * "+texShape[0]+".0);\n      }\n    ":"\n      int getOutputCoords() {\n        return int(resultUV.x * "+texShape[1]+".0);\n      }\n    "}(0,outTexShape);case 2:return function(shape,texShape){if(util.arraysEqual(shape,texShape))return"\n      ivec2 getOutputCoords() {\n        return ivec2(resultUV.yx * vec2("+texShape[0]+", "+texShape[1]+"));\n      }\n    ";return 1!==shape[1]?1!==shape[0]?"\n    ivec2 getOutputCoords() {\n      ivec2 resTexRC = ivec2(resultUV.yx *\n                             vec2("+texShape[0]+", "+texShape[1]+"));\n      int index = resTexRC.x * "+texShape[1]+" + resTexRC.y;\n      int r = index / "+shape[1]+";\n      int c = index - r * "+shape[1]+";\n      return ivec2(r, c);\n    }\n  ":"\n      ivec2 getOutputCoords() {\n        ivec2 resTexRC = ivec2(resultUV.yx *\n                               vec2("+texShape[0]+", "+texShape[1]+"));\n        int index = resTexRC.x * "+texShape[1]+" + resTexRC.y;\n        return ivec2(0, index);\n      }\n    ":"\n      ivec2 getOutputCoords() {\n        ivec2 resTexRC = ivec2(resultUV.yx *\n                               vec2("+texShape[0]+", "+texShape[1]+"));\n        int index = resTexRC.x * "+texShape[1]+" + resTexRC.y;\n        return ivec2(index, 0);\n      }\n    "}(outShape,outTexShape);case 3:return function(shape,texShape){var coordsFromIndexSnippet=shader_util.getLogicalCoordinatesFromFlatIndex(["r","c","d"],shape);return"\n    ivec3 getOutputCoords() {\n      ivec2 resTexRC = ivec2(resultUV.yx *\n                             vec2("+texShape[0]+", "+texShape[1]+"));\n      int index = resTexRC.x * "+texShape[1]+" + resTexRC.y;\n      "+coordsFromIndexSnippet+"\n      return ivec3(r, c, d);\n    }\n  "}(outShape,outTexShape);case 4:return function(shape,texShape){var coordsFromIndexSnippet=shader_util.getLogicalCoordinatesFromFlatIndex(["r","c","d","d2"],shape);return"\n    ivec4 getOutputCoords() {\n      ivec2 resTexRC = ivec2(resultUV.yx *\n        vec2("+texShape[0]+", "+texShape[1]+"));\n      int index = resTexRC.x * "+texShape[1]+" + resTexRC.y;\n      "+coordsFromIndexSnippet+"\n      return ivec4(r, c, d, d2);\n    }\n  "}(outShape,outTexShape);case 5:return function(shape,texShape){var coordsFromIndexSnippet=shader_util.getLogicalCoordinatesFromFlatIndex(["r","c","d","d2","d3"],shape);return"\n    ivec5 getOutputCoords() {\n      ivec2 resTexRC = ivec2(resultUV.yx * vec2("+texShape[0]+",\n                             "+texShape[1]+"));\n\n      int index = resTexRC.x * "+texShape[1]+" + resTexRC.y;\n\n      "+coordsFromIndexSnippet+"\n\n      ivec5 outShape = ivec5(r, c, d, d2, d3);\n      return outShape;\n    }\n  "}(outShape,outTexShape);case 6:return function(shape,texShape){var coordsFromIndexSnippet=shader_util.getLogicalCoordinatesFromFlatIndex(["r","c","d","d2","d3","d4"],shape);return"\n    ivec6 getOutputCoords() {\n      ivec2 resTexRC = ivec2(resultUV.yx *\n        vec2("+texShape[0]+", "+texShape[1]+"));\n      int index = resTexRC.x * "+texShape[1]+" + resTexRC.y;\n\n      "+coordsFromIndexSnippet+"\n\n      ivec6 result = ivec6(r, c, d, d2, d3, d4);\n      return result;\n    }\n  "}(outShape,outTexShape);default:throw new Error(outShape.length+"-D output sampling is not yet supported")}}(outputShape.logicalShape,outTexShape),function(glsl){return"\n    void setOutput(float val) {\n      "+glsl.output+" = vec4(val, 0, 0, 0);\n    }\n  "}(glsl)),usesPackedTextures&&(shaderPrefix+=SHADER_PACKED_PREFIX),[shaderPrefix,floatTextureSampleSnippet,floatTextureSetOutputSnippet,inputPrefixSnippet,outputSamplingSnippet,inputSamplingSnippet,userCode].join("\n")};var SAMPLE_1D_SNIPPET="\nvec2 uvFromFlat(int texNumR, int texNumC, int index) {\n  int texR = index / texNumC;\n  int texC = index - texR * texNumC;\n  return (vec2(texC, texR) + halfCR) / vec2(texNumC, texNumR);\n}\nvec2 packedUVfrom1D(int texNumR, int texNumC, int index) {\n  int texelIndex = index / 2;\n  int texR = texelIndex / texNumC;\n  int texC = texelIndex - texR * texNumC;\n  return (vec2(texC, texR) + halfCR) / vec2(texNumC, texNumR);\n}\n",SAMPLE_2D_SNIPPET="\nvec2 packedUVfrom2D(int texelsInLogicalRow, int texNumR,\n  int texNumC, int row, int col) {\n  int texelIndex = (row / 2) * texelsInLogicalRow + (col / 2);\n  int texR = texelIndex / texNumC;\n  int texC = texelIndex - texR * texNumC;\n  return (vec2(texC, texR) + halfCR) / vec2(texNumC, texNumR);\n}\n",SAMPLE_3D_SNIPPET="\nvec2 packedUVfrom3D(int texNumR, int texNumC,\n    int texelsInBatch, int texelsInLogicalRow, int b,\n    int row, int col) {\n  int index = b * texelsInBatch + (row / 2) * texelsInLogicalRow + (col / 2);\n  int texR = index / texNumC;\n  int texC = index - texR * texNumC;\n  return (vec2(texC, texR) + halfCR) / vec2(texNumC, texNumR);\n}\n",SHADER_PACKED_PREFIX="\n  float getChannel(vec4 frag, vec2 innerDims) {\n    vec2 modCoord = mod(innerDims, 2.);\n    return modCoord.x == 0. ?\n      (modCoord.y == 0. ? frag.r : frag.g) :\n      (modCoord.y == 0. ? frag.b : frag.a);\n  }\n  float getChannel(vec4 frag, int dim) {\n    float modCoord = mod(float(dim), 2.);\n    return modCoord == 0. ? frag.r : frag.g;\n  }\n";function getFlatOffsetUniformName(texName){return"offset"+texName}function getUniformSampler(inputInfo){var texName=inputInfo.name,inSize=util.sizeFromShape(inputInfo.shapeInfo.logicalShape);return inSize<2?"return "+texName+";":"\n    for (int i = 0; i < "+inSize+"; i++) {\n      if (i == index) {\n        return "+texName+"[i];\n      }\n    }\n  "}function getCoordsDataType(rank){if(rank<=1)return"int";if(2===rank)return"ivec2";if(3===rank)return"ivec3";if(4===rank)return"ivec4";if(5===rank)return"ivec5";if(6===rank)return"ivec6";throw Error("GPU for rank "+rank+" is not yet supported")}function squeezeInputInfo(inInfo,squeezedShape){var newInputInfo=JSON.parse(JSON.stringify(inInfo));return newInputInfo.shapeInfo.logicalShape=squeezedShape,newInputInfo}function getSqueezedParams(params,keptDims){return keptDims.map(function(d){return params[d]}).join(", ")}exports.getCoordsDataType=getCoordsDataType},{"../../ops/broadcast_util":169,"../../util":241,"./glsl_version":98,"./shader_compiler_util":127}],127:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var util=require("../../util");function buildVec(x){return 1===x.length?""+x[0]:"vec"+x.length+"("+x.join(",")+")"}exports.getLogicalCoordinatesFromFlatIndex=function(coords,shape,index){void 0===index&&(index="index");var strides=util.computeStrides(shape);return strides.map(function(stride,i){return"int "+coords[i]+" = "+index+" / "+stride+"; "+(i===strides.length-1?"int "+coords[i+1]+" = "+index+" - "+coords[i]+" * "+stride:"index -= "+coords[i]+" * "+stride)+";"}).join("")},exports.dotify=function(x,y){if(x.length!==y.length)throw new Error("Vectors to be dotted must be of the same length -got "+x.length+" and "+y.length);for(var slices=[],nearestVec4=Math.floor(x.length/4),nearestVec4Remainder=x.length%4,i=0;i<nearestVec4;i++){var xSlice=x.slice(4*i,4*i+4),ySlice=y.slice(4*i,4*i+4);slices.push(buildVec(xSlice)+", "+buildVec(ySlice))}if(0!=nearestVec4Remainder){xSlice=x.slice(4*nearestVec4),ySlice=y.slice(4*nearestVec4);1===xSlice.length&&(xSlice=xSlice.map(function(d){return"float("+d+")"}),ySlice=ySlice.map(function(d){return"float("+d+")"})),slices.push(buildVec(xSlice)+", "+buildVec(ySlice))}return slices.map(function(d,i){return"dot("+d+")"}).join("+")},exports.getFlatIndexFrom3D=function(shape){var strides=util.computeStrides(shape).map(function(d){return d.toString()});return"\n  int getFlatIndex(ivec3 coords) {\n    return coords.x * "+strides[0]+" + coords.y * "+strides[1]+" + coords.z;\n  }\n"},exports.ENCODE_FLOAT_SNIPPET="\n  const float FLOAT_MAX = 1.70141184e38;\n  const float FLOAT_MIN = 1.17549435e-38;\n\n  lowp vec4 encode_float(highp float v) {\n    if (isnan(v)) {\n      return vec4(255, 255, 255, 255);\n    }\n\n    highp float av = abs(v);\n\n    if(av < FLOAT_MIN) {\n      return vec4(0.0, 0.0, 0.0, 0.0);\n    } else if(v > FLOAT_MAX) {\n      return vec4(0.0, 0.0, 128.0, 127.0) / 255.0;\n    } else if(v < -FLOAT_MAX) {\n      return vec4(0.0, 0.0,  128.0, 255.0) / 255.0;\n    }\n\n    highp vec4 c = vec4(0,0,0,0);\n\n    highp float e = floor(log2(av));\n    highp float m = exp2(fract(log2(av))) - 1.0;\n\n    c[2] = floor(128.0 * m);\n    m -= c[2] / 128.0;\n    c[1] = floor(32768.0 * m);\n    m -= c[1] / 32768.0;\n    c[0] = floor(8388608.0 * m);\n\n    highp float ebias = e + 127.0;\n    c[3] = floor(ebias / 2.0);\n    ebias -= c[3] * 2.0;\n    c[2] += floor(ebias) * 128.0;\n\n    c[3] += 128.0 * step(0.0, -v);\n\n    return c / 255.0;\n  }\n"},{"../../util":241}],128:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var shader_compiler_1=require("./shader_compiler"),SliceProgram=function(){function SliceProgram(destSize){this.variableNames=["source"],this.outputShape=destSize,this.rank=destSize.length;var body,dtype=shader_compiler_1.getCoordsDataType(this.rank),uniformPart="uniform int start["+this.rank+"];",sourceCoords=function(rank){{if(1===rank)return"sourceLoc";if(rank<=6)return coords.slice(0,rank).map(function(x){return"sourceLoc."+x}).join(",");throw Error("Slicing for rank "+rank+" is not yet supported")}}(this.rank);body="\n        "+dtype+" sourceLoc;\n        "+dtype+" coords = getOutputCoords();\n        "+destSize.map(function(_,i){return"sourceLoc."+coords[i]+" = start["+i+"] + coords."+coords[i]+";"}).join("\n")+"\n      ",this.userCode="\n      "+uniformPart+"\n      void main() {\n        "+body+"\n        setOutput(getSource("+sourceCoords+"));\n      }\n    "}return SliceProgram.prototype.getCustomSetupFunc=function(start){var _this=this;if(start.length!==this.rank)throw Error("The rank ("+this.rank+") of the program must match the length of start ("+start.length+")");return function(gpgpu,webGLProgram){null==_this.startLoc&&(_this.startLoc=gpgpu.getUniformLocationNoThrow(webGLProgram,"start"),null==_this.startLoc)||gpgpu.gl.uniform1iv(_this.startLoc,start)}},SliceProgram}();exports.SliceProgram=SliceProgram;var coords=["x","y","z","w","u","v"]},{"./shader_compiler":126}],129:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var packing_util_1=require("../packing_util"),shader_compiler_1=require("./shader_compiler"),SlicePackedProgram=function(){function SlicePackedProgram(destSize){this.variableNames=["source"],this.usesPackedTextures=!0,this.outputShape=destSize,this.rank=destSize.length;var dtype=shader_compiler_1.getCoordsDataType(this.rank),coords=packing_util_1.getChannels("coords",this.rank),sourceLoc=packing_util_1.getChannels("sourceLoc",this.rank),innerDims=1===this.rank?"sourceLoc":"vec2("+sourceLoc.slice(-2).join()+")",getChannel="getChannel(getSource("+sourceLoc.join()+"), "+innerDims+")",upperRow="\n      result.x = "+getChannel+";\n      if (++"+coords[this.rank-1]+" < "+destSize[this.rank-1]+") {\n        ++"+sourceLoc[this.rank-1]+";\n        result.y = "+getChannel+";\n        --"+sourceLoc[this.rank-1]+";\n      }\n    ",lowerRow=1===this.rank?"":"\n      --"+coords[this.rank-1]+";\n      if (++"+coords[this.rank-2]+" < "+destSize[this.rank-2]+") {\n        ++"+sourceLoc[this.rank-2]+";\n        result.z = "+getChannel+";\n        if (++"+coords[this.rank-1]+" < "+destSize[this.rank-1]+") {\n          ++"+sourceLoc[this.rank-1]+";\n          result.w = "+getChannel+";\n        }\n      }\n    ",sourceLocSetup=this.rank<=4?"sourceLoc = coords +\n            "+dtype+"("+destSize.map(function(_,i){return"start["+i+"]"}).join()+");":destSize.map(function(_,i){return sourceLoc[i]+" = "+coords[i]+" + start["+i+"];"}).join("\n");this.userCode="\n      uniform int start["+this.rank+"];\n      void main() {\n        "+dtype+" coords = getOutputCoords();\n        "+dtype+" sourceLoc;\n        "+sourceLocSetup+" \n        vec4 result = vec4(0.);\n        "+upperRow+"\n        "+lowerRow+"\n        setOutput(result);\n      }\n    "}return SlicePackedProgram.prototype.getCustomSetupFunc=function(start){var _this=this;if(start.length!==this.rank)throw Error("The rank ("+this.rank+") of the program must match the length of start ("+start.length+")");return function(gpgpu,webGLProgram){null==_this.startLoc&&(_this.startLoc=gpgpu.getUniformLocationNoThrow(webGLProgram,"start"),null==_this.startLoc)||gpgpu.gl.uniform1iv(_this.startLoc,start)}},SlicePackedProgram}();exports.SlicePackedProgram=SlicePackedProgram},{"../packing_util":55,"./shader_compiler":126}],130:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});function StridedSliceProgram(begin,strides,size,shrinkAxis){this.variableNames=["x"];var shape=size.filter(function(v,index){return-1===shrinkAxis.indexOf(index)});this.outputShape=shape;var rank=size.length,inputDtype=shader_compiler_1.getCoordsDataType(size.length),dtype=shader_compiler_1.getCoordsDataType(shape.length),newCoords="";if(1===rank)newCoords="coords * strides + begin";else{var outputAxis_1=0;newCoords=size.map(function(_,i){return-1===shrinkAxis.indexOf(i)?(outputAxis_1++,1===shape.length?"coords * strides["+i+"] + begin["+i+"]":"coords["+(outputAxis_1-1)+"] * strides["+i+"] + begin["+i+"]"):"begin["+i+"]"}).join(",")}this.userCode="\n      "+inputDtype+" begin = "+inputDtype+"("+begin+");\n      "+inputDtype+" strides = "+inputDtype+"("+strides+");\n\n      void main() {\n        "+dtype+" coords = getOutputCoords();\n        setOutput(getX("+newCoords+"));\n      }\n    "}var shader_compiler_1=require("./shader_compiler");exports.StridedSliceProgram=StridedSliceProgram},{"./shader_compiler":126}],131:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var environment_1=require("../../environment"),util=require("../../util");function getPackedMatrixTextureShapeWidthHeight(rows,columns){return[Math.max(1,Math.ceil(columns/2)),Math.max(1,Math.ceil(rows/2))]}!function(TextureUsage){TextureUsage[TextureUsage.RENDER=0]="RENDER",TextureUsage[TextureUsage.UPLOAD=1]="UPLOAD",TextureUsage[TextureUsage.PIXELS=2]="PIXELS",TextureUsage[TextureUsage.DOWNLOAD=3]="DOWNLOAD"}(exports.TextureUsage||(exports.TextureUsage={})),function(PhysicalTextureType){PhysicalTextureType[PhysicalTextureType.UNPACKED_FLOAT16=0]="UNPACKED_FLOAT16",PhysicalTextureType[PhysicalTextureType.UNPACKED_FLOAT32=1]="UNPACKED_FLOAT32",PhysicalTextureType[PhysicalTextureType.PACKED_4X1_UNSIGNED_BYTE=2]="PACKED_4X1_UNSIGNED_BYTE",PhysicalTextureType[PhysicalTextureType.PACKED_2X2_FLOAT32=3]="PACKED_2X2_FLOAT32",PhysicalTextureType[PhysicalTextureType.PACKED_2X2_FLOAT16=4]="PACKED_2X2_FLOAT16"}(exports.PhysicalTextureType||(exports.PhysicalTextureType={})),exports.getUnpackedMatrixTextureShapeWidthHeight=function(rows,columns){return[columns,rows]},exports.getUnpackedArraySizeFromMatrixSize=function(matrixSize,channelsPerTexture){return matrixSize*channelsPerTexture},exports.getColorMatrixTextureShapeWidthHeight=function(rows,columns){return[4*columns,rows]},exports.getDenseTexShape=function(shape){var size=util.sizeFromShape(shape),texelsNeeded=Math.ceil(size/4);return util.sizeToSquarishShape(texelsNeeded)},exports.getMatrixSizeFromUnpackedArraySize=function(unpackedSize,channelsPerTexture){if(unpackedSize%channelsPerTexture!=0)throw new Error("unpackedSize ("+unpackedSize+") must be a multiple of "+channelsPerTexture);return unpackedSize/channelsPerTexture},exports.decodeMatrixFromUnpackedColorRGBAArray=function(unpackedArray,matrix,channels){var requiredSize=unpackedArray.length*channels/4;if(matrix.length<requiredSize)throw new Error("matrix length ("+matrix.length+") must be >= "+requiredSize);for(var dst=0,src=0;src<unpackedArray.length;src+=4)for(var c=0;c<channels;c++)matrix[dst++]=unpackedArray[src+c]},exports.getPackedMatrixTextureShapeWidthHeight=getPackedMatrixTextureShapeWidthHeight,exports.getPackedRGBAArraySizeFromMatrixShape=function(rows,columns){var _a=getPackedMatrixTextureShapeWidthHeight(rows,columns);return _a[0]*_a[1]*4},exports.getTextureConfig=function(gl,textureHalfFloatExtension){var internalFormatFloat,internalFormatHalfFloat,internalFormatPackedHalfFloat,internalFormatPackedFloat,textureFormatFloat,downloadUnpackNumChannels,defaultNumChannels,textureTypeHalfFloat,textureTypeFloat,glany=gl;return textureTypeFloat=2===environment_1.ENV.getNumber("WEBGL_VERSION")?(internalFormatFloat=glany.R32F,internalFormatHalfFloat=glany.R16F,internalFormatPackedHalfFloat=glany.RGBA16F,internalFormatPackedFloat=glany.RGBA32F,textureFormatFloat=glany.RED,downloadUnpackNumChannels=4,defaultNumChannels=1,textureTypeHalfFloat=glany.HALF_FLOAT,glany.FLOAT):(internalFormatFloat=gl.RGBA,internalFormatHalfFloat=gl.RGBA,internalFormatPackedHalfFloat=gl.RGBA,internalFormatPackedFloat=glany.RGBA,textureFormatFloat=gl.RGBA,defaultNumChannels=downloadUnpackNumChannels=4,textureTypeHalfFloat=null!=textureHalfFloatExtension?textureHalfFloatExtension.HALF_FLOAT_OES:null,gl.FLOAT),{internalFormatFloat:internalFormatFloat,internalFormatHalfFloat:internalFormatHalfFloat,internalFormatPackedHalfFloat:internalFormatPackedHalfFloat,internalFormatPackedFloat:internalFormatPackedFloat,textureFormatFloat:textureFormatFloat,downloadTextureFormat:gl.RGBA,downloadUnpackNumChannels:downloadUnpackNumChannels,defaultNumChannels:defaultNumChannels,textureTypeHalfFloat:textureTypeHalfFloat,textureTypeFloat:textureTypeFloat}}},{"../../environment":144,"../../util":241}],132:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var environment_1=require("../../environment"),tex_util_1=require("./tex_util"),TextureManager=function(){function TextureManager(gpgpu){this.gpgpu=gpgpu,this.numUsedTextures=0,this.numFreeTextures=0,this.freeTextures={},this.logEnabled=!1,this.usedTextures={}}return TextureManager.prototype.acquireTexture=function(shapeRC,usage,isPacked){var newTexture,physicalTexType=getPhysicalFromLogicalTextureType(usage,isPacked),shapeKey=getKeyFromTextureShape(shapeRC,physicalTexType,isPacked);if(shapeKey in this.freeTextures||(this.freeTextures[shapeKey]=[]),shapeKey in this.usedTextures||(this.usedTextures[shapeKey]=[]),0<this.freeTextures[shapeKey].length){this.numFreeTextures--,this.numUsedTextures++,this.log();var newTexture_1=this.freeTextures[shapeKey].shift();return this.usedTextures[shapeKey].push(newTexture_1),newTexture_1}return this.numUsedTextures++,this.log(),physicalTexType===tex_util_1.PhysicalTextureType.PACKED_2X2_FLOAT32?newTexture=this.gpgpu.createPackedMatrixTexture(shapeRC[0],shapeRC[1]):physicalTexType===tex_util_1.PhysicalTextureType.PACKED_2X2_FLOAT16?newTexture=this.gpgpu.createFloat16PackedMatrixTexture(shapeRC[0],shapeRC[1]):physicalTexType===tex_util_1.PhysicalTextureType.UNPACKED_FLOAT32?newTexture=this.gpgpu.createFloat32MatrixTexture(shapeRC[0],shapeRC[1]):physicalTexType===tex_util_1.PhysicalTextureType.UNPACKED_FLOAT16?newTexture=this.gpgpu.createFloat16MatrixTexture(shapeRC[0],shapeRC[1]):physicalTexType===tex_util_1.PhysicalTextureType.PACKED_4X1_UNSIGNED_BYTE&&(newTexture=this.gpgpu.createUnsignedBytesMatrixTexture(shapeRC[0],shapeRC[1])),this.usedTextures[shapeKey].push(newTexture),newTexture},TextureManager.prototype.releaseTexture=function(texture,shape,logicalTexType,isPacked){if(null!=this.freeTextures){var shapeKey=getKeyFromTextureShape(shape,getPhysicalFromLogicalTextureType(logicalTexType,isPacked),isPacked);shapeKey in this.freeTextures||(this.freeTextures[shapeKey]=[]),this.freeTextures[shapeKey].push(texture),this.numFreeTextures++,this.numUsedTextures--;var texList=this.usedTextures[shapeKey],texIndex=texList.indexOf(texture);if(texIndex<0)throw new Error("Cannot release a texture that was never provided by this texture manager");texList.splice(texIndex,1),this.log()}},TextureManager.prototype.log=function(){if(this.logEnabled){var total=this.numFreeTextures+this.numUsedTextures;console.log("Free/Used",this.numFreeTextures+" / "+this.numUsedTextures,"("+total+")")}},TextureManager.prototype.getNumUsedTextures=function(){return this.numUsedTextures},TextureManager.prototype.getNumFreeTextures=function(){return this.numFreeTextures},TextureManager.prototype.dispose=function(){var _this=this;if(null!=this.freeTextures){for(var texShape in this.freeTextures)this.freeTextures[texShape].forEach(function(tex){_this.gpgpu.deleteMatrixTexture(tex)});for(var texShape in this.usedTextures)this.usedTextures[texShape].forEach(function(tex){_this.gpgpu.deleteMatrixTexture(tex)});this.freeTextures=null,this.usedTextures=null,this.numUsedTextures=0,this.numFreeTextures=0}},TextureManager}();function getPhysicalFromLogicalTextureType(logicalTexType,isPacked){if(logicalTexType===tex_util_1.TextureUsage.UPLOAD)return tex_util_1.PhysicalTextureType.PACKED_2X2_FLOAT32;if(logicalTexType===tex_util_1.TextureUsage.RENDER||null==logicalTexType)return isPacked?environment_1.ENV.getBool("WEBGL_RENDER_FLOAT32_ENABLED")?tex_util_1.PhysicalTextureType.PACKED_2X2_FLOAT32:tex_util_1.PhysicalTextureType.PACKED_2X2_FLOAT16:environment_1.ENV.getBool("WEBGL_RENDER_FLOAT32_ENABLED")?tex_util_1.PhysicalTextureType.UNPACKED_FLOAT32:tex_util_1.PhysicalTextureType.UNPACKED_FLOAT16;if(logicalTexType===tex_util_1.TextureUsage.DOWNLOAD||logicalTexType===tex_util_1.TextureUsage.PIXELS)return tex_util_1.PhysicalTextureType.PACKED_4X1_UNSIGNED_BYTE;throw new Error("Unknown logical texture type "+logicalTexType)}function getKeyFromTextureShape(shapeRowsCol,physicalTexType,isPacked){return shapeRowsCol[0]+"_"+shapeRowsCol[1]+"_"+physicalTexType+"_"+isPacked}exports.TextureManager=TextureManager},{"../../environment":144,"./tex_util":131}],133:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});function TileProgram(aShape,reps){this.variableNames=["A"];for(var outputShape=new Array(aShape.length),i=0;i<outputShape.length;i++)outputShape[i]=aShape[i]*reps[i];this.outputShape=outputShape,this.rank=outputShape.length;var dtype=shader_compiler_1.getCoordsDataType(this.rank),sourceCoords=function(aShape){var rank=aShape.length;if(5<rank)throw Error("Tile for rank "+rank+" is not yet supported");if(1===rank)return"imod(resRC, "+aShape[0]+")";for(var currentCoords=["resRC.x","resRC.y","resRC.z","resRC.w","resRC.u"],sourceCoords=[],i=0;i<aShape.length;i++)sourceCoords.push("imod("+currentCoords[i]+", "+aShape[i]+")");return sourceCoords.join()}(aShape);this.userCode="\n      void main() {\n        "+dtype+" resRC = getOutputCoords();\n        setOutput(getA("+sourceCoords+"));\n      }\n    "}var shader_compiler_1=require("./shader_compiler");exports.TileProgram=TileProgram},{"./shader_compiler":126}],134:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});function TransposeProgram(aShape,newDim){this.variableNames=["A"];for(var outputShape=new Array(aShape.length),i=0;i<outputShape.length;i++)outputShape[i]=aShape[newDim[i]];this.outputShape=outputShape,this.rank=outputShape.length;var dtype=shader_compiler_1.getCoordsDataType(this.rank),switched=function(newDim){var rank=newDim.length;if(6<rank)throw Error("Transpose for rank "+rank+" is not yet supported");for(var originalOrder=["resRC.x","resRC.y","resRC.z","resRC.w","resRC.u","resRC.v"],switchedCoords=new Array(rank),i=0;i<newDim.length;i++)switchedCoords[newDim[i]]=originalOrder[i];return switchedCoords.join()}(newDim);this.userCode="\n    void main() {\n      "+dtype+" resRC = getOutputCoords();\n      setOutput(getA("+switched+"));\n    }\n    "}var shader_compiler_1=require("./shader_compiler");exports.TransposeProgram=TransposeProgram},{"./shader_compiler":126}],135:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});function TransposePackedProgram(aShape,newDim){this.variableNames=["A"],this.usesPackedTextures=!0;for(var outputShape=new Array(aShape.length),i=0;i<outputShape.length;i++)outputShape[i]=aShape[newDim[i]];if(this.outputShape=outputShape,this.rank=outputShape.length,6<this.rank)throw Error("Packed transpose for rank "+this.rank+" is not yet supported.");var dtype=shader_compiler_1.getCoordsDataType(this.rank),outputOrder=packing_util_1.getVecChannels("rc",this.rank),switchedOrder=new Array(this.rank);for(i=0;i<newDim.length;i++)switchedOrder[newDim[i]]=outputOrder[i];var innerDims="vec2("+switchedOrder.slice(-2).join()+")",nextColumn="++"+outputOrder[this.rank-1]+" < "+outputShape[this.rank-1],getc="getChannel(getA("+switchedOrder.join()+"), "+innerDims+")";this.userCode="\n    void main() {\n      "+dtype+" rc = getOutputCoords();\n      vec4 result = vec4(0.);\n      result[0] = "+getc+";\n      if("+nextColumn+") {\n        result[1] = "+getc+";\n      }\n      --"+outputOrder[this.rank-1]+";\n      if(++"+outputOrder[this.rank-2]+" < "+outputShape[this.rank-2]+") {\n        result[2] = "+getc+";\n        if("+nextColumn+") {\n          result[3] = "+getc+";\n        }\n      }  \n      setOutput(result);\n    }\n    "}var packing_util_1=require("../packing_util"),shader_compiler_1=require("./shader_compiler");exports.TransposePackedProgram=TransposePackedProgram},{"../packing_util":55,"./shader_compiler":126}],136:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});function UnaryOpProgram(aShape,opSnippet){this.variableNames=["A"],this.outputShape=aShape,this.userCode="\n      float unaryOperation(float x) {\n        "+opSnippet+"\n      }\n\n      void main() {\n        float x = getAAtOutCoords();\n        float y = unaryOperation(x);\n\n        setOutput(y);\n      }\n    "}var erf_util=require("../../ops/erf_util"),selu_util=require("../../ops/selu_util");exports.UnaryOpProgram=UnaryOpProgram;var CHECK_NAN_SNIPPET="if (isnan(x)) return x;";exports.LINEAR="return x;",exports.ABS="return abs(x);",exports.RELU=CHECK_NAN_SNIPPET+"\n  return (x < 0.0) ? 0.0 : x;\n",exports.ELU="return (x >= 0.0) ? x : (exp(x) - 1.0);",exports.SELU="\n  // Stable and Attracting Fixed Point (0, 1) for Normalized Weights.\n  // see: https://arxiv.org/abs/1706.02515\n  float scaleAlpha = "+selu_util.SELU_SCALEALPHA+";\n  float scale = "+selu_util.SELU_SCALE+";\n  return (x >= 0.0) ? scale * x : scaleAlpha * (exp(x) - 1.0);\n",exports.STEP=function(alpha){return void 0===alpha&&(alpha=0),CHECK_NAN_SNIPPET+"\n    return x > 0.0 ? 1.0 : float("+alpha+");\n  "},exports.NEG="return -x;",exports.CEIL="return ceil(x);",exports.FLOOR="return floor(x);",exports.SIGN="\n  if (isnan(x)) { return 0.0; }\n  return sign(x);\n",exports.IS_NAN="return float(isnan(x));",exports.IS_INF="return float(isinf(x));",exports.IS_FINITE="return float(!isnan(x) && !isinf(x));",exports.ROUND="\n  // OpenGL ES does not support round function.\n  // The algorithm is based on banker's rounding.\n  float base = floor(x);\n  if ((x - base) < 0.5) {\n    return floor(x);\n  } else if ((x - base) > 0.5) {\n    return ceil(x);\n  } else {\n    if (mod(base, 2.0) == 0.0) {\n      return base;\n    } else {\n      return base + 1.0;\n    }\n  }\n",exports.EXP="return exp(x);",exports.EXPM1="return exp(x) - 1.0;",exports.LOG="if (x < 0.0) return NAN;\n  return log(x);",exports.LOG1P="return log(1.0 + x);",exports.SQRT="return sqrt(x);",exports.RSQRT="return inversesqrt(x);",exports.SIGMOID="return 1.0 / (1.0 + exp(-1.0 * x));",exports.SOFTPLUS="\n  float epsilon = 1.1920928955078125e-7;\n  float threshold = log(epsilon) + 2.0;\n\n  bool too_large = x > -threshold;\n  bool too_small = x < threshold;\n\n  float result;\n  float exp_x = exp(x);\n\n  if (too_large){\n    result = x;\n  }\n  else if (too_small){\n    result = exp_x;\n  }\n  else{\n    result = log(exp_x + 1.0);\n  }\n  return result;\n",exports.SIN=CHECK_NAN_SNIPPET+"\n  return sin(x);\n",exports.COS=CHECK_NAN_SNIPPET+"\n  return cos(x);\n",exports.TAN="return tan(x);",exports.ASIN="return asin(x);",exports.ACOS="return acos(x);",exports.ATAN=CHECK_NAN_SNIPPET+"\n  return atan(x);\n",exports.SINH="\n  float e2x = exp(x);\n  return (e2x - 1.0 / e2x) / 2.0;\n",exports.COSH="\n  float e2x = exp(-x);\n  return (e2x + 1.0 / e2x) / 2.0;\n",exports.TANH="\n  float e2x = exp(-2.0 * abs(x));\n  return sign(x) * (1.0 - e2x) / (1.0 + e2x);\n",exports.ASINH="return log(x + sqrt(x * x + 1.0));",exports.ACOSH=CHECK_NAN_SNIPPET+"\n  if (x < 1.0) return NAN;\n  return log(x + sqrt(x * x - 1.0));",exports.ATANH=CHECK_NAN_SNIPPET+"\n  if ((x < -1.0) || (x > 1.0)) return NAN;\n  return (log(1.0 + x) - log(1.0 - x)) / 2.0;",exports.ERF='\n  // Error function is calculated approximately with elementary function.\n  // See "Handbook of Mathematical Functions with Formulas,\n  // Graphs, and Mathematical Tables", Abramowitz and Stegun.\n  float p = '+erf_util.ERF_P+";\n  float a1 = "+erf_util.ERF_A1+";\n  float a2 = "+erf_util.ERF_A2+";\n  float a3 = "+erf_util.ERF_A3+";\n  float a4 = "+erf_util.ERF_A4+";\n  float a5 = "+erf_util.ERF_A5+";\n\n  float t = 1.0 / (1.0 + p * x);\n  return 1.0 - (((((a5*t + a4)*t) + a3)*t + a2)*t + a1)*t*exp(-x*x);\n",exports.SQUARE="return x * x;",exports.RECIPROCAL="return 1.0 / x;",exports.LOGICAL_NOT="return float(!(x >= 1.0));",exports.TO_INT="return float(int(x));",exports.CLONE="return x;"},{"../../ops/erf_util":181,"../../ops/selu_util":207}],137:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.LINEAR="return x;",exports.LOG="\n  vec4 result = log(x);\n  vec4 isNaN = vec4(lessThan(x, vec4(0.0)));\n  result.r = isNaN.r == 1.0 ? NAN : result.r;\n  result.g = isNaN.g == 1.0 ? NAN : result.g;\n  result.b = isNaN.b == 1.0 ? NAN : result.b;\n  result.a = isNaN.a == 1.0 ? NAN : result.a;\n\n  return result;\n",exports.RELU="\n  vec4 result = x * vec4(greaterThanEqual(x, vec4(0.0)));\n  bvec4 isNaN = isnan(x);\n\n  result.r = isNaN.r ? x.r : result.r;\n  result.g = isNaN.g ? x.g : result.g;\n  result.b = isNaN.b ? x.b : result.b;\n  result.a = isNaN.a ? x.a : result.a;\n\n  return result;\n";function UnaryOpPackedProgram(aShape,opSnippet){this.variableNames=["A"],this.usesPackedTextures=!0,this.outputShape=aShape,this.userCode="\n      vec4 unaryOperation(vec4 x) {\n        "+opSnippet+"\n      }\n\n      void main() {\n        vec4 x = getAAtOutCoords();\n        vec4 y = unaryOperation(x);\n\n        setOutput(y);\n      }\n    "}exports.UnaryOpPackedProgram=UnaryOpPackedProgram},{}],138:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});function UnpackProgram(outputShape){this.variableNames=["A"],this.usesPackedTextures=!0;var rank=(this.outputShape=outputShape).length,channels=packing_util_1.getChannels("rc",rank),dtype=shader_compiler_1.getCoordsDataType(rank),sourceCoords=packing_util_1.getSourceCoords(rank,channels),innerDims=channels.slice(-2),coords=rank<=1?"rc":"vec2("+innerDims.join(",")+")";this.userCode="\n      void main() {\n        "+dtype+" rc = getOutputCoords();\n        vec4 packedInput = getA("+sourceCoords+");\n\n        setOutput(getChannel(packedInput, "+coords+"));\n      }\n    "}var packing_util_1=require("../packing_util"),shader_compiler_1=require("./shader_compiler");exports.UnpackProgram=UnpackProgram},{"../packing_util":55,"./shader_compiler":126}],139:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var environment_1=require("../../environment"),util=require("../../util"),canvas_util_1=require("./canvas_util"),tex_util_1=require("./tex_util");function callAndCheck(gl,debugMode,func){var returnValue=func();return debugMode&&function(gl){var error=gl.getError();if(error!==gl.NO_ERROR)throw new Error("WebGL Error: "+getWebGLErrorMessage(gl,error))}(gl),returnValue}exports.callAndCheck=callAndCheck;function getWebGLErrorMessage(gl,status){switch(status){case gl.NO_ERROR:return"NO_ERROR";case gl.INVALID_ENUM:return"INVALID_ENUM";case gl.INVALID_VALUE:return"INVALID_VALUE";case gl.INVALID_OPERATION:return"INVALID_OPERATION";case gl.INVALID_FRAMEBUFFER_OPERATION:return"INVALID_FRAMEBUFFER_OPERATION";case gl.OUT_OF_MEMORY:return"OUT_OF_MEMORY";case gl.CONTEXT_LOST_WEBGL:return"CONTEXT_LOST_WEBGL";default:return"Unknown error code "+status}}exports.canBeRepresented=function(num){return!!(environment_1.ENV.getBool("WEBGL_RENDER_FLOAT32_ENABLED")||0===num||5.96e-8<Math.abs(num)&&Math.abs(num)<65504)},exports.getWebGLErrorMessage=getWebGLErrorMessage,exports.getExtensionOrThrow=function(gl,debug,extensionName){return throwIfNull(gl,debug,function(){return gl.getExtension(extensionName)},'Extension "'+extensionName+'" not supported on this browser.')},exports.createVertexShader=function(gl,debug,vertexShaderSource){var vertexShader=throwIfNull(gl,debug,function(){return gl.createShader(gl.VERTEX_SHADER)},"Unable to create vertex WebGLShader.");if(callAndCheck(gl,debug,function(){return gl.shaderSource(vertexShader,vertexShaderSource)}),callAndCheck(gl,debug,function(){return gl.compileShader(vertexShader)}),!1===gl.getShaderParameter(vertexShader,gl.COMPILE_STATUS))throw console.log(gl.getShaderInfoLog(vertexShader)),new Error("Failed to compile vertex shader.");return vertexShader},exports.createFragmentShader=function(gl,debug,fragmentShaderSource){var fragmentShader=throwIfNull(gl,debug,function(){return gl.createShader(gl.FRAGMENT_SHADER)},"Unable to create fragment WebGLShader.");if(callAndCheck(gl,debug,function(){return gl.shaderSource(fragmentShader,fragmentShaderSource)}),callAndCheck(gl,debug,function(){return gl.compileShader(fragmentShader)}),!1===gl.getShaderParameter(fragmentShader,gl.COMPILE_STATUS))throw function(shaderSource,shaderInfoLog){var lineNumberRegexResult=lineNumberRegex.exec(shaderInfoLog);if(null==lineNumberRegexResult)return console.log("Couldn't parse line number in error: "+shaderInfoLog),console.log(shaderSource);for(var lineNumber=+lineNumberRegexResult[1],shaderLines=shaderSource.split("\n"),pad=shaderLines.length.toString().length+2,linesWithLineNumbers=shaderLines.map(function(line,lineNumber){return util.rightPad((lineNumber+1).toString(),pad)+line}),maxLineLength=0,i=0;i<linesWithLineNumbers.length;i++)maxLineLength=Math.max(linesWithLineNumbers[i].length,maxLineLength);var beforeErrorLines=linesWithLineNumbers.slice(0,lineNumber-1),errorLine=linesWithLineNumbers.slice(lineNumber-1,lineNumber),afterErrorLines=linesWithLineNumbers.slice(lineNumber);console.log(beforeErrorLines.join("\n")),console.log(shaderInfoLog.split("\n")[0]),console.log("%c "+util.rightPad(errorLine[0],maxLineLength),"border:1px solid red; background-color:#e3d2d2; color:#a61717"),console.log(afterErrorLines.join("\n"))}(fragmentShaderSource,gl.getShaderInfoLog(fragmentShader)),new Error("Failed to compile fragment shader.");return fragmentShader};var MAX_TEXTURE_SIZE,MAX_TEXTURES_IN_SHADER,lineNumberRegex=/ERROR: [0-9]+:([0-9]+):/g;function bindTextureUnit(gl,debug,texture,textureUnit){validateTextureUnit(gl,textureUnit),callAndCheck(gl,debug,function(){return gl.activeTexture(gl.TEXTURE0+textureUnit)}),callAndCheck(gl,debug,function(){return gl.bindTexture(gl.TEXTURE_2D,texture)})}function getFramebufferErrorMessage(gl,status){switch(status){case gl.FRAMEBUFFER_INCOMPLETE_ATTACHMENT:return"FRAMEBUFFER_INCOMPLETE_ATTACHMENT";case gl.FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT:return"FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT";case gl.FRAMEBUFFER_INCOMPLETE_DIMENSIONS:return"FRAMEBUFFER_INCOMPLETE_DIMENSIONS";case gl.FRAMEBUFFER_UNSUPPORTED:return"FRAMEBUFFER_UNSUPPORTED";default:return"unknown error "+status}}function throwIfNull(gl,debug,returnTOrNull,failureMessage){var tOrNull=callAndCheck(gl,debug,function(){return returnTOrNull()});if(null==tOrNull)throw new Error(failureMessage);return tOrNull}function validateTextureUnit(gl,textureUnit){var maxTextureUnit=gl.MAX_COMBINED_TEXTURE_IMAGE_UNITS-1,glTextureUnit=textureUnit+gl.TEXTURE0;if(glTextureUnit<gl.TEXTURE0||maxTextureUnit<glTextureUnit)throw new Error("textureUnit must be in "+("[gl.TEXTURE0, gl.TEXTURE"+maxTextureUnit+"]")+".")}function getBatchDim(shape,dimsToSkip){return void 0===dimsToSkip&&(dimsToSkip=2),util.sizeFromShape(shape.slice(0,shape.length-dimsToSkip))}function getRowsCols(shape){if(0===shape.length)throw Error("Cannot get rows and columns of an empty shape array.");return[1<shape.length?shape[shape.length-2]:1,shape[shape.length-1]]}function isEven(n){return n%2==0}function hasExtension(gl,extensionName){return null!=gl.getExtension(extensionName)}function createFloatTextureAndBindToFramebuffer(gl){var texConfig=tex_util_1.getTextureConfig(gl),texture=gl.createTexture();gl.bindTexture(gl.TEXTURE_2D,texture);gl.texImage2D(gl.TEXTURE_2D,0,texConfig.internalFormatFloat,1,1,0,texConfig.textureFormatFloat,texConfig.textureTypeFloat,null);var frameBuffer=gl.createFramebuffer();gl.bindFramebuffer(gl.FRAMEBUFFER,frameBuffer),gl.framebufferTexture2D(gl.FRAMEBUFFER,gl.COLOR_ATTACHMENT0,gl.TEXTURE_2D,texture,0);var isFrameBufferComplete=gl.checkFramebufferStatus(gl.FRAMEBUFFER)===gl.FRAMEBUFFER_COMPLETE;return gl.bindTexture(gl.TEXTURE_2D,null),gl.bindFramebuffer(gl.FRAMEBUFFER,null),gl.deleteTexture(texture),gl.deleteFramebuffer(frameBuffer),isFrameBufferComplete}exports.createProgram=function(gl,debug){return throwIfNull(gl,debug,function(){return gl.createProgram()},"Unable to create WebGLProgram.")},exports.linkProgram=function(gl,debug,program){if(callAndCheck(gl,debug,function(){return gl.linkProgram(program)}),!1===gl.getProgramParameter(program,gl.LINK_STATUS))throw console.log(gl.getProgramInfoLog(program)),new Error("Failed to link vertex and fragment shaders.")},exports.validateProgram=function(gl,debug,program){if(callAndCheck(gl,debug,function(){return gl.validateProgram(program)}),!1===gl.getProgramParameter(program,gl.VALIDATE_STATUS))throw console.log(gl.getProgramInfoLog(program)),new Error("Shader program validation failed.")},exports.createStaticVertexBuffer=function(gl,debug,data){var buffer=throwIfNull(gl,debug,function(){return gl.createBuffer()},"Unable to create WebGLBuffer");return callAndCheck(gl,debug,function(){return gl.bindBuffer(gl.ARRAY_BUFFER,buffer)}),callAndCheck(gl,debug,function(){return gl.bufferData(gl.ARRAY_BUFFER,data,gl.STATIC_DRAW)}),buffer},exports.createStaticIndexBuffer=function(gl,debug,data){var buffer=throwIfNull(gl,debug,function(){return gl.createBuffer()},"Unable to create WebGLBuffer");return callAndCheck(gl,debug,function(){return gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER,buffer)}),callAndCheck(gl,debug,function(){return gl.bufferData(gl.ELEMENT_ARRAY_BUFFER,data,gl.STATIC_DRAW)}),buffer},exports.getNumChannels=function(){return 2===environment_1.ENV.getNumber("WEBGL_VERSION")?1:4},exports.createTexture=function(gl,debug){return throwIfNull(gl,debug,function(){return gl.createTexture()},"Unable to create WebGLTexture.")},exports.validateTextureSize=function(width,height){var maxTextureSize=environment_1.ENV.getNumber("WEBGL_MAX_TEXTURE_SIZE");if(width<=0||height<=0){var requested="["+width+"x"+height+"]";throw new Error("Requested texture size "+requested+" is invalid.")}if(maxTextureSize<width||maxTextureSize<height){requested="["+width+"x"+height+"]";throw new Error("Requested texture size "+requested+" greater than WebGL maximum on this browser / GPU "+("["+maxTextureSize+"x"+maxTextureSize+"]")+".")}},exports.createFramebuffer=function(gl,debug){return throwIfNull(gl,debug,function(){return gl.createFramebuffer()},"Unable to create WebGLFramebuffer.")},exports.bindVertexBufferToProgramAttribute=function(gl,debug,program,attribute,buffer,arrayEntriesPerItem,itemStrideInBytes,itemOffsetInBytes){var loc=gl.getAttribLocation(program,attribute);return-1!==loc&&(callAndCheck(gl,debug,function(){return gl.bindBuffer(gl.ARRAY_BUFFER,buffer)}),callAndCheck(gl,debug,function(){return gl.vertexAttribPointer(loc,arrayEntriesPerItem,gl.FLOAT,!1,itemStrideInBytes,itemOffsetInBytes)}),callAndCheck(gl,debug,function(){return gl.enableVertexAttribArray(loc)}),!0)},exports.bindTextureUnit=bindTextureUnit,exports.unbindTextureUnit=function(gl,debug,textureUnit){validateTextureUnit(gl,textureUnit),callAndCheck(gl,debug,function(){return gl.activeTexture(gl.TEXTURE0+textureUnit)}),callAndCheck(gl,debug,function(){return gl.bindTexture(gl.TEXTURE_2D,null)})},exports.getProgramUniformLocationOrThrow=function(gl,debug,program,uniformName){return throwIfNull(gl,debug,function(){return gl.getUniformLocation(program,uniformName)},'uniform "'+uniformName+'" not present in program.')},exports.getProgramUniformLocation=function(gl,program,uniformName){return gl.getUniformLocation(program,uniformName)},exports.bindTextureToProgramUniformSampler=function(gl,debug,program,texture,uniformSamplerLocation,textureUnit){callAndCheck(gl,debug,function(){return bindTextureUnit(gl,debug,texture,textureUnit)}),callAndCheck(gl,debug,function(){return gl.uniform1i(uniformSamplerLocation,textureUnit)})},exports.bindCanvasToFramebuffer=function(gl,debug){callAndCheck(gl,debug,function(){return gl.bindFramebuffer(gl.FRAMEBUFFER,null)}),callAndCheck(gl,debug,function(){return gl.viewport(0,0,gl.canvas.width,gl.canvas.height)}),callAndCheck(gl,debug,function(){return gl.scissor(0,0,gl.canvas.width,gl.canvas.height)})},exports.bindColorTextureToFramebuffer=function(gl,debug,texture,framebuffer){callAndCheck(gl,debug,function(){return gl.bindFramebuffer(gl.FRAMEBUFFER,framebuffer)}),callAndCheck(gl,debug,function(){return gl.framebufferTexture2D(gl.FRAMEBUFFER,gl.COLOR_ATTACHMENT0,gl.TEXTURE_2D,texture,0)})},exports.unbindColorTextureFromFramebuffer=function(gl,debug,framebuffer){callAndCheck(gl,debug,function(){return gl.bindFramebuffer(gl.FRAMEBUFFER,framebuffer)}),callAndCheck(gl,debug,function(){return gl.framebufferTexture2D(gl.FRAMEBUFFER,gl.COLOR_ATTACHMENT0,gl.TEXTURE_2D,null,0)})},exports.validateFramebuffer=function(gl){var status=gl.checkFramebufferStatus(gl.FRAMEBUFFER);if(status!==gl.FRAMEBUFFER_COMPLETE)throw new Error("Error binding framebuffer: "+getFramebufferErrorMessage(gl,status))},exports.getFramebufferErrorMessage=getFramebufferErrorMessage,exports.getBatchDim=getBatchDim,exports.getRowsCols=getRowsCols,exports.getShapeAs3D=function(shape){var shapeAs3D=[1,1,1];return 0===shape.length||1===shape.length&&1===shape[0]||(shapeAs3D=[getBatchDim(shape)].concat(getRowsCols(shape))),shapeAs3D},exports.getTextureShapeFromLogicalShape=function(logShape,isPacked){var _a;void 0===isPacked&&(isPacked=!1);var maxTexSize=environment_1.ENV.getNumber("WEBGL_MAX_TEXTURE_SIZE");if(isPacked&&(maxTexSize*=2,1===(logShape=logShape.map(function(d,i){return i>=logShape.length-2?util.nearestLargerEven(logShape[i]):logShape[i]})).length&&(logShape=[2,logShape[0]])),2!==logShape.length){var squeezeResult=util.squeezeShape(logShape);logShape=squeezeResult.newShape}var size=util.sizeFromShape(logShape);if(logShape.length<=1&&size<=maxTexSize)return[1,size];if(2===logShape.length&&logShape[0]<=maxTexSize&&logShape[1]<=maxTexSize)return logShape;if(3===logShape.length&&logShape[0]*logShape[1]<=maxTexSize&&logShape[2]<=maxTexSize)return[logShape[0]*logShape[1],logShape[2]];if(3===logShape.length&&logShape[0]<=maxTexSize&&logShape[1]*logShape[2]<=maxTexSize)return[logShape[0],logShape[1]*logShape[2]];if(4===logShape.length&&logShape[0]*logShape[1]*logShape[2]<=maxTexSize&&logShape[3]<=maxTexSize)return[logShape[0]*logShape[1]*logShape[2],logShape[3]];if(4===logShape.length&&logShape[0]<=maxTexSize&&logShape[1]*logShape[2]*logShape[3]<=maxTexSize)return[logShape[0],logShape[1]*logShape[2]*logShape[3]];if(isPacked){var batchDim=getBatchDim(logShape),rows=2,cols=2;return logShape.length&&(rows=(_a=getRowsCols(logShape))[0],cols=_a[1]),size=batchDim*(rows/2)*(cols/2),util.sizeToSquarishShape(size).map(function(d){return 2*d})}return util.sizeToSquarishShape(size)},exports.isReshapeFree=function(shape1,shape2){if(shape1=shape1.slice(-2),shape2=shape2.slice(-2),util.arraysEqual(shape1,shape2))return!0;if(!shape1.length||!shape2.length)return!0;if(0===shape1[0]||0===shape1[1]||0===shape2[0]||0===shape2[1])return!0;if(shape1.length!==shape2.length){var shape1Cols=shape1.slice(-1)[0],shape2Cols=shape2.slice(-1)[0];if(shape1Cols===shape2Cols)return!0;if(isEven(shape1Cols)&&isEven(shape2Cols)&&(1===shape1[0]||1===shape2[0]))return!0}return shape1[1]===shape2[1]&&isEven(shape1[0])&&isEven(shape2[0])},exports.getWebGLMaxTextureSize=function(webGLVersion){if(null==MAX_TEXTURE_SIZE){var gl=canvas_util_1.getWebGLContext(webGLVersion);MAX_TEXTURE_SIZE=gl.getParameter(gl.MAX_TEXTURE_SIZE)}return MAX_TEXTURE_SIZE},exports.resetMaxTextureSize=function(){MAX_TEXTURE_SIZE=null},exports.resetMaxTexturesInShader=function(){MAX_TEXTURES_IN_SHADER=null},exports.getMaxTexturesInShader=function(webGLVersion){if(null==MAX_TEXTURES_IN_SHADER){var gl=canvas_util_1.getWebGLContext(webGLVersion);MAX_TEXTURES_IN_SHADER=gl.getParameter(gl.MAX_TEXTURE_IMAGE_UNITS)}return Math.min(16,MAX_TEXTURES_IN_SHADER)},exports.getWebGLDisjointQueryTimerVersion=function(webGLVersion){if(0===webGLVersion)return 0;var gl=canvas_util_1.getWebGLContext(webGLVersion);return hasExtension(gl,"EXT_disjoint_timer_query_webgl2")&&2===webGLVersion?2:hasExtension(gl,"EXT_disjoint_timer_query")?1:0},exports.hasExtension=hasExtension,exports.isWebGLVersionEnabled=function(webGLVersion){try{if(null!=canvas_util_1.getWebGLContext(webGLVersion))return!0}catch(e){return!1}return!1},exports.isRenderToFloatTextureEnabled=function(webGLVersion){if(0===webGLVersion)return!1;var gl=canvas_util_1.getWebGLContext(webGLVersion);if(1===webGLVersion){if(!hasExtension(gl,"OES_texture_float"))return!1}else if(!hasExtension(gl,"EXT_color_buffer_float"))return!1;return createFloatTextureAndBindToFramebuffer(gl)},exports.isDownloadFloatTextureEnabled=function(webGLVersion){if(0===webGLVersion)return!1;var gl=canvas_util_1.getWebGLContext(webGLVersion);if(1===webGLVersion)return!!hasExtension(gl,"OES_texture_float")&&(!!hasExtension(gl,"WEBGL_color_buffer_float")&&createFloatTextureAndBindToFramebuffer(gl));if(hasExtension(gl,"EXT_color_buffer_float"))return createFloatTextureAndBindToFramebuffer(gl);if(hasExtension(gl,"EXT_color_buffer_half_float")){var textureHalfFloatExtension=gl.getExtension("EXT_color_buffer_half_float");return function(gl,textureHalfFloatExtension){var texConfig=tex_util_1.getTextureConfig(gl,textureHalfFloatExtension),texture=gl.createTexture();gl.bindTexture(gl.TEXTURE_2D,texture);gl.texImage2D(gl.TEXTURE_2D,0,texConfig.internalFormatHalfFloat,1,1,0,texConfig.textureFormatFloat,texConfig.textureTypeHalfFloat,null);var frameBuffer=gl.createFramebuffer();gl.bindFramebuffer(gl.FRAMEBUFFER,frameBuffer),gl.framebufferTexture2D(gl.FRAMEBUFFER,gl.COLOR_ATTACHMENT0,gl.TEXTURE_2D,texture,0);var isFrameBufferComplete=gl.checkFramebufferStatus(gl.FRAMEBUFFER)===gl.FRAMEBUFFER_COMPLETE;return gl.bindTexture(gl.TEXTURE_2D,null),gl.bindFramebuffer(gl.FRAMEBUFFER,null),gl.deleteTexture(texture),gl.deleteFramebuffer(frameBuffer),isFrameBufferComplete}(gl,textureHalfFloatExtension)}return!1},exports.isWebGLFenceEnabled=function(webGLVersion){return 2===webGLVersion&&null!=canvas_util_1.getWebGLContext(webGLVersion).fenceSync}},{"../../environment":144,"../../util":241,"./canvas_util":70,"./tex_util":131}],140:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var array_ops_1=require("../ops/array_ops");exports.whereImpl=function(condShape,condVals){for(var indices=[],i=0;i<condVals.length;i++)condVals[i]&&indices.push(i);var inBuffer=array_ops_1.buffer(condShape,"int32"),out=array_ops_1.buffer([indices.length,condShape.length],"int32");for(i=0;i<indices.length;i++){var loc=inBuffer.indexToLoc(indices[i]),offset=i*condShape.length;out.values.set(loc,offset)}return out.toTensor()}},{"../ops/array_ops":163}],141:[function(require,module,exports){(function(setImmediate){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var delayCallback="undefined"!=typeof requestAnimationFrame?requestAnimationFrame:void 0!==setImmediate?setImmediate:function(f){return f()};exports.nextFrame=function(){return new Promise(function(resolve){return delayCallback(function(){return resolve()})})}}).call(this,require("timers").setImmediate)},{timers:346}],142:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.isMobile=function(){var a=navigator.userAgent||navigator.vendor||window.opera;return/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|lge |maemo|midp|mmp|mobile.+firefox|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows ce|xda|xiino/i.test(a)||/1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(a.substr(0,4))},exports.isBrowser=function(){return"undefined"!=typeof window&&null!=window.document||"undefined"!=typeof WorkerGlobalScope}},{}],143:[function(require,module,exports){(function(process,global){"use strict";var __awaiter=this&&this.__awaiter||function(thisArg,_arguments,P,generator){return new(P=P||Promise)(function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){result.done?resolve(result.value):new P(function(resolve){resolve(result.value)}).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())})},__generator=this&&this.__generator||function(thisArg,body){var f,y,t,g,_={label:0,sent:function(){if(1&t[0])throw t[1];return t[1]},trys:[],ops:[]};return g={next:verb(0),throw:verb(1),return:verb(2)},"function"==typeof Symbol&&(g[Symbol.iterator]=function(){return this}),g;function verb(n){return function(v){return function(op){if(f)throw new TypeError("Generator is already executing.");for(;_;)try{if(f=1,y&&(t=2&op[0]?y.return:op[0]?y.throw||((t=y.return)&&t.call(y),0):y.next)&&!(t=t.call(y,op[1])).done)return t;switch(y=0,t&&(op=[2&op[0],t.value]),op[0]){case 0:case 1:t=op;break;case 4:return _.label++,{value:op[1],done:!1};case 5:_.label++,y=op[1],op=[0];continue;case 7:op=_.ops.pop(),_.trys.pop();continue;default:if(!(t=0<(t=_.trys).length&&t[t.length-1])&&(6===op[0]||2===op[0])){_=0;continue}if(3===op[0]&&(!t||op[1]>t[0]&&op[1]<t[3])){_.label=op[1];break}if(6===op[0]&&_.label<t[1]){_.label=t[1],t=op;break}if(t&&_.label<t[2]){_.label=t[2],_.ops.push(op);break}t[2]&&_.ops.pop(),_.trys.pop();continue}op=body.call(thisArg,_)}catch(e){op=[6,e],y=0}finally{f=t=0}if(5&op[0])throw op[1];return{value:op[0]?op[1]:void 0,done:!0}}([n,v])}}};Object.defineProperty(exports,"__esModule",{value:!0});var GLOBAL,environment_1=require("./environment"),profiler_1=require("./profiler"),tape_1=require("./tape"),tensor_1=require("./tensor"),tensor_util_1=require("./tensor_util"),util=require("./util"),util_1=require("./util"),EngineState=function(){function EngineState(){this.registeredVariables={},this.nextTapeNodeId=0,this.numBytes=0,this.numTensors=0,this.numStringTensors=0,this.numDataBuffers=0,this.gradientDepth=0,this.kernelDepth=0,this.scopeStack=[],this.nextScopeId=0,this.tensorInfo=new WeakMap,this.profiling=!1,this.activeProfile={newBytes:0,newTensors:0,peakBytes:0,kernels:[],result:null}}return EngineState.prototype.dispose=function(){for(var variableName in this.registeredVariables)this.registeredVariables[variableName].dispose()},EngineState}(),Engine=function(){function Engine(ENV){this.ENV=ENV,this.registry={},this.registryFactory={},this.pendingBackendInitId=0,this.state=new EngineState}return Engine.prototype.ready=function(){return __awaiter(this,void 0,void 0,function(){var sortedBackends,i,backendName;return __generator(this,function(_a){switch(_a.label){case 0:if(null!=this.pendingBackendInit)return[2,this.pendingBackendInit.then(function(){})];if(null!=this.backendInstance)return[2];sortedBackends=this.getSortedBackends(),i=0,_a.label=1;case 1:return i<sortedBackends.length?(backendName=sortedBackends[i],[4,this.initializeBackend(backendName).success]):[3,5];case 2:return _a.sent()?[4,this.setBackend(backendName)]:[3,4];case 3:return _a.sent(),[2];case 4:return i++,[3,1];case 5:throw new Error("Could not initialize any backends, all backend initializations failed.")}})})},Object.defineProperty(Engine.prototype,"backend",{get:function(){if(null!=this.pendingBackendInit)throw new Error("Backend '"+this.backendName+"' has not yet been initialized. Make sure to await tf.ready() before calling other methods");if(null==this.backendInstance){var _a=this.initializeBackendsAndReturnBest(),name_1=_a.name;if(_a.asyncInit)throw new Error("The highest priority backend '"+name_1+"' has not yet been initialized. Make sure to await tf.ready() before calling other methods");this.setBackend(name_1)}return this.backendInstance},enumerable:!0,configurable:!0}),Engine.prototype.backendNames=function(){return Object.keys(this.registryFactory)},Engine.prototype.findBackend=function(backendName){if(!(backendName in this.registry)){if(!(backendName in this.registryFactory))return null;if(this.initializeBackend(backendName).asyncInit)return null}return this.registry[backendName]},Engine.prototype.findBackendFactory=function(backendName){return backendName in this.registryFactory?this.registryFactory[backendName].factory:null},Engine.prototype.registerBackend=function(backendName,factory,priority){return void 0===priority&&(priority=1),backendName in this.registryFactory?(console.warn(backendName+" backend was already registered. Reusing existing backend factory."),!1):(this.registryFactory[backendName]={factory:factory,priority:priority},!0)},Engine.prototype.setBackend=function(backendName){return __awaiter(this,void 0,void 0,function(){var _a,success,_b;return __generator(this,function(_c){switch(_c.label){case 0:if(null==this.registryFactory[backendName])throw new Error("Backend name '"+backendName+"' not found in registry");return this.backendName=backendName,null!=this.registry[backendName]?[3,4]:(this.backendInstance=null,_a=this.initializeBackend(backendName),success=_a.success,_a.asyncInit?[4,success]:[3,2]);case 1:return _b=_c.sent(),[3,3];case 2:_b=success,_c.label=3;case 3:if(!_b)return[2,!1];_c.label=4;case 4:return this.backendInstance=this.registry[backendName],this.profiler=new profiler_1.Profiler(this.backendInstance),[2,!0]}})})},Engine.prototype.initializeBackend=function(backendName){var _this=this,registryFactoryEntry=this.registryFactory[backendName];if(null==registryFactoryEntry)throw new Error("Cannot initialize backend "+backendName+", no registration found.");try{var backend=registryFactoryEntry.factory();if(Promise.resolve(backend)!==backend)return this.registry[backendName]=backend,{success:!0,asyncInit:!1};var promiseId_1=++this.pendingBackendInitId,success=backend.then(function(backendInstance){return!(promiseId_1<_this.pendingBackendInitId)&&(_this.registry[backendName]=backendInstance,!(_this.pendingBackendInit=null))}).catch(function(err){return promiseId_1<_this.pendingBackendInitId||(_this.pendingBackendInit=null,console.warn("Initialization of backend "+backendName+" failed"),console.warn(err.stack||err.message)),!1});return{success:this.pendingBackendInit=success,asyncInit:!0}}catch(err){return console.warn("Initialization of backend "+backendName+" failed"),console.warn(err.stack||err.message),{success:!1,asyncInit:!1}}},Engine.prototype.removeBackend=function(backendName){if(!(backendName in this.registryFactory))throw new Error(backendName+" backend not found in registry");this.backendName===backendName&&null!=this.pendingBackendInit&&this.pendingBackendInitId++,backendName in this.registry&&(this.registry[backendName].dispose(),delete this.registry[backendName]),delete this.registryFactory[backendName],this.backendName===backendName&&(this.pendingBackendInit=null,this.backendName=null,this.backendInstance=null)},Engine.prototype.getSortedBackends=function(){var _this=this;if(0===Object.keys(this.registryFactory).length)throw new Error("No backend found in registry.");return Object.keys(this.registryFactory).sort(function(a,b){return _this.registryFactory[b].priority-_this.registryFactory[a].priority})},Engine.prototype.initializeBackendsAndReturnBest=function(){for(var sortedBackends=this.getSortedBackends(),i=0;i<sortedBackends.length;i++){var backendName=sortedBackends[i],_a=this.initializeBackend(backendName),success=_a.success,asyncInit=_a.asyncInit;if(asyncInit||success)return{name:backendName,asyncInit:asyncInit}}throw new Error("Could not initialize any backends, all backend initializations failed.")},Engine.prototype.moveData=function(destBackend,dataId){this.write(destBackend,dataId,this.readSync(dataId))},Engine.prototype.tidy=function(nameOrFn,fn){var result,_this=this,name=null;if(null==fn){if("function"!=typeof nameOrFn)throw new Error("Please provide a function to tidy()");fn=nameOrFn}else{if("string"!=typeof nameOrFn&&!(nameOrFn instanceof String))throw new Error("When calling with two arguments, the first argument to tidy() must be a string");if("function"!=typeof fn)throw new Error("When calling with two arguments, the 2nd argument to tidy() must be a function");name=nameOrFn}return this.scopedRun(function(){return _this.startScope(name)},function(){return _this.endScope(result)},function(){return(result=fn())instanceof Promise&&console.error("Cannot return a Promise inside of tidy."),result})},Engine.prototype.scopedRun=function(start,end,f){start();try{var res=f();return end(),res}catch(ex){throw end(),ex}},Engine.prototype.nextTensorId=function(){return Engine.nextTensorId++},Engine.prototype.nextVariableId=function(){return Engine.nextVariableId++},Engine.prototype.clone=function(x){var y=tensor_1.Tensor.make(x.shape,{dataId:x.dataId},x.dtype);return this.addTapeNode([x],y,function(dy){return[dy.toFloat()]}),y},Engine.prototype.runKernel=function(forwardFunc,inputs,backwardsFunc){function saveFunc(tensors){isTapeOn&&(saved=tensors.map(function(tensor){return _this.keep(_this.clone(tensor))}))}var result,_this=this,saved=[],isTapeOn=this.isTapeOn(),scopeName=null!=this.state.activeScope?this.state.activeScope.name:"",startingBytecount=this.state.numBytes,startingNumTensors=this.state.numTensors;if(this.scopedRun(function(){return _this.state.kernelDepth++},function(){return _this.state.kernelDepth--},function(){result=_this.ENV.getBool("DEBUG")?_this.profiler.profileKernel(scopeName,inputs,function(){return forwardFunc(_this.backend,saveFunc)}):forwardFunc(_this.backend,saveFunc)}),isTapeOn){var tapeNode={id:this.state.nextTapeNodeId++,name:scopeName,inputs:inputs,outputs:Array.isArray(result)?result:[result],saved:saved};null!=backwardsFunc&&(tapeNode.gradient=function(dy){return backwardsFunc(dy,saved)}),this.state.activeTape.push(tapeNode)}return this.state.profiling&&this.state.activeProfile.kernels.push({name:scopeName,bytesAdded:this.state.numBytes-startingBytecount,totalBytesSnapshot:this.state.numBytes,tensorsAdded:this.state.numTensors-startingNumTensors,totalTensorsSnapshot:this.state.numTensors,inputShapes:Object.keys(inputs).map(function(key){return inputs[key].shape}),outputShape:Array.isArray(result)?result.map(function(item){return item.shape}):result.shape}),result},Engine.prototype.registerTensor=function(a,backend){var refCount=this.state.tensorInfo.has(a.dataId)?this.state.tensorInfo.get(a.dataId).refCount:0;if(this.state.numTensors++,"string"===a.dtype&&this.state.numStringTensors++,0===refCount){this.state.numDataBuffers++;var bytes=0;"complex64"!==a.dtype&&"string"!==a.dtype&&(bytes=a.size*util.bytesPerElement(a.dtype)),this.state.tensorInfo.set(a.dataId,{backend:null!=backend?backend:this.backend,dtype:a.dtype,shape:a.shape,bytes:bytes,refCount:0}),this.state.numBytes+=bytes,null!=backend?backend.register(a.dataId,a.shape,a.dtype):this.backend.register(a.dataId,a.shape,a.dtype)}this.state.tensorInfo.get(a.dataId).refCount++,a instanceof tensor_1.Variable||this.track(a)},Engine.prototype.registerVariable=function(v){if(null!=this.state.registeredVariables[v.name])throw new Error("Variable with name "+v.name+" was already registered");this.state.registeredVariables[v.name]=v},Engine.prototype.disposeTensor=function(a){if(this.state.tensorInfo.has(a.dataId)){this.state.numTensors--,"string"===a.dtype&&this.state.numStringTensors--;var info=this.state.tensorInfo.get(a.dataId);info.refCount<=1?("complex64"!==a.dtype&&(this.state.numBytes-=info.bytes),this.state.numDataBuffers--,info.backend.disposeData(a.dataId),this.state.tensorInfo.delete(a.dataId)):this.state.tensorInfo.get(a.dataId).refCount--}},Engine.prototype.disposeVariables=function(){for(var varName in this.state.registeredVariables){var v=this.state.registeredVariables[varName];this.disposeVariable(v)}},Engine.prototype.disposeVariable=function(v){this.disposeTensor(v),null!=this.state.registeredVariables[v.name]&&delete this.state.registeredVariables[v.name]},Engine.prototype.memory=function(){var info=this.backend.memory();return info.numTensors=this.state.numTensors,info.numDataBuffers=this.state.numDataBuffers,info.numBytes=this.state.numBytes,0<this.state.numStringTensors&&(info.unreliable=!0,null==info.reasons&&(info.reasons=[]),info.reasons.push("Memory usage by string tensors is approximate (2 bytes per character)")),info},Engine.prototype.profile=function(query){return __awaiter(this,void 0,void 0,function(){var startBytes,startNumTensors;return __generator(this,function(_a){return this.state.profiling=!0,startBytes=this.state.numBytes,startNumTensors=this.state.numTensors,this.state.activeProfile.kernels=[],this.state.activeProfile.result=query(),this.state.profiling=!1,this.state.activeProfile.peakBytes=Math.max.apply(Math,this.state.activeProfile.kernels.map(function(d){return d.totalBytesSnapshot})),this.state.activeProfile.newBytes=this.state.numBytes-startBytes,this.state.activeProfile.newTensors=this.state.numTensors-startNumTensors,[2,this.state.activeProfile]})})},Engine.prototype.isTapeOn=function(){return 0<this.state.gradientDepth&&0===this.state.kernelDepth},Engine.prototype.addTapeNode=function(inputs,result,gradientsFunc){var inputsMap={};inputs.forEach(function(input,idx){inputsMap[idx]=input});var tapeNode={id:this.state.nextTapeNodeId++,name:this.state.activeScope.name,inputs:inputsMap,outputs:[result],gradient:function(dy){var res=gradientsFunc(dy),resMap={};return res.forEach(function(r,idx){resMap[idx]=function(){return r}}),resMap}};this.state.activeTape.push(tapeNode)},Engine.prototype.keep=function(result){return result.kept=!0,result},Engine.prototype.startTape=function(){0===this.state.gradientDepth&&(this.state.activeTape=[]),this.state.gradientDepth++},Engine.prototype.endTape=function(){this.state.gradientDepth--},Engine.prototype.startScope=function(name){var scopeInfo={track:[],name:"unnamed scope",id:this.state.nextScopeId++};name&&(scopeInfo.name=name),this.state.scopeStack.push(scopeInfo),this.state.activeScope=scopeInfo},Engine.prototype.endScope=function(result){for(var _this=this,tensorsToTrackInParent=tensor_util_1.getTensorsInContainer(result),tensorsToTrackInParentSet=new Set(tensorsToTrackInParent.map(function(t){return t.id})),i=0;i<this.state.activeScope.track.length;i++){var tensor=this.state.activeScope.track[i];tensor.kept||tensorsToTrackInParentSet.has(tensor.id)||tensor.dispose()}var oldScope=this.state.scopeStack.pop();this.state.activeScope=0===this.state.scopeStack.length?null:this.state.scopeStack[this.state.scopeStack.length-1],tensorsToTrackInParent.forEach(function(tensor){tensor.kept||tensor.scopeId!==oldScope.id||_this.track(tensor)})},Engine.prototype.gradients=function(f,xs,dy,allowNoGradients){var _this=this;if(void 0===allowNoGradients&&(allowNoGradients=!1),util.assert(0<xs.length,function(){return"gradients() received an empty list of xs."}),null!=dy&&"float32"!==dy.dtype)throw new Error("dy must have 'float32' dtype, but has '"+dy.dtype+"'");var y=this.scopedRun(function(){return _this.startTape()},function(){return _this.endTape()},function(){return _this.tidy("forward",f)});util.assert(y instanceof tensor_1.Tensor,function(){return"The result y returned by f() must be a tensor."});var filteredTape=tape_1.getFilteredNodesXToY(this.state.activeTape,xs,y);if(!allowNoGradients&&0===filteredTape.length&&0<xs.length)throw new Error("Cannot compute gradient of y=f(x) with respect to x. Make sure that the f you passed encloses all operations that lead from x to y.");return this.tidy("backward",function(){var accumulatedGradientMap={};accumulatedGradientMap[y.id]=null==dy?function(shape){var values=util_1.makeOnesTypedArray(util_1.sizeFromShape(shape),"float32");return tensor_1.Tensor.make(shape,{values:values})}(y.shape):dy,tape_1.backpropagateGradients(accumulatedGradientMap,filteredTape,function(f){return _this.tidy(f)});var grads=xs.map(function(x){return accumulatedGradientMap[x.id]});return 0===_this.state.gradientDepth&&(_this.state.activeTape.forEach(function(node){for(var key in node.saved)node.saved[key].dispose()}),_this.state.activeTape=null),{value:y,grads:grads}})},Engine.prototype.customGrad=function(f){var _this=this;return util.assert(util.isFunction(f),function(){return"The f passed in customGrad(f) must be a function."}),function(){for(var res,inputs=[],_i=0;_i<arguments.length;_i++)inputs[_i]=arguments[_i];util.assert(inputs.every(function(t){return t instanceof tensor_1.Tensor}),function(){return"The args passed in customGrad(f)(x1, x2,...) must all be tensors"});var inputMap={};return inputs.forEach(function(input,i){inputMap[i]=input}),_this.runKernel(function(_,save){return res=f.apply(void 0,inputs.concat([save])),util.assert(res.value instanceof tensor_1.Tensor,function(){return"The function f passed in customGrad(f) must return an object where `obj.value` is a tensor"}),util.assert(util.isFunction(res.gradFunc),function(){return"The function f passed in customGrad(f) must return an object where `obj.gradFunc` is a function."}),res.value},inputMap,function(dy,saved){var gradRes=res.gradFunc(dy,saved),grads=Array.isArray(gradRes)?gradRes:[gradRes];util.assert(grads.length===inputs.length,function(){return"The function f passed in customGrad(f) must return an object where `obj.gradFunc` is a function that returns the same number of tensors as inputs passed to f(...)."}),util.assert(grads.every(function(t){return t instanceof tensor_1.Tensor}),function(){return"The function f passed in customGrad(f) must return an object where `obj.gradFunc` is a function that returns a list of only tensors."});var gradMap={};return grads.forEach(function(grad,i){gradMap[i]=function(){return grad}}),gradMap})}},Engine.prototype.write=function(destBackend,dataId,values){var info=this.state.tensorInfo.get(dataId),srcBackend=info.backend;if(destBackend=destBackend||this.backend,"string"===info.dtype){var newBytes=util_1.bytesFromStringArray(values);this.state.numBytes+=newBytes-info.bytes,info.bytes=newBytes}destBackend!==srcBackend&&(srcBackend.disposeData(dataId),(info.backend=destBackend).register(dataId,info.shape,info.dtype)),destBackend.write(dataId,values)},Engine.prototype.readSync=function(dataId){return this.state.tensorInfo.get(dataId).backend.readSync(dataId)},Engine.prototype.read=function(dataId){return this.state.tensorInfo.get(dataId).backend.read(dataId)},Engine.prototype.fromPixels=function(pixels,numChannels){return this.backend.fromPixels(pixels,numChannels)},Engine.prototype.time=function(query){return __awaiter(this,void 0,void 0,function(){var start,timingInfo;return __generator(this,function(_a){switch(_a.label){case 0:return start=util_1.now(),[4,this.backend.time(query)];case 1:return(timingInfo=_a.sent()).wallMs=util_1.now()-start,[2,timingInfo]}})})},Engine.prototype.track=function(result){return null!=this.state.activeScope&&(result.scopeId=this.state.activeScope.id,this.state.activeScope.track.push(result)),result},Object.defineProperty(Engine.prototype,"registeredVariables",{get:function(){return this.state.registeredVariables},enumerable:!0,configurable:!0}),Engine.prototype.reset=function(){for(var backendName in this.pendingBackendInitId++,this.state.dispose(),this.ENV.reset(),this.state=new EngineState,this.registry)this.registry[backendName].dispose(),delete this.registry[backendName];this.backendName=null,this.backendInstance=null,this.pendingBackendInit=null},Engine.nextTensorId=0,Engine.nextVariableId=0,Engine}();exports.Engine=Engine,exports.ENGINE=function(){var ns=function(){if(null==GLOBAL){var ns=void 0;if("undefined"!=typeof window)ns=window;else if(void 0!==global)ns=global;else if(void 0!==process)ns=process;else{if("undefined"==typeof self)throw new Error("Could not find a global object");ns=self}GLOBAL=ns}return GLOBAL}();if(null==ns._tfengine){var environment=new environment_1.Environment(ns);ns._tfengine=new Engine(environment)}return environment_1.setEnvironmentGlobal(ns._tfengine.ENV),tensor_1.setTensorTracker(function(){return ns._tfengine}),ns._tfengine}()}).call(this,require("_process"),"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"./environment":144,"./profiler":231,"./tape":233,"./tensor":234,"./tensor_util":236,"./util":241,_process:337}],144:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var Environment=function(){function Environment(global){this.global=global,this.flags={},this.flagRegistry={},this.urlFlags={},this.populateURLFlags()}return Environment.prototype.setPlatform=function(platformName,platform){null!=this.platform&&console.warn("Platform "+this.platformName+" has already been set. Overwriting the platform with "+platform+"."),this.platformName=platformName,this.platform=platform},Environment.prototype.registerFlag=function(flagName,evaluationFn,setHook){if(this.flagRegistry[flagName]={evaluationFn:evaluationFn,setHook:setHook},null!=this.urlFlags[flagName]){var flagValue=this.urlFlags[flagName];console.warn("Setting feature override from URL "+flagName+": "+flagValue+"."),this.set(flagName,flagValue)}},Environment.prototype.get=function(flagName){return flagName in this.flags||(this.flags[flagName]=this.evaluateFlag(flagName)),this.flags[flagName]},Environment.prototype.getNumber=function(flagName){return this.get(flagName)},Environment.prototype.getBool=function(flagName){return this.get(flagName)},Environment.prototype.getFlags=function(){return this.flags},Object.defineProperty(Environment.prototype,"features",{get:function(){return this.flags},enumerable:!0,configurable:!0}),Environment.prototype.set=function(flagName,value){if(null==this.flagRegistry[flagName])throw new Error("Cannot set flag "+flagName+" as it has not been registered.");this.flags[flagName]=value,null!=this.flagRegistry[flagName].setHook&&this.flagRegistry[flagName].setHook(value)},Environment.prototype.evaluateFlag=function(flagName){if(null==this.flagRegistry[flagName])throw new Error("Cannot evaluate flag '"+flagName+"': no evaluation function found.");return this.flagRegistry[flagName].evaluationFn()},Environment.prototype.setFlags=function(flags){this.flags=Object.assign({},flags)},Environment.prototype.reset=function(){this.flags={},this.urlFlags={},this.populateURLFlags()},Environment.prototype.populateURLFlags=function(){var _this=this;if(void 0!==this.global&&void 0!==this.global.location&&void 0!==this.global.location.search){var urlParams=getQueryParams(this.global.location.search);if("tfjsflags"in urlParams)urlParams.tfjsflags.split(",").forEach(function(keyValue){var _a=keyValue.split(":"),key=_a[0],value=_a[1];_this.urlFlags[key]=function(flagName,value){{if("true"===(value=value.toLowerCase())||"false"===value)return"true"===value;if(""+ +value===value)return+value}throw new Error("Could not parse value flag value "+value+" for flag "+flagName+".")}(key,value)})}},Environment}();function getQueryParams(queryString){var params={};return queryString.replace(/[?&]([^=?&]+)(?:=([^&]*))?/g,function(s){for(var t=[],_i=1;_i<arguments.length;_i++)t[_i-1]=arguments[_i];return function(params,name,value){params[decodeURIComponent(name)]=decodeURIComponent(value||"")}(params,t[0],t[1]),t.join("=")}),params}exports.Environment=Environment,exports.getQueryParams=getQueryParams,exports.ENV=null,exports.setEnvironmentGlobal=function(environment){exports.ENV=environment}},{}],145:[function(require,module,exports){(function(process){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var device_util=require("./device_util"),environment_1=require("./environment");environment_1.ENV.registerFlag("DEBUG",function(){return!1},function(debugValue){debugValue&&console.warn("Debugging mode is ON. The output of every math call will be downloaded to CPU and checked for NaNs. This significantly impacts performance.")}),environment_1.ENV.registerFlag("IS_BROWSER",function(){return device_util.isBrowser()}),environment_1.ENV.registerFlag("IS_NODE",function(){return void 0!==process&&void 0!==process.versions&&void 0!==process.versions.node}),environment_1.ENV.registerFlag("IS_CHROME",function(){return"undefined"!=typeof navigator&&null!=navigator&&null!=navigator.userAgent&&/Chrome/.test(navigator.userAgent)&&/Google Inc/.test(navigator.vendor)}),environment_1.ENV.registerFlag("PROD",function(){return!1}),environment_1.ENV.registerFlag("TENSORLIKE_CHECK_SHAPE_CONSISTENCY",function(){return environment_1.ENV.getBool("DEBUG")}),environment_1.ENV.registerFlag("DEPRECATION_WARNINGS_ENABLED",function(){return!0}),environment_1.ENV.registerFlag("IS_TEST",function(){return!1})}).call(this,require("_process"))},{"./device_util":142,"./environment":144,_process:337}],146:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var engine_1=require("./engine"),environment_1=require("./environment"),tensor_1=require("./tensor"),tensor_util_1=require("./tensor_util");function deprecationWarn(msg){environment_1.ENV.getBool("DEPRECATION_WARNINGS_ENABLED")&&console.warn(msg+" You can disable deprecation warnings with tf.disableDeprecationWarnings().")}exports.enableProdMode=function(){environment_1.ENV.set("PROD",!0)},exports.enableDebugMode=function(){environment_1.ENV.set("DEBUG",!0)},exports.disableDeprecationWarnings=function(){environment_1.ENV.set("DEPRECATION_WARNINGS_ENABLED",!1),console.warn("TensorFlow.js deprecation warnings have been disabled.")},exports.deprecationWarn=deprecationWarn,tensor_1.setDeprecationWarningFn(deprecationWarn),exports.disposeVariables=function(){engine_1.ENGINE.disposeVariables()},exports.memory=function(){return engine_1.ENGINE.memory()},exports.profile=function(f){return engine_1.ENGINE.profile(f)},exports.tidy=function(nameOrFn,fn){return engine_1.ENGINE.tidy(nameOrFn,fn)},exports.dispose=function(container){tensor_util_1.getTensorsInContainer(container).forEach(function(tensor){return tensor.dispose()})},exports.keep=function(result){return engine_1.ENGINE.keep(result)},exports.time=function(f){return engine_1.ENGINE.time(f)},exports.setBackend=function(backendName){return engine_1.ENGINE.setBackend(backendName)},exports.ready=function(){return engine_1.ENGINE.ready()},exports.getBackend=function(){return engine_1.ENGINE.backendName},exports.removeBackend=function(name){engine_1.ENGINE.removeBackend(name)},exports.findBackend=function(name){return engine_1.ENGINE.findBackend(name)},exports.findBackendFactory=function(name){return engine_1.ENGINE.findBackendFactory(name)},exports.registerBackend=function(name,factory,priority){return void 0===priority&&(priority=1),engine_1.ENGINE.registerBackend(name,factory,priority)},exports.backend=function(){return engine_1.ENGINE.backend},exports.setPlatform=function(platformName,platform){environment_1.ENV.setPlatform(platformName,platform)}},{"./engine":143,"./environment":144,"./tensor":234,"./tensor_util":236}],147:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var engine_1=require("./engine"),tensor_1=require("./tensor"),tensor_util_env_1=require("./tensor_util_env"),util=require("./util");function checkGrads(grads){if(0<grads.filter(function(g){return null==g}).length)throw new Error("Cannot compute gradient of y=f(x) with respect to x. Make sure that\n    the f you passed encloses all operations that lead from x to y.")}exports.grad=function(f){return util.assert(util.isFunction(f),function(){return"The f passed in grad(f) must be a function"}),function(x,dy){var $x=tensor_util_env_1.convertToTensor(x,"x","tf.grad",null),$dy=null!=dy?tensor_util_env_1.convertToTensor(dy,"dy","tf.grad"):null;return engine_1.ENGINE.tidy(function(){var _a=engine_1.ENGINE.gradients(function(){return f($x)},[$x],$dy),value=_a.value,grads=_a.grads;return null!=$dy&&util.assertShapesMatch(value.shape,$dy.shape,"The shape of dy passed in grad(f)(x, dy) must match the shape returned by f(x)"),checkGrads(grads),grads[0]})}},exports.grads=function(f){return util.assert(util.isFunction(f),function(){return"The f passed in grads(f) must be a function"}),function(args,dy){util.assert(Array.isArray(args),function(){return"The args passed in grads(f)(args) must be an array of `Tensor`s or `TensorLike`s"});var $args=tensor_util_env_1.convertToTensorArray(args,"args","tf.grads",null),$dy=null!=dy?tensor_util_env_1.convertToTensor(dy,"dy","tf.grads"):null;return engine_1.ENGINE.tidy(function(){var _a=engine_1.ENGINE.gradients(function(){return f.apply(void 0,$args)},$args,$dy),value=_a.value,grads=_a.grads;return null!=$dy&&util.assertShapesMatch(value.shape,$dy.shape,"The shape of dy passed in grads(f)([x1,...], dy) must match the shape returned by f([x1,...])"),checkGrads(grads),grads})}},exports.valueAndGrad=function(f){return util.assert(util.isFunction(f),function(){return"The f passed in valueAndGrad(f) must be a function"}),function(x,dy){util.assert(x instanceof tensor_1.Tensor,function(){return"The x passed in valueAndGrad(f)(x) must be a tensor"}),util.assert(null==dy||dy instanceof tensor_1.Tensor,function(){return"The dy passed in valueAndGrad(f)(x, dy) must be a tensor"});var _a=engine_1.ENGINE.gradients(function(){return f(x)},[x],dy),grads=_a.grads,value=_a.value;return checkGrads(grads),{grad:grads[0],value:value}}},exports.valueAndGrads=function(f){return util.assert(util.isFunction(f),function(){return"The f passed in valueAndGrads(f) must be a function"}),function(args,dy){util.assert(Array.isArray(args)&&args.every(function(arg){return arg instanceof tensor_1.Tensor}),function(){return"The args passed in valueAndGrads(f)(args) must be array of tensors"}),util.assert(null==dy||dy instanceof tensor_1.Tensor,function(){return"The dy passed in valueAndGrads(f)(args, dy) must be a tensor"});var res=engine_1.ENGINE.gradients(function(){return f.apply(void 0,args)},args,dy);return null!=dy&&util.assertShapesMatch(res.value.shape,dy.shape,"The shape of dy passed in valueAndGrads(f)([x1,...], dy) must match the shape returned by f([x1,...])"),checkGrads(res.grads),res}},exports.variableGrads=function(f,varList){util.assert(util.isFunction(f),function(){return"The f passed in variableGrads(f) must be a function"}),util.assert(null==varList||Array.isArray(varList)&&varList.every(function(v){return v instanceof tensor_1.Variable}),function(){return"The varList passed in variableGrads(f, varList) must be an array of variables"});var specifiedVarList=null!=varList;if(!specifiedVarList)for(var varName in varList=[],engine_1.ENGINE.registeredVariables)varList.push(engine_1.ENGINE.registeredVariables[varName]);var specifiedNonTrainable=specifiedVarList?varList.filter(function(variable){return!variable.trainable}):null,originalVarCount=varList.length;varList=varList.filter(function(variable){return variable.trainable}),util.assert(0<varList.length,function(){return"variableGrads() expects at least one of the input variables to be trainable, but none of the "+originalVarCount+" variables is trainable."});var _a=engine_1.ENGINE.gradients(f,varList,null,!0),value=_a.value,grads=_a.grads;util.assert(grads.some(function(g){return null!=g}),function(){return"Cannot find a connection between any variable and the result of the loss function y=f(x). Please make sure the operations that use variables are inside the function f passed to minimize()."}),util.assert(0===value.rank,function(){return"The f passed in variableGrads(f) must return a scalar, but it returned a rank-"+value.rank+" tensor"});var namedGrads={};return varList.forEach(function(v,i){null!=grads[i]&&(namedGrads[v.name]=grads[i])}),null!=specifiedNonTrainable&&specifiedNonTrainable.forEach(function(v){return namedGrads[v.name]=null}),{value:value,grads:namedGrads}},exports.customGrad=function(f){return engine_1.ENGINE.customGrad(f)}},{"./engine":143,"./tensor":234,"./tensor_util_env":237,"./util":241}],148:[function(require,module,exports){"use strict";function __export(m){for(var p in m)exports.hasOwnProperty(p)||(exports[p]=m[p])}Object.defineProperty(exports,"__esModule",{value:!0}),require("./engine"),require("./flags"),require("./backends/webgl/backend_webgl"),require("./backends/cpu/backend_cpu"),require("./platforms/platform_browser"),require("./platforms/platform_node");var backend_util=require("./backends/backend_util");exports.backend_util=backend_util;var environment=require("./environment");exports.environment=environment;var io=require("./io/io");exports.io=io;var math=require("./math");exports.math=math;var browser=require("./ops/browser");exports.browser=browser;var serialization=require("./serialization");exports.serialization=serialization;var tensor_1=require("./tensor"),tensor_util=require("./tensor_util");exports.tensor_util=tensor_util;var test_util=require("./test_util");exports.test_util=test_util;var util=require("./util");exports.util=util;var version_1=require("./version");exports.version_core=version_1.version;var webgl=require("./webgl");exports.webgl=webgl;var adadelta_optimizer_1=require("./optimizers/adadelta_optimizer");exports.AdadeltaOptimizer=adadelta_optimizer_1.AdadeltaOptimizer;var adagrad_optimizer_1=require("./optimizers/adagrad_optimizer");exports.AdagradOptimizer=adagrad_optimizer_1.AdagradOptimizer;var adam_optimizer_1=require("./optimizers/adam_optimizer");exports.AdamOptimizer=adam_optimizer_1.AdamOptimizer;var adamax_optimizer_1=require("./optimizers/adamax_optimizer");exports.AdamaxOptimizer=adamax_optimizer_1.AdamaxOptimizer;var momentum_optimizer_1=require("./optimizers/momentum_optimizer");exports.MomentumOptimizer=momentum_optimizer_1.MomentumOptimizer;var optimizer_1=require("./optimizers/optimizer");exports.Optimizer=optimizer_1.Optimizer;var rmsprop_optimizer_1=require("./optimizers/rmsprop_optimizer");exports.RMSPropOptimizer=rmsprop_optimizer_1.RMSPropOptimizer;var sgd_optimizer_1=require("./optimizers/sgd_optimizer");exports.SGDOptimizer=sgd_optimizer_1.SGDOptimizer;var tensor_2=require("./tensor");exports.Tensor=tensor_2.Tensor,exports.TensorBuffer=tensor_2.TensorBuffer,exports.variable=tensor_2.variable,exports.Variable=tensor_2.Variable;var types_1=require("./types");exports.Rank=types_1.Rank,__export(require("./ops/ops"));var loss_ops_1=require("./ops/loss_ops");exports.Reduction=loss_ops_1.Reduction,__export(require("./train")),__export(require("./globals"));var gradients_1=require("./gradients");exports.customGrad=gradients_1.customGrad,exports.grad=gradients_1.grad,exports.grads=gradients_1.grads,exports.valueAndGrad=gradients_1.valueAndGrad,exports.valueAndGrads=gradients_1.valueAndGrads,exports.variableGrads=gradients_1.variableGrads;var environment_1=require("./environment");exports.ENV=environment_1.ENV,exports.Environment=environment_1.Environment;var browser_util_1=require("./browser_util");exports.nextFrame=browser_util_1.nextFrame;var backend_1=require("./backends/backend");exports.KernelBackend=backend_1.KernelBackend,exports.DataStorage=backend_1.DataStorage;var ops=require("./ops/ops");tensor_1.setOpHandler(ops)},{"./backends/backend":50,"./backends/backend_util":51,"./backends/cpu/backend_cpu":53,"./backends/webgl/backend_webgl":64,"./browser_util":141,"./engine":143,"./environment":144,"./flags":145,"./globals":146,"./gradients":147,"./io/io":152,"./math":162,"./ops/browser":170,"./ops/loss_ops":189,"./ops/ops":196,"./optimizers/adadelta_optimizer":220,"./optimizers/adagrad_optimizer":221,"./optimizers/adam_optimizer":222,"./optimizers/adamax_optimizer":223,"./optimizers/momentum_optimizer":224,"./optimizers/optimizer":225,"./optimizers/rmsprop_optimizer":227,"./optimizers/sgd_optimizer":228,"./platforms/platform_browser":229,"./platforms/platform_node":230,"./serialization":232,"./tensor":234,"./tensor_util":236,"./test_util":238,"./train":239,"./types":240,"./util":241,"./version":242,"./webgl":243}],149:[function(require,module,exports){"use strict";var __awaiter=this&&this.__awaiter||function(thisArg,_arguments,P,generator){return new(P=P||Promise)(function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){result.done?resolve(result.value):new P(function(resolve){resolve(result.value)}).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())})},__generator=this&&this.__generator||function(thisArg,body){var f,y,t,g,_={label:0,sent:function(){if(1&t[0])throw t[1];return t[1]},trys:[],ops:[]};return g={next:verb(0),throw:verb(1),return:verb(2)},"function"==typeof Symbol&&(g[Symbol.iterator]=function(){return this}),g;function verb(n){return function(v){return function(op){if(f)throw new TypeError("Generator is already executing.");for(;_;)try{if(f=1,y&&(t=2&op[0]?y.return:op[0]?y.throw||((t=y.return)&&t.call(y),0):y.next)&&!(t=t.call(y,op[1])).done)return t;switch(y=0,t&&(op=[2&op[0],t.value]),op[0]){case 0:case 1:t=op;break;case 4:return _.label++,{value:op[1],done:!1};case 5:_.label++,y=op[1],op=[0];continue;case 7:op=_.ops.pop(),_.trys.pop();continue;default:if(!(t=0<(t=_.trys).length&&t[t.length-1])&&(6===op[0]||2===op[0])){_=0;continue}if(3===op[0]&&(!t||op[1]>t[0]&&op[1]<t[3])){_.label=op[1];break}if(6===op[0]&&_.label<t[1]){_.label=t[1],t=op;break}if(t&&_.label<t[2]){_.label=t[2],_.ops.push(op);break}t[2]&&_.ops.pop(),_.trys.pop();continue}op=body.call(thisArg,_)}catch(e){op=[6,e],y=0}finally{f=t=0}if(5&op[0])throw op[1];return{value:op[0]?op[1]:void 0,done:!0}}([n,v])}}};Object.defineProperty(exports,"__esModule",{value:!0});var environment_1=require("../environment"),io_utils_1=require("./io_utils"),router_registry_1=require("./router_registry");function defer(f){return new Promise(function(resolve){return setTimeout(resolve)}).then(f)}var BrowserDownloads=function(){function BrowserDownloads(fileNamePrefix){if(!environment_1.ENV.getBool("IS_BROWSER"))throw new Error("browserDownloads() cannot proceed because the current environment is not a browser.");fileNamePrefix.startsWith(BrowserDownloads.URL_SCHEME)&&(fileNamePrefix=fileNamePrefix.slice(BrowserDownloads.URL_SCHEME.length)),null!=fileNamePrefix&&0!==fileNamePrefix.length||(fileNamePrefix="model"),this.modelTopologyFileName=fileNamePrefix+".json",this.weightDataFileName=fileNamePrefix+".weights.bin"}return BrowserDownloads.prototype.save=function(modelArtifacts){return __awaiter(this,void 0,void 0,function(){var weightsURL,weightsManifest,modelTopologyAndWeightManifest,modelTopologyAndWeightManifestURL,jsonAnchor_1,weightDataAnchor_1;return __generator(this,function(_a){switch(_a.label){case 0:if("undefined"==typeof document)throw new Error("Browser downloads are not supported in this environment since `document` is not present");if(weightsURL=window.URL.createObjectURL(new Blob([modelArtifacts.weightData],{type:"application/octet-stream"})),!(modelArtifacts.modelTopology instanceof ArrayBuffer))return[3,1];throw new Error("BrowserDownloads.save() does not support saving model topology in binary formats yet.");case 1:return weightsManifest=[{paths:["./"+this.weightDataFileName],weights:modelArtifacts.weightSpecs}],modelTopologyAndWeightManifest={modelTopology:modelArtifacts.modelTopology,format:modelArtifacts.format,generatedBy:modelArtifacts.generatedBy,convertedBy:modelArtifacts.convertedBy,weightsManifest:weightsManifest},modelTopologyAndWeightManifestURL=window.URL.createObjectURL(new Blob([JSON.stringify(modelTopologyAndWeightManifest)],{type:"application/json"})),(jsonAnchor_1=null==this.jsonAnchor?document.createElement("a"):this.jsonAnchor).download=this.modelTopologyFileName,jsonAnchor_1.href=modelTopologyAndWeightManifestURL,[4,defer(function(){return jsonAnchor_1.dispatchEvent(new MouseEvent("click"))})];case 2:return _a.sent(),null==modelArtifacts.weightData?[3,4]:((weightDataAnchor_1=null==this.weightDataAnchor?document.createElement("a"):this.weightDataAnchor).download=this.weightDataFileName,weightDataAnchor_1.href=weightsURL,[4,defer(function(){return weightDataAnchor_1.dispatchEvent(new MouseEvent("click"))})]);case 3:_a.sent(),_a.label=4;case 4:return[2,{modelArtifactsInfo:io_utils_1.getModelArtifactsInfoForJSON(modelArtifacts)}]}})})},BrowserDownloads.URL_SCHEME="downloads://",BrowserDownloads}();exports.BrowserDownloads=BrowserDownloads;var BrowserFiles=function(){function BrowserFiles(files){if(null==files||files.length<1)throw new Error("When calling browserFiles, at least 1 file is required, but received "+files);this.files=files}return BrowserFiles.prototype.load=function(){return __awaiter(this,void 0,void 0,function(){var jsonFile,weightFiles,_this=this;return __generator(this,function(_a){return jsonFile=this.files[0],weightFiles=this.files.slice(1),[2,new Promise(function(resolve,reject){var jsonReader=new FileReader;jsonReader.onload=function(event){var modelJSON=JSON.parse(event.target.result),modelTopology=modelJSON.modelTopology;if(null!=modelTopology){0===weightFiles.length&&resolve({modelTopology:modelTopology});var weightsManifest=modelJSON.weightsManifest;if(null!=weightsManifest){var pathToFile;try{pathToFile=_this.checkManifestAndWeightFiles(weightsManifest,weightFiles)}catch(err){return void reject(err)}var weightSpecs=[],paths=[],perFileBuffers=[];weightsManifest.forEach(function(weightsGroup){weightsGroup.paths.forEach(function(path){paths.push(path),perFileBuffers.push(null)}),weightSpecs.push.apply(weightSpecs,weightsGroup.weights)}),weightsManifest.forEach(function(weightsGroup){weightsGroup.paths.forEach(function(path){var weightFileReader=new FileReader;weightFileReader.onload=function(event){var weightData=event.target.result,index=paths.indexOf(path);perFileBuffers[index]=weightData,-1===perFileBuffers.indexOf(null)&&resolve({modelTopology:modelTopology,weightSpecs:weightSpecs,weightData:io_utils_1.concatenateArrayBuffers(perFileBuffers)})},weightFileReader.onerror=function(error){return reject("Failed to weights data from file of path '"+path+"'.")},weightFileReader.readAsArrayBuffer(pathToFile[path])})})}else reject(new Error("weightManifest field is missing from file "+jsonFile.name))}else reject(new Error("modelTopology field is missing from file "+jsonFile.name))},jsonReader.onerror=function(error){return reject("Failed to read model topology and weights manifest JSON from file '"+jsonFile.name+"'. BrowserFiles supports loading Keras-style tf.Model artifacts only.")},jsonReader.readAsText(jsonFile)})]})})},BrowserFiles.prototype.checkManifestAndWeightFiles=function(manifest,files){for(var basenames=[],fileNames=files.map(function(file){return io_utils_1.basename(file.name)}),pathToFile={},_i=0,manifest_1=manifest;_i<manifest_1.length;_i++){manifest_1[_i].paths.forEach(function(path){var pathBasename=io_utils_1.basename(path);if(-1!==basenames.indexOf(pathBasename))throw new Error("Duplicate file basename found in weights manifest: '"+pathBasename+"'");if(basenames.push(pathBasename),-1===fileNames.indexOf(pathBasename))throw new Error("Weight file with basename '"+pathBasename+"' is not provided.");pathToFile[path]=files[fileNames.indexOf(pathBasename)]})}if(basenames.length!==files.length)throw new Error("Mismatch in the number of files in weights manifest ("+basenames.length+") and the number of weight files provided ("+files.length+").");return pathToFile},BrowserFiles}();function browserDownloads(fileNamePrefix){return void 0===fileNamePrefix&&(fileNamePrefix="model"),new BrowserDownloads(fileNamePrefix)}exports.browserDownloadsRouter=function(url){return environment_1.ENV.getBool("IS_BROWSER")&&!Array.isArray(url)&&url.startsWith(BrowserDownloads.URL_SCHEME)?browserDownloads(url.slice(BrowserDownloads.URL_SCHEME.length)):null},router_registry_1.IORouterRegistry.registerSaveRouter(exports.browserDownloadsRouter),exports.browserDownloads=browserDownloads,exports.browserFiles=function(files){return new BrowserFiles(files)}},{"../environment":144,"./io_utils":153,"./router_registry":158}],150:[function(require,module,exports){"use strict";var __awaiter=this&&this.__awaiter||function(thisArg,_arguments,P,generator){return new(P=P||Promise)(function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){result.done?resolve(result.value):new P(function(resolve){resolve(result.value)}).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())})},__generator=this&&this.__generator||function(thisArg,body){var f,y,t,g,_={label:0,sent:function(){if(1&t[0])throw t[1];return t[1]},trys:[],ops:[]};return g={next:verb(0),throw:verb(1),return:verb(2)},"function"==typeof Symbol&&(g[Symbol.iterator]=function(){return this}),g;function verb(n){return function(v){return function(op){if(f)throw new TypeError("Generator is already executing.");for(;_;)try{if(f=1,y&&(t=2&op[0]?y.return:op[0]?y.throw||((t=y.return)&&t.call(y),0):y.next)&&!(t=t.call(y,op[1])).done)return t;switch(y=0,t&&(op=[2&op[0],t.value]),op[0]){case 0:case 1:t=op;break;case 4:return _.label++,{value:op[1],done:!1};case 5:_.label++,y=op[1],op=[0];continue;case 7:op=_.ops.pop(),_.trys.pop();continue;default:if(!(t=0<(t=_.trys).length&&t[t.length-1])&&(6===op[0]||2===op[0])){_=0;continue}if(3===op[0]&&(!t||op[1]>t[0]&&op[1]<t[3])){_.label=op[1];break}if(6===op[0]&&_.label<t[1]){_.label=t[1],t=op;break}if(t&&_.label<t[2]){_.label=t[2],_.ops.push(op);break}t[2]&&_.ops.pop(),_.trys.pop();continue}op=body.call(thisArg,_)}catch(e){op=[6,e],y=0}finally{f=t=0}if(5&op[0])throw op[1];return{value:op[0]?op[1]:void 0,done:!0}}([n,v])}}};Object.defineProperty(exports,"__esModule",{value:!0});var environment_1=require("../environment"),util_1=require("../util"),io_utils_1=require("./io_utils"),router_registry_1=require("./router_registry"),weights_loader_1=require("./weights_loader"),HTTPRequest=function(){function HTTPRequest(path,loadOptions){if(this.DEFAULT_METHOD="POST",null==loadOptions&&(loadOptions={}),this.weightPathPrefix=loadOptions.weightPathPrefix,this.onProgress=loadOptions.onProgress,null!=loadOptions.fetchFunc?(util_1.assert("function"==typeof loadOptions.fetchFunc,function(){return"Must pass a function that matches the signature of `fetch` (see https://developer.mozilla.org/en-US/docs/Web/API/Fetch_API)"}),this.fetch=loadOptions.fetchFunc):this.fetch=environment_1.ENV.platform.fetch,util_1.assert(null!=path&&0<path.length,function(){return"URL path for http must not be null, undefined or empty."}),Array.isArray(path)&&util_1.assert(2===path.length,function(){return"URL paths for http must have a length of 2, (actual length is "+path.length+")."}),this.path=path,null!=loadOptions.requestInit&&null!=loadOptions.requestInit.body)throw new Error("requestInit is expected to have no pre-existing body, but has one.");this.requestInit=loadOptions.requestInit||{}}return HTTPRequest.prototype.save=function(modelArtifacts){return __awaiter(this,void 0,void 0,function(){var init,weightsManifest,modelTopologyAndWeightManifest,response;return __generator(this,function(_a){switch(_a.label){case 0:if(modelArtifacts.modelTopology instanceof ArrayBuffer)throw new Error("BrowserHTTPRequest.save() does not support saving model topology in binary formats yet.");return(init=Object.assign({method:this.DEFAULT_METHOD},this.requestInit)).body=new FormData,weightsManifest=[{paths:["./model.weights.bin"],weights:modelArtifacts.weightSpecs}],modelTopologyAndWeightManifest={modelTopology:modelArtifacts.modelTopology,format:modelArtifacts.format,generatedBy:modelArtifacts.generatedBy,convertedBy:modelArtifacts.convertedBy,weightsManifest:weightsManifest},init.body.append("model.json",new Blob([JSON.stringify(modelTopologyAndWeightManifest)],{type:"application/json"}),"model.json"),null!=modelArtifacts.weightData&&init.body.append("model.weights.bin",new Blob([modelArtifacts.weightData],{type:"application/octet-stream"}),"model.weights.bin"),[4,this.fetch(this.path,init)];case 1:if((response=_a.sent()).ok)return[2,{modelArtifactsInfo:io_utils_1.getModelArtifactsInfoForJSON(modelArtifacts),responses:[response]}];throw new Error("BrowserHTTPRequest.save() failed due to HTTP response status "+response.status+".")}})})},HTTPRequest.prototype.load=function(){return __awaiter(this,void 0,void 0,function(){var modelConfigRequest,modelConfig,message,modelTopology,weightsManifest,weightSpecs,weightData,results;return __generator(this,function(_a){switch(_a.label){case 0:return[4,this.fetch(this.path,this.requestInit)];case 1:if(!(modelConfigRequest=_a.sent()).ok)throw new Error("Request to "+this.path+" failed with status code "+modelConfigRequest.status+". Please verify this URL points to the model JSON of the model to load.");_a.label=2;case 2:return _a.trys.push([2,4,,5]),[4,modelConfigRequest.json()];case 3:return modelConfig=_a.sent(),[3,5];case 4:throw _a.sent(),message="Failed to parse model JSON of response from "+this.path+".",this.path.endsWith(".pb")?message+=" Your path contains a .pb file extension. Support for .pb models have been removed in TensorFlow.js 1.0 in favor of .json models. You can re-convert your Python TensorFlow model using the TensorFlow.js 1.0 conversion scripts or you can convert your.pb models with the 'pb2json'NPM script in the tensorflow/tfjs-converter repository.":message+=" Please make sure the server is serving valid JSON for this request.",new Error(message);case 5:if(modelTopology=modelConfig.modelTopology,weightsManifest=modelConfig.weightsManifest,null==modelTopology&&null==weightsManifest)throw new Error("The JSON from HTTP path "+this.path+" contains neither model topology or manifest for weights.");return null==weightsManifest?[3,7]:[4,this.loadWeights(weightsManifest)];case 6:results=_a.sent(),weightSpecs=results[0],weightData=results[1],_a.label=7;case 7:return[2,{modelTopology:modelTopology,weightSpecs:weightSpecs,weightData:weightData}]}})})},HTTPRequest.prototype.loadWeights=function(weightsManifest){return __awaiter(this,void 0,void 0,function(){var weightPath,_a,prefix,suffix,pathPrefix,weightSpecs,_i,weightsManifest_1,entry,fetchURLs,buffers;return __generator(this,function(_b){switch(_b.label){case 0:for(weightPath=Array.isArray(this.path)?this.path[1]:this.path,_a=parseUrl(weightPath),prefix=_a[0],suffix=_a[1],pathPrefix=this.weightPathPrefix||prefix,weightSpecs=[],_i=0,weightsManifest_1=weightsManifest;_i<weightsManifest_1.length;_i++)entry=weightsManifest_1[_i],weightSpecs.push.apply(weightSpecs,entry.weights);return fetchURLs=[],weightsManifest.forEach(function(weightsGroup){weightsGroup.paths.forEach(function(path){fetchURLs.push(pathPrefix+path+suffix)})}),[4,weights_loader_1.loadWeightsAsArrayBuffer(fetchURLs,{requestInit:this.requestInit,fetchFunc:this.fetch,onProgress:this.onProgress})];case 1:return buffers=_b.sent(),[2,[weightSpecs,io_utils_1.concatenateArrayBuffers(buffers)]]}})})},HTTPRequest.URL_SCHEME_REGEX=/^https?:\/\//,HTTPRequest}();function parseUrl(url){var lastSlash=url.lastIndexOf("/"),lastSearchParam=url.lastIndexOf("?");return[url.substring(0,lastSlash)+"/",lastSlash<lastSearchParam?url.substring(lastSearchParam):""]}function isHTTPScheme(url){return null!=url.match(HTTPRequest.URL_SCHEME_REGEX)}function http(path,loadOptions){return new HTTPRequest(path,loadOptions)}exports.HTTPRequest=HTTPRequest,exports.parseUrl=parseUrl,exports.isHTTPScheme=isHTTPScheme,exports.httpRouter=function(url,onProgress){if("undefined"==typeof fetch)return null;return(Array.isArray(url)?url.every(function(urlItem){return isHTTPScheme(urlItem)}):isHTTPScheme(url))?http(url,{onProgress:onProgress}):null},router_registry_1.IORouterRegistry.registerSaveRouter(exports.httpRouter),router_registry_1.IORouterRegistry.registerLoadRouter(exports.httpRouter),exports.http=http,exports.browserHTTPRequest=function(path,loadOptions){return http(path,loadOptions)}},{"../environment":144,"../util":241,"./io_utils":153,"./router_registry":158,"./weights_loader":160}],151:[function(require,module,exports){"use strict";var __awaiter=this&&this.__awaiter||function(thisArg,_arguments,P,generator){return new(P=P||Promise)(function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){result.done?resolve(result.value):new P(function(resolve){resolve(result.value)}).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())})},__generator=this&&this.__generator||function(thisArg,body){var f,y,t,g,_={label:0,sent:function(){if(1&t[0])throw t[1];return t[1]},trys:[],ops:[]};return g={next:verb(0),throw:verb(1),return:verb(2)},"function"==typeof Symbol&&(g[Symbol.iterator]=function(){return this}),g;function verb(n){return function(v){return function(op){if(f)throw new TypeError("Generator is already executing.");for(;_;)try{if(f=1,y&&(t=2&op[0]?y.return:op[0]?y.throw||((t=y.return)&&t.call(y),0):y.next)&&!(t=t.call(y,op[1])).done)return t;switch(y=0,t&&(op=[2&op[0],t.value]),op[0]){case 0:case 1:t=op;break;case 4:return _.label++,{value:op[1],done:!1};case 5:_.label++,y=op[1],op=[0];continue;case 7:op=_.ops.pop(),_.trys.pop();continue;default:if(!(t=0<(t=_.trys).length&&t[t.length-1])&&(6===op[0]||2===op[0])){_=0;continue}if(3===op[0]&&(!t||op[1]>t[0]&&op[1]<t[3])){_.label=op[1];break}if(6===op[0]&&_.label<t[1]){_.label=t[1],t=op;break}if(t&&_.label<t[2]){_.label=t[2],_.ops.push(op);break}t[2]&&_.ops.pop(),_.trys.pop();continue}op=body.call(thisArg,_)}catch(e){op=[6,e],y=0}finally{f=t=0}if(5&op[0])throw op[1];return{value:op[0]?op[1]:void 0,done:!0}}([n,v])}}};Object.defineProperty(exports,"__esModule",{value:!0});var environment_1=require("../environment"),io_utils_1=require("./io_utils"),model_management_1=require("./model_management"),router_registry_1=require("./router_registry"),DATABASE_NAME="tensorflowjs",MODEL_STORE_NAME="models_store",INFO_STORE_NAME="model_info_store";function getIndexedDBFactory(){if(!environment_1.ENV.getBool("IS_BROWSER"))throw new Error("Failed to obtain IndexedDB factory because the current environmentis not a web browser.");var theWindow=window,factory=theWindow.indexedDB||theWindow.mozIndexedDB||theWindow.webkitIndexedDB||theWindow.msIndexedDB||theWindow.shimIndexedDB;if(null==factory)throw new Error("The current browser does not appear to support IndexedDB.");return factory}function setUpDatabase(openRequest){var db=openRequest.result;db.createObjectStore(MODEL_STORE_NAME,{keyPath:"modelPath"}),db.createObjectStore(INFO_STORE_NAME,{keyPath:"modelPath"})}exports.deleteDatabase=function(){return __awaiter(this,void 0,void 0,function(){var idbFactory;return __generator(this,function(_a){return idbFactory=getIndexedDBFactory(),[2,new Promise(function(resolve,reject){var deleteRequest=idbFactory.deleteDatabase(DATABASE_NAME);deleteRequest.onsuccess=function(){return resolve()},deleteRequest.onerror=function(error){return reject(error)}})]})})};var BrowserIndexedDB=function(){function BrowserIndexedDB(modelPath){if(this.indexedDB=getIndexedDBFactory(),null==modelPath||!modelPath)throw new Error("For IndexedDB, modelPath must not be null, undefined or empty.");this.modelPath=modelPath}return BrowserIndexedDB.prototype.save=function(modelArtifacts){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(_a){if(modelArtifacts.modelTopology instanceof ArrayBuffer)throw new Error("BrowserLocalStorage.save() does not support saving model topology in binary formats yet.");return[2,this.databaseAction(this.modelPath,modelArtifacts)]})})},BrowserIndexedDB.prototype.load=function(){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(_a){return[2,this.databaseAction(this.modelPath)]})})},BrowserIndexedDB.prototype.databaseAction=function(modelPath,modelArtifacts){var _this=this;return new Promise(function(resolve,reject){var openRequest=_this.indexedDB.open(DATABASE_NAME,1);openRequest.onupgradeneeded=function(){return setUpDatabase(openRequest)},openRequest.onsuccess=function(){var db=openRequest.result;if(null==modelArtifacts){var modelTx=db.transaction(MODEL_STORE_NAME,"readonly"),getRequest_1=modelTx.objectStore(MODEL_STORE_NAME).get(_this.modelPath);getRequest_1.onsuccess=function(){if(null==getRequest_1.result)return db.close(),reject(new Error("Cannot find model with path '"+_this.modelPath+"' in IndexedDB."));resolve(getRequest_1.result.modelArtifacts)},getRequest_1.onerror=function(error){return db.close(),reject(getRequest_1.error)},modelTx.oncomplete=function(){return db.close()}}else{var modelTx_1,modelArtifactsInfo_1=io_utils_1.getModelArtifactsInfoForJSON(modelArtifacts),infoTx_1=db.transaction(INFO_STORE_NAME,"readwrite"),infoStore_1=infoTx_1.objectStore(INFO_STORE_NAME),putInfoRequest_1=infoStore_1.put({modelPath:_this.modelPath,modelArtifactsInfo:modelArtifactsInfo_1});putInfoRequest_1.onsuccess=function(){var putModelRequest=(modelTx_1=db.transaction(MODEL_STORE_NAME,"readwrite")).objectStore(MODEL_STORE_NAME).put({modelPath:_this.modelPath,modelArtifacts:modelArtifacts,modelArtifactsInfo:modelArtifactsInfo_1});putModelRequest.onsuccess=function(){return resolve({modelArtifactsInfo:modelArtifactsInfo_1})},putModelRequest.onerror=function(error){var deleteInfoRequest=(infoStore_1=infoTx_1.objectStore(INFO_STORE_NAME)).delete(_this.modelPath);deleteInfoRequest.onsuccess=function(){return db.close(),reject(putModelRequest.error)},deleteInfoRequest.onerror=function(error){return db.close(),reject(putModelRequest.error)}}},putInfoRequest_1.onerror=function(error){return db.close(),reject(putInfoRequest_1.error)},infoTx_1.oncomplete=function(){null==modelTx_1?db.close():modelTx_1.oncomplete=function(){return db.close()}}}},openRequest.onerror=function(error){return reject(openRequest.error)}})},BrowserIndexedDB.URL_SCHEME="indexeddb://",BrowserIndexedDB}();function browserIndexedDB(modelPath){return new BrowserIndexedDB(modelPath)}exports.BrowserIndexedDB=BrowserIndexedDB,exports.indexedDBRouter=function(url){return environment_1.ENV.getBool("IS_BROWSER")&&!Array.isArray(url)&&url.startsWith(BrowserIndexedDB.URL_SCHEME)?browserIndexedDB(url.slice(BrowserIndexedDB.URL_SCHEME.length)):null},router_registry_1.IORouterRegistry.registerSaveRouter(exports.indexedDBRouter),router_registry_1.IORouterRegistry.registerLoadRouter(exports.indexedDBRouter),exports.browserIndexedDB=browserIndexedDB;var BrowserIndexedDBManager=function(){function BrowserIndexedDBManager(){this.indexedDB=getIndexedDBFactory()}return BrowserIndexedDBManager.prototype.listModels=function(){return __awaiter(this,void 0,void 0,function(){var _this=this;return __generator(this,function(_a){return[2,new Promise(function(resolve,reject){var openRequest=_this.indexedDB.open(DATABASE_NAME,1);openRequest.onupgradeneeded=function(){return setUpDatabase(openRequest)},openRequest.onsuccess=function(){var db=openRequest.result,tx=db.transaction(INFO_STORE_NAME,"readonly"),getAllInfoRequest=tx.objectStore(INFO_STORE_NAME).getAll();getAllInfoRequest.onsuccess=function(){for(var out={},_i=0,_a=getAllInfoRequest.result;_i<_a.length;_i++){var item=_a[_i];out[item.modelPath]=item.modelArtifactsInfo}resolve(out)},getAllInfoRequest.onerror=function(error){return db.close(),reject(getAllInfoRequest.error)},tx.oncomplete=function(){return db.close()}},openRequest.onerror=function(error){return reject(openRequest.error)}})]})})},BrowserIndexedDBManager.prototype.removeModel=function(path){return __awaiter(this,void 0,void 0,function(){var _this=this;return __generator(this,function(_a){return path=function(key){return key.startsWith(BrowserIndexedDB.URL_SCHEME)?key.slice(BrowserIndexedDB.URL_SCHEME.length):key}(path),[2,new Promise(function(resolve,reject){var openRequest=_this.indexedDB.open(DATABASE_NAME,1);openRequest.onupgradeneeded=function(){return setUpDatabase(openRequest)},openRequest.onsuccess=function(){var modelTx,db=openRequest.result,infoTx=db.transaction(INFO_STORE_NAME,"readwrite"),infoStore=infoTx.objectStore(INFO_STORE_NAME),getInfoRequest=infoStore.get(path);getInfoRequest.onsuccess=function(){if(null==getInfoRequest.result)return db.close(),reject(new Error("Cannot find model with path '"+path+"' in IndexedDB."));function deleteModelData_1(){var deleteModelRequest=(modelTx=db.transaction(MODEL_STORE_NAME,"readwrite")).objectStore(MODEL_STORE_NAME).delete(path);deleteModelRequest.onsuccess=function(){return resolve(getInfoRequest.result.modelArtifactsInfo)},deleteModelRequest.onerror=function(error){return reject(getInfoRequest.error)}}var deleteInfoRequest=infoStore.delete(path);deleteInfoRequest.onsuccess=deleteModelData_1,deleteInfoRequest.onerror=function(error){return deleteModelData_1(),db.close(),reject(getInfoRequest.error)}},getInfoRequest.onerror=function(error){return db.close(),reject(getInfoRequest.error)},infoTx.oncomplete=function(){null==modelTx?db.close():modelTx.oncomplete=function(){return db.close()}}},openRequest.onerror=function(error){return reject(openRequest.error)}})]})})},BrowserIndexedDBManager}();if(exports.BrowserIndexedDBManager=BrowserIndexedDBManager,environment_1.ENV.getBool("IS_BROWSER"))try{model_management_1.ModelStoreManagerRegistry.registerManager(BrowserIndexedDB.URL_SCHEME,new BrowserIndexedDBManager)}catch(err){}},{"../environment":144,"./io_utils":153,"./model_management":155,"./router_registry":158}],152:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),require("./indexed_db"),require("./local_storage");var browser_files_1=require("./browser_files");exports.browserFiles=browser_files_1.browserFiles;var http_1=require("./http");exports.browserHTTPRequest=http_1.browserHTTPRequest,exports.http=http_1.http,exports.isHTTPScheme=http_1.isHTTPScheme;var io_utils_1=require("./io_utils");exports.concatenateArrayBuffers=io_utils_1.concatenateArrayBuffers,exports.decodeWeights=io_utils_1.decodeWeights,exports.encodeWeights=io_utils_1.encodeWeights,exports.getModelArtifactsInfoForJSON=io_utils_1.getModelArtifactsInfoForJSON;var passthrough_1=require("./passthrough");exports.fromMemory=passthrough_1.fromMemory,exports.withSaveHandler=passthrough_1.withSaveHandler;var router_registry_1=require("./router_registry");exports.getLoadHandlers=router_registry_1.getLoadHandlers,exports.getSaveHandlers=router_registry_1.getSaveHandlers,exports.registerLoadRouter=router_registry_1.registerLoadRouter,exports.registerSaveRouter=router_registry_1.registerSaveRouter;var weights_loader_1=require("./weights_loader");exports.loadWeights=weights_loader_1.loadWeights,exports.weightsLoaderFactory=weights_loader_1.weightsLoaderFactory;var model_management_1=require("./model_management");exports.copyModel=model_management_1.copyModel,exports.listModels=model_management_1.listModels,exports.moveModel=model_management_1.moveModel,exports.removeModel=model_management_1.removeModel},{"./browser_files":149,"./http":150,"./indexed_db":151,"./io_utils":153,"./local_storage":154,"./model_management":155,"./passthrough":156,"./router_registry":158,"./weights_loader":160}],153:[function(require,module,exports){(function(Buffer){"use strict";var __awaiter=this&&this.__awaiter||function(thisArg,_arguments,P,generator){return new(P=P||Promise)(function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){result.done?resolve(result.value):new P(function(resolve){resolve(result.value)}).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())})},__generator=this&&this.__generator||function(thisArg,body){var f,y,t,g,_={label:0,sent:function(){if(1&t[0])throw t[1];return t[1]},trys:[],ops:[]};return g={next:verb(0),throw:verb(1),return:verb(2)},"function"==typeof Symbol&&(g[Symbol.iterator]=function(){return this}),g;function verb(n){return function(v){return function(op){if(f)throw new TypeError("Generator is already executing.");for(;_;)try{if(f=1,y&&(t=2&op[0]?y.return:op[0]?y.throw||((t=y.return)&&t.call(y),0):y.next)&&!(t=t.call(y,op[1])).done)return t;switch(y=0,t&&(op=[2&op[0],t.value]),op[0]){case 0:case 1:t=op;break;case 4:return _.label++,{value:op[1],done:!1};case 5:_.label++,y=op[1],op=[0];continue;case 7:op=_.ops.pop(),_.trys.pop();continue;default:if(!(t=0<(t=_.trys).length&&t[t.length-1])&&(6===op[0]||2===op[0])){_=0;continue}if(3===op[0]&&(!t||op[1]>t[0]&&op[1]<t[3])){_.label=op[1];break}if(6===op[0]&&_.label<t[1]){_.label=t[1],t=op;break}if(t&&_.label<t[2]){_.label=t[2],_.ops.push(op);break}t[2]&&_.ops.pop(),_.trys.pop();continue}op=body.call(thisArg,_)}catch(e){op=[6,e],y=0}finally{f=t=0}if(5&op[0])throw op[1];return{value:op[0]?op[1]:void 0,done:!0}}([n,v])}}};Object.defineProperty(exports,"__esModule",{value:!0});var tensor_ops_1=require("../ops/tensor_ops"),util_1=require("../util"),types_1=require("./types"),NUM_BYTES_STRING_LENGTH=4;function concatenateTypedArrays(xs){if(null===xs)throw new Error("Invalid input value: "+JSON.stringify(xs));var totalByteLength=0,normalizedXs=[];xs.forEach(function(x){if(totalByteLength+=x.byteLength,normalizedXs.push(x.byteLength===x.buffer.byteLength?x:new x.constructor(x)),!(x instanceof Float32Array||x instanceof Int32Array||x instanceof Uint8Array))throw new Error("Unsupported TypedArray subtype: "+x.constructor.name)});var y=new Uint8Array(totalByteLength),offset=0;return normalizedXs.forEach(function(x){y.set(new Uint8Array(x.buffer),offset),offset+=x.byteLength}),y.buffer}exports.encodeWeights=function(tensors,group){return __awaiter(this,void 0,void 0,function(){var specs,dataPromises,names,_loop_1,i,_this=this;return __generator(this,function(_a){switch(_a.label){case 0:for(specs=[],dataPromises=[],names=Array.isArray(tensors)?tensors.map(function(tensor){return tensor.name}):Object.keys(tensors),_loop_1=function(i){var name_1=names[i],t=Array.isArray(tensors)?tensors[i].tensor:tensors[name_1];if("float32"!==t.dtype&&"int32"!==t.dtype&&"bool"!==t.dtype&&"string"!==t.dtype)throw new Error("Unsupported dtype in weight '"+name_1+"': "+t.dtype);var spec={name:name_1,shape:t.shape,dtype:t.dtype};if("string"===t.dtype){var utf8bytes=new Promise(function(resolve){return __awaiter(_this,void 0,void 0,function(){var vals,totalNumBytes,bytes,offset,i_1,val,bytesOfLength;return __generator(this,function(_a){switch(_a.label){case 0:return[4,t.bytes()];case 1:for(vals=_a.sent(),totalNumBytes=vals.reduce(function(p,c){return p+c.length},0)+NUM_BYTES_STRING_LENGTH*vals.length,bytes=new Uint8Array(totalNumBytes),i_1=offset=0;i_1<vals.length;i_1++)val=vals[i_1],bytesOfLength=new Uint8Array(new Uint32Array([val.length]).buffer),bytes.set(bytesOfLength,offset),offset+=NUM_BYTES_STRING_LENGTH,bytes.set(val,offset),offset+=val.length;return resolve(bytes),[2]}})})});dataPromises.push(utf8bytes)}else dataPromises.push(t.data());null!=group&&(spec.group=group),specs.push(spec)},i=0;i<names.length;++i)_loop_1(i);return[4,Promise.all(dataPromises)];case 1:return[2,{data:concatenateTypedArrays(_a.sent()),specs:specs}]}})})},exports.decodeWeights=function(buffer,specs){for(var out={},offset=0,_loop_2=function(spec){var name_2=spec.name,dtype=spec.dtype,shape=spec.shape,size=util_1.sizeFromShape(shape),values=void 0;if("quantization"in spec){var quantization_1=spec.quantization;if("uint8"!==quantization_1.dtype&&"uint16"!==quantization_1.dtype)throw new Error("Weight "+spec.name+" has unknown quantization dtype "+quantization_1.dtype+". Supported quantization dtypes are: 'uint8' and 'uint16'.");var quantizationSizeFactor=types_1.DTYPE_VALUE_SIZE_MAP[quantization_1.dtype],byteBuffer=buffer.slice(offset,offset+size*quantizationSizeFactor),quantizedArray="uint8"===quantization_1.dtype?new Uint8Array(byteBuffer):new Uint16Array(byteBuffer);if("float32"===dtype)values=Float32Array.from(quantizedArray,function(v){return v*quantization_1.scale+quantization_1.min});else{if("int32"!==dtype)throw new Error("Unsupported dtype in weight '"+name_2+"': "+dtype);values=Int32Array.from(quantizedArray,function(v){return Math.round(v*quantization_1.scale+quantization_1.min)})}offset+=size*quantizationSizeFactor}else if("string"===dtype){var size_1=util_1.sizeFromShape(spec.shape);values=[];for(var i=0;i<size_1;i++){var byteLength=new Uint32Array(buffer.slice(offset,offset+NUM_BYTES_STRING_LENGTH))[0];offset+=NUM_BYTES_STRING_LENGTH;var bytes=new Uint8Array(buffer.slice(offset,offset+byteLength));values.push(bytes),offset+=byteLength}}else{var dtypeFactor=types_1.DTYPE_VALUE_SIZE_MAP[dtype];byteBuffer=buffer.slice(offset,offset+size*dtypeFactor);if("float32"===dtype)values=new Float32Array(byteBuffer);else if("int32"===dtype)values=new Int32Array(byteBuffer);else{if("bool"!==dtype)throw new Error("Unsupported dtype in weight '"+name_2+"': "+dtype);values=new Uint8Array(byteBuffer)}offset+=size*dtypeFactor}out[name_2]=tensor_ops_1.tensor(values,shape,dtype)},_i=0,specs_1=specs;_i<specs_1.length;_i++){_loop_2(specs_1[_i])}return out},exports.concatenateTypedArrays=concatenateTypedArrays;var useNodeBuffer=void 0!==Buffer&&("undefined"==typeof Blob||"undefined"==typeof atob||"undefined"==typeof btoa);function stringByteLength(str){return useNodeBuffer?Buffer.byteLength(str):new Blob([str]).size}exports.stringByteLength=stringByteLength,exports.arrayBufferToBase64String=function(buffer){return useNodeBuffer?Buffer.from(buffer).toString("base64"):btoa(String.fromCharCode.apply(null,new Uint8Array(buffer)))},exports.base64StringToArrayBuffer=function(str){if(useNodeBuffer){var buf=Buffer.from(str,"base64");return buf.buffer.slice(buf.byteOffset,buf.byteOffset+buf.byteLength)}for(var s=atob(str),buffer=new Uint8Array(s.length),i=0;i<s.length;++i)buffer.set([s.charCodeAt(i)],i);return buffer.buffer},exports.concatenateArrayBuffers=function(buffers){var totalByteLength=0;buffers.forEach(function(buffer){totalByteLength+=buffer.byteLength});var temp=new Uint8Array(totalByteLength),offset=0;return buffers.forEach(function(buffer){temp.set(new Uint8Array(buffer),offset),offset+=buffer.byteLength}),temp.buffer},exports.basename=function(path){for(path=path.trim();path.endsWith("/");)path=path.slice(0,path.length-1);var items=path.split("/");return items[items.length-1]},exports.getModelArtifactsInfoForJSON=function(modelArtifacts){if(modelArtifacts.modelTopology instanceof ArrayBuffer)throw new Error("Expected JSON model topology, received ArrayBuffer.");return{dateSaved:new Date,modelTopologyType:"JSON",modelTopologyBytes:null==modelArtifacts.modelTopology?0:stringByteLength(JSON.stringify(modelArtifacts.modelTopology)),weightSpecsBytes:null==modelArtifacts.weightSpecs?0:stringByteLength(JSON.stringify(modelArtifacts.weightSpecs)),weightDataBytes:null==modelArtifacts.weightData?0:modelArtifacts.weightData.byteLength}}}).call(this,require("buffer").Buffer)},{"../ops/tensor_ops":216,"../util":241,"./types":159,buffer:334}],154:[function(require,module,exports){"use strict";var __awaiter=this&&this.__awaiter||function(thisArg,_arguments,P,generator){return new(P=P||Promise)(function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){result.done?resolve(result.value):new P(function(resolve){resolve(result.value)}).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())})},__generator=this&&this.__generator||function(thisArg,body){var f,y,t,g,_={label:0,sent:function(){if(1&t[0])throw t[1];return t[1]},trys:[],ops:[]};return g={next:verb(0),throw:verb(1),return:verb(2)},"function"==typeof Symbol&&(g[Symbol.iterator]=function(){return this}),g;function verb(n){return function(v){return function(op){if(f)throw new TypeError("Generator is already executing.");for(;_;)try{if(f=1,y&&(t=2&op[0]?y.return:op[0]?y.throw||((t=y.return)&&t.call(y),0):y.next)&&!(t=t.call(y,op[1])).done)return t;switch(y=0,t&&(op=[2&op[0],t.value]),op[0]){case 0:case 1:t=op;break;case 4:return _.label++,{value:op[1],done:!1};case 5:_.label++,y=op[1],op=[0];continue;case 7:op=_.ops.pop(),_.trys.pop();continue;default:if(!(t=0<(t=_.trys).length&&t[t.length-1])&&(6===op[0]||2===op[0])){_=0;continue}if(3===op[0]&&(!t||op[1]>t[0]&&op[1]<t[3])){_.label=op[1];break}if(6===op[0]&&_.label<t[1]){_.label=t[1],t=op;break}if(t&&_.label<t[2]){_.label=t[2],_.ops.push(op);break}t[2]&&_.ops.pop(),_.trys.pop();continue}op=body.call(thisArg,_)}catch(e){op=[6,e],y=0}finally{f=t=0}if(5&op[0])throw op[1];return{value:op[0]?op[1]:void 0,done:!0}}([n,v])}}};Object.defineProperty(exports,"__esModule",{value:!0});var environment_1=require("../environment"),util_1=require("../util"),io_utils_1=require("./io_utils"),model_management_1=require("./model_management"),router_registry_1=require("./router_registry"),PATH_SEPARATOR="/",PATH_PREFIX="tensorflowjs_models",INFO_SUFFIX="info",MODEL_TOPOLOGY_SUFFIX="model_topology",WEIGHT_SPECS_SUFFIX="weight_specs",WEIGHT_DATA_SUFFIX="weight_data",MODEL_METADATA_SUFFIX="model_metadata";function getModelKeys(path){return{info:[PATH_PREFIX,path,INFO_SUFFIX].join(PATH_SEPARATOR),topology:[PATH_PREFIX,path,MODEL_TOPOLOGY_SUFFIX].join(PATH_SEPARATOR),weightSpecs:[PATH_PREFIX,path,WEIGHT_SPECS_SUFFIX].join(PATH_SEPARATOR),weightData:[PATH_PREFIX,path,WEIGHT_DATA_SUFFIX].join(PATH_SEPARATOR),modelMetadata:[PATH_PREFIX,path,MODEL_METADATA_SUFFIX].join(PATH_SEPARATOR)}}function getModelPathFromKey(key){var items=key.split(PATH_SEPARATOR);if(items.length<3)throw new Error("Invalid key format: "+key);return items.slice(1,items.length-1).join(PATH_SEPARATOR)}exports.purgeLocalStorageArtifacts=function(){if(!environment_1.ENV.getBool("IS_BROWSER")||void 0===window.localStorage)throw new Error("purgeLocalStorageModels() cannot proceed because local storage is unavailable in the current environment.");for(var LS=window.localStorage,purgedModelPaths=[],i=0;i<LS.length;++i){var key=LS.key(i),prefix=PATH_PREFIX+PATH_SEPARATOR;if(key.startsWith(prefix)&&key.length>prefix.length){LS.removeItem(key);var modelName=getModelPathFromKey(key);-1===purgedModelPaths.indexOf(modelName)&&purgedModelPaths.push(modelName)}}return purgedModelPaths};var BrowserLocalStorage=function(){function BrowserLocalStorage(modelPath){if(!environment_1.ENV.getBool("IS_BROWSER")||void 0===window.localStorage)throw new Error("The current environment does not support local storage.");if(this.LS=window.localStorage,null==modelPath||!modelPath)throw new Error("For local storage, modelPath must not be null, undefined or empty.");this.modelPath=modelPath,this.keys=getModelKeys(this.modelPath)}return BrowserLocalStorage.prototype.save=function(modelArtifacts){return __awaiter(this,void 0,void 0,function(){var topology,weightSpecs,modelArtifactsInfo;return __generator(this,function(_a){if(modelArtifacts.modelTopology instanceof ArrayBuffer)throw new Error("BrowserLocalStorage.save() does not support saving model topology in binary formats yet.");topology=JSON.stringify(modelArtifacts.modelTopology),weightSpecs=JSON.stringify(modelArtifacts.weightSpecs),modelArtifactsInfo=io_utils_1.getModelArtifactsInfoForJSON(modelArtifacts);try{return this.LS.setItem(this.keys.info,JSON.stringify(modelArtifactsInfo)),this.LS.setItem(this.keys.topology,topology),this.LS.setItem(this.keys.weightSpecs,weightSpecs),this.LS.setItem(this.keys.weightData,io_utils_1.arrayBufferToBase64String(modelArtifacts.weightData)),this.LS.setItem(this.keys.modelMetadata,JSON.stringify({format:modelArtifacts.format,generatedBy:modelArtifacts.generatedBy,convertedBy:modelArtifacts.convertedBy})),[2,{modelArtifactsInfo:modelArtifactsInfo}]}catch(err){throw this.LS.removeItem(this.keys.info),this.LS.removeItem(this.keys.topology),this.LS.removeItem(this.keys.weightSpecs),this.LS.removeItem(this.keys.weightData),this.LS.removeItem(this.keys.modelMetadata),new Error("Failed to save model '"+this.modelPath+"' to local storage: size quota being exceeded is a possible cause of this failure: modelTopologyBytes="+modelArtifactsInfo.modelTopologyBytes+", weightSpecsBytes="+modelArtifactsInfo.weightSpecsBytes+", weightDataBytes="+modelArtifactsInfo.weightDataBytes+".")}return[2]})})},BrowserLocalStorage.prototype.load=function(){return __awaiter(this,void 0,void 0,function(){var info,out,topology,weightSpecs,metadataString,metadata,weightDataBase64;return __generator(this,function(_a){if(null==(info=JSON.parse(this.LS.getItem(this.keys.info))))throw new Error("In local storage, there is no model with name '"+this.modelPath+"'");if("JSON"!==info.modelTopologyType)throw new Error("BrowserLocalStorage does not support loading non-JSON model topology yet.");if(out={},null==(topology=JSON.parse(this.LS.getItem(this.keys.topology))))throw new Error("In local storage, the topology of model '"+this.modelPath+"' is missing.");if(out.modelTopology=topology,null==(weightSpecs=JSON.parse(this.LS.getItem(this.keys.weightSpecs))))throw new Error("In local storage, the weight specs of model '"+this.modelPath+"' are missing.");if(out.weightSpecs=weightSpecs,null!=(metadataString=this.LS.getItem(this.keys.modelMetadata))&&(metadata=JSON.parse(metadataString),out.format=metadata.format,out.generatedBy=metadata.generatedBy,out.convertedBy=metadata.convertedBy),null==(weightDataBase64=this.LS.getItem(this.keys.weightData)))throw new Error("In local storage, the binary weight values of model '"+this.modelPath+"' are missing.");return out.weightData=io_utils_1.base64StringToArrayBuffer(weightDataBase64),[2,out]})})},BrowserLocalStorage.URL_SCHEME="localstorage://",BrowserLocalStorage}();function browserLocalStorage(modelPath){return new BrowserLocalStorage(modelPath)}exports.BrowserLocalStorage=BrowserLocalStorage,exports.localStorageRouter=function(url){return environment_1.ENV.getBool("IS_BROWSER")&&!Array.isArray(url)&&url.startsWith(BrowserLocalStorage.URL_SCHEME)?browserLocalStorage(url.slice(BrowserLocalStorage.URL_SCHEME.length)):null},router_registry_1.IORouterRegistry.registerSaveRouter(exports.localStorageRouter),router_registry_1.IORouterRegistry.registerLoadRouter(exports.localStorageRouter),exports.browserLocalStorage=browserLocalStorage;var BrowserLocalStorageManager=function(){function BrowserLocalStorageManager(){util_1.assert(environment_1.ENV.getBool("IS_BROWSER"),function(){return"Current environment is not a web browser"}),util_1.assert(void 0!==window.localStorage,function(){return"Current browser does not appear to support localStorage"}),this.LS=window.localStorage}return BrowserLocalStorageManager.prototype.listModels=function(){return __awaiter(this,void 0,void 0,function(){var out,prefix,suffix,i,key,modelPath;return __generator(this,function(_a){for(out={},prefix=PATH_PREFIX+PATH_SEPARATOR,suffix=PATH_SEPARATOR+INFO_SUFFIX,i=0;i<this.LS.length;++i)(key=this.LS.key(i)).startsWith(prefix)&&key.endsWith(suffix)&&(modelPath=getModelPathFromKey(key),out[modelPath]=JSON.parse(this.LS.getItem(key)));return[2,out]})})},BrowserLocalStorageManager.prototype.removeModel=function(path){return __awaiter(this,void 0,void 0,function(){var keys,info;return __generator(this,function(_a){if(path=function(key){return key.startsWith(BrowserLocalStorage.URL_SCHEME)?key.slice(BrowserLocalStorage.URL_SCHEME.length):key}(path),keys=getModelKeys(path),null==this.LS.getItem(keys.info))throw new Error("Cannot find model at path '"+path+"'");return info=JSON.parse(this.LS.getItem(keys.info)),this.LS.removeItem(keys.info),this.LS.removeItem(keys.topology),this.LS.removeItem(keys.weightSpecs),this.LS.removeItem(keys.weightData),[2,info]})})},BrowserLocalStorageManager}();if(exports.BrowserLocalStorageManager=BrowserLocalStorageManager,environment_1.ENV.getBool("IS_BROWSER"))try{model_management_1.ModelStoreManagerRegistry.registerManager(BrowserLocalStorage.URL_SCHEME,new BrowserLocalStorageManager)}catch(err){}},{"../environment":144,"../util":241,"./io_utils":153,"./model_management":155,"./router_registry":158}],155:[function(require,module,exports){"use strict";var __awaiter=this&&this.__awaiter||function(thisArg,_arguments,P,generator){return new(P=P||Promise)(function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){result.done?resolve(result.value):new P(function(resolve){resolve(result.value)}).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())})},__generator=this&&this.__generator||function(thisArg,body){var f,y,t,g,_={label:0,sent:function(){if(1&t[0])throw t[1];return t[1]},trys:[],ops:[]};return g={next:verb(0),throw:verb(1),return:verb(2)},"function"==typeof Symbol&&(g[Symbol.iterator]=function(){return this}),g;function verb(n){return function(v){return function(op){if(f)throw new TypeError("Generator is already executing.");for(;_;)try{if(f=1,y&&(t=2&op[0]?y.return:op[0]?y.throw||((t=y.return)&&t.call(y),0):y.next)&&!(t=t.call(y,op[1])).done)return t;switch(y=0,t&&(op=[2&op[0],t.value]),op[0]){case 0:case 1:t=op;break;case 4:return _.label++,{value:op[1],done:!1};case 5:_.label++,y=op[1],op=[0];continue;case 7:op=_.ops.pop(),_.trys.pop();continue;default:if(!(t=0<(t=_.trys).length&&t[t.length-1])&&(6===op[0]||2===op[0])){_=0;continue}if(3===op[0]&&(!t||op[1]>t[0]&&op[1]<t[3])){_.label=op[1];break}if(6===op[0]&&_.label<t[1]){_.label=t[1],t=op;break}if(t&&_.label<t[2]){_.label=t[2],_.ops.push(op);break}t[2]&&_.ops.pop(),_.trys.pop();continue}op=body.call(thisArg,_)}catch(e){op=[6,e],y=0}finally{f=t=0}if(5&op[0])throw op[1];return{value:op[0]?op[1]:void 0,done:!0}}([n,v])}}};Object.defineProperty(exports,"__esModule",{value:!0});var util_1=require("../util"),router_registry_1=require("./router_registry"),URL_SCHEME_SUFFIX="://",ModelStoreManagerRegistry=function(){function ModelStoreManagerRegistry(){this.managers={}}return ModelStoreManagerRegistry.getInstance=function(){return null==ModelStoreManagerRegistry.instance&&(ModelStoreManagerRegistry.instance=new ModelStoreManagerRegistry),ModelStoreManagerRegistry.instance},ModelStoreManagerRegistry.registerManager=function(scheme,manager){util_1.assert(null!=scheme,function(){return"scheme must not be undefined or null."}),scheme.endsWith(URL_SCHEME_SUFFIX)&&(scheme=scheme.slice(0,scheme.indexOf(URL_SCHEME_SUFFIX))),util_1.assert(0<scheme.length,function(){return"scheme must not be an empty string."});var registry=ModelStoreManagerRegistry.getInstance();util_1.assert(null==registry.managers[scheme],function(){return"A model store manager is already registered for scheme '"+scheme+"'."}),registry.managers[scheme]=manager},ModelStoreManagerRegistry.getManager=function(scheme){var manager=this.getInstance().managers[scheme];if(null==manager)throw new Error("Cannot find model manager for scheme '"+scheme+"'");return manager},ModelStoreManagerRegistry.getSchemes=function(){return Object.keys(this.getInstance().managers)},ModelStoreManagerRegistry}();function parseURL(url){if(-1===url.indexOf(URL_SCHEME_SUFFIX))throw new Error("The url string provided does not contain a scheme. Supported schemes are: "+ModelStoreManagerRegistry.getSchemes().join(","));return{scheme:url.split(URL_SCHEME_SUFFIX)[0],path:url.split(URL_SCHEME_SUFFIX)[1]}}function cloneModelInternal(sourceURL,destURL,deleteSource){return void 0===deleteSource&&(deleteSource=!1),__awaiter(this,void 0,void 0,function(){var loadHandlers,loadHandler,saveHandlers,saveHandler,sourceScheme,sourcePath,sameMedium,modelArtifacts,saveResult;return __generator(this,function(_a){switch(_a.label){case 0:return util_1.assert(sourceURL!==destURL,function(){return"Old path and new path are the same: '"+sourceURL+"'"}),loadHandlers=router_registry_1.IORouterRegistry.getLoadHandlers(sourceURL),util_1.assert(0<loadHandlers.length,function(){return"Copying failed because no load handler is found for source URL "+sourceURL+"."}),util_1.assert(loadHandlers.length<2,function(){return"Copying failed because more than one ("+loadHandlers.length+") load handlers for source URL "+sourceURL+"."}),loadHandler=loadHandlers[0],saveHandlers=router_registry_1.IORouterRegistry.getSaveHandlers(destURL),util_1.assert(0<saveHandlers.length,function(){return"Copying failed because no save handler is found for destination URL "+destURL+"."}),util_1.assert(saveHandlers.length<2,function(){return"Copying failed because more than one ("+loadHandlers.length+") save handlers for destination URL "+destURL+"."}),saveHandler=saveHandlers[0],sourceScheme=parseURL(sourceURL).scheme,sourcePath=parseURL(sourceURL).path,sameMedium=sourceScheme===parseURL(sourceURL).scheme,[4,loadHandler.load()];case 1:return modelArtifacts=_a.sent(),deleteSource&&sameMedium?[4,ModelStoreManagerRegistry.getManager(sourceScheme).removeModel(sourcePath)]:[3,3];case 2:_a.sent(),_a.label=3;case 3:return[4,saveHandler.save(modelArtifacts)];case 4:return saveResult=_a.sent(),!deleteSource||sameMedium?[3,6]:[4,ModelStoreManagerRegistry.getManager(sourceScheme).removeModel(sourcePath)];case 5:_a.sent(),_a.label=6;case 6:return[2,saveResult.modelArtifactsInfo]}})})}exports.ModelStoreManagerRegistry=ModelStoreManagerRegistry,exports.listModels=function(){return __awaiter(this,void 0,void 0,function(){var schemes,out,_i,schemes_1,scheme,schemeOut,path;return __generator(this,function(_a){switch(_a.label){case 0:schemes=ModelStoreManagerRegistry.getSchemes(),out={},_i=0,schemes_1=schemes,_a.label=1;case 1:return _i<schemes_1.length?(scheme=schemes_1[_i],[4,ModelStoreManagerRegistry.getManager(scheme).listModels()]):[3,4];case 2:for(path in schemeOut=_a.sent())out[scheme+URL_SCHEME_SUFFIX+path]=schemeOut[path];_a.label=3;case 3:return _i++,[3,1];case 4:return[2,out]}})})},exports.removeModel=function(url){return __awaiter(this,void 0,void 0,function(){var schemeAndPath;return __generator(this,function(_a){return schemeAndPath=parseURL(url),[2,ModelStoreManagerRegistry.getManager(schemeAndPath.scheme).removeModel(schemeAndPath.path)]})})},exports.copyModel=function(sourceURL,destURL){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(_a){return[2,cloneModelInternal(sourceURL,destURL,!1)]})})},exports.moveModel=function(sourceURL,destURL){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(_a){return[2,cloneModelInternal(sourceURL,destURL,!0)]})})}},{"../util":241,"./router_registry":158}],156:[function(require,module,exports){"use strict";var __awaiter=this&&this.__awaiter||function(thisArg,_arguments,P,generator){return new(P=P||Promise)(function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){result.done?resolve(result.value):new P(function(resolve){resolve(result.value)}).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())})},__generator=this&&this.__generator||function(thisArg,body){var f,y,t,g,_={label:0,sent:function(){if(1&t[0])throw t[1];return t[1]},trys:[],ops:[]};return g={next:verb(0),throw:verb(1),return:verb(2)},"function"==typeof Symbol&&(g[Symbol.iterator]=function(){return this}),g;function verb(n){return function(v){return function(op){if(f)throw new TypeError("Generator is already executing.");for(;_;)try{if(f=1,y&&(t=2&op[0]?y.return:op[0]?y.throw||((t=y.return)&&t.call(y),0):y.next)&&!(t=t.call(y,op[1])).done)return t;switch(y=0,t&&(op=[2&op[0],t.value]),op[0]){case 0:case 1:t=op;break;case 4:return _.label++,{value:op[1],done:!1};case 5:_.label++,y=op[1],op=[0];continue;case 7:op=_.ops.pop(),_.trys.pop();continue;default:if(!(t=0<(t=_.trys).length&&t[t.length-1])&&(6===op[0]||2===op[0])){_=0;continue}if(3===op[0]&&(!t||op[1]>t[0]&&op[1]<t[3])){_.label=op[1];break}if(6===op[0]&&_.label<t[1]){_.label=t[1],t=op;break}if(t&&_.label<t[2]){_.label=t[2],_.ops.push(op);break}t[2]&&_.ops.pop(),_.trys.pop();continue}op=body.call(thisArg,_)}catch(e){op=[6,e],y=0}finally{f=t=0}if(5&op[0])throw op[1];return{value:op[0]?op[1]:void 0,done:!0}}([n,v])}}};Object.defineProperty(exports,"__esModule",{value:!0});var PassthroughLoader=function(){function PassthroughLoader(modelArtifacts){this.modelArtifacts=modelArtifacts}return PassthroughLoader.prototype.load=function(){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(_a){return[2,this.modelArtifacts]})})},PassthroughLoader}(),PassthroughSaver=function(){function PassthroughSaver(saveHandler){this.saveHandler=saveHandler}return PassthroughSaver.prototype.save=function(modelArtifacts){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(_a){return[2,this.saveHandler(modelArtifacts)]})})},PassthroughSaver}();exports.fromMemory=function(modelArtifacts,weightSpecs,weightData,trainingConfig){return 1!==arguments.length?(console.warn("Please call tf.io.fromMemory() with only one argument. The argument should be of type ModelArtifacts. The multi-argument signature of tf.io.fromMemory() has been deprecated and will be removed in a future release."),new PassthroughLoader({modelTopology:modelArtifacts,weightSpecs:weightSpecs,weightData:weightData,trainingConfig:trainingConfig})):null!=modelArtifacts.modelTopology||null!=modelArtifacts.weightSpecs?new PassthroughLoader(modelArtifacts):(console.warn("Please call tf.io.fromMemory() with only one argument. The argument should be of type ModelArtifacts. The multi-argument signature of tf.io.fromMemory() has been deprecated and will be removed in a future release."),new PassthroughLoader({modelTopology:modelArtifacts}))},exports.withSaveHandler=function(saveHandler){return new PassthroughSaver(saveHandler)}},{}],157:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var util_1=require("../util");exports.monitorPromisesProgress=function(promises,onProgress,startFraction,endFraction){!function(promises){util_1.assert(null!=promises&&Array.isArray(promises)&&0<promises.length,function(){return"promises must be a none empty array"})}(promises),function(startFraction,endFraction){util_1.assert(0<=startFraction&&startFraction<=1,function(){return"Progress fraction must be in range [0, 1], but got startFraction "+startFraction}),util_1.assert(0<=endFraction&&endFraction<=1,function(){return"Progress fraction must be in range [0, 1], but got endFraction "+endFraction}),util_1.assert(startFraction<=endFraction,function(){return"startFraction must be no more than endFraction, but got startFraction "+startFraction+" and endFraction "+endFraction})}(startFraction=null==startFraction?0:startFraction,endFraction=null==endFraction?1:endFraction);var resolvedPromise=0;return Promise.all(promises.map(function(promise){return promise.then(function(value){var fraction=startFraction+ ++resolvedPromise/promises.length*(endFraction-startFraction);return onProgress(fraction),value}),promise}))}},{"../util":241}],158:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var IORouterRegistry=function(){function IORouterRegistry(){this.saveRouters=[],this.loadRouters=[]}return IORouterRegistry.getInstance=function(){return null==IORouterRegistry.instance&&(IORouterRegistry.instance=new IORouterRegistry),IORouterRegistry.instance},IORouterRegistry.registerSaveRouter=function(saveRouter){IORouterRegistry.getInstance().saveRouters.push(saveRouter)},IORouterRegistry.registerLoadRouter=function(loadRouter){IORouterRegistry.getInstance().loadRouters.push(loadRouter)},IORouterRegistry.getSaveHandlers=function(url){return IORouterRegistry.getHandlers(url,"save")},IORouterRegistry.getLoadHandlers=function(url,onProgress){return IORouterRegistry.getHandlers(url,"load",onProgress)},IORouterRegistry.getHandlers=function(url,handlerType,onProgress){var validHandlers=[];return("load"===handlerType?IORouterRegistry.getInstance().loadRouters:IORouterRegistry.getInstance().saveRouters).forEach(function(router){var handler=router(url,onProgress);null!==handler&&validHandlers.push(handler)}),validHandlers},IORouterRegistry}();exports.IORouterRegistry=IORouterRegistry,exports.registerSaveRouter=function(loudRouter){return IORouterRegistry.registerSaveRouter(loudRouter)},exports.registerLoadRouter=function(loudRouter){return IORouterRegistry.registerLoadRouter(loudRouter)},exports.getSaveHandlers=function(url){return IORouterRegistry.getSaveHandlers(url)},exports.getLoadHandlers=function(url,onProgress){return IORouterRegistry.getLoadHandlers(url,onProgress)}},{}],159:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.DTYPE_VALUE_SIZE_MAP={float32:4,int32:4,uint16:2,uint8:1,bool:1}},{}],160:[function(require,module,exports){"use strict";var __awaiter=this&&this.__awaiter||function(thisArg,_arguments,P,generator){return new(P=P||Promise)(function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){result.done?resolve(result.value):new P(function(resolve){resolve(result.value)}).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())})},__generator=this&&this.__generator||function(thisArg,body){var f,y,t,g,_={label:0,sent:function(){if(1&t[0])throw t[1];return t[1]},trys:[],ops:[]};return g={next:verb(0),throw:verb(1),return:verb(2)},"function"==typeof Symbol&&(g[Symbol.iterator]=function(){return this}),g;function verb(n){return function(v){return function(op){if(f)throw new TypeError("Generator is already executing.");for(;_;)try{if(f=1,y&&(t=2&op[0]?y.return:op[0]?y.throw||((t=y.return)&&t.call(y),0):y.next)&&!(t=t.call(y,op[1])).done)return t;switch(y=0,t&&(op=[2&op[0],t.value]),op[0]){case 0:case 1:t=op;break;case 4:return _.label++,{value:op[1],done:!1};case 5:_.label++,y=op[1],op=[0];continue;case 7:op=_.ops.pop(),_.trys.pop();continue;default:if(!(t=0<(t=_.trys).length&&t[t.length-1])&&(6===op[0]||2===op[0])){_=0;continue}if(3===op[0]&&(!t||op[1]>t[0]&&op[1]<t[3])){_.label=op[1];break}if(6===op[0]&&_.label<t[1]){_.label=t[1],t=op;break}if(t&&_.label<t[2]){_.label=t[2],_.ops.push(op);break}t[2]&&_.ops.pop(),_.trys.pop();continue}op=body.call(thisArg,_)}catch(e){op=[6,e],y=0}finally{f=t=0}if(5&op[0])throw op[1];return{value:op[0]?op[1]:void 0,done:!0}}([n,v])}}};Object.defineProperty(exports,"__esModule",{value:!0});var environment_1=require("../environment"),util=require("../util"),io_utils_1=require("./io_utils"),progress_1=require("./progress"),types_1=require("./types");function loadWeightsAsArrayBuffer(fetchURLs,loadOptions){return __awaiter(this,void 0,void 0,function(){var fetchFunc,requests,fetchStartFraction,fetchEndFraction,_a,bufferPromises,bufferStartFraction,bufferEndFraction,_b;return __generator(this,function(_c){switch(_c.label){case 0:return null==loadOptions&&(loadOptions={}),fetchFunc=null==loadOptions.fetchFunc?environment_1.ENV.platform.fetch:loadOptions.fetchFunc,requests=fetchURLs.map(function(fetchURL){return fetchFunc(fetchURL,loadOptions.requestInit,{isBinary:!0})}),fetchStartFraction=0,fetchEndFraction=.5,null!=loadOptions.onProgress?[3,2]:[4,Promise.all(requests)];case 1:return _a=_c.sent(),[3,4];case 2:return[4,progress_1.monitorPromisesProgress(requests,loadOptions.onProgress,fetchStartFraction,fetchEndFraction)];case 3:_a=_c.sent(),_c.label=4;case 4:return bufferPromises=_a.map(function(response){return response.arrayBuffer()}),bufferStartFraction=.5,bufferEndFraction=1,null!=loadOptions.onProgress?[3,6]:[4,Promise.all(bufferPromises)];case 5:return _b=_c.sent(),[3,8];case 6:return[4,progress_1.monitorPromisesProgress(bufferPromises,loadOptions.onProgress,bufferStartFraction,bufferEndFraction)];case 7:_b=_c.sent(),_c.label=8;case 8:return[2,_b]}})})}function weightsLoaderFactory(fetchWeightsFunction){var _this=this;return function(manifest,filePathPrefix,weightNames){return void 0===filePathPrefix&&(filePathPrefix=""),__awaiter(_this,void 0,void 0,function(){var groupIndicesToFetchMap,groupWeightsToFetch,weightsFound,allManifestWeightNames,weightsNotFound,groupIndicesToFetch,fetchUrls,buffers,weightsTensorMap,bufferIndexOffset;return __generator(this,function(_a){switch(_a.label){case 0:if(groupIndicesToFetchMap=manifest.map(function(){return!1}),groupWeightsToFetch={},weightsFound=null!=weightNames?weightNames.map(function(){return!1}):[],allManifestWeightNames=[],manifest.forEach(function(manifestGroupConfig,groupIndex){var groupOffset=0;manifestGroupConfig.weights.forEach(function(weightsEntry){function enqueueWeightsForFetchingFn(){groupIndicesToFetchMap[groupIndex]=!0,null==groupWeightsToFetch[groupIndex]&&(groupWeightsToFetch[groupIndex]=[]),groupWeightsToFetch[groupIndex].push({manifestEntry:weightsEntry,groupOffset:groupOffset,sizeBytes:weightsBytes})}var rawDtype="quantization"in weightsEntry?weightsEntry.quantization.dtype:weightsEntry.dtype,weightsBytes=types_1.DTYPE_VALUE_SIZE_MAP[rawDtype]*util.sizeFromShape(weightsEntry.shape);null!=weightNames?weightNames.forEach(function(weightName,weightIndex){weightName===weightsEntry.name&&(enqueueWeightsForFetchingFn(),weightsFound[weightIndex]=!0)}):enqueueWeightsForFetchingFn(),allManifestWeightNames.push(weightsEntry.name),groupOffset+=weightsBytes})}),!weightsFound.every(function(found){return found}))throw weightsNotFound=weightNames.filter(function(_,i){return!weightsFound[i]}),new Error("Could not find weights in manifest with names: "+weightsNotFound.join(", ")+". \nManifest JSON has weights with names: "+allManifestWeightNames.join(", ")+".");return groupIndicesToFetch=groupIndicesToFetchMap.reduce(function(accumulator,shouldFetch,i){return shouldFetch&&accumulator.push(i),accumulator},[]),fetchUrls=[],groupIndicesToFetch.forEach(function(i){manifest[i].paths.forEach(function(filepath){var fetchUrl=filePathPrefix+(filePathPrefix.endsWith("/")?"":"/")+filepath;fetchUrls.push(fetchUrl)})}),[4,fetchWeightsFunction(fetchUrls)];case 1:return buffers=_a.sent(),weightsTensorMap={},bufferIndexOffset=0,groupIndicesToFetch.forEach(function(i){for(var numBuffers=manifest[i].paths.length,groupBytes=0,i_1=0;i_1<numBuffers;i_1++)groupBytes+=buffers[bufferIndexOffset+i_1].byteLength;for(var groupBuffer=new ArrayBuffer(groupBytes),groupByteBuffer=new Uint8Array(groupBuffer),groupBufferOffset=0,i_2=0;i_2<numBuffers;i_2++){var buffer=new Uint8Array(buffers[bufferIndexOffset+i_2]);groupByteBuffer.set(buffer,groupBufferOffset),groupBufferOffset+=buffer.byteLength}groupWeightsToFetch[i].forEach(function(weightsEntry){var byteBuffer=groupBuffer.slice(weightsEntry.groupOffset,weightsEntry.groupOffset+weightsEntry.sizeBytes),nameToTensorMap=io_utils_1.decodeWeights(byteBuffer,[weightsEntry.manifestEntry]);for(var name_1 in nameToTensorMap)weightsTensorMap[name_1]=nameToTensorMap[name_1]}),bufferIndexOffset+=numBuffers}),[2,weightsTensorMap]}})})}}exports.loadWeightsAsArrayBuffer=loadWeightsAsArrayBuffer,exports.loadWeights=function(manifest,filePathPrefix,weightNames,requestInit){return void 0===filePathPrefix&&(filePathPrefix=""),__awaiter(this,void 0,void 0,function(){return __generator(this,function(_a){return[2,weightsLoaderFactory(function(fetchUrls){return loadWeightsAsArrayBuffer(fetchUrls,{requestInit:requestInit})})(manifest,filePathPrefix,weightNames)]})})},exports.weightsLoaderFactory=weightsLoaderFactory},{"../environment":144,"../util":241,"./io_utils":153,"./progress":157,"./types":159}],161:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var environment_1=require("./environment");exports.warn=function(){for(var msg=[],_i=0;_i<arguments.length;_i++)msg[_i]=arguments[_i];environment_1.ENV.getBool("IS_TEST")||console.warn.apply(console,msg)},exports.log=function(){for(var msg=[],_i=0;_i<arguments.length;_i++)msg[_i]=arguments[_i];environment_1.ENV.getBool("IS_TEST")||console.log.apply(console,msg)}},{"./environment":144}],162:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var confusion_matrix_1=require("./ops/confusion_matrix");exports.confusionMatrix=confusion_matrix_1.confusionMatrix},{"./ops/confusion_matrix":175}],163:[function(require,module,exports){"use strict";var __awaiter=this&&this.__awaiter||function(thisArg,_arguments,P,generator){return new(P=P||Promise)(function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){result.done?resolve(result.value):new P(function(resolve){resolve(result.value)}).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())})},__generator=this&&this.__generator||function(thisArg,body){var f,y,t,g,_={label:0,sent:function(){if(1&t[0])throw t[1];return t[1]},trys:[],ops:[]};return g={next:verb(0),throw:verb(1),return:verb(2)},"function"==typeof Symbol&&(g[Symbol.iterator]=function(){return this}),g;function verb(n){return function(v){return function(op){if(f)throw new TypeError("Generator is already executing.");for(;_;)try{if(f=1,y&&(t=2&op[0]?y.return:op[0]?y.throw||((t=y.return)&&t.call(y),0):y.next)&&!(t=t.call(y,op[1])).done)return t;switch(y=0,t&&(op=[2&op[0],t.value]),op[0]){case 0:case 1:t=op;break;case 4:return _.label++,{value:op[1],done:!1};case 5:_.label++,y=op[1],op=[0];continue;case 7:op=_.ops.pop(),_.trys.pop();continue;default:if(!(t=0<(t=_.trys).length&&t[t.length-1])&&(6===op[0]||2===op[0])){_=0;continue}if(3===op[0]&&(!t||op[1]>t[0]&&op[1]<t[3])){_.label=op[1];break}if(6===op[0]&&_.label<t[1]){_.label=t[1],t=op;break}if(t&&_.label<t[2]){_.label=t[2],_.ops.push(op);break}t[2]&&_.ops.pop(),_.trys.pop();continue}op=body.call(thisArg,_)}catch(e){op=[6,e],y=0}finally{f=t=0}if(5&op[0])throw op[1];return{value:op[0]?op[1]:void 0,done:!0}}([n,v])}}};Object.defineProperty(exports,"__esModule",{value:!0});var engine_1=require("../engine"),tensor_1=require("../tensor"),tensor_util_env_1=require("../tensor_util_env"),util=require("../util"),axis_util_1=require("./axis_util"),concat_split_1=require("./concat_split"),operation_1=require("./operation"),rand_1=require("./rand"),tensor_ops_1=require("./tensor_ops");function buffer(shape,dtype,values){return void 0===dtype&&(dtype="float32"),dtype=dtype||"float32",util.assertNonNegativeIntegerDimensions(shape),new tensor_1.TensorBuffer(shape,dtype,values)}exports.buffer=buffer,exports.print=function(x,verbose){void 0===verbose&&(verbose=!1),console.log(x.toString(verbose))},exports.batchToSpaceND=operation_1.op({batchToSpaceND_:function(x,blockShape,crops){var $x=tensor_util_env_1.convertToTensor(x,"x","batchToSpaceND"),prod=blockShape.reduce(function(a,b){return a*b});return util.assert($x.rank>=1+blockShape.length,function(){return"input rank is "+$x.rank+" but should be > than blockShape.length "+blockShape.length}),util.assert(crops.length===blockShape.length,function(){return"crops.length is "+crops.length+" but should be equal to blockShape.length  "+blockShape.length}),util.assert($x.shape[0]%prod==0,function(){return"input tensor batch is "+$x.shape[0]+" but is not divisible by the product of the elements of blockShape "+blockShape.join(" * ")+" === "+prod}),engine_1.ENGINE.runKernel(function(backend){return backend.batchToSpaceND($x,blockShape,crops)},{$x:$x},function(dy){return{$x:function(){return dy.spaceToBatchND(blockShape,crops)}}})}}),exports.cast=operation_1.op({cast_:function(x,dtype){var $x=tensor_util_env_1.convertToTensor(x,"x","cast");if(!util.isValidDtype(dtype))throw new Error("Failed to cast to unknown dtype "+dtype);if("string"===dtype&&"string"!==$x.dtype||"string"!==dtype&&"string"===$x.dtype)throw new Error("Only strings can be casted to strings");return engine_1.ENGINE.runKernel(function(backend){return backend.cast($x,dtype)},{$x:$x},function(dy){return{$x:function(){return dy.clone()}}})}}),exports.clone=operation_1.op({clone_:function(x){var $x=tensor_util_env_1.convertToTensor(x,"x","clone",null);return engine_1.ENGINE.runKernel(function(backend){return tensor_1.Tensor.make($x.shape,{dataId:$x.dataId},$x.dtype)},{$x:$x},function(dy){return{$x:function(){return dy.toFloat()}}})}}),exports.cumsum=operation_1.op({cumsum_:function(x,axis,exclusive,reverse){void 0===axis&&(axis=0),void 0===exclusive&&(exclusive=!1),void 0===reverse&&(reverse=!1);var $x=tensor_util_env_1.convertToTensor(x,"x","cumsum");axis|=0;var permutation=axis_util_1.getAxesPermutation([axis],$x.rank),permutedX=$x;null!=permutation&&(permutedX=$x.transpose(permutation));var permutedAxis=axis_util_1.getInnerMostAxes(1,$x.rank)[0],value=engine_1.ENGINE.runKernel(function(backend){return backend.cumsum(permutedX,permutedAxis,exclusive,reverse)},{permutedX:permutedX},function(dy){return{permutedX:function(){return dy.cumsum(axis,exclusive,!reverse)}}});return null!=permutation&&(value=value.transpose(permutation)),value}}),exports.depthToSpace=operation_1.op({depthToSpace_:function(x,blockSize,dataFormat){void 0===dataFormat&&(dataFormat="NHWC");var $x=tensor_util_env_1.convertToTensor(x,"x","depthToSpace"),inputHeight="NHWC"===dataFormat?$x.shape[1]:$x.shape[2],inputWidth="NHWC"===dataFormat?$x.shape[2]:$x.shape[3],inputDepth="NHWC"===dataFormat?$x.shape[3]:$x.shape[1];return util.assert(0<=inputHeight*blockSize,function(){return"Negative dimension size caused by overflow when multiplying\n      "+inputHeight+" and "+blockSize+"  for depthToSpace with input shape\n      "+$x.shape}),util.assert(0<=inputWidth*blockSize,function(){return"Negative dimension size caused by overflow when multiplying\n      "+inputWidth+" and "+blockSize+" for depthToSpace with input shape\n          "+$x.shape}),util.assert(inputDepth%(blockSize*blockSize)==0,function(){return"Dimension size must be evenly divisible by "+blockSize*blockSize+" but is "+inputDepth+" for depthToSpace with input shape "+$x.shape}),engine_1.ENGINE.runKernel(function(backend){return backend.depthToSpace($x,blockSize,dataFormat)},{$x:$x})}}),exports.expandDims=operation_1.op({expandDims_:function(x,axis){void 0===axis&&(axis=0);var $x=tensor_util_env_1.convertToTensor(x,"x","expandDims",null);util.assert(axis<=$x.rank,function(){return"Axis must be <= rank of the tensor"});var newShape=$x.shape.slice();return axis<0&&(util.assert(-($x.rank+1)<=axis,function(){return"Axis must be in the interval ["+-($x.rank+1)+", "+$x.rank+"]"}),axis=$x.rank+axis+1),newShape.splice(axis,0,1),exports.reshape($x,newShape)}}),exports.eye=operation_1.op({eye_:function(numRows,numColumns,batchShape,dtype){void 0===dtype&&(dtype="float32"),null==numColumns&&(numColumns=numRows);for(var buff=buffer([numRows,numColumns],dtype),n=numRows<=numColumns?numRows:numColumns,i=0;i<n;++i)buff.set(1,i,i);var out=buff.toTensor().as2D(numRows,numColumns);if(null==batchShape)return out;if(1===batchShape.length)return exports.tile(exports.expandDims(out,0),[batchShape[0],1,1]);if(2===batchShape.length)return exports.tile(exports.expandDims(exports.expandDims(out,0),0),[batchShape[0],batchShape[1],1,1]);if(3===batchShape.length)return exports.tile(exports.expandDims(exports.expandDims(exports.expandDims(out,0),0),0),[batchShape[0],batchShape[1],batchShape[2],1,1]);throw new Error("eye() currently supports only 1D and 2D batchShapes, but received "+batchShape.length+"D.")}}),exports.multinomial=operation_1.op({multinomial_:function(logits,numSamples,seed,normalized){void 0===normalized&&(normalized=!1);var $logits=tensor_util_env_1.convertToTensor(logits,"logits","multinomial"),numOutcomes=$logits.size,origRank=$logits.rank;if(numOutcomes<2)throw new Error("Error in multinomial: you need at least 2 outcomes, but got "+numOutcomes+".");if(2<origRank)throw new Error("Rank of probabilities must be 1 or 2, but is "+origRank);seed=seed||Math.random();var logits2D=1===origRank?$logits.as2D(1,-1):$logits,res=engine_1.ENGINE.runKernel(function(backend){return backend.multinomial(logits2D,normalized,numSamples,seed)},{logits2D:logits2D});return 1===origRank?res.as1D():res}}),exports.oneHot=operation_1.op({oneHot_:function(indices,depth,onValue,offValue){if(void 0===onValue&&(onValue=1),void 0===offValue&&(offValue=0),depth<2)throw new Error("Error in oneHot: depth must be >=2, but it is "+depth);var $indices=tensor_util_env_1.convertToTensor(indices,"indices","oneHot","int32"),outShape=$indices.shape.concat([depth]);return $indices=$indices.flatten(),engine_1.ENGINE.runKernel(function(backend){return backend.oneHot($indices,depth,onValue,offValue)},{$indices:$indices},function(dy){return{$indices:function(){return tensor_ops_1.zeros($indices.shape,"float32")}}}).reshape(outShape)}}),exports.pad=operation_1.op({pad_:function(x,paddings,constantValue){void 0===constantValue&&(constantValue=0);var $x=tensor_util_env_1.convertToTensor(x,"x","pad");if(0===$x.rank)throw new Error("pad(scalar) is not defined. Pass non-scalar to pad");var begin=paddings.map(function(p){return p[0]});return engine_1.ENGINE.runKernel(function(backend){return backend.pad($x,paddings,constantValue)},{$x:$x},function(dy){return{$x:function(){return dy.slice(begin,$x.shape)}}})}}),exports.pad1d=operation_1.op({pad1d_:function(x,paddings,constantValue){return void 0===constantValue&&(constantValue=0),util.assert(2===paddings.length,function(){return"Invalid number of paddings. Must be length of 2."}),exports.pad(x,[paddings],constantValue)}}),exports.pad2d=operation_1.op({pad2d_:function(x,paddings,constantValue){return void 0===constantValue&&(constantValue=0),util.assert(2===paddings.length&&2===paddings[0].length&&2===paddings[1].length,function(){return"Invalid number of paddings. Must be length of 2 each."}),exports.pad(x,paddings,constantValue)}}),exports.pad3d=operation_1.op({pad3d_:function(x,paddings,constantValue){return void 0===constantValue&&(constantValue=0),util.assert(3===paddings.length&&2===paddings[0].length&&2===paddings[1].length&&2===paddings[2].length,function(){return"Invalid number of paddings. Must be length of 2 each."}),exports.pad(x,paddings,constantValue)}}),exports.pad4d=operation_1.op({pad4d_:function(x,paddings,constantValue){return void 0===constantValue&&(constantValue=0),util.assert(4===paddings.length&&2===paddings[0].length&&2===paddings[1].length&&2===paddings[2].length&&2===paddings[3].length,function(){return"Invalid number of paddings. Must be length of 2 each."}),exports.pad(x,paddings,constantValue)}}),exports.rand=operation_1.op({rand_:function(shape,randFunction,dtype){var size=util.sizeFromShape(shape),values=null;if(null==dtype||"float32"===dtype)values=new Float32Array(size);else if("int32"===dtype)values=new Int32Array(size);else{if("bool"!==dtype)throw new Error("Unknown data type "+dtype);values=new Uint8Array(size)}for(var i=0;i<size;i++)values[i]=randFunction();return tensor_1.Tensor.make(shape,{values:values},dtype)}}),exports.randomNormal=operation_1.op({randomNormal_:function(shape,mean,stdDev,dtype,seed){if(void 0===mean&&(mean=0),void 0===stdDev&&(stdDev=1),null!=dtype&&"bool"===dtype)throw new Error("Unsupported data type "+dtype);for(var randGauss=new rand_1.MPRandGauss(mean,stdDev,dtype,!1,seed),res=buffer(shape,dtype),i=0;i<res.values.length;i++)res.values[i]=randGauss.nextValue();return res.toTensor()}}),exports.randomGamma=operation_1.op({randomGamma_:function(shape,alpha,beta,dtype,seed){if(void 0===beta&&(beta=1),void 0===dtype&&(dtype="float32"),null==beta&&(beta=1),null==dtype&&(dtype="float32"),"float32"!==dtype&&"int32"!==dtype)throw new Error("Unsupported data type "+dtype);for(var rgamma=new rand_1.RandGamma(alpha,beta,dtype,seed),res=buffer(shape,dtype),i=0;i<res.values.length;i++)res.values[i]=rgamma.nextValue();return res.toTensor()}}),exports.randomUniform=operation_1.op({randomUniform_:function(shape,minval,maxval,dtype,seed){void 0===minval&&(minval=0),void 0===maxval&&(maxval=1),void 0===dtype&&(dtype="float32");for(var res=buffer(shape,dtype),random=new rand_1.UniformRandom(minval,maxval,null,seed),i=0;i<res.values.length;i++)res.values[i]=random.nextValue();return res.toTensor()}}),exports.reshape=operation_1.op({reshape_:function(x,shape){var $x=tensor_util_env_1.convertToTensor(x,"x","reshape",null);return shape=util.inferFromImplicitShape(shape,$x.size),util.assert($x.size===util.sizeFromShape(shape),function(){return"new shape and old shape must have the same number of elements."}),engine_1.ENGINE.runKernel(function(backend){return backend.reshape($x,shape)},{$x:$x},function(dy){return{$x:function(){return dy.reshape($x.shape)}}})}}),exports.spaceToBatchND=operation_1.op({spaceToBatchND_:function(x,blockShape,paddings){var $x=tensor_util_env_1.convertToTensor(x,"x","spaceToBatchND");return util.assert($x.rank>=1+blockShape.length,function(){return"input rank "+$x.rank+" should be > than [blockShape] "+blockShape.length}),util.assert(paddings.length===blockShape.length,function(){return"paddings.shape[0] "+paddings.length+" must be equal to [blockShape] "+blockShape.length}),util.assert($x.shape.reduce(function(a,b,i){return 0<i&&i<=blockShape.length?a&&(b+paddings[i-1][0]+paddings[i-1][1])%blockShape[i-1]==0:a},!0),function(){return"input spatial dimensions "+$x.shape.slice(1)+" with paddings "+paddings.toString()+" must be divisible by blockShapes "+blockShape.toString()}),engine_1.ENGINE.runKernel(function(backend){return backend.spaceToBatchND($x,blockShape,paddings)},{$x:$x},function(dy){return{$x:function(){return dy.batchToSpaceND(blockShape,paddings)}}})}}),exports.squeeze=operation_1.op({squeeze_:function(x,axis){var $x=tensor_util_env_1.convertToTensor(x,"x","squeeze");return exports.reshape($x,util.squeezeShape($x.shape,axis).newShape)}}),exports.stack=operation_1.op({stack_:function(tensors,axis){void 0===axis&&(axis=0);var $tensors=tensor_util_env_1.convertToTensorArray(tensors,"tensors","stack");if(util.assert(1<=$tensors.length,function(){return"Pass at least one tensor to tf.stack"}),1===$tensors.length)return $tensors[0].expandDims(axis);var rank=$tensors[0].rank,shape=$tensors[0].shape,dtype=$tensors[0].dtype;util.assert(axis<=rank,function(){return"Axis must be <= rank of the tensor"}),$tensors.forEach(function(t){util.assertShapesMatch(shape,t.shape,"All tensors passed to stack must have matching shapes")}),$tensors.forEach(function(t){util.assert(dtype===t.dtype,function(){return"All tensors passed to stack must have matching dtypes"})});var expandedTensors=$tensors.map(function(t){return t.expandDims(axis)});return concat_split_1.concat(expandedTensors,axis)}}),exports.tile=operation_1.op({tile_:function(x,reps){var $x=tensor_util_env_1.convertToTensor(x,"x","tile",null);return util.assert($x.rank===reps.length,function(){return"Error in transpose: rank of input "+$x.rank+" must match length of reps "+reps+"."}),engine_1.ENGINE.runKernel(function(backend,save){var res=backend.tile($x,reps);return save([$x]),res},{$x:$x},function(dy,saved){var $x=saved[0];return{$x:function(){var xGrad=tensor_ops_1.zerosLike($x);if(1===$x.rank)for(var i=0;i<reps[0];++i)xGrad=xGrad.add(dy.slice([i*$x.shape[0]],[$x.shape[0]]));else if(2===$x.rank)for(i=0;i<reps[0];++i)for(var j=0;j<reps[1];++j)xGrad=xGrad.add(dy.slice([i*$x.shape[0],j*$x.shape[1]],[$x.shape[0],$x.shape[1]]));else if(3===$x.rank)for(i=0;i<reps[0];++i)for(j=0;j<reps[1];++j)for(var k=0;k<reps[2];++k)xGrad=xGrad.add(dy.slice([i*$x.shape[0],j*$x.shape[1],k*$x.shape[2]],[$x.shape[0],$x.shape[1],$x.shape[2]]));else{if(4!==$x.rank)throw new Error("Gradient for tile operation is not implemented for rank-"+$x.rank+" tensors yet.");for(i=0;i<reps[0];++i)for(j=0;j<reps[1];++j)for(k=0;k<reps[2];++k)for(var l=0;l<reps[3];++l)xGrad=xGrad.add(dy.slice([i*$x.shape[0],j*$x.shape[1],k*$x.shape[2],l*$x.shape[3]],[$x.shape[0],$x.shape[1],$x.shape[2],$x.shape[3]]))}return xGrad}}})}}),exports.truncatedNormal=operation_1.op({truncatedNormal_:function(shape,mean,stdDev,dtype,seed){if(void 0===mean&&(mean=0),void 0===stdDev&&(stdDev=1),null!=dtype&&"bool"===dtype)throw new Error("Unsupported data type "+dtype);for(var randGauss=new rand_1.MPRandGauss(mean,stdDev,dtype,!0,seed),res=buffer(shape,dtype),i=0;i<res.values.length;i++)res.values[i]=randGauss.nextValue();return res.toTensor()}}),exports.unstack=operation_1.op({unstack_:function(x,axis){void 0===axis&&(axis=0),axis=axis||0;var $x=tensor_util_env_1.convertToTensor(x,"x","unstack");return util.assert(axis>=-$x.shape.length&&axis<$x.shape.length,function(){return"Axis = "+axis+" is not in [-"+$x.shape.length+", "+$x.shape.length+")"}),axis<0&&(axis+=$x.shape.length),engine_1.ENGINE.runKernel(function(backend){return backend.unstack($x,axis)},{$x:$x},function(dy){return{$x:function(){return exports.stack(dy,axis)}}})}}),exports.setdiff1dAsync=function(x,y){return __awaiter(this,void 0,void 0,function(){var $x,$y,xVals,yVals,ySet,outputSize,buffer,indices,i,p;return __generator(this,function(_a){switch(_a.label){case 0:return $x=tensor_util_env_1.convertToTensor(x,"x","setdiff1d"),$y=tensor_util_env_1.convertToTensor(y,"y","setdiff1d"),util.assert($x.dtype===$y.dtype,function(){return"x and y should have the same dtype, but got x ("+$x.dtype+") and y ("+$y.dtype+")."}),util.assert(1===$x.rank,function(){return"x should be 1D tensor, but got x ("+$x.shape+")."}),util.assert(1===$y.rank,function(){return"y should be 1D tensor, but got y ("+$y.shape+")."}),[4,$x.data()];case 1:return xVals=_a.sent(),[4,$y.data()];case 2:for(yVals=_a.sent(),ySet=new Set(yVals),i=outputSize=0;i<xVals.length;i++)ySet.has(xVals[i])||outputSize++;for(buffer=new tensor_1.TensorBuffer([outputSize],$x.dtype),indices=new tensor_1.TensorBuffer([outputSize],"int32"),p=i=0;i<xVals.length;i++)ySet.has(xVals[i])||(buffer.values[p]=xVals[i],indices.values[p]=i,p++);return[2,[buffer.toTensor(),indices.toTensor()]]}})})}},{"../engine":143,"../tensor":234,"../tensor_util_env":237,"../util":241,"./axis_util":165,"./concat_split":173,"./operation":195,"./rand":198,"./tensor_ops":216}],164:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.getReshaped=function(inputShape,blockShape,prod,batchToSpace){void 0===batchToSpace&&(batchToSpace=!0);var reshaped=[];if(batchToSpace)(reshaped=reshaped.concat(blockShape.slice(0))).push(inputShape[0]/prod),reshaped=reshaped.concat(inputShape.slice(1));else{reshaped=reshaped.concat(inputShape[0]);for(var spatialLength=blockShape.length,i=0;i<spatialLength;++i)reshaped=reshaped.concat([inputShape[i+1]/blockShape[i],blockShape[i]]);reshaped=reshaped.concat(inputShape.slice(spatialLength+1))}return reshaped},exports.getPermuted=function(reshapedRank,blockShapeRank,batchToSpace){void 0===batchToSpace&&(batchToSpace=!0);var permuted=[];if(batchToSpace){permuted.push(blockShapeRank);for(var i=blockShapeRank+1;i<reshapedRank;++i)i<=2*blockShapeRank?(permuted.push(i),permuted.push(i-(blockShapeRank+1))):permuted.push(i)}else{var permutedBeforeBatch=[],permutedAfterBatch=[];for(i=1;i<reshapedRank;++i)2*blockShapeRank+1<=i||i%2==1?permutedAfterBatch.push(i):permutedBeforeBatch.push(i);permuted.push.apply(permuted,permutedBeforeBatch),permuted.push(0),permuted.push.apply(permuted,permutedAfterBatch)}return permuted},exports.getReshapedPermuted=function(inputShape,blockShape,prod,batchToSpace){void 0===batchToSpace&&(batchToSpace=!0);var reshapedPermuted=[];batchToSpace?reshapedPermuted.push(inputShape[0]/prod):reshapedPermuted.push(inputShape[0]*prod);for(var i=1;i<inputShape.length;++i)i<=blockShape.length?batchToSpace?reshapedPermuted.push(blockShape[i-1]*inputShape[i]):reshapedPermuted.push(inputShape[i]/blockShape[i-1]):reshapedPermuted.push(inputShape[i]);return reshapedPermuted},exports.getSliceBeginCoords=function(crops,blockShape){for(var sliceBeginCoords=[0],i=0;i<blockShape;++i)sliceBeginCoords.push(crops[i][0]);return sliceBeginCoords},exports.getSliceSize=function(uncroppedShape,crops,blockShape){for(var sliceSize=uncroppedShape.slice(0,1),i=0;i<blockShape;++i)sliceSize.push(uncroppedShape[i+1]-crops[i][0]-crops[i][1]);return sliceSize}},{}],165:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var util=require("../util");function axesAreInnerMostDims(axes,rank){for(var i=0;i<axes.length;++i)if(axes[axes.length-i-1]!==rank-1-i)return!1;return!0}function combineLocations(outputLoc,reduceLoc,axes){for(var rank=outputLoc.length+reduceLoc.length,loc=[],outIdx=0,reduceIdx=0,dim=0;dim<rank;dim++)-1===axes.indexOf(dim)?loc.push(outputLoc[outIdx++]):loc.push(reduceLoc[reduceIdx++]);return loc}exports.axesAreInnerMostDims=axesAreInnerMostDims,exports.combineLocations=combineLocations,exports.computeOutAndReduceShapes=function(aShape,axes){for(var outShape=[],rank=aShape.length,dim=0;dim<rank;dim++)-1===axes.indexOf(dim)&&outShape.push(aShape[dim]);return[outShape,axes.map(function(dim){return aShape[dim]})]},exports.expandShapeToKeepDim=function(shape,axes){return combineLocations(shape,axes.map(function(x){return 1}),axes)},exports.assertAxesAreInnerMostDims=function(msg,axes,rank){util.assert(axesAreInnerMostDims(axes,rank),function(){return msg+" supports only inner-most axes for now. Got axes "+axes+" and rank-"+rank+" input."})},exports.getAxesPermutation=function(axes,rank){if(axesAreInnerMostDims(axes,rank))return null;for(var result=[],i=0;i<rank;++i)-1===axes.indexOf(i)&&result.push(i);return axes.forEach(function(axis){return result.push(axis)}),result},exports.getUndoAxesPermutation=function(axes){return axes.map(function(axis,i){return[i,axis]}).sort(function(a,b){return a[1]-b[1]}).map(function(x){return x[0]})},exports.getInnerMostAxes=function(numAxes,rank){for(var res=[],i=rank-numAxes;i<rank;++i)res.push(i);return res}},{"../util":241}],166:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var engine_1=require("../engine"),globals_1=require("../globals"),tensor_util_env_1=require("../tensor_util_env"),util=require("../util"),array_ops_1=require("./array_ops"),broadcast_util_1=require("./broadcast_util"),operation_1=require("./operation"),tensor_ops_1=require("./tensor_ops"),unary_ops_1=require("./unary_ops");function batchNorm2d_(x,mean,variance,offset,scale,varianceEpsilon){var $scale,$offset,$x=tensor_util_env_1.convertToTensor(x,"x","batchNorm"),$mean=tensor_util_env_1.convertToTensor(mean,"mean","batchNorm"),$variance=tensor_util_env_1.convertToTensor(variance,"variance","batchNorm");return null!=scale&&($scale=tensor_util_env_1.convertToTensor(scale,"scale","batchNorm")),null!=offset&&($offset=tensor_util_env_1.convertToTensor(offset,"offset","batchNorm")),util.assert(2===$x.rank,function(){return"Error in batchNorm3D: x must be rank 3 but got rank "+$x.rank+"."}),util.assert(2===$mean.rank||1===$mean.rank,function(){return"Error in batchNorm2D: mean must be rank 2 or rank 1 but got rank "+$mean.rank+"."}),util.assert(2===$variance.rank||1===$variance.rank,function(){return"Error in batchNorm2D: variance must be rank 2 or rank 1 but got rank "+$variance.rank+"."}),null!=$scale&&util.assert(2===$scale.rank||1===$scale.rank,function(){return"Error in batchNorm2D: scale must be rank 2 or rank 1 but got rank "+$scale.rank+"."}),null!=$offset&&util.assert(2===$offset.rank||1===$offset.rank,function(){return"Error in batchNorm2D: offset must be rank 2 or rank 1 but got rank "+$offset.rank+"."}),batchNorm_($x,$mean,$variance,$offset,$scale,varianceEpsilon)}function batchNorm3d_(x,mean,variance,offset,scale,varianceEpsilon){var $scale,$offset,$x=tensor_util_env_1.convertToTensor(x,"x","batchNorm"),$mean=tensor_util_env_1.convertToTensor(mean,"mean","batchNorm"),$variance=tensor_util_env_1.convertToTensor(variance,"variance","batchNorm");return null!=scale&&($scale=tensor_util_env_1.convertToTensor(scale,"scale","batchNorm")),null!=offset&&($offset=tensor_util_env_1.convertToTensor(offset,"offset","batchNorm")),util.assert(3===$x.rank,function(){return"Error in batchNorm3D: x must be rank 3 but got rank "+$x.rank+"."}),util.assert(3===$mean.rank||1===$mean.rank,function(){return"Error in batchNorm3D: mean must be rank 3 or rank 1 but got rank "+$mean.rank+"."}),util.assert(3===$variance.rank||1===$variance.rank,function(){return"Error in batchNorm3D: variance must be rank 3 or rank 1 but got rank "+$variance.rank+"."}),null!=$scale&&util.assert(3===$scale.rank||1===$scale.rank,function(){return"Error in batchNorm3D: scale must be rank 3 or rank 1 but got rank "+$scale.rank+"."}),null!=$offset&&util.assert(3===$offset.rank||1===$offset.rank,function(){return"Error in batchNorm3D: offset must be rank 3 or rank 1 but got rank "+$offset.rank+"."}),batchNorm_($x,$mean,$variance,$offset,$scale,varianceEpsilon)}function batchNorm4d_(x,mean,variance,offset,scale,varianceEpsilon){var $scale,$offset,$x=tensor_util_env_1.convertToTensor(x,"x","batchNorm"),$mean=tensor_util_env_1.convertToTensor(mean,"mean","batchNorm"),$variance=tensor_util_env_1.convertToTensor(variance,"variance","batchNorm");return null!=scale&&($scale=tensor_util_env_1.convertToTensor(scale,"scale","batchNorm")),null!=offset&&($offset=tensor_util_env_1.convertToTensor(offset,"offset","batchNorm")),util.assert(4===$x.rank,function(){return"Error in batchNorm4D: x must be rank 4 but got rank "+$x.rank+"."}),util.assert(4===$mean.rank||1===$mean.rank,function(){return"Error in batchNorm4D: mean must be rank 4 or rank 1 but got rank "+$mean.rank+"."}),util.assert(4===$variance.rank||1===$variance.rank,function(){return"Error in batchNorm4D: variance must be rank 4 or rank 1 but got rank "+$variance.rank+"."}),null!=$scale&&util.assert(4===$scale.rank||1===$scale.rank,function(){return"Error in batchNorm4D: scale must be rank 4 or rank 1 but got rank "+$scale.rank+"."}),null!=$offset&&util.assert(4===$offset.rank||1===$offset.rank,function(){return"Error in batchNorm4D: offset must be rank 4 or rank 1 but got rank "+$offset.rank+"."}),batchNorm_($x,$mean,$variance,$offset,$scale,varianceEpsilon)}function batchNorm_(x,mean,variance,offset,scale,varianceEpsilon){null==varianceEpsilon&&(varianceEpsilon=.001);var $scale,$offset,x4D,$x=tensor_util_env_1.convertToTensor(x,"x","batchNorm"),$mean=tensor_util_env_1.convertToTensor(mean,"mean","batchNorm"),$variance=tensor_util_env_1.convertToTensor(variance,"variance","batchNorm");null!=scale&&($scale=tensor_util_env_1.convertToTensor(scale,"scale","batchNorm")),null!=offset&&($offset=tensor_util_env_1.convertToTensor(offset,"offset","batchNorm")),util.assert($mean.rank===$variance.rank,function(){return"Batch normalization gradient requires mean and variance to have equal ranks."}),util.assert(null==$offset||$mean.rank===$offset.rank,function(){return"Batch normalization gradient requires mean and offset to have equal ranks."}),util.assert(null==$scale||$mean.rank===$scale.rank,function(){return"Batch normalization gradient requires mean and scale to have equal ranks."}),x4D=0===$x.rank||1===$x.rank?$x.as4D(1,1,1,$x.size):2===$x.rank?$x.as4D(1,1,$x.shape[0],$x.shape[1]):3===$x.rank?$x.as4D(1,$x.shape[0],$x.shape[1],$x.shape[2]):$x;return engine_1.ENGINE.runKernel(function(backend,save){var res=backend.batchNormalization(x4D,batchnormReshape4D($mean),batchnormReshape4D($variance),varianceEpsilon,batchnormReshape4D($scale),batchnormReshape4D($offset));return save([$x,$mean,$variance,$scale]),res},{$x:$x,$mean:$mean,$variance:$variance,$scale:$scale,$offset:$offset},function(dy,saved){var _a=saved,$x=_a[0],$mean=_a[1],$variance=_a[2],$scale=_a[3],scaleValue=null==$scale?tensor_ops_1.scalar(1):$scale,reductionAxes=broadcast_util_1.getReductionAxes($mean.shape,x4D.shape),tileShape=[];if(1===$mean.rank){for(var i=0;i<x4D.shape.length-1;++i)tileShape.push(x4D.shape[i]);tileShape.push(1)}var xMinusMean=$x.sub($mean),dyTimesScaleValue=dy.mul(scaleValue),oneOverSqrtVariance=unary_ops_1.rsqrt($variance.add(tensor_ops_1.scalar(varianceEpsilon))),minusHalfRCube=oneOverSqrtVariance.mul(oneOverSqrtVariance).mul(oneOverSqrtVariance).mul(tensor_ops_1.scalar(-.5));return{$x:function(){return 1===$mean.rank?dy.mul(array_ops_1.tile(oneOverSqrtVariance.as4D(1,1,1,$mean.shape[0]),tileShape)).mul(scaleValue).reshape($x.shape):dy.mul(oneOverSqrtVariance).mul(scaleValue).reshape($x.shape)},$mean:function(){var meanDer=oneOverSqrtVariance.mul(tensor_ops_1.scalar(-1)).mul(dyTimesScaleValue);return 1===$mean.rank&&(meanDer=meanDer.sum(reductionAxes)),meanDer.reshape($mean.shape)},$variance:function(){var varianceDer=minusHalfRCube.mul(xMinusMean).mul(dyTimesScaleValue);return 1===$mean.rank&&(varianceDer=varianceDer.sum(reductionAxes)),varianceDer.reshape($mean.shape)},$scale:function(){var xMinusMean2TimesRsqrt=xMinusMean.mul(oneOverSqrtVariance),scaleDer=dy.mul(xMinusMean2TimesRsqrt);return 1===$mean.rank&&(scaleDer=scaleDer.sum(reductionAxes)),scaleDer.reshape($mean.shape)},$offset:function(){var offsetDer=dy;return 1===$mean.rank&&(offsetDer=offsetDer.sum(reductionAxes)),offsetDer.reshape($mean.shape)}}}).reshape($x.shape)}function batchnormReshape4D(x){return null==x?null:0===x.rank?x.as1D():1===x.rank?x:2===x.rank?x.as4D(1,1,x.shape[0],x.shape[1]):3===x.rank?x.as4D(1,x.shape[0],x.shape[1],x.shape[2]):x}function warnDeprecation(){globals_1.deprecationWarn("tf.batchNormalization() is going away. Use tf.batchNorm() instead, and note the positional argument change of scale, offset, and varianceEpsilon")}exports.batchNormalization2d=operation_1.op({batchNormalization2d_:function(x,mean,variance,varianceEpsilon,scale,offset){return void 0===varianceEpsilon&&(varianceEpsilon=.001),warnDeprecation(),batchNorm2d_(x,mean,variance,offset,scale,varianceEpsilon)}}),exports.batchNormalization3d=operation_1.op({batchNormalization3d_:function(x,mean,variance,varianceEpsilon,scale,offset){return void 0===varianceEpsilon&&(varianceEpsilon=.001),warnDeprecation(),batchNorm3d_(x,mean,variance,offset,scale,varianceEpsilon)}}),exports.batchNormalization4d=operation_1.op({batchNormalization4d_:function(x,mean,variance,varianceEpsilon,scale,offset){return void 0===varianceEpsilon&&(varianceEpsilon=.001),warnDeprecation(),batchNorm4d_(x,mean,variance,offset,scale,varianceEpsilon)}}),exports.batchNormalization=operation_1.op({batchNormalization_:function(x,mean,variance,varianceEpsilon,scale,offset){return void 0===varianceEpsilon&&(varianceEpsilon=.001),warnDeprecation(),batchNorm_(x,mean,variance,offset,scale,varianceEpsilon)}}),exports.batchNorm=operation_1.op({batchNorm_:batchNorm_}),exports.batchNorm2d=operation_1.op({batchNorm2d_:batchNorm2d_}),exports.batchNorm3d=operation_1.op({batchNorm3d_:batchNorm3d_}),exports.batchNorm4d=operation_1.op({batchNorm4d_:batchNorm4d_})},{"../engine":143,"../globals":146,"../tensor_util_env":237,"../util":241,"./array_ops":163,"./broadcast_util":169,"./operation":195,"./tensor_ops":216,"./unary_ops":219}],167:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var engine_1=require("../engine"),tensor_util_1=require("../tensor_util"),tensor_util_env_1=require("../tensor_util_env"),types_1=require("../types"),util=require("../util"),broadcast_util=require("./broadcast_util"),operation_1=require("./operation"),tensor_ops_1=require("./tensor_ops"),unary_ops_1=require("./unary_ops");exports.add=operation_1.op({add_:function(a,b){var _a,$a=tensor_util_env_1.convertToTensor(a,"a","add"),$b=tensor_util_env_1.convertToTensor(b,"b","add");_a=tensor_util_1.makeTypesMatch($a,$b),$a=_a[0],$b=_a[1];var outShape=broadcast_util.assertAndGetBroadcastShape($a.shape,$b.shape);return engine_1.ENGINE.runKernel(function(backend){return backend.add($a,$b)},{$a:$a,$b:$b},function(dy){return{$a:function(){var res=dy,reduceAxes=broadcast_util.getReductionAxes($a.shape,outShape);return 0<reduceAxes.length&&(res=res.sum(reduceAxes)),res.reshape($a.shape)},$b:function(){var res=dy,reduceAxes=broadcast_util.getReductionAxes($b.shape,outShape);return 0<reduceAxes.length&&(res=res.sum(reduceAxes)),res.reshape($b.shape)}}})}}),exports.addN=operation_1.op({addN_:function(tensors){util.assert(Array.isArray(tensors),function(){return"The argument passed to tf.addN() must be a list of tensors"}),util.assert(1<=tensors.length,function(){return"Must pass at least one tensor to tf.addN(), but got "+tensors.length});var $tensors=tensors.map(function(t,i){return tensor_util_env_1.convertToTensor(t,"tensors"+i,"addN")}),firstTensor=$tensors[0];$tensors.forEach(function(t){if(t.dtype!==firstTensor.dtype)throw new Error("All tensors passed to tf.addN() must have the same dtype")}),$tensors.forEach(function(t){if(!util.arraysEqual(t.shape,firstTensor.shape))throw new Error("All tensors passed to tf.addN() must have the same shape")});var inputs=$tensors;return engine_1.ENGINE.runKernel(function(backend){return backend.addN($tensors)},inputs,function(dy){var ders={};return $tensors.forEach(function(t,i){ders[i]=function(){return dy.clone()}}),ders})}}),exports.addStrict=operation_1.op({addStrict_:function(a,b){var $a=tensor_util_env_1.convertToTensor(a,"a","addStrict"),$b=tensor_util_env_1.convertToTensor(b,"b","addStrict");return util.assertShapesMatch($a.shape,$b.shape,"Error in addStrict: "),$a.add($b)}}),exports.atan2=operation_1.op({atan2_:function(a,b){var _a,$a=tensor_util_env_1.convertToTensor(a,"a","atan2"),$b=tensor_util_env_1.convertToTensor(b,"b","atan2");_a=tensor_util_1.makeTypesMatch($a,$b),$a=_a[0],$b=_a[1];var outShape=broadcast_util.assertAndGetBroadcastShape($a.shape,$b.shape);return engine_1.ENGINE.runKernel(function(backend,save){var res=backend.atan2($a,$b);return save([$a,$b]),res},{$a:$a,$b:$b},function(dy,saved){var $a=saved[0],$b=saved[1];return{$a:function(){var d=exports.add($a.square(),$b.square()),res=dy.mul($b.div(d)),reduceAxes=broadcast_util.getReductionAxes($a.shape,outShape);return 0<reduceAxes.length&&(res=res.sum(reduceAxes)),res.reshape($a.shape)},$b:function(){var d=exports.add($a.square(),$b.square()),res=unary_ops_1.neg(dy.mul($a.div(d))),reduceAxes=broadcast_util.getReductionAxes($b.shape,outShape);return 0<reduceAxes.length&&(res=res.sum(reduceAxes)),res.reshape($b.shape)}}})}}),exports.div=operation_1.op({div_:function(a,b){var _a,$a=tensor_util_env_1.convertToTensor(a,"a","div"),$b=tensor_util_env_1.convertToTensor(b,"b","div");if(_a=tensor_util_1.makeTypesMatch($a,$b),$a=_a[0],$b=_a[1],"int32"===$a.dtype&&"int32"===$b.dtype)return exports.floorDiv($a,$b);var outShape=broadcast_util.assertAndGetBroadcastShape($a.shape,$b.shape);return engine_1.ENGINE.runKernel(function(backend,save){var res=backend.realDivide($a,$b);return save([$a,$b]),res},{$a:$a,$b:$b},function(dy,saved){var $a=saved[0],$b=saved[1];return{$a:function(){var res=dy.div($b.toFloat()),reduceAxes=broadcast_util.getReductionAxes($a.shape,outShape);return 0<reduceAxes.length?res.sum(reduceAxes).reshape($a.shape):res},$b:function(){var res=dy.mul($a.toFloat()),reduceAxes=broadcast_util.getReductionAxes($b.shape,outShape);0<reduceAxes.length&&(res=res.sum(reduceAxes).reshape($b.shape));var tmp=$b.square();return res.div(tmp.toFloat()).neg()}}})}}),exports.divStrict=operation_1.op({divStrict_:function(a,b){var $a=tensor_util_env_1.convertToTensor(a,"a","div"),$b=tensor_util_env_1.convertToTensor(b,"b","div");return util.assertShapesMatch($a.shape,$b.shape,"Error in divideStrict: "),$a.div($b)}}),exports.floorDiv=operation_1.op({floorDiv_:function(a,b){var _a,$a=tensor_util_env_1.convertToTensor(a,"a","floorDiv"),$b=tensor_util_env_1.convertToTensor(b,"b","floorDiv");_a=tensor_util_1.makeTypesMatch($a,$b),$a=_a[0],$b=_a[1];var outShape=broadcast_util.assertAndGetBroadcastShape($a.shape,$b.shape);return engine_1.ENGINE.runKernel(function(backend,save){var res=backend.floorDiv($a,$b);return save([$a,$b]),res},{$a:$a,$b:$b},function(dy,saved){var $a=saved[0],$b=saved[1];return{$a:function(){var res=dy.div($b.toFloat()),reduceAxes=broadcast_util.getReductionAxes($a.shape,outShape);return 0<reduceAxes.length?res.sum(reduceAxes).reshape($a.shape):res},$b:function(){var res=dy.mul($a.toFloat()),reduceAxes=broadcast_util.getReductionAxes($b.shape,outShape);0<reduceAxes.length&&(res=res.sum(reduceAxes).reshape($b.shape));var tmp=$b.square();return res.div(tmp.toFloat()).neg()}}})}}),exports.maximum=operation_1.op({maximum_:function(a,b){var _a,$a=tensor_util_env_1.convertToTensor(a,"a","maximum"),$b=tensor_util_env_1.convertToTensor(b,"b","maximum");return _a=tensor_util_1.makeTypesMatch($a,$b),$a=_a[0],$b=_a[1],"bool"===$a.dtype&&($a=$a.toInt(),$b=$b.toInt()),broadcast_util.assertAndGetBroadcastShape($a.shape,$b.shape),engine_1.ENGINE.runKernel(function(backend,save){var res=backend.maximum($a,$b);return save([$a,$b]),res},{$a:$a,$b:$b},function(dy,saved){var $a=saved[0],$b=saved[1];return{$a:function(){return dy.mul($a.greaterEqual($b).toFloat())},$b:function(){return dy.mul($a.less($b).toFloat())}}})}}),exports.maximumStrict=operation_1.op({maximumStrict_:function(a,b){var $a=tensor_util_env_1.convertToTensor(a,"a","maximumStrict"),$b=tensor_util_env_1.convertToTensor(b,"b","maximumStrict");return util.assertShapesMatch($a.shape,$b.shape,"Error in maximumStrict: "),$a.maximum($b)}}),exports.minimum=operation_1.op({minimum_:function(a,b){var _a,$a=tensor_util_env_1.convertToTensor(a,"a","minimum"),$b=tensor_util_env_1.convertToTensor(b,"b","minimum");return _a=tensor_util_1.makeTypesMatch($a,$b),$a=_a[0],$b=_a[1],"bool"===$a.dtype&&($a=$a.toInt(),$b=$b.toInt()),broadcast_util.assertAndGetBroadcastShape($a.shape,$b.shape),engine_1.ENGINE.runKernel(function(backend,save){var res=backend.minimum($a,$b);return save([$a,$b]),res},{$a:$a,$b:$b},function(dy,saved){var $a=saved[0],$b=saved[1];return{$a:function(){return dy.mul($a.lessEqual($b).toFloat())},$b:function(){return dy.mul($a.greater($b).toFloat())}}})}}),exports.minimumStrict=operation_1.op({minimumStrict_:function(a,b){var $a=tensor_util_env_1.convertToTensor(a,"a","minimumStrict"),$b=tensor_util_env_1.convertToTensor(b,"b","minimumStrict");return util.assertShapesMatch($a.shape,$b.shape,"Error in minimumStrict: "),$a.minimum($b)}}),exports.mod=operation_1.op({mod_:function(a,b){var _a,$a=tensor_util_env_1.convertToTensor(a,"a","mod"),$b=tensor_util_env_1.convertToTensor(b,"b","mod");_a=tensor_util_1.makeTypesMatch($a,$b),$a=_a[0],$b=_a[1];var outShape=broadcast_util.assertAndGetBroadcastShape($a.shape,$b.shape);return engine_1.ENGINE.runKernel(function(backend,save){var res=backend.mod($a,$b);return save([$a,$b]),res},{$a:$a,$b:$b},function(dy,saved){var $a=saved[0],$b=saved[1];return{$a:function(){var reduceAxes=broadcast_util.getReductionAxes($a.shape,outShape);return 0<reduceAxes.length?dy.sum(reduceAxes).reshape($a.shape):dy},$b:function(){var res=dy.mul($a.div($b).floor().neg()),reduceAxes=broadcast_util.getReductionAxes($b.shape,outShape);return 0<reduceAxes.length?res.sum(reduceAxes).reshape($b.shape):res}}})}}),exports.modStrict=operation_1.op({modStrict_:function(a,b){var $a=tensor_util_env_1.convertToTensor(a,"a","modStrict"),$b=tensor_util_env_1.convertToTensor(b,"b","modStrict");return util.assertShapesMatch($a.shape,$b.shape,"Error in modStrict: "),$a.mod($b)}}),exports.mul=operation_1.op({mul_:function(a,b){var _a,$a=tensor_util_env_1.convertToTensor(a,"a","mul"),$b=tensor_util_env_1.convertToTensor(b,"b","mul");_a=tensor_util_1.makeTypesMatch($a,$b),$a=_a[0],$b=_a[1];var outShape=broadcast_util.assertAndGetBroadcastShape($a.shape,$b.shape);return engine_1.ENGINE.runKernel(function(backend,save){var res=backend.multiply($a,$b);return save([$a,$b]),res},{$a:$a,$b:$b},function(dy,saved){var $a=saved[0],$b=saved[1];return{$a:function(){var res=dy.mul($b.toFloat()),reduceAxes=broadcast_util.getReductionAxes($a.shape,outShape);return 0<reduceAxes.length?res.sum(reduceAxes).reshape($a.shape):res},$b:function(){var res=dy.mul($a.toFloat()),reduceAxes=broadcast_util.getReductionAxes($b.shape,outShape);return 0<reduceAxes.length?res.sum(reduceAxes).reshape($b.shape):res}}})}}),exports.mulStrict=operation_1.op({mulStrict_:function(a,b){var $a=tensor_util_env_1.convertToTensor(a,"a","mul"),$b=tensor_util_env_1.convertToTensor(b,"b","mul");return util.assertShapesMatch($a.shape,$b.shape,"Error in multiplyStrict: "),$a.mul($b)}}),exports.pow=operation_1.op({pow_:function(base,exp){var $base=tensor_util_env_1.convertToTensor(base,"base","pow"),$exp=tensor_util_env_1.convertToTensor(exp,"exp","pow"),outShape=broadcast_util.assertAndGetBroadcastShape($base.shape,$exp.shape);return base=$base.cast(types_1.upcastType($base.dtype,$exp.dtype)),exp=$exp.cast(types_1.upcastType($base.dtype,$exp.dtype)),engine_1.ENGINE.runKernel(function(backend,save){var y=backend.pow($base,$exp);return save([$base,$exp,y]),y},{$base:$base,$exp:$exp},function(dy,saved){var $base=saved[0],$exp=saved[1],y=saved[2];return{$base:function(){var expFloat=$exp.toFloat(),res=dy.mul(expFloat.mul($base.pow(expFloat.sub(tensor_ops_1.scalar(1))))),reduceAxes=broadcast_util.getReductionAxes($base.shape,outShape);return 0<reduceAxes.length&&(res=res.sum(reduceAxes)),res.reshape($base.shape)},$exp:function(){var condition=$base.greater(0),logBase=$base.log().where(condition,tensor_ops_1.zerosLike($base)),res=dy.mul(y.mul(logBase)),reduceAxes=broadcast_util.getReductionAxes($exp.shape,outShape);return 0<reduceAxes.length&&(res=res.sum(reduceAxes)),res.reshape($exp.shape)}}})}}),exports.powStrict=operation_1.op({powStrict_:function(base,exp){return util.assertShapesMatch(base.shape,exp.shape,"Error in powStrict: "),base.pow(exp)}}),exports.squaredDifference=operation_1.op({squaredDifference_:function(a,b){var _a,$a=tensor_util_env_1.convertToTensor(a,"a","squaredDifference"),$b=tensor_util_env_1.convertToTensor(b,"b","squaredDifference");return _a=tensor_util_1.makeTypesMatch($a,$b),$a=_a[0],$b=_a[1],broadcast_util.assertAndGetBroadcastShape($a.shape,$b.shape),engine_1.ENGINE.runKernel(function(backend,save){var res=backend.squaredDifference($a,$b);return save([$a,$b]),res},{$a:$a,$b:$b},function(dy,saved){var $a=saved[0],$b=saved[1],two=tensor_ops_1.scalar(2);return{$a:function(){return dy.mul($a.sub($b).mul(two))},$b:function(){return dy.mul($b.sub($a).mul(two))}}})}}),exports.squaredDifferenceStrict=operation_1.op({squaredDifferenceStrict_:function(a,b){var $a=tensor_util_env_1.convertToTensor(a,"a","squaredDifferenceStrict"),$b=tensor_util_env_1.convertToTensor(b,"b","squaredDifferenceStrict");return util.assertShapesMatch($a.shape,$b.shape,"Error in squaredDifferenceStrict: "),$a.squaredDifference($b)}}),exports.sub=operation_1.op({sub_:function(a,b){var _a,$a=tensor_util_env_1.convertToTensor(a,"a","sub"),$b=tensor_util_env_1.convertToTensor(b,"b","sub");_a=tensor_util_1.makeTypesMatch($a,$b),$a=_a[0],$b=_a[1];var outShape=broadcast_util.assertAndGetBroadcastShape($a.shape,$b.shape);return engine_1.ENGINE.runKernel(function(backend){return backend.subtract($a,$b)},{$a:$a,$b:$b},function(dy){return{$a:function(){var res=dy,reduceAxes=broadcast_util.getReductionAxes($a.shape,outShape);return 0<reduceAxes.length&&(res=res.sum(reduceAxes)),res.reshape($a.shape)},$b:function(){var res=dy,reduceAxes=broadcast_util.getReductionAxes($b.shape,outShape);return 0<reduceAxes.length&&(res=res.sum(reduceAxes)),res.neg().reshape($b.shape)}}})}}),exports.subStrict=operation_1.op({subStrict_:function(a,b){var $a=tensor_util_env_1.convertToTensor(a,"a","subStrict"),$b=tensor_util_env_1.convertToTensor(b,"b","subStrict");return util.assertShapesMatch($a.shape,$b.shape,"Error in subStrict: "),$a.sub($b)}})},{"../engine":143,"../tensor_util":236,"../tensor_util_env":237,"../types":240,"../util":241,"./broadcast_util":169,"./operation":195,"./tensor_ops":216,"./unary_ops":219}],168:[function(require,module,exports){"use strict";var __awaiter=this&&this.__awaiter||function(thisArg,_arguments,P,generator){return new(P=P||Promise)(function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){result.done?resolve(result.value):new P(function(resolve){resolve(result.value)}).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())})},__generator=this&&this.__generator||function(thisArg,body){var f,y,t,g,_={label:0,sent:function(){if(1&t[0])throw t[1];return t[1]},trys:[],ops:[]};return g={next:verb(0),throw:verb(1),return:verb(2)},"function"==typeof Symbol&&(g[Symbol.iterator]=function(){return this}),g;function verb(n){return function(v){return function(op){if(f)throw new TypeError("Generator is already executing.");for(;_;)try{if(f=1,y&&(t=2&op[0]?y.return:op[0]?y.throw||((t=y.return)&&t.call(y),0):y.next)&&!(t=t.call(y,op[1])).done)return t;switch(y=0,t&&(op=[2&op[0],t.value]),op[0]){case 0:case 1:t=op;break;case 4:return _.label++,{value:op[1],done:!1};case 5:_.label++,y=op[1],op=[0];continue;case 7:op=_.ops.pop(),_.trys.pop();continue;default:if(!(t=0<(t=_.trys).length&&t[t.length-1])&&(6===op[0]||2===op[0])){_=0;continue}if(3===op[0]&&(!t||op[1]>t[0]&&op[1]<t[3])){_.label=op[1];break}if(6===op[0]&&_.label<t[1]){_.label=t[1],t=op;break}if(t&&_.label<t[2]){_.label=t[2],_.ops.push(op);break}t[2]&&_.ops.pop(),_.trys.pop();continue}op=body.call(thisArg,_)}catch(e){op=[6,e],y=0}finally{f=t=0}if(5&op[0])throw op[1];return{value:op[0]?op[1]:void 0,done:!0}}([n,v])}}};Object.defineProperty(exports,"__esModule",{value:!0});var tensor_util_env_1=require("../tensor_util_env"),util=require("../util"),logical_ops_1=require("./logical_ops"),segment_ops_1=require("./segment_ops");exports.booleanMaskAsync=function(tensor,mask,axis){return __awaiter(this,void 0,void 0,function(){var $tensor,$mask,axisFrom,maskDim,tensorShape,leadingSize,i,targetTensorShape,reshapedTensor,reshapedMask,positivePositions,indices,res;return __generator(this,function(_a){switch(_a.label){case 0:for($tensor=tensor_util_env_1.convertToTensor(tensor,"tensor","boolMask"),$mask=tensor_util_env_1.convertToTensor(mask,"mask","boolMask","bool"),axisFrom=null==axis?0:axis,maskDim=$mask.rank,tensorShape=$tensor.shape,util.assert(0<maskDim,function(){return"mask cannot be scalar"}),util.assertShapesMatch(tensorShape.slice(axisFrom,axisFrom+maskDim),$mask.shape,"mask's shape must match the first K dimensions of tensor's shape,"),leadingSize=1,i=axisFrom;i<axisFrom+maskDim;i++)leadingSize*=tensorShape[i];return targetTensorShape=tensorShape.slice(0,axisFrom).concat([leadingSize],tensorShape.slice(axisFrom+maskDim)),reshapedTensor=$tensor.reshape(targetTensorShape),reshapedMask=$mask.reshape([-1]),[4,logical_ops_1.whereAsync(reshapedMask)];case 1:return positivePositions=_a.sent(),indices=positivePositions.squeeze([1]),res=segment_ops_1.gather(reshapedTensor,indices,axisFrom),tensor!==$tensor&&$tensor.dispose(),mask!==$mask&&$mask.dispose(),indices.dispose(),reshapedTensor.dispose(),reshapedMask.dispose(),positivePositions.dispose(),[2,res]}})})}},{"../tensor_util_env":237,"../util":241,"./logical_ops":188,"./segment_ops":205}],169:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.getBroadcastDims=function(inShape,outShape){for(var inRank=inShape.length,dims=[],i=0;i<inRank;i++){var dim=inRank-1-i,a=inShape[dim]||1;1<(outShape[outShape.length-1-i]||1)&&1===a&&dims.unshift(dim)}return dims},exports.getReductionAxes=function(inShape,outShape){for(var result=[],i=0;i<outShape.length;i++){var inDim=inShape[inShape.length-i-1],outAxis=outShape.length-i-1,outDim=outShape[outAxis];(null==inDim||1===inDim&&1<outDim)&&result.unshift(outAxis)}return result},exports.assertAndGetBroadcastShape=function(shapeA,shapeB){for(var result=[],l=Math.max(shapeA.length,shapeB.length),i=0;i<l;i++){var a=shapeA[shapeA.length-i-1];null==a&&(a=1);var b=shapeB[shapeB.length-i-1];if(null==b&&(b=1),1===a)result.unshift(b);else if(1===b)result.unshift(a);else{if(a!==b)throw Error("Operands could not be broadcast together with shapes "+shapeA+" and "+shapeB+".");result.unshift(a)}}return result}},{}],170:[function(require,module,exports){"use strict";var __awaiter=this&&this.__awaiter||function(thisArg,_arguments,P,generator){return new(P=P||Promise)(function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){result.done?resolve(result.value):new P(function(resolve){resolve(result.value)}).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())})},__generator=this&&this.__generator||function(thisArg,body){var f,y,t,g,_={label:0,sent:function(){if(1&t[0])throw t[1];return t[1]},trys:[],ops:[]};return g={next:verb(0),throw:verb(1),return:verb(2)},"function"==typeof Symbol&&(g[Symbol.iterator]=function(){return this}),g;function verb(n){return function(v){return function(op){if(f)throw new TypeError("Generator is already executing.");for(;_;)try{if(f=1,y&&(t=2&op[0]?y.return:op[0]?y.throw||((t=y.return)&&t.call(y),0):y.next)&&!(t=t.call(y,op[1])).done)return t;switch(y=0,t&&(op=[2&op[0],t.value]),op[0]){case 0:case 1:t=op;break;case 4:return _.label++,{value:op[1],done:!1};case 5:_.label++,y=op[1],op=[0];continue;case 7:op=_.ops.pop(),_.trys.pop();continue;default:if(!(t=0<(t=_.trys).length&&t[t.length-1])&&(6===op[0]||2===op[0])){_=0;continue}if(3===op[0]&&(!t||op[1]>t[0]&&op[1]<t[3])){_.label=op[1];break}if(6===op[0]&&_.label<t[1]){_.label=t[1],t=op;break}if(t&&_.label<t[2]){_.label=t[2],_.ops.push(op);break}t[2]&&_.ops.pop(),_.trys.pop();continue}op=body.call(thisArg,_)}catch(e){op=[6,e],y=0}finally{f=t=0}if(5&op[0])throw op[1];return{value:op[0]?op[1]:void 0,done:!0}}([n,v])}}};Object.defineProperty(exports,"__esModule",{value:!0});var engine_1=require("../engine"),tensor_1=require("../tensor"),tensor_util_env_1=require("../tensor_util_env"),operation_1=require("./operation");exports.toPixels=function(img,canvas){return __awaiter(this,void 0,void 0,function(){var $img,_a,height,width,depth,data,minTensor,maxTensor,_b,minVals,maxVals,min,max,multiplier,bytes,i,r,g,b,a,j,ctx,imageData;return __generator(this,function(_c){switch(_c.label){case 0:if($img=tensor_util_env_1.convertToTensor(img,"img","toPixels"),img instanceof tensor_1.Tensor||($img=$img.toInt()),2!==$img.rank&&3!==$img.rank)throw new Error("toPixels only supports rank 2 or 3 tensors, got rank "+$img.rank+".");if(_a=$img.shape.slice(0,2),height=_a[0],width=_a[1],4<(depth=2===$img.rank?1:$img.shape[2])||2===depth)throw new Error("toPixels only supports depth of size 1, 3 or 4 but got "+depth);return[4,$img.data()];case 1:return data=_c.sent(),minTensor=$img.min(),maxTensor=$img.max(),[4,Promise.all([minTensor.data(),maxTensor.data()])];case 2:if(_b=_c.sent(),minVals=_b[0],maxVals=_b[1],min=minVals[0],max=maxVals[0],minTensor.dispose(),maxTensor.dispose(),"float32"===$img.dtype){if(min<0||1<max)throw new Error("Tensor values for a float32 Tensor must be in the range [0 - 1] but got range ["+min+" - "+max+"].")}else{if("int32"!==$img.dtype)throw new Error("Unsupported type for toPixels: "+$img.dtype+". Please use float32 or int32 tensors.");if(min<0||255<max)throw new Error("Tensor values for a int32 Tensor must be in the range [0 - 255] but got range ["+min+" - "+max+"].")}for(multiplier="float32"===$img.dtype?255:1,bytes=new Uint8ClampedArray(width*height*4),i=0;i<height*width;++i)a=b=g=r=void 0,1===depth?(r=data[i]*multiplier,g=data[i]*multiplier,b=data[i]*multiplier,a=255):3===depth?(r=data[3*i]*multiplier,g=data[3*i+1]*multiplier,b=data[3*i+2]*multiplier,a=255):4===depth&&(r=data[4*i]*multiplier,g=data[4*i+1]*multiplier,b=data[4*i+2]*multiplier,a=data[4*i+3]*multiplier),bytes[0+(j=4*i)]=Math.round(r),bytes[1+j]=Math.round(g),bytes[2+j]=Math.round(b),bytes[3+j]=Math.round(a);return null!=canvas&&(canvas.width=width,canvas.height=height,ctx=canvas.getContext("2d"),imageData=new ImageData(bytes,width,height),ctx.putImageData(imageData,0,0)),$img!==img&&$img.dispose(),[2,bytes]}})})},exports.fromPixels=operation_1.op({fromPixels_:function(pixels,numChannels){if(void 0===numChannels&&(numChannels=3),4<numChannels)throw new Error("Cannot construct Tensor with more than 4 channels from pixels.");return engine_1.ENGINE.fromPixels(pixels,numChannels)}})},{"../engine":143,"../tensor":234,"../tensor_util_env":237,"./operation":195}],171:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var engine_1=require("../engine"),tensor_util_1=require("../tensor_util"),tensor_util_env_1=require("../tensor_util_env"),util_1=require("../util"),broadcast_util_1=require("./broadcast_util"),operation_1=require("./operation"),tensor_ops_1=require("./tensor_ops");exports.equal=operation_1.op({equal_:function(a,b){var _a,$a=tensor_util_env_1.convertToTensor(a,"a","equal"),$b=tensor_util_env_1.convertToTensor(b,"b","equal");return _a=tensor_util_1.makeTypesMatch($a,$b),$a=_a[0],$b=_a[1],broadcast_util_1.assertAndGetBroadcastShape($a.shape,$b.shape),engine_1.ENGINE.runKernel(function(backend){return backend.equal($a,$b)},{$a:$a,$b:$b})}}),exports.equalStrict=operation_1.op({equalStrict_:function(a,b){var $a=tensor_util_env_1.convertToTensor(a,"a","equalStrict"),$b=tensor_util_env_1.convertToTensor(b,"b","equalStrict");return util_1.assertShapesMatch($a.shape,$b.shape,"Error in equalStrict: "),$a.equal($b)}}),exports.greater=operation_1.op({greater_:function(a,b){var _a,$a=tensor_util_env_1.convertToTensor(a,"a","greater"),$b=tensor_util_env_1.convertToTensor(b,"b","greater");return _a=tensor_util_1.makeTypesMatch($a,$b),$a=_a[0],$b=_a[1],broadcast_util_1.assertAndGetBroadcastShape($a.shape,$b.shape),engine_1.ENGINE.runKernel(function(backend){return backend.greater($a,$b)},{$a:$a,$b:$b})}}),exports.greaterEqual=operation_1.op({greaterEqual_:function(a,b){var _a,$a=tensor_util_env_1.convertToTensor(a,"a","greaterEqual"),$b=tensor_util_env_1.convertToTensor(b,"b","greaterEqual");return _a=tensor_util_1.makeTypesMatch($a,$b),$a=_a[0],$b=_a[1],broadcast_util_1.assertAndGetBroadcastShape($a.shape,$b.shape),engine_1.ENGINE.runKernel(function(backend,save){var res=backend.greaterEqual($a,$b);return save([$a,$b]),res},{$a:$a,$b:$b},function(dy,saved){var $a=saved[0],$b=saved[1];return{$a:function(){return tensor_ops_1.zerosLike($a)},$b:function(){return tensor_ops_1.zerosLike($b)}}})}}),exports.greaterEqualStrict=operation_1.op({greaterEqualStrict_:function(a,b){var $a=tensor_util_env_1.convertToTensor(a,"a","greaterEqualStrict"),$b=tensor_util_env_1.convertToTensor(b,"b","greaterEqualStrict");return util_1.assertShapesMatch($a.shape,$b.shape,"Error in greaterEqualStrict: "),$a.greaterEqual($b)}}),exports.greaterStrict=operation_1.op({greaterStrict_:function(a,b){var $a=tensor_util_env_1.convertToTensor(a,"a","greaterStrict"),$b=tensor_util_env_1.convertToTensor(b,"b","greaterStrict");return util_1.assertShapesMatch($a.shape,$b.shape,"Error in greaterStrict: "),$a.greater($b)}}),exports.less=operation_1.op({less_:function(a,b){var _a,$a=tensor_util_env_1.convertToTensor(a,"a","less"),$b=tensor_util_env_1.convertToTensor(b,"b","less");return _a=tensor_util_1.makeTypesMatch($a,$b),$a=_a[0],$b=_a[1],broadcast_util_1.assertAndGetBroadcastShape($a.shape,$b.shape),engine_1.ENGINE.runKernel(function(backend){return backend.less($a,$b)},{$a:$a,$b:$b})}}),exports.lessEqual=operation_1.op({lessEqual_:function(a,b){var _a,$a=tensor_util_env_1.convertToTensor(a,"a","lessEqual"),$b=tensor_util_env_1.convertToTensor(b,"b","lessEqual");return _a=tensor_util_1.makeTypesMatch($a,$b),$a=_a[0],$b=_a[1],broadcast_util_1.assertAndGetBroadcastShape($a.shape,$b.shape),engine_1.ENGINE.runKernel(function(backend){return backend.lessEqual($a,$b)},{$a:$a,$b:$b})}}),exports.lessEqualStrict=operation_1.op({lessEqualStrict_:function(a,b){var $a=tensor_util_env_1.convertToTensor(a,"a","lessEqualStrict"),$b=tensor_util_env_1.convertToTensor(b,"b","lessEqualStrict");return util_1.assertShapesMatch($a.shape,$b.shape,"Error in lessEqualStrict: "),$a.lessEqual($b)}}),exports.lessStrict=operation_1.op({lessStrict_:function(a,b){var $a=tensor_util_env_1.convertToTensor(a,"a","lessStrict"),$b=tensor_util_env_1.convertToTensor(b,"b","lessStrict");return util_1.assertShapesMatch($a.shape,$b.shape,"Error in lessStrict: "),$a.less($b)}}),exports.notEqual=operation_1.op({notEqual_:function(a,b){var _a,$a=tensor_util_env_1.convertToTensor(a,"a","notEqual"),$b=tensor_util_env_1.convertToTensor(b,"b","notEqual");return _a=tensor_util_1.makeTypesMatch($a,$b),$a=_a[0],$b=_a[1],broadcast_util_1.assertAndGetBroadcastShape($a.shape,$b.shape),engine_1.ENGINE.runKernel(function(backend){return backend.notEqual($a,$b)},{$a:$a,$b:$b})}}),exports.notEqualStrict=operation_1.op({notEqualStrict_:function(a,b){var $a=tensor_util_env_1.convertToTensor(a,"a","notEqualStrict"),$b=tensor_util_env_1.convertToTensor(b,"b","notEqualStrict");return util_1.assertShapesMatch($a.shape,$b.shape,"Error in notEqualStrict: "),$a.notEqual($b)}})},{"../engine":143,"../tensor_util":236,"../tensor_util_env":237,"../util":241,"./broadcast_util":169,"./operation":195,"./tensor_ops":216}],172:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var engine_1=require("../engine"),tensor_util_env_1=require("../tensor_util_env"),util=require("../util"),operation_1=require("./operation");exports.complex=operation_1.op({complex_:function(real,imag){var $real=tensor_util_env_1.convertToTensor(real,"real","complex"),$imag=tensor_util_env_1.convertToTensor(imag,"imag","complex");return util.assertShapesMatch($real.shape,$imag.shape,"real and imag shapes, "+$real.shape+" and "+$imag.shape+", must match in call to tf.complex()."),engine_1.ENGINE.runKernel(function(backend){return backend.complex($real,$imag)},{$real:$real,$imag:$imag})}}),exports.real=operation_1.op({real_:function(input){var $input=tensor_util_env_1.convertToTensor(input,"input","real");return engine_1.ENGINE.runKernel(function(backend){return backend.real($input)},{$input:$input})}}),exports.imag=operation_1.op({imag_:function(input){var $input=tensor_util_env_1.convertToTensor(input,"input","imag");return engine_1.ENGINE.runKernel(function(backend){return backend.imag($input)},{$input:$input})}})},{"../engine":143,"../tensor_util_env":237,"../util":241,"./operation":195}],173:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var engine_1=require("../engine"),tensor_util_env_1=require("../tensor_util_env"),util_1=require("../util"),util_2=require("../util"),concat_util_1=require("./concat_util"),operation_1=require("./operation"),tensor_ops_1=require("./tensor_ops");exports.concat=operation_1.op({concat_:function(tensors,axis){void 0===axis&&(axis=0),util_1.assert(1<=tensors.length,function(){return"Pass at least one tensor to concat"});var $tensors=tensor_util_env_1.convertToTensorArray(tensors,"tensors","concat");"complex64"===$tensors[0].dtype&&$tensors.forEach(function(tensor){if("complex64"!==tensor.dtype)throw new Error("Cannot concatenate complex64 tensors with a tensor\n          with dtype "+tensor.dtype+". ")}),axis=util_2.parseAxisParam(axis,$tensors[0].shape)[0];var outShape=concat_util_1.computeOutShape($tensors.map(function(t){return t.shape}),axis);if(0===util_1.sizeFromShape(outShape))return tensor_ops_1.tensor([],outShape);if(1===($tensors=$tensors.filter(function(t){return 0<t.size})).length)return $tensors[0];var shapes=$tensors.map(function(t){return t.shape});concat_util_1.assertParamsConsistent(shapes,axis);var inputs=$tensors;return engine_1.ENGINE.runKernel(function(backend){return backend.concat($tensors,axis)},inputs,function(dy){var sizeSplits=shapes.map(function(s){return s[axis]});return exports.split(dy,sizeSplits,axis).map(function(t){return function(){return t}})})}}),exports.concat1d=operation_1.op({concat1d_:function(tensors){return exports.concat(tensors,0)}}),exports.concat2d=operation_1.op({concat2d_:function(tensors,axis){return exports.concat(tensors,axis)}}),exports.concat3d=operation_1.op({concat3d_:function(tensors,axis){return exports.concat(tensors,axis)}}),exports.concat4d=operation_1.op({concat4d_:function(tensors,axis){return exports.concat(tensors,axis)}}),exports.split=operation_1.op({split_:function(x,numOrSizeSplits,axis){void 0===axis&&(axis=0);var splitSizes,$x=tensor_util_env_1.convertToTensor(x,"x","split");return axis=util_2.parseAxisParam(axis,$x.shape)[0],splitSizes="number"==typeof numOrSizeSplits?(util_1.assert($x.shape[axis]%numOrSizeSplits==0,function(){return"Number of splits must evenly divide the axis."}),new Array(numOrSizeSplits).fill($x.shape[axis]/numOrSizeSplits)):(util_1.assert($x.shape[axis]===numOrSizeSplits.reduce(function(a,b){return a+b}),function(){return"The sum of sizes must match the size of the axis dimension."}),numOrSizeSplits),engine_1.ENGINE.runKernel(function(backend){return backend.split($x,splitSizes,axis)},{$x:$x},function(dy){return{$x:function(){return exports.concat(dy,axis)}}})}})},{"../engine":143,"../tensor_util_env":237,"../util":241,"./concat_util":174,"./operation":195,"./tensor_ops":216}],174:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var util=require("../util");exports.assertParamsConsistent=function(shapes,axis){var rank=shapes[0].length;shapes.forEach(function(shape,i){util.assert(shape.length===rank,function(){return"Error in concat"+rank+"D: rank of tensors["+i+"] must be the same as the rank of the rest ("+rank+")"})}),util.assert(0<=axis&&axis<rank,function(){return"Error in concat"+rank+"D: axis must be between 0 and "+(rank-1)+"."});var firstShape=shapes[0];shapes.forEach(function(shape,i){for(var r=0;r<rank;r++)util.assert(r===axis||shape[r]===firstShape[r],function(){return"Error in concat"+rank+"D: Shape of tensors["+i+"] ("+shape+") does not match the shape of the rest ("+firstShape+") along the non-concatenated axis "+i+"."})})},exports.computeOutShape=function(shapes,axis){for(var outputShape=shapes[0].slice(),i=1;i<shapes.length;i++)outputShape[axis]+=shapes[i][axis];return outputShape}},{"../util":241}],175:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var tensor_util_env_1=require("../tensor_util_env"),util=require("../util"),array_ops_1=require("./array_ops"),operation_1=require("./operation");function confusionMatrix_(labels,predictions,numClasses){var $labels=tensor_util_env_1.convertToTensor(labels,"labels","confusionMatrix"),$predictions=tensor_util_env_1.convertToTensor(predictions,"predictions","confusionMatrix");util.assert(null==numClasses||0<numClasses&&Number.isInteger(numClasses),function(){return"If provided, numClasses must be a positive integer, but got "+numClasses}),util.assert(1===$labels.rank,function(){return"Expected the rank of labels to be 1, but got "+$labels.rank}),util.assert(1===$predictions.rank,function(){return"Expected the rank of predictions to be 1, but got "+$predictions.rank}),util.assert($labels.shape[0]===$predictions.shape[0],function(){return"Mismatch in the number of examples: "+$labels.shape[0]+" vs. "+$predictions.shape[0]+". Labels and predictions should have the same number of elements."}),util.assert(0<numClasses&&Number.isInteger(numClasses),function(){return"numClasses is required to be a positive integer, but got "+numClasses});var oneHotLabels=array_ops_1.oneHot($labels.asType("int32"),numClasses),oneHotPredictions=array_ops_1.oneHot($predictions.asType("int32"),numClasses);return oneHotLabels.transpose().matMul(oneHotPredictions).asType("int32")}exports.confusionMatrix_=confusionMatrix_,exports.confusionMatrix=operation_1.op({confusionMatrix_:confusionMatrix_})},{"../tensor_util_env":237,"../util":241,"./array_ops":163,"./operation":195}],176:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var engine_1=require("../engine"),tensor_util_env_1=require("../tensor_util_env"),util=require("../util"),conv_util=require("./conv_util"),operation_1=require("./operation");function conv2dDerInput_(xShape,dy,filter,strides,pad,dataFormat,dimRoundingMode){void 0===dataFormat&&(dataFormat="NHWC"),util.assert(xShape.length===dy.rank,function(){return"Length of inShape ("+xShape.length+") and rank of dy ("+dy.rank+") must match"});var xShape4D=xShape,dy4D=dy,reshapedTo4D=!1;3===dy.rank&&(reshapedTo4D=!0,dy4D=dy.as4D(1,dy.shape[0],dy.shape[1],dy.shape[2]),xShape4D=[1,xShape[0],xShape[1],xShape[2]]),util.assert(4===xShape4D.length,function(){return"Error in conv2dDerInput: inShape must be length 4, but got length "+xShape4D.length+"."}),util.assert(4===dy4D.rank,function(){return"Error in conv2dDerInput: dy must be rank 4, but got rank "+dy4D.rank}),util.assert(4===filter.rank,function(){return"Error in conv2dDerInput: filter must be rank 4, but got rank "+filter.rank});var inDepth="NHWC"===dataFormat?xShape4D[3]:xShape4D[1],outDepth="NHWC"===dataFormat?dy4D.shape[3]:dy4D.shape[1];util.assert(inDepth===filter.shape[2],function(){return"Error in conv2dDerInput: depth of input ("+inDepth+") must match input depth for filter "+filter.shape[2]+"."}),util.assert(outDepth===filter.shape[3],function(){return"Error in conv2dDerInput: depth of output ("+outDepth+") must match output depth for filter "+filter.shape[3]+"."}),null!=dimRoundingMode&&util.assert(util.isInt(pad),function(){return"Error in conv2dDerInput: pad must be an integer when using, dimRoundingMode "+dimRoundingMode+" but got pad "+pad+"."});var $dataFormat=conv_util.convertConv2DDataFormat(dataFormat),convInfo=conv_util.computeConv2DInfo(xShape4D,filter.shape,strides,1,pad,dimRoundingMode,!1,$dataFormat),res=engine_1.ENGINE.runKernel(function(backend,save){var res=backend.conv2dDerInput(dy4D,filter,convInfo);return save([filter,dy4D]),res},{dy4D:dy4D,filter:filter},function(ddx,saved){var filter=saved[0],dy4D=saved[1];return{dy4D:function(){return exports.conv2d(ddx,filter,strides,pad,dataFormat,1,dimRoundingMode)},filter:function(){return exports.conv2dDerFilter(ddx,dy4D,filter.shape,strides,pad,dataFormat,dimRoundingMode)}}});return reshapedTo4D?res.as3D(res.shape[1],res.shape[2],res.shape[3]):res}function conv2dDerFilter_(x,dy,filterShape,strides,pad,dataFormat,dimRoundingMode){void 0===dataFormat&&(dataFormat="NHWC");var x4D=x;3===x.rank&&(x4D=x.as4D(1,x.shape[0],x.shape[1],x.shape[2]));var dy4D=dy;3===dy4D.rank&&(dy4D=dy.as4D(1,dy.shape[0],dy.shape[1],dy.shape[2])),util.assert(4===x4D.rank,function(){return"Error in conv2dDerFilter: input must be rank 4, but got shape "+x4D.shape+"."}),util.assert(4===dy4D.rank,function(){return"Error in conv2dDerFilter: dy must be rank 4, but got shape "+dy4D.shape+"."}),util.assert(4===filterShape.length,function(){return"Error in conv2dDerFilter: filterShape must be length 4, but got "+filterShape+"."});var inDepth="NHWC"===dataFormat?x4D.shape[3]:x4D.shape[1],outDepth="NHWC"===dataFormat?dy4D.shape[3]:dy4D.shape[1];util.assert(inDepth===filterShape[2],function(){return"Error in conv2dDerFilter: depth of input "+inDepth+") must match input depth in filter ("+filterShape[2]+"."}),util.assert(outDepth===filterShape[3],function(){return"Error in conv2dDerFilter: depth of dy ("+outDepth+") must match output depth for filter ("+filterShape[3]+")."}),null!=dimRoundingMode&&util.assert(util.isInt(pad),function(){return"Error in conv2dDerFilter: pad must be an integer when using, dimRoundingMode "+dimRoundingMode+" but got pad "+pad+"."});var $dataFormat=conv_util.convertConv2DDataFormat(dataFormat),convInfo=conv_util.computeConv2DInfo(x4D.shape,filterShape,strides,1,pad,dimRoundingMode,!1,$dataFormat);return engine_1.ENGINE.runKernel(function(backend){return backend.conv2dDerFilter(x4D,dy4D,convInfo)},{x4D:x4D,dy4D:dy4D})}function tupleValuesAreOne(param){var _a=function(param){return"number"==typeof param?[param,param,param]:2===param.length?[param[0],param[1],1]:param}(param),dimA=_a[0],dimB=_a[1],dimC=_a[2];return 1===dimA&&1===dimB&&1===dimC}function conv3dDerInput_(xShape,dy,filter,strides,pad){util.assert(xShape.length===dy.rank,function(){return"Length of inShape ("+xShape.length+") and rank of dy ("+dy.rank+") must match"});var xShape5D=xShape,dy5D=dy,reshapedTo5D=!1;4===dy.rank&&(reshapedTo5D=!0,dy5D=dy.as5D(1,dy.shape[0],dy.shape[1],dy.shape[2],dy.shape[3]),xShape5D=[1,xShape[0],xShape[1],xShape[2],xShape[3]]);var inDepth=xShape5D[4],outDepth=dy5D.shape[4];util.assert(5===xShape5D.length,function(){return"Error in conv3dDerInput: inShape must be length 5, but got length "+xShape5D.length+"."}),util.assert(5===dy5D.rank,function(){return"Error in conv3dDerInput: dy must be rank 5, but got rank "+dy5D.rank}),util.assert(5===filter.rank,function(){return"Error in conv3dDerInput: filter must be rank 5, but got rank "+filter.rank}),util.assert(inDepth===filter.shape[3],function(){return"Error in conv3dDerInput: depth of input ("+inDepth+") must match input depth for filter "+filter.shape[3]+"."}),util.assert(outDepth===filter.shape[4],function(){return"Error in conv3dDerInput: depth of output ("+outDepth+") must match output depth for filter "+filter.shape[4]+"."});var convInfo=conv_util.computeConv3DInfo(xShape5D,filter.shape,strides,1,pad),res=engine_1.ENGINE.runKernel(function(backend){return backend.conv3dDerInput(dy5D,filter,convInfo)},{dy5D:dy5D});return reshapedTo5D?res.as4D(res.shape[1],res.shape[2],res.shape[3],res.shape[4]):res}exports.conv1d=operation_1.op({conv1d_:function(x,filter,stride,pad,dataFormat,dilation,dimRoundingMode){void 0===dataFormat&&(dataFormat="NWC"),void 0===dilation&&(dilation=1);var $x=tensor_util_env_1.convertToTensor(x,"x","conv1d"),$filter=tensor_util_env_1.convertToTensor(filter,"filter","conv1d"),x3D=$x,reshapedTo3D=!1;2===$x.rank&&(reshapedTo3D=!0,x3D=$x.as3D(1,$x.shape[0],$x.shape[1])),util.assert(3===x3D.rank,function(){return"Error in conv1d: input must be rank 3, but got rank "+x3D.rank+"."}),util.assert(3===$filter.rank,function(){return"Error in conv1d: filter must be rank 3, but got rank "+$filter.rank+"."}),null!=dimRoundingMode&&util.assert(util.isInt(pad),function(){return"Error in conv1d: pad must be an integer when using, dimRoundingMode "+dimRoundingMode+" but got pad "+pad+"."}),util.assert(x3D.shape[2]===$filter.shape[1],function(){return"Error in conv1d: depth of input ("+x3D.shape[2]+") must match input depth for filter "+$filter.shape[1]+"."}),util.assert(conv_util.eitherStridesOrDilationsAreOne(stride,dilation),function(){return"Error in conv1D: Either stride or dilation must be 1. Got stride "+stride+" and dilation '"+dilation+"'"}),util.assert("NWC"===dataFormat,function(){return"Error in conv1d: got dataFormat of "+dataFormat+" but only NWC is currently supported."});var filter4D=$filter.as4D(1,$filter.shape[0],$filter.shape[1],$filter.shape[2]),input4D=x3D.as4D(x3D.shape[0],1,x3D.shape[1],x3D.shape[2]),strides=[1,stride],dilations=[1,dilation],res=exports.conv2d(input4D,filter4D,strides,pad,"NHWC",dilations,dimRoundingMode);return reshapedTo3D?res.as2D(res.shape[2],res.shape[3]):res.as3D(res.shape[0],res.shape[2],res.shape[3])}}),exports.conv2d=operation_1.op({conv2d_:function(x,filter,strides,pad,dataFormat,dilations,dimRoundingMode){void 0===dataFormat&&(dataFormat="NHWC"),void 0===dilations&&(dilations=[1,1]);var $x=tensor_util_env_1.convertToTensor(x,"x","conv2d"),$filter=tensor_util_env_1.convertToTensor(filter,"filter","conv2d"),x4D=$x,reshapedTo4D=!1;3===$x.rank&&(reshapedTo4D=!0,x4D=$x.as4D(1,$x.shape[0],$x.shape[1],$x.shape[2])),util.assert(4===x4D.rank,function(){return"Error in conv2d: input must be rank 4, but got rank "+x4D.rank+"."}),util.assert(4===$filter.rank,function(){return"Error in conv2d: filter must be rank 4, but got rank "+$filter.rank+"."}),null!=dimRoundingMode&&util.assert(util.isInt(pad),function(){return"Error in conv2d: pad must be an integer when using, dimRoundingMode "+dimRoundingMode+" but got pad "+pad+"."});var inDepth="NHWC"===dataFormat?x4D.shape[3]:x4D.shape[1];util.assert(inDepth===$filter.shape[2],function(){return"Error in conv2d: depth of input ("+inDepth+") must match input depth for filter "+$filter.shape[2]+"."}),util.assert(conv_util.eitherStridesOrDilationsAreOne(strides,dilations),function(){return"Error in conv2D: Either strides or dilations must be 1. Got strides "+strides+" and dilations '"+dilations+"'"});var $dataFormat=conv_util.convertConv2DDataFormat(dataFormat),convInfo=conv_util.computeConv2DInfo(x4D.shape,$filter.shape,strides,dilations,pad,dimRoundingMode,!1,$dataFormat),res=engine_1.ENGINE.runKernel(function(backend,save){var res=backend.conv2d(x4D,$filter,convInfo);return save([$filter,x4D]),res},{x:x4D,$filter:$filter},function(dy,saved){var _a=saved,$filter=_a[0],x4D=_a[1];return util.assert(conv_util.tupleValuesAreOne(dilations),function(){return"Error in gradient of conv2D: dilation rates greater than 1 are not yet supported in gradients. Got dilations '"+dilations+"'"}),{x:function(){return conv2dDerInput_(x4D.shape,dy,$filter,strides,pad,dataFormat)},$filter:function(){return conv2dDerFilter_(x4D,dy,$filter.shape,strides,pad,dataFormat)}}});return reshapedTo4D?res.as3D(res.shape[1],res.shape[2],res.shape[3]):res}}),exports.conv3d=operation_1.op({conv3d_:function(x,filter,strides,pad,dataFormat,dilations){void 0===dataFormat&&(dataFormat="NDHWC"),void 0===dilations&&(dilations=[1,1,1]);var $x=tensor_util_env_1.convertToTensor(x,"x","conv3d"),$filter=tensor_util_env_1.convertToTensor(filter,"filter","conv3d"),x5D=$x,reshapedTo5D=!1;4===$x.rank&&(reshapedTo5D=!0,x5D=$x.as5D(1,$x.shape[0],$x.shape[1],$x.shape[2],$x.shape[3])),util.assert(5===x5D.rank,function(){return"Error in conv3d: input must be rank 5, but got rank "+x5D.rank+"."}),util.assert(5===$filter.rank,function(){return"Error in conv3d: filter must be rank 5, but got rank "+$filter.rank+"."}),util.assert(x5D.shape[4]===$filter.shape[3],function(){return"Error in conv3d: depth of input ("+x5D.shape[4]+") must match input depth for filter "+$filter.shape[3]+"."}),util.assert(function(strides,dilations){return tupleValuesAreOne(strides)||tupleValuesAreOne(dilations)}(strides,dilations),function(){return"Error in conv3D: Either strides or dilations must be 1. Got strides "+strides+" and dilations '"+dilations+"'"}),util.assert("NDHWC"===dataFormat,function(){return"Error in conv3d: got dataFormat of "+dataFormat+" but only NDHWC is currently supported."});var convInfo=conv_util.computeConv3DInfo(x5D.shape,$filter.shape,strides,dilations,pad),res=engine_1.ENGINE.runKernel(function(backend,save){var res=backend.conv3d(x5D,$filter,convInfo);return save([x5D,$filter]),res},{x:x5D,$filter:$filter},function(dy,saved){util.assert(tupleValuesAreOne(dilations),function(){return"Error in gradient of conv3D: dilation rates greater than 1 are not yet supported in gradients. Got dilations '"+dilations+"'"});var x5D=saved[0],$filter=saved[1];return{x:function(){return conv3dDerInput_(x5D.shape,dy,$filter,strides,pad)},$filter:function(){return function(x,dy,filterShape,strides,pad){var x5D=x;4===x.rank&&(x5D=x.as5D(1,x.shape[0],x.shape[1],x.shape[2],x.shape[3]));var dy5D=dy;4===dy5D.rank&&(dy5D=dy.as5D(1,dy.shape[0],dy.shape[1],dy.shape[2],dy.shape[3]));util.assert(5===x5D.rank,function(){return"Error in conv3dDerFilter: input must be rank 5, but got shape "+x5D.shape+"."}),util.assert(5===dy5D.rank,function(){return"Error in conv3dDerFilter: dy must be rank 5, but got shape "+dy5D.shape+"."}),util.assert(5===filterShape.length,function(){return"Error in conv3dDerFilter: filterShape must be length 5, but got "+filterShape+"."}),util.assert(x5D.shape[4]===filterShape[3],function(){return"Error in conv3dDerFilter: depth of input "+x5D.shape[4]+") must match input depth in filter ("+filterShape[3]+"."}),util.assert(dy5D.shape[4]===filterShape[4],function(){return"Error in conv3dDerFilter: depth of dy ("+dy5D.shape[4]+") must match output depth for filter ("+filterShape[4]+")."});var convInfo=conv_util.computeConv3DInfo(x5D.shape,filterShape,strides,1,pad);return engine_1.ENGINE.runKernel(function(backend){return backend.conv3dDerFilter(x5D,dy5D,convInfo)},{x5D:x5D,dy5D:dy5D})}(x5D,dy,$filter.shape,strides,pad)}}});return reshapedTo5D?res.as4D(res.shape[1],res.shape[2],res.shape[3],res.shape[4]):res}}),exports.conv2dDerFilter=operation_1.op({conv2dDerFilter_:conv2dDerFilter_}),exports.conv2dDerInput=operation_1.op({conv2dDerInput_:conv2dDerInput_}),exports.depthwiseConv2d=operation_1.op({depthwiseConv2d_:function(x,filter,strides,pad,dataFormat,dilations,dimRoundingMode){void 0===dataFormat&&(dataFormat="NHWC"),void 0===dilations&&(dilations=[1,1]);var $x=tensor_util_env_1.convertToTensor(x,"x","depthwiseConv2d"),$filter=tensor_util_env_1.convertToTensor(filter,"filter","depthwiseConv2d"),x4D=$x,reshapedTo4D=!1;3===$x.rank&&(reshapedTo4D=!0,x4D=$x.as4D(1,$x.shape[0],$x.shape[1],$x.shape[2])),util.assert(4===x4D.rank,function(){return"Error in depthwiseConv2d: input must be rank 4, but got rank "+x4D.rank+"."}),util.assert(4===$filter.rank,function(){return"Error in depthwiseConv2d: filter must be rank 4, but got rank "+$filter.rank+"."}),util.assert(x4D.shape[3]===$filter.shape[2],function(){return"Error in depthwiseConv2d: number of input channels ("+x4D.shape[3]+") must match the inChannels dimension in filter "+$filter.shape[2]+"."}),null==dilations&&(dilations=[1,1]),util.assert(conv_util.eitherStridesOrDilationsAreOne(strides,dilations),function(){return"Error in depthwiseConv2d: Either strides or dilations must be 1. Got strides "+strides+" and dilations '"+dilations+"'"}),null!=dimRoundingMode&&util.assert(util.isInt(pad),function(){return"Error in depthwiseConv2d: pad must be an integer when using, dimRoundingMode "+dimRoundingMode+" but got pad "+pad+"."});var convInfo=conv_util.computeConv2DInfo(x4D.shape,$filter.shape,strides,dilations,pad,dimRoundingMode,!0),res=engine_1.ENGINE.runKernel(function(backend,save){var res=backend.depthwiseConv2D(x4D,$filter,convInfo);return save([x4D,$filter]),res},{x:x4D,$filter:$filter},function(dy,saved){util.assert(conv_util.tupleValuesAreOne(dilations),function(){return"Error in gradient of depthwiseConv2d: dilation rates greater than 1 are not yet supported. Got dilations '"+dilations+"'"});var x4D=saved[0],$filter=saved[1];return{x:function(){return function(xShape,dy,filter,convInfo){var dy4D=dy,reshapedTo4D=!1;3===dy.rank&&(reshapedTo4D=!0,dy4D=dy.as4D(1,dy.shape[0],dy.shape[1],dy.shape[2]));var res=engine_1.ENGINE.runKernel(function(backend){return backend.depthwiseConv2DDerInput(dy4D,filter,convInfo)},{dy4D:dy4D});if(reshapedTo4D)return res.as3D(res.shape[1],res.shape[2],res.shape[3]);return res}(x4D.shape,dy,$filter,convInfo)},$filter:function(){return function(x,dy,filterShape,convInfo){var x4D=x;3===x.rank&&(x4D=x.as4D(1,x.shape[0],x.shape[1],x.shape[2]));var dy4D=dy;3===dy4D.rank&&(dy4D=dy.as4D(1,dy.shape[0],dy.shape[1],dy.shape[2]));return engine_1.ENGINE.runKernel(function(backend){return backend.depthwiseConv2DDerFilter(x4D,dy4D,convInfo)},{x4D:x4D,dy4D:dy4D})}(x4D,dy,$filter.shape,convInfo)}}});return reshapedTo4D?res.as3D(res.shape[1],res.shape[2],res.shape[3]):res}}),exports.separableConv2d=operation_1.op({separableConv2d_:function(x,depthwiseFilter,pointwiseFilter,strides,pad,dilation,dataFormat){void 0===dilation&&(dilation=[1,1]),void 0===dataFormat&&(dataFormat="NHWC");var $x=tensor_util_env_1.convertToTensor(x,"x","separableConv2d"),$depthwiseFilter=tensor_util_env_1.convertToTensor(depthwiseFilter,"depthwiseFilter","separableConv2d"),$pointwiseFilter=tensor_util_env_1.convertToTensor(pointwiseFilter,"pointwiseFilter","separableConv2d"),x4D=$x,reshapedTo4D=!1;if(3===$x.rank&&(reshapedTo4D=!0,x4D=$x.as4D(1,$x.shape[0],$x.shape[1],$x.shape[2])),"NCHW"===dataFormat)throw new Error("separableConv2d currently does not support dataFormat NCHW; only NHWC is supported");util.assert(4===x4D.rank,function(){return"Error in separableConv2d: input must be rank 4, but got rank "+x4D.rank+"."}),util.assert(4===$depthwiseFilter.rank,function(){return"Error in separableConv2d: depthwise filter must be rank 4, but got rank "+$depthwiseFilter.rank+"."}),util.assert(4===$pointwiseFilter.rank,function(){return"Error in separableConv2d: pointwise filter must be rank 4, but got rank "+$depthwiseFilter.rank+"."}),util.assert(1===$pointwiseFilter.shape[0],function(){return"Error in separableConv2d: the first dimension of pointwise filter  must be 1, but got "+$pointwiseFilter.shape[0]+"."}),util.assert(1===$pointwiseFilter.shape[1],function(){return"Error in separableConv2d: the second dimension of pointwise filter must be 1, but got "+$pointwiseFilter.shape[1]+"."});var inChannels=$depthwiseFilter.shape[2],channelMultiplier=$depthwiseFilter.shape[3];util.assert($pointwiseFilter.shape[2]===inChannels*channelMultiplier,function(){return"Error in separableConv2d: the third dimension of pointwise filter must be "+inChannels*channelMultiplier+", but got "+$pointwiseFilter.shape[2]+"."});var depthwise=exports.depthwiseConv2d(x4D,$depthwiseFilter,strides,pad,dataFormat,dilation),res=exports.conv2d(depthwise,$pointwiseFilter,1,"valid",dataFormat);return reshapedTo4D?res.as3D(res.shape[1],res.shape[2],res.shape[3]):res}}),exports.conv2dTranspose=operation_1.op({conv2dTranspose_:function(x,filter,outputShape,strides,pad,dimRoundingMode){return conv2dDerInput_(outputShape,tensor_util_env_1.convertToTensor(x,"x","conv2dTranspose"),tensor_util_env_1.convertToTensor(filter,"filter","conv2dTranspose"),strides,pad,"NHWC",dimRoundingMode)}}),exports.conv3dTranspose=operation_1.op({conv3dTranspose_:function(x,filter,outputShape,strides,pad){return conv3dDerInput_(outputShape,tensor_util_env_1.convertToTensor(x,"x","conv3dTranspose"),tensor_util_env_1.convertToTensor(filter,"filter","conv3dTranspose"),strides,pad)}})},{"../engine":143,"../tensor_util_env":237,"../util":241,"./conv_util":177,"./operation":195}],177:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var util=require("../util");function computeConv2DInfo(inShape,filterShape,strides,dilations,pad,roundingMode,depthwise,dataFormat){void 0===depthwise&&(depthwise=!1),void 0===dataFormat&&(dataFormat="channelsLast");var _a=[-1,-1,-1,-1],batchSize=_a[0],inHeight=_a[1],inWidth=_a[2],inChannels=_a[3];if("channelsLast"===dataFormat)batchSize=inShape[0],inHeight=inShape[1],inWidth=inShape[2],inChannels=inShape[3];else{if("channelsFirst"!==dataFormat)throw new Error("Unknown dataFormat "+dataFormat);batchSize=inShape[0],inChannels=inShape[1],inHeight=inShape[2],inWidth=inShape[3]}var outShape,filterHeight=filterShape[0],filterWidth=filterShape[1],filterChannels=filterShape[3],_b=parseTupleParam(strides),strideHeight=_b[0],strideWidth=_b[1],_c=parseTupleParam(dilations),dilationHeight=_c[0],dilationWidth=_c[1],effectiveFilterHeight=getEffectiveFilterSize(filterHeight,dilationHeight),effectiveFilterWidth=getEffectiveFilterSize(filterWidth,dilationWidth),_d=function(pad,inHeight,inWidth,strideHeight,strideWidth,filterHeight,filterWidth,roundingMode){var padInfo,outHeight,outWidth;if("number"==typeof pad){padInfo={top:pad,bottom:pad,left:pad,right:pad,type:0===pad?"VALID":"NUMBER"};var outShape=function(inShape,fieldSize,stride,zeroPad,roundingMode){null==zeroPad&&(zeroPad=computeDefaultPad(inShape,fieldSize,stride));var inputRows=inShape[0],inputCols=inShape[1],outputRows=conditionalRound((inputRows-fieldSize+2*zeroPad)/stride+1,roundingMode);util.assert(util.isInt(outputRows),function(){return"The output # of rows ("+outputRows+") must be an integer. Change the stride and/or zero pad parameters"});var outputCols=conditionalRound((inputCols-fieldSize+2*zeroPad)/stride+1,roundingMode);return util.assert(util.isInt(outputCols),function(){return"The output # of columns ("+outputCols+") must be an integer. Change the stride and/or zero pad parameters"}),[outputRows,outputCols]}([inHeight,inWidth],filterHeight,strideHeight,pad,roundingMode);outHeight=outShape[0],outWidth=outShape[1]}else if("same"===pad){outHeight=Math.ceil(inHeight/strideHeight),outWidth=Math.ceil(inWidth/strideWidth);var padAlongHeight=Math.max(0,(outHeight-1)*strideHeight+filterHeight-inHeight),padAlongWidth=Math.max(0,(outWidth-1)*strideWidth+filterWidth-inWidth),top_1=Math.floor(padAlongHeight/2),bottom=padAlongHeight-top_1,left=Math.floor(padAlongWidth/2);padInfo={top:top_1,bottom:bottom,left:left,right:padAlongWidth-left,type:"SAME"}}else{if("valid"!==pad)throw Error("Unknown padding parameter: "+pad);padInfo={top:0,bottom:0,left:0,right:0,type:"VALID"},outHeight=Math.ceil((inHeight-filterHeight+1)/strideHeight),outWidth=Math.ceil((inWidth-filterWidth+1)/strideWidth)}return{padInfo:padInfo,outHeight:outHeight,outWidth:outWidth}}(pad,inHeight,inWidth,strideHeight,strideWidth,effectiveFilterHeight,effectiveFilterWidth,roundingMode),padInfo=_d.padInfo,outHeight=_d.outHeight,outWidth=_d.outWidth,outChannels=depthwise?filterChannels*inChannels:filterChannels;return"channelsFirst"===dataFormat?outShape=[batchSize,outChannels,outHeight,outWidth]:"channelsLast"===dataFormat&&(outShape=[batchSize,outHeight,outWidth,outChannels]),{batchSize:batchSize,dataFormat:dataFormat,inHeight:inHeight,inWidth:inWidth,inChannels:inChannels,outHeight:outHeight,outWidth:outWidth,outChannels:outChannels,padInfo:padInfo,strideHeight:strideHeight,strideWidth:strideWidth,filterHeight:filterHeight,filterWidth:filterWidth,effectiveFilterHeight:effectiveFilterHeight,effectiveFilterWidth:effectiveFilterWidth,dilationHeight:dilationHeight,dilationWidth:dilationWidth,inShape:inShape,outShape:outShape,filterShape:filterShape}}function computeConv3DInfo(inShape,filterShape,strides,dilations,pad,depthwise,dataFormat,roundingMode){void 0===depthwise&&(depthwise=!1),void 0===dataFormat&&(dataFormat="channelsLast");var _a=[-1,-1,-1,-1,-1],batchSize=_a[0],inDepth=_a[1],inHeight=_a[2],inWidth=_a[3],inChannels=_a[4];if("channelsLast"===dataFormat)batchSize=inShape[0],inDepth=inShape[1],inHeight=inShape[2],inWidth=inShape[3],inChannels=inShape[4];else{if("channelsFirst"!==dataFormat)throw new Error("Unknown dataFormat "+dataFormat);batchSize=inShape[0],inChannels=inShape[1],inDepth=inShape[2],inHeight=inShape[3],inWidth=inShape[4]}var outShape,filterDepth=filterShape[0],filterHeight=filterShape[1],filterWidth=filterShape[2],filterChannels=filterShape[4],_b=parse3TupleParam(strides),strideDepth=_b[0],strideHeight=_b[1],strideWidth=_b[2],_c=parse3TupleParam(dilations),dilationDepth=_c[0],dilationHeight=_c[1],dilationWidth=_c[2],effectiveFilterDepth=getEffectiveFilterSize(filterDepth,dilationDepth),effectiveFilterHeight=getEffectiveFilterSize(filterHeight,dilationHeight),effectiveFilterWidth=getEffectiveFilterSize(filterWidth,dilationWidth),_d=function(pad,inDepth,inHeight,inWidth,strideDepth,strideHeight,strideWidth,filterDepth,filterHeight,filterWidth,roundingMode){var padInfo,outDepth,outHeight,outWidth;if("number"==typeof pad){padInfo={top:pad,bottom:pad,left:pad,right:pad,front:pad,back:pad,type:0===pad?"VALID":"NUMBER"};var outShape=function(inShape,fieldSize,outChannels,stride,zeroPad,roundingMode){null==zeroPad&&(zeroPad=computeDefaultPad(inShape,fieldSize,stride));var inputDepth=inShape[0],inputRows=inShape[1],inputCols=inShape[2],outputDepths=conditionalRound((inputDepth-fieldSize+2*zeroPad)/stride+1,roundingMode);util.assert(util.isInt(outputDepths),function(){return"The output # of depths ("+outputDepths+") must be an integer. Change the stride and/or zero pad parameters"});var outputRows=conditionalRound((inputRows-fieldSize+2*zeroPad)/stride+1,roundingMode);util.assert(util.isInt(outputRows),function(){return"The output # of rows ("+outputRows+") must be an integer. Change the stride and/or zero pad parameters"});var outputCols=conditionalRound((inputCols-fieldSize+2*zeroPad)/stride+1,roundingMode);return util.assert(util.isInt(outputCols),function(){return"The output # of columns ("+outputCols+") must be an integer. Change the stride and/or zero pad parameters"}),[outputDepths,outputRows,outputCols,outChannels]}([inDepth,inHeight,inWidth,1],filterDepth,1,strideDepth,pad,roundingMode);outDepth=outShape[0],outHeight=outShape[1],outWidth=outShape[2]}else if("same"===pad){outDepth=Math.ceil(inDepth/strideDepth),outHeight=Math.ceil(inHeight/strideHeight),outWidth=Math.ceil(inWidth/strideWidth);var padAlongDepth=(outDepth-1)*strideDepth+filterDepth-inDepth,padAlongHeight=(outHeight-1)*strideHeight+filterHeight-inHeight,padAlongWidth=(outWidth-1)*strideWidth+filterWidth-inWidth,front=Math.floor(padAlongDepth/2),back=padAlongDepth-front,top_2=Math.floor(padAlongHeight/2),bottom=padAlongHeight-top_2,left=Math.floor(padAlongWidth/2);padInfo={top:top_2,bottom:bottom,left:left,right:padAlongWidth-left,front:front,back:back,type:"SAME"}}else{if("valid"!==pad)throw Error("Unknown padding parameter: "+pad);padInfo={top:0,bottom:0,left:0,right:0,front:0,back:0,type:"VALID"},outDepth=Math.ceil((inDepth-filterDepth+1)/strideDepth),outHeight=Math.ceil((inHeight-filterHeight+1)/strideHeight),outWidth=Math.ceil((inWidth-filterWidth+1)/strideWidth)}return{padInfo:padInfo,outDepth:outDepth,outHeight:outHeight,outWidth:outWidth}}(pad,inDepth,inHeight,inWidth,strideDepth,strideHeight,strideWidth,effectiveFilterDepth,effectiveFilterHeight,effectiveFilterWidth,roundingMode),padInfo=_d.padInfo,outDepth=_d.outDepth,outHeight=_d.outHeight,outWidth=_d.outWidth,outChannels=depthwise?filterChannels*inChannels:filterChannels;return"channelsFirst"===dataFormat?outShape=[batchSize,outChannels,outDepth,outHeight,outWidth]:"channelsLast"===dataFormat&&(outShape=[batchSize,outDepth,outHeight,outWidth,outChannels]),{batchSize:batchSize,dataFormat:dataFormat,inDepth:inDepth,inHeight:inHeight,inWidth:inWidth,inChannels:inChannels,outDepth:outDepth,outHeight:outHeight,outWidth:outWidth,outChannels:outChannels,padInfo:padInfo,strideDepth:strideDepth,strideHeight:strideHeight,strideWidth:strideWidth,filterDepth:filterDepth,filterHeight:filterHeight,filterWidth:filterWidth,effectiveFilterDepth:effectiveFilterDepth,effectiveFilterHeight:effectiveFilterHeight,effectiveFilterWidth:effectiveFilterWidth,dilationDepth:dilationDepth,dilationHeight:dilationHeight,dilationWidth:dilationWidth,inShape:inShape,outShape:outShape,filterShape:filterShape}}function computeDefaultPad(inputShape,fieldSize,stride,dilation){void 0===dilation&&(dilation=1);var effectiveFieldSize=getEffectiveFilterSize(fieldSize,dilation);return Math.floor((inputShape[0]*(stride-1)-stride+effectiveFieldSize)/2)}function parseTupleParam(param){return"number"==typeof param?[param,param,param]:2===param.length?[param[0],param[1],1]:param}function parse3TupleParam(param){return"number"==typeof param?[param,param,param]:param}function getEffectiveFilterSize(filterSize,dilation){return dilation<=1?filterSize:filterSize+(filterSize-1)*(dilation-1)}function conditionalRound(value,roundingMode){if(!roundingMode)return value;switch(roundingMode){case"round":return Math.round(value);case"ceil":return Math.ceil(value);case"floor":return Math.floor(value);default:throw new Error("Unknown roundingMode "+roundingMode)}}function tupleValuesAreOne(param){var _a=parseTupleParam(param),dimA=_a[0],dimB=_a[1],dimC=_a[2];return 1===dimA&&1===dimB&&1===dimC}exports.computePool2DInfo=function(inShape,filterSize,strides,dilations,pad,roundingMode,dataFormat){void 0===dataFormat&&(dataFormat="channelsLast");var filterShape,_a=parseTupleParam(filterSize),filterHeight=_a[0],filterWidth=_a[1];if("channelsLast"===dataFormat)filterShape=[filterHeight,filterWidth,inShape[3],inShape[3]];else{if("channelsFirst"!==dataFormat)throw new Error("Unknown dataFormat "+dataFormat);filterShape=[filterHeight,filterWidth,inShape[1],inShape[1]]}return computeConv2DInfo(inShape,filterShape,strides,dilations,pad,roundingMode,!1,dataFormat)},exports.computePool3DInfo=function(inShape,filterSize,strides,dilations,pad,roundingMode,dataFormat){void 0===dataFormat&&(dataFormat="NDHWC");var filterShape,$dataFormat,_a=parse3TupleParam(filterSize),filterDepth=_a[0],filterHeight=_a[1],filterWidth=_a[2];if("NDHWC"===dataFormat)$dataFormat="channelsLast",filterShape=[filterDepth,filterHeight,filterWidth,inShape[4],inShape[4]];else{if("NCDHW"!==dataFormat)throw new Error("Unknown dataFormat "+dataFormat);$dataFormat="channelsFirst",filterShape=[filterDepth,filterHeight,filterWidth,inShape[1],inShape[1]]}return computeConv3DInfo(inShape,filterShape,strides,dilations,pad,!1,$dataFormat,roundingMode)},exports.computeConv2DInfo=computeConv2DInfo,exports.computeConv3DInfo=computeConv3DInfo,exports.computeDefaultPad=computeDefaultPad,exports.tupleValuesAreOne=tupleValuesAreOne,exports.eitherStridesOrDilationsAreOne=function(strides,dilations){return tupleValuesAreOne(strides)||tupleValuesAreOne(dilations)},exports.convertConv2DDataFormat=function(dataFormat){if("NHWC"===dataFormat)return"channelsLast";if("NCHW"===dataFormat)return"channelsFirst";throw new Error("Unknown dataFormat "+dataFormat)}},{"../util":241}],178:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var engine_1=require("../engine"),tensor_util_env_1=require("../tensor_util_env"),operation_1=require("./operation");exports.diag=operation_1.op({diag_:function(x){var $x=tensor_util_env_1.convertToTensor(x,"x","diag").flatten(),outShape=x.shape.concat(x.shape);return engine_1.ENGINE.runKernel(function(backend){return backend.diag($x)},{$x:$x}).reshape(outShape)}})},{"../engine":143,"../tensor_util_env":237,"./operation":195}],179:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var tensor_1=require("../tensor"),tensor_util_env_1=require("../tensor_util_env"),util=require("../util"),array_ops_1=require("./array_ops"),dropout_util_1=require("./dropout_util"),operation_1=require("./operation");exports.dropout=operation_1.op({dropout_:function(x,rate,noiseShape,seed){var $x=tensor_util_env_1.convertToTensor(x,"x","dropout");if(util.assert("float32"===$x.dtype,function(){return"x has to be a floating point tensor since it's going to be scaled, but got a "+$x.dtype+" tensor instead."}),util.assert(0<=rate&&rate<1,function(){return"rate must be a float in the range [0, 1), but got "+rate+"."}),0===rate)return x instanceof tensor_1.Tensor?$x.clone():$x;var $noiseShape=dropout_util_1.getNoiseShape($x,noiseShape),keepProb=1-rate,multiplier=array_ops_1.randomUniform($noiseShape,0,1,"float32",seed).add(keepProb).floor().div(keepProb);return $x.mul(multiplier)}})},{"../tensor":234,"../tensor_util_env":237,"../util":241,"./array_ops":163,"./dropout_util":180,"./operation":195}],180:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var util=require("../util");exports.getNoiseShape=function(x,noiseShape){if(null==noiseShape)return x.shape.slice();if(util.arraysEqual(x.shape,noiseShape))return noiseShape;if(x.shape.length!==noiseShape.length)return noiseShape;for(var newDimension=[],i=0;i<x.shape.length;i++)null==noiseShape[i]&&null!=x.shape[i]?newDimension.push(x.shape[i]):newDimension.push(noiseShape[i]);return newDimension}},{"../util":241}],181:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.ERF_P=.3275911,exports.ERF_A1=.254829592,exports.ERF_A2=-.284496736,exports.ERF_A3=1.421413741,exports.ERF_A4=-1.453152027,exports.ERF_A5=1.061405429},{}],182:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var engine_1=require("../engine"),conv_1=require("../ops/conv"),conv_util=require("../ops/conv_util"),operation_1=require("../ops/operation"),tensor_util_1=require("../tensor_util"),tensor_util_env_1=require("../tensor_util_env"),util=require("../util"),broadcast_util=require("./broadcast_util");exports.matMul=operation_1.op({matMul_:function(_a){var _e,a=_a.a,b=_a.b,_b=_a.transposeA,transposeA=void 0!==_b&&_b,_c=_a.transposeB,transposeB=void 0!==_c&&_c,bias=_a.bias,_d=_a.activation,activation=void 0===_d?"linear":_d,preluActivationWeights=_a.preluActivationWeights,$a=tensor_util_env_1.convertToTensor(a,"a","fused matMul"),$b=tensor_util_env_1.convertToTensor(b,"b","fused matMul");_e=tensor_util_1.makeTypesMatch($a,$b),$a=_e[0],$b=_e[1];var innerShapeA=transposeA?$a.shape[$a.rank-2]:$a.shape[$a.rank-1],innerShapeB=transposeB?$b.shape[$b.rank-1]:$b.shape[$b.rank-2],outerShapeA=transposeA?$a.shape[$a.rank-1]:$a.shape[$a.rank-2],outerShapeB=transposeB?$b.shape[$b.rank-2]:$b.shape[$b.rank-1],outerDimsA=$a.shape.slice(0,-2),outerDimsB=$b.shape.slice(0,-2),batchDimA=util.sizeFromShape(outerDimsA),batchDimB=util.sizeFromShape(outerDimsB);util.assert(2<=$a.rank&&2<=$b.rank&&$a.rank===$b.rank,function(){return"Error in fused matMul: inputs must have the same rank of at least 2, got ranks "+$a.rank+" and "+$b.rank+"."}),util.assert(util.arraysEqual(outerDimsA,outerDimsB),function(){return"Error in fused matMul: outer dimensions ("+outerDimsA+") and ("+outerDimsB+") of Tensors with shapes "+$a.shape+" and "+$b.shape+" must match."}),util.assert(innerShapeA===innerShapeB,function(){return"Error in fused matMul: inner shapes ("+innerShapeA+") and ("+innerShapeB+") of Tensors with shapes "+$a.shape+" and "+$b.shape+" and transposeA="+transposeA+" and transposeB="+transposeB+" must match."});var $bias,$preluActivationWeights,outShape=$a.shape.slice(0,-2).concat([outerShapeA,outerShapeB]),a3D=transposeA?$a.as3D(batchDimA,innerShapeA,outerShapeA):$a.as3D(batchDimA,outerShapeA,innerShapeA),b3D=transposeB?$b.as3D(batchDimB,outerShapeB,innerShapeB):$b.as3D(batchDimB,innerShapeB,outerShapeB);null!=bias&&($bias=tensor_util_env_1.convertToTensor(bias,"bias","fused matMul"),$bias=tensor_util_1.makeTypesMatch($bias,$a)[0],broadcast_util.assertAndGetBroadcastShape(outShape,$bias.shape)),null!=preluActivationWeights&&($preluActivationWeights=tensor_util_env_1.convertToTensor(preluActivationWeights,"prelu weights","fused matMul"));var inputs={$a:a3D,$b:b3D};return null!=bias&&(inputs.$bias=$bias),null!=preluActivationWeights&&(inputs.$preluActivationWeights=$preluActivationWeights),engine_1.ENGINE.runKernel(function(backend,save){var y=backend.fusedBatchMatMul({a:a3D,b:b3D,transposeA:transposeA,transposeB:transposeB,bias:$bias,activation:activation,preluActivationWeights:$preluActivationWeights});return save([a3D,b3D,y]),y},inputs,function(dy,saved){var dyActivation,a3D=saved[0],b3D=saved[1],y=saved[2];if(null==activation||"linear"===activation)dyActivation=dy;else{if("relu"!==activation)throw new Error("Gradient for activation "+activation+" has not been implemented yet.");dyActivation=dy.mul(y.step())}var biasGradient={};return null!=bias&&(biasGradient={$bias:function(){var res=dyActivation,reduceAxes=broadcast_util.getReductionAxes($bias.shape,dyActivation.shape);return 0<reduceAxes.length&&(res=res.sum(reduceAxes)),res.reshape($bias.shape)}}),transposeA||transposeB?!transposeA&&transposeB?Object.assign({$a:function(){return dyActivation.matMul(b3D,!1,!1)},$b:function(){return dyActivation.matMul(a3D,!0,!1)}},biasGradient):transposeA&&!transposeB?Object.assign({$a:function(){return b3D.matMul(dyActivation,!1,!0)},$b:function(){return a3D.matMul(dyActivation,!1,!1)}},biasGradient):Object.assign({$a:function(){return b3D.matMul(dyActivation,!0,!0)},$b:function(){return dyActivation.matMul(a3D,!0,!0)}},biasGradient):Object.assign({$a:function(){return dyActivation.matMul(b3D,!1,!0)},$b:function(){return a3D.matMul(dyActivation,!0,!1)}},biasGradient)}).reshape(outShape)}}),exports.conv2d=operation_1.op({conv2d_:function(_a){var x=_a.x,filter=_a.filter,strides=_a.strides,pad=_a.pad,_b=_a.dataFormat,dataFormat=void 0===_b?"NHWC":_b,_c=_a.dilations,dilations=void 0===_c?[1,1]:_c,dimRoundingMode=_a.dimRoundingMode,bias=_a.bias,_d=_a.activation,activation=void 0===_d?"linear":_d,preluActivationWeights=_a.preluActivationWeights,$x=tensor_util_env_1.convertToTensor(x,"x","conv2d"),$filter=tensor_util_env_1.convertToTensor(filter,"filter","conv2d"),x4D=$x,reshapedTo4D=!1;3===$x.rank&&(reshapedTo4D=!0,x4D=$x.as4D(1,$x.shape[0],$x.shape[1],$x.shape[2])),util.assert(4===x4D.rank,function(){return"Error in fused conv2d: input must be rank 4, but got rank "+x4D.rank+"."}),util.assert(4===$filter.rank,function(){return"Error in fused conv2d: filter must be rank 4, but got rank "+$filter.rank+"."}),null!=dimRoundingMode&&util.assert(util.isInt(pad),function(){return"Error in fused conv2d: pad must be an integer when using, dimRoundingMode "+dimRoundingMode+" but got pad "+pad+"."}),util.assert(x4D.shape[3]===$filter.shape[2],function(){return"Error in conv2d: depth of input ("+x4D.shape[3]+") must match input depth for filter "+$filter.shape[2]+"."}),util.assert(conv_util.eitherStridesOrDilationsAreOne(strides,dilations),function(){return"Error in conv2D: Either strides or dilations must be 1. Got strides "+strides+" and dilations '"+dilations+"'"}),util.assert("NHWC"===dataFormat,function(){return"Error in conv2d: got dataFormat of "+dataFormat+" but only NHWC is currently supported."});var $bias,$preluActivationWeights,convInfo=conv_util.computeConv2DInfo(x4D.shape,$filter.shape,strides,dilations,pad,dimRoundingMode);null!=bias&&($bias=tensor_util_env_1.convertToTensor(bias,"bias","fused conv2d"),$bias=tensor_util_1.makeTypesMatch($bias,$x)[0],broadcast_util.assertAndGetBroadcastShape(convInfo.outShape,$bias.shape)),null!=preluActivationWeights&&($preluActivationWeights=tensor_util_env_1.convertToTensor(preluActivationWeights,"prelu weights","fused conv2d"));var inputs={x:x4D,$filter:$filter};null!=bias&&(inputs.$bias=$bias),null!=preluActivationWeights&&(inputs.$preluActivationWeights=$preluActivationWeights);var res=engine_1.ENGINE.runKernel(function(backend,save){var res=backend.fusedConv2d(x4D,$filter,convInfo,$bias,activation,$preluActivationWeights);return save([$filter,x4D,res]),res},inputs,function(dy,saved){var dyActivation,_a=saved,$filter=_a[0],x4D=_a[1],y=_a[2];if(null==activation||"linear"===activation)dyActivation=dy;else{if("relu"!==activation)throw new Error("Gradient for activation "+activation+" has not been implemented yet.");dyActivation=dy.mul(y.step())}util.assert(conv_util.tupleValuesAreOne(dilations),function(){return"Error in gradient of fused conv2D: dilation rates greater than 1 are not yet supported in gradients. Got dilations '"+dilations+"'"});var biasGradient={};return null!=bias&&(biasGradient={$bias:function(){var res=dyActivation,reduceAxes=broadcast_util.getReductionAxes($bias.shape,dyActivation.shape);return 0<reduceAxes.length&&(res=res.sum(reduceAxes)),res.reshape($bias.shape)}}),Object.assign({x:function(){return conv_1.conv2dDerInput(x4D.shape,dyActivation,$filter,strides,pad)},$filter:function(){return conv_1.conv2dDerFilter(x4D,dyActivation,$filter.shape,strides,pad)}},biasGradient)});return reshapedTo4D?res.as3D(res.shape[1],res.shape[2],res.shape[3]):res}})},{"../engine":143,"../ops/conv":176,"../ops/conv_util":177,"../ops/operation":195,"../tensor_util":236,"../tensor_util_env":237,"../util":241,"./broadcast_util":169}],183:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var engine_1=require("../engine"),tensor_util_env_1=require("../tensor_util_env"),operation_1=require("./operation");exports.gatherND=operation_1.op({gatherND_:function(x,indices){var $indices=tensor_util_env_1.convertToTensor(indices,"indices","gatherND","int32"),$x=tensor_util_env_1.convertToTensor(x,"x","gatherND");return engine_1.ENGINE.runKernel(function(backend){return backend.gatherND($x,$indices)},{$x:$x,$indices:$indices})}})},{"../engine":143,"../tensor_util_env":237,"./operation":195}],184:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var util_1=require("../util");exports.prepareAndValidate=function(tensor,indices){if(tensor.rank<1)throw new Error("tf.gatherND() expects the input to be rank 1 or higher, but the rank was "+tensor.rank+".");if(indices.rank<1)throw new Error("tf.gatherND() expects the indices to be rank 1 or higher, but the rank was "+indices.rank+".");if("int32"!==indices.dtype)throw new Error("tf.gatherND() expects the indices to be int32 type, but the dtype was "+indices.dtype+".");if(indices.shape[indices.rank-1]>tensor.rank)throw new Error("index innermost dimension length must be <= tensor rank; saw: "+indices.shape[indices.rank-1]+" vs. "+tensor.rank);if(0===tensor.size)throw new Error("Requested more than 0 entries, but input is empty. Input shape: "+tensor.shape+".");for(var indicesShape=indices.shape,sliceRank=indicesShape[indicesShape.length-1],nResult=1,i=0;i<indicesShape.length-1;++i)nResult*=indicesShape[i];var inputShape=tensor.shape,resultShape=indicesShape.slice();resultShape.pop();var sliceSize=1;for(i=sliceRank;i<tensor.rank;++i)sliceSize*=inputShape[i],resultShape.push(inputShape[i]);var strides=util_1.computeStrides(tensor.shape).map(function(stride){return stride/sliceSize}).concat([1]).slice(0,sliceRank);return[resultShape,nResult,sliceSize,strides]}},{"../util":241}],185:[function(require,module,exports){"use strict";var __awaiter=this&&this.__awaiter||function(thisArg,_arguments,P,generator){return new(P=P||Promise)(function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){result.done?resolve(result.value):new P(function(resolve){resolve(result.value)}).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())})},__generator=this&&this.__generator||function(thisArg,body){var f,y,t,g,_={label:0,sent:function(){if(1&t[0])throw t[1];return t[1]},trys:[],ops:[]};return g={next:verb(0),throw:verb(1),return:verb(2)},"function"==typeof Symbol&&(g[Symbol.iterator]=function(){return this}),g;function verb(n){return function(v){return function(op){if(f)throw new TypeError("Generator is already executing.");for(;_;)try{if(f=1,y&&(t=2&op[0]?y.return:op[0]?y.throw||((t=y.return)&&t.call(y),0):y.next)&&!(t=t.call(y,op[1])).done)return t;switch(y=0,t&&(op=[2&op[0],t.value]),op[0]){case 0:case 1:t=op;break;case 4:return _.label++,{value:op[1],done:!1};case 5:_.label++,y=op[1],op=[0];continue;case 7:op=_.ops.pop(),_.trys.pop();continue;default:if(!(t=0<(t=_.trys).length&&t[t.length-1])&&(6===op[0]||2===op[0])){_=0;continue}if(3===op[0]&&(!t||op[1]>t[0]&&op[1]<t[3])){_.label=op[1];break}if(6===op[0]&&_.label<t[1]){_.label=t[1],t=op;break}if(t&&_.label<t[2]){_.label=t[2],_.ops.push(op);break}t[2]&&_.ops.pop(),_.trys.pop();continue}op=body.call(thisArg,_)}catch(e){op=[6,e],y=0}finally{f=t=0}if(5&op[0])throw op[1];return{value:op[0]?op[1]:void 0,done:!0}}([n,v])}}};Object.defineProperty(exports,"__esModule",{value:!0});var non_max_suppression_impl_1=require("../backends/non_max_suppression_impl"),engine_1=require("../engine"),tensor_util_env_1=require("../tensor_util_env"),util=require("../util"),operation_1=require("./operation");function nonMaxSuppSanityCheck(boxes,scores,maxOutputSize,iouThreshold,scoreThreshold){null==iouThreshold&&(iouThreshold=.5),null==scoreThreshold&&(scoreThreshold=Number.NEGATIVE_INFINITY);var numBoxes=boxes.shape[0];return maxOutputSize=Math.min(maxOutputSize,numBoxes),util.assert(0<=iouThreshold&&iouThreshold<=1,function(){return"iouThreshold must be in [0, 1], but was '"+iouThreshold+"'"}),util.assert(2===boxes.rank,function(){return"boxes must be a 2D tensor, but was of rank '"+boxes.rank+"'"}),util.assert(4===boxes.shape[1],function(){return"boxes must have 4 columns, but 2nd dimension was "+boxes.shape[1]}),util.assert(1===scores.rank,function(){return"scores must be a 1D tensor"}),util.assert(scores.shape[0]===numBoxes,function(){return"scores has incompatible shape with boxes. Expected "+numBoxes+", but was "+scores.shape[0]}),{maxOutputSize:maxOutputSize,iouThreshold:iouThreshold,scoreThreshold:scoreThreshold}}exports.resizeBilinear=operation_1.op({resizeBilinear_:function(images,size,alignCorners){void 0===alignCorners&&(alignCorners=!1);var $images=tensor_util_env_1.convertToTensor(images,"images","resizeBilinear");util.assert(3===$images.rank||4===$images.rank,function(){return"Error in resizeBilinear: x must be rank 3 or 4, but got rank "+$images.rank+"."}),util.assert(2===size.length,function(){return"Error in resizeBilinear: new shape must 2D, but got shape "+size+"."});var batchImages=$images,reshapedTo4D=!1;3===$images.rank&&(reshapedTo4D=!0,batchImages=$images.as4D(1,$images.shape[0],$images.shape[1],$images.shape[2]));var newHeight=size[0],newWidth=size[1],res=engine_1.ENGINE.runKernel(function(backend,save){return save([batchImages]),backend.resizeBilinear(batchImages,newHeight,newWidth,alignCorners)},{batchImages:batchImages},function(dy,saved){return{batchImages:function(){return engine_1.ENGINE.runKernel(function(backend){return backend.resizeBilinearBackprop(dy,saved[0],alignCorners)},{})}}});return reshapedTo4D?res.as3D(res.shape[1],res.shape[2],res.shape[3]):res}}),exports.resizeNearestNeighbor=operation_1.op({resizeNearestNeighbor_:function(images,size,alignCorners){void 0===alignCorners&&(alignCorners=!1);var $images=tensor_util_env_1.convertToTensor(images,"images","resizeNearestNeighbor");util.assert(3===$images.rank||4===$images.rank,function(){return"Error in resizeNearestNeighbor: x must be rank 3 or 4, but got rank "+$images.rank+"."}),util.assert(2===size.length,function(){return"Error in resizeNearestNeighbor: new shape must 2D, but got shape "+size+"."}),util.assert("float32"===$images.dtype||"int32"===$images.dtype,function(){return"`images` must have `int32` or `float32` as dtype"});var batchImages=$images,reshapedTo4D=!1;3===$images.rank&&(reshapedTo4D=!0,batchImages=$images.as4D(1,$images.shape[0],$images.shape[1],$images.shape[2]));var newHeight=size[0],newWidth=size[1],res=engine_1.ENGINE.runKernel(function(backend,save){return save([batchImages]),backend.resizeNearestNeighbor(batchImages,newHeight,newWidth,alignCorners)},{batchImages:batchImages},function(dy,saved){return{batchImages:function(){return engine_1.ENGINE.runKernel(function(backend){return backend.resizeNearestNeighborBackprop(dy,saved[0],alignCorners)},{})}}});return reshapedTo4D?res.as3D(res.shape[1],res.shape[2],res.shape[3]):res}}),exports.nonMaxSuppression=operation_1.op({nonMaxSuppression_:function(boxes,scores,maxOutputSize,iouThreshold,scoreThreshold){void 0===iouThreshold&&(iouThreshold=.5),void 0===scoreThreshold&&(scoreThreshold=Number.NEGATIVE_INFINITY);var $boxes=tensor_util_env_1.convertToTensor(boxes,"boxes","nonMaxSuppression"),$scores=tensor_util_env_1.convertToTensor(scores,"scores","nonMaxSuppression"),inputs=nonMaxSuppSanityCheck($boxes,$scores,maxOutputSize,iouThreshold,scoreThreshold);return maxOutputSize=inputs.maxOutputSize,iouThreshold=inputs.iouThreshold,scoreThreshold=inputs.scoreThreshold,engine_1.ENGINE.runKernel(function(b){return b.nonMaxSuppression($boxes,$scores,maxOutputSize,iouThreshold,scoreThreshold)},{$boxes:$boxes})}}),exports.nonMaxSuppressionAsync=function(boxes,scores,maxOutputSize,iouThreshold,scoreThreshold){return void 0===iouThreshold&&(iouThreshold=.5),void 0===scoreThreshold&&(scoreThreshold=Number.NEGATIVE_INFINITY),__awaiter(this,void 0,void 0,function(){var $boxes,$scores,inputs,boxesVals,scoresVals,res;return __generator(this,function(_a){switch(_a.label){case 0:return $boxes=tensor_util_env_1.convertToTensor(boxes,"boxes","nonMaxSuppressionAsync"),$scores=tensor_util_env_1.convertToTensor(scores,"scores","nonMaxSuppressionAsync"),inputs=nonMaxSuppSanityCheck($boxes,$scores,maxOutputSize,iouThreshold,scoreThreshold),maxOutputSize=inputs.maxOutputSize,iouThreshold=inputs.iouThreshold,scoreThreshold=inputs.scoreThreshold,[4,$boxes.data()];case 1:return boxesVals=_a.sent(),[4,$scores.data()];case 2:return scoresVals=_a.sent(),res=non_max_suppression_impl_1.nonMaxSuppressionImpl(boxesVals,scoresVals,maxOutputSize,iouThreshold,scoreThreshold),$boxes!==boxes&&$boxes.dispose(),$scores!==scores&&$scores.dispose(),[2,res]}})})},exports.cropAndResize=operation_1.op({cropAndResize_:function(image,boxes,boxInd,cropSize,method,extrapolationValue){var $image=tensor_util_env_1.convertToTensor(image,"image","cropAndResize","float32"),$boxes=tensor_util_env_1.convertToTensor(boxes,"boxes","cropAndResize","float32"),$boxInd=tensor_util_env_1.convertToTensor(boxInd,"boxInd","cropAndResize","int32");method=method||"bilinear",extrapolationValue=extrapolationValue||0;var numBoxes=$boxes.shape[0];return util.assert(4===$image.rank,function(){return"Error in cropAndResize: image must be rank 4,but got rank "+$image.rank+"."}),util.assert(2===$boxes.rank&&4===$boxes.shape[1],function(){return"Error in cropAndResize: boxes must be have size ["+numBoxes+",4] but had shape "+$boxes.shape+"."}),util.assert(1===$boxInd.rank&&$boxInd.shape[0]===numBoxes,function(){return"Error in cropAndResize: boxInd must be have size ["+numBoxes+"] but had shape "+$boxes.shape+"."}),util.assert(2===cropSize.length,function(){return"Error in cropAndResize: cropSize must be of length 2, but got length "+cropSize.length+"."}),util.assert(1<=cropSize[0]&&1<=cropSize[1],function(){return"cropSize must be atleast [1,1], but was "+cropSize}),util.assert("bilinear"===method||"nearest"===method,function(){return"method must be bilinear or nearest, but was "+method}),engine_1.ENGINE.runKernel(function(backend,save){return backend.cropAndResize($image,$boxes,$boxInd,cropSize,method,extrapolationValue)},{$image:$image,$boxes:$boxes})}})},{"../backends/non_max_suppression_impl":54,"../engine":143,"../tensor_util_env":237,"../util":241,"./operation":195}],186:[function(require,module,exports){"use strict";var __awaiter=this&&this.__awaiter||function(thisArg,_arguments,P,generator){return new(P=P||Promise)(function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){result.done?resolve(result.value):new P(function(resolve){resolve(result.value)}).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())})},__generator=this&&this.__generator||function(thisArg,body){var f,y,t,g,_={label:0,sent:function(){if(1&t[0])throw t[1];return t[1]},trys:[],ops:[]};return g={next:verb(0),throw:verb(1),return:verb(2)},"function"==typeof Symbol&&(g[Symbol.iterator]=function(){return this}),g;function verb(n){return function(v){return function(op){if(f)throw new TypeError("Generator is already executing.");for(;_;)try{if(f=1,y&&(t=2&op[0]?y.return:op[0]?y.throw||((t=y.return)&&t.call(y),0):y.next)&&!(t=t.call(y,op[1])).done)return t;switch(y=0,t&&(op=[2&op[0],t.value]),op[0]){case 0:case 1:t=op;break;case 4:return _.label++,{value:op[1],done:!1};case 5:_.label++,y=op[1],op=[0];continue;case 7:op=_.ops.pop(),_.trys.pop();continue;default:if(!(t=0<(t=_.trys).length&&t[t.length-1])&&(6===op[0]||2===op[0])){_=0;continue}if(3===op[0]&&(!t||op[1]>t[0]&&op[1]<t[3])){_.label=op[1];break}if(6===op[0]&&_.label<t[1]){_.label=t[1],t=op;break}if(t&&_.label<t[2]){_.label=t[2],_.ops.push(op);break}t[2]&&_.ops.pop(),_.trys.pop();continue}op=body.call(thisArg,_)}catch(e){op=[6,e],y=0}finally{f=t=0}if(5&op[0])throw op[1];return{value:op[0]?op[1]:void 0,done:!0}}([n,v])}}};Object.defineProperty(exports,"__esModule",{value:!0});var tensor_util_env_1=require("../tensor_util_env"),util_1=require("../util"),tensor_ops_1=require("./tensor_ops");exports.inTopKAsync=function(predictions,targets,k){return void 0===k&&(k=1),__awaiter(this,void 0,void 0,function(){var $predictions,$targets,lastDim,predictionsVals,targetsVals,_a,batch,size,precision,b,offset,vals,valAndInd,i;return __generator(this,function(_b){switch(_b.label){case 0:return $predictions=tensor_util_env_1.convertToTensor(predictions,"predictions","inTopK"),$targets=tensor_util_env_1.convertToTensor(targets,"targets","inTopK"),util_1.assert(1<$predictions.rank,function(){return"inTopK() expects the predictions to be of rank 2 or higher, but got "+$predictions.rank}),util_1.assert($predictions.rank-1===$targets.rank,function(){return"predictions rank should be 1 larger than targets rank, but got predictions rank "+$predictions.rank+" and targets rank "+$targets.rank}),util_1.assertShapesMatch($predictions.shape.slice(0,$predictions.shape.length-1),$targets.shape,"predictions's shape should be align with the targets' shape, except the last dimension."),lastDim=$predictions.shape[$predictions.shape.length-1],util_1.assert(0<k&&k<=lastDim,function(){return"'k' passed to inTopK() must be > 0 && <= the predictions last dimension ("+lastDim+"), but got "+k}),[4,$predictions.data()];case 1:return predictionsVals=_b.sent(),[4,$targets.data()];case 2:for(targetsVals=_b.sent(),_a=[predictionsVals.length/lastDim,lastDim],batch=_a[0],size=_a[1],precision=util_1.getTypedArrayFromDType("bool",batch),b=0;b<batch;b++){for(offset=b*size,vals=predictionsVals.subarray(offset,offset+size),valAndInd=[],i=0;i<vals.length;i++)valAndInd.push({value:vals[i],index:i});for(valAndInd.sort(function(a,b){return b.value-a.value}),precision[b]=0,i=0;i<k;i++)if(valAndInd[i].index===targetsVals[b]){precision[b]=1;break}}return predictions!==$predictions&&$predictions.dispose(),targets!==$targets&&$targets.dispose(),[2,tensor_ops_1.tensor(precision,$targets.shape,"bool")]}})})}},{"../tensor_util_env":237,"../util":241,"./tensor_ops":216}],187:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var engine_1=require("../engine"),globals_1=require("../globals"),util_1=require("../util"),array_ops_1=require("./array_ops"),concat_split_1=require("./concat_split"),norm_1=require("./norm"),operation_1=require("./operation"),reduction_ops_1=require("./reduction_ops"),tensor_ops_1=require("./tensor_ops");function qr2d(x,fullMatrices){return void 0===fullMatrices&&(fullMatrices=!1),engine_1.ENGINE.tidy(function(){if(2!==x.shape.length)throw new Error("qr2d() requires a 2D Tensor, but got a "+x.shape.length+"D Tensor.");for(var m=x.shape[0],n=x.shape[1],q=array_ops_1.eye(m),r=x.clone(),one2D=tensor_ops_1.tensor2d([[1]],[1,1]),w=one2D.clone(),iters=n<=m?n:m,_loop_3=function(j){var _a,rTemp=r,wTemp=w,qTemp=q;w=(_a=engine_1.ENGINE.tidy(function(){var rjEnd1=r.slice([j,j],[m-j,1]),normX=rjEnd1.norm(),rjj=r.slice([j,j],[1,1]),s=tensor_ops_1.tensor2d([[-1]]).where(rjj.greater(0),tensor_ops_1.tensor2d([[1]])),u1=rjj.sub(s.mul(normX)),wPre=rjEnd1.div(u1);w=1===wPre.shape[0]?one2D.clone():one2D.concat(wPre.slice([1,0],[wPre.shape[0]-1,wPre.shape[1]]),0);var tau=s.matMul(u1).div(normX).neg(),rjEndAll=r.slice([j,0],[m-j,n]),tauTimesW=tau.mul(w);r=0===j?rjEndAll.sub(tauTimesW.matMul(w.transpose().matMul(rjEndAll))):r.slice([0,0],[j,n]).concat(rjEndAll.sub(tauTimesW.matMul(w.transpose().matMul(rjEndAll))),0);var qAllJEnd=q.slice([0,j],[m,q.shape[1]-j]);return q=0===j?qAllJEnd.sub(qAllJEnd.matMul(w).matMul(tauTimesW.transpose())):q.slice([0,0],[m,j]).concat(qAllJEnd.sub(qAllJEnd.matMul(w).matMul(tauTimesW.transpose())),1),[w,r,q]}))[0],r=_a[1],q=_a[2],globals_1.dispose([rTemp,wTemp,qTemp])},j=0;j<iters;++j)_loop_3(j);return!fullMatrices&&n<m&&(q=q.slice([0,0],[m,n]),r=r.slice([0,0],[n,n])),[q,r]})}exports.gramSchmidt=operation_1.op({gramSchmidt_:function(xs){var inputIsTensor2D;if(Array.isArray(xs)){inputIsTensor2D=!1,util_1.assert(null!=xs&&0<xs.length,function(){return"Gram-Schmidt process: input must not be null, undefined, or empty"});for(var dim_1=xs[0].shape[0],_loop_1=function(i){util_1.assert(xs[i].shape[0]===dim_1,function(){return"Gram-Schmidt: Non-unique lengths found in the input vectors: ("+xs[i].shape[0]+" vs. "+dim_1+")"})},i=1;i<xs.length;++i)_loop_1(i)}else inputIsTensor2D=!0,xs=concat_split_1.split(xs,xs.shape[0],0).map(function(x){return array_ops_1.squeeze(x,[0])});util_1.assert(xs.length<=xs[0].shape[0],function(){return"Gram-Schmidt: Number of vectors ("+xs.length+") exceeds number of dimensions ("+xs[0].shape[0]+")."});function _loop_2(i){ys.push(engine_1.ENGINE.tidy(function(){var x=xs1d[i];if(0<i)for(var j=0;j<i;++j){var proj=reduction_ops_1.sum(ys[j].mulStrict(x)).mul(ys[j]);x=x.sub(proj)}return x.div(norm_1.norm(x,"euclidean"))}))}var ys=[],xs1d=xs;for(i=0;i<xs.length;++i)_loop_2(i);return inputIsTensor2D?array_ops_1.stack(ys,0):ys}}),exports.qr=operation_1.op({qr_:function(x,fullMatrices){if(void 0===fullMatrices&&(fullMatrices=!1),x.rank<2)throw new Error("qr() requires input tensor to have a rank >= 2, but got rank "+x.rank);if(2===x.rank)return qr2d(x,fullMatrices);var outerDimsProd=x.shape.slice(0,x.shape.length-2).reduce(function(value,prev){return value*prev}),x2ds=array_ops_1.unstack(x.reshape([outerDimsProd,x.shape[x.shape.length-2],x.shape[x.shape.length-1]]),0),q2ds_1=[],r2ds_1=[];return x2ds.forEach(function(x2d){var _a=qr2d(x2d,fullMatrices),q2d=_a[0],r2d=_a[1];q2ds_1.push(q2d),r2ds_1.push(r2d)}),[array_ops_1.stack(q2ds_1,0).reshape(x.shape),array_ops_1.stack(r2ds_1,0).reshape(x.shape)]}})},{"../engine":143,"../globals":146,"../util":241,"./array_ops":163,"./concat_split":173,"./norm":194,"./operation":195,"./reduction_ops":200,"./tensor_ops":216}],188:[function(require,module,exports){"use strict";var __awaiter=this&&this.__awaiter||function(thisArg,_arguments,P,generator){return new(P=P||Promise)(function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){result.done?resolve(result.value):new P(function(resolve){resolve(result.value)}).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())})},__generator=this&&this.__generator||function(thisArg,body){var f,y,t,g,_={label:0,sent:function(){if(1&t[0])throw t[1];return t[1]},trys:[],ops:[]};return g={next:verb(0),throw:verb(1),return:verb(2)},"function"==typeof Symbol&&(g[Symbol.iterator]=function(){return this}),g;function verb(n){return function(v){return function(op){if(f)throw new TypeError("Generator is already executing.");for(;_;)try{if(f=1,y&&(t=2&op[0]?y.return:op[0]?y.throw||((t=y.return)&&t.call(y),0):y.next)&&!(t=t.call(y,op[1])).done)return t;switch(y=0,t&&(op=[2&op[0],t.value]),op[0]){case 0:case 1:t=op;break;case 4:return _.label++,{value:op[1],done:!1};case 5:_.label++,y=op[1],op=[0];continue;case 7:op=_.ops.pop(),_.trys.pop();continue;default:if(!(t=0<(t=_.trys).length&&t[t.length-1])&&(6===op[0]||2===op[0])){_=0;continue}if(3===op[0]&&(!t||op[1]>t[0]&&op[1]<t[3])){_.label=op[1];break}if(6===op[0]&&_.label<t[1]){_.label=t[1],t=op;break}if(t&&_.label<t[2]){_.label=t[2],_.ops.push(op);break}t[2]&&_.ops.pop(),_.trys.pop();continue}op=body.call(thisArg,_)}catch(e){op=[6,e],y=0}finally{f=t=0}if(5&op[0])throw op[1];return{value:op[0]?op[1]:void 0,done:!0}}([n,v])}}};Object.defineProperty(exports,"__esModule",{value:!0});var where_impl_1=require("../backends/where_impl"),engine_1=require("../engine"),tensor_util_env_1=require("../tensor_util_env"),util_1=require("../util"),broadcast_util_1=require("./broadcast_util"),operation_1=require("./operation"),tensor_ops_1=require("./tensor_ops");exports.logicalAnd=operation_1.op({logicalAnd_:function(a,b){var $a=tensor_util_env_1.convertToTensor(a,"a","logicalAnd","bool"),$b=tensor_util_env_1.convertToTensor(b,"b","logicalAnd","bool");return broadcast_util_1.assertAndGetBroadcastShape($a.shape,$b.shape),engine_1.ENGINE.runKernel(function(backend){return backend.logicalAnd($a,$b)},{$a:$a,$b:$b})}}),exports.logicalNot=operation_1.op({logicalNot_:function(x){var $x=tensor_util_env_1.convertToTensor(x,"x","logicalNot","bool");return engine_1.ENGINE.runKernel(function(backend){return backend.logicalNot($x)},{$x:$x})}}),exports.logicalOr=operation_1.op({logicalOr_:function(a,b){var $a=tensor_util_env_1.convertToTensor(a,"a","logicalOr","bool"),$b=tensor_util_env_1.convertToTensor(b,"b","logicalOr","bool");return broadcast_util_1.assertAndGetBroadcastShape($a.shape,$b.shape),engine_1.ENGINE.runKernel(function(backend){return backend.logicalOr($a,$b)},{$a:$a,$b:$b})}}),exports.logicalXor=operation_1.op({logicalXor_:function(a,b){var $a=tensor_util_env_1.convertToTensor(a,"a","logicalXor","bool"),$b=tensor_util_env_1.convertToTensor(b,"b","logicalXor","bool");return broadcast_util_1.assertAndGetBroadcastShape($a.shape,$b.shape),exports.logicalOr(a,b).logicalAnd(exports.logicalAnd(a,b).logicalNot())}}),exports.where=operation_1.op({where_:function(condition,a,b){var $a=tensor_util_env_1.convertToTensor(a,"a","where"),$b=tensor_util_env_1.convertToTensor(b,"b","where"),$condition=tensor_util_env_1.convertToTensor(condition,"condition","where","bool");return util_1.assertShapesMatch($a.shape,$b.shape,"Error in where: "),1===$condition.rank?util_1.assert($condition.shape[0]===$a.shape[0],function(){return"The first dimension of `a` must match the size of `condition`."}):util_1.assertShapesMatch($condition.shape,$b.shape,"Error in where: "),engine_1.ENGINE.runKernel(function(backend,save){var res=backend.select($condition,$a,$b);return save([$condition]),res},{$condition:$condition,$a:$a,$b:$b},function(dy,saved){var $condition=saved[0];return{$condition:function(){return tensor_ops_1.zerosLike($condition).toFloat()},$a:function(){return dy.mul($condition.cast(dy.dtype))},$b:function(){return dy.mul($condition.logicalNot().cast(dy.dtype))}}})}}),exports.whereAsync=function(condition){return __awaiter(this,void 0,void 0,function(){var $condition,vals,res;return __generator(this,function(_a){switch(_a.label){case 0:return[4,($condition=tensor_util_env_1.convertToTensor(condition,"condition","whereAsync","bool")).data()];case 1:return vals=_a.sent(),res=where_impl_1.whereImpl($condition.shape,vals),condition!==$condition&&$condition.dispose(),[2,res]}})})}},{"../backends/where_impl":140,"../engine":143,"../tensor_util_env":237,"../util":241,"./broadcast_util":169,"./operation":195,"./tensor_ops":216}],189:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var Reduction,gradients_1=require("../gradients"),tensor_util_env_1=require("../tensor_util_env"),util_1=require("../util"),axis_util_1=require("./axis_util"),binary_ops_1=require("./binary_ops"),operation_1=require("./operation"),tensor_ops_1=require("./tensor_ops");!function(Reduction){Reduction[Reduction.NONE=0]="NONE",Reduction[Reduction.MEAN=1]="MEAN",Reduction[Reduction.SUM=2]="SUM",Reduction[Reduction.SUM_BY_NONZERO_WEIGHTS=3]="SUM_BY_NONZERO_WEIGHTS"}(Reduction=exports.Reduction||(exports.Reduction={})),exports.absoluteDifference=operation_1.op({absoluteDifference_:function(labels,predictions,weights,reduction){void 0===reduction&&(reduction=Reduction.SUM_BY_NONZERO_WEIGHTS);var $labels=tensor_util_env_1.convertToTensor(labels,"labels","absoluteDifference"),$predictions=tensor_util_env_1.convertToTensor(predictions,"predictions","absoluteDifference"),$weights=null;null!=weights&&($weights=tensor_util_env_1.convertToTensor(weights,"weights","absoluteDifference")),util_1.assertShapesMatch($labels.shape,$predictions.shape,"Error in absoluteDifference: ");var losses=$labels.sub($predictions).abs();return exports.computeWeightedLoss(losses,$weights,reduction)}}),exports.computeWeightedLoss=operation_1.op({computeWeightedLoss_:function(losses,weights,reduction){void 0===reduction&&(reduction=Reduction.SUM_BY_NONZERO_WEIGHTS);var $losses=tensor_util_env_1.convertToTensor(losses,"losses","computeWeightedLoss"),$weights=null;null!=weights&&($weights=tensor_util_env_1.convertToTensor(weights,"weights","computeWeightedLoss"));var weightedLoss=null==$weights?$losses:$losses.mul($weights);if(reduction===Reduction.NONE)return weightedLoss;if(reduction===Reduction.SUM)return weightedLoss.sum();if(reduction===Reduction.MEAN){if(null==$weights)return weightedLoss.mean();var broadcastFactor=$losses.size/$weights.size,result=weightedLoss.sum().div($weights.sum());return 1<broadcastFactor?result.div(tensor_ops_1.scalar(broadcastFactor)):result}if(reduction!==Reduction.SUM_BY_NONZERO_WEIGHTS)throw Error("Unknown reduction: "+reduction);if(null==$weights)return weightedLoss.sum().div(tensor_ops_1.scalar($losses.size));var numNonZeros=$weights.mul(tensor_ops_1.ones($losses.shape)).notEqual(tensor_ops_1.scalar(0)).sum().toFloat();return weightedLoss.sum().div(numNonZeros)}}),exports.cosineDistance=operation_1.op({cosineDistance_:function(labels,predictions,axis,weights,reduction){void 0===reduction&&(reduction=Reduction.SUM_BY_NONZERO_WEIGHTS);var $labels=tensor_util_env_1.convertToTensor(labels,"labels","cosineDistance"),$predictions=tensor_util_env_1.convertToTensor(predictions,"predictions","cosineDistance"),$weights=null;null!=weights&&($weights=tensor_util_env_1.convertToTensor(weights,"weights","cosineDistance")),util_1.assertShapesMatch($labels.shape,$predictions.shape,"Error in cosineDistance: ");var losses=tensor_ops_1.scalar(1).sub($labels.mul($predictions).sum(axis,!0));return exports.computeWeightedLoss(losses,$weights,reduction)}}),exports.hingeLoss=operation_1.op({hingeLoss_:function(labels,predictions,weights,reduction){void 0===reduction&&(reduction=Reduction.SUM_BY_NONZERO_WEIGHTS);var $labels=tensor_util_env_1.convertToTensor(labels,"labels","hingeLoss"),$predictions=tensor_util_env_1.convertToTensor(predictions,"predictions","hingeLoss"),$weights=null;null!=weights&&($weights=tensor_util_env_1.convertToTensor(weights,"weights","hingeLoss")),util_1.assertShapesMatch($labels.shape,$predictions.shape,"Error in hingeLoss: ");var one=tensor_ops_1.scalar(1);$labels=tensor_ops_1.scalar(2).mul($labels).sub(one);var losses=one.sub($labels.mul($predictions)).relu();return exports.computeWeightedLoss(losses,$weights,reduction)}}),exports.huberLoss=operation_1.op({huberLoss_:function(labels,predictions,weights,delta,reduction){void 0===delta&&(delta=1),void 0===reduction&&(reduction=Reduction.SUM_BY_NONZERO_WEIGHTS);var $labels=tensor_util_env_1.convertToTensor(labels,"labels","huberLoss"),$predictions=tensor_util_env_1.convertToTensor(predictions,"predictions","huberLoss"),$weights=null;null!=weights&&($weights=tensor_util_env_1.convertToTensor(weights,"weights","huberLoss")),util_1.assertShapesMatch($labels.shape,$predictions.shape,"Error in huberLoss: ");var deltaScalar=tensor_ops_1.scalar(delta),error=$predictions.sub($labels).abs(),quadratic=binary_ops_1.minimum(error,deltaScalar),linear=error.sub(quadratic),losses=tensor_ops_1.scalar(.5).mul(quadratic.square()).add(deltaScalar.mul(linear));return exports.computeWeightedLoss(losses,$weights,reduction)}}),exports.logLoss=operation_1.op({logLoss_:function(labels,predictions,weights,epsilon,reduction){void 0===epsilon&&(epsilon=1e-7),void 0===reduction&&(reduction=Reduction.SUM_BY_NONZERO_WEIGHTS);var $labels=tensor_util_env_1.convertToTensor(labels,"labels","logLoss"),$predictions=tensor_util_env_1.convertToTensor(predictions,"predictions","logLoss"),$weights=null;null!=weights&&($weights=tensor_util_env_1.convertToTensor(weights,"weights","logLoss")),util_1.assertShapesMatch($labels.shape,$predictions.shape,"Error in logLoss: ");var one=tensor_ops_1.scalar(1),epsilonScalar=tensor_ops_1.scalar(epsilon),losses=$labels.mul($predictions.add(epsilonScalar).log()).neg().sub(one.sub($labels).mul(one.sub($predictions).add(epsilonScalar).log()));return exports.computeWeightedLoss(losses,$weights,reduction)}}),exports.meanSquaredError=operation_1.op({meanSquaredError_:function(labels,predictions,weights,reduction){void 0===reduction&&(reduction=Reduction.SUM_BY_NONZERO_WEIGHTS);var $labels=tensor_util_env_1.convertToTensor(labels,"labels","meanSquaredError"),$predictions=tensor_util_env_1.convertToTensor(predictions,"predictions","meanSquaredError"),$weights=null;null!=weights&&($weights=tensor_util_env_1.convertToTensor(weights,"weights","meanSquaredError")),util_1.assertShapesMatch($labels.shape,$predictions.shape,"Error in meanSquaredError: ");var losses=$labels.squaredDifference($predictions);return exports.computeWeightedLoss(losses,$weights,reduction)}}),exports.sigmoidCrossEntropy=operation_1.op({sigmoidCrossEntropy_:function(multiClassLabels,logits,weights,labelSmoothing,reduction){void 0===labelSmoothing&&(labelSmoothing=0),void 0===reduction&&(reduction=Reduction.SUM_BY_NONZERO_WEIGHTS);var $multiClassLabels=tensor_util_env_1.convertToTensor(multiClassLabels,"multiClassLabels","sigmoidCrossEntropy"),$logits=tensor_util_env_1.convertToTensor(logits,"logits","sigmoidCrossEntropy"),$weights=null;if(null!=weights&&($weights=tensor_util_env_1.convertToTensor(weights,"weights","sigmoidCrossEntropy")),util_1.assertShapesMatch($multiClassLabels.shape,$logits.shape,"Error in sigmoidCrossEntropy: "),0<labelSmoothing){var labelSmoothingScalar=tensor_ops_1.scalar(labelSmoothing),one=tensor_ops_1.scalar(1),half=tensor_ops_1.scalar(.5);$multiClassLabels=$multiClassLabels.mul(one.sub(labelSmoothingScalar)).add(half.mul(labelSmoothingScalar))}var losses=function(labels,logits){var $labels=tensor_util_env_1.convertToTensor(labels,"labels","sigmoidCrossEntropyWithLogits"),$logits=tensor_util_env_1.convertToTensor(logits,"logits","sigmoidCrossEntropyWithLogits");util_1.assertShapesMatch($labels.shape,$logits.shape,"Error in sigmoidCrossEntropyWithLogits: ");var maxOutput=$logits.relu(),outputXTarget=$logits.mul($labels),sigmoidOutput=$logits.abs().neg().exp().log1p();return maxOutput.sub(outputXTarget).add(sigmoidOutput)}($multiClassLabels,$logits);return exports.computeWeightedLoss(losses,$weights,reduction)}}),exports.softmaxCrossEntropy=operation_1.op({softmaxCrossEntropy_:function(onehotLabels,logits,weights,labelSmoothing,reduction){void 0===labelSmoothing&&(labelSmoothing=0),void 0===reduction&&(reduction=Reduction.SUM_BY_NONZERO_WEIGHTS);var $onehotLabels=tensor_util_env_1.convertToTensor(onehotLabels,"onehotLabels","softmaxCrossEntropy"),$logits=tensor_util_env_1.convertToTensor(logits,"logits","softmaxCrossEntropy"),$weights=null;if(null!=weights&&($weights=tensor_util_env_1.convertToTensor(weights,"weights","softmaxCrossEntropy")),util_1.assertShapesMatch($onehotLabels.shape,$logits.shape,"Error in softmaxCrossEntropy: "),0<labelSmoothing){var labelSmoothingScalar=tensor_ops_1.scalar(labelSmoothing),one=tensor_ops_1.scalar(1),numClasses=tensor_ops_1.scalar($onehotLabels.shape[1]);$onehotLabels=$onehotLabels.mul(one.sub(labelSmoothingScalar)).add(labelSmoothingScalar.div(numClasses))}var losses=function(labels,logits,dim){if(void 0===dim&&(dim=-1),-1===dim&&(dim=logits.rank-1),dim!==logits.rank-1)throw Error("Softmax cross entropy along a non-last dimension is not yet supported. Labels / logits was rank "+logits.rank+" and dim was "+dim);return gradients_1.customGrad(function(labels,logits,save){var lse=logits.logSumExp([dim],!0),logResult=logits.toFloat().sub(lse);save([labels,logResult]);return{value:logResult.mul(labels).neg().sum([dim]),gradFunc:function(dy,saved){var labels=saved[0],logResult=saved[1],dyShape=axis_util_1.expandShapeToKeepDim(dy.shape,[dim]);return[dy.reshape(dyShape).mul(labels.toFloat().sub(logResult.exp())),dy.reshape(dyShape).mul(logResult.exp().sub(labels.toFloat()))]}}})(labels,logits)}($onehotLabels,$logits);return exports.computeWeightedLoss(losses,$weights,reduction)}})},{"../gradients":147,"../tensor_util_env":237,"../util":241,"./axis_util":165,"./binary_ops":167,"./operation":195,"./tensor_ops":216}],190:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var engine_1=require("../engine"),tensor_util_env_1=require("../tensor_util_env"),util=require("../util"),operation_1=require("./operation");exports.localResponseNormalization=operation_1.op({localResponseNormalization_:function(x,depthRadius,bias,alpha,beta){void 0===depthRadius&&(depthRadius=5),void 0===bias&&(bias=1),void 0===alpha&&(alpha=1),void 0===beta&&(beta=.5);var $x=tensor_util_env_1.convertToTensor(x,"x","localResponseNormalization");util.assert(4===$x.rank||3===$x.rank,function(){return"Error in localResponseNormalization: x must be rank 3 or 4 but got\n               rank "+$x.rank+"."}),util.assert(util.isInt(depthRadius),function(){return"Error in localResponseNormalization: depthRadius must be an integer but got depthRadius "+depthRadius+"."});var x4D=$x,reshapedTo4D=!1;3===$x.rank&&(reshapedTo4D=!0,x4D=$x.as4D(1,$x.shape[0],$x.shape[1],$x.shape[2]));var res=engine_1.ENGINE.runKernel(function(backend,save){var y=backend.localResponseNormalization4D(x4D,depthRadius,bias,alpha,beta);return save([x4D,y]),y},{x4D:x4D},function(dy,saved){var x4D=saved[0],y=saved[1];return{x4D:function(){return engine_1.ENGINE.runKernel(function(backend){return backend.LRNGrad(dy,x4D,y,depthRadius,bias,alpha,beta)},{})}}});return reshapedTo4D?res.as3D(res.shape[1],res.shape[2],res.shape[3]):res}})},{"../engine":143,"../tensor_util_env":237,"../util":241,"./operation":195}],191:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var tensor_util_env_1=require("../tensor_util_env"),operation_1=require("./operation");exports.basicLSTMCell=operation_1.op({basicLSTMCell_:function(forgetBias,lstmKernel,lstmBias,data,c,h){var $forgetBias=tensor_util_env_1.convertToTensor(forgetBias,"forgetBias","basicLSTMCell"),$lstmKernel=tensor_util_env_1.convertToTensor(lstmKernel,"lstmKernel","basicLSTMCell"),$lstmBias=tensor_util_env_1.convertToTensor(lstmBias,"lstmBias","basicLSTMCell"),$data=tensor_util_env_1.convertToTensor(data,"data","basicLSTMCell"),$c=tensor_util_env_1.convertToTensor(c,"c","basicLSTMCell"),$h=tensor_util_env_1.convertToTensor(h,"h","basicLSTMCell"),res=$data.concat($h,1).matMul($lstmKernel).add($lstmBias),batchSize=res.shape[0],sliceCols=res.shape[1]/4,sliceSize=[batchSize,sliceCols],i=res.slice([0,0],sliceSize),j=res.slice([0,sliceCols],sliceSize),f=res.slice([0,2*sliceCols],sliceSize),o=res.slice([0,3*sliceCols],sliceSize),newC=i.sigmoid().mulStrict(j.tanh()).addStrict($c.mulStrict($forgetBias.add(f).sigmoid())),newH=newC.tanh().mulStrict(o.sigmoid());return[newC,newH]}}),exports.multiRNNCell=operation_1.op({multiRNNCell_:function(lstmCells,data,c,h){for(var $data=tensor_util_env_1.convertToTensor(data,"data","multiRNNCell"),$c=tensor_util_env_1.convertToTensorArray(c,"c","multiRNNCell"),$h=tensor_util_env_1.convertToTensorArray(h,"h","multiRNNCell"),input=$data,newStates=[],i=0;i<lstmCells.length;i++){var output=lstmCells[i](input,$c[i],$h[i]);newStates.push(output[0]),newStates.push(output[1]),input=output[1]}var newC=[],newH=[];for(i=0;i<newStates.length;i+=2)newC.push(newStates[i]),newH.push(newStates[i+1]);return[newC,newH]}})},{"../tensor_util_env":237,"./operation":195}],192:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var engine_1=require("../engine"),tensor_util_1=require("../tensor_util"),tensor_util_env_1=require("../tensor_util_env"),util=require("../util"),operation_1=require("./operation");exports.matMul=operation_1.op({matMul_:function(a,b,transposeA,transposeB){var _a;void 0===transposeA&&(transposeA=!1),void 0===transposeB&&(transposeB=!1);var $a=tensor_util_env_1.convertToTensor(a,"a","matMul"),$b=tensor_util_env_1.convertToTensor(b,"b","matMul");_a=tensor_util_1.makeTypesMatch($a,$b),$a=_a[0],$b=_a[1];var innerShapeA=transposeA?$a.shape[$a.rank-2]:$a.shape[$a.rank-1],innerShapeB=transposeB?$b.shape[$b.rank-1]:$b.shape[$b.rank-2],outerShapeA=transposeA?$a.shape[$a.rank-1]:$a.shape[$a.rank-2],outerShapeB=transposeB?$b.shape[$b.rank-2]:$b.shape[$b.rank-1],outerDimsA=$a.shape.slice(0,-2),outerDimsB=$b.shape.slice(0,-2),batchDimA=util.sizeFromShape(outerDimsA),batchDimB=util.sizeFromShape(outerDimsB);util.assert(2<=$a.rank&&2<=$b.rank&&$a.rank===$b.rank,function(){return"Error in matMul: inputs must have the same rank of at least 2, got ranks "+$a.rank+" and "+$b.rank+"."}),util.assert(util.arraysEqual(outerDimsA,outerDimsB),function(){return"Error in matMul: outer dimensions ("+outerDimsA+") and ("+outerDimsB+") of Tensors with shapes "+$a.shape+" and "+$b.shape+" must match."}),util.assert(innerShapeA===innerShapeB,function(){return"Error in matMul: inner shapes ("+innerShapeA+") and ("+innerShapeB+") of Tensors with shapes "+$a.shape+" and "+$b.shape+" and transposeA="+transposeA+" and transposeB="+transposeB+" must match."});var outShape=$a.shape.slice(0,-2).concat([outerShapeA,outerShapeB]),a3D=transposeA?$a.as3D(batchDimA,innerShapeA,outerShapeA):$a.as3D(batchDimA,outerShapeA,innerShapeA),b3D=transposeB?$b.as3D(batchDimB,outerShapeB,innerShapeB):$b.as3D(batchDimB,innerShapeB,outerShapeB);return engine_1.ENGINE.runKernel(function(backend,save){var res=backend.batchMatMul(a3D,b3D,transposeA,transposeB);return save([a3D,b3D]),res},{$a:a3D,$b:b3D},function(dy,saved){var _a=saved,a3D=_a[0],b3D=_a[1];return transposeA||transposeB?!transposeA&&transposeB?{$a:function(){return dy.matMul(b3D,!1,!1)},$b:function(){return dy.matMul(a3D,!0,!1)}}:transposeA&&!transposeB?{$a:function(){return b3D.matMul(dy,!1,!0)},$b:function(){return a3D.matMul(dy,!1,!1)}}:{$a:function(){return b3D.matMul(dy,!0,!0)},$b:function(){return dy.matMul(a3D,!0,!0)}}:{$a:function(){return dy.matMul(b3D,!1,!0)},$b:function(){return a3D.matMul(dy,!0,!1)}}}).reshape(outShape)}}),exports.dot=operation_1.op({dot_:function(t1,t2){var $t1=tensor_util_env_1.convertToTensor(t1,"t1","dot"),$t2=tensor_util_env_1.convertToTensor(t2,"t2","dot");util.assert(!(1!==$t1.rank&&2!==$t1.rank||1!==$t2.rank&&2!==$t2.rank),function(){return"Error in dot: inputs must all be rank 1 or 2, but got ranks "+$t1.rank+" and "+$t2.rank+"."});var t1Inner=1===$t1.rank?$t1.size:$t1.shape[1],t2Inner=1===$t2.rank?$t2.size:$t2.shape[0];return util.assert(t1Inner===t2Inner,function(){return"Error in dot: inner dimensions of inputs must match, but got "+t1Inner+" and "+t2Inner+"."}),1===$t1.rank&&1===$t2.rank?$t1.as2D(1,-1).matMul($t2.as2D(-1,1)).asScalar():1===$t1.rank&&2===$t2.rank?$t1.as2D(1,-1).matMul($t2.as2D($t2.shape[0],$t2.shape[1])).as1D():2===$t1.rank&&1===$t2.rank?$t1.matMul($t2.as2D(-1,1)).as1D():$t1.matMul($t2.as2D($t2.shape[0],$t2.shape[1]))}}),exports.outerProduct=operation_1.op({outerProduct_:function(v1,v2){var $v1=tensor_util_env_1.convertToTensor(v1,"v1","outerProduct"),$v2=tensor_util_env_1.convertToTensor(v2,"v2","outerProduct");return util.assert(1===$v1.rank&&1===$v2.rank,function(){return"Error in outerProduct: inputs must be rank 1, but got ranks "+$v1.rank+" and "+$v2.rank+"."}),$v1.as2D(-1,1).matMul($v2.as2D(1,-1))}})},{"../engine":143,"../tensor_util":236,"../tensor_util_env":237,"../util":241,"./operation":195}],193:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var tensor_util_1=require("../tensor_util"),tensor_util_env_1=require("../tensor_util_env"),util=require("../util"),binary_ops_1=require("./binary_ops"),operation_1=require("./operation"),tensor_ops_1=require("./tensor_ops");exports.movingAverage=operation_1.op({movingAverage_:function(v,x,decay,step,zeroDebias){void 0===zeroDebias&&(zeroDebias=!0);var $v=tensor_util_env_1.convertToTensor(v,"v","movingAverage"),$x=tensor_util_env_1.convertToTensor(x,"x","movingAverage"),$decay=tensor_util_env_1.convertToTensor(decay,"decay","movingAverage");tensor_util_1.assertTypesMatch($v,$x),util.assert(util.arraysEqual($v.shape,$x.shape),function(){return"Shape mismatch in v and x"});var one=tensor_ops_1.scalar(1),oneMinusDecay=one.sub($decay),update=$x.sub($v).mul(oneMinusDecay);if(zeroDebias){util.assert(null!=step,function(){return"When using zeroDebias: true, step is required."});var $step=tensor_util_env_1.convertToTensor(step,"step","movingAverage");update=update.div(one.sub(binary_ops_1.pow($decay,$step)))}return $v.add(update)}})},{"../tensor_util":236,"../tensor_util_env":237,"../util":241,"./binary_ops":167,"./operation":195,"./tensor_ops":216}],194:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var tensor_util_env_1=require("../tensor_util_env"),util_1=require("../util"),axis_util=require("./axis_util"),operation_1=require("./operation"),tensor_ops_1=require("./tensor_ops");exports.norm=operation_1.op({norm_:function(x,ord,axis,keepDims){void 0===ord&&(ord="euclidean"),void 0===axis&&(axis=null),void 0===keepDims&&(keepDims=!1);var norm=function normImpl(x,p,axis){void 0===axis&&(axis=null);if(0===x.rank)return x.abs();if(1!==x.rank&&null===axis)return normImpl(x.reshape([-1]),p,axis);if(1===x.rank||"number"==typeof axis||Array.isArray(axis)&&1===axis.length){if(1===p)return x.abs().sum(axis);if(p===1/0)return x.abs().max(axis);if(p===-1/0)return x.abs().min(axis);if("euclidean"===p||2===p)return x.abs().pow(tensor_ops_1.scalar(2,"int32")).sum(axis).sqrt();throw new Error("Error in norm: invalid ord value: "+p)}if(Array.isArray(axis)&&2===axis.length){if(1===p)return x.abs().sum(axis[0]).max(axis[1]-1);if(p===1/0)return x.abs().sum(axis[1]).max(axis[0]);if(p===-1/0)return x.abs().sum(axis[1]).min(axis[0]);if("fro"===p||"euclidean"===p)return x.square().sum(axis).sqrt();throw new Error("Error in norm: invalid ord value: "+p)}throw new Error("Error in norm: invalid axis: "+axis)}(x=tensor_util_env_1.convertToTensor(x,"x","norm"),ord,axis),keepDimsShape=norm.shape;if(keepDims){var axes=util_1.parseAxisParam(axis,x.shape);keepDimsShape=axis_util.expandShapeToKeepDim(norm.shape,axes)}return norm.reshape(keepDimsShape)}})},{"../tensor_util_env":237,"../util":241,"./axis_util":165,"./operation":195,"./tensor_ops":216}],195:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var engine_1=require("../engine");exports.op=function(f){var keys=Object.keys(f);if(1!==keys.length)throw new Error("Please provide an object with a single key (operation name) mapping to a function. Got an object with "+keys.length+" keys.");var opName=keys[0],fn=f[opName];function f2(){for(var args=[],_i=0;_i<arguments.length;_i++)args[_i]=arguments[_i];engine_1.ENGINE.startScope(opName);try{var result=fn.apply(void 0,args);return result instanceof Promise&&console.error("Cannot return a Promise inside of tidy."),engine_1.ENGINE.endScope(result),result}catch(ex){throw engine_1.ENGINE.endScope(null),ex}}return opName.endsWith("_")&&(opName=opName.substring(0,opName.length-1)),Object.defineProperty(f2,"name",{value:opName,configurable:!0}),f2}},{"../engine":143}],196:[function(require,module,exports){"use strict";function __export(m){for(var p in m)exports.hasOwnProperty(p)||(exports[p]=m[p])}Object.defineProperty(exports,"__esModule",{value:!0}),__export(require("./batchnorm")),__export(require("./boolean_mask")),__export(require("./complex_ops")),__export(require("./concat_split")),__export(require("./conv")),__export(require("./matmul")),__export(require("./reverse")),__export(require("./pool")),__export(require("./slice")),__export(require("./unary_ops")),__export(require("./reduction_ops")),__export(require("./compare")),__export(require("./binary_ops")),__export(require("./relu_ops")),__export(require("./logical_ops")),__export(require("./array_ops")),__export(require("./tensor_ops")),__export(require("./transpose")),__export(require("./softmax")),__export(require("./lrn")),__export(require("./norm")),__export(require("./segment_ops")),__export(require("./lstm")),__export(require("./moving_average")),__export(require("./strided_slice")),__export(require("./topk")),__export(require("./scatter_nd")),__export(require("./spectral_ops")),__export(require("./sparse_to_dense")),__export(require("./gather_nd")),__export(require("./diag")),__export(require("./dropout")),__export(require("./signal_ops")),__export(require("./in_top_k"));var operation_1=require("./operation");exports.op=operation_1.op;var losses=require("./loss_ops");exports.losses=losses;var linalg=require("./linalg_ops");exports.linalg=linalg;var image=require("./image_ops");exports.image=image;var spectral=require("./spectral_ops");exports.spectral=spectral;var fused=require("./fused_ops");exports.fused=fused;var signal=require("./signal_ops");exports.signal=signal},{"./array_ops":163,"./batchnorm":166,"./binary_ops":167,"./boolean_mask":168,"./compare":171,"./complex_ops":172,"./concat_split":173,"./conv":176,"./diag":178,"./dropout":179,"./fused_ops":182,"./gather_nd":183,"./image_ops":185,"./in_top_k":186,"./linalg_ops":187,"./logical_ops":188,"./loss_ops":189,"./lrn":190,"./lstm":191,"./matmul":192,"./moving_average":193,"./norm":194,"./operation":195,"./pool":197,"./reduction_ops":200,"./relu_ops":201,"./reverse":202,"./scatter_nd":203,"./segment_ops":205,"./signal_ops":208,"./slice":209,"./softmax":211,"./sparse_to_dense":212,"./spectral_ops":214,"./strided_slice":215,"./tensor_ops":216,"./topk":217,"./transpose":218,"./unary_ops":219}],197:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var engine_1=require("../engine"),tensor_util_env_1=require("../tensor_util_env"),util=require("../util"),array_ops_1=require("./array_ops"),conv_util=require("./conv_util"),operation_1=require("./operation");function maxPoolImpl_(x,filterSize,strides,dilations,pad,dimRoundingMode){var $x=tensor_util_env_1.convertToTensor(x,"x","maxPool"),x4D=$x,reshapedTo4D=!1;3===$x.rank&&(reshapedTo4D=!0,x4D=$x.as4D(1,$x.shape[0],$x.shape[1],$x.shape[2])),null==dilations&&(dilations=[1,1]),util.assert(4===x4D.rank,function(){return"Error in maxPool: input must be rank 4 but got rank "+x4D.rank+"."}),util.assert(conv_util.eitherStridesOrDilationsAreOne(strides,dilations),function(){return"Error in maxPool: Either strides or dilations must be 1. Got strides "+strides+" and dilations '"+dilations+"'"}),null!=dimRoundingMode&&util.assert(util.isInt(pad),function(){return"Error in maxPool: pad must be an integer when using, dimRoundingMode "+dimRoundingMode+" but got pad "+pad+"."});var convInfo=conv_util.computePool2DInfo(x4D.shape,filterSize,strides,dilations,pad,dimRoundingMode),res=engine_1.ENGINE.runKernel(function(backend,save){var y=backend.maxPool(x4D,convInfo);return save([x4D,y]),y},{x:x4D},function(dy,saved){var x4D=saved[0],y=saved[1];return{x:function(){return function(dy,input,output,filterSize,strides,dilations,pad,dimRoundingMode){var $dy=tensor_util_env_1.convertToTensor(dy,"dy","maxPoolBackprop"),$input=tensor_util_env_1.convertToTensor(input,"input","maxPoolBackprop"),$output=tensor_util_env_1.convertToTensor(output,"output","maxPoolBackprop");util.assert($input.rank===$dy.rank,function(){return"Rank of input ("+$input.rank+") does not match rank of dy ("+$dy.rank+")"}),null==dilations&&(dilations=[1,1]);util.assert(conv_util.eitherStridesOrDilationsAreOne(strides,dilations),function(){return"Error in maxPoolBackProp: Either strides or dilations must be 1. Got strides "+strides+" and dilations '"+dilations+"'"}),util.assert(4===$dy.rank,function(){return"Error in maxPoolBackprop: dy must be rank 4 but got rank "+$dy.rank+"."}),util.assert(4===$input.rank,function(){return"Error in maxPoolBackprop: input must be rank 4 but got rank "+$input.rank+"."}),null!=dimRoundingMode&&util.assert(util.isInt(pad),function(){return"Error in maxPoolBackprop: pad must be an integer when using, dimRoundingMode "+dimRoundingMode+" but got pad "+pad+"."});var convInfo=conv_util.computePool2DInfo($input.shape,filterSize,strides,dilations,pad,dimRoundingMode);return engine_1.ENGINE.runKernel(function(backend){return backend.maxPoolBackprop($dy,$input,$output,convInfo)},{$dy:$dy,$input:$input})}(dy,x4D,y,filterSize,strides,dilations,pad)}}});return reshapedTo4D?res.as3D(res.shape[1],res.shape[2],res.shape[3]):res}function avgPoolImpl_(x,filterSize,strides,dilations,pad,dimRoundingMode){var $x=tensor_util_env_1.convertToTensor(x,"x","avgPool","float32");null==dilations&&(dilations=[1,1]),util.assert(conv_util.eitherStridesOrDilationsAreOne(strides,dilations),function(){return"Error in avgPool: Either strides or dilations must be 1. Got strides "+strides+" and dilations '"+dilations+"'"});var x4D=$x,reshapedTo4D=!1;3===$x.rank&&(reshapedTo4D=!0,x4D=$x.as4D(1,$x.shape[0],$x.shape[1],$x.shape[2])),util.assert(4===x4D.rank,function(){return"Error in avgPool: x must be rank 4 but got rank "+x4D.rank+"."}),null!=dimRoundingMode&&util.assert(util.isInt(pad),function(){return"Error in avgPool: pad must be an integer when using, dimRoundingMode "+dimRoundingMode+" but got pad "+pad+"."});var convInfo=conv_util.computePool2DInfo(x4D.shape,filterSize,strides,dilations,pad,dimRoundingMode),res=engine_1.ENGINE.runKernel(function(backend){return backend.avgPool(x4D,convInfo)},{x:x4D},function(dy){return{x:function(){return function(dy,input,filterSize,strides,dilations,pad){var $dy=tensor_util_env_1.convertToTensor(dy,"dy","avgPoolBackprop"),$input=tensor_util_env_1.convertToTensor(input,"input","avgPoolBackprop");util.assert($input.rank===$dy.rank,function(){return"Rank of input ("+$input.rank+") does not match rank of dy ("+$dy.rank+")"}),null==dilations&&(dilations=[1,1]);util.assert(conv_util.eitherStridesOrDilationsAreOne(strides,dilations),function(){return"Error in avgPoolBackprop: Either strides or dilations must be 1. Got strides "+strides+" and dilations '"+dilations+"'"});var input4D=$input,dy4D=$dy,reshapedTo4D=!1;3===$input.rank&&(reshapedTo4D=!0,input4D=$input.as4D(1,$input.shape[0],$input.shape[1],$input.shape[2]),dy4D=$dy.as4D(1,$dy.shape[0],$dy.shape[1],$dy.shape[2]));util.assert(4===dy4D.rank,function(){return"Error in avgPoolBackprop: dy must be rank 4 but got rank "+dy4D.rank+"."}),util.assert(4===input4D.rank,function(){return"Error in avgPoolBackprop: input must be rank 4 but got rank "+input4D.rank+"."});var convInfo=conv_util.computePool2DInfo(input4D.shape,filterSize,strides,dilations,pad),res=engine_1.ENGINE.runKernel(function(backend){return backend.avgPoolBackprop(dy4D,input4D,convInfo)},{dy4D:dy4D,input4D:input4D});if(reshapedTo4D)return res.as3D(res.shape[1],res.shape[2],res.shape[3]);return res}(dy,x4D,filterSize,strides,dilations,pad)}}});return res=res.cast($x.dtype),reshapedTo4D?res.as3D(res.shape[1],res.shape[2],res.shape[3]):res}exports.maxPool=operation_1.op({maxPool_:function(x,filterSize,strides,pad,dimRoundingMode){return maxPoolImpl_(x,filterSize,strides,1,pad,dimRoundingMode)}}),exports.avgPool=operation_1.op({avgPool_:function(x,filterSize,strides,pad,dimRoundingMode){return avgPoolImpl_(x,filterSize,strides,1,pad,dimRoundingMode)}}),exports.pool=operation_1.op({pool_:function(input,windowShape,poolingType,pad,dilations,strides){null==dilations&&(dilations=[1,1]),null==strides&&(strides=1),0===pad&&(pad="valid");var $x=tensor_util_env_1.convertToTensor(input,"x","maxPool"),x4D=$x,reshapedTo4D=!1;3===$x.rank&&(reshapedTo4D=!0,x4D=$x.as4D(1,$x.shape[0],$x.shape[1],$x.shape[2])),util.assert(conv_util.eitherStridesOrDilationsAreOne(strides,dilations),function(){return"Error in pool: Either strides or dilations must be 1. Got strides "+strides+" and dilations '"+dilations+"'"});var basePadding,convInfo=conv_util.computePool2DInfo(x4D.shape,windowShape,strides,dilations,pad),dilation=[convInfo.dilationHeight,convInfo.dilationWidth];basePadding="same"===pad?function(filterShape,dilation){var padExtraShape=filterShape.map(function(s,i){return s+(s-1)*(dilation[i]-1)}).map(function(s){return s-1}),padExtraStart=padExtraShape.map(function(s){return Math.floor(s/2)}),padExtraEnd=padExtraShape.map(function(s,i){return s-padExtraStart[i]});return padExtraShape.map(function(_,i){return[padExtraStart[i],padExtraEnd[i]]})}([convInfo.filterHeight,convInfo.filterWidth],dilation):[[0,0],[0,0]];var isDilationOne=1===dilation[0]&&1===dilation[1],_a=function(inputShape,blockShape,basePadding){var padStart=basePadding.map(function(b){return b[0]}),origPadEnd=basePadding.map(function(b){return b[1]}),fullInputShape=inputShape.concat(padStart,origPadEnd),padEndExtra=blockShape.map(function(b,i){return(b-fullInputShape[i]%b)%b}),padEnd=origPadEnd.map(function(s,i){return s+padEndExtra[i]}),paddings=blockShape.map(function(_,i){return[padStart[i],padEnd[i]]}),crops=blockShape.map(function(_,i){return[0,padEndExtra[i]]});return[paddings,crops]}([convInfo.inHeight,convInfo.inWidth],dilation,basePadding),adjustedPadding=_a[0],adjustedCrops=_a[1],convertedPad=isDilationOne?pad:"valid",convertedX=isDilationOne?x4D:array_ops_1.spaceToBatchND(x4D,dilation,adjustedPadding),y=("avg"===poolingType?function(){return avgPoolImpl_(convertedX,windowShape,strides,1,convertedPad)}:function(){return maxPoolImpl_(convertedX,windowShape,strides,1,convertedPad)})(),res=isDilationOne?y:array_ops_1.batchToSpaceND(y,dilation,adjustedCrops);return reshapedTo4D?res.as3D(res.shape[1],res.shape[2],res.shape[3]):res}}),exports.maxPool3d=operation_1.op({maxPool3d_:function(x,filterSize,strides,pad,dimRoundingMode,dataFormat,dilations){void 0===dataFormat&&(dataFormat="NDHWC");var $x=tensor_util_env_1.convertToTensor(x,"x","maxPool3d"),x5D=$x,reshapedTo5D=!1;4===$x.rank&&(reshapedTo5D=!0,x5D=$x.as5D(1,$x.shape[0],$x.shape[1],$x.shape[2],$x.shape[3])),null==dilations&&(dilations=[1,1,1]),util.assert(5===x5D.rank,function(){return"Error in maxPool3d: x must be rank 5 but got rank "+x5D.rank+"."}),util.assert("NDHWC"===dataFormat,function(){return"Error in maxPool3d: Only NDHWC is currently supported, but got dataFormat of "+dataFormat}),util.assert(conv_util.eitherStridesOrDilationsAreOne(strides,dilations),function(){return"Error in maxPool3d: Either strides or dilations must be 1. Got strides "+strides+" and dilations '"+dilations+"'"}),null!=dimRoundingMode&&util.assert(util.isInt(pad),function(){return"Error in maxPool3d: pad must be an integer when using, dimRoundingMode "+dimRoundingMode+" but got pad "+pad+"."});var convInfo=conv_util.computePool3DInfo(x5D.shape,filterSize,strides,dilations,pad,dimRoundingMode,dataFormat),res=engine_1.ENGINE.runKernel(function(backend,save){var y=backend.maxPool3d(x5D,convInfo);return save([x5D,y]),y},{x:x5D},function(dy,saved){var x5D=saved[0],y=saved[1];return{x:function(){return function(dy,input,output,filterSize,strides,dilations,pad,dimRoundingMode){var $dy=tensor_util_env_1.convertToTensor(dy,"dy","maxPool3dBackprop"),$input=tensor_util_env_1.convertToTensor(input,"input","maxPool3dBackprop"),$output=tensor_util_env_1.convertToTensor(output,"output","maxPool3dBackprop"),dy5D=$dy,input5D=$input,output5D=$output,reshapedTo5D=!1;4===$input.rank&&(reshapedTo5D=!0,dy5D=$dy.as5D(1,$dy.shape[0],$dy.shape[1],$dy.shape[2],$dy.shape[3]),input5D=$input.as5D(1,$input.shape[0],$input.shape[1],$input.shape[2],$input.shape[3]),output5D=$output.as5D(1,$output.shape[0],$output.shape[1],$output.shape[2],$output.shape[3]));util.assert(5===dy5D.rank,function(){return"Error in maxPool3dBackprop: dy must be rank 5 but got rank "+dy5D.rank+"."}),util.assert(5===input5D.rank,function(){return"Error in maxPool3dBackprop: input must be rank 5 but got rank "+input5D.rank+"."}),util.assert(5===output5D.rank,function(){return"Error in maxPool3dBackprop: output must be rank 5 but got rank "+output5D.rank+"."}),null==dilations&&(dilations=[1,1,1]);util.assert(conv_util.eitherStridesOrDilationsAreOne(strides,dilations),function(){return"Error in maxPool3dBackprop: Either strides or dilations must be 1. Got strides "+strides+" and dilations '"+dilations+"'"}),null!=dimRoundingMode&&util.assert(util.isInt(pad),function(){return"Error in maxPool3dBackprop: pad must be an integer when using, dimRoundingMode "+dimRoundingMode+" but got pad "+pad+"."});var convInfo=conv_util.computePool3DInfo(input5D.shape,filterSize,strides,dilations,pad,dimRoundingMode),res=engine_1.ENGINE.runKernel(function(backend){return backend.maxPool3dBackprop(dy5D,input5D,output5D,convInfo)},{dy5D:dy5D,input5D:input5D});if(reshapedTo5D)return res.as4D(res.shape[1],res.shape[2],res.shape[3],res.shape[4]);return res}(dy,x5D,y,filterSize,strides,dilations,pad,dimRoundingMode)}}});return reshapedTo5D?res.as4D(res.shape[1],res.shape[2],res.shape[3],res.shape[4]):res}}),exports.avgPool3d=operation_1.op({avgPool3d_:function(x,filterSize,strides,pad,dimRoundingMode,dataFormat,dilations){void 0===dataFormat&&(dataFormat="NDHWC");var $x=tensor_util_env_1.convertToTensor(x,"x","avgPool3d","float32"),x5D=$x,reshapedTo5D=!1;4===$x.rank&&(reshapedTo5D=!0,x5D=$x.as5D(1,$x.shape[0],$x.shape[1],$x.shape[2],$x.shape[3])),null==dilations&&(dilations=[1,1,1]),util.assert(5===x5D.rank,function(){return"Error in avgPool3d: x must be rank 5 but got rank "+x5D.rank+"."}),util.assert("NDHWC"===dataFormat,function(){return"Error in avgPool3d: Only NDHWC is currently supported, but got dataFormat of "+dataFormat}),util.assert(conv_util.eitherStridesOrDilationsAreOne(strides,dilations),function(){return"Error in avgPool3d: Either strides or dilations must be 1. Got strides "+strides+" and dilations '"+dilations+"'"}),null!=dimRoundingMode&&util.assert(util.isInt(pad),function(){return"Error in avgPool3d: pad must be an integer when using, dimRoundingMode "+dimRoundingMode+" but got pad "+pad+"."});var convInfo=conv_util.computePool3DInfo(x5D.shape,filterSize,strides,dilations,pad,dimRoundingMode,dataFormat),res=engine_1.ENGINE.runKernel(function(backend){return backend.avgPool3d(x5D,convInfo)},{x:x5D},function(dy){return{x:function(){return function(dy,input,filterSize,strides,dilations,pad,dimRoundingMode){var $dy=tensor_util_env_1.convertToTensor(dy,"dy","avgPool3dBackprop"),$input=tensor_util_env_1.convertToTensor(input,"input","avgPool3dBackprop"),dy5D=$dy,input5D=$input,reshapedTo5D=!1;4===$input.rank&&(reshapedTo5D=!0,dy5D=$dy.as5D(1,$dy.shape[0],$dy.shape[1],$dy.shape[2],$dy.shape[3]),input5D=$input.as5D(1,$input.shape[0],$input.shape[1],$input.shape[2],$input.shape[3]));util.assert(5===dy5D.rank,function(){return"Error in avgPool3dBackprop: dy must be rank 5 but got rank "+dy5D.rank+"."}),util.assert(5===input5D.rank,function(){return"Error in avgPool3dBackprop: input must be rank 5 but got rank "+input5D.rank+"."}),null==dilations&&(dilations=[1,1,1]);util.assert(conv_util.eitherStridesOrDilationsAreOne(strides,dilations),function(){return"Error in avgPool3dBackprop: Either strides or dilations must be 1. Got strides "+strides+" and dilations '"+dilations+"'"}),null!=dimRoundingMode&&util.assert(util.isInt(pad),function(){return"Error in maxPool3dBackprop: pad must be an integer when using, dimRoundingMode "+dimRoundingMode+" but got pad "+pad+"."});var convInfo=conv_util.computePool3DInfo(input5D.shape,filterSize,strides,dilations,pad,dimRoundingMode),res=engine_1.ENGINE.runKernel(function(backend){return backend.avgPool3dBackprop(dy5D,input5D,convInfo)},{dy5D:dy5D,input5D:input5D});if(reshapedTo5D)return res.as4D(res.shape[1],res.shape[2],res.shape[3],res.shape[4]);return res}(dy,x5D,filterSize,strides,dilations,pad,dimRoundingMode)}}});return res=res.cast(x5D.dtype),reshapedTo5D?res.as4D(res.shape[1],res.shape[2],res.shape[3],res.shape[4]):res}})},{"../engine":143,"../tensor_util_env":237,"../util":241,"./array_ops":163,"./conv_util":177,"./operation":195}],198:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var seedrandom=require("seedrandom"),MPRandGauss=function(){function MPRandGauss(mean,stdDeviation,dtype,truncated,seed){this.mean=mean,this.stdDev=stdDeviation,this.dtype=dtype,this.nextVal=NaN,this.truncated=truncated,this.truncated&&(this.upper=this.mean+2*this.stdDev,this.lower=this.mean-2*this.stdDev);var seedValue=seed||Math.random();this.random=seedrandom.alea(seedValue.toString())}return MPRandGauss.prototype.nextValue=function(){if(!isNaN(this.nextVal)){var value=this.nextVal;return this.nextVal=NaN,value}for(var resultX,resultY,isValid=!1;!isValid;){for(var v1=void 0,v2=void 0,s=void 0;1<=(s=(v1=2*this.random()-1)*v1+(v2=2*this.random()-1)*v2)||0===s;);var mul=Math.sqrt(-2*Math.log(s)/s);resultX=this.mean+this.stdDev*v1*mul,resultY=this.mean+this.stdDev*v2*mul,this.truncated&&!this.isValidTruncated(resultX)||(isValid=!0)}return this.truncated&&!this.isValidTruncated(resultY)||(this.nextVal=this.convertValue(resultY)),this.convertValue(resultX)},MPRandGauss.prototype.convertValue=function(value){return null==this.dtype||"float32"===this.dtype?value:Math.round(value)},MPRandGauss.prototype.isValidTruncated=function(value){return value<=this.upper&&value>=this.lower},MPRandGauss}();exports.MPRandGauss=MPRandGauss;var RandGamma=function(){function RandGamma(alpha,beta,dtype,seed){this.alpha=alpha,this.beta=1/beta,this.dtype=dtype;var seedValue=seed||Math.random();this.randu=seedrandom.alea(seedValue.toString()),this.randn=new MPRandGauss(0,1,dtype,!1,this.randu()),this.d=alpha<1?alpha+2/3:alpha-1/3,this.c=1/Math.sqrt(9*this.d)}return RandGamma.prototype.nextValue=function(){for(var x2,v0,v1,x,u,v;;){for(;x=this.randn.nextValue(),(v=1+this.c*x)<=0;);if(v*=v*v,v0=1-.331*(x2=x*x)*x2,v1=.5*x2+this.d*(1-v+Math.log(v)),(u=this.randu())<v0||Math.log(u)<v1)break}return v=1/this.beta*this.d*v,this.alpha<1&&(v*=Math.pow(this.randu(),1/this.alpha)),this.convertValue(v)},RandGamma.prototype.convertValue=function(value){return"float32"===this.dtype?value:Math.round(value)},RandGamma}();exports.RandGamma=RandGamma;var UniformRandom=function(){function UniformRandom(min,max,dtype,seed){void 0===min&&(min=0),void 0===max&&(max=1);var _this=this;if(this.canReturnFloat=function(){return null==_this.dtype||"float32"===_this.dtype},this.min=min,this.range=max-min,this.dtype=dtype,null==seed&&(seed=Math.random()),"number"==typeof seed&&(seed=seed.toString()),!this.canReturnFloat()&&this.range<=1)throw new Error("The difference between "+min+" - "+max+" <= 1 and dtype is not float");this.random=seedrandom.alea(seed)}return UniformRandom.prototype.convertValue=function(value){return this.canReturnFloat()?value:Math.round(value)},UniformRandom.prototype.nextValue=function(){return this.convertValue(this.min+this.range*this.random())},UniformRandom}();exports.UniformRandom=UniformRandom},{seedrandom:244}],199:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var util_1=require("../util");exports.PARALLELIZE_THRESHOLD=30,exports.computeOptimalWindowSize=function(inSize){return inSize<=exports.PARALLELIZE_THRESHOLD?inSize:util_1.nearestDivisor(inSize,Math.floor(Math.sqrt(inSize)))}},{"../util":241}],200:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var engine_1=require("../engine"),gradients_1=require("../gradients"),tensor_util_env_1=require("../tensor_util_env"),util=require("../util"),axis_util=require("./axis_util"),operation_1=require("./operation"),tensor_ops_1=require("./tensor_ops");function gradForMinAndMax(dy,y,xOrig,origAxes,permutedAxes){return y.rank<xOrig.rank&&(y=y.reshape(axis_util.expandShapeToKeepDim(y.shape,origAxes))),dy.rank<xOrig.rank&&(dy=dy.reshape(axis_util.expandShapeToKeepDim(dy.shape,origAxes))),{$x:function(){var dx=dy.mul(xOrig.equal(y).cast(dy.dtype));return null==permutedAxes?dx:dx.transpose(permutedAxes)}}}exports.all=operation_1.op({all_:function(x,axis,keepDims){void 0===axis&&(axis=null),void 0===keepDims&&(keepDims=!1);var $x=tensor_util_env_1.convertToTensor(x,"x","all","bool"),origAxes=util.parseAxisParam(axis,$x.shape),axes=origAxes,permutedAxes=axis_util.getAxesPermutation(axes,$x.rank);null!=permutedAxes&&($x=$x.transpose(permutedAxes),axes=axis_util.getInnerMostAxes(axes.length,$x.rank));var res=engine_1.ENGINE.runKernel(function(backend){return backend.all($x,axes)},{$x:$x});if(keepDims){var newShape=axis_util.expandShapeToKeepDim(res.shape,origAxes);return res.reshape(newShape)}return res}}),exports.any=operation_1.op({any_:function(x,axis,keepDims){void 0===axis&&(axis=null),void 0===keepDims&&(keepDims=!1);var $x=tensor_util_env_1.convertToTensor(x,"x","any","bool"),origAxes=util.parseAxisParam(axis,$x.shape),axes=origAxes,permutedAxes=axis_util.getAxesPermutation(axes,$x.rank);null!=permutedAxes&&($x=$x.transpose(permutedAxes),axes=axis_util.getInnerMostAxes(axes.length,$x.rank));var res=engine_1.ENGINE.runKernel(function(backend){return backend.any($x,axes)},{$x:$x});if(keepDims){var newShape=axis_util.expandShapeToKeepDim(res.shape,origAxes);return res.reshape(newShape)}return res}}),exports.argMax=operation_1.op({argMax_:function(x,axis){void 0===axis&&(axis=0);var $x=tensor_util_env_1.convertToTensor(x,"x","argMax");null==axis&&(axis=0);var axes=util.parseAxisParam(axis,$x.shape),permutedAxes=axis_util.getAxesPermutation(axes,$x.rank);return null!=permutedAxes&&($x=$x.transpose(permutedAxes),axes=axis_util.getInnerMostAxes(axes.length,$x.rank)),engine_1.ENGINE.runKernel(function(backend,save){var res=backend.argMax($x,axes[0]);return save([$x]),res},{$x:$x},function(dy,saved){var $x=saved[0];return{$x:function(){return tensor_ops_1.zerosLike($x)}}})}}),exports.argMin=operation_1.op({argMin_:function(x,axis){void 0===axis&&(axis=0);var $x=tensor_util_env_1.convertToTensor(x,"x","argMin");null==axis&&(axis=0);var axes=util.parseAxisParam(axis,$x.shape),permutedAxes=axis_util.getAxesPermutation(axes,$x.rank);return null!=permutedAxes&&($x=$x.transpose(permutedAxes),axes=axis_util.getInnerMostAxes(axes.length,$x.rank)),engine_1.ENGINE.runKernel(function(backend,save){var res=backend.argMin($x,axes[0]);return save([$x]),res},{$x:$x},function(dy,saved){var $x=saved[0];return{$x:function(){return tensor_ops_1.zerosLike($x)}}})}}),exports.logSumExp=operation_1.op({logSumExp_:function(x,axis,keepDims){void 0===axis&&(axis=null),void 0===keepDims&&(keepDims=!1);var $x=tensor_util_env_1.convertToTensor(x,"x","logSumExp"),axes=util.parseAxisParam(axis,$x.shape),xMax=$x.max(axes,!0),d=$x.sub(xMax).exp().sum(axes).log(),res=xMax.reshape(d.shape).add(d);if(keepDims){var newShape=axis_util.expandShapeToKeepDim(res.shape,axes);return res.reshape(newShape)}return res}}),exports.max=operation_1.op({max_:function(x,axis,keepDims){void 0===axis&&(axis=null),void 0===keepDims&&(keepDims=!1);var $x=tensor_util_env_1.convertToTensor(x,"x","max"),xOrig=$x,origAxes=util.parseAxisParam(axis,$x.shape),axes=origAxes,permutedAxes=axis_util.getAxesPermutation(axes,$x.rank);null!=permutedAxes&&($x=$x.transpose(permutedAxes),axes=axis_util.getInnerMostAxes(axes.length,$x.rank));var res=engine_1.ENGINE.runKernel(function(backend,save){var y=backend.max($x,axes);return save([xOrig,y]),y},{$x:$x},function(dy,saved){return gradForMinAndMax(dy,saved[1],saved[0],origAxes,permutedAxes)});if(keepDims){var newShape=axis_util.expandShapeToKeepDim(res.shape,origAxes);res=res.reshape(newShape)}return res}}),exports.mean=operation_1.op({mean_:function(x,axis,keepDims){void 0===axis&&(axis=null),void 0===keepDims&&(keepDims=!1);var $x=tensor_util_env_1.convertToTensor(x,"x","mean"),axes=util.parseAxisParam(axis,$x.shape),reduceShape=axis_util.computeOutAndReduceShapes($x.shape,axes)[1],reduceSize=util.sizeFromShape(reduceShape);return gradients_1.customGrad(function(x){var reduceSizeScalar=tensor_ops_1.scalar(reduceSize);return{value:(reduceSizeScalar.dtype===x.dtype?x:x.cast(reduceSizeScalar.dtype)).div(reduceSizeScalar).sum(axis,keepDims),gradFunc:function(dy){var expandedDyShape=x.shape.slice();return axes.forEach(function(axis){expandedDyShape[axis]=1}),dy.reshape(expandedDyShape).mul(tensor_ops_1.ones(x.shape,"float32")).div(reduceSize)}}})($x)}}),exports.min=operation_1.op({min_:function(x,axis,keepDims){void 0===axis&&(axis=null),void 0===keepDims&&(keepDims=!1);var $x=tensor_util_env_1.convertToTensor(x,"x","min"),xOrig=$x,origAxes=util.parseAxisParam(axis,$x.shape),axes=origAxes,permutedAxes=axis_util.getAxesPermutation(axes,$x.rank);null!=permutedAxes&&($x=$x.transpose(permutedAxes),axes=axis_util.getInnerMostAxes(axes.length,$x.rank));var res=engine_1.ENGINE.runKernel(function(backend,save){var y=backend.min($x,axes);return save([xOrig,y]),y},{$x:$x},function(dy,saved){return gradForMinAndMax(dy,saved[1],saved[0],origAxes,permutedAxes)});if(keepDims){var newShape=axis_util.expandShapeToKeepDim(res.shape,origAxes);res=res.reshape(newShape)}return res}}),exports.moments=operation_1.op({moments_:function(x,axis,keepDims){void 0===axis&&(axis=null),void 0===keepDims&&(keepDims=!1),x=tensor_util_env_1.convertToTensor(x,"x","moments");var axes=util.parseAxisParam(axis,x.shape),mean=x.mean(axes,keepDims),keepDimsShape=mean.shape;keepDims||(keepDimsShape=axis_util.expandShapeToKeepDim(mean.shape,axes));var devSquared=x.toFloat().sub(mean.reshape(keepDimsShape)).square();return{mean:mean,variance:devSquared.mean(axes,keepDims)}}}),exports.sum=operation_1.op({sum_:function(x,axis,keepDims){void 0===axis&&(axis=null),void 0===keepDims&&(keepDims=!1);var $x=tensor_util_env_1.convertToTensor(x,"x","sum");"bool"===$x.dtype&&($x=$x.toInt());var axes=util.parseAxisParam(axis,$x.shape);return gradients_1.customGrad(function(x){var permutation=axis_util.getAxesPermutation(axes,x.rank),reductionAxes=axes,permutedX=x;null!=permutation&&(permutedX=x.transpose(permutation),reductionAxes=axis_util.getInnerMostAxes(reductionAxes.length,x.rank));var value=engine_1.ENGINE.runKernel(function(backend){return backend.sum(permutedX,reductionAxes)},{permutedX:permutedX});if(keepDims){var newShape=axis_util.expandShapeToKeepDim(value.shape,axes);value=value.reshape(newShape)}return{value:value,gradFunc:function(dy){var expandedDyShape=x.shape.slice();return axes.forEach(function(axis){expandedDyShape[axis]=1}),dy.reshape(expandedDyShape).mul(tensor_ops_1.ones(x.shape,"float32"))}}})($x)}}),exports.prod=operation_1.op({prod_:function(x,axis,keepDims){void 0===axis&&(axis=null),void 0===keepDims&&(keepDims=!1);var $x=tensor_util_env_1.convertToTensor(x,"x","prod");"bool"===$x.dtype&&($x=$x.toInt());var axes=util.parseAxisParam(axis,$x.shape),permutation=axis_util.getAxesPermutation(axes,$x.rank),reductionAxes=axes,permutedX=$x;null!=permutation&&(permutedX=$x.transpose(permutation),reductionAxes=axis_util.getInnerMostAxes(reductionAxes.length,$x.rank));var value=engine_1.ENGINE.runKernel(function(backend){return backend.prod(permutedX,reductionAxes)},{permutedX:permutedX});if(keepDims){var newShape=axis_util.expandShapeToKeepDim(value.shape,axes);value=value.reshape(newShape)}return value}})},{"../engine":143,"../gradients":147,"../tensor_util_env":237,"../util":241,"./axis_util":165,"./operation":195,"./tensor_ops":216}],201:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var engine_1=require("../engine"),tensor_util_env_1=require("../tensor_util_env"),binary_ops_1=require("./binary_ops"),broadcast_util_1=require("./broadcast_util"),logical_ops_1=require("./logical_ops"),operation_1=require("./operation"),selu_util_1=require("./selu_util"),tensor_ops_1=require("./tensor_ops");exports.elu=operation_1.op({elu_:function(x){var $x=tensor_util_env_1.convertToTensor(x,"x","elu");return engine_1.ENGINE.runKernel(function(backend,save){var y=backend.elu($x);return save([y]),y},{$x:$x},function(dy,saved){var y=saved[0];return{$x:function(){return engine_1.ENGINE.runKernel(function(backend){return backend.eluDer(dy,y)},{dy:dy,y:y})}}})}}),exports.leakyRelu=operation_1.op({leakyRelu_:function(x,alpha){void 0===alpha&&(alpha=.2);var $x=tensor_util_env_1.convertToTensor(x,"x","leakyRelu");return binary_ops_1.maximum(tensor_ops_1.scalar(alpha).mul($x),$x)}}),exports.prelu=operation_1.op({prelu_:function(x,alpha){var $x=tensor_util_env_1.convertToTensor(x,"x","prelu"),$alpha=tensor_util_env_1.convertToTensor(alpha,"alpha","prelu");return engine_1.ENGINE.runKernel(function(backend,save){var res=backend.prelu($x,$alpha);return save([$x,$alpha]),res},{$x:$x,$alpha:$alpha},function(dy,saved){var $x=saved[0],$alpha=saved[1],mask=$x.greater(0);return{$x:function(){return logical_ops_1.where(mask,dy,dy.mul($alpha))},$alpha:function(){var res=logical_ops_1.where(mask,tensor_ops_1.zerosLike(dy),dy.mul($x)),reduceAxes=broadcast_util_1.getReductionAxes($alpha.shape,dy.shape);return 0<reduceAxes.length&&(res=res.sum(reduceAxes)),res.reshape($alpha.shape)}}})}}),exports.relu=operation_1.op({relu_:function(x){var $x=tensor_util_env_1.convertToTensor(x,"x","relu");return"bool"===$x.dtype?$x.toInt():engine_1.ENGINE.runKernel(function(backend,save){var res=backend.relu($x);return save([$x]),res},{$x:$x},function(dy,saved){var $x=saved[0];return{$x:function(){return dy.mulStrict($x.step().toFloat())}}})}}),exports.selu=operation_1.op({selu_:function(x){var $x=tensor_util_env_1.convertToTensor(x,"x","selu");return engine_1.ENGINE.runKernel(function(backend,save){var res=backend.selu($x);return save([$x]),res},{$x:$x},function(dy,saved){var $x=saved[0];return{$x:function(){var mask=$x.greater(tensor_ops_1.scalar(0)),scaleAlpha=tensor_ops_1.scalar(selu_util_1.SELU_SCALEALPHA),scale=tensor_ops_1.scalar(selu_util_1.SELU_SCALE),greaterThanZeroDer=dy.mul(scale),lessEqualZeroDer=dy.mul(scaleAlpha).mul($x.toFloat().exp());return logical_ops_1.where(mask,greaterThanZeroDer,lessEqualZeroDer)}}})}})},{"../engine":143,"../tensor_util_env":237,"./binary_ops":167,"./broadcast_util":169,"./logical_ops":188,"./operation":195,"./selu_util":207,"./tensor_ops":216}],202:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var engine_1=require("../engine"),tensor_util_env_1=require("../tensor_util_env"),util=require("../util"),operation_1=require("./operation");exports.reverse=operation_1.op({reverse_:function(x,axis){var $x=tensor_util_env_1.convertToTensor(x,"x","reverse");if(0===$x.rank)return $x.clone();var axes=util.parseAxisParam(axis,$x.shape);return engine_1.ENGINE.runKernel(function(backend){return backend.reverse($x,axes)},{$x:$x},function(dy){return{$x:function(){return dy.reverse(axes)}}}).reshapeAs($x)}}),exports.reverse1d=operation_1.op({reverse1d_:function(x){var $x=tensor_util_env_1.convertToTensor(x,"x","reverse");return util.assert(1===$x.rank,function(){return"Error in reverse1D: x must be rank 1 but got rank "+$x.rank+"."}),exports.reverse($x,0)}}),exports.reverse2d=operation_1.op({reverse2d_:function(x,axis){var $x=tensor_util_env_1.convertToTensor(x,"x","reverse");return util.assert(2===$x.rank,function(){return"Error in reverse2D: x must be rank 2 but got rank "+$x.rank+"."}),exports.reverse($x,axis)}}),exports.reverse3d=operation_1.op({reverse3d_:function(x,axis){var $x=tensor_util_env_1.convertToTensor(x,"x","reverse");return util.assert(3===$x.rank,function(){return"Error in reverse3D: x must be rank 3 but got rank "+$x.rank+"."}),exports.reverse($x,axis)}}),exports.reverse4d=operation_1.op({reverse4d_:function(x,axis){var $x=tensor_util_env_1.convertToTensor(x,"x","reverse");return util.assert(4===$x.rank,function(){return"Error in reverse4D: x must be rank 4 but got rank "+$x.rank+"."}),exports.reverse($x,axis)}})},{"../engine":143,"../tensor_util_env":237,"../util":241,"./operation":195}],203:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var engine_1=require("../engine"),tensor_util_env_1=require("../tensor_util_env"),operation_1=require("./operation"),scatter_nd_util=require("./scatter_nd_util");exports.scatterND=operation_1.op({scatterND_:function(indices,updates,shape){var $indices=tensor_util_env_1.convertToTensor(indices,"indices","scatterND","int32"),$updates=tensor_util_env_1.convertToTensor(updates,"updates","scatterND");return scatter_nd_util.validateInput($updates,$indices,shape),engine_1.ENGINE.runKernel(function(backend){return backend.scatterND($indices,$updates,shape)},{$indices:$indices,$updates:$updates})}})},{"../engine":143,"../tensor_util_env":237,"./operation":195,"./scatter_nd_util":204}],204:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var util_1=require("../util");function validateUpdateShape(shape,indices,updates){var sliceDim=1<indices.rank?indices.shape[indices.rank-1]:1,batchDim=1<indices.rank?indices.rank-1:1,shapeError="Must have updates.shape = indices.shape[:batchDim] + shape[sliceDim:], got updates.shape: "+updates.shape+", indices.shape: "+indices.shape+", shape: "+shape+", sliceDim: "+sliceDim+", and batchDim: "+batchDim+".";if(updates.rank<batchDim)throw new Error(shapeError+" update.rank < "+batchDim+". ");if(shape.length<sliceDim+(updates.rank-batchDim))throw new Error(shapeError+" Output shape length < "+(sliceDim+(updates.rank-batchDim)));if(updates.rank!==batchDim+shape.length-sliceDim)throw new Error(shapeError+" update.rank != "+(batchDim+shape.length-sliceDim));for(var d=0;d<batchDim;++d)if(updates.shape[d]!==indices.shape[d])throw new Error(shapeError+" updates.shape["+d+"] ("+updates.shape[d]+") != indices.shape["+d+"] ("+indices.shape[d]+").");for(d=0;d<updates.rank-batchDim;++d)if(updates.shape[d+batchDim]!==shape[d+sliceDim])throw new Error(shapeError+" updates.shape["+(d+batchDim)+"] ("+updates.shape[d+batchDim]+") != shape["+(d+batchDim)+"] ("+shape[d+batchDim]+")")}exports.validateUpdateShape=validateUpdateShape,exports.validateInput=function(updates,indices,shape){if(indices.rank<1)throw new Error("tf.scatterND() expects the indices to be rank 1 or higher, but the rank was "+indices.rank+".");if(updates.rank<1)throw new Error("tf.scatterND() expects the updates to be rank 1 or higher, but the rank was "+updates.rank+".");if("int32"!==indices.dtype)throw new Error("The dtype of 'indices' should be int32, but got dtype: "+indices.dtype);if(shape.length<1)throw new Error("Output rank must be greater or equal to 1, but got shape: "+shape);if(0===shape.length){if(0===indices.size)throw new Error("Indices specified for empty output. indices shape: "+indices.shape);if(0===updates.size)throw new Error("Updates specified for empty output. updates shape: "+updates.shape)}validateUpdateShape(shape,indices,updates)},exports.calculateShapes=function(updates,indices,shape){for(var sliceRank=1<indices.rank?indices.shape[indices.rank-1]:1,totalNd=shape.length,sliceSize=1,i=sliceRank;i<totalNd;++i)sliceSize*=shape[i];var safeSliceDim=sliceRank<1?1:sliceRank;return{sliceRank:sliceRank,numUpdates:indices.size/safeSliceDim,sliceSize:sliceSize,strides:util_1.computeStrides(shape.slice(0,sliceRank)).concat([1]),outputSize:util_1.sizeFromShape(shape)}}},{"../util":241}],205:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var engine_1=require("../engine"),tensor_util_env_1=require("../tensor_util_env"),util_1=require("../util"),array_ops_1=require("./array_ops"),axis_util_1=require("./axis_util"),binary_ops_1=require("./binary_ops"),compare_1=require("./compare"),logical_ops_1=require("./logical_ops"),operation_1=require("./operation"),segment_util_1=require("./segment_util"),tensor_ops_1=require("./tensor_ops");function arrayRange(start,stop){for(var result=[],i=start;i<stop;++i)result.push(i);return result}function arrayConcat(arrays){for(var result=[],i=0;i<arrays.length;++i)for(var j=0;j<arrays[i].length;++j)result.push(arrays[i][j]);return result}exports.gather=operation_1.op({gather_:function(x,indices,axis){void 0===axis&&(axis=0);var $x=tensor_util_env_1.convertToTensor(x,"x","gather"),$indices=tensor_util_env_1.convertToTensor(indices,"indices","gather","int32");axis=util_1.parseAxisParam(axis,$x.shape)[0];var shapeInfo=segment_util_1.collectGatherOpShapeInfo($x,$indices,axis);return engine_1.ENGINE.runKernel(function(backend,save){var res=backend.gather($x,$indices.flatten(),axis);return save([$indices]),res},{$x:$x},function(dy,saved){var $indices=saved[0];return{$x:function(){var paramsShape=$x.shape,indicesSize=$indices.size,outerShape=paramsShape.slice(0,axis),outerDims=outerShape.length,innerShape=paramsShape.slice(axis,paramsShape.length).slice(1),innerDims=innerShape.length,outerAxesIndices=arrayRange(0,outerDims),innerAxesIndices=arrayRange(outerDims+1,outerDims+1+innerDims),valuesShape=arrayConcat([outerShape,[indicesSize],innerShape]),values=dy.reshape(valuesShape),reshapedIndices=$indices.reshape([indicesSize]),transposeDims=arrayConcat([[outerDims],outerAxesIndices,innerAxesIndices]),valuesTranspose=values.transpose(transposeDims),paramsGrad=exports.unsortedSegmentSum(valuesTranspose,reshapedIndices,$x.shape[axis]),invertTransposeDims=axis_util_1.getUndoAxesPermutation(transposeDims);return paramsGrad=paramsGrad.transpose(invertTransposeDims)}}}).reshape(shapeInfo.outputShape)}}),exports.unsortedSegmentSum=operation_1.op({unsortedSegmentSum_:function(x,segmentIds,numSegments){var $x=tensor_util_env_1.convertToTensor(x,"x","unsortedSegmentSum"),$segmentIds=tensor_util_env_1.convertToTensor(segmentIds,"segmentIds","unsortedSegmentSum","int32");return util_1.assert(util_1.isInt(numSegments),function(){return"numSegments must be of dtype int"}),engine_1.ENGINE.runKernel(function(backend,save){var res=backend.unsortedSegmentSum($x,$segmentIds,numSegments);return save([$segmentIds]),res},{$x:$x},function(dy,saved){var $segmentIds=saved[0];return{$x:function(){return function(x,indices){for(var zeroClippedIndices=binary_ops_1.maximum(indices,tensor_ops_1.zerosLike(indices)),gathered=exports.gather(x,zeroClippedIndices),isPositive=compare_1.greaterEqual(indices,tensor_ops_1.scalar(0,"int32")),numIters=gathered.rank-isPositive.rank,i=0;i<numIters;++i)isPositive=array_ops_1.expandDims(isPositive,i+1);isPositive=logical_ops_1.logicalAnd(isPositive,tensor_ops_1.ones(gathered.shape,"bool"));var zeroSlice=tensor_ops_1.zerosLike(gathered);return logical_ops_1.where(isPositive,gathered,zeroSlice)}(dy,$segmentIds)}}})}})},{"../engine":143,"../tensor_util_env":237,"../util":241,"./array_ops":163,"./axis_util":165,"./binary_ops":167,"./compare":171,"./logical_ops":188,"./operation":195,"./segment_util":206,"./tensor_ops":216}],206:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var util_1=require("../util"),reduce_util_1=require("./reduce_util");exports.segOpComputeOptimalWindowSize=function(inSize,numSegments){var res,done=!1;for(inSize<=reduce_util_1.PARALLELIZE_THRESHOLD?(res=inSize,done=!0):res=util_1.nearestDivisor(inSize,Math.floor(Math.sqrt(inSize)));!done;)numSegments<res||res===inSize?done=!0:res=util_1.nearestDivisor(inSize,res+1);return res},exports.computeOutShape=function(aShape,axis,numSegments){for(var outShape=[],rank=aShape.length,dim=0;dim<rank;dim++)dim!==axis?outShape.push(aShape[dim]):outShape.push(numSegments);return outShape},exports.collectGatherOpShapeInfo=function(x,indices,axis){for(var dimSize=x.shape[axis],outputShape=[],batchSize=1,sliceSize=1,i=0;i<axis;i++)outputShape.push(x.shape[i]),batchSize*=x.shape[i];for(i=0;i<indices.rank;i++)outputShape.push(indices.shape[i]);for(i=axis+1;i<x.rank;i++)outputShape.push(x.shape[i]),sliceSize*=x.shape[i];return{batchSize:batchSize,sliceSize:sliceSize,dimSize:dimSize,outputShape:outputShape}}},{"../util":241,"./reduce_util":199}],207:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.SELU_SCALEALPHA=1.7580993408473768,exports.SELU_SCALE=1.0507009873554805},{}],208:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var operation_1=require("../ops/operation"),binary_ops_1=require("./binary_ops"),concat_split_1=require("./concat_split"),slice_1=require("./slice"),spectral_ops_1=require("./spectral_ops"),tensor_ops_1=require("./tensor_ops");function cosineWindow(windowLength,a,b){for(var even=1-windowLength%2,newValues=new Float32Array(windowLength),i=0;i<windowLength;++i){var cosArg=2*Math.PI*i/(windowLength+even-1);newValues[i]=a-b*Math.cos(cosArg)}return tensor_ops_1.tensor1d(newValues,"float32")}exports.hannWindow=operation_1.op({hannWindow_:function(windowLength){return cosineWindow(windowLength,.5,.5)}}),exports.hammingWindow=operation_1.op({hammingWindow_:function(windowLength){return cosineWindow(windowLength,.54,.46)}}),exports.frame=operation_1.op({frame_:function(signal,frameLength,frameStep,padEnd,padValue){void 0===padEnd&&(padEnd=!1),void 0===padValue&&(padValue=0);for(var start=0,output=[];start+frameLength<=signal.size;)output.push(slice_1.slice(signal,start,frameLength)),start+=frameStep;if(padEnd){var padLen=start+frameLength-signal.size,pad=concat_split_1.concat([slice_1.slice(signal,start,frameLength-padLen),tensor_ops_1.fill([padLen],padValue)]);output.push(pad)}return 0===output.length?tensor_ops_1.tensor2d([],[0,frameLength]):concat_split_1.concat(output).as2D(output.length,frameLength)}}),exports.stft=operation_1.op({stft_:function(signal,frameLength,frameStep,fftLength,windowFn){void 0===windowFn&&(windowFn=exports.hannWindow),null==fftLength&&(fftLength=function(value){return Math.floor(Math.pow(2,Math.ceil(Math.log(value)/Math.log(2))))}(frameLength));for(var framedSignal=exports.frame(signal,frameLength,frameStep),windowedSignal=binary_ops_1.mul(framedSignal,windowFn(frameLength)),output=[],i=0;i<framedSignal.shape[0];i++)output.push(spectral_ops_1.rfft(windowedSignal.slice([i,0],[1,frameLength]),fftLength));return concat_split_1.concat(output)}})},{"../ops/operation":195,"./binary_ops":167,"./concat_split":173,"./slice":209,"./spectral_ops":214,"./tensor_ops":216}],209:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var engine_1=require("../engine"),tensor_util_env_1=require("../tensor_util_env"),util=require("../util"),operation_1=require("./operation"),slice_util=require("./slice_util");exports.slice=operation_1.op({slice_:function(x,begin,size){var begin_,size_,$x=tensor_util_env_1.convertToTensor(x,"x","slice");if(0===$x.rank)throw new Error("Slicing scalar is not possible");begin_="number"==typeof begin?[begin].concat(new Array($x.rank-1).fill(0)):begin.length<$x.rank?begin.concat(new Array($x.rank-begin.length).fill(0)):begin.slice(),size_=(size_=null==size?new Array($x.rank).fill(-1):"number"==typeof size?[size].concat(new Array($x.rank-1).fill(-1)):size.length<$x.rank?size.concat(new Array($x.rank-size.length).fill(-1)):size).map(function(d,i){return 0<=d?d:(util.assert(-1===d,function(){return"Bad value in size"}),$x.shape[i]-begin_[i])}),slice_util.assertParamsValid($x,begin_,size_);var inputShape=$x.shape;return engine_1.ENGINE.runKernel(function(backend){return backend.slice($x,begin_,size_)},{$x:$x},function(dy){for(var paddings=[],i=0;i<dy.rank;i++)paddings.push([begin_[i],inputShape[i]-begin_[i]-size_[i]]);return{$x:function(){return dy.pad(paddings)}}})}}),exports.slice1d=operation_1.op({slice1d_:function(x,begin,size){var $x=tensor_util_env_1.convertToTensor(x,"x","slice1d");return util.assert(1===$x.rank,function(){return"slice1d expects a rank-1 tensor, but got a rank-"+$x.rank+" tensor"}),exports.slice($x,[begin],[size])}}),exports.slice2d=operation_1.op({slice2d_:function(x,begin,size){var $x=tensor_util_env_1.convertToTensor(x,"x","slice2d");return util.assert(2===$x.rank,function(){return"slice2d expects a rank-2 tensor, but got a rank-"+$x.rank+" tensor"}),exports.slice($x,begin,size)}}),exports.slice3d=operation_1.op({slice3d_:function(x,begin,size){var $x=tensor_util_env_1.convertToTensor(x,"x","slice3d");return util.assert(3===$x.rank,function(){return"slice3d expects a rank-3 tensor, but got a rank-"+$x.rank+" tensor"}),exports.slice($x,begin,size)}}),exports.slice4d=operation_1.op({slice4d_:function(x,begin,size){var $x=tensor_util_env_1.convertToTensor(x,"x","slice4d");return util.assert(4===$x.rank,function(){return"slice4d expects a rank-4 tensor, but got a rank-"+$x.rank+" tensor"}),exports.slice($x,begin,size)}})},{"../engine":143,"../tensor_util_env":237,"../util":241,"./operation":195,"./slice_util":210}],210:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var util=require("../util");function startForAxis(beginMask,startIndices,strides,inputShape,axis){var start=startIndices[axis],stride=strides[axis]||1;(beginMask&1<<axis||null==start)&&(start=0<stride?Number.MIN_SAFE_INTEGER:Number.MAX_SAFE_INTEGER);var axisSize=inputShape[axis];return start<0&&(start+=axisSize),start=util.clamp(0,start,axisSize-1)}function stopForAxis(endMask,stopIndices,strides,inputShape,axis){var stop=stopIndices[axis],stride=strides[axis]||1;(endMask&1<<axis||null==stop)&&(stop=0<stride?Number.MAX_SAFE_INTEGER:Number.MIN_SAFE_INTEGER);var axisSize=inputShape[axis];return stop<0&&(stop+=axisSize),stop=0<stride?util.clamp(0,stop,axisSize):util.clamp(-1,stop,axisSize-1)}exports.assertParamsValid=function(input,begin,size){util.assert(input.rank===begin.length,function(){return"Error in slice"+input.rank+"D: Length of begin "+begin+" must match the rank of the array ("+input.rank+")."}),util.assert(input.rank===size.length,function(){return"Error in slice"+input.rank+"D: Length of size "+size+" must match the rank of the array ("+input.rank+")."});for(var _loop_1=function(i){util.assert(begin[i]+size[i]<=input.shape[i],function(){return"Error in slice"+input.rank+"D: begin["+i+"] + size["+i+"] ("+(begin[i]+size[i])+") would overflow input.shape["+i+"] ("+input.shape[i]+")"})},i=0;i<input.rank;++i)_loop_1(i)},exports.getStridedSlicedInfo=function(shape,begin,end,strides,beginMask,endMask,ellipsisMask,newAxisMask,shrinkAxisMask){if(void 0===beginMask&&(beginMask=0),void 0===endMask&&(endMask=0),void 0===ellipsisMask&&(ellipsisMask=0),void 0===newAxisMask&&(newAxisMask=0),void 0===shrinkAxisMask&&(shrinkAxisMask=0),0!==ellipsisMask)throw new Error("ellipsis mask is not yet supported");if(0!==newAxisMask)throw new Error("new axis mask is not yet supported");for(var startIndex=[],endIndex=[],shrinkAxis=[],i=0;i<shape.length;i++)startIndex[i]=startForAxis(beginMask,begin,strides,shape,i),endIndex[i]=stopForAxis(endMask,end,strides,shape,i),shrinkAxisMask&1<<i&&(endIndex[i]=startIndex[i]+1,shrinkAxis.push(i));var size=new Array(shape.length).fill(0);return size=size.map(function(d,i){for(var count=0,stride=strides[i]||1,start=startIndex[i];!(0<stride?start>=endIndex[i]:start<=endIndex[i]);start+=stride)count+=1;return count}),[startIndex,size,shrinkAxis]},exports.startForAxis=startForAxis,exports.stopForAxis=stopForAxis,exports.isSliceContinous=function(shape,begin,size){for(var firstNonOneAxis=size.length,i=0;i<size.length;i++)if(1<size[i]){firstNonOneAxis=i;break}for(i=firstNonOneAxis+1;i<size.length;i++)if(0<begin[i]||size[i]!==shape[i])return!1;return!0},exports.computeFlatOffset=function(begin,strides){for(var flatOffset=0<begin.length?begin[begin.length-1]:1,i=0;i<begin.length-1;i++)flatOffset+=begin[i]*strides[i];return flatOffset}},{"../util":241}],211:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var gradients_1=require("../gradients"),tensor_util_env_1=require("../tensor_util_env"),operation_1=require("./operation");exports.softmax=operation_1.op({softmax_:function(logits,dim){void 0===dim&&(dim=-1);var $logits=tensor_util_env_1.convertToTensor(logits,"logits","softmax");if(-1===dim&&(dim=$logits.rank-1),dim!==$logits.rank-1)throw Error("Softmax along a non-last dimension is not yet supported. Logits was rank "+$logits.rank+" and dim was "+dim);return gradients_1.customGrad(function(logits,save){var lse=logits.logSumExp([dim],!0),y=logits.toFloat().sub(lse).exp();save([y]);return{value:y,gradFunc:function(dy,saved){var y=saved[0],dyTimesY=dy.mul(y);return dyTimesY.sub(dyTimesY.sum([dim],!0).mul(y))}}})($logits)}}),exports.logSoftmax=operation_1.op({logSoftmax_:function(logits,axis){void 0===axis&&(axis=-1);var $logits=tensor_util_env_1.convertToTensor(logits,"logits","logSoftmax");if(-1===axis&&(axis=$logits.rank-1),axis!==$logits.rank-1)throw Error("Log Softmax along a non-last dimension is not yet supported. Logits was rank "+$logits.rank+" and axis was "+axis);return gradients_1.customGrad(function(logits,save){var xMax=logits.max(axis,!0),shifted=logits.sub(xMax),value=shifted.toFloat().sub(shifted.exp().sum(axis,!0).log());save([value]);return{value:value,gradFunc:function(dy,saved){var softmax=saved[0].exp();return dy.sub(dy.sum(axis,!0).mul(softmax))}}})($logits)}})},{"../gradients":147,"../tensor_util_env":237,"./operation":195}],212:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var engine_1=require("../engine"),sparse_to_dense=require("../ops/sparse_to_dense_util"),tensor_util_env_1=require("../tensor_util_env"),operation_1=require("./operation");exports.sparseToDense=operation_1.op({sparseToDense_:function(sparseIndices,sparseValues,outputShape,defaultValue){void 0===defaultValue&&(defaultValue=0);var $sparseIndices=tensor_util_env_1.convertToTensor(sparseIndices,"sparseIndices","sparseToDense","int32"),$sparseValues=tensor_util_env_1.convertToTensor(sparseValues,"sparseValues","sparseToDense"),$defaultValue=tensor_util_env_1.convertToTensor(defaultValue,"defaultValue","sparseToDense",$sparseValues.dtype);return sparse_to_dense.validateInput($sparseIndices,$sparseValues,outputShape,$defaultValue),engine_1.ENGINE.runKernel(function(backend){return backend.sparseToDense($sparseIndices,$sparseValues,outputShape,$defaultValue)},{$sparseIndices:$sparseIndices,$sparseValues:$sparseValues,$defaultValue:$defaultValue})}})},{"../engine":143,"../ops/sparse_to_dense_util":213,"../tensor_util_env":237,"./operation":195}],213:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.validateInput=function(sparseIndices,sparseValues,outputShape,defaultValues){if("int32"!==sparseIndices.dtype)throw new Error("tf.sparseToDense() expects the indices to be int32 type, but the dtype was "+sparseIndices.dtype+".");if(2<sparseIndices.rank)throw new Error("sparseIndices should be a scalar, vector, or matrix, but got shape "+sparseIndices.shape+".");var numElems=0<sparseIndices.rank?sparseIndices.shape[0]:1,numDims=1<sparseIndices.rank?sparseIndices.shape[1]:1;if(outputShape.length!==numDims)throw new Error("outputShape has incorrect number of elements:, "+outputShape.length+", should be: "+numDims+".");var numValues=sparseValues.size;if(0!==sparseValues.rank&&(1!==sparseValues.rank||numValues!==numElems))throw new Error("sparseValues has incorrect shape "+sparseValues.shape+", should be [] or ["+numElems+"]");if(sparseValues.dtype!==defaultValues.dtype)throw new Error("sparseValues.dtype must match defaultValues.dtype")}},{}],214:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var engine_1=require("../engine"),complex_ops_1=require("../ops/complex_ops"),operation_1=require("../ops/operation"),util_1=require("../util"),tensor_ops_1=require("./tensor_ops");exports.fft=operation_1.op({fft_:function(input){util_1.assert("complex64"===input.dtype,function(){return"The dtype for tf.spectral.fft() must be complex64 but got "+input.dtype+"."});var innerDimensionSize=input.shape[input.shape.length-1],batch=input.size/innerDimensionSize,input2D=input.as2D(batch,innerDimensionSize);return engine_1.ENGINE.runKernel(function(backend){return backend.fft(input2D)},{input:input}).reshape(input.shape)}}),exports.ifft=operation_1.op({ifft_:function(input){util_1.assert("complex64"===input.dtype,function(){return"The dtype for tf.spectral.ifft() must be complex64 but got "+input.dtype+"."});var innerDimensionSize=input.shape[input.shape.length-1],batch=input.size/innerDimensionSize,input2D=input.as2D(batch,innerDimensionSize);return engine_1.ENGINE.runKernel(function(backend){return backend.ifft(input2D)},{input:input}).reshape(input.shape)}}),exports.rfft=operation_1.op({rfft_:function(input,fftLength){util_1.assert("float32"===input.dtype,function(){return"The dtype for rfft() must be real value but got "+input.dtype});var adjustedInput,innerDimensionSize=input.shape[input.shape.length-1],batch=input.size/innerDimensionSize;if(null!=fftLength&&fftLength<innerDimensionSize){var begin=input.shape.map(function(v){return 0}),size=input.shape.map(function(v){return v});size[input.shape.length-1]=fftLength,adjustedInput=input.slice(begin,size),innerDimensionSize=fftLength}else if(null!=fftLength&&innerDimensionSize<fftLength){var zerosShape=input.shape.map(function(v){return v});zerosShape[input.shape.length-1]=fftLength-innerDimensionSize,adjustedInput=input.concat(tensor_ops_1.zeros(zerosShape),input.shape.length-1),innerDimensionSize=fftLength}else adjustedInput=input;var zerosInput=adjustedInput.zerosLike(),complexInput=complex_ops_1.complex(adjustedInput,zerosInput).as2D(batch,innerDimensionSize),ret=exports.fft(complexInput),half=Math.floor(innerDimensionSize/2)+1,realValues=complex_ops_1.real(ret),imagValues=complex_ops_1.imag(ret),realComplexConjugate=realValues.split([half,innerDimensionSize-half],realValues.shape.length-1),imagComplexConjugate=imagValues.split([half,innerDimensionSize-half],imagValues.shape.length-1),outputShape=adjustedInput.shape.slice();return outputShape[adjustedInput.shape.length-1]=half,complex_ops_1.complex(realComplexConjugate[0],imagComplexConjugate[0]).reshape(outputShape)}}),exports.irfft=operation_1.op({irfft_:function(input){var innerDimensionSize=input.shape[input.shape.length-1],batch=input.size/innerDimensionSize;if(innerDimensionSize<=2){var complexInput=input.as2D(batch,innerDimensionSize),ret=exports.ifft(complexInput);return complex_ops_1.real(ret)}var outputShape=[batch,2*(innerDimensionSize-1)],realInput=complex_ops_1.real(input).as2D(batch,innerDimensionSize),imagInput=complex_ops_1.imag(input).as2D(batch,innerDimensionSize),realConjugate=realInput.slice([0,1],[batch,innerDimensionSize-2]).reverse(1),imagConjugate=imagInput.slice([0,1],[batch,innerDimensionSize-2]).reverse(1).mul(tensor_ops_1.scalar(-1)),r=realInput.concat(realConjugate,1),i=imagInput.concat(imagConjugate,1);return complexInput=complex_ops_1.complex(r,i).as2D(outputShape[0],outputShape[1]),ret=exports.ifft(complexInput),complex_ops_1.real(ret)}})},{"../engine":143,"../ops/complex_ops":172,"../ops/operation":195,"../util":241,"./tensor_ops":216}],215:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var engine_1=require("../engine"),tensor_util_env_1=require("../tensor_util_env"),operation_1=require("./operation"),slice_1=require("./slice"),slice_util_1=require("./slice_util");exports.stridedSlice=operation_1.op({stridedSlice_:function(x,begin,end,strides,beginMask,endMask,ellipsisMask,newAxisMask,shrinkAxisMask){if(void 0===beginMask&&(beginMask=0),void 0===endMask&&(endMask=0),void 0===ellipsisMask&&(ellipsisMask=0),void 0===newAxisMask&&(newAxisMask=0),void 0===shrinkAxisMask&&(shrinkAxisMask=0),0!==ellipsisMask)throw new Error("ellipsis mask is not yet supported");if(0!==newAxisMask)throw new Error("new axis mask is not yet supported");var $x=tensor_util_env_1.convertToTensor(x,"x","stridedSlice");if(strides.every(function(v){return 1===v})){var _a=slice_util_1.getStridedSlicedInfo($x.shape,begin,end,strides,beginMask,endMask,ellipsisMask,newAxisMask,shrinkAxisMask),beginIndex=_a[0],size=_a[1],shrinkAxis_1=_a[2],outShape=size.filter(function(_,index){return-1===shrinkAxis_1.indexOf(index)});return slice_1.slice($x,beginIndex,size).reshape(outShape)}return engine_1.ENGINE.runKernel(function(backend){return backend.stridedSlice($x,begin,end,strides,beginMask,endMask,ellipsisMask,newAxisMask,shrinkAxisMask)},{$x:$x})}})},{"../engine":143,"../tensor_util_env":237,"./operation":195,"./slice":209,"./slice_util":210}],216:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var engine_1=require("../engine"),environment_1=require("../environment"),tensor_1=require("../tensor"),tensor_util_env_1=require("../tensor_util_env"),util_1=require("../util"),complex_ops_1=require("./complex_ops"),operation_1=require("./operation");function makeTensor(values,shape,inferredShape,dtype){if(null==dtype&&(dtype=util_1.inferDtype(values)),"complex64"===dtype)throw new Error("Cannot construct a complex64 tensor directly. Please use tf.complex(real, imag).");if(!util_1.isTypedArray(values)&&!Array.isArray(values)&&"number"!=typeof values&&"boolean"!=typeof values&&"string"!=typeof values)throw new Error("values passed to tensor(values) must be a number/boolean/string or an array of numbers/booleans/strings, or a TypedArray");if(null!=shape){util_1.assertNonNegativeIntegerDimensions(shape);var providedSize_1=util_1.sizeFromShape(shape),inferredSize_1=util_1.sizeFromShape(inferredShape);util_1.assert(providedSize_1===inferredSize_1,function(){return"Based on the provided shape, ["+shape+"], the tensor should have "+providedSize_1+" values but has "+inferredSize_1});for(var i=0;i<inferredShape.length;++i){var inferred=inferredShape[i],flatDimsDontMatch=i!==inferredShape.length-1||inferred!==util_1.sizeFromShape(shape.slice(i));util_1.assert(inferredShape[i]===shape[i]||!flatDimsDontMatch,function(){return"Error creating a new Tensor. Inferred shape ("+inferredShape+") does not match the provided shape ("+shape+"). "})}}return util_1.isTypedArray(values)||Array.isArray(values)||(values=[values]),shape=shape||inferredShape,values="string"!==dtype?util_1.toTypedArray(values,dtype,environment_1.ENV.getBool("DEBUG")):util_1.flatten(values,[],!0),tensor_1.Tensor.make(shape,{values:values},dtype)}function tensor1d(values,dtype){util_1.assertNonNull(values);var inferredShape=tensor_util_env_1.inferShape(values,dtype);if(1!==inferredShape.length)throw new Error("tensor1d() requires values to be a flat/TypedArray");return makeTensor(values,null,inferredShape,dtype)}function zeros(shape,dtype){if(void 0===dtype&&(dtype="float32"),"complex64"===dtype){var real_2=zeros(shape,"float32"),imag_2=zeros(shape,"float32");return complex_ops_1.complex(real_2,imag_2)}var values=util_1.makeZerosTypedArray(util_1.sizeFromShape(shape),dtype);return tensor_1.Tensor.make(shape,{values:values},dtype)}exports.tensor=function(values,shape,dtype){return makeTensor(values,shape,tensor_util_env_1.inferShape(values,dtype),dtype)},exports.scalar=function(value,dtype){if((util_1.isTypedArray(value)&&"string"!==dtype||Array.isArray(value))&&"complex64"!==dtype)throw new Error("Error creating a new Scalar: value must be a primitive (number|boolean|string)");if("string"===dtype&&util_1.isTypedArray(value)&&!(value instanceof Uint8Array))throw new Error("When making a scalar from encoded string, the value must be `Uint8Array`.");return makeTensor(value,[],[],dtype)},exports.tensor1d=tensor1d,exports.tensor2d=function(values,shape,dtype){if(util_1.assertNonNull(values),null!=shape&&2!==shape.length)throw new Error("tensor2d() requires shape to have two numbers");var inferredShape=tensor_util_env_1.inferShape(values,dtype);if(2!==inferredShape.length&&1!==inferredShape.length)throw new Error("tensor2d() requires values to be number[][] or flat/TypedArray");if(1===inferredShape.length&&null==shape)throw new Error("tensor2d() requires shape to be provided when `values` are a flat/TypedArray");return makeTensor(values,shape,inferredShape,dtype)},exports.tensor3d=function(values,shape,dtype){if(util_1.assertNonNull(values),null!=shape&&3!==shape.length)throw new Error("tensor3d() requires shape to have three numbers");var inferredShape=tensor_util_env_1.inferShape(values,dtype);if(3!==inferredShape.length&&1!==inferredShape.length)throw new Error("tensor3d() requires values to be number[][][] or flat/TypedArray");if(1===inferredShape.length&&null==shape)throw new Error("tensor3d() requires shape to be provided when `values` are a flat array");return makeTensor(values,shape,inferredShape,dtype)},exports.tensor4d=function(values,shape,dtype){if(util_1.assertNonNull(values),null!=shape&&4!==shape.length)throw new Error("tensor4d() requires shape to have four numbers");var inferredShape=tensor_util_env_1.inferShape(values,dtype);if(4!==inferredShape.length&&1!==inferredShape.length)throw new Error("tensor4d() requires values to be number[][][][] or flat/TypedArray");if(1===inferredShape.length&&null==shape)throw new Error("tensor4d() requires shape to be provided when `values` are a flat array");return makeTensor(values,shape,inferredShape,dtype)},exports.tensor5d=function(values,shape,dtype){if(util_1.assertNonNull(values),null!=shape&&5!==shape.length)throw new Error("tensor5d() requires shape to have five numbers");var inferredShape=tensor_util_env_1.inferShape(values,dtype);if(5!==inferredShape.length&&1!==inferredShape.length)throw new Error("tensor5d() requires values to be number[][][][][] or flat/TypedArray");if(1===inferredShape.length&&null==shape)throw new Error("tensor5d() requires shape to be provided when `values` are a flat array");return makeTensor(values,shape,inferredShape,dtype)},exports.tensor6d=function(values,shape,dtype){if(util_1.assertNonNull(values),null!=shape&&6!==shape.length)throw new Error("tensor6d() requires shape to have six numbers");var inferredShape=tensor_util_env_1.inferShape(values,dtype);if(6!==inferredShape.length&&1!==inferredShape.length)throw new Error("tensor6d() requires values to be number[][][][][][] or flat/TypedArray");if(1===inferredShape.length&&null==shape)throw new Error("tensor6d() requires shape to be provided when `values` are a flat array");return makeTensor(values,shape=shape||inferredShape,inferredShape,dtype)},exports.ones=function ones(shape,dtype){if(void 0===dtype&&(dtype="float32"),"complex64"===dtype){var real_1=ones(shape,"float32"),imag_1=zeros(shape,"float32");return complex_ops_1.complex(real_1,imag_1)}var values=util_1.makeOnesTypedArray(util_1.sizeFromShape(shape),dtype);return tensor_1.Tensor.make(shape,{values:values},dtype)},exports.zeros=zeros,exports.fill=function(shape,value,dtype){return engine_1.ENGINE.runKernel(function(backend){return backend.fill(shape,value,dtype)},{})},exports.linspace=function(start,stop,num){if(num<=0)throw new Error("The number of values should be positive.");return engine_1.ENGINE.runKernel(function(backend){return backend.linspace(start,stop,num)},{})},exports.range=function(start,stop,step,dtype){if(void 0===step&&(step=1),void 0===dtype&&(dtype="float32"),0===step)throw new Error("Cannot have a step of zero");if(start===stop||start<stop&&step<0||stop<start&&1<step)return zeros([0],dtype);var numElements=Math.abs(Math.ceil((stop-start)/step)),values=util_1.makeZerosTypedArray(numElements,dtype);stop<start&&1===step&&(step=-1),values[0]=start;for(var i=1;i<values.length;i++)values[i]=values[i-1]+step;return tensor1d(values,dtype)},exports.onesLike=operation_1.op({onesLike_:function(x){var $x=tensor_util_env_1.convertToTensor(x,"x","onesLike");if("complex64"!==$x.dtype)return engine_1.ENGINE.runKernel(function(backend){return backend.onesLike($x)},{$x:$x},function(dy,saved){return{$x:function(){return exports.zerosLike(dy)}}});var r=exports.onesLike(complex_ops_1.real($x)),i=exports.zerosLike(complex_ops_1.imag($x));return complex_ops_1.complex(r,i)}}),exports.zerosLike=operation_1.op({zerosLike_:function(x){var $x=tensor_util_env_1.convertToTensor(x,"x","zerosLike");return engine_1.ENGINE.runKernel(function(backend){return backend.zerosLike($x)},{$x:$x},function(dy,saved){return{$x:function(){return exports.zerosLike(dy)}}})}})},{"../engine":143,"../environment":144,"../tensor":234,"../tensor_util_env":237,"../util":241,"./complex_ops":172,"./operation":195}],217:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var engine_1=require("../engine"),tensor_util_env_1=require("../tensor_util_env"),operation_1=require("./operation");exports.topk=operation_1.op({topk_:function(x,k,sorted){void 0===k&&(k=1),void 0===sorted&&(sorted=!0);var $x=tensor_util_env_1.convertToTensor(x,"x","topk");if(0===$x.rank)throw new Error("topk() expects the input to be of rank 1 or higher");var lastDim=$x.shape[$x.shape.length-1];if(lastDim<k)throw new Error("'k' passed to topk() must be <= the last dimension ("+lastDim+") but got "+k);var _a=engine_1.ENGINE.runKernel(function(b){return b.topk($x,k,sorted)},{$x:$x});return{values:_a[0],indices:_a[1]}}})},{"../engine":143,"../tensor_util_env":237,"./operation":195}],218:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var engine_1=require("../engine"),tensor_util_env_1=require("../tensor_util_env"),util=require("../util"),axis_util=require("./axis_util"),operation_1=require("./operation");exports.transpose=operation_1.op({transpose_:function(x,perm){var $x=tensor_util_env_1.convertToTensor(x,"x","transpose");return null==perm&&(perm=$x.shape.map(function(s,i){return i}).reverse()),util.assert($x.rank===perm.length,function(){return"Error in transpose: rank of input "+$x.rank+" must match length of perm "+perm+"."}),perm.forEach(function(axis){util.assert(0<=axis&&axis<$x.rank,function(){return"All entries in 'perm' must be between 0 and "+($x.rank-1)+" but got "+perm})}),$x.rank<=1?$x.clone():engine_1.ENGINE.runKernel(function(backend){return backend.transpose($x,perm)},{$x:$x},function(dy){var undoPerm=axis_util.getUndoAxesPermutation(perm);return{$x:function(){return dy.transpose(undoPerm)}}})}})},{"../engine":143,"../tensor_util_env":237,"../util":241,"./axis_util":165,"./operation":195}],219:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var engine_1=require("../engine"),tensor_util_env_1=require("../tensor_util_env"),util=require("../util"),operation_1=require("./operation"),tensor_ops_1=require("./tensor_ops");exports.abs=operation_1.op({abs_:function(x){var $x=tensor_util_env_1.convertToTensor(x,"x","abs");return"complex64"===$x.dtype?engine_1.ENGINE.runKernel(function(backend){return backend.complexAbs($x)},{$x:$x}):engine_1.ENGINE.runKernel(function(backend,save){var res=backend.abs($x);return save([$x]),res},{$x:$x},function(dy,saved){var $x=saved[0];return{$x:function(){return dy.mul($x.toFloat().step(-1))}}})}}),exports.acos=operation_1.op({acos_:function(x){var $x=tensor_util_env_1.convertToTensor(x,"x","acos");return engine_1.ENGINE.runKernel(function(backend,save){var res=backend.acos($x);return save([$x]),res},{$x:$x},function(dy,saved){var $x=saved[0];return{$x:function(){return dy.divStrict(tensor_ops_1.scalar(1).sub($x.toFloat().square()).sqrt()).neg()}}})}}),exports.acosh=operation_1.op({acosh_:function(x){var $x=tensor_util_env_1.convertToTensor(x,"x","acosh");return engine_1.ENGINE.runKernel(function(backend,save){var res=backend.acosh($x);return save([$x]),res},{$x:$x},function(dy,saved){var $x=saved[0];return{$x:function(){return dy.divStrict($x.toFloat().square().sub(1).sqrt())}}})}}),exports.asin=operation_1.op({asin_:function(x){var $x=tensor_util_env_1.convertToTensor(x,"x","asin");return engine_1.ENGINE.runKernel(function(backend,save){var res=backend.asin($x);return save([$x]),res},{$x:$x},function(dy,saved){var $x=saved[0];return{$x:function(){return dy.divStrict(tensor_ops_1.scalar(1).sub($x.toFloat().square()).sqrt())}}})}}),exports.asinh=operation_1.op({asinh_:function(x){var $x=tensor_util_env_1.convertToTensor(x,"x","asinh");return engine_1.ENGINE.runKernel(function(backend,save){var res=backend.asinh($x);return save([$x]),res},{$x:$x},function(dy,saved){var $x=saved[0];return{$x:function(){return dy.divStrict(tensor_ops_1.scalar(1).add($x.toFloat().square()).sqrt())}}})}}),exports.atan=operation_1.op({atan_:function(x){var $x=tensor_util_env_1.convertToTensor(x,"x","atan");return engine_1.ENGINE.runKernel(function(backend,save){var res=backend.atan($x);return save([$x]),res},{$x:$x},function(dy,saved){var $x=saved[0];return{$x:function(){return dy.div($x.toFloat().square().add(1))}}})}}),exports.atanh=operation_1.op({atanh_:function(x){var $x=tensor_util_env_1.convertToTensor(x,"x","atanh");return engine_1.ENGINE.runKernel(function(backend,save){var res=backend.atanh($x);return save([$x]),res},{$x:$x},function(dy,saved){var $x=saved[0];return{$x:function(){return dy.div(tensor_ops_1.scalar(1).sub($x.toFloat().square()))}}})}}),exports.ceil=operation_1.op({ceil_:function(x){var $x=tensor_util_env_1.convertToTensor(x,"x","ceil");return engine_1.ENGINE.runKernel(function(backend){return backend.ceil($x)},{$x:$x},function(dy){return{$x:function(){return tensor_ops_1.zerosLike(dy)}}})}}),exports.clipByValue=operation_1.op({clipByValue_:function(x,clipValueMin,clipValueMax){var $x=tensor_util_env_1.convertToTensor(x,"x","clipByValue");return util.assert(clipValueMin<=clipValueMax,function(){return"Error in clip: min ("+clipValueMin+") must be less than or equal to max ("+clipValueMax+")."}),engine_1.ENGINE.runKernel(function(backend,save){var res=backend.clip($x,clipValueMin,clipValueMax);return save([$x]),res},{$x:$x},function(dy,saved){var $x=saved[0];return{$x:function(){return dy.where($x.greaterEqual(clipValueMin).logicalAnd($x.lessEqual(clipValueMax)),tensor_ops_1.zerosLike(dy))}}})}}),exports.cos=operation_1.op({cos_:function(x){var $x=tensor_util_env_1.convertToTensor(x,"x","cos");return engine_1.ENGINE.runKernel(function(backend,save){var res=backend.cos($x);return save([$x]),res},{$x:$x},function(dy,saved){var $x=saved[0];return{$x:function(){return $x.toFloat().sin().neg().mul(dy)}}})}}),exports.cosh=operation_1.op({cosh_:function(x){var $x=tensor_util_env_1.convertToTensor(x,"x","cosh");return engine_1.ENGINE.runKernel(function(backend,save){var res=backend.cosh($x);return save([$x]),res},{$x:$x},function(dy,saved){var $x=saved[0];return{$x:function(){return $x.toFloat().sinh().mulStrict(dy)}}})}}),exports.erf=operation_1.op({erf_:function(x){var $x=tensor_util_env_1.convertToTensor(x,"x","erf");return util.assert("int32"===$x.dtype||"float32"===$x.dtype,function(){return"Input dtype must be `int32` or `float32`."}),"int32"===$x.dtype&&($x=$x.toFloat()),engine_1.ENGINE.runKernel(function(backend,save){var res=backend.erf($x);return save([$x]),res},{$x:$x},function(dy,saved){var $x=saved[0];return{$x:function(){return dy.mul($x.square().neg().exp().mul(2/Math.sqrt(Math.PI)))}}})}}),exports.exp=operation_1.op({exp_:function(x){var $x=tensor_util_env_1.convertToTensor(x,"x","exp");return engine_1.ENGINE.runKernel(function(backend,save){var y=backend.exp($x);return save([y]),y},{$x:$x},function(dy,saved){return{$x:function(){return dy.mulStrict(saved[0])}}})}}),exports.expm1=operation_1.op({expm1_:function(x){var $x=tensor_util_env_1.convertToTensor(x,"x","expm1");return engine_1.ENGINE.runKernel(function(backend,save){var res=backend.expm1($x);return save([$x]),res},{$x:$x},function(dy,saved){var $x=saved[0];return{$x:function(){return dy.mul($x.exp())}}})}}),exports.floor=operation_1.op({floor_:function(x){var $x=tensor_util_env_1.convertToTensor(x,"x","floor");return engine_1.ENGINE.runKernel(function(backend){return backend.floor($x)},{$x:$x},function(dy){return{$x:function(){return tensor_ops_1.zerosLike(dy)}}})}}),exports.log=operation_1.op({log_:function(x){var $x=tensor_util_env_1.convertToTensor(x,"x","log");return engine_1.ENGINE.runKernel(function(backend,save){var res=backend.log($x);return save([$x]),res},{$x:$x},function(dy,saved){var $x=saved[0];return{$x:function(){return dy.div($x.toFloat())}}})}}),exports.log1p=operation_1.op({log1p_:function(x){var $x=tensor_util_env_1.convertToTensor(x,"x","log1p");return engine_1.ENGINE.runKernel(function(backend,save){var res=backend.log1p($x);return save([$x]),res},{$x:$x},function(dy,saved){var $x=saved[0];return{$x:function(){return dy.div($x.add(1))}}})}}),exports.logSigmoid=operation_1.op({logSigmoid_:function(x){var $x=tensor_util_env_1.convertToTensor(x,"x","logSigmoid");return engine_1.ENGINE.runKernel(function(backend,save){var res=backend.softplus($x.neg()).neg();return save([$x]),res},{$x:$x},function(dy,saved){var $x=saved[0];return{$x:function(){return dy.mul($x.neg().sigmoid())}}})}}),exports.neg=operation_1.op({neg_:function(x){var $x=tensor_util_env_1.convertToTensor(x,"x","neg");return engine_1.ENGINE.runKernel(function(backend){return backend.neg($x)},{$x:$x},function(dy){return{$x:function(){return dy.neg()}}})}}),exports.reciprocal=operation_1.op({reciprocal_:function(x){var $x=tensor_util_env_1.convertToTensor(x,"x","reciprocal");return engine_1.ENGINE.runKernel(function(backend,save){var res=backend.reciprocal($x);return save([$x]),res},{$x:$x},function(dy,saved){var $x=saved[0];return{$x:function(){return dy.div($x.square().neg())}}})}}),exports.round=operation_1.op({round_:function(x){var $x=tensor_util_env_1.convertToTensor(x,"x","round");return engine_1.ENGINE.runKernel(function(backend){return backend.round($x)},{$x:$x},function(dy){return{$x:function(){return tensor_ops_1.zerosLike(dy)}}})}}),exports.rsqrt=operation_1.op({rsqrt_:function(x){var $x=tensor_util_env_1.convertToTensor(x,"x","rsqrt");return engine_1.ENGINE.runKernel(function(backend,save){var res=backend.rsqrt($x);return save([$x]),res},{$x:$x},function(dy,saved){var $x=saved[0];return{$x:function(){return dy.div($x.pow(1.5).mul(2)).neg()}}})}}),exports.sigmoid=operation_1.op({sigmoid_:function(x){var $x=tensor_util_env_1.convertToTensor(x,"x","sigmoid");return engine_1.ENGINE.runKernel(function(backend,save){var y=backend.sigmoid($x);return save([y]),y},{$x:$x},function(dy,saved){var y=saved[0];return{$x:function(){return dy.mul(y.mul(tensor_ops_1.scalar(1).sub(y)))}}})}}),exports.sign=operation_1.op({sign_:function(x){var $x=tensor_util_env_1.convertToTensor(x,"x","sign");return engine_1.ENGINE.runKernel(function(backend){return backend.sign($x)},{$x:$x},function(dy){return{$x:function(){return tensor_ops_1.zerosLike(dy)}}})}}),exports.isNaN=operation_1.op({isNaN_:function(x){var $x=tensor_util_env_1.convertToTensor(x,"x","isNaN");return engine_1.ENGINE.runKernel(function(backend){return backend.isNaN($x)},{$x:$x},function(dy){return{$x:function(){return tensor_ops_1.zerosLike(dy)}}})}}),exports.isInf=operation_1.op({isInf_:function(x){var $x=tensor_util_env_1.convertToTensor(x,"x","isInf");return engine_1.ENGINE.runKernel(function(backend){return backend.isInf($x)},{$x:$x},function(dy){return{$x:function(){return tensor_ops_1.zerosLike(dy)}}})}}),exports.isFinite=operation_1.op({isFinite_:function(x){var $x=tensor_util_env_1.convertToTensor(x,"x","isFinite");return engine_1.ENGINE.runKernel(function(backend){return backend.isFinite($x)},{$x:$x},function(dy){return{$x:function(){return tensor_ops_1.zerosLike(dy)}}})}}),exports.sin=operation_1.op({sin_:function(x){var $x=tensor_util_env_1.convertToTensor(x,"x","sin");return engine_1.ENGINE.runKernel(function(backend,save){var res=backend.sin($x);return save([$x]),res},{$x:$x},function(dy,saved){var $x=saved[0];return{$x:function(){return $x.toFloat().cos().mul(dy)}}})}}),exports.sinh=operation_1.op({sinh_:function(x){var $x=tensor_util_env_1.convertToTensor(x,"x","sinh");return engine_1.ENGINE.runKernel(function(backend,save){var res=backend.sinh($x);return save([$x]),res},{$x:$x},function(dy,saved){var $x=saved[0];return{$x:function(){return $x.toFloat().cosh().mulStrict(dy)}}})}}),exports.softplus=operation_1.op({softplus_:function(x){var $x=tensor_util_env_1.convertToTensor(x,"x","softplus");return engine_1.ENGINE.runKernel(function(backend,save){var res=backend.softplus($x);return save([$x]),res},{$x:$x},function(dy,saved){var $x=saved[0];return{$x:function(){return dy.mul($x.sigmoid())}}})}}),exports.sqrt=operation_1.op({sqrt_:function(x){var $x=tensor_util_env_1.convertToTensor(x,"x","sqrt");return engine_1.ENGINE.runKernel(function(backend,save){var res=backend.sqrt($x);return save([$x]),res},{$x:$x},function(dy,saved){var $x=saved[0];return{$x:function(){return dy.div($x.toFloat().sqrt().mul(2))}}})}}),exports.square=operation_1.op({square_:function(x){var $x=tensor_util_env_1.convertToTensor(x,"x","square");return engine_1.ENGINE.runKernel(function(backend,save){return save([$x]),backend.square($x)},{$x:$x},function(dy,saved){var $x=saved[0];return{$x:function(){return dy.mul($x.toFloat().mul(2))}}})}}),exports.step=operation_1.op({step_:function(x,alpha){void 0===alpha&&(alpha=0);var $x=tensor_util_env_1.convertToTensor(x,"x","step");return engine_1.ENGINE.runKernel(function(backend){return backend.step($x,alpha)},{$x:$x},function(dy){return{$x:function(){return tensor_ops_1.zerosLike(dy)}}})}}),exports.tan=operation_1.op({tan_:function(x){var $x=tensor_util_env_1.convertToTensor(x,"x","tan");return engine_1.ENGINE.runKernel(function(backend,save){var res=backend.tan($x);return save([$x]),res},{$x:$x},function(dy,saved){var $x=saved[0];return{$x:function(){return dy.div($x.cos().square())}}})}}),exports.tanh=operation_1.op({tanh_:function(x){var $x=tensor_util_env_1.convertToTensor(x,"x","tanh");return engine_1.ENGINE.runKernel(function(backend,save){var y=backend.tanh($x);return save([y]),y},{$x:$x},function(dy,saved){var y=saved[0];return{$x:function(){return tensor_ops_1.scalar(1).sub(y.square()).mulStrict(dy)}}})}})},{"../engine":143,"../tensor_util_env":237,"../util":241,"./operation":195,"./tensor_ops":216}],220:[function(require,module,exports){"use strict";var extendStatics,__extends=this&&this.__extends||(extendStatics=function(d,b){return(extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p])})(d,b)},function(d,b){function __(){this.constructor=d}extendStatics(d,b),d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)}),__awaiter=this&&this.__awaiter||function(thisArg,_arguments,P,generator){return new(P=P||Promise)(function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){result.done?resolve(result.value):new P(function(resolve){resolve(result.value)}).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())})},__generator=this&&this.__generator||function(thisArg,body){var f,y,t,g,_={label:0,sent:function(){if(1&t[0])throw t[1];return t[1]},trys:[],ops:[]};return g={next:verb(0),throw:verb(1),return:verb(2)},"function"==typeof Symbol&&(g[Symbol.iterator]=function(){return this}),g;function verb(n){return function(v){return function(op){if(f)throw new TypeError("Generator is already executing.");for(;_;)try{if(f=1,y&&(t=2&op[0]?y.return:op[0]?y.throw||((t=y.return)&&t.call(y),0):y.next)&&!(t=t.call(y,op[1])).done)return t;switch(y=0,t&&(op=[2&op[0],t.value]),op[0]){case 0:case 1:t=op;break;case 4:return _.label++,{value:op[1],done:!1};case 5:_.label++,y=op[1],op=[0];continue;case 7:op=_.ops.pop(),_.trys.pop();continue;default:if(!(t=0<(t=_.trys).length&&t[t.length-1])&&(6===op[0]||2===op[0])){_=0;continue}if(3===op[0]&&(!t||op[1]>t[0]&&op[1]<t[3])){_.label=op[1];break}if(6===op[0]&&_.label<t[1]){_.label=t[1],t=op;break}if(t&&_.label<t[2]){_.label=t[2],_.ops.push(op);break}t[2]&&_.ops.pop(),_.trys.pop();continue}op=body.call(thisArg,_)}catch(e){op=[6,e],y=0}finally{f=t=0}if(5&op[0])throw op[1];return{value:op[0]?op[1]:void 0,done:!0}}([n,v])}}};Object.defineProperty(exports,"__esModule",{value:!0});var engine_1=require("../engine"),globals_1=require("../globals"),ops_1=require("../ops/ops"),serialization_1=require("../serialization"),AdadeltaOptimizer=function(_super){function AdadeltaOptimizer(learningRate,rho,epsilon){void 0===epsilon&&(epsilon=null);var _this=_super.call(this)||this;return _this.learningRate=learningRate,_this.rho=rho,_this.epsilon=epsilon,_this.accumulatedGrads=[],_this.accumulatedUpdates=[],null==epsilon&&(_this.epsilon=engine_1.ENGINE.backend.epsilon()),_this}return __extends(AdadeltaOptimizer,_super),AdadeltaOptimizer.prototype.applyGradients=function(variableGradients){var _this=this;(Array.isArray(variableGradients)?variableGradients.map(function(item){return item.name}):Object.keys(variableGradients)).forEach(function(name,i){var value=engine_1.ENGINE.registeredVariables[name];null==_this.accumulatedGrads[i]&&(_this.accumulatedGrads[i]={originalName:name+"/accum_grad",variable:globals_1.tidy(function(){return ops_1.zerosLike(value).variable(!1)})}),null==_this.accumulatedUpdates[i]&&(_this.accumulatedUpdates[i]={originalName:name+"/accum_var",variable:globals_1.tidy(function(){return ops_1.zerosLike(value).variable(!1)})});var gradient=Array.isArray(variableGradients)?variableGradients[i].tensor:variableGradients[name];if(null!=gradient){var accumulatedGrad=_this.accumulatedGrads[i].variable,accumulatedUpdate=_this.accumulatedUpdates[i].variable;globals_1.tidy(function(){var newAccumulatedGrad=accumulatedGrad.mul(_this.rho).add(gradient.square().mul(1-_this.rho)),updates=accumulatedUpdate.add(_this.epsilon).sqrt().div(accumulatedGrad.add(_this.epsilon).sqrt()).mul(gradient),newAccumulatedUpdate=accumulatedUpdate.mul(_this.rho).add(updates.square().mul(1-_this.rho));accumulatedGrad.assign(newAccumulatedGrad),accumulatedUpdate.assign(newAccumulatedUpdate);var newValue=updates.mul(-_this.learningRate).add(value);value.assign(newValue)})}}),this.incrementIterations()},AdadeltaOptimizer.prototype.dispose=function(){null!=this.accumulatedUpdates&&(globals_1.dispose(this.accumulatedGrads.map(function(v){return v.variable})),globals_1.dispose(this.accumulatedUpdates.map(function(v){return v.variable})))},AdadeltaOptimizer.prototype.getWeights=function(){return __awaiter(this,void 0,void 0,function(){var variables;return __generator(this,function(_a){switch(_a.label){case 0:return variables=this.accumulatedGrads.concat(this.accumulatedUpdates),[4,this.saveIterations()];case 1:return[2,[_a.sent()].concat(variables.map(function(v){return{name:v.originalName,tensor:v.variable}}))]}})})},AdadeltaOptimizer.prototype.setWeights=function(weightValues){return __awaiter(this,void 0,void 0,function(){var variableCount;return __generator(this,function(_a){switch(_a.label){case 0:return[4,this.extractIterations(weightValues)];case 1:return weightValues=_a.sent(),variableCount=weightValues.length/2,!1,this.accumulatedGrads=weightValues.slice(0,variableCount).map(function(v){return{originalName:v.name,variable:v.tensor.variable(!1)}}),this.accumulatedUpdates=weightValues.slice(variableCount,2*variableCount).map(function(v){return{originalName:v.name,variable:v.tensor.variable(!1)}}),[2]}})})},AdadeltaOptimizer.prototype.getConfig=function(){return{learningRate:this.learningRate,rho:this.rho,epsilon:this.epsilon}},AdadeltaOptimizer.fromConfig=function(cls,config){return new cls(config.learningRate,config.rho,config.epsilon)},AdadeltaOptimizer.className="Adadelta",AdadeltaOptimizer}(require("./optimizer").Optimizer);exports.AdadeltaOptimizer=AdadeltaOptimizer,serialization_1.registerClass(AdadeltaOptimizer)},{"../engine":143,"../globals":146,"../ops/ops":196,"../serialization":232,"./optimizer":225}],221:[function(require,module,exports){"use strict";var extendStatics,__extends=this&&this.__extends||(extendStatics=function(d,b){return(extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p])})(d,b)},function(d,b){function __(){this.constructor=d}extendStatics(d,b),d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)}),__awaiter=this&&this.__awaiter||function(thisArg,_arguments,P,generator){return new(P=P||Promise)(function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){result.done?resolve(result.value):new P(function(resolve){resolve(result.value)}).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())})},__generator=this&&this.__generator||function(thisArg,body){var f,y,t,g,_={label:0,sent:function(){if(1&t[0])throw t[1];return t[1]},trys:[],ops:[]};return g={next:verb(0),throw:verb(1),return:verb(2)},"function"==typeof Symbol&&(g[Symbol.iterator]=function(){return this}),g;function verb(n){return function(v){return function(op){if(f)throw new TypeError("Generator is already executing.");for(;_;)try{if(f=1,y&&(t=2&op[0]?y.return:op[0]?y.throw||((t=y.return)&&t.call(y),0):y.next)&&!(t=t.call(y,op[1])).done)return t;switch(y=0,t&&(op=[2&op[0],t.value]),op[0]){case 0:case 1:t=op;break;case 4:return _.label++,{value:op[1],done:!1};case 5:_.label++,y=op[1],op=[0];continue;case 7:op=_.ops.pop(),_.trys.pop();continue;default:if(!(t=0<(t=_.trys).length&&t[t.length-1])&&(6===op[0]||2===op[0])){_=0;continue}if(3===op[0]&&(!t||op[1]>t[0]&&op[1]<t[3])){_.label=op[1];break}if(6===op[0]&&_.label<t[1]){_.label=t[1],t=op;break}if(t&&_.label<t[2]){_.label=t[2],_.ops.push(op);break}t[2]&&_.ops.pop(),_.trys.pop();continue}op=body.call(thisArg,_)}catch(e){op=[6,e],y=0}finally{f=t=0}if(5&op[0])throw op[1];return{value:op[0]?op[1]:void 0,done:!0}}([n,v])}}};Object.defineProperty(exports,"__esModule",{value:!0});var engine_1=require("../engine"),globals_1=require("../globals"),ops_1=require("../ops/ops"),serialization_1=require("../serialization"),AdagradOptimizer=function(_super){function AdagradOptimizer(learningRate,initialAccumulatorValue){void 0===initialAccumulatorValue&&(initialAccumulatorValue=.1);var _this=_super.call(this)||this;return _this.learningRate=learningRate,_this.initialAccumulatorValue=initialAccumulatorValue,_this.accumulatedGrads=[],_this}return __extends(AdagradOptimizer,_super),AdagradOptimizer.prototype.applyGradients=function(variableGradients){var _this=this;(Array.isArray(variableGradients)?variableGradients.map(function(item){return item.name}):Object.keys(variableGradients)).forEach(function(name,i){var value=engine_1.ENGINE.registeredVariables[name];if(null==_this.accumulatedGrads[i]){_this.accumulatedGrads[i]={originalName:name+"/accumulator",variable:globals_1.tidy(function(){return ops_1.fill(value.shape,_this.initialAccumulatorValue).variable(!1)})}}var gradient=Array.isArray(variableGradients)?variableGradients[i].tensor:variableGradients[name];if(null!=gradient){var accumulatedGrad=_this.accumulatedGrads[i].variable;globals_1.tidy(function(){var newAccumulatedGrad=accumulatedGrad.add(gradient.square());accumulatedGrad.assign(newAccumulatedGrad);var newValue=gradient.div(newAccumulatedGrad.add(engine_1.ENGINE.backend.epsilon()).sqrt()).mul(-_this.learningRate).add(value);value.assign(newValue)})}}),this.incrementIterations()},AdagradOptimizer.prototype.dispose=function(){null!=this.accumulatedGrads&&globals_1.dispose(this.accumulatedGrads.map(function(v){return v.variable}))},AdagradOptimizer.prototype.getWeights=function(){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(_a){switch(_a.label){case 0:return[4,this.saveIterations()];case 1:return[2,[_a.sent()].concat(this.accumulatedGrads.map(function(v){return{name:v.originalName,tensor:v.variable}}))]}})})},AdagradOptimizer.prototype.setWeights=function(weightValues){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(_a){switch(_a.label){case 0:return[4,this.extractIterations(weightValues)];case 1:return weightValues=_a.sent(),!1,this.accumulatedGrads=weightValues.map(function(v){return{originalName:v.name,variable:v.tensor.variable(!1)}}),[2]}})})},AdagradOptimizer.prototype.getConfig=function(){return{learningRate:this.learningRate,initialAccumulatorValue:this.initialAccumulatorValue}},AdagradOptimizer.fromConfig=function(cls,config){return new cls(config.learningRate,config.initialAccumulatorValue)},AdagradOptimizer.className="Adagrad",AdagradOptimizer}(require("./optimizer").Optimizer);exports.AdagradOptimizer=AdagradOptimizer,serialization_1.registerClass(AdagradOptimizer)},{"../engine":143,"../globals":146,"../ops/ops":196,"../serialization":232,"./optimizer":225}],222:[function(require,module,exports){"use strict";var extendStatics,__extends=this&&this.__extends||(extendStatics=function(d,b){return(extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p])})(d,b)},function(d,b){function __(){this.constructor=d}extendStatics(d,b),d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)}),__awaiter=this&&this.__awaiter||function(thisArg,_arguments,P,generator){return new(P=P||Promise)(function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){result.done?resolve(result.value):new P(function(resolve){resolve(result.value)}).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())})},__generator=this&&this.__generator||function(thisArg,body){var f,y,t,g,_={label:0,sent:function(){if(1&t[0])throw t[1];return t[1]},trys:[],ops:[]};return g={next:verb(0),throw:verb(1),return:verb(2)},"function"==typeof Symbol&&(g[Symbol.iterator]=function(){return this}),g;function verb(n){return function(v){return function(op){if(f)throw new TypeError("Generator is already executing.");for(;_;)try{if(f=1,y&&(t=2&op[0]?y.return:op[0]?y.throw||((t=y.return)&&t.call(y),0):y.next)&&!(t=t.call(y,op[1])).done)return t;switch(y=0,t&&(op=[2&op[0],t.value]),op[0]){case 0:case 1:t=op;break;case 4:return _.label++,{value:op[1],done:!1};case 5:_.label++,y=op[1],op=[0];continue;case 7:op=_.ops.pop(),_.trys.pop();continue;default:if(!(t=0<(t=_.trys).length&&t[t.length-1])&&(6===op[0]||2===op[0])){_=0;continue}if(3===op[0]&&(!t||op[1]>t[0]&&op[1]<t[3])){_.label=op[1];break}if(6===op[0]&&_.label<t[1]){_.label=t[1],t=op;break}if(t&&_.label<t[2]){_.label=t[2],_.ops.push(op);break}t[2]&&_.ops.pop(),_.trys.pop();continue}op=body.call(thisArg,_)}catch(e){op=[6,e],y=0}finally{f=t=0}if(5&op[0])throw op[1];return{value:op[0]?op[1]:void 0,done:!0}}([n,v])}}};Object.defineProperty(exports,"__esModule",{value:!0});var engine_1=require("../engine"),globals_1=require("../globals"),ops_1=require("../ops/ops"),serialization_1=require("../serialization"),AdamOptimizer=function(_super){function AdamOptimizer(learningRate,beta1,beta2,epsilon){void 0===epsilon&&(epsilon=null);var _this=_super.call(this)||this;return _this.learningRate=learningRate,_this.beta1=beta1,_this.beta2=beta2,_this.epsilon=epsilon,_this.accumulatedFirstMoment=[],_this.accumulatedSecondMoment=[],globals_1.tidy(function(){_this.accBeta1=ops_1.scalar(beta1).variable(),_this.accBeta2=ops_1.scalar(beta2).variable()}),null==epsilon&&(_this.epsilon=engine_1.ENGINE.backend.epsilon()),_this}return __extends(AdamOptimizer,_super),AdamOptimizer.prototype.applyGradients=function(variableGradients){var _this=this,varNames=Array.isArray(variableGradients)?variableGradients.map(function(v){return v.name}):Object.keys(variableGradients);globals_1.tidy(function(){var oneMinusAccBeta1=ops_1.sub(1,_this.accBeta1),oneMinusAccBeta2=ops_1.sub(1,_this.accBeta2);varNames.forEach(function(name,i){var value=engine_1.ENGINE.registeredVariables[name];null==_this.accumulatedFirstMoment[i]&&(_this.accumulatedFirstMoment[i]={originalName:name+"/m",variable:globals_1.tidy(function(){return ops_1.zerosLike(value).variable(!1)})}),null==_this.accumulatedSecondMoment[i]&&(_this.accumulatedSecondMoment[i]={originalName:name+"/v",variable:globals_1.tidy(function(){return ops_1.zerosLike(value).variable(!1)})});var gradient=Array.isArray(variableGradients)?variableGradients[i].tensor:variableGradients[name];if(null!=gradient){var firstMoment=_this.accumulatedFirstMoment[i].variable,secondMoment=_this.accumulatedSecondMoment[i].variable,newFirstMoment=firstMoment.mul(_this.beta1).add(gradient.mul(1-_this.beta1)),newSecondMoment=secondMoment.mul(_this.beta2).add(gradient.square().mul(1-_this.beta2)),biasCorrectedFirstMoment=newFirstMoment.div(oneMinusAccBeta1),biasCorrectedSecondMoment=newSecondMoment.div(oneMinusAccBeta2);firstMoment.assign(newFirstMoment),secondMoment.assign(newSecondMoment);var newValue=biasCorrectedFirstMoment.div(biasCorrectedSecondMoment.sqrt().add(_this.epsilon)).mul(-_this.learningRate).add(value);value.assign(newValue)}}),_this.accBeta1.assign(_this.accBeta1.mul(_this.beta1)),_this.accBeta2.assign(_this.accBeta2.mul(_this.beta2))}),this.incrementIterations()},AdamOptimizer.prototype.dispose=function(){this.accBeta1.dispose(),this.accBeta2.dispose(),null!=this.accumulatedFirstMoment&&globals_1.dispose(this.accumulatedFirstMoment.map(function(v){return v.variable})),null!=this.accumulatedSecondMoment&&globals_1.dispose(this.accumulatedSecondMoment.map(function(v){return v.variable}))},AdamOptimizer.prototype.getWeights=function(){return __awaiter(this,void 0,void 0,function(){var variables;return __generator(this,function(_a){switch(_a.label){case 0:return variables=this.accumulatedFirstMoment.concat(this.accumulatedSecondMoment),[4,this.saveIterations()];case 1:return[2,[_a.sent()].concat(variables.map(function(v){return{name:v.originalName,tensor:v.variable}}))]}})})},AdamOptimizer.prototype.setWeights=function(weightValues){return __awaiter(this,void 0,void 0,function(){var variableCount,_this=this;return __generator(this,function(_a){switch(_a.label){case 0:return[4,this.extractIterations(weightValues)];case 1:return weightValues=_a.sent(),globals_1.tidy(function(){_this.accBeta1.assign(ops_1.pow(_this.beta1,_this.iterations_+1)),_this.accBeta2.assign(ops_1.pow(_this.beta2,_this.iterations_+1))}),variableCount=weightValues.length/2,!1,this.accumulatedFirstMoment=weightValues.slice(0,variableCount).map(function(v){return{originalName:v.name,variable:v.tensor.variable(!1)}}),this.accumulatedSecondMoment=weightValues.slice(variableCount,2*variableCount).map(function(v){return{originalName:v.name,variable:v.tensor.variable(!1)}}),[2]}})})},AdamOptimizer.prototype.getConfig=function(){return{learningRate:this.learningRate,beta1:this.beta1,beta2:this.beta2,epsilon:this.epsilon}},AdamOptimizer.fromConfig=function(cls,config){return new cls(config.learningRate,config.beta1,config.beta2,config.epsilon)},AdamOptimizer.className="Adam",AdamOptimizer}(require("./optimizer").Optimizer);exports.AdamOptimizer=AdamOptimizer,serialization_1.registerClass(AdamOptimizer)},{"../engine":143,"../globals":146,"../ops/ops":196,"../serialization":232,"./optimizer":225}],223:[function(require,module,exports){"use strict";var extendStatics,__extends=this&&this.__extends||(extendStatics=function(d,b){return(extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p])})(d,b)},function(d,b){function __(){this.constructor=d}extendStatics(d,b),d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)}),__awaiter=this&&this.__awaiter||function(thisArg,_arguments,P,generator){return new(P=P||Promise)(function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){result.done?resolve(result.value):new P(function(resolve){resolve(result.value)}).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())})},__generator=this&&this.__generator||function(thisArg,body){var f,y,t,g,_={label:0,sent:function(){if(1&t[0])throw t[1];return t[1]},trys:[],ops:[]};return g={next:verb(0),throw:verb(1),return:verb(2)},"function"==typeof Symbol&&(g[Symbol.iterator]=function(){return this}),g;function verb(n){return function(v){return function(op){if(f)throw new TypeError("Generator is already executing.");for(;_;)try{if(f=1,y&&(t=2&op[0]?y.return:op[0]?y.throw||((t=y.return)&&t.call(y),0):y.next)&&!(t=t.call(y,op[1])).done)return t;switch(y=0,t&&(op=[2&op[0],t.value]),op[0]){case 0:case 1:t=op;break;case 4:return _.label++,{value:op[1],done:!1};case 5:_.label++,y=op[1],op=[0];continue;case 7:op=_.ops.pop(),_.trys.pop();continue;default:if(!(t=0<(t=_.trys).length&&t[t.length-1])&&(6===op[0]||2===op[0])){_=0;continue}if(3===op[0]&&(!t||op[1]>t[0]&&op[1]<t[3])){_.label=op[1];break}if(6===op[0]&&_.label<t[1]){_.label=t[1],t=op;break}if(t&&_.label<t[2]){_.label=t[2],_.ops.push(op);break}t[2]&&_.ops.pop(),_.trys.pop();continue}op=body.call(thisArg,_)}catch(e){op=[6,e],y=0}finally{f=t=0}if(5&op[0])throw op[1];return{value:op[0]?op[1]:void 0,done:!0}}([n,v])}}};Object.defineProperty(exports,"__esModule",{value:!0});var engine_1=require("../engine"),globals_1=require("../globals"),ops_1=require("../ops/ops"),serialization_1=require("../serialization"),AdamaxOptimizer=function(_super){function AdamaxOptimizer(learningRate,beta1,beta2,epsilon,decay){void 0===epsilon&&(epsilon=null),void 0===decay&&(decay=0);var _this=_super.call(this)||this;return _this.learningRate=learningRate,_this.beta1=beta1,_this.beta2=beta2,_this.epsilon=epsilon,_this.decay=decay,_this.accumulatedFirstMoment=[],_this.accumulatedWeightedInfNorm=[],globals_1.tidy(function(){_this.iteration=ops_1.scalar(0).variable(),_this.accBeta1=ops_1.scalar(beta1).variable()}),null==epsilon&&(_this.epsilon=engine_1.ENGINE.backend.epsilon()),_this}return __extends(AdamaxOptimizer,_super),AdamaxOptimizer.prototype.applyGradients=function(variableGradients){var _this=this,variableNames=Array.isArray(variableGradients)?variableGradients.map(function(item){return item.name}):Object.keys(variableGradients);globals_1.tidy(function(){var oneMinusAccBeta1=ops_1.sub(1,_this.accBeta1),lr=ops_1.div(-_this.learningRate,_this.iteration.mul(_this.decay).add(1));variableNames.forEach(function(name,i){var value=engine_1.ENGINE.registeredVariables[name];null==_this.accumulatedFirstMoment[i]&&(_this.accumulatedFirstMoment[i]={originalName:name+"/m",variable:ops_1.zerosLike(value).variable(!1)}),null==_this.accumulatedWeightedInfNorm[i]&&(_this.accumulatedWeightedInfNorm[i]={originalName:name+"/v",variable:ops_1.zerosLike(value).variable(!1)});var gradient=Array.isArray(variableGradients)?variableGradients[i].tensor:variableGradients[name];if(null!=gradient){var firstMoment=_this.accumulatedFirstMoment[i].variable,weightedInfNorm=_this.accumulatedWeightedInfNorm[i].variable,newFirstMoment=firstMoment.mul(_this.beta1).add(gradient.mul(1-_this.beta1)),ut0=weightedInfNorm.mul(_this.beta2),ut1=gradient.abs(),newWeightedInfNorm=ut0.maximum(ut1);firstMoment.assign(newFirstMoment),weightedInfNorm.assign(newWeightedInfNorm);var newValue=lr.div(oneMinusAccBeta1).mul(newFirstMoment.div(newWeightedInfNorm.add(_this.epsilon))).add(value);value.assign(newValue)}}),_this.iteration.assign(_this.iteration.add(1)),_this.accBeta1.assign(_this.accBeta1.mul(_this.beta1))}),this.incrementIterations()},AdamaxOptimizer.prototype.dispose=function(){this.accBeta1.dispose(),this.iteration.dispose(),null!=this.accumulatedFirstMoment&&globals_1.dispose(this.accumulatedFirstMoment.map(function(v){return v.variable})),null!=this.accumulatedWeightedInfNorm&&globals_1.dispose(this.accumulatedWeightedInfNorm.map(function(v){return v.variable}))},AdamaxOptimizer.prototype.getWeights=function(){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(_a){throw new Error("getWeights() is not implemented for Adamax yet.")})})},AdamaxOptimizer.prototype.setWeights=function(weightValues){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(_a){throw new Error("setWeights() is not implemented for Adamax yet.")})})},AdamaxOptimizer.prototype.getConfig=function(){return{learningRate:this.learningRate,beta1:this.beta1,beta2:this.beta2,epsilon:this.epsilon,decay:this.decay}},AdamaxOptimizer.fromConfig=function(cls,config){return new cls(config.learningRate,config.beta1,config.beta2,config.epsilon,config.decay)},AdamaxOptimizer.className="Adamax",AdamaxOptimizer}(require("./optimizer").Optimizer);exports.AdamaxOptimizer=AdamaxOptimizer,serialization_1.registerClass(AdamaxOptimizer)},{"../engine":143,"../globals":146,"../ops/ops":196,"../serialization":232,"./optimizer":225}],224:[function(require,module,exports){"use strict";var extendStatics,__extends=this&&this.__extends||(extendStatics=function(d,b){return(extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p])})(d,b)},function(d,b){function __(){this.constructor=d}extendStatics(d,b),d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)}),__awaiter=this&&this.__awaiter||function(thisArg,_arguments,P,generator){return new(P=P||Promise)(function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){result.done?resolve(result.value):new P(function(resolve){resolve(result.value)}).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())})},__generator=this&&this.__generator||function(thisArg,body){var f,y,t,g,_={label:0,sent:function(){if(1&t[0])throw t[1];return t[1]},trys:[],ops:[]};return g={next:verb(0),throw:verb(1),return:verb(2)},"function"==typeof Symbol&&(g[Symbol.iterator]=function(){return this}),g;function verb(n){return function(v){return function(op){if(f)throw new TypeError("Generator is already executing.");for(;_;)try{if(f=1,y&&(t=2&op[0]?y.return:op[0]?y.throw||((t=y.return)&&t.call(y),0):y.next)&&!(t=t.call(y,op[1])).done)return t;switch(y=0,t&&(op=[2&op[0],t.value]),op[0]){case 0:case 1:t=op;break;case 4:return _.label++,{value:op[1],done:!1};case 5:_.label++,y=op[1],op=[0];continue;case 7:op=_.ops.pop(),_.trys.pop();continue;default:if(!(t=0<(t=_.trys).length&&t[t.length-1])&&(6===op[0]||2===op[0])){_=0;continue}if(3===op[0]&&(!t||op[1]>t[0]&&op[1]<t[3])){_.label=op[1];break}if(6===op[0]&&_.label<t[1]){_.label=t[1],t=op;break}if(t&&_.label<t[2]){_.label=t[2],_.ops.push(op);break}t[2]&&_.ops.pop(),_.trys.pop();continue}op=body.call(thisArg,_)}catch(e){op=[6,e],y=0}finally{f=t=0}if(5&op[0])throw op[1];return{value:op[0]?op[1]:void 0,done:!0}}([n,v])}}};Object.defineProperty(exports,"__esModule",{value:!0});var engine_1=require("../engine"),globals_1=require("../globals"),ops_1=require("../ops/ops"),serialization_1=require("../serialization"),MomentumOptimizer=function(_super){function MomentumOptimizer(learningRate,momentum,useNesterov){void 0===useNesterov&&(useNesterov=!1);var _this=_super.call(this,learningRate)||this;return _this.learningRate=learningRate,_this.momentum=momentum,_this.useNesterov=useNesterov,_this.accumulations=[],_this.m=ops_1.scalar(_this.momentum),_this}return __extends(MomentumOptimizer,_super),MomentumOptimizer.prototype.applyGradients=function(variableGradients){var _this=this;(Array.isArray(variableGradients)?variableGradients.map(function(item){return item.name}):Object.keys(variableGradients)).forEach(function(name,i){var value=engine_1.ENGINE.registeredVariables[name];if(null==_this.accumulations[i]){_this.accumulations[i]={originalName:name+"/momentum",variable:globals_1.tidy(function(){return ops_1.zerosLike(value).variable(!1)})}}var accumulation=_this.accumulations[i].variable,gradient=Array.isArray(variableGradients)?variableGradients[i].tensor:variableGradients[name];null!=gradient&&globals_1.tidy(function(){var newValue,newAccumulation=_this.m.mul(accumulation).add(gradient);newValue=_this.useNesterov?_this.c.mul(gradient.add(newAccumulation.mul(_this.m))).add(value):_this.c.mul(newAccumulation).add(value),accumulation.assign(newAccumulation),value.assign(newValue)})}),this.incrementIterations()},MomentumOptimizer.prototype.dispose=function(){this.m.dispose(),null!=this.accumulations&&globals_1.dispose(this.accumulations.map(function(v){return v.variable}))},MomentumOptimizer.prototype.setMomentum=function(momentum){this.momentum=momentum},MomentumOptimizer.prototype.getWeights=function(){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(_a){switch(_a.label){case 0:return[4,this.saveIterations()];case 1:return[2,[_a.sent()].concat(this.accumulations.map(function(v){return{name:v.originalName,tensor:v.variable}}))]}})})},MomentumOptimizer.prototype.setWeights=function(weightValues){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(_a){switch(_a.label){case 0:return[4,this.extractIterations(weightValues)];case 1:return weightValues=_a.sent(),!1,this.accumulations=weightValues.map(function(v){return{originalName:v.name,variable:v.tensor.variable(!1)}}),[2]}})})},MomentumOptimizer.prototype.getConfig=function(){return{learningRate:this.learningRate,momentum:this.momentum,useNesterov:this.useNesterov}},MomentumOptimizer.fromConfig=function(cls,config){return new cls(config.learningRate,config.momentum,config.useNesterov)},MomentumOptimizer.className="Momentum",MomentumOptimizer}(require("./sgd_optimizer").SGDOptimizer);exports.MomentumOptimizer=MomentumOptimizer,serialization_1.registerClass(MomentumOptimizer)},{"../engine":143,"../globals":146,"../ops/ops":196,"../serialization":232,"./sgd_optimizer":228}],225:[function(require,module,exports){"use strict";var extendStatics,__extends=this&&this.__extends||(extendStatics=function(d,b){return(extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p])})(d,b)},function(d,b){function __(){this.constructor=d}extendStatics(d,b),d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)}),__awaiter=this&&this.__awaiter||function(thisArg,_arguments,P,generator){return new(P=P||Promise)(function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){result.done?resolve(result.value):new P(function(resolve){resolve(result.value)}).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())})},__generator=this&&this.__generator||function(thisArg,body){var f,y,t,g,_={label:0,sent:function(){if(1&t[0])throw t[1];return t[1]},trys:[],ops:[]};return g={next:verb(0),throw:verb(1),return:verb(2)},"function"==typeof Symbol&&(g[Symbol.iterator]=function(){return this}),g;function verb(n){return function(v){return function(op){if(f)throw new TypeError("Generator is already executing.");for(;_;)try{if(f=1,y&&(t=2&op[0]?y.return:op[0]?y.throw||((t=y.return)&&t.call(y),0):y.next)&&!(t=t.call(y,op[1])).done)return t;switch(y=0,t&&(op=[2&op[0],t.value]),op[0]){case 0:case 1:t=op;break;case 4:return _.label++,{value:op[1],done:!1};case 5:_.label++,y=op[1],op=[0];continue;case 7:op=_.ops.pop(),_.trys.pop();continue;default:if(!(t=0<(t=_.trys).length&&t[t.length-1])&&(6===op[0]||2===op[0])){_=0;continue}if(3===op[0]&&(!t||op[1]>t[0]&&op[1]<t[3])){_.label=op[1];break}if(6===op[0]&&_.label<t[1]){_.label=t[1],t=op;break}if(t&&_.label<t[2]){_.label=t[2],_.ops.push(op);break}t[2]&&_.ops.pop(),_.trys.pop();continue}op=body.call(thisArg,_)}catch(e){op=[6,e],y=0}finally{f=t=0}if(5&op[0])throw op[1];return{value:op[0]?op[1]:void 0,done:!0}}([n,v])}}};Object.defineProperty(exports,"__esModule",{value:!0});var globals_1=require("../globals"),gradients_1=require("../gradients"),ops_1=require("../ops/ops"),Optimizer=function(_super){function Optimizer(){return null!==_super&&_super.apply(this,arguments)||this}return __extends(Optimizer,_super),Optimizer.prototype.minimize=function(f,returnCost,varList){void 0===returnCost&&(returnCost=!1);var _a=this.computeGradients(f,varList),value=_a.value,grads=_a.grads;if(null!=varList){var gradArray=varList.map(function(v){return{name:v.name,tensor:grads[v.name]}});this.applyGradients(gradArray)}else this.applyGradients(grads);return globals_1.dispose(grads),returnCost?value:(value.dispose(),null)},Object.defineProperty(Optimizer.prototype,"iterations",{get:function(){return null==this.iterations_&&(this.iterations_=0),this.iterations_},enumerable:!0,configurable:!0}),Optimizer.prototype.incrementIterations=function(){this.iterations_=this.iterations+1},Optimizer.prototype.computeGradients=function(f,varList){return gradients_1.variableGrads(f,varList)},Optimizer.prototype.dispose=function(){null!=this.iterations_&&globals_1.dispose(this.iterations_)},Optimizer.prototype.saveIterations=function(){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(_a){return null==this.iterations_&&(this.iterations_=0),[2,{name:"iter",tensor:ops_1.scalar(this.iterations_,"int32")}]})})},Optimizer.prototype.getWeights=function(){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(_a){throw new Error("getWeights() is not implemented for this optimizer yet.")})})},Optimizer.prototype.setWeights=function(weightValues){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(_a){throw new Error("setWeights() is not implemented for this optimizer class "+this.getClassName())})})},Optimizer.prototype.extractIterations=function(weightValues){return __awaiter(this,void 0,void 0,function(){var _a;return __generator(this,function(_b){switch(_b.label){case 0:return _a=this,[4,weightValues[0].tensor.data()];case 1:return _a.iterations_=_b.sent()[0],[2,weightValues.slice(1)]}})})},Optimizer}(require("../serialization").Serializable);exports.Optimizer=Optimizer,Object.defineProperty(Optimizer,Symbol.hasInstance,{value:function(instance){return null!=instance.minimize&&null!=instance.computeGradients&&null!=instance.applyGradients}})},{"../globals":146,"../gradients":147,"../ops/ops":196,"../serialization":232}],226:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var adadelta_optimizer_1=require("./adadelta_optimizer"),adagrad_optimizer_1=require("./adagrad_optimizer"),adam_optimizer_1=require("./adam_optimizer"),adamax_optimizer_1=require("./adamax_optimizer"),momentum_optimizer_1=require("./momentum_optimizer"),rmsprop_optimizer_1=require("./rmsprop_optimizer"),sgd_optimizer_1=require("./sgd_optimizer"),OptimizerConstructors=function(){function OptimizerConstructors(){}return OptimizerConstructors.sgd=function(learningRate){return new sgd_optimizer_1.SGDOptimizer(learningRate)},OptimizerConstructors.momentum=function(learningRate,momentum,useNesterov){return void 0===useNesterov&&(useNesterov=!1),new momentum_optimizer_1.MomentumOptimizer(learningRate,momentum,useNesterov)},OptimizerConstructors.rmsprop=function(learningRate,decay,momentum,epsilon,centered){return void 0===decay&&(decay=.9),void 0===momentum&&(momentum=0),void 0===epsilon&&(epsilon=null),void 0===centered&&(centered=!1),new rmsprop_optimizer_1.RMSPropOptimizer(learningRate,decay,momentum,epsilon,centered)},OptimizerConstructors.adam=function(learningRate,beta1,beta2,epsilon){return void 0===learningRate&&(learningRate=.001),void 0===beta1&&(beta1=.9),void 0===beta2&&(beta2=.999),void 0===epsilon&&(epsilon=null),new adam_optimizer_1.AdamOptimizer(learningRate,beta1,beta2,epsilon)},OptimizerConstructors.adadelta=function(learningRate,rho,epsilon){return void 0===learningRate&&(learningRate=.001),void 0===rho&&(rho=.95),void 0===epsilon&&(epsilon=null),new adadelta_optimizer_1.AdadeltaOptimizer(learningRate,rho,epsilon)},OptimizerConstructors.adamax=function(learningRate,beta1,beta2,epsilon,decay){return void 0===learningRate&&(learningRate=.002),void 0===beta1&&(beta1=.9),void 0===beta2&&(beta2=.999),void 0===epsilon&&(epsilon=null),void 0===decay&&(decay=0),new adamax_optimizer_1.AdamaxOptimizer(learningRate,beta1,beta2,epsilon,decay)},OptimizerConstructors.adagrad=function(learningRate,initialAccumulatorValue){return void 0===initialAccumulatorValue&&(initialAccumulatorValue=.1),new adagrad_optimizer_1.AdagradOptimizer(learningRate,initialAccumulatorValue)},OptimizerConstructors}();exports.OptimizerConstructors=OptimizerConstructors},{"./adadelta_optimizer":220,"./adagrad_optimizer":221,"./adam_optimizer":222,"./adamax_optimizer":223,"./momentum_optimizer":224,"./rmsprop_optimizer":227,"./sgd_optimizer":228}],227:[function(require,module,exports){"use strict";var extendStatics,__extends=this&&this.__extends||(extendStatics=function(d,b){return(extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p])})(d,b)},function(d,b){function __(){this.constructor=d}extendStatics(d,b),d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)}),__awaiter=this&&this.__awaiter||function(thisArg,_arguments,P,generator){return new(P=P||Promise)(function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){result.done?resolve(result.value):new P(function(resolve){resolve(result.value)}).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())})},__generator=this&&this.__generator||function(thisArg,body){var f,y,t,g,_={label:0,sent:function(){if(1&t[0])throw t[1];return t[1]},trys:[],ops:[]};return g={next:verb(0),throw:verb(1),return:verb(2)},"function"==typeof Symbol&&(g[Symbol.iterator]=function(){return this}),g;function verb(n){return function(v){return function(op){if(f)throw new TypeError("Generator is already executing.");for(;_;)try{if(f=1,y&&(t=2&op[0]?y.return:op[0]?y.throw||((t=y.return)&&t.call(y),0):y.next)&&!(t=t.call(y,op[1])).done)return t;switch(y=0,t&&(op=[2&op[0],t.value]),op[0]){case 0:case 1:t=op;break;case 4:return _.label++,{value:op[1],done:!1};case 5:_.label++,y=op[1],op=[0];continue;case 7:op=_.ops.pop(),_.trys.pop();continue;default:if(!(t=0<(t=_.trys).length&&t[t.length-1])&&(6===op[0]||2===op[0])){_=0;continue}if(3===op[0]&&(!t||op[1]>t[0]&&op[1]<t[3])){_.label=op[1];break}if(6===op[0]&&_.label<t[1]){_.label=t[1],t=op;break}if(t&&_.label<t[2]){_.label=t[2],_.ops.push(op);break}t[2]&&_.ops.pop(),_.trys.pop();continue}op=body.call(thisArg,_)}catch(e){op=[6,e],y=0}finally{f=t=0}if(5&op[0])throw op[1];return{value:op[0]?op[1]:void 0,done:!0}}([n,v])}}};Object.defineProperty(exports,"__esModule",{value:!0});var engine_1=require("../engine"),globals_1=require("../globals"),ops_1=require("../ops/ops"),serialization_1=require("../serialization"),RMSPropOptimizer=function(_super){function RMSPropOptimizer(learningRate,decay,momentum,epsilon,centered){void 0===decay&&(decay=.9),void 0===momentum&&(momentum=0),void 0===epsilon&&(epsilon=null),void 0===centered&&(centered=!1);var _this=_super.call(this)||this;return _this.learningRate=learningRate,_this.decay=decay,_this.momentum=momentum,_this.epsilon=epsilon,_this.accumulatedMeanSquares=[],_this.accumulatedMoments=[],_this.accumulatedMeanGrads=[],_this.centered=centered,null==epsilon&&(_this.epsilon=engine_1.ENGINE.backend.epsilon()),_this}return __extends(RMSPropOptimizer,_super),RMSPropOptimizer.prototype.applyGradients=function(variableGradients){var _this=this;(Array.isArray(variableGradients)?variableGradients.map(function(item){return item.name}):Object.keys(variableGradients)).forEach(function(name,i){var value=engine_1.ENGINE.registeredVariables[name];null==_this.accumulatedMeanSquares[i]&&(_this.accumulatedMeanSquares[i]={originalName:name+"/rms",variable:globals_1.tidy(function(){return ops_1.zerosLike(value).variable(!1)})}),null==_this.accumulatedMoments[i]&&(_this.accumulatedMoments[i]={originalName:name+"/momentum",variable:globals_1.tidy(function(){return ops_1.zerosLike(value).variable(!1)})}),null==_this.accumulatedMeanGrads[i]&&_this.centered&&(_this.accumulatedMeanGrads[i]={originalName:name+"/mg",variable:globals_1.tidy(function(){return ops_1.zerosLike(value).variable(!1)})});var gradient=Array.isArray(variableGradients)?variableGradients[i].tensor:variableGradients[name];if(null!=gradient){var accumulatedMeanSquare=_this.accumulatedMeanSquares[i].variable,accumulatedMoments=_this.accumulatedMoments[i].variable;globals_1.tidy(function(){var newAccumulatedMeanSquare=accumulatedMeanSquare.mul(_this.decay).add(gradient.square().mul(1-_this.decay));if(_this.centered){var accumulatedMeanGrad=_this.accumulatedMeanGrads[i].variable,newAccumulatedMeanGrad=accumulatedMeanGrad.mul(_this.decay).add(gradient.mul(1-_this.decay)),newAccumulatedMoments=accumulatedMoments.mul(_this.momentum).add(gradient.mul(_this.learningRate).div(newAccumulatedMeanSquare.sub(newAccumulatedMeanGrad.square().add(_this.epsilon)).sqrt()));accumulatedMeanSquare.assign(newAccumulatedMeanSquare),accumulatedMeanGrad.assign(newAccumulatedMeanGrad),accumulatedMoments.assign(newAccumulatedMoments);var newValue=value.sub(newAccumulatedMoments);value.assign(newValue)}else{var newAccumulatedMeanSquare_1=accumulatedMeanSquare.mul(_this.decay).add(gradient.square().mul(1-_this.decay));newAccumulatedMoments=accumulatedMoments.mul(_this.momentum).add(gradient.mul(_this.learningRate).div(newAccumulatedMeanSquare_1.add(_this.epsilon).sqrt()));accumulatedMeanSquare.assign(newAccumulatedMeanSquare_1),accumulatedMoments.assign(newAccumulatedMoments);newValue=value.sub(newAccumulatedMoments);value.assign(newValue)}})}}),this.incrementIterations()},RMSPropOptimizer.prototype.dispose=function(){null!=this.accumulatedMeanSquares&&globals_1.dispose(this.accumulatedMeanSquares.map(function(v){return v.variable})),null!=this.accumulatedMeanGrads&&this.centered&&globals_1.dispose(this.accumulatedMeanGrads.map(function(v){return v.variable})),null!=this.accumulatedMoments&&globals_1.dispose(this.accumulatedMoments.map(function(v){return v.variable}))},RMSPropOptimizer.prototype.getWeights=function(){return __awaiter(this,void 0,void 0,function(){var variables;return __generator(this,function(_a){switch(_a.label){case 0:return variables=this.accumulatedMeanSquares.concat(this.accumulatedMoments),this.centered&&variables.push.apply(variables,this.accumulatedMeanGrads),[4,this.saveIterations()];case 1:return[2,[_a.sent()].concat(variables.map(function(v){return{name:v.originalName,tensor:v.variable}}))]}})})},RMSPropOptimizer.prototype.setWeights=function(weightValues){return __awaiter(this,void 0,void 0,function(){var variableCount;return __generator(this,function(_a){switch(_a.label){case 0:return[4,this.extractIterations(weightValues)];case 1:return weightValues=_a.sent(),variableCount=this.centered?weightValues.length/3:weightValues.length/2,!1,this.accumulatedMeanSquares=weightValues.slice(0,variableCount).map(function(v){return{originalName:v.name,variable:v.tensor.variable(!1)}}),this.accumulatedMoments=weightValues.slice(variableCount,2*variableCount).map(function(v){return{originalName:v.name,variable:v.tensor.variable(!1)}}),this.centered&&(this.accumulatedMeanGrads=weightValues.slice(2*variableCount,3*variableCount).map(function(v){return{originalName:v.name,variable:v.tensor.variable(!1)}})),[2]}})})},RMSPropOptimizer.prototype.getConfig=function(){return{learningRate:this.learningRate,decay:this.decay,momentum:this.momentum,epsilon:this.epsilon,centered:this.centered}},RMSPropOptimizer.fromConfig=function(cls,config){return new cls(config.learningRate,config.decay,config.momentum,config.epsilon,config.centered)},RMSPropOptimizer.className="RMSProp",RMSPropOptimizer}(require("./optimizer").Optimizer);exports.RMSPropOptimizer=RMSPropOptimizer,serialization_1.registerClass(RMSPropOptimizer)},{"../engine":143,"../globals":146,"../ops/ops":196,"../serialization":232,"./optimizer":225}],228:[function(require,module,exports){"use strict";var extendStatics,__extends=this&&this.__extends||(extendStatics=function(d,b){return(extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p])})(d,b)},function(d,b){function __(){this.constructor=d}extendStatics(d,b),d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)}),__awaiter=this&&this.__awaiter||function(thisArg,_arguments,P,generator){return new(P=P||Promise)(function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){result.done?resolve(result.value):new P(function(resolve){resolve(result.value)}).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())})},__generator=this&&this.__generator||function(thisArg,body){var f,y,t,g,_={label:0,sent:function(){if(1&t[0])throw t[1];return t[1]},trys:[],ops:[]};return g={next:verb(0),throw:verb(1),return:verb(2)},"function"==typeof Symbol&&(g[Symbol.iterator]=function(){return this}),g;function verb(n){return function(v){return function(op){if(f)throw new TypeError("Generator is already executing.");for(;_;)try{if(f=1,y&&(t=2&op[0]?y.return:op[0]?y.throw||((t=y.return)&&t.call(y),0):y.next)&&!(t=t.call(y,op[1])).done)return t;switch(y=0,t&&(op=[2&op[0],t.value]),op[0]){case 0:case 1:t=op;break;case 4:return _.label++,{value:op[1],done:!1};case 5:_.label++,y=op[1],op=[0];continue;case 7:op=_.ops.pop(),_.trys.pop();continue;default:if(!(t=0<(t=_.trys).length&&t[t.length-1])&&(6===op[0]||2===op[0])){_=0;continue}if(3===op[0]&&(!t||op[1]>t[0]&&op[1]<t[3])){_.label=op[1];break}if(6===op[0]&&_.label<t[1]){_.label=t[1],t=op;break}if(t&&_.label<t[2]){_.label=t[2],_.ops.push(op);break}t[2]&&_.ops.pop(),_.trys.pop();continue}op=body.call(thisArg,_)}catch(e){op=[6,e],y=0}finally{f=t=0}if(5&op[0])throw op[1];return{value:op[0]?op[1]:void 0,done:!0}}([n,v])}}};Object.defineProperty(exports,"__esModule",{value:!0});var engine_1=require("../engine"),globals_1=require("../globals"),ops_1=require("../ops/ops"),serialization_1=require("../serialization"),SGDOptimizer=function(_super){function SGDOptimizer(learningRate){var _this=_super.call(this)||this;return _this.learningRate=learningRate,_this.setLearningRate(learningRate),_this}return __extends(SGDOptimizer,_super),SGDOptimizer.prototype.applyGradients=function(variableGradients){var _this=this;(Array.isArray(variableGradients)?variableGradients.map(function(v){return v.name}):Object.keys(variableGradients)).forEach(function(name,i){var gradient=Array.isArray(variableGradients)?variableGradients[i].tensor:variableGradients[name];if(null!=gradient){var value=engine_1.ENGINE.registeredVariables[name];globals_1.tidy(function(){var newValue=_this.c.mul(gradient).add(value);value.assign(newValue)})}}),this.incrementIterations()},SGDOptimizer.prototype.setLearningRate=function(learningRate){this.learningRate=learningRate,null!=this.c&&this.c.dispose(),this.c=globals_1.keep(ops_1.scalar(-learningRate))},SGDOptimizer.prototype.dispose=function(){this.c.dispose()},SGDOptimizer.prototype.getWeights=function(){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(_a){switch(_a.label){case 0:return[4,this.saveIterations()];case 1:return[2,[_a.sent()]]}})})},SGDOptimizer.prototype.setWeights=function(weightValues){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(_a){switch(_a.label){case 0:return[4,this.extractIterations(weightValues)];case 1:if(0!==(weightValues=_a.sent()).length)throw new Error("SGD optimizer does not have settable weights.");return[2]}})})},SGDOptimizer.prototype.getConfig=function(){return{learningRate:this.learningRate}},SGDOptimizer.fromConfig=function(cls,config){return new cls(config.learningRate)},SGDOptimizer.className="SGD",SGDOptimizer}(require("./optimizer").Optimizer);exports.SGDOptimizer=SGDOptimizer,serialization_1.registerClass(SGDOptimizer)},{"../engine":143,"../globals":146,"../ops/ops":196,"../serialization":232,"./optimizer":225}],229:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var environment_1=require("../environment"),PlatformBrowser=function(){function PlatformBrowser(){this.textEncoder=new TextEncoder}return PlatformBrowser.prototype.fetch=function(path,init){return fetch(path,init)},PlatformBrowser.prototype.now=function(){return performance.now()},PlatformBrowser.prototype.encode=function(text,encoding){if("utf-8"!==encoding&&"utf8"!==encoding)throw new Error("Browser's encoder only supports utf-8, but got "+encoding);return this.textEncoder.encode(text)},PlatformBrowser.prototype.decode=function(bytes,encoding){return new TextDecoder(encoding).decode(bytes)},PlatformBrowser}();exports.PlatformBrowser=PlatformBrowser,environment_1.ENV.get("IS_BROWSER")&&environment_1.ENV.setPlatform("browser",new PlatformBrowser)},{"../environment":144}],230:[function(require,module,exports){(function(process){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var environment_1=require("../environment");exports.getNodeFetch={importFetch:function(){return require("node-fetch")}};var PlatformNode=function(){function PlatformNode(){this.util=require("util"),this.textEncoder=new this.util.TextEncoder}return PlatformNode.prototype.fetch=function(path,requestInits){return null!=environment_1.ENV.global.fetch?environment_1.ENV.global.fetch(path,requestInits):(null==exports.systemFetch&&(exports.systemFetch=exports.getNodeFetch.importFetch()),exports.systemFetch(path,requestInits))},PlatformNode.prototype.now=function(){var time=process.hrtime();return 1e3*time[0]+time[1]/1e6},PlatformNode.prototype.encode=function(text,encoding){if("utf-8"!==encoding&&"utf8"!==encoding)throw new Error("Node built-in encoder only supports utf-8, but got "+encoding);return this.textEncoder.encode(text)},PlatformNode.prototype.decode=function(bytes,encoding){return 0===bytes.length?"":new this.util.TextDecoder(encoding).decode(bytes)},PlatformNode}();exports.PlatformNode=PlatformNode,environment_1.ENV.get("IS_NODE")&&environment_1.ENV.setPlatform("node",new PlatformNode)}).call(this,require("_process"))},{"../environment":144,_process:337,"node-fetch":333,util:333}],231:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var util=require("./util"),Profiler=function(){function Profiler(backendTimer,logger){this.backendTimer=backendTimer,null==(this.logger=logger)&&(this.logger=new Logger)}return Profiler.prototype.profileKernel=function(name,inputs,f){var result,_this=this,timer=this.backendTimer.time(function(){result=f()});return(Array.isArray(result)?result:[result]).forEach(function(r){var vals=r.dataSync();util.checkComputationForErrors(vals,r.dtype,name),timer.then(function(timing){var extraInfo="";null!=timing.getExtraProfileInfo&&(extraInfo=timing.getExtraProfileInfo()),_this.logger.logKernelProfile(name,r,vals,timing.kernelMs,inputs,extraInfo)})}),result},Profiler}();exports.Profiler=Profiler;var Logger=function(){function Logger(){}return Logger.prototype.logKernelProfile=function(name,result,vals,timeMs,inputs,extraInfo){var time=util.rightPad(timeMs+"ms",9),paddedName=util.rightPad(name,25),rank=result.rank,size=result.size,shape=util.rightPad(result.shape.toString(),14),inputShapesDescription="";for(var name_1 in inputs){var inputShape=inputs[name_1].shape,inputRank=inputShape.length;inputShapesDescription+=name_1+": "+inputRank+"D "+(0<inputRank?inputShape:"")+" "}console.log("%c"+paddedName+"\t%c"+time+"\t%c"+rank+"D "+shape+"\t%c"+size+"\t%c"+inputShapesDescription+"\t%c"+extraInfo,"font-weight:bold","color:red","color:blue","color: orange","color: green","color: steelblue")},Logger}();exports.Logger=Logger},{"./util":241}],232:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var util_1=require("./util"),Serializable=function(){function Serializable(){}return Serializable.prototype.getClassName=function(){return this.constructor.className},Serializable.fromConfig=function(cls,config){return new cls(config)},Serializable}();exports.Serializable=Serializable;var SerializationMap=function(){function SerializationMap(){this.classNameMap={}}return SerializationMap.getMap=function(){return null==SerializationMap.instance&&(SerializationMap.instance=new SerializationMap),SerializationMap.instance},SerializationMap.register=function(cls){SerializationMap.getMap().classNameMap[cls.className]=[cls,cls.fromConfig]},SerializationMap}();exports.SerializationMap=SerializationMap,exports.registerClass=function(cls){util_1.assert(null!=cls.className,function(){return"Class being registered does not have the static className property defined."}),util_1.assert("string"==typeof cls.className,function(){return"className is required to be a string, but got type "+typeof cls.className}),util_1.assert(0<cls.className.length,function(){return"Class being registered has an empty-string as its className, which is disallowed."}),SerializationMap.register(cls)}},{"./util":241}],233:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var tensor_1=require("./tensor"),util=require("./util");exports.getFilteredNodesXToY=function(tape,xs,y){for(var tensorsFromX={},nodesFromX={},i=0;i<xs.length;i++)tensorsFromX[xs[i].id]=!0;for(i=0;i<tape.length;i++){var nodeInputs=(node=tape[i]).inputs;for(var inputName in nodeInputs){for(var input=nodeInputs[inputName],anyInputFromX=!1,j=0;j<xs.length;j++)if(tensorsFromX[input.id]){node.outputs.forEach(function(output){return tensorsFromX[output.id]=!0}),anyInputFromX=!0,nodesFromX[node.id]=!0;break}if(anyInputFromX)break}}var tensorsLeadToY={};tensorsLeadToY[y.id]=!0;var nodesToY={};for(i=tape.length-1;0<=i;i--)for(nodeInputs=(node=tape[i]).inputs,j=0;j<node.outputs.length;j++)if(tensorsLeadToY[node.outputs[j].id]){for(var inputName in nodeInputs)tensorsLeadToY[nodeInputs[inputName].id]=!0,nodesToY[node.id]=!0;break}var filteredTape=[];for(i=0;i<tape.length;i++){var node;if(nodesFromX[(node=tape[i]).id]&&nodesToY[node.id]){var prunedInputs={};for(var inputName in node.inputs){var nodeInput=node.inputs[inputName];tensorsFromX[nodeInput.id]&&(prunedInputs[inputName]=nodeInput)}var prunedNode=Object.assign({},node);prunedNode.inputs=prunedInputs,prunedNode.outputs=node.outputs,filteredTape.push(prunedNode)}}return filteredTape},exports.backpropagateGradients=function(tensorAccumulatedGradientMap,filteredTape,tidy){for(var _loop_1=function(i){var node=filteredTape[i],dys=[];if(node.outputs.forEach(function(o){var gradTensor=tensorAccumulatedGradientMap[o.id];if(null!=gradTensor)dys.push(gradTensor);else{var dy=tensor_1.Tensor.make(o.shape,{values:util.makeZerosTypedArray(o.size,o.dtype)},o.dtype);dys.push(dy)}}),null==node.gradient)throw new Error("Cannot compute gradient: gradient function not found for "+node.name+".");function _loop_2(inputName){if(!(inputName in inputGradients))throw new Error("Cannot backprop through input "+inputName+". Available gradients found: "+Object.keys(inputGradients)+".");var dx=tidy(function(){return inputGradients[inputName]()});if("float32"!==dx.dtype)throw new Error("Error in gradient for op "+node.name+". The gradient of input "+inputName+" must have 'float32' dtype, but has '"+dx.dtype+"'");var x=node.inputs[inputName];if(!util.arraysEqual(dx.shape,x.shape))throw new Error("Error in gradient for op "+node.name+". The gradient of input '"+inputName+"' has shape '"+dx.shape+"', which does not match the shape of the input '"+x.shape+"'");if(null==tensorAccumulatedGradientMap[x.id])tensorAccumulatedGradientMap[x.id]=dx;else{var curGradient=tensorAccumulatedGradientMap[x.id];tensorAccumulatedGradientMap[x.id]=curGradient.add(dx),curGradient.dispose()}}var inputGradients=node.gradient(1===node.outputs.length?dys[0]:dys);for(var inputName in node.inputs)_loop_2(inputName)},i=filteredTape.length-1;0<=i;i--)_loop_1(i)}},{"./tensor":234,"./util":241}],234:[function(require,module,exports){"use strict";var extendStatics,__extends=this&&this.__extends||(extendStatics=function(d,b){return(extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p])})(d,b)},function(d,b){function __(){this.constructor=d}extendStatics(d,b),d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)}),__awaiter=this&&this.__awaiter||function(thisArg,_arguments,P,generator){return new(P=P||Promise)(function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){result.done?resolve(result.value):new P(function(resolve){resolve(result.value)}).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())})},__generator=this&&this.__generator||function(thisArg,body){var f,y,t,g,_={label:0,sent:function(){if(1&t[0])throw t[1];return t[1]},trys:[],ops:[]};return g={next:verb(0),throw:verb(1),return:verb(2)},"function"==typeof Symbol&&(g[Symbol.iterator]=function(){return this}),g;function verb(n){return function(v){return function(op){if(f)throw new TypeError("Generator is already executing.");for(;_;)try{if(f=1,y&&(t=2&op[0]?y.return:op[0]?y.throw||((t=y.return)&&t.call(y),0):y.next)&&!(t=t.call(y,op[1])).done)return t;switch(y=0,t&&(op=[2&op[0],t.value]),op[0]){case 0:case 1:t=op;break;case 4:return _.label++,{value:op[1],done:!1};case 5:_.label++,y=op[1],op=[0];continue;case 7:op=_.ops.pop(),_.trys.pop();continue;default:if(!(t=0<(t=_.trys).length&&t[t.length-1])&&(6===op[0]||2===op[0])){_=0;continue}if(3===op[0]&&(!t||op[1]>t[0]&&op[1]<t[3])){_.label=op[1];break}if(6===op[0]&&_.label<t[1]){_.label=t[1],t=op;break}if(t&&_.label<t[2]){_.label=t[2],_.ops.push(op);break}t[2]&&_.ops.pop(),_.trys.pop();continue}op=body.call(thisArg,_)}catch(e){op=[6,e],y=0}finally{f=t=0}if(5&op[0])throw op[1];return{value:op[0]?op[1]:void 0,done:!0}}([n,v])}}};Object.defineProperty(exports,"__esModule",{value:!0});var tensor_format_1=require("./tensor_format"),util=require("./util"),util_1=require("./util"),TensorBuffer=function(){function TensorBuffer(shape,dtype,values){var _this=this;if(this.dtype=dtype,this.shape=shape.slice(),this.size=util.sizeFromShape(shape),null!=values){var n_1=values.length;util.assert(n_1===this.size,function(){return"Length of values '"+n_1+"' does not match the size inferred by the shape '"+_this.size+"'."})}if("complex64"===dtype)throw new Error("complex64 dtype TensorBuffers are not supported. Please create a TensorBuffer for the real and imaginary parts separately and call tf.complex(real, imag).");this.values=values||util.getArrayFromDType(dtype,this.size),this.strides=util_1.computeStrides(shape)}return TensorBuffer.prototype.set=function(value){for(var _this=this,locs=[],_i=1;_i<arguments.length;_i++)locs[_i-1]=arguments[_i];0===locs.length&&(locs=[0]),util.assert(locs.length===this.rank,function(){return"The number of provided coordinates ("+locs.length+") must match the rank ("+_this.rank+")"});var index=this.locToIndex(locs);this.values[index]=value},TensorBuffer.prototype.get=function(){for(var locs=[],_i=0;_i<arguments.length;_i++)locs[_i]=arguments[_i];0===locs.length&&(locs=[0]);for(var i=0,_a=0,locs_1=locs;_a<locs_1.length;_a++){var loc=locs_1[_a];if(loc<0||loc>=this.shape[i]){var msg="Requested out of range element at "+locs+".   Buffer shape="+this.shape;throw new Error(msg)}i++}for(var index=locs[locs.length-1],i_1=0;i_1<locs.length-1;++i_1)index+=this.strides[i_1]*locs[i_1];return this.values[index]},TensorBuffer.prototype.locToIndex=function(locs){if(0===this.rank)return 0;if(1===this.rank)return locs[0];for(var index=locs[locs.length-1],i=0;i<locs.length-1;++i)index+=this.strides[i]*locs[i];return index},TensorBuffer.prototype.indexToLoc=function(index){if(0===this.rank)return[];if(1===this.rank)return[index];for(var locs=new Array(this.shape.length),i=0;i<locs.length-1;++i)locs[i]=Math.floor(index/this.strides[i]),index-=locs[i]*this.strides[i];return locs[locs.length-1]=index,locs},Object.defineProperty(TensorBuffer.prototype,"rank",{get:function(){return this.shape.length},enumerable:!0,configurable:!0}),TensorBuffer.prototype.toTensor=function(){return Tensor.make(this.shape,{values:this.values},this.dtype)},TensorBuffer}();exports.TensorBuffer=TensorBuffer;var trackerFn=null,opHandler=null,deprecationWarningFn=null;exports.setTensorTracker=function(fn){trackerFn=fn},exports.setOpHandler=function(handler){opHandler=handler},exports.setDeprecationWarningFn=function(fn){deprecationWarningFn=fn};var Tensor=function(){function Tensor(shape,dtype,values,dataId,backend){this.kept=!1,this.isDisposedInternal=!1,this.shape=shape.slice(),this.dtype=dtype||"float32",this.size=util.sizeFromShape(shape),this.strides=util_1.computeStrides(shape),this.dataId=null!=dataId?dataId:{},this.id=trackerFn().nextTensorId(),this.rankType=this.rank<5?this.rank.toString():"higher",trackerFn().registerTensor(this,backend),null!=values&&trackerFn().write(backend,this.dataId,values)}return Tensor.make=function(shape,data,dtype,backend){var backendVals=data.values;return null!=data.values&&"string"===dtype&&util.isString(data.values[0])&&(backendVals=data.values.map(function(d){return util.encodeString(d)})),new Tensor(shape,dtype,backendVals,data.dataId,backend)},Tensor.prototype.flatten=function(){return this.throwIfDisposed(),this.as1D()},Tensor.prototype.asScalar=function(){return this.throwIfDisposed(),util.assert(1===this.size,function(){return"The array must have only 1 element."}),this.reshape([])},Tensor.prototype.as1D=function(){return this.throwIfDisposed(),this.reshape([this.size])},Tensor.prototype.as2D=function(rows,columns){return this.throwIfDisposed(),this.reshape([rows,columns])},Tensor.prototype.as3D=function(rows,columns,depth){return this.throwIfDisposed(),this.reshape([rows,columns,depth])},Tensor.prototype.as4D=function(rows,columns,depth,depth2){return this.throwIfDisposed(),this.reshape([rows,columns,depth,depth2])},Tensor.prototype.as5D=function(rows,columns,depth,depth2,depth3){return this.throwIfDisposed(),this.reshape([rows,columns,depth,depth2,depth3])},Tensor.prototype.asType=function(dtype){return this.throwIfDisposed(),opHandler.cast(this,dtype)},Object.defineProperty(Tensor.prototype,"rank",{get:function(){return this.shape.length},enumerable:!0,configurable:!0}),Tensor.prototype.buffer=function(){return __awaiter(this,void 0,void 0,function(){var vals;return __generator(this,function(_a){switch(_a.label){case 0:return[4,this.data()];case 1:return vals=_a.sent(),[2,opHandler.buffer(this.shape,this.dtype,vals)]}})})},Tensor.prototype.bufferSync=function(){return opHandler.buffer(this.shape,this.dtype,this.dataSync())},Tensor.prototype.array=function(){return __awaiter(this,void 0,void 0,function(){var vals;return __generator(this,function(_a){switch(_a.label){case 0:return[4,this.data()];case 1:return vals=_a.sent(),[2,util_1.toNestedArray(this.shape,vals)]}})})},Tensor.prototype.arraySync=function(){return util_1.toNestedArray(this.shape,this.dataSync())},Tensor.prototype.data=function(){return __awaiter(this,void 0,void 0,function(){var data,bytes;return __generator(this,function(_a){switch(_a.label){case 0:return this.throwIfDisposed(),data=trackerFn().read(this.dataId),"string"!==this.dtype?[3,2]:[4,data];case 1:bytes=_a.sent();try{return[2,bytes.map(function(b){return util.decodeString(b)})]}catch(_b){throw new Error("Failed to decode the string bytes into utf-8. To get the original bytes, call tensor.bytes().")}_a.label=2;case 2:return[2,data]}})})},Tensor.prototype.dataSync=function(){this.throwIfDisposed();var data=trackerFn().readSync(this.dataId);if("string"===this.dtype)try{return data.map(function(b){return util.decodeString(b)})}catch(_a){throw new Error("Failed to decode the string bytes into utf-8. To get the original bytes, call tensor.bytes().")}return data},Tensor.prototype.bytes=function(){return __awaiter(this,void 0,void 0,function(){var data;return __generator(this,function(_a){switch(_a.label){case 0:return this.throwIfDisposed(),[4,trackerFn().read(this.dataId)];case 1:return data=_a.sent(),"string"===this.dtype?[2,data]:[2,new Uint8Array(data.buffer)]}})})},Tensor.prototype.dispose=function(){this.isDisposed||(trackerFn().disposeTensor(this),this.isDisposedInternal=!0)},Object.defineProperty(Tensor.prototype,"isDisposed",{get:function(){return this.isDisposedInternal},enumerable:!0,configurable:!0}),Tensor.prototype.throwIfDisposed=function(){if(this.isDisposed)throw new Error("Tensor is disposed.")},Tensor.prototype.toFloat=function(){return this.asType("float32")},Tensor.prototype.toInt=function(){return this.asType("int32")},Tensor.prototype.toBool=function(){return this.asType("bool")},Tensor.prototype.print=function(verbose){return void 0===verbose&&(verbose=!1),opHandler.print(this,verbose)},Tensor.prototype.reshape=function(newShape){return this.throwIfDisposed(),opHandler.reshape(this,newShape)},Tensor.prototype.reshapeAs=function(x){return this.throwIfDisposed(),this.reshape(x.shape)},Tensor.prototype.expandDims=function(axis){return void 0===axis&&(axis=0),opHandler.expandDims(this,axis)},Tensor.prototype.cumsum=function(axis,exclusive,reverse){return void 0===axis&&(axis=0),void 0===exclusive&&(exclusive=!1),void 0===reverse&&(reverse=!1),opHandler.cumsum(this,axis,exclusive,reverse)},Tensor.prototype.squeeze=function(axis){return this.throwIfDisposed(),opHandler.squeeze(this,axis)},Tensor.prototype.clone=function(){return this.throwIfDisposed(),opHandler.clone(this)},Tensor.prototype.oneHot=function(depth,onValue,offValue){return this.throwIfDisposed(),opHandler.oneHot(this,depth,onValue,offValue)},Tensor.prototype.toString=function(verbose){void 0===verbose&&(verbose=!1);var vals=this.dataSync();return tensor_format_1.tensorToString(vals,this.shape,this.dtype,verbose)},Tensor.prototype.tile=function(reps){return this.throwIfDisposed(),opHandler.tile(this,reps)},Tensor.prototype.gather=function(indices,axis){return void 0===axis&&(axis=0),this.throwIfDisposed(),opHandler.gather(this,indices,axis)},Tensor.prototype.matMul=function(b,transposeA,transposeB){return void 0===transposeA&&(transposeA=!1),void 0===transposeB&&(transposeB=!1),this.throwIfDisposed(),opHandler.matMul(this,b,transposeA,transposeB)},Tensor.prototype.dot=function(b){return this.throwIfDisposed(),opHandler.dot(this,b)},Tensor.prototype.norm=function(ord,axis,keepDims){return void 0===ord&&(ord="euclidean"),void 0===axis&&(axis=null),void 0===keepDims&&(keepDims=!1),this.throwIfDisposed(),opHandler.norm(this,ord,axis,keepDims)},Tensor.prototype.slice=function(begin,size){return this.throwIfDisposed(),opHandler.slice(this,begin,size)},Tensor.prototype.reverse=function(axis){return this.throwIfDisposed(),opHandler.reverse(this,axis)},Tensor.prototype.concat=function(x,axis){return void 0===axis&&(axis=0),this.throwIfDisposed(),x instanceof Tensor&&(x=[x]),opHandler.concat([this].concat(x),axis)},Tensor.prototype.split=function(numOrSizeSplits,axis){return void 0===axis&&(axis=0),this.throwIfDisposed(),opHandler.split(this,numOrSizeSplits,axis)},Tensor.prototype.stack=function(x,axis){return void 0===axis&&(axis=0),opHandler.stack([this,x],axis)},Tensor.prototype.unstack=function(axis){return void 0===axis&&(axis=0),opHandler.unstack(this,axis)},Tensor.prototype.pad=function(paddings,constantValue){return void 0===constantValue&&(constantValue=0),opHandler.pad(this,paddings,constantValue)},Tensor.prototype.batchNormalization=function(mean,variance,varianceEpsilon,scale,offset){return void 0===varianceEpsilon&&(varianceEpsilon=.001),deprecationWarningFn("tf.batchNormalization() is going away. Use tf.batchNorm() instead, and note the positional argument change of scale, offset, and varianceEpsilon"),this.batchNorm(mean,variance,offset,scale,varianceEpsilon)},Tensor.prototype.batchNorm=function(mean,variance,offset,scale,varianceEpsilon){return void 0===varianceEpsilon&&(varianceEpsilon=.001),this.throwIfDisposed(),opHandler.batchNorm(this,mean,variance,offset,scale,varianceEpsilon)},Tensor.prototype.all=function(axis,keepDims){return void 0===axis&&(axis=null),void 0===keepDims&&(keepDims=!1),this.throwIfDisposed(),opHandler.all(this,axis,keepDims)},Tensor.prototype.any=function(axis,keepDims){return void 0===axis&&(axis=null),void 0===keepDims&&(keepDims=!1),this.throwIfDisposed(),opHandler.any(this,axis,keepDims)},Tensor.prototype.logSumExp=function(axis,keepDims){return void 0===axis&&(axis=null),void 0===keepDims&&(keepDims=!1),this.throwIfDisposed(),opHandler.logSumExp(this,axis,keepDims)},Tensor.prototype.sum=function(axis,keepDims){return void 0===axis&&(axis=null),void 0===keepDims&&(keepDims=!1),this.throwIfDisposed(),opHandler.sum(this,axis,keepDims)},Tensor.prototype.prod=function(axis,keepDims){return void 0===axis&&(axis=null),void 0===keepDims&&(keepDims=!1),this.throwIfDisposed(),opHandler.prod(this,axis,keepDims)},Tensor.prototype.mean=function(axis,keepDims){return void 0===axis&&(axis=null),void 0===keepDims&&(keepDims=!1),this.throwIfDisposed(),opHandler.mean(this,axis,keepDims)},Tensor.prototype.min=function(axis,keepDims){return void 0===axis&&(axis=null),void 0===keepDims&&(keepDims=!1),this.throwIfDisposed(),opHandler.min(this,axis,keepDims)},Tensor.prototype.max=function(axis,keepDims){return void 0===axis&&(axis=null),void 0===keepDims&&(keepDims=!1),this.throwIfDisposed(),opHandler.max(this,axis,keepDims)},Tensor.prototype.argMin=function(axis){return void 0===axis&&(axis=null),this.throwIfDisposed(),opHandler.argMin(this,axis)},Tensor.prototype.argMax=function(axis){return void 0===axis&&(axis=null),this.throwIfDisposed(),opHandler.argMax(this,axis)},Tensor.prototype.cast=function(dtype){return this.throwIfDisposed(),opHandler.cast(this,dtype)},Tensor.prototype.add=function(x){return this.throwIfDisposed(),opHandler.add(this,x)},Tensor.prototype.addStrict=function(x){return this.throwIfDisposed(),opHandler.addStrict(this,x)},Tensor.prototype.atan2=function(x){return this.throwIfDisposed(),opHandler.atan2(this,x)},Tensor.prototype.sub=function(x){return this.throwIfDisposed(),opHandler.sub(this,x)},Tensor.prototype.subStrict=function(x){return this.throwIfDisposed(),opHandler.subStrict(this,x)},Tensor.prototype.pow=function(exp){return this.throwIfDisposed(),opHandler.pow(this,exp)},Tensor.prototype.powStrict=function(exp){return this.throwIfDisposed(),opHandler.powStrict(this,exp)},Tensor.prototype.mul=function(x){return this.throwIfDisposed(),opHandler.mul(this,x)},Tensor.prototype.mulStrict=function(x){return this.throwIfDisposed(),opHandler.mulStrict(this,x)},Tensor.prototype.div=function(x){return this.throwIfDisposed(),opHandler.div(this,x)},Tensor.prototype.floorDiv=function(x){return this.throwIfDisposed(),opHandler.floorDiv(this,x)},Tensor.prototype.divStrict=function(x){return this.throwIfDisposed(),opHandler.divStrict(this,x)},Tensor.prototype.minimum=function(x){return this.throwIfDisposed(),opHandler.minimum(this,x)},Tensor.prototype.minimumStrict=function(x){return this.throwIfDisposed(),opHandler.minimumStrict(this,x)},Tensor.prototype.maximum=function(x){return this.throwIfDisposed(),opHandler.maximum(this,x)},Tensor.prototype.maximumStrict=function(x){return this.throwIfDisposed(),opHandler.maximumStrict(this,x)},Tensor.prototype.mod=function(x){return this.throwIfDisposed(),opHandler.mod(this,x)},Tensor.prototype.modStrict=function(x){return this.throwIfDisposed(),opHandler.modStrict(this,x)},Tensor.prototype.squaredDifference=function(x){return this.throwIfDisposed(),opHandler.squaredDifference(this,x)},Tensor.prototype.squaredDifferenceStrict=function(x){return this.throwIfDisposed(),opHandler.squaredDifferenceStrict(this,x)},Tensor.prototype.transpose=function(perm){return this.throwIfDisposed(),opHandler.transpose(this,perm)},Tensor.prototype.notEqual=function(x){return this.throwIfDisposed(),opHandler.notEqual(this,x)},Tensor.prototype.notEqualStrict=function(x){return this.throwIfDisposed(),opHandler.notEqualStrict(this,x)},Tensor.prototype.less=function(x){return this.throwIfDisposed(),opHandler.less(this,x)},Tensor.prototype.lessStrict=function(x){return this.throwIfDisposed(),opHandler.lessStrict(this,x)},Tensor.prototype.equal=function(x){return this.throwIfDisposed(),opHandler.equal(this,x)},Tensor.prototype.equalStrict=function(x){return this.throwIfDisposed(),opHandler.equalStrict(this,x)},Tensor.prototype.lessEqual=function(x){return this.throwIfDisposed(),opHandler.lessEqual(this,x)},Tensor.prototype.lessEqualStrict=function(x){return this.throwIfDisposed(),opHandler.lessEqualStrict(this,x)},Tensor.prototype.greater=function(x){return this.throwIfDisposed(),opHandler.greater(this,x)},Tensor.prototype.greaterStrict=function(x){return this.throwIfDisposed(),opHandler.greaterStrict(this,x)},Tensor.prototype.greaterEqual=function(x){return this.throwIfDisposed(),opHandler.greaterEqual(this,x)},Tensor.prototype.greaterEqualStrict=function(x){return this.throwIfDisposed(),opHandler.greaterEqualStrict(this,x)},Tensor.prototype.logicalAnd=function(x){return this.throwIfDisposed(),opHandler.logicalAnd(this,x)},Tensor.prototype.logicalOr=function(x){return this.throwIfDisposed(),opHandler.logicalOr(this,x)},Tensor.prototype.logicalNot=function(){return this.throwIfDisposed(),opHandler.logicalNot(this)},Tensor.prototype.logicalXor=function(x){return this.throwIfDisposed(),opHandler.logicalXor(this,x)},Tensor.prototype.where=function(condition,x){return this.throwIfDisposed(),opHandler.where(condition,this,x)},Tensor.prototype.neg=function(){return this.throwIfDisposed(),opHandler.neg(this)},Tensor.prototype.ceil=function(){return this.throwIfDisposed(),opHandler.ceil(this)},Tensor.prototype.floor=function(){return this.throwIfDisposed(),opHandler.floor(this)},Tensor.prototype.sign=function(){return this.throwIfDisposed(),opHandler.sign(this)},Tensor.prototype.isNaN=function(){return this.throwIfDisposed(),opHandler.isNaN(this)},Tensor.prototype.isInf=function(){return this.throwIfDisposed(),opHandler.isInf(this)},Tensor.prototype.isFinite=function(){return this.throwIfDisposed(),opHandler.isFinite(this)},Tensor.prototype.exp=function(){return this.throwIfDisposed(),opHandler.exp(this)},Tensor.prototype.expm1=function(){return this.throwIfDisposed(),opHandler.expm1(this)},Tensor.prototype.log=function(){return this.throwIfDisposed(),opHandler.log(this)},Tensor.prototype.log1p=function(){return this.throwIfDisposed(),opHandler.log1p(this)},Tensor.prototype.sqrt=function(){return this.throwIfDisposed(),opHandler.sqrt(this)},Tensor.prototype.rsqrt=function(){return this.throwIfDisposed(),opHandler.rsqrt(this)},Tensor.prototype.square=function(){return this.throwIfDisposed(),opHandler.square(this)},Tensor.prototype.reciprocal=function(){return this.throwIfDisposed(),opHandler.reciprocal(this)},Tensor.prototype.abs=function(){return this.throwIfDisposed(),opHandler.abs(this)},Tensor.prototype.clipByValue=function(min,max){return this.throwIfDisposed(),opHandler.clipByValue(this,min,max)},Tensor.prototype.relu=function(){return this.throwIfDisposed(),opHandler.relu(this)},Tensor.prototype.elu=function(){return this.throwIfDisposed(),opHandler.elu(this)},Tensor.prototype.selu=function(){return this.throwIfDisposed(),opHandler.selu(this)},Tensor.prototype.leakyRelu=function(alpha){return void 0===alpha&&(alpha=.2),this.throwIfDisposed(),opHandler.leakyRelu(this,alpha)},Tensor.prototype.prelu=function(alpha){return this.throwIfDisposed(),opHandler.prelu(this,alpha)},Tensor.prototype.sigmoid=function(){return this.throwIfDisposed(),opHandler.sigmoid(this)},Tensor.prototype.logSigmoid=function(){return this.throwIfDisposed(),opHandler.logSigmoid(this)},Tensor.prototype.softplus=function(){return this.throwIfDisposed(),opHandler.softplus(this)},Tensor.prototype.zerosLike=function(){return this.throwIfDisposed(),opHandler.zerosLike(this)},Tensor.prototype.onesLike=function(){return this.throwIfDisposed(),opHandler.onesLike(this)},Tensor.prototype.sin=function(){return this.throwIfDisposed(),opHandler.sin(this)},Tensor.prototype.cos=function(){return this.throwIfDisposed(),opHandler.cos(this)},Tensor.prototype.tan=function(){return this.throwIfDisposed(),opHandler.tan(this)},Tensor.prototype.asin=function(){return this.throwIfDisposed(),opHandler.asin(this)},Tensor.prototype.acos=function(){return this.throwIfDisposed(),opHandler.acos(this)},Tensor.prototype.atan=function(){return this.throwIfDisposed(),opHandler.atan(this)},Tensor.prototype.sinh=function(){return this.throwIfDisposed(),opHandler.sinh(this)},Tensor.prototype.cosh=function(){return this.throwIfDisposed(),opHandler.cosh(this)},Tensor.prototype.tanh=function(){return this.throwIfDisposed(),opHandler.tanh(this)},Tensor.prototype.asinh=function(){return this.throwIfDisposed(),opHandler.asinh(this)},Tensor.prototype.acosh=function(){return this.throwIfDisposed(),opHandler.acosh(this)},Tensor.prototype.atanh=function(){return this.throwIfDisposed(),opHandler.atanh(this)},Tensor.prototype.erf=function(){return this.throwIfDisposed(),opHandler.erf(this)},Tensor.prototype.round=function(){return this.throwIfDisposed(),opHandler.round(this)},Tensor.prototype.step=function(alpha){return void 0===alpha&&(alpha=0),this.throwIfDisposed(),opHandler.step(this,alpha)},Tensor.prototype.softmax=function(dim){return void 0===dim&&(dim=-1),this.throwIfDisposed(),opHandler.softmax(this,dim)},Tensor.prototype.logSoftmax=function(axis){return void 0===axis&&(axis=-1),this.throwIfDisposed(),opHandler.logSoftmax(this,axis)},Tensor.prototype.resizeBilinear=function(newShape2D,alignCorners){return void 0===alignCorners&&(alignCorners=!1),this.throwIfDisposed(),opHandler.image.resizeBilinear(this,newShape2D,alignCorners)},Tensor.prototype.resizeNearestNeighbor=function(newShape2D,alignCorners){return void 0===alignCorners&&(alignCorners=!1),this.throwIfDisposed(),opHandler.image.resizeNearestNeighbor(this,newShape2D,alignCorners)},Tensor.prototype.conv1d=function(filter,stride,pad,dataFormat,dilation,dimRoundingMode){return void 0===dataFormat&&(dataFormat="NWC"),void 0===dilation&&(dilation=1),this.throwIfDisposed(),opHandler.conv1d(this,filter,stride,pad,dataFormat,dilation,dimRoundingMode)},Tensor.prototype.conv2d=function(filter,strides,pad,dataFormat,dilations,dimRoundingMode){return void 0===dataFormat&&(dataFormat="NHWC"),void 0===dilations&&(dilations=[1,1]),this.throwIfDisposed(),opHandler.conv2d(this,filter,strides,pad,dataFormat,dilations,dimRoundingMode)},Tensor.prototype.conv2dTranspose=function(filter,outputShape,strides,pad,dimRoundingMode){return this.throwIfDisposed(),opHandler.conv2dTranspose(this,filter,outputShape,strides,pad,dimRoundingMode)},Tensor.prototype.depthwiseConv2D=function(filter,strides,pad,dataFormat,dilations,dimRoundingMode){return void 0===dataFormat&&(dataFormat="NHWC"),void 0===dilations&&(dilations=[1,1]),this.throwIfDisposed(),opHandler.depthwiseConv2d(this,filter,strides,pad,dataFormat,dilations,dimRoundingMode)},Tensor.prototype.separableConv2d=function(depthwiseFilter,pointwiseFilter,strides,pad,dilation,dataFormat){return void 0===dilation&&(dilation=[1,1]),void 0===dataFormat&&(dataFormat="NHWC"),this.throwIfDisposed(),opHandler.separableConv2d(this,depthwiseFilter,pointwiseFilter,strides,pad,dilation,dataFormat)},Tensor.prototype.avgPool=function(filterSize,strides,pad,dimRoundingMode){return this.throwIfDisposed(),opHandler.avgPool(this,filterSize,strides,pad,dimRoundingMode)},Tensor.prototype.maxPool=function(filterSize,strides,pad,dimRoundingMode){return this.throwIfDisposed(),opHandler.maxPool(this,filterSize,strides,pad,dimRoundingMode)},Tensor.prototype.localResponseNormalization=function(radius,bias,alpha,beta){return void 0===radius&&(radius=5),void 0===bias&&(bias=1),void 0===alpha&&(alpha=1),void 0===beta&&(beta=.5),opHandler.localResponseNormalization(this,radius,bias,alpha,beta)},Tensor.prototype.pool=function(windowShape,poolingType,padding,dilationRate,strides){return this.throwIfDisposed(),opHandler.pool(this,windowShape,poolingType,padding,dilationRate,strides)},Tensor.prototype.variable=function(trainable,name,dtype){return void 0===trainable&&(trainable=!0),this.throwIfDisposed(),Variable.variable(this,trainable,name,dtype)},Tensor.prototype.unsortedSegmentSum=function(segmentIds,numSegments){return this.throwIfDisposed(),opHandler.unsortedSegmentSum(this,segmentIds,numSegments)},Tensor.prototype.batchToSpaceND=function(blockShape,crops){return this.throwIfDisposed(),opHandler.batchToSpaceND(this,blockShape,crops)},Tensor.prototype.spaceToBatchND=function(blockShape,paddings){return this.throwIfDisposed(),opHandler.spaceToBatchND(this,blockShape,paddings)},Tensor.prototype.topk=function(k,sorted){return void 0===k&&(k=1),void 0===sorted&&(sorted=!0),this.throwIfDisposed(),opHandler.topk(this,k,sorted)},Tensor.prototype.stridedSlice=function(begin,end,strides,beginMask,endMask,ellipsisMask,newAxisMask,shrinkAxisMask){return void 0===beginMask&&(beginMask=0),void 0===endMask&&(endMask=0),void 0===ellipsisMask&&(ellipsisMask=0),void 0===newAxisMask&&(newAxisMask=0),void 0===shrinkAxisMask&&(shrinkAxisMask=0),this.throwIfDisposed(),opHandler.stridedSlice(this,begin,end,strides,beginMask,endMask,ellipsisMask,newAxisMask,shrinkAxisMask)},Tensor.prototype.depthToSpace=function(blockSize,dataFormat){return this.throwIfDisposed(),opHandler.depthToSpace(this,blockSize,dataFormat)},Tensor.prototype.fft=function(){return this.throwIfDisposed(),opHandler.spectral.fft(this)},Tensor.prototype.ifft=function(){return this.throwIfDisposed(),opHandler.spectral.ifft(this)},Tensor.prototype.rfft=function(){return this.throwIfDisposed(),opHandler.spectral.rfft(this)},Tensor.prototype.irfft=function(){return this.throwIfDisposed(),opHandler.spectral.irfft(this)},Tensor}();exports.Tensor=Tensor,Object.defineProperty(Tensor,Symbol.hasInstance,{value:function(instance){return!!instance&&null!=instance.dataId&&null!=instance.shape&&null!=instance.dtype}});var Variable=function(_super){function Variable(initialValue,trainable,name){void 0===trainable&&(trainable=!0);var _this=_super.call(this,initialValue.shape,initialValue.dtype,null,initialValue.dataId)||this;_this.trainable=trainable,_this.name=name,null==_this.name&&(_this.name=trackerFn().nextVariableId().toString());try{trackerFn().registerVariable(_this)}catch(ex){throw trackerFn().disposeTensor(_this),ex}return _this}return __extends(Variable,_super),Variable.variable=function(initialValue,trainable,name,dtype){return void 0===trainable&&(trainable=!0),null!=dtype&&dtype!==initialValue.dtype&&(initialValue=initialValue.asType(dtype)),new Variable(initialValue,trainable,name)},Variable.prototype.assign=function(newValue){if(newValue.dtype!==this.dtype)throw new Error("dtype of the new value ("+newValue.dtype+") and previous value ("+this.dtype+") must match");if(!util.arraysEqual(newValue.shape,this.shape))throw new Error("shape of the new value ("+newValue.shape+") and previous value ("+this.shape+") must match");trackerFn().disposeTensor(this),this.dataId=newValue.dataId,trackerFn().registerTensor(this)},Variable.prototype.dispose=function(){trackerFn().disposeVariable(this),this.isDisposedInternal=!0},Variable}(Tensor);exports.Variable=Variable,Object.defineProperty(Variable,Symbol.hasInstance,{value:function(instance){return instance instanceof Tensor&&null!=instance.assign&&instance.assign instanceof Function}});var variable=Variable.variable;exports.variable=variable},{"./tensor_format":235,"./util":241}],235:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var util_1=require("./util"),FORMAT_LIMIT_NUM_VALS=20,FORMAT_NUM_FIRST_LAST_VALS=3,FORMAT_NUM_SIG_DIGITS=7;function valToString(val,pad,dtype){var valStr;return valStr=Array.isArray(val)?parseFloat(val[0].toFixed(FORMAT_NUM_SIG_DIGITS))+" + "+parseFloat(val[1].toFixed(FORMAT_NUM_SIG_DIGITS))+"j":util_1.isString(val)?"'"+val+"'":"bool"===dtype?boolNumToString(val):parseFloat(val.toFixed(FORMAT_NUM_SIG_DIGITS)).toString(),util_1.rightPad(valStr,pad)}function boolNumToString(v){return 0===v?"false":"true"}function createComplexTuples(vals){for(var complexTuples=[],i=0;i<vals.length;i+=2)complexTuples.push([vals[i],vals[i+1]]);return complexTuples}exports.tensorToString=function(vals,shape,dtype,verbose){var strides=util_1.computeStrides(shape),padPerCol=function(vals,shape,dtype,strides){var n=util_1.sizeFromShape(shape),numCols=strides[strides.length-1],padPerCol=new Array(numCols).fill(0),rank=shape.length,valuesOrTuples="complex64"===dtype?createComplexTuples(vals):vals;if(1<rank)for(var row=0;row<n/numCols;row++)for(var offset=row*numCols,j=0;j<numCols;j++)padPerCol[j]=Math.max(padPerCol[j],valToString(valuesOrTuples[offset+j],0,dtype).length);return padPerCol}(vals,shape,dtype,strides),rank=shape.length,valsLines=function subTensorToString(vals,shape,dtype,strides,padPerCol,isLast){void 0===isLast&&(isLast=!0);var storagePerElement="complex64"===dtype?2:1;var size=shape[0];var rank=shape.length;if(0===rank){if("complex64"!==dtype)return"bool"===dtype?[boolNumToString(vals[0])]:[vals[0].toString()];var complexTuple=createComplexTuples(vals);return[valToString(complexTuple[0],0,dtype)]}if(1===rank){if(FORMAT_LIMIT_NUM_VALS<size){var firstValsSize=FORMAT_NUM_FIRST_LAST_VALS*storagePerElement,firstVals=Array.from(vals.slice(0,firstValsSize)),lastVals=Array.from(vals.slice(size-FORMAT_NUM_FIRST_LAST_VALS*storagePerElement,size));return"complex64"===dtype&&(firstVals=createComplexTuples(firstVals),lastVals=createComplexTuples(lastVals)),["["+firstVals.map(function(x,i){return valToString(x,padPerCol[i],dtype)}).join(", ")+", ..., "+lastVals.map(function(x,i){return valToString(x,padPerCol[size-FORMAT_NUM_FIRST_LAST_VALS+i],dtype)}).join(", ")+"]"]}var displayVals="complex64"===dtype?createComplexTuples(vals):Array.from(vals);return["["+displayVals.map(function(x,i){return valToString(x,padPerCol[i],dtype)}).join(", ")+"]"]}var subshape=shape.slice(1);var substrides=strides.slice(1);var stride=strides[0]*storagePerElement;var lines=[];if(FORMAT_LIMIT_NUM_VALS<size){for(var i=0;i<FORMAT_NUM_FIRST_LAST_VALS;i++){var start=i*stride,end=start+stride;lines.push.apply(lines,subTensorToString(vals.slice(start,end),subshape,dtype,substrides,padPerCol,!1))}lines.push("...");for(var i=size-FORMAT_NUM_FIRST_LAST_VALS;i<size;i++){var start=i*stride,end=start+stride;lines.push.apply(lines,subTensorToString(vals.slice(start,end),subshape,dtype,substrides,padPerCol,i===size-1))}}else for(var i=0;i<size;i++){var start=i*stride,end=start+stride;lines.push.apply(lines,subTensorToString(vals.slice(start,end),subshape,dtype,substrides,padPerCol,i===size-1))}var sep=2===rank?",":"";lines[0]="["+lines[0]+sep;for(var i=1;i<lines.length-1;i++)lines[i]=" "+lines[i]+sep;var newLineSep=",\n";for(var i=2;i<rank;i++)newLineSep+="\n";lines[lines.length-1]=" "+lines[lines.length-1]+"]"+(isLast?"":newLineSep);return lines}(vals,shape,dtype,strides,padPerCol),lines=["Tensor"];return verbose&&(lines.push("  dtype: "+dtype),lines.push("  rank: "+rank),lines.push("  shape: ["+shape+"]"),lines.push("  values:")),lines.push(valsLines.map(function(l){return"    "+l}).join("\n")),lines.join("\n")}},{"./util":241}],236:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var tensor_1=require("./tensor"),types_1=require("./types"),util_1=require("./util");exports.makeTypesMatch=function(a,b){if(a.dtype===b.dtype)return[a,b];var dtype=types_1.upcastType(a.dtype,b.dtype);return[a.cast(dtype),b.cast(dtype)]},exports.assertTypesMatch=function(a,b){util_1.assert(a.dtype===b.dtype,function(){return"The dtypes of the first("+a.dtype+") and second("+b.dtype+") input must match"})},exports.isTensorInList=function(tensor,tensorList){for(var i=0;i<tensorList.length;i++)if(tensorList[i].id===tensor.id)return!0;return!1},exports.getTensorsInContainer=function(result){var list=[];return function walkTensorContainer(container,list,seen){if(null==container)return;if(container instanceof tensor_1.Tensor)return void list.push(container);if(obj=container,!Array.isArray(obj)&&"object"!=typeof obj)return;var obj;var iterable=container;for(var k in iterable){var val=iterable[k];seen.has(val)||(seen.add(val),walkTensorContainer(val,list,seen))}}(result,list,new Set),list}},{"./tensor":234,"./types":240,"./util":241}],237:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var environment_1=require("./environment"),tensor_1=require("./tensor"),util_1=require("./util");function inferShape(val,dtype){var firstElem=val;if(util_1.isTypedArray(val))return"string"===dtype?[]:[val.length];if(!Array.isArray(val))return[];for(var shape=[];Array.isArray(firstElem)||util_1.isTypedArray(firstElem)&&"string"!==dtype;)shape.push(firstElem.length),firstElem=firstElem[0];return Array.isArray(val)&&environment_1.ENV.getBool("TENSORLIKE_CHECK_SHAPE_CONSISTENCY")&&function deepAssertShapeConsistency(val,shape,indices){indices=indices||[];if(!Array.isArray(val)&&!util_1.isTypedArray(val))return void util_1.assert(0===shape.length,function(){return"Element arr["+indices.join("][")+"] is a primitive, but should be an array/TypedArray of "+shape[0]+" elements"});util_1.assert(0<shape.length,function(){return"Element arr["+indices.join("][")+"] should be a primitive, but is an array of "+val.length+" elements"});util_1.assert(val.length===shape[0],function(){return"Element arr["+indices.join("][")+"] should have "+shape[0]+" elements, but has "+val.length+" elements"});var subShape=shape.slice(1);for(var i=0;i<val.length;++i)deepAssertShapeConsistency(val[i],subShape,indices.concat(i))}(val,shape,[]),shape}function assertDtype(expectedDtype,actualDType,argName,functionName){if(null!=expectedDtype&&("numeric"!==expectedDtype&&expectedDtype!==actualDType||"numeric"===expectedDtype&&"string"===actualDType))throw new Error("Argument '"+argName+"' passed to '"+functionName+"' must be "+expectedDtype+" tensor, but got "+actualDType+" tensor")}function convertToTensor(x,argName,functionName,parseAsDtype){if(void 0===parseAsDtype&&(parseAsDtype="numeric"),x instanceof tensor_1.Tensor)return assertDtype(parseAsDtype,x.dtype,argName,functionName),x;var inferredDtype=util_1.inferDtype(x);if("string"!==inferredDtype&&0<=["bool","int32","float32"].indexOf(parseAsDtype)&&(inferredDtype=parseAsDtype),assertDtype(parseAsDtype,inferredDtype,argName,functionName),null==x||!util_1.isTypedArray(x)&&!Array.isArray(x)&&"number"!=typeof x&&"boolean"!=typeof x&&"string"!=typeof x){var type=null==x?"null":x.constructor.name;throw new Error("Argument '"+argName+"' passed to '"+functionName+"' must be a Tensor or TensorLike, but got '"+type+"'")}var inferredShape=inferShape(x,inferredDtype);util_1.isTypedArray(x)||Array.isArray(x)||(x=[x]);var values="string"!==inferredDtype?util_1.toTypedArray(x,inferredDtype,environment_1.ENV.getBool("DEBUG")):util_1.flatten(x,[],!0);return tensor_1.Tensor.make(inferredShape,{values:values},inferredDtype)}exports.inferShape=inferShape,exports.convertToTensor=convertToTensor,exports.convertToTensorArray=function(arg,argName,functionName,parseAsDtype){if(void 0===parseAsDtype&&(parseAsDtype="numeric"),!Array.isArray(arg))throw new Error("Argument "+argName+" passed to "+functionName+" must be a `Tensor[]` or `TensorLike[]`");return arg.map(function(t,i){return convertToTensor(t,argName+"["+i+"]",functionName)},parseAsDtype)}},{"./environment":144,"./tensor":234,"./util":241}],238:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var engine_1=require("./engine"),tensor_util_env_1=require("./tensor_util_env"),util_1=require("./util"),TEST_EPSILON_FLOAT32=.001;function testEpsilon(){return 32===engine_1.ENGINE.backend.floatPrecision()?TEST_EPSILON_FLOAT32:exports.TEST_EPSILON_FLOAT16}function expectArraysPredicate(actual,expected,predicate){var checkClassType=!0;if((util_1.isTypedArray(actual)||util_1.isTypedArray(expected))&&(checkClassType=!1),util_1.isTypedArray(actual)&&util_1.isTypedArray(expected)&&(checkClassType=!0),checkClassType){var aType=actual.constructor.name,bType=expected.constructor.name;if(aType!==bType)throw new Error("Arrays are of different type. Actual: "+aType+". Expected: "+bType)}if(Array.isArray(actual)&&Array.isArray(expected)){var actualShape=tensor_util_env_1.inferShape(actual),expectedShape=tensor_util_env_1.inferShape(expected);if(!util_1.arraysEqual(actualShape,expectedShape))throw new Error("Arrays have different shapes. Actual: ["+actualShape+"]. Expected: ["+expectedShape+"]")}var actualFlat=util_1.isTypedArray(actual)?actual:util_1.flatten(actual),expectedFlat=util_1.isTypedArray(expected)?expected:util_1.flatten(expected);if(actualFlat.length!==expectedFlat.length)throw new Error("Arrays have different lengths actual: "+actualFlat.length+" vs expected: "+expectedFlat.length+".\nActual:   "+actualFlat+".\nExpected: "+expectedFlat+".");for(var i=0;i<expectedFlat.length;++i){var a=actualFlat[i],e=expectedFlat[i];if(!predicate(a,e))throw new Error("Arrays differ: actual["+i+"] = "+a+", expected["+i+"] = "+e+".\nActual:   "+actualFlat+".\nExpected: "+expectedFlat+".")}}function areClose(a,e,epsilon){return!isFinite(a)&&!isFinite(e)||!(isNaN(a)||isNaN(e)||Math.abs(a-e)>epsilon)}exports.TEST_EPSILON_FLOAT16=.1,exports.expectArraysClose=function(actual,expected,epsilon){return null==epsilon&&(epsilon=testEpsilon()),expectArraysPredicate(actual,expected,function(a,b){return areClose(a,b,epsilon)})},exports.testEpsilon=testEpsilon,exports.expectPromiseToFail=function(fn,done){fn().then(function(){return done.fail()},function(){return done()})},exports.expectArraysEqual=function(actual,expected){var exp="string"==typeof expected||"number"==typeof expected||"boolean"==typeof expected?[expected]:expected;return util_1.isString(actual)||util_1.isString(actual[0])||util_1.isString(expected)||util_1.isString(expected[0])?expectArraysPredicate(actual,exp,function(a,b){return a==b}):expectArraysPredicate(actual,expected,function(a,b){return areClose(a,b,0)})},exports.expectNumbersClose=function(a,e,epsilon){if(null==epsilon&&(epsilon=testEpsilon()),!areClose(a,e,epsilon))throw new Error("Numbers differ: actual === "+a+", expected === "+e)},exports.expectValuesInRange=function(actual,low,high){for(var i=0;i<actual.length;i++)if(actual[i]<low||actual[i]>high)throw new Error("Value out of range:"+actual[i]+" low: "+low+", high: "+high)},exports.expectArrayBuffersEqual=function(actual,expected){expect(new Float32Array(actual)).toEqual(new Float32Array(expected))}},{"./engine":143,"./tensor_util_env":237,"./util":241}],239:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var adadelta_optimizer_1=require("./optimizers/adadelta_optimizer"),adagrad_optimizer_1=require("./optimizers/adagrad_optimizer"),adam_optimizer_1=require("./optimizers/adam_optimizer"),adamax_optimizer_1=require("./optimizers/adamax_optimizer"),momentum_optimizer_1=require("./optimizers/momentum_optimizer"),optimizer_constructors_1=require("./optimizers/optimizer_constructors"),rmsprop_optimizer_1=require("./optimizers/rmsprop_optimizer"),sgd_optimizer_1=require("./optimizers/sgd_optimizer");momentum_optimizer_1.MomentumOptimizer,sgd_optimizer_1.SGDOptimizer,adadelta_optimizer_1.AdadeltaOptimizer,adagrad_optimizer_1.AdagradOptimizer,rmsprop_optimizer_1.RMSPropOptimizer,adamax_optimizer_1.AdamaxOptimizer,adam_optimizer_1.AdamOptimizer,exports.train={sgd:optimizer_constructors_1.OptimizerConstructors.sgd,momentum:optimizer_constructors_1.OptimizerConstructors.momentum,adadelta:optimizer_constructors_1.OptimizerConstructors.adadelta,adagrad:optimizer_constructors_1.OptimizerConstructors.adagrad,rmsprop:optimizer_constructors_1.OptimizerConstructors.rmsprop,adamax:optimizer_constructors_1.OptimizerConstructors.adamax,adam:optimizer_constructors_1.OptimizerConstructors.adam}},{"./optimizers/adadelta_optimizer":220,"./optimizers/adagrad_optimizer":221,"./optimizers/adam_optimizer":222,"./optimizers/adamax_optimizer":223,"./optimizers/momentum_optimizer":224,"./optimizers/optimizer_constructors":226,"./optimizers/rmsprop_optimizer":227,"./optimizers/sgd_optimizer":228}],240:[function(require,module,exports){"use strict";var UpcastInt32AndMap,UpcastBoolAndMap,UpcastFloat32AndMap,UpcastComplex64AndMap;Object.defineProperty(exports,"__esModule",{value:!0}),function(Rank){Rank.R0="R0",Rank.R1="R1",Rank.R2="R2",Rank.R3="R3",Rank.R4="R4",Rank.R5="R5",Rank.R6="R6"}(exports.Rank||(exports.Rank={})),function(UpcastInt32AndMap){UpcastInt32AndMap.float32="float32",UpcastInt32AndMap.int32="int32",UpcastInt32AndMap.bool="int32",UpcastInt32AndMap.complex64="complex64"}(UpcastInt32AndMap=UpcastInt32AndMap||{}),function(UpcastBoolAndMap){UpcastBoolAndMap.float32="float32",UpcastBoolAndMap.int32="int32",UpcastBoolAndMap.bool="bool",UpcastBoolAndMap.complex64="complex64"}(UpcastBoolAndMap=UpcastBoolAndMap||{}),function(UpcastFloat32AndMap){UpcastFloat32AndMap.float32="float32",UpcastFloat32AndMap.int32="float32",UpcastFloat32AndMap.bool="float32",UpcastFloat32AndMap.complex64="complex64"}(UpcastFloat32AndMap=UpcastFloat32AndMap||{}),function(UpcastComplex64AndMap){UpcastComplex64AndMap.float32="complex64",UpcastComplex64AndMap.int32="complex64",UpcastComplex64AndMap.bool="complex64",UpcastComplex64AndMap.complex64="complex64"}(UpcastComplex64AndMap=UpcastComplex64AndMap||{});var upcastTypeMap={float32:UpcastFloat32AndMap,int32:UpcastInt32AndMap,bool:UpcastBoolAndMap,complex64:UpcastComplex64AndMap};function upcastType(typeA,typeB){if("string"!==typeA&&"string"!==typeB)return upcastTypeMap[typeA][typeB];if("string"===typeA&&"string"===typeB)return"string";throw new Error("Can not upcast "+typeA+" with "+typeB)}exports.upcastType=upcastType,exports.sumOutType=function(type){return upcastType(type,"int32")}},{}],241:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var environment_1=require("./environment");function shuffle(array){for(var counter=array.length,temp=0,index=0;0<counter;)index=Math.random()*counter|0,temp=array[--counter],array[counter]=array[index],array[index]=temp}function assert(expr,msg){if(!expr)throw new Error("string"==typeof msg?msg:msg())}function flatten(arr,result,skipTypedArray){if(void 0===result&&(result=[]),void 0===skipTypedArray&&(skipTypedArray=!1),null==result&&(result=[]),Array.isArray(arr)||isTypedArray(arr)&&!skipTypedArray)for(var i=0;i<arr.length;++i)flatten(arr[i],result,skipTypedArray);else result.push(arr);return result}function arraysEqual(n1,n2){if(n1===n2)return!0;if(null==n1||null==n2)return!1;if(n1.length!==n2.length)return!1;for(var i=0;i<n1.length;i++)if(n1[i]!==n2[i])return!1;return!0}function isInt(a){return a%1==0}function parseAxisParam(axis,shape){var rank=shape.length;return assert((axis=null==axis?shape.map(function(s,i){return i}):[].concat(axis)).every(function(ax){return-rank<=ax&&ax<rank}),function(){return"All values in axis param must be in range [-"+rank+", "+rank+") but got axis "+axis}),assert(axis.every(function(ax){return isInt(ax)}),function(){return"All values in axis param must be integers but got axis "+axis}),axis.map(function(a){return a<0?rank+a:a})}function checkConversionForErrors(vals,dtype){for(var i=0;i<vals.length;i++){var num=vals[i];if(isNaN(num)||!isFinite(num))throw Error("A tensor of type "+dtype+" being uploaded contains "+num+".")}}function isTypedArray(a){return a instanceof Float32Array||a instanceof Int32Array||a instanceof Uint8Array}function isString(value){return"string"==typeof value||value instanceof String}function isBoolean(value){return"boolean"==typeof value}function isNumber(value){return"number"==typeof value}function makeZerosTypedArray(size,dtype){if(null==dtype||"float32"===dtype||"complex64"===dtype)return new Float32Array(size);if("int32"===dtype)return new Int32Array(size);if("bool"===dtype)return new Uint8Array(size);throw new Error("Unknown data type "+dtype)}exports.shuffle=shuffle,exports.clamp=function(min,x,max){return Math.max(min,Math.min(x,max))},exports.nearestLargerEven=function(val){return val%2==0?val:val+1},exports.sum=function(arr){for(var sum=0,i=0;i<arr.length;i++)sum+=arr[i];return sum},exports.randUniform=function(a,b){var r=Math.random();return b*r+(1-r)*a},exports.distSquared=function(a,b){for(var result=0,i=0;i<a.length;i++){var diff=Number(a[i])-Number(b[i]);result+=diff*diff}return result},exports.assert=assert,exports.assertShapesMatch=function(shapeA,shapeB,errorMessagePrefix){void 0===errorMessagePrefix&&(errorMessagePrefix=""),assert(arraysEqual(shapeA,shapeB),function(){return errorMessagePrefix+" Shapes "+shapeA+" and "+shapeB+" must match"})},exports.assertNonNull=function(a){assert(null!=a,function(){return"The input to the tensor constructor must be a non-null value."})},exports.flatten=flatten,exports.sizeFromShape=function(shape){if(0===shape.length)return 1;for(var size=shape[0],i=1;i<shape.length;i++)size*=shape[i];return size},exports.isScalarShape=function(shape){return 0===shape.length},exports.arraysEqual=arraysEqual,exports.isInt=isInt,exports.tanh=function(x){if(null!=Math.tanh)return Math.tanh(x);if(x===1/0)return 1;if(x===-1/0)return-1;var e2x=Math.exp(2*x);return(e2x-1)/(e2x+1)},exports.sizeToSquarishShape=function(size){var width=Math.ceil(Math.sqrt(size));return[width,Math.ceil(size/width)]},exports.createShuffledIndices=function(n){for(var shuffledIndices=new Uint32Array(n),i=0;i<n;++i)shuffledIndices[i]=i;return shuffle(shuffledIndices),shuffledIndices},exports.rightPad=function(a,size){return size<=a.length?a:a+" ".repeat(size-a.length)},exports.repeatedTry=function(checkFn,delayFn,maxCounter){return void 0===delayFn&&(delayFn=function(counter){return 0}),new Promise(function(resolve,reject){var tryCount=0,tryFn=function(){if(checkFn())resolve();else{var nextBackoff=delayFn(++tryCount);null!=maxCounter&&maxCounter<=tryCount?reject():setTimeout(tryFn,nextBackoff)}};tryFn()})},exports.inferFromImplicitShape=function(shape,size){for(var shapeProd=1,implicitIdx=-1,i=0;i<shape.length;++i)if(0<=shape[i])shapeProd*=shape[i];else if(-1===shape[i]){if(-1!==implicitIdx)throw Error("Shapes can only have 1 implicit size. Found -1 at dim "+implicitIdx+" and dim "+i);implicitIdx=i}else if(shape[i]<0)throw Error("Shapes can not be < 0. Found "+shape[i]+" at dim "+i);if(-1===implicitIdx){if(0<size&&size!==shapeProd)throw Error("Size("+size+") must match the product of shape "+shape);return shape}if(0===shapeProd)throw Error("Cannot infer the missing size in ["+shape+"] when there are 0 elements");if(size%shapeProd!=0)throw Error("The implicit shape can't be a fractional number. Got "+size+" / "+shapeProd);var newShape=shape.slice();return newShape[implicitIdx]=size/shapeProd,newShape},exports.parseAxisParam=parseAxisParam,exports.squeezeShape=function(shape,axis){for(var newShape=[],keptDims=[],axes=null==axis?null:parseAxisParam(axis,shape).sort(),j=0,i=0;i<shape.length;++i){if(null!=axes){if(axes[j]===i&&1!==shape[i])throw new Error("Can't squeeze axis "+i+" since its dim '"+shape[i]+"' is not 1");(null==axes[j]||axes[j]>i)&&1===shape[i]&&(newShape.push(shape[i]),keptDims.push(i)),axes[j]<=i&&j++}1!==shape[i]&&(newShape.push(shape[i]),keptDims.push(i))}return{newShape:newShape,keptDims:keptDims}},exports.getTypedArrayFromDType=function(dtype,size){var values=null;if(null==dtype||"float32"===dtype)values=new Float32Array(size);else if("int32"===dtype)values=new Int32Array(size);else{if("bool"!==dtype)throw new Error("Unknown data type "+dtype);values=new Uint8Array(size)}return values},exports.getArrayFromDType=function(dtype,size){var values=null;if(null==dtype||"float32"===dtype)values=new Float32Array(size);else if("int32"===dtype)values=new Int32Array(size);else if("bool"===dtype)values=new Uint8Array(size);else{if("string"!==dtype)throw new Error("Unknown data type "+dtype);values=new Array(size)}return values},exports.checkComputationForErrors=function(vals,dtype,name){if("float32"===dtype)for(var i=0;i<vals.length;i++){var num=vals[i];if(isNaN(num)||!isFinite(num))throw Error("The result of the '"+name+"' is "+num+".")}},exports.checkConversionForErrors=checkConversionForErrors,exports.isValidDtype=function(dtype){return"bool"===dtype||"complex64"===dtype||"float32"===dtype||"int32"===dtype||"string"===dtype},exports.hasEncodingLoss=function(oldType,newType){return"complex64"!==newType&&(("float32"!==newType||"complex64"===oldType)&&(("int32"!==newType||"float32"===oldType||"complex64"===oldType)&&("bool"!==newType||"bool"!==oldType)))},exports.isTypedArray=isTypedArray,exports.bytesPerElement=function(dtype){if("float32"===dtype||"int32"===dtype)return 4;if("complex64"===dtype)return 8;if("bool"===dtype)return 1;throw new Error("Unknown dtype "+dtype)},exports.bytesFromStringArray=function(arr){if(null==arr)return 0;var bytes=0;return arr.forEach(function(x){return bytes+=x.length}),bytes},exports.isString=isString,exports.isBoolean=isBoolean,exports.isNumber=isNumber,exports.inferDtype=function inferDtype(values){return Array.isArray(values)?inferDtype(values[0]):values instanceof Float32Array?"float32":values instanceof Int32Array||values instanceof Uint8Array?"int32":isNumber(values)?"float32":isString(values)?"string":isBoolean(values)?"bool":"float32"},exports.isFunction=function(f){return!!(f&&f.constructor&&f.call&&f.apply)},exports.nearestDivisor=function(size,start){for(var i=start;i<size;++i)if(size%i==0)return i;return size},exports.computeStrides=function(shape){var rank=shape.length;if(rank<2)return[];var strides=new Array(rank-1);strides[rank-2]=shape[rank-1];for(var i=rank-3;0<=i;--i)strides[i]=strides[i+1]*shape[i+1];return strides},exports.toTypedArray=function(a,dtype,debugMode){if("string"===dtype)throw new Error("Cannot convert a string[] to a TypedArray");if(Array.isArray(a)&&(a=flatten(a)),debugMode&&checkConversionForErrors(a,dtype),function(a,dtype){return a instanceof Float32Array&&"float32"===dtype||a instanceof Int32Array&&"int32"===dtype||a instanceof Uint8Array&&"bool"===dtype}(a,dtype))return a;if(null==dtype||"float32"===dtype||"complex64"===dtype)return new Float32Array(a);if("int32"===dtype)return new Int32Array(a);if("bool"!==dtype)throw new Error("Unknown data type "+dtype);for(var bool=new Uint8Array(a.length),i=0;i<bool.length;++i)0!==Math.round(a[i])&&(bool[i]=1);return bool},exports.toNestedArray=function(shape,a){if(0===shape.length)return a[0];var size=shape.reduce(function(acc,c){return acc*c});if(0===size)return[];if(size!==a.length)throw new Error("["+shape+"] does not match the input size.");return function createNestedArray(offset,shape,a){var ret=new Array;if(1===shape.length)for(var d=shape[0],i=0;i<d;i++)ret[i]=a[offset+i];else{d=shape[0];var rest=shape.slice(1),len=rest.reduce(function(acc,c){return acc*c});for(i=0;i<d;i++)ret[i]=createNestedArray(offset+i*len,rest,a)}return ret}(0,shape,a)},exports.makeOnesTypedArray=function(size,dtype){for(var array=makeZerosTypedArray(size,dtype),i=0;i<array.length;i++)array[i]=1;return array},exports.makeZerosTypedArray=makeZerosTypedArray,exports.now=function(){return environment_1.ENV.platform.now()},exports.assertNonNegativeIntegerDimensions=function(shape){shape.forEach(function(dimSize){assert(Number.isInteger(dimSize)&&0<=dimSize,function(){return"Tensor must have a shape comprised of positive integers but got shape ["+shape+"]."})})},exports.fetch=function(path,requestInits){return environment_1.ENV.platform.fetch(path,requestInits)},exports.encodeString=function(s,encoding){return void 0===encoding&&(encoding="utf-8"),encoding=encoding||"utf-8",environment_1.ENV.platform.encode(s,encoding)},exports.decodeString=function(bytes,encoding){return void 0===encoding&&(encoding="utf-8"),encoding=encoding||"utf-8",environment_1.ENV.platform.decode(bytes,encoding)}},{"./environment":144}],242:[function(require,module,exports){arguments[4][49][0].apply(exports,arguments)},{dup:49}],243:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var gpgpu_util=require("./backends/webgl/gpgpu_util");exports.gpgpu_util=gpgpu_util;var webgl_util=require("./backends/webgl/webgl_util");exports.webgl_util=webgl_util;var backend_webgl_1=require("./backends/webgl/backend_webgl");exports.MathBackendWebGL=backend_webgl_1.MathBackendWebGL;var canvas_util_1=require("./backends/webgl/canvas_util");exports.setWebGLContext=canvas_util_1.setWebGLContext;var gpgpu_context_1=require("./backends/webgl/gpgpu_context");exports.GPGPUContext=gpgpu_context_1.GPGPUContext},{"./backends/webgl/backend_webgl":64,"./backends/webgl/canvas_util":70,"./backends/webgl/gpgpu_context":99,"./backends/webgl/gpgpu_util":101,"./backends/webgl/webgl_util":139}],244:[function(require,module,exports){var alea=require("./lib/alea"),xor128=require("./lib/xor128"),xorwow=require("./lib/xorwow"),xorshift7=require("./lib/xorshift7"),xor4096=require("./lib/xor4096"),tychei=require("./lib/tychei"),sr=require("./seedrandom");sr.alea=alea,sr.xor128=xor128,sr.xorwow=xorwow,sr.xorshift7=xorshift7,sr.xor4096=xor4096,sr.tychei=tychei,module.exports=sr},{"./lib/alea":245,"./lib/tychei":246,"./lib/xor128":247,"./lib/xor4096":248,"./lib/xorshift7":249,"./lib/xorwow":250,"./seedrandom":251}],245:[function(require,module,exports){!function(global,module,define){function Alea(seed){var me=this,mash=function(){var n=4022871197;return function(data){data=data.toString();for(var i=0;i<data.length;i++){var h=.02519603282416938*(n+=data.charCodeAt(i));h-=n=h>>>0,n=(h*=n)>>>0,n+=4294967296*(h-=n)}return 2.3283064365386963e-10*(n>>>0)}}();me.next=function(){var t=2091639*me.s0+2.3283064365386963e-10*me.c;return me.s0=me.s1,me.s1=me.s2,me.s2=t-(me.c=0|t)},me.c=1,me.s0=mash(" "),me.s1=mash(" "),me.s2=mash(" "),me.s0-=mash(seed),me.s0<0&&(me.s0+=1),me.s1-=mash(seed),me.s1<0&&(me.s1+=1),me.s2-=mash(seed),me.s2<0&&(me.s2+=1),mash=null}function copy(f,t){return t.c=f.c,t.s0=f.s0,t.s1=f.s1,t.s2=f.s2,t}function impl(seed,opts){var xg=new Alea(seed),state=opts&&opts.state,prng=xg.next;return prng.int32=function(){return 4294967296*xg.next()|0},prng.double=function(){return prng()+11102230246251565e-32*(2097152*prng()|0)},prng.quick=prng,state&&("object"==typeof state&&copy(state,xg),prng.state=function(){return copy(xg,{})}),prng}module&&module.exports?module.exports=impl:define&&define.amd?define(function(){return impl}):this.alea=impl}(0,"object"==typeof module&&module,!1)},{}],246:[function(require,module,exports){!function(global,module,define){function XorGen(seed){var me=this,strseed="";me.next=function(){var b=me.b,c=me.c,d=me.d,a=me.a;return b=b<<25^b>>>7^c,c=c-d|0,d=d<<24^d>>>8^a,a=a-b|0,me.b=b=b<<20^b>>>12^c,me.c=c=c-d|0,me.d=d<<16^c>>>16^a,me.a=a-b|0},me.a=0,me.b=0,me.c=-1640531527,me.d=1367130551,seed===Math.floor(seed)?(me.a=seed/4294967296|0,me.b=0|seed):strseed+=seed;for(var k=0;k<strseed.length+20;k++)me.b^=0|strseed.charCodeAt(k),me.next()}function copy(f,t){return t.a=f.a,t.b=f.b,t.c=f.c,t.d=f.d,t}function impl(seed,opts){function prng(){return(xg.next()>>>0)/4294967296}var xg=new XorGen(seed),state=opts&&opts.state;return prng.double=function(){do{var result=((xg.next()>>>11)+(xg.next()>>>0)/4294967296)/(1<<21)}while(0===result);return result},prng.int32=xg.next,prng.quick=prng,state&&("object"==typeof state&&copy(state,xg),prng.state=function(){return copy(xg,{})}),prng}module&&module.exports?module.exports=impl:define&&define.amd?define(function(){return impl}):this.tychei=impl}(0,"object"==typeof module&&module,!1)},{}],247:[function(require,module,exports){!function(global,module,define){function XorGen(seed){var me=this,strseed="";me.x=0,me.y=0,me.z=0,me.w=0,me.next=function(){var t=me.x^me.x<<11;return me.x=me.y,me.y=me.z,me.z=me.w,me.w^=me.w>>>19^t^t>>>8},seed===(0|seed)?me.x=seed:strseed+=seed;for(var k=0;k<strseed.length+64;k++)me.x^=0|strseed.charCodeAt(k),me.next()}function copy(f,t){return t.x=f.x,t.y=f.y,t.z=f.z,t.w=f.w,t}function impl(seed,opts){function prng(){return(xg.next()>>>0)/4294967296}var xg=new XorGen(seed),state=opts&&opts.state;return prng.double=function(){do{var result=((xg.next()>>>11)+(xg.next()>>>0)/4294967296)/(1<<21)}while(0===result);return result},prng.int32=xg.next,prng.quick=prng,state&&("object"==typeof state&&copy(state,xg),prng.state=function(){return copy(xg,{})}),prng}module&&module.exports?module.exports=impl:define&&define.amd?define(function(){return impl}):this.xor128=impl}(0,"object"==typeof module&&module,!1)},{}],248:[function(require,module,exports){!function(global,module,define){function XorGen(seed){var me=this;me.next=function(){var t,v,w=me.w,X=me.X,i=me.i;return me.w=w=w+1640531527|0,v=X[i+34&127],t=X[i=i+1&127],v^=v<<13,t^=t<<17,v^=v>>>15,t^=t>>>12,v=X[i]=v^t,me.i=i,v+(w^w>>>16)|0},function(me,seed){var t,v,i,j,w,X=[],limit=128;for(seed===(0|seed)?(v=seed,seed=null):(seed+="\0",v=0,limit=Math.max(limit,seed.length)),i=0,j=-32;j<limit;++j)seed&&(v^=seed.charCodeAt((j+32)%seed.length)),0===j&&(w=v),v^=v<<10,v^=v>>>15,v^=v<<4,v^=v>>>13,0<=j&&(w=w+1640531527|0,i=0==(t=X[127&j]^=v+w)?i+1:0);for(128<=i&&(X[127&(seed&&seed.length||0)]=-1),i=127,j=512;0<j;--j)v=X[i+34&127],t=X[i=i+1&127],v^=v<<13,t^=t<<17,v^=v>>>15,t^=t>>>12,X[i]=v^t;me.w=w,me.X=X,me.i=i}(me,seed)}function copy(f,t){return t.i=f.i,t.w=f.w,t.X=f.X.slice(),t}function impl(seed,opts){null==seed&&(seed=+new Date);function prng(){return(xg.next()>>>0)/4294967296}var xg=new XorGen(seed),state=opts&&opts.state;return prng.double=function(){do{var result=((xg.next()>>>11)+(xg.next()>>>0)/4294967296)/(1<<21)}while(0===result);return result},prng.int32=xg.next,prng.quick=prng,state&&(state.X&&copy(state,xg),prng.state=function(){return copy(xg,{})}),prng}module&&module.exports?module.exports=impl:define&&define.amd?define(function(){return impl}):this.xor4096=impl}(0,"object"==typeof module&&module,!1)},{}],249:[function(require,module,exports){!function(global,module,define){function XorGen(seed){var me=this;me.next=function(){var t,v,X=me.x,i=me.i;return t=X[i],v=(t^=t>>>7)^t<<24,v^=(t=X[i+1&7])^t>>>10,v^=(t=X[i+3&7])^t>>>3,v^=(t=X[i+4&7])^t<<7,t=X[i+7&7],v^=(t^=t<<13)^t<<9,X[i]=v,me.i=i+1&7,v},function(me,seed){var j,X=[];if(seed===(0|seed))X[0]=seed;else for(seed=""+seed,j=0;j<seed.length;++j)X[7&j]=X[7&j]<<15^seed.charCodeAt(j)+X[j+1&7]<<13;for(;X.length<8;)X.push(0);for(j=0;j<8&&0===X[j];++j);for(8==j?X[7]=-1:X[j],me.x=X,me.i=0,j=256;0<j;--j)me.next()}(me,seed)}function copy(f,t){return t.x=f.x.slice(),t.i=f.i,t}function impl(seed,opts){null==seed&&(seed=+new Date);function prng(){return(xg.next()>>>0)/4294967296}var xg=new XorGen(seed),state=opts&&opts.state;return prng.double=function(){do{var result=((xg.next()>>>11)+(xg.next()>>>0)/4294967296)/(1<<21)}while(0===result);return result},prng.int32=xg.next,prng.quick=prng,state&&(state.x&&copy(state,xg),prng.state=function(){return copy(xg,{})}),prng}module&&module.exports?module.exports=impl:define&&define.amd?define(function(){return impl}):this.xorshift7=impl}(0,"object"==typeof module&&module,!1)},{}],250:[function(require,module,exports){!function(global,module,define){function XorGen(seed){var me=this,strseed="";me.next=function(){var t=me.x^me.x>>>2;return me.x=me.y,me.y=me.z,me.z=me.w,me.w=me.v,(me.d=me.d+362437|0)+(me.v=me.v^me.v<<4^t^t<<1)|0},me.x=0,me.y=0,me.z=0,me.w=0,seed===((me.v=0)|seed)?me.x=seed:strseed+=seed;for(var k=0;k<strseed.length+64;k++)me.x^=0|strseed.charCodeAt(k),k==strseed.length&&(me.d=me.x<<10^me.x>>>4),me.next()}function copy(f,t){return t.x=f.x,t.y=f.y,t.z=f.z,t.w=f.w,t.v=f.v,t.d=f.d,t}function impl(seed,opts){function prng(){return(xg.next()>>>0)/4294967296}var xg=new XorGen(seed),state=opts&&opts.state;return prng.double=function(){do{var result=((xg.next()>>>11)+(xg.next()>>>0)/4294967296)/(1<<21)}while(0===result);return result},prng.int32=xg.next,prng.quick=prng,state&&("object"==typeof state&&copy(state,xg),prng.state=function(){return copy(xg,{})}),prng}module&&module.exports?module.exports=impl:define&&define.amd?define(function(){return impl}):this.xorwow=impl}(0,"object"==typeof module&&module,!1)},{}],251:[function(require,module,exports){!function(pool,math){var nodecrypto,global=this,width=256,chunks=6,rngname="random",startdenom=math.pow(width,chunks),significance=math.pow(2,52),overflow=2*significance,mask=width-1;function seedrandom(seed,options,callback){function prng(){for(var n=arc4.g(chunks),d=startdenom,x=0;n<significance;)n=(n+x)*width,d*=width,x=arc4.g(1);for(;overflow<=n;)n/=2,d/=2,x>>>=1;return(n+x)/d}var key=[],shortseed=mixkey(function flatten(obj,depth){var prop,result=[],typ=typeof obj;if(depth&&"object"==typ)for(prop in obj)try{result.push(flatten(obj[prop],depth-1))}catch(e){}return result.length?result:"string"==typ?obj:obj+"\0"}((options=1==options?{entropy:!0}:options||{}).entropy?[seed,tostring(pool)]:null==seed?function(){try{var out;return nodecrypto&&(out=nodecrypto.randomBytes)?out=out(width):(out=new Uint8Array(width),(global.crypto||global.msCrypto).getRandomValues(out)),tostring(out)}catch(e){var browser=global.navigator,plugins=browser&&browser.plugins;return[+new Date,global,plugins,global.screen,tostring(pool)]}}():seed,3),key),arc4=new ARC4(key);return prng.int32=function(){return 0|arc4.g(4)},prng.quick=function(){return arc4.g(4)/4294967296},prng.double=prng,mixkey(tostring(arc4.S),pool),(options.pass||callback||function(prng,seed,is_math_call,state){return state&&(state.S&&copy(state,arc4),prng.state=function(){return copy(arc4,{})}),is_math_call?(math[rngname]=prng,seed):prng})(prng,shortseed,"global"in options?options.global:this==math,options.state)}function ARC4(key){var t,keylen=key.length,me=this,i=0,j=me.i=me.j=0,s=me.S=[];for(keylen||(key=[keylen++]);i<width;)s[i]=i++;for(i=0;i<width;i++)s[i]=s[j=mask&j+key[i%keylen]+(t=s[i])],s[j]=t;(me.g=function(count){for(var t,r=0,i=me.i,j=me.j,s=me.S;count--;)t=s[i=mask&i+1],r=r*width+s[mask&(s[i]=s[j=mask&j+t])+(s[j]=t)];return me.i=i,me.j=j,r})(width)}function copy(f,t){return t.i=f.i,t.j=f.j,t.S=f.S.slice(),t}function mixkey(seed,key){for(var smear,stringseed=seed+"",j=0;j<stringseed.length;)key[mask&j]=mask&(smear^=19*key[mask&j])+stringseed.charCodeAt(j++);return tostring(key)}function tostring(a){return String.fromCharCode.apply(0,a)}if(math["seed"+rngname]=seedrandom,mixkey(math.random(),pool),"object"==typeof module&&module.exports){module.exports=seedrandom;try{nodecrypto=require("crypto")}catch(ex){}}else 0}([],Math)},{crypto:333}],252:[function(require,module,exports){"use strict";var extendStatics,__extends=this&&this.__extends||(extendStatics=function(d,b){return(extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p])})(d,b)},function(d,b){function __(){this.constructor=d}extendStatics(d,b),d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)}),__awaiter=this&&this.__awaiter||function(thisArg,_arguments,P,generator){return new(P=P||Promise)(function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){result.done?resolve(result.value):new P(function(resolve){resolve(result.value)}).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())})},__generator=this&&this.__generator||function(thisArg,body){var f,y,t,g,_={label:0,sent:function(){if(1&t[0])throw t[1];return t[1]},trys:[],ops:[]};return g={next:verb(0),throw:verb(1),return:verb(2)},"function"==typeof Symbol&&(g[Symbol.iterator]=function(){return this}),g;function verb(n){return function(v){return function(op){if(f)throw new TypeError("Generator is already executing.");for(;_;)try{if(f=1,y&&(t=2&op[0]?y.return:op[0]?y.throw||((t=y.return)&&t.call(y),0):y.next)&&!(t=t.call(y,op[1])).done)return t;switch(y=0,t&&(op=[2&op[0],t.value]),op[0]){case 0:case 1:t=op;break;case 4:return _.label++,{value:op[1],done:!1};case 5:_.label++,y=op[1],op=[0];continue;case 7:op=_.ops.pop(),_.trys.pop();continue;default:if(!(t=0<(t=_.trys).length&&t[t.length-1])&&(6===op[0]||2===op[0])){_=0;continue}if(3===op[0]&&(!t||op[1]>t[0]&&op[1]<t[3])){_.label=op[1];break}if(6===op[0]&&_.label<t[1]){_.label=t[1],t=op;break}if(t&&_.label<t[2]){_.label=t[2],_.ops.push(op);break}t[2]&&_.ops.pop(),_.trys.pop();continue}op=body.call(thisArg,_)}catch(e){op=[6,e],y=0}finally{f=t=0}if(5&op[0])throw op[1];return{value:op[0]?op[1]:void 0,done:!0}}([n,v])}}};Object.defineProperty(exports,"__esModule",{value:!0});var tf=require("@tensorflow/tfjs-core"),seedrandom=require("seedrandom"),lazy_iterator_1=require("./iterators/lazy_iterator"),deep_map_1=require("./util/deep_map"),Dataset=function(){function Dataset(){this.size=null}return Dataset.prototype.batch=function(batchSize,smallLastBatch){var _this=this;void 0===smallLastBatch&&(smallLastBatch=!0);var base=this;return tf.util.assert(0<batchSize,function(){return"batchSize needs to be positive, but it is\n      "+batchSize}),datasetFromIteratorFn(function(){return __awaiter(_this,void 0,void 0,function(){return __generator(this,function(_a){switch(_a.label){case 0:return[4,base.iterator()];case 1:return[2,_a.sent().columnMajorBatch(batchSize,smallLastBatch,deepBatchConcat)]}})})},this.size===1/0||null==this.size?this.size:smallLastBatch?Math.ceil(this.size/batchSize):Math.floor(this.size/batchSize))},Dataset.prototype.concatenate=function(dataset){var _this=this,base=this;return datasetFromIteratorFn(function(){return __awaiter(_this,void 0,void 0,function(){var _a,_b;return __generator(this,function(_c){switch(_c.label){case 0:return[4,base.iterator()];case 1:return _b=(_a=_c.sent()).concatenate,[4,dataset.iterator()];case 2:return[2,_b.apply(_a,[_c.sent()])]}})})},this.size===1/0||dataset.size===1/0?1/0:null!=this.size&&null!=dataset.size?this.size+dataset.size:null)},Dataset.prototype.filter=function(predicate){var _this=this,base=this;return datasetFromIteratorFn(function(){return __awaiter(_this,void 0,void 0,function(){return __generator(this,function(_a){switch(_a.label){case 0:return[4,base.iterator()];case 1:return[2,_a.sent().filter(function(x){return tf.tidy(function(){return predicate(x)})})]}})})},this.size===1/0?1/0:null)},Dataset.prototype.forEachAsync=function(f){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(_a){switch(_a.label){case 0:return[4,this.iterator()];case 1:return[2,_a.sent().forEachAsync(f)]}})})},Dataset.prototype.forEach=function(f){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(_a){return tf.deprecationWarn("dataset.forEach() is deprecated and will be removed. Please use dataset.forEachAsync() instead"),[2,this.forEachAsync(f)]})})},Dataset.prototype.map=function(transform){var _this=this,base=this;return datasetFromIteratorFn(function(){return __awaiter(_this,void 0,void 0,function(){return __generator(this,function(_a){switch(_a.label){case 0:return[4,base.iterator()];case 1:return[2,_a.sent().map(function(x){return tf.tidy(function(){return transform(x)})})]}})})},this.size)},Dataset.prototype.mapAsync=function(transform){var _this=this,base=this;return datasetFromIteratorFn(function(){return __awaiter(_this,void 0,void 0,function(){return __generator(this,function(_a){switch(_a.label){case 0:return[4,base.iterator()];case 1:return[2,_a.sent().mapAsync(transform)]}})})},this.size)},Dataset.prototype.prefetch=function(bufferSize){var _this=this;if(null==bufferSize)throw new RangeError("`Dataset.prefetch()` requires bufferSize to be specified.");var base=this;return datasetFromIteratorFn(function(){return __awaiter(_this,void 0,void 0,function(){return __generator(this,function(_a){switch(_a.label){case 0:return[4,base.iterator()];case 1:return[2,_a.sent().prefetch(bufferSize)]}})})},this.size)},Dataset.prototype.repeat=function(count){var _this=this,base=this;return datasetFromIteratorFn(function(){return __awaiter(_this,void 0,void 0,function(){var iteratorIterator,_this=this;return __generator(this,function(_a){return iteratorIterator=lazy_iterator_1.iteratorFromFunction(function(){return __awaiter(_this,void 0,void 0,function(){var _a;return __generator(this,function(_b){switch(_b.label){case 0:return _a={},[4,base.iterator()];case 1:return[2,(_a.value=_b.sent(),_a.done=!1,_a)]}})})}),[2,lazy_iterator_1.iteratorFromConcatenated(iteratorIterator.take(count))]})})},null!=this.size&&0<count?this.size*count:0===count?0:null!=this.size&&(void 0===count||count<0)?1/0:null)},Dataset.prototype.skip=function(count){var _this=this,base=this;return datasetFromIteratorFn(function(){return __awaiter(_this,void 0,void 0,function(){return __generator(this,function(_a){switch(_a.label){case 0:return[4,base.iterator()];case 1:return[2,_a.sent().skip(count)]}})})},null!=this.size&&0<=count&&this.size>=count?this.size-count:null!=this.size&&(this.size<count||void 0===count||count<0)?0:null)},Dataset.prototype.shuffle=function(bufferSize,seed,reshuffleEachIteration){var _this=this;if(void 0===reshuffleEachIteration&&(reshuffleEachIteration=!0),null==bufferSize||bufferSize<0)throw null==this.size?new RangeError("`Dataset.shuffle()` requires bufferSize to be specified."):new RangeError("`Dataset.shuffle()` requires bufferSize to be specified.  If your data fits in main memory (for regular JS objects), and/or GPU memory (for `tf.Tensor`s), consider setting bufferSize to the dataset size ("+this.size+" elements)");var base=this,random=seedrandom.alea(seed||tf.util.now().toString());return datasetFromIteratorFn(function(){return __awaiter(_this,void 0,void 0,function(){var seed2;return __generator(this,function(_a){switch(_a.label){case 0:return seed2=random.int32(),reshuffleEachIteration&&(seed2+=random.int32()),[4,base.iterator()];case 1:return[2,_a.sent().shuffle(bufferSize,seed2.toString())]}})})},this.size)},Dataset.prototype.take=function(count){var _this=this,base=this;return datasetFromIteratorFn(function(){return __awaiter(_this,void 0,void 0,function(){return __generator(this,function(_a){switch(_a.label){case 0:return[4,base.iterator()];case 1:return[2,_a.sent().take(count)]}})})},null!=this.size&&this.size>count?count:null!=this.size&&this.size<=count?this.size:null)},Dataset.prototype.toArray=function(){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(_a){switch(_a.label){case 0:if(this.size===1/0)throw new Error("Can not convert infinite data stream to array.");return[4,this.iterator()];case 1:return[2,_a.sent().toArray()]}})})},Dataset.prototype.toArrayForTest=function(){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(_a){switch(_a.label){case 0:if(this.size===1/0)throw new Error("Can not convert infinite data stream to array.");return[4,this.iterator()];case 1:return[2,_a.sent().toArrayForTest()]}})})},Dataset.MAX_BUFFER_SIZE=1e4,Dataset}();function datasetFromIteratorFn(iteratorFn,size){return void 0===size&&(size=null),__extends(class_1,_super=Dataset),class_1.prototype.iterator=function(){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(_a){return[2,iteratorFn()]})})},new class_1;function class_1(){var _this=null!==_super&&_super.apply(this,arguments)||this;return _this.size=size,_this}var _super}function deepBatchConcat(rows){if(null===rows)return null;var exampleRow=rows[0];return deep_map_1.canTensorify(exampleRow)?{value:function(arrays){if(0===arrays.length)throw new Error("Can't make a batch of zero elements.");return arrays[0]instanceof tf.Tensor?tf.stack(arrays):tf.tensor(arrays)}(rows),recurse:!1}:{value:null,recurse:!0}}exports.Dataset=Dataset,exports.datasetFromIteratorFn=datasetFromIteratorFn,exports.array=function(items){var _this=this;return datasetFromIteratorFn(function(){return __awaiter(_this,void 0,void 0,function(){return __generator(this,function(_a){return[2,lazy_iterator_1.iteratorFromItems(items)]})})},items.length)},exports.zip=function(datasets){var size,_this=this;if(!deep_map_1.isIterable(datasets))throw new Error("The argument to zip() must be an object or array.");if(Array.isArray(datasets))for(var i=0;i<datasets.length;i++)size=null==size?datasets[i].size:Math.min(size,datasets[i].size);else if(datasets instanceof Object)for(var ds in datasets)size=null==size?datasets[ds].size:Math.min(size,datasets[ds].size);return datasetFromIteratorFn(function(){return __awaiter(_this,void 0,void 0,function(){var streams;return __generator(this,function(_a){switch(_a.label){case 0:return[4,deep_map_1.deepMapAndAwaitAll(datasets,function(d){if(d instanceof Dataset)return{value:d.iterator(),recurse:!1};if(deep_map_1.isIterable(d))return{value:null,recurse:!0};throw new Error("Leaves of the structure passed to zip() must be Datasets, not primitives.")})];case 1:return streams=_a.sent(),[2,lazy_iterator_1.iteratorFromZipped(streams,lazy_iterator_1.ZipMismatchMode.SHORTEST)]}})})},size)}},{"./iterators/lazy_iterator":259,"./util/deep_map":268,"@tensorflow/tfjs-core":148,seedrandom:338}],253:[function(require,module,exports){"use strict";var extendStatics,__extends=this&&this.__extends||(extendStatics=function(d,b){return(extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p])})(d,b)},function(d,b){function __(){this.constructor=d}extendStatics(d,b),d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)}),__awaiter=this&&this.__awaiter||function(thisArg,_arguments,P,generator){return new(P=P||Promise)(function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){result.done?resolve(result.value):new P(function(resolve){resolve(result.value)}).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())})},__generator=this&&this.__generator||function(thisArg,body){var f,y,t,g,_={label:0,sent:function(){if(1&t[0])throw t[1];return t[1]},trys:[],ops:[]};return g={next:verb(0),throw:verb(1),return:verb(2)},"function"==typeof Symbol&&(g[Symbol.iterator]=function(){return this}),g;function verb(n){return function(v){return function(op){if(f)throw new TypeError("Generator is already executing.");for(;_;)try{if(f=1,y&&(t=2&op[0]?y.return:op[0]?y.throw||((t=y.return)&&t.call(y),0):y.next)&&!(t=t.call(y,op[1])).done)return t;switch(y=0,t&&(op=[2&op[0],t.value]),op[0]){case 0:case 1:t=op;break;case 4:return _.label++,{value:op[1],done:!1};case 5:_.label++,y=op[1],op=[0];continue;case 7:op=_.ops.pop(),_.trys.pop();continue;default:if(!(t=0<(t=_.trys).length&&t[t.length-1])&&(6===op[0]||2===op[0])){_=0;continue}if(3===op[0]&&(!t||op[1]>t[0]&&op[1]<t[3])){_.label=op[1];break}if(6===op[0]&&_.label<t[1]){_.label=t[1],t=op;break}if(t&&_.label<t[2]){_.label=t[2],_.ops.push(op);break}t[2]&&_.ops.pop(),_.trys.pop();continue}op=body.call(thisArg,_)}catch(e){op=[6,e],y=0}finally{f=t=0}if(5&op[0])throw op[1];return{value:op[0]?op[1]:void 0,done:!0}}([n,v])}}};Object.defineProperty(exports,"__esModule",{value:!0});var tfjs_core_1=require("@tensorflow/tfjs-core"),dataset_1=require("../dataset"),text_line_dataset_1=require("./text_line_dataset"),STATE_OUT=Symbol("out"),STATE_FIELD=Symbol("field"),STATE_QUOTE=Symbol("quote"),STATE_QUOTE_AFTER_QUOTE=Symbol("quoteafterquote"),STATE_WITHIN_QUOTE_IN_QUOTE=Symbol("quoteinquote"),CSVDataset=function(_super){function CSVDataset(input,csvConfig){var _this=_super.call(this)||this;return _this.input=input,_this.hasHeader=!0,_this.fullColumnNames=null,_this.columnNamesValidated=!1,_this.columnConfigs=null,_this.configuredColumnsOnly=!1,_this.delimiter=",",_this.delimWhitespace=!1,_this.base=new text_line_dataset_1.TextLineDataset(input),csvConfig=csvConfig||{},_this.hasHeader=!1!==csvConfig.hasHeader,_this.fullColumnNames=csvConfig.columnNames,_this.columnConfigs=csvConfig.columnConfigs,_this.configuredColumnsOnly=csvConfig.configuredColumnsOnly,csvConfig.delimWhitespace?(tfjs_core_1.util.assert(null==csvConfig.delimiter,function(){return"Delimiter should not be provided when delimWhitespace is true."}),_this.delimWhitespace=!0,_this.delimiter=" "):_this.delimiter=csvConfig.delimiter?csvConfig.delimiter:",",_this}return __extends(CSVDataset,_super),CSVDataset.prototype.columnNames=function(){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(_a){switch(_a.label){case 0:return this.columnNamesValidated?[3,2]:[4,this.setColumnNames()];case 1:_a.sent(),_a.label=2;case 2:return[2,this.configuredColumnsOnly?Object.keys(this.columnConfigs):this.fullColumnNames]}})})},CSVDataset.prototype.setColumnNames=function(){return __awaiter(this,void 0,void 0,function(){var columnNamesFromFile,counts,duplicateNames,_i,_a,key,_this=this;return __generator(this,function(_b){switch(_b.label){case 0:return[4,this.maybeReadHeaderLine()];case 1:if(columnNamesFromFile=_b.sent(),!this.fullColumnNames&&!columnNamesFromFile)throw new Error("Column names must be provided if there is no header line.");if(this.fullColumnNames&&columnNamesFromFile&&tfjs_core_1.util.assert(columnNamesFromFile.length===this.fullColumnNames.length,function(){return"The length of provided columnNames ("+_this.fullColumnNames.length.toString()+") does not match the length of the header line read from file ("+columnNamesFromFile.length.toString()+")."}),this.fullColumnNames||(this.fullColumnNames=columnNamesFromFile),counts=this.fullColumnNames.reduce(function(countAcc,name){return countAcc[name]=countAcc[name]+1||1,countAcc},{}),duplicateNames=Object.keys(counts).filter(function(name){return 1<counts[name]}),tfjs_core_1.util.assert(0===duplicateNames.length,function(){return"Duplicate column names found: "+duplicateNames.toString()}),this.columnConfigs)for(_i=0,_a=Object.keys(this.columnConfigs);_i<_a.length;_i++)if(key=_a[_i],-1===this.fullColumnNames.indexOf(key))throw new Error('The key "'+key+'" provided in columnConfigs does not match any of the column names ('+this.fullColumnNames.toString()+").");return this.columnNamesValidated=!0,[2]}})})},CSVDataset.prototype.maybeReadHeaderLine=function(){return __awaiter(this,void 0,void 0,function(){var firstElement,firstLine;return __generator(this,function(_a){switch(_a.label){case 0:return this.hasHeader?[4,this.base.iterator()]:[3,3];case 1:return[4,_a.sent().next()];case 2:if((firstElement=_a.sent()).done)throw new Error("No data was found for CSV parsing.");return firstLine=firstElement.value,[2,this.parseRow(firstLine,!1)];case 3:return[2,null]}})})},CSVDataset.prototype.iterator=function(){return __awaiter(this,void 0,void 0,function(){var lines,_this=this;return __generator(this,function(_a){switch(_a.label){case 0:return this.columnNamesValidated?[3,2]:[4,this.setColumnNames()];case 1:_a.sent(),_a.label=2;case 2:return[4,this.base.iterator()];case 3:return lines=_a.sent(),this.hasHeader&&(lines=lines.skip(1)),[2,lines.map(function(x){return _this.makeDataElement(x)})]}})})},CSVDataset.prototype.makeDataElement=function(line){for(var values=this.parseRow(line),features={},labels={},i=0;i<this.fullColumnNames.length;i++){var key=this.fullColumnNames[i],config=this.columnConfigs?this.columnConfigs[key]:null;if(!this.configuredColumnsOnly||config){var value=values[i],parsedValue=null;if(""===value)if(config&&void 0!==config.default)parsedValue=config.default;else{if(config&&(config.required||config.isLabel))throw new Error("Required column "+key+" is empty in this line: "+line);parsedValue=void 0}else{var valueAsNum=Number(value);if(isNaN(valueAsNum))parsedValue=config&&"bool"===config.dtype?this.getBoolean(value):value;else if(config&&config.dtype)switch(config.dtype){case"float32":parsedValue=valueAsNum;break;case"int32":parsedValue=Math.floor(valueAsNum);break;case"bool":parsedValue=this.getBoolean(value);break;default:parsedValue=valueAsNum}else parsedValue=valueAsNum}config&&config.isLabel?labels[key]=parsedValue:features[key]=parsedValue}}return 0===Object.keys(labels).length?features:{xs:features,ys:labels}},CSVDataset.prototype.getBoolean=function(value){return"1"===value||"true"===value.toLowerCase()?1:0},CSVDataset.prototype.parseRow=function(line,validateElementCount){void 0===validateElementCount&&(validateElementCount=!0);for(var result=[],readOffset=0,readLength=line.length,currentState=STATE_OUT,i=0;i<readLength;i++)switch(currentState){case STATE_OUT:switch(line.charAt(i)){case'"':readOffset=i+1,currentState=STATE_QUOTE;break;case this.delimiter:if(readOffset=i+1," "===this.delimiter&&this.delimWhitespace)break;result.push(""),currentState=STATE_OUT;break;default:currentState=STATE_FIELD,readOffset=i}break;case STATE_FIELD:switch(line.charAt(i)){case this.delimiter:result.push(line.substring(readOffset,i)),currentState=STATE_OUT,readOffset=i+1}break;case STATE_QUOTE:switch(line.charAt(i)){case'"':currentState=STATE_QUOTE_AFTER_QUOTE}break;case STATE_QUOTE_AFTER_QUOTE:switch(line.charAt(i)){case this.delimiter:result.push(line.substring(readOffset,i-1)),currentState=STATE_OUT,readOffset=i+1;break;case'"':currentState=STATE_QUOTE;break;default:currentState=STATE_WITHIN_QUOTE_IN_QUOTE}break;case STATE_WITHIN_QUOTE_IN_QUOTE:switch(line.charAt(i)){case'"':currentState=STATE_QUOTE}}if(currentState===STATE_QUOTE_AFTER_QUOTE?result.push(line.substring(readOffset,readLength-1)):result.push(line.substring(readOffset)),validateElementCount&&result.length!==this.fullColumnNames.length)throw new Error("Invalid row in csv file. Should have "+this.fullColumnNames.length+" elements in a row, but got "+result);return result},CSVDataset}(dataset_1.Dataset);exports.CSVDataset=CSVDataset},{"../dataset":252,"./text_line_dataset":254,"@tensorflow/tfjs-core":148}],254:[function(require,module,exports){"use strict";var extendStatics,__extends=this&&this.__extends||(extendStatics=function(d,b){return(extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p])})(d,b)},function(d,b){function __(){this.constructor=d}extendStatics(d,b),d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)}),__awaiter=this&&this.__awaiter||function(thisArg,_arguments,P,generator){return new(P=P||Promise)(function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){result.done?resolve(result.value):new P(function(resolve){resolve(result.value)}).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())})},__generator=this&&this.__generator||function(thisArg,body){var f,y,t,g,_={label:0,sent:function(){if(1&t[0])throw t[1];return t[1]},trys:[],ops:[]};return g={next:verb(0),throw:verb(1),return:verb(2)},"function"==typeof Symbol&&(g[Symbol.iterator]=function(){return this}),g;function verb(n){return function(v){return function(op){if(f)throw new TypeError("Generator is already executing.");for(;_;)try{if(f=1,y&&(t=2&op[0]?y.return:op[0]?y.throw||((t=y.return)&&t.call(y),0):y.next)&&!(t=t.call(y,op[1])).done)return t;switch(y=0,t&&(op=[2&op[0],t.value]),op[0]){case 0:case 1:t=op;break;case 4:return _.label++,{value:op[1],done:!1};case 5:_.label++,y=op[1],op=[0];continue;case 7:op=_.ops.pop(),_.trys.pop();continue;default:if(!(t=0<(t=_.trys).length&&t[t.length-1])&&(6===op[0]||2===op[0])){_=0;continue}if(3===op[0]&&(!t||op[1]>t[0]&&op[1]<t[3])){_.label=op[1];break}if(6===op[0]&&_.label<t[1]){_.label=t[1],t=op;break}if(t&&_.label<t[2]){_.label=t[2],_.ops.push(op);break}t[2]&&_.ops.pop(),_.trys.pop();continue}op=body.call(thisArg,_)}catch(e){op=[6,e],y=0}finally{f=t=0}if(5&op[0])throw op[1];return{value:op[0]?op[1]:void 0,done:!0}}([n,v])}}};Object.defineProperty(exports,"__esModule",{value:!0});var TextLineDataset=function(_super){function TextLineDataset(input){var _this=_super.call(this)||this;return _this.input=input,_this}return __extends(TextLineDataset,_super),TextLineDataset.prototype.iterator=function(){return __awaiter(this,void 0,void 0,function(){var inputIterator,utf8Iterator;return __generator(this,function(_a){switch(_a.label){case 0:return[4,this.input.iterator()];case 1:return inputIterator=_a.sent(),utf8Iterator=inputIterator.decodeUTF8(),[2,utf8Iterator.split("\n").map(function(line){return line.endsWith("\r")&&(line=line.slice(0,-1)),line})]}})})},TextLineDataset}(require("../dataset").Dataset);exports.TextLineDataset=TextLineDataset},{"../dataset":252}],255:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});function DataSource(){}exports.DataSource=DataSource},{}],256:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var dataset_1=require("./dataset");exports.array=dataset_1.array,exports.Dataset=dataset_1.Dataset,exports.zip=dataset_1.zip;var csv_dataset_1=require("./datasets/csv_dataset");exports.CSVDataset=csv_dataset_1.CSVDataset;var text_line_dataset_1=require("./datasets/text_line_dataset");exports.TextLineDataset=text_line_dataset_1.TextLineDataset;var readers_1=require("./readers");exports.csv=readers_1.csv,exports.func=readers_1.func,exports.generator=readers_1.generator,exports.microphone=readers_1.microphone,exports.webcam=readers_1.webcam;var file_data_source_1=require("./sources/file_data_source");exports.FileDataSource=file_data_source_1.FileDataSource;var url_data_source_1=require("./sources/url_data_source");exports.URLDataSource=url_data_source_1.URLDataSource;var version_1=require("./version");exports.version_data=version_1.version},{"./dataset":252,"./datasets/csv_dataset":253,"./datasets/text_line_dataset":254,"./readers":264,"./sources/file_data_source":265,"./sources/url_data_source":266,"./version":272}],257:[function(require,module,exports){(function(Buffer){"use strict";var extendStatics,__extends=this&&this.__extends||(extendStatics=function(d,b){return(extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p])})(d,b)},function(d,b){function __(){this.constructor=d}extendStatics(d,b),d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)}),__awaiter=this&&this.__awaiter||function(thisArg,_arguments,P,generator){return new(P=P||Promise)(function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){result.done?resolve(result.value):new P(function(resolve){resolve(result.value)}).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())})},__generator=this&&this.__generator||function(thisArg,body){var f,y,t,g,_={label:0,sent:function(){if(1&t[0])throw t[1];return t[1]},trys:[],ops:[]};return g={next:verb(0),throw:verb(1),return:verb(2)},"function"==typeof Symbol&&(g[Symbol.iterator]=function(){return this}),g;function verb(n){return function(v){return function(op){if(f)throw new TypeError("Generator is already executing.");for(;_;)try{if(f=1,y&&(t=2&op[0]?y.return:op[0]?y.throw||((t=y.return)&&t.call(y),0):y.next)&&!(t=t.call(y,op[1])).done)return t;switch(y=0,t&&(op=[2&op[0],t.value]),op[0]){case 0:case 1:t=op;break;case 4:return _.label++,{value:op[1],done:!1};case 5:_.label++,y=op[1],op=[0];continue;case 7:op=_.ops.pop(),_.trys.pop();continue;default:if(!(t=0<(t=_.trys).length&&t[t.length-1])&&(6===op[0]||2===op[0])){_=0;continue}if(3===op[0]&&(!t||op[1]>t[0]&&op[1]<t[3])){_.label=op[1];break}if(6===op[0]&&_.label<t[1]){_.label=t[1],t=op;break}if(t&&_.label<t[2]){_.label=t[2],_.ops.push(op);break}t[2]&&_.ops.pop(),_.trys.pop();continue}op=body.call(thisArg,_)}catch(e){op=[6,e],y=0}finally{f=t=0}if(5&op[0])throw op[1];return{value:op[0]?op[1]:void 0,done:!0}}([n,v])}}};Object.defineProperty(exports,"__esModule",{value:!0});var tfjs_core_1=require("@tensorflow/tfjs-core"),lazy_iterator_1=require("./lazy_iterator"),string_iterator_1=require("./string_iterator"),ByteChunkIterator=function(_super){function ByteChunkIterator(){return null!==_super&&_super.apply(this,arguments)||this}return __extends(ByteChunkIterator,_super),ByteChunkIterator.prototype.decodeUTF8=function(){return new Utf8Iterator(this)},ByteChunkIterator}(lazy_iterator_1.LazyIterator);exports.ByteChunkIterator=ByteChunkIterator;var Utf8Iterator=function(_super){function Utf8Iterator(upstream){var _this=_super.call(this)||this;return _this.upstream=upstream,_this.impl=new Utf8IteratorImpl(upstream),_this}return __extends(Utf8Iterator,_super),Utf8Iterator.prototype.summary=function(){return this.impl.summary()},Utf8Iterator.prototype.next=function(){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(_a){return[2,this.impl.next()]})})},Utf8Iterator}(string_iterator_1.StringIterator),Utf8IteratorImpl=function(_super){function Utf8IteratorImpl(upstream){var _this=_super.call(this)||this;if(_this.upstream=upstream,tfjs_core_1.ENV.get("IS_BROWSER"))_this.decoder=new TextDecoder("utf-8");else{var StringDecoder=require("string_decoder").StringDecoder;_this.decoder=new StringDecoder("utf8")}return _this}return __extends(Utf8IteratorImpl,_super),Utf8IteratorImpl.prototype.summary=function(){return this.upstream.summary()+" -> Utf8"},Utf8IteratorImpl.prototype.pump=function(){return __awaiter(this,void 0,void 0,function(){var chunkResult,chunk,text;return __generator(this,function(_a){switch(_a.label){case 0:return[4,this.upstream.next()];case 1:return(chunkResult=_a.sent()).done?[2,!1]:(chunk=chunkResult.value,text=tfjs_core_1.ENV.get("IS_BROWSER")?this.decoder.decode(chunk,{stream:!0}):this.decoder.write(Buffer.from(chunk.buffer)),this.outputQueue.push(text),[2,!0])}})})},Utf8IteratorImpl}(lazy_iterator_1.OneToManyIterator)}).call(this,require("buffer").Buffer)},{"./lazy_iterator":259,"./string_iterator":261,"@tensorflow/tfjs-core":148,buffer:334,string_decoder:333}],258:[function(require,module,exports){"use strict";var extendStatics,__extends=this&&this.__extends||(extendStatics=function(d,b){return(extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p])})(d,b)},function(d,b){function __(){this.constructor=d}extendStatics(d,b),d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)}),__awaiter=this&&this.__awaiter||function(thisArg,_arguments,P,generator){return new(P=P||Promise)(function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){result.done?resolve(result.value):new P(function(resolve){resolve(result.value)}).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())})},__generator=this&&this.__generator||function(thisArg,body){var f,y,t,g,_={label:0,sent:function(){if(1&t[0])throw t[1];return t[1]},trys:[],ops:[]};return g={next:verb(0),throw:verb(1),return:verb(2)},"function"==typeof Symbol&&(g[Symbol.iterator]=function(){return this}),g;function verb(n){return function(v){return function(op){if(f)throw new TypeError("Generator is already executing.");for(;_;)try{if(f=1,y&&(t=2&op[0]?y.return:op[0]?y.throw||((t=y.return)&&t.call(y),0):y.next)&&!(t=t.call(y,op[1])).done)return t;switch(y=0,t&&(op=[2&op[0],t.value]),op[0]){case 0:case 1:t=op;break;case 4:return _.label++,{value:op[1],done:!1};case 5:_.label++,y=op[1],op=[0];continue;case 7:op=_.ops.pop(),_.trys.pop();continue;default:if(!(t=0<(t=_.trys).length&&t[t.length-1])&&(6===op[0]||2===op[0])){_=0;continue}if(3===op[0]&&(!t||op[1]>t[0]&&op[1]<t[3])){_.label=op[1];break}if(6===op[0]&&_.label<t[1]){_.label=t[1],t=op;break}if(t&&_.label<t[2]){_.label=t[2],_.ops.push(op);break}t[2]&&_.ops.pop(),_.trys.pop();continue}op=body.call(thisArg,_)}catch(e){op=[6,e],y=0}finally{f=t=0}if(5&op[0])throw op[1];return{value:op[0]?op[1]:void 0,done:!0}}([n,v])}}};Object.defineProperty(exports,"__esModule",{value:!0});var tfjs_core_1=require("@tensorflow/tfjs-core"),FileChunkIterator=function(_super){function FileChunkIterator(file,options){void 0===options&&(options={});var _this=_super.call(this)||this;return _this.file=file,_this.options=options,tfjs_core_1.util.assert(file instanceof Uint8Array||!!tfjs_core_1.ENV.get("IS_BROWSER")&&(file instanceof File||file instanceof Blob),function(){return"FileChunkIterator only supports File, Blob and Uint8Array right now."}),_this.offset=options.offset||0,_this.chunkSize=options.chunkSize||1048576,_this}return __extends(FileChunkIterator,_super),FileChunkIterator.prototype.summary=function(){return"FileChunks "+this.file},FileChunkIterator.prototype.next=function(){return __awaiter(this,void 0,void 0,function(){var chunk,_a,_this=this;return __generator(this,function(_b){switch(_b.label){case 0:return this.offset>=(this.file instanceof Uint8Array?this.file.byteLength:this.file.size)?[2,{value:null,done:!0}]:(chunk=new Promise(function(resolve,reject){var end=_this.offset+_this.chunkSize;if(_this.file instanceof Uint8Array)resolve(new Uint8Array(_this.file.slice(_this.offset,end)));else{var fileReader_1=new FileReader;fileReader_1.onload=function(event){var data=fileReader_1.result;if(data instanceof ArrayBuffer&&(data=new Uint8Array(data)),!(data instanceof Uint8Array))return reject(new TypeError("FileReader returned unknown type."));resolve(data)},fileReader_1.onabort=function(event){return reject(new Error("Aborted"))},fileReader_1.onerror=function(event){return reject(new Error(event.type))};var slice=_this.file.slice(_this.offset,end);fileReader_1.readAsArrayBuffer(slice)}_this.offset=end}),_a={},[4,chunk]);case 1:return[2,(_a.value=_b.sent(),_a.done=!1,_a)]}})})},FileChunkIterator}(require("./byte_chunk_iterator").ByteChunkIterator);exports.FileChunkIterator=FileChunkIterator},{"./byte_chunk_iterator":257,"@tensorflow/tfjs-core":148}],259:[function(require,module,exports){"use strict";var extendStatics,__extends=this&&this.__extends||(extendStatics=function(d,b){return(extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p])})(d,b)},function(d,b){function __(){this.constructor=d}extendStatics(d,b),d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)}),__awaiter=this&&this.__awaiter||function(thisArg,_arguments,P,generator){return new(P=P||Promise)(function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){result.done?resolve(result.value):new P(function(resolve){resolve(result.value)}).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())})},__generator=this&&this.__generator||function(thisArg,body){var f,y,t,g,_={label:0,sent:function(){if(1&t[0])throw t[1];return t[1]},trys:[],ops:[]};return g={next:verb(0),throw:verb(1),return:verb(2)},"function"==typeof Symbol&&(g[Symbol.iterator]=function(){return this}),g;function verb(n){return function(v){return function(op){if(f)throw new TypeError("Generator is already executing.");for(;_;)try{if(f=1,y&&(t=2&op[0]?y.return:op[0]?y.throw||((t=y.return)&&t.call(y),0):y.next)&&!(t=t.call(y,op[1])).done)return t;switch(y=0,t&&(op=[2&op[0],t.value]),op[0]){case 0:case 1:t=op;break;case 4:return _.label++,{value:op[1],done:!1};case 5:_.label++,y=op[1],op=[0];continue;case 7:op=_.ops.pop(),_.trys.pop();continue;default:if(!(t=0<(t=_.trys).length&&t[t.length-1])&&(6===op[0]||2===op[0])){_=0;continue}if(3===op[0]&&(!t||op[1]>t[0]&&op[1]<t[3])){_.label=op[1];break}if(6===op[0]&&_.label<t[1]){_.label=t[1],t=op;break}if(t&&_.label<t[2]){_.label=t[2],_.ops.push(op);break}t[2]&&_.ops.pop(),_.trys.pop();continue}op=body.call(thisArg,_)}catch(e){op=[6,e],y=0}finally{f=t=0}if(5&op[0])throw op[1];return{value:op[0]?op[1]:void 0,done:!0}}([n,v])}}};Object.defineProperty(exports,"__esModule",{value:!0});var tf=require("@tensorflow/tfjs-core"),seedrandom=require("seedrandom"),deep_clone_1=require("../util/deep_clone"),deep_map_1=require("../util/deep_map"),growing_ring_buffer_1=require("../util/growing_ring_buffer"),ring_buffer_1=require("../util/ring_buffer");function iteratorFromItems(items){return new ArrayIterator(items)}function iteratorFromFunction(func){return new FunctionCallIterator(func)}function iteratorFromConcatenated(baseIterators,baseErrorHandler){return new ChainedIterator(baseIterators,baseErrorHandler)}exports.iteratorFromItems=iteratorFromItems,exports.iteratorFromIncrementing=function(start){var i=start;return iteratorFromFunction(function(){return{value:i++,done:!1}})},exports.iteratorFromFunction=iteratorFromFunction,exports.iteratorFromConcatenated=iteratorFromConcatenated,exports.iteratorFromConcatenatedFunction=function(iteratorFunc,count,baseErrorHandler){return iteratorFromConcatenated(iteratorFromFunction(iteratorFunc).take(count),baseErrorHandler)},exports.iteratorFromZipped=function(iterators,mismatchMode){return void 0===mismatchMode&&(mismatchMode=ZipMismatchMode.FAIL),new ZipIterator(iterators,mismatchMode)};var ZipMismatchMode,LazyIterator=function(){function LazyIterator(){}return LazyIterator.prototype.toArray=function(){return __awaiter(this,void 0,void 0,function(){var result,x;return __generator(this,function(_a){switch(_a.label){case 0:return result=[],[4,this.next()];case 1:x=_a.sent(),_a.label=2;case 2:return x.done?[3,4]:(result.push(x.value),[4,this.next()]);case 3:return x=_a.sent(),[3,2];case 4:return[2,result]}})})},LazyIterator.prototype.toArrayForTest=function(){return __awaiter(this,void 0,void 0,function(){var stream,result,x;return __generator(this,function(_a){switch(_a.label){case 0:return stream=this.prefetch(100),result=[],[4,stream.next()];case 1:x=_a.sent(),_a.label=2;case 2:return x.done?[3,4]:(result.push(x.value),[4,stream.next()]);case 3:return x=_a.sent(),[3,2];case 4:return[2,result]}})})},LazyIterator.prototype.resolveFully=function(){return __awaiter(this,void 0,void 0,function(){var x;return __generator(this,function(_a){switch(_a.label){case 0:return[4,this.next()];case 1:x=_a.sent(),_a.label=2;case 2:return x.done?[3,4]:[4,this.next()];case 3:return x=_a.sent(),[3,2];case 4:return[2]}})})},LazyIterator.prototype.resolveWhile=function(predicate){return __awaiter(this,void 0,void 0,function(){var x,shouldContinue;return __generator(this,function(_a){switch(_a.label){case 0:return[4,this.next()];case 1:x=_a.sent(),shouldContinue=predicate(x.value),_a.label=2;case 2:return x.done||!shouldContinue?[3,4]:[4,this.next()];case 3:return x=_a.sent(),shouldContinue=predicate(x.value),[3,2];case 4:return[2]}})})},LazyIterator.prototype.handleErrors=function(handler){return new ErrorHandlingLazyIterator(this,handler)},LazyIterator.prototype.filter=function(predicate){return new FilterIterator(this,predicate)},LazyIterator.prototype.map=function(transform){return new MapIterator(this,transform)},LazyIterator.prototype.mapAsync=function(transform){return new AsyncMapIterator(this,transform)},LazyIterator.prototype.serialMapAsync=function(transform){return new AsyncMapIterator(this,transform).serial()},LazyIterator.prototype.flatmap=function(transform){return new FlatmapIterator(this,transform)},LazyIterator.prototype.forEachAsync=function(f){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(_a){return[2,this.map(f).resolveFully()]})})},LazyIterator.prototype.serialForEach=function(f){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(_a){return[2,this.serialMapAsync(f).resolveWhile(function(x){return!0===x})]})})},LazyIterator.prototype.rowMajorBatch=function(batchSize,smallLastBatch){return void 0===smallLastBatch&&(smallLastBatch=!0),new RowMajorBatchIterator(this,batchSize,smallLastBatch)},LazyIterator.prototype.columnMajorBatch=function(batchSize,smallLastBatch,zipFn){return void 0===smallLastBatch&&(smallLastBatch=!0),void 0===zipFn&&(zipFn=deep_map_1.zipToList),this.rowMajorBatch(batchSize,smallLastBatch).map(function(x){return deep_map_1.deepZip(x,zipFn)})},LazyIterator.prototype.concatenate=function(iterator,baseErrorHandler){return new ChainedIterator(iteratorFromItems([this,iterator]),baseErrorHandler)},LazyIterator.prototype.take=function(count){return count<0||null==count?this:new TakeIterator(this,count)},LazyIterator.prototype.skip=function(count){return count<0||null==count?this:new SkipIterator(this,count)},LazyIterator.prototype.prefetch=function(bufferSize){return new PrefetchIterator(this,bufferSize)},LazyIterator.prototype.shuffle=function(windowSize,seed){return new ShuffleIterator(this,windowSize,seed)},LazyIterator.prototype.serial=function(){return new SerialIterator(this)},LazyIterator}(),ArrayIterator=function(_super){function ArrayIterator(items){var _this=_super.call(this)||this;return _this.items=items,_this.trav=0,_this}return __extends(ArrayIterator,_super),ArrayIterator.prototype.summary=function(){return"Array of "+this.items.length+" items"},ArrayIterator.prototype.next=function(){return __awaiter(this,void 0,void 0,function(){var item;return __generator(this,function(_a){return this.trav>=this.items.length?[2,{value:null,done:!0}]:(item=this.items[this.trav],this.trav++,[2,{value:deep_clone_1.deepClone(item),done:!1}])})})},ArrayIterator}(exports.LazyIterator=LazyIterator),FunctionCallIterator=function(_super){function FunctionCallIterator(nextFn){var _this=_super.call(this)||this;return _this.nextFn=nextFn,_this}return __extends(FunctionCallIterator,_super),FunctionCallIterator.prototype.summary=function(){return"Function call"},FunctionCallIterator.prototype.next=function(){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(_a){try{return[2,this.nextFn()]}catch(e){throw e.message="Error thrown while iterating through a dataset: "+e.message,e}return[2]})})},FunctionCallIterator}(LazyIterator),SerialIterator=function(_super){function SerialIterator(upstream){var _this=_super.call(this)||this;return _this.upstream=upstream,_this.lastRead=Promise.resolve({value:null,done:!1}),_this}return __extends(SerialIterator,_super),SerialIterator.prototype.summary=function(){return this.upstream.summary()+" -> Serial"},SerialIterator.prototype.next=function(){return __awaiter(this,void 0,void 0,function(){var _this=this;return __generator(this,function(_a){return this.lastRead=this.lastRead.then(function(){return _this.serialNext()}),[2,this.lastRead]})})},SerialIterator.prototype.serialNext=function(){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(_a){return[2,this.upstream.next()]})})},SerialIterator}(LazyIterator),SkipIterator=function(_super){function SkipIterator(upstream,maxCount){var _this=_super.call(this)||this;return _this.upstream=upstream,_this.maxCount=maxCount,_this.count=0,_this.lastRead=Promise.resolve({value:null,done:!1}),_this}return __extends(SkipIterator,_super),SkipIterator.prototype.summary=function(){return this.upstream.summary()+" -> Skip"},SkipIterator.prototype.next=function(){return __awaiter(this,void 0,void 0,function(){var _this=this;return __generator(this,function(_a){return this.lastRead=this.lastRead.then(function(){return _this.serialNext()}),[2,this.lastRead]})})},SkipIterator.prototype.serialNext=function(){return __awaiter(this,void 0,void 0,function(){var skipped;return __generator(this,function(_a){switch(_a.label){case 0:return this.count++<this.maxCount?[4,this.upstream.next()]:[3,2];case 1:return(skipped=_a.sent()).done?[2,skipped]:(tf.dispose(skipped.value),[3,0]);case 2:return[2,this.upstream.next()]}})})},SkipIterator}(LazyIterator),TakeIterator=function(_super){function TakeIterator(upstream,maxCount){var _this=_super.call(this)||this;return _this.upstream=upstream,_this.maxCount=maxCount,_this.count=0,_this}return __extends(TakeIterator,_super),TakeIterator.prototype.summary=function(){return this.upstream.summary()+" -> Take"},TakeIterator.prototype.next=function(){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(_a){return this.count++>=this.maxCount?[2,{value:null,done:!0}]:[2,this.upstream.next()]})})},TakeIterator}(LazyIterator),RowMajorBatchIterator=function(_super){function RowMajorBatchIterator(upstream,batchSize,enableSmallLastBatch){void 0===enableSmallLastBatch&&(enableSmallLastBatch=!0);var _this=_super.call(this)||this;return _this.upstream=upstream,_this.batchSize=batchSize,_this.enableSmallLastBatch=enableSmallLastBatch,_this.lastRead=Promise.resolve({value:null,done:!1}),_this}return __extends(RowMajorBatchIterator,_super),RowMajorBatchIterator.prototype.summary=function(){return this.upstream.summary()+" -> RowMajorBatch"},RowMajorBatchIterator.prototype.next=function(){return __awaiter(this,void 0,void 0,function(){var _this=this;return __generator(this,function(_a){return this.lastRead=this.lastRead.then(function(){return _this.serialNext()}),[2,this.lastRead]})})},RowMajorBatchIterator.prototype.serialNext=function(){return __awaiter(this,void 0,void 0,function(){var batch,item;return __generator(this,function(_a){switch(_a.label){case 0:batch=[],_a.label=1;case 1:return batch.length<this.batchSize?[4,this.upstream.next()]:[3,3];case 2:return(item=_a.sent()).done?this.enableSmallLastBatch&&0<batch.length?[2,{value:batch,done:!1}]:[2,{value:null,done:!0}]:(batch.push(item.value),[3,1]);case 3:return[2,{value:batch,done:!1}]}})})},RowMajorBatchIterator}(LazyIterator),FilterIterator=function(_super){function FilterIterator(upstream,predicate){var _this=_super.call(this)||this;return _this.upstream=upstream,_this.predicate=predicate,_this.lastRead=Promise.resolve({value:null,done:!1}),_this}return __extends(FilterIterator,_super),FilterIterator.prototype.summary=function(){return this.upstream.summary()+" -> Filter"},FilterIterator.prototype.next=function(){return __awaiter(this,void 0,void 0,function(){var _this=this;return __generator(this,function(_a){return this.lastRead=this.lastRead.then(function(){return _this.serialNext()}),[2,this.lastRead]})})},FilterIterator.prototype.serialNext=function(){return __awaiter(this,void 0,void 0,function(){var item;return __generator(this,function(_a){switch(_a.label){case 0:return[4,this.upstream.next()];case 1:return(item=_a.sent()).done||this.predicate(item.value)?[2,item]:(tf.dispose(item.value),[3,0]);case 2:return[2]}})})},FilterIterator}(LazyIterator),MapIterator=function(_super){function MapIterator(upstream,transform){var _this=_super.call(this)||this;return _this.upstream=upstream,_this.transform=transform,_this}return __extends(MapIterator,_super),MapIterator.prototype.summary=function(){return this.upstream.summary()+" -> Map"},MapIterator.prototype.next=function(){return __awaiter(this,void 0,void 0,function(){var item,inputTensors,mapped,outputTensors,_i,inputTensors_1,t;return __generator(this,function(_a){switch(_a.label){case 0:return[4,this.upstream.next()];case 1:if((item=_a.sent()).done)return[2,{value:null,done:!0}];for(inputTensors=tf.tensor_util.getTensorsInContainer(item.value),mapped=this.transform(item.value),outputTensors=tf.tensor_util.getTensorsInContainer(mapped),_i=0,inputTensors_1=inputTensors;_i<inputTensors_1.length;_i++)t=inputTensors_1[_i],tf.tensor_util.isTensorInList(t,outputTensors)||t.dispose();return[2,{value:mapped,done:!1}]}})})},MapIterator}(LazyIterator),ErrorHandlingLazyIterator=function(_super){function ErrorHandlingLazyIterator(upstream,handler){var _this=_super.call(this)||this;return _this.upstream=upstream,_this.handler=handler,_this.count=0,_this.lastRead=Promise.resolve({value:null,done:!1}),_this}return __extends(ErrorHandlingLazyIterator,_super),ErrorHandlingLazyIterator.prototype.summary=function(){return this.upstream.summary()+" -> handleErrors"},ErrorHandlingLazyIterator.prototype.next=function(){return __awaiter(this,void 0,void 0,function(){var _this=this;return __generator(this,function(_a){return this.lastRead=this.lastRead.then(function(){return _this.serialNext()}),[2,this.lastRead]})})},ErrorHandlingLazyIterator.prototype.serialNext=function(){return __awaiter(this,void 0,void 0,function(){var e_1;return __generator(this,function(_a){switch(_a.label){case 0:0,_a.label=1;case 1:return _a.trys.push([1,3,,4]),[4,this.upstream.next()];case 2:return[2,_a.sent()];case 3:return e_1=_a.sent(),this.handler(e_1)?[3,4]:[2,{value:null,done:!0}];case 4:return[3,0];case 5:return[2]}})})},ErrorHandlingLazyIterator}(LazyIterator),AsyncMapIterator=function(_super){function AsyncMapIterator(upstream,transform){var _this=_super.call(this)||this;return _this.upstream=upstream,_this.transform=transform,_this}return __extends(AsyncMapIterator,_super),AsyncMapIterator.prototype.summary=function(){return this.upstream.summary()+" -> AsyncMap"},AsyncMapIterator.prototype.next=function(){return __awaiter(this,void 0,void 0,function(){var item,inputTensors,mapped,outputTensors,_i,inputTensors_2,t;return __generator(this,function(_a){switch(_a.label){case 0:return[4,this.upstream.next()];case 1:return(item=_a.sent()).done?[2,{value:null,done:!0}]:(inputTensors=tf.tensor_util.getTensorsInContainer(item.value),[4,this.transform(item.value)]);case 2:for(mapped=_a.sent(),outputTensors=tf.tensor_util.getTensorsInContainer(mapped),_i=0,inputTensors_2=inputTensors;_i<inputTensors_2.length;_i++)t=inputTensors_2[_i],tf.tensor_util.isTensorInList(t,outputTensors)||t.dispose();return[2,{value:mapped,done:!1}]}})})},AsyncMapIterator}(LazyIterator),OneToManyIterator=function(_super){function OneToManyIterator(){var _this=_super.call(this)||this;return _this.outputQueue=new growing_ring_buffer_1.GrowingRingBuffer,_this.lastRead=Promise.resolve({value:null,done:!1}),_this}return __extends(OneToManyIterator,_super),OneToManyIterator.prototype.next=function(){return __awaiter(this,void 0,void 0,function(){var _this=this;return __generator(this,function(_a){return this.lastRead=this.lastRead.then(function(){return _this.serialNext()}),[2,this.lastRead]})})},OneToManyIterator.prototype.serialNext=function(){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(_a){switch(_a.label){case 0:return 0!==this.outputQueue.length()?[3,2]:[4,this.pump()];case 1:return _a.sent()?[3,0]:[2,{value:null,done:!0}];case 2:return[2,{value:this.outputQueue.shift(),done:!1}]}})})},OneToManyIterator}(LazyIterator),FlatmapIterator=function(_super){function FlatmapIterator(upstream,transform){var _this=_super.call(this)||this;return _this.upstream=upstream,_this.transform=transform,_this}return __extends(FlatmapIterator,_super),FlatmapIterator.prototype.summary=function(){return this.upstream.summary()+" -> Flatmap"},FlatmapIterator.prototype.pump=function(){return __awaiter(this,void 0,void 0,function(){var item,inputTensors,mappedArray,outputTensors,_i,inputTensors_3,t;return __generator(this,function(_a){switch(_a.label){case 0:return[4,this.upstream.next()];case 1:if((item=_a.sent()).done)return[2,!1];for(inputTensors=tf.tensor_util.getTensorsInContainer(item.value),mappedArray=this.transform(item.value),outputTensors=tf.tensor_util.getTensorsInContainer(mappedArray),this.outputQueue.pushAll(mappedArray),_i=0,inputTensors_3=inputTensors;_i<inputTensors_3.length;_i++)t=inputTensors_3[_i],tf.tensor_util.isTensorInList(t,outputTensors)||t.dispose();return[2,!0]}})})},FlatmapIterator}(exports.OneToManyIterator=OneToManyIterator),ChainedIterator=function(_super){function ChainedIterator(iterators,baseErrorHandler){var _this=_super.call(this)||this;return _this.baseErrorHandler=baseErrorHandler,_this.lastRead=null,_this.iterator=null,_this.moreIterators=iterators,_this}return __extends(ChainedIterator,_super),ChainedIterator.prototype.summary=function(){return"TODO: fill in upstream of chained summaries -> Chained"},ChainedIterator.prototype.next=function(){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(_a){return this.lastRead=this.readFromChain(this.lastRead),[2,this.lastRead]})})},ChainedIterator.prototype.readFromChain=function(lastRead){return __awaiter(this,void 0,void 0,function(){var iteratorResult,itemResult;return __generator(this,function(_a){switch(_a.label){case 0:return[4,lastRead];case 1:return _a.sent(),null!=this.iterator?[3,3]:[4,this.moreIterators.next()];case 2:if((iteratorResult=_a.sent()).done)return[2,{value:null,done:!0}];this.iterator=iteratorResult.value,null!=this.baseErrorHandler&&(this.iterator=this.iterator.handleErrors(this.baseErrorHandler)),_a.label=3;case 3:return[4,this.iterator.next()];case 4:return(itemResult=_a.sent()).done?(this.iterator=null,[2,this.readFromChain(lastRead)]):[2,itemResult]}})})},ChainedIterator}(LazyIterator);exports.ChainedIterator=ChainedIterator,function(ZipMismatchMode){ZipMismatchMode[ZipMismatchMode.FAIL=0]="FAIL",ZipMismatchMode[ZipMismatchMode.SHORTEST=1]="SHORTEST",ZipMismatchMode[ZipMismatchMode.LONGEST=2]="LONGEST"}(ZipMismatchMode=exports.ZipMismatchMode||(exports.ZipMismatchMode={}));var ZipIterator=function(_super){function ZipIterator(iterators,mismatchMode){void 0===mismatchMode&&(mismatchMode=ZipMismatchMode.FAIL);var _this=_super.call(this)||this;return _this.iterators=iterators,_this.mismatchMode=mismatchMode,_this.count=0,_this.currentPromise=null,_this}return __extends(ZipIterator,_super),ZipIterator.prototype.summary=function(){return"{TODO: fill in upstream of zip summaries} -> Zip"},ZipIterator.prototype.nextState=function(afterState){return __awaiter(this,void 0,void 0,function(){function getNext(container){return container instanceof LazyIterator?{value:container.next().then(function(x){return numIterators++,x.done&&iteratorsDone++,x.value}),recurse:!1}:{value:null,recurse:!0}}var numIterators,iteratorsDone,mapped;return __generator(this,function(_a){switch(_a.label){case 0:return[4,afterState];case 1:return _a.sent(),iteratorsDone=numIterators=0,[4,deep_map_1.deepMapAndAwaitAll(this.iterators,getNext)];case 2:if(mapped=_a.sent(),numIterators===iteratorsDone)return[2,{value:null,done:!0}];if(0<iteratorsDone)switch(this.mismatchMode){case ZipMismatchMode.FAIL:throw new Error("Zipped streams should have the same length. Mismatched at element "+this.count+".");case ZipMismatchMode.SHORTEST:return[2,{value:null,done:!0}];case ZipMismatchMode.LONGEST:}return this.count++,[2,{value:mapped,done:!1}]}})})},ZipIterator.prototype.next=function(){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(_a){switch(_a.label){case 0:return this.currentPromise=this.nextState(this.currentPromise),[4,this.currentPromise];case 1:return[2,_a.sent()]}})})},ZipIterator}(LazyIterator),PrefetchIterator=function(_super){function PrefetchIterator(upstream,bufferSize){var _this=_super.call(this)||this;return _this.upstream=upstream,_this.bufferSize=bufferSize,_this.buffer=new ring_buffer_1.RingBuffer(bufferSize),_this}return __extends(PrefetchIterator,_super),PrefetchIterator.prototype.summary=function(){return this.upstream.summary()+" -> Prefetch"},PrefetchIterator.prototype.refill=function(){for(;!this.buffer.isFull();){var v=this.upstream.next();this.buffer.push(v)}},PrefetchIterator.prototype.next=function(){return this.refill(),this.buffer.shift()},PrefetchIterator}(LazyIterator),ShuffleIterator=function(_super){function ShuffleIterator(upstream,windowSize,seed){var _this=_super.call(this,upstream,windowSize)||this;return _this.upstream=upstream,_this.windowSize=windowSize,_this.upstreamExhausted=!1,_this.random=seedrandom.alea(seed||tf.util.now().toString()),_this.lastRead=Promise.resolve({value:null,done:!1}),_this}return __extends(ShuffleIterator,_super),ShuffleIterator.prototype.next=function(){return __awaiter(this,void 0,void 0,function(){var _this=this;return __generator(this,function(_a){return this.lastRead=this.lastRead.then(function(){return _this.serialNext()}),[2,this.lastRead]})})},ShuffleIterator.prototype.randomInt=function(max){return Math.floor(this.random()*max)},ShuffleIterator.prototype.chooseIndex=function(){return this.randomInt(this.buffer.length())},ShuffleIterator.prototype.serialNext=function(){return __awaiter(this,void 0,void 0,function(){var chosenIndex,result;return __generator(this,function(_a){switch(_a.label){case 0:this.upstreamExhausted||this.refill(),_a.label=1;case 1:return this.buffer.isEmpty()?[3,3]:(chosenIndex=this.chooseIndex(),[4,this.buffer.shuffleExcise(chosenIndex)]);case 2:return(result=_a.sent()).done?(this.upstreamExhausted=!0,[3,1]):(this.refill(),[2,result]);case 3:return[2,{value:null,done:!0}]}})})},ShuffleIterator}(exports.PrefetchIterator=PrefetchIterator);exports.ShuffleIterator=ShuffleIterator},{"../util/deep_clone":267,"../util/deep_map":268,"../util/growing_ring_buffer":269,"../util/ring_buffer":270,"@tensorflow/tfjs-core":148,seedrandom:338}],260:[function(require,module,exports){"use strict";var extendStatics,__extends=this&&this.__extends||(extendStatics=function(d,b){return(extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p])})(d,b)},function(d,b){function __(){this.constructor=d}extendStatics(d,b),d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)}),__awaiter=this&&this.__awaiter||function(thisArg,_arguments,P,generator){return new(P=P||Promise)(function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){result.done?resolve(result.value):new P(function(resolve){resolve(result.value)}).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())})},__generator=this&&this.__generator||function(thisArg,body){var f,y,t,g,_={label:0,sent:function(){if(1&t[0])throw t[1];return t[1]},trys:[],ops:[]};return g={next:verb(0),throw:verb(1),return:verb(2)},"function"==typeof Symbol&&(g[Symbol.iterator]=function(){return this}),g;function verb(n){return function(v){return function(op){if(f)throw new TypeError("Generator is already executing.");for(;_;)try{if(f=1,y&&(t=2&op[0]?y.return:op[0]?y.throw||((t=y.return)&&t.call(y),0):y.next)&&!(t=t.call(y,op[1])).done)return t;switch(y=0,t&&(op=[2&op[0],t.value]),op[0]){case 0:case 1:t=op;break;case 4:return _.label++,{value:op[1],done:!1};case 5:_.label++,y=op[1],op=[0];continue;case 7:op=_.ops.pop(),_.trys.pop();continue;default:if(!(t=0<(t=_.trys).length&&t[t.length-1])&&(6===op[0]||2===op[0])){_=0;continue}if(3===op[0]&&(!t||op[1]>t[0]&&op[1]<t[3])){_.label=op[1];break}if(6===op[0]&&_.label<t[1]){_.label=t[1],t=op;break}if(t&&_.label<t[2]){_.label=t[2],_.ops.push(op);break}t[2]&&_.ops.pop(),_.trys.pop();continue}op=body.call(thisArg,_)}catch(e){op=[6,e],y=0}finally{f=t=0}if(5&op[0])throw op[1];return{value:op[0]?op[1]:void 0,done:!0}}([n,v])}}};Object.defineProperty(exports,"__esModule",{value:!0});var tfjs_core_1=require("@tensorflow/tfjs-core"),MicrophoneIterator=function(_super){function MicrophoneIterator(microphoneConfig){var _this=_super.call(this)||this;_this.microphoneConfig=microphoneConfig,_this.isClosed=!1,_this.fftSize=microphoneConfig.fftSize||1024;var fftSizeLog2=Math.log2(_this.fftSize);if(_this.fftSize<0||fftSizeLog2<4||14<fftSizeLog2||!Number.isInteger(fftSizeLog2))throw new Error("Invalid fftSize: it must be a power of 2 between 2 to 4 and 2 to 14, but got "+_this.fftSize);if(_this.numFrames=microphoneConfig.numFramesPerSpectrogram||43,_this.sampleRateHz=microphoneConfig.sampleRateHz,_this.columnTruncateLength=microphoneConfig.columnTruncateLength||_this.fftSize,_this.audioTrackConstraints=microphoneConfig.audioTrackConstraints,_this.smoothingTimeConstant=microphoneConfig.smoothingTimeConstant||0,_this.includeSpectrogram=!1!==microphoneConfig.includeSpectrogram,_this.includeWaveform=!0===microphoneConfig.includeWaveform,!_this.includeSpectrogram&&!_this.includeWaveform)throw new Error("Both includeSpectrogram and includeWaveform are false. At least one type of data should be returned.");return _this}return __extends(MicrophoneIterator,_super),MicrophoneIterator.prototype.summary=function(){return"microphone"},MicrophoneIterator.create=function(microphoneConfig){return void 0===microphoneConfig&&(microphoneConfig={}),__awaiter(this,void 0,void 0,function(){var microphoneIterator;return __generator(this,function(_a){switch(_a.label){case 0:if(tfjs_core_1.ENV.get("IS_NODE"))throw new Error("microphone API is only supported in browser environment.");return[4,(microphoneIterator=new MicrophoneIterator(microphoneConfig)).start()];case 1:return _a.sent(),[2,microphoneIterator]}})})},MicrophoneIterator.prototype.start=function(){return __awaiter(this,void 0,void 0,function(){var _a,e_1,ctxConstructor,streamSource;return __generator(this,function(_b){switch(_b.label){case 0:return _b.trys.push([0,2,,3]),_a=this,[4,navigator.mediaDevices.getUserMedia({audio:null==this.audioTrackConstraints||this.audioTrackConstraints,video:!1})];case 1:return _a.stream=_b.sent(),[3,3];case 2:throw e_1=_b.sent(),new Error("Error thrown while initializing video stream: "+e_1.message);case 3:if(!this.stream)throw new Error("Could not obtain audio from microphone.");if(ctxConstructor=window.AudioContext||window.webkitAudioContext,this.audioContext=new ctxConstructor,this.sampleRateHz){if(this.audioContext.sampleRate!==this.sampleRateHz)throw new Error("Mismatch in sampling rate: Expected: "+this.sampleRateHz+"; Actual: "+this.audioContext.sampleRate)}else this.sampleRateHz=this.audioContext.sampleRate;return streamSource=this.audioContext.createMediaStreamSource(this.stream),this.analyser=this.audioContext.createAnalyser(),this.analyser.fftSize=2*this.fftSize,this.analyser.smoothingTimeConstant=this.smoothingTimeConstant,streamSource.connect(this.analyser),this.freqData=new Float32Array(this.fftSize),this.timeData=new Float32Array(this.fftSize),[2]}})})},MicrophoneIterator.prototype.next=function(){return __awaiter(this,void 0,void 0,function(){var spectrogramTensor,waveformTensor,audioDataQueue,freqData,timeData;return __generator(this,function(_a){switch(_a.label){case 0:return this.isClosed?[2,{value:null,done:!0}]:[4,this.getAudioData()];case 1:return audioDataQueue=_a.sent(),this.includeSpectrogram&&(freqData=this.flattenQueue(audioDataQueue.freqDataQueue),spectrogramTensor=this.getTensorFromAudioDataArray(freqData,[this.numFrames,this.columnTruncateLength,1])),this.includeWaveform&&(timeData=this.flattenQueue(audioDataQueue.timeDataQueue),waveformTensor=this.getTensorFromAudioDataArray(timeData,[this.numFrames*this.fftSize,1])),[2,{value:{spectrogram:spectrogramTensor,waveform:waveformTensor},done:!1}]}})})},MicrophoneIterator.prototype.capture=function(){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(_a){switch(_a.label){case 0:return[4,this.next()];case 1:return[2,_a.sent().value]}})})},MicrophoneIterator.prototype.getAudioData=function(){return __awaiter(this,void 0,void 0,function(){var freqDataQueue,timeDataQueue,currentFrames,_this=this;return __generator(this,function(_a){return freqDataQueue=[],timeDataQueue=[],currentFrames=0,[2,new Promise(function(resolve){var intervalID=setInterval(function(){_this.includeSpectrogram&&(_this.analyser.getFloatFrequencyData(_this.freqData),_this.freqData[0]===-1/0&&resolve({freqDataQueue:freqDataQueue,timeDataQueue:timeDataQueue}),freqDataQueue.push(_this.freqData.slice(0,_this.columnTruncateLength))),_this.includeWaveform&&(_this.analyser.getFloatTimeDomainData(_this.timeData),timeDataQueue.push(_this.timeData.slice())),++currentFrames===_this.numFrames&&(clearInterval(intervalID),resolve({freqDataQueue:freqDataQueue,timeDataQueue:timeDataQueue}))},_this.fftSize/_this.sampleRateHz*1e3)})]})})},MicrophoneIterator.prototype.stop=function(){this.isClosed=!0,this.analyser.disconnect(),this.audioContext.close(),null!=this.stream&&0<this.stream.getTracks().length&&this.stream.getTracks()[0].stop()},MicrophoneIterator.prototype.toArray=function(){throw new Error("Can not convert infinite audio stream to array.")},MicrophoneIterator.prototype.getSampleRate=function(){return this.sampleRateHz},MicrophoneIterator.prototype.flattenQueue=function(queue){var frameSize=queue[0].length,freqData=new Float32Array(queue.length*frameSize);return queue.forEach(function(data,i){return freqData.set(data,i*frameSize)}),freqData},MicrophoneIterator.prototype.getTensorFromAudioDataArray=function(freqData,shape){var vals=new Float32Array(tfjs_core_1.util.sizeFromShape(shape));return vals.set(freqData,vals.length-freqData.length),tfjs_core_1.tensor(vals,shape)},MicrophoneIterator}(require("./lazy_iterator").LazyIterator);exports.MicrophoneIterator=MicrophoneIterator},{"./lazy_iterator":259,"@tensorflow/tfjs-core":148}],261:[function(require,module,exports){"use strict";var extendStatics,__extends=this&&this.__extends||(extendStatics=function(d,b){return(extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p])})(d,b)},function(d,b){function __(){this.constructor=d}extendStatics(d,b),d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)}),__awaiter=this&&this.__awaiter||function(thisArg,_arguments,P,generator){return new(P=P||Promise)(function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){result.done?resolve(result.value):new P(function(resolve){resolve(result.value)}).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())})},__generator=this&&this.__generator||function(thisArg,body){var f,y,t,g,_={label:0,sent:function(){if(1&t[0])throw t[1];return t[1]},trys:[],ops:[]};return g={next:verb(0),throw:verb(1),return:verb(2)},"function"==typeof Symbol&&(g[Symbol.iterator]=function(){return this}),g;function verb(n){return function(v){return function(op){if(f)throw new TypeError("Generator is already executing.");for(;_;)try{if(f=1,y&&(t=2&op[0]?y.return:op[0]?y.throw||((t=y.return)&&t.call(y),0):y.next)&&!(t=t.call(y,op[1])).done)return t;switch(y=0,t&&(op=[2&op[0],t.value]),op[0]){case 0:case 1:t=op;break;case 4:return _.label++,{value:op[1],done:!1};case 5:_.label++,y=op[1],op=[0];continue;case 7:op=_.ops.pop(),_.trys.pop();continue;default:if(!(t=0<(t=_.trys).length&&t[t.length-1])&&(6===op[0]||2===op[0])){_=0;continue}if(3===op[0]&&(!t||op[1]>t[0]&&op[1]<t[3])){_.label=op[1];break}if(6===op[0]&&_.label<t[1]){_.label=t[1],t=op;break}if(t&&_.label<t[2]){_.label=t[2],_.ops.push(op);break}t[2]&&_.ops.pop(),_.trys.pop();continue}op=body.call(thisArg,_)}catch(e){op=[6,e],y=0}finally{f=t=0}if(5&op[0])throw op[1];return{value:op[0]?op[1]:void 0,done:!0}}([n,v])}}};Object.defineProperty(exports,"__esModule",{value:!0});var lazy_iterator_1=require("./lazy_iterator"),StringIterator=function(_super){function StringIterator(){return null!==_super&&_super.apply(this,arguments)||this}return __extends(StringIterator,_super),StringIterator.prototype.split=function(separator){return new SplitIterator(this,separator)},StringIterator}(lazy_iterator_1.LazyIterator),SplitIterator=function(_super){function SplitIterator(upstream,separator){var _this=_super.call(this)||this;return _this.upstream=upstream,_this.impl=new SplitIteratorImpl(upstream,separator),_this}return __extends(SplitIterator,_super),SplitIterator.prototype.summary=function(){return this.impl.summary()},SplitIterator.prototype.next=function(){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(_a){return[2,this.impl.next()]})})},SplitIterator}(exports.StringIterator=StringIterator),SplitIteratorImpl=function(_super){function SplitIteratorImpl(upstream,separator){var _this=_super.call(this)||this;return _this.upstream=upstream,_this.separator=separator,_this.carryover="",_this}return __extends(SplitIteratorImpl,_super),SplitIteratorImpl.prototype.summary=function(){return this.upstream.summary()+" -> Split('"+this.separator+"')"},SplitIteratorImpl.prototype.pump=function(){return __awaiter(this,void 0,void 0,function(){var chunkResult,lines,_i,_a,line;return __generator(this,function(_b){switch(_b.label){case 0:return[4,this.upstream.next()];case 1:if((chunkResult=_b.sent()).done)return""===this.carryover?[2,!1]:(this.outputQueue.push(this.carryover),[2,!(this.carryover="")]);for((lines=chunkResult.value.split(this.separator))[0]=this.carryover+lines[0],_i=0,_a=lines.slice(0,-1);_i<_a.length;_i++)line=_a[_i],this.outputQueue.push(line);return this.carryover=lines[lines.length-1],[2,!0]}})})},SplitIteratorImpl}(lazy_iterator_1.OneToManyIterator)},{"./lazy_iterator":259}],262:[function(require,module,exports){"use strict";var __awaiter=this&&this.__awaiter||function(thisArg,_arguments,P,generator){return new(P=P||Promise)(function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){result.done?resolve(result.value):new P(function(resolve){resolve(result.value)}).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())})},__generator=this&&this.__generator||function(thisArg,body){var f,y,t,g,_={label:0,sent:function(){if(1&t[0])throw t[1];return t[1]},trys:[],ops:[]};return g={next:verb(0),throw:verb(1),return:verb(2)},"function"==typeof Symbol&&(g[Symbol.iterator]=function(){return this}),g;function verb(n){return function(v){return function(op){if(f)throw new TypeError("Generator is already executing.");for(;_;)try{if(f=1,y&&(t=2&op[0]?y.return:op[0]?y.throw||((t=y.return)&&t.call(y),0):y.next)&&!(t=t.call(y,op[1])).done)return t;switch(y=0,t&&(op=[2&op[0],t.value]),op[0]){case 0:case 1:t=op;break;case 4:return _.label++,{value:op[1],done:!1};case 5:_.label++,y=op[1],op=[0];continue;case 7:op=_.ops.pop(),_.trys.pop();continue;default:if(!(t=0<(t=_.trys).length&&t[t.length-1])&&(6===op[0]||2===op[0])){_=0;continue}if(3===op[0]&&(!t||op[1]>t[0]&&op[1]<t[3])){_.label=op[1];break}if(6===op[0]&&_.label<t[1]){_.label=t[1],t=op;break}if(t&&_.label<t[2]){_.label=t[2],_.ops.push(op);break}t[2]&&_.ops.pop(),_.trys.pop();continue}op=body.call(thisArg,_)}catch(e){op=[6,e],y=0}finally{f=t=0}if(5&op[0])throw op[1];return{value:op[0]?op[1]:void 0,done:!0}}([n,v])}}};Object.defineProperty(exports,"__esModule",{value:!0});var tfjs_core_1=require("@tensorflow/tfjs-core"),file_chunk_iterator_1=require("./file_chunk_iterator");exports.urlChunkIterator=function(url,options){return void 0===options&&(options={}),__awaiter(this,void 0,void 0,function(){var urlString,requestInit,response,uint8Array,_a;return __generator(this,function(_b){switch(_b.label){case 0:return"string"==typeof url?urlString=url:(urlString=url.url,requestInit=getRequestInitFromRequest(url)),[4,tfjs_core_1.util.fetch(urlString,requestInit)];case 1:return(response=_b.sent()).ok?(_a=Uint8Array.bind,[4,response.arrayBuffer()]):[3,3];case 2:return uint8Array=new(_a.apply(Uint8Array,[void 0,_b.sent()])),[2,new file_chunk_iterator_1.FileChunkIterator(uint8Array,options)];case 3:throw new Error(response.statusText)}})})};var getRequestInitFromRequest=function(request){return{method:request.method,headers:request.headers,body:request.body,mode:request.mode,credentials:request.credentials,cache:request.cache,redirect:request.redirect,referrer:request.referrer,integrity:request.integrity}}},{"./file_chunk_iterator":258,"@tensorflow/tfjs-core":148}],263:[function(require,module,exports){"use strict";var extendStatics,__extends=this&&this.__extends||(extendStatics=function(d,b){return(extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p])})(d,b)},function(d,b){function __(){this.constructor=d}extendStatics(d,b),d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)}),__awaiter=this&&this.__awaiter||function(thisArg,_arguments,P,generator){return new(P=P||Promise)(function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){result.done?resolve(result.value):new P(function(resolve){resolve(result.value)}).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())})},__generator=this&&this.__generator||function(thisArg,body){var f,y,t,g,_={label:0,sent:function(){if(1&t[0])throw t[1];return t[1]},trys:[],ops:[]};return g={next:verb(0),throw:verb(1),return:verb(2)},"function"==typeof Symbol&&(g[Symbol.iterator]=function(){return this}),g;function verb(n){return function(v){return function(op){if(f)throw new TypeError("Generator is already executing.");for(;_;)try{if(f=1,y&&(t=2&op[0]?y.return:op[0]?y.throw||((t=y.return)&&t.call(y),0):y.next)&&!(t=t.call(y,op[1])).done)return t;switch(y=0,t&&(op=[2&op[0],t.value]),op[0]){case 0:case 1:t=op;break;case 4:return _.label++,{value:op[1],done:!1};case 5:_.label++,y=op[1],op=[0];continue;case 7:op=_.ops.pop(),_.trys.pop();continue;default:if(!(t=0<(t=_.trys).length&&t[t.length-1])&&(6===op[0]||2===op[0])){_=0;continue}if(3===op[0]&&(!t||op[1]>t[0]&&op[1]<t[3])){_.label=op[1];break}if(6===op[0]&&_.label<t[1]){_.label=t[1],t=op;break}if(t&&_.label<t[2]){_.label=t[2],_.ops.push(op);break}t[2]&&_.ops.pop(),_.trys.pop();continue}op=body.call(thisArg,_)}catch(e){op=[6,e],y=0}finally{f=t=0}if(5&op[0])throw op[1];return{value:op[0]?op[1]:void 0,done:!0}}([n,v])}}};Object.defineProperty(exports,"__esModule",{value:!0});var tfjs_core_1=require("@tensorflow/tfjs-core"),WebcamIterator=function(_super){function WebcamIterator(webcamVideoElement,webcamConfig){var _this=_super.call(this)||this;if(_this.webcamVideoElement=webcamVideoElement,_this.webcamConfig=webcamConfig,_this.isClosed=!0,_this.resize=!1,_this.needToResize())if(_this.resize=!0,_this.cropSize=[_this.webcamConfig.resizeHeight,_this.webcamConfig.resizeWidth],_this.cropBoxInd=tfjs_core_1.tensor1d([0],"int32"),_this.webcamConfig.centerCrop){var widthCroppingRatio=1*_this.webcamConfig.resizeWidth/_this.webcamVideoElement.width,heightCroppingRatio=1*_this.webcamConfig.resizeHeight/_this.webcamVideoElement.height,widthCropStart=(1-widthCroppingRatio)/2,heightCropStart=(1-heightCroppingRatio)/2,widthCropEnd=widthCropStart+widthCroppingRatio,heightCropEnd=heightCroppingRatio+heightCropStart;_this.cropBox=tfjs_core_1.tensor2d([heightCropStart,widthCropStart,heightCropEnd,widthCropEnd],[1,4])}else _this.cropBox=tfjs_core_1.tensor2d([0,0,1,1],[1,4]);return _this}return __extends(WebcamIterator,_super),WebcamIterator.prototype.summary=function(){return"webcam"},WebcamIterator.create=function(webcamVideoElement,webcamConfig){return void 0===webcamConfig&&(webcamConfig={}),__awaiter(this,void 0,void 0,function(){var webcamIterator;return __generator(this,function(_a){switch(_a.label){case 0:if(tfjs_core_1.ENV.get("IS_NODE"))throw new Error("tf.data.webcam is only supported in browser environment.");if(!webcamVideoElement){if(webcamVideoElement=document.createElement("video"),!webcamConfig.resizeWidth||!webcamConfig.resizeHeight)throw new Error("Please provide webcam video element, or resizeWidth and resizeHeight to create a hidden video element.");webcamVideoElement.width=webcamConfig.resizeWidth,webcamVideoElement.height=webcamConfig.resizeHeight}return[4,(webcamIterator=new WebcamIterator(webcamVideoElement,webcamConfig)).start()];case 1:return _a.sent(),[2,webcamIterator]}})})},WebcamIterator.prototype.start=function(){return __awaiter(this,void 0,void 0,function(){var _a,e_1,_this=this;return __generator(this,function(_b){switch(_b.label){case 0:this.webcamConfig.facingMode&&tfjs_core_1.util.assert("user"===this.webcamConfig.facingMode||"environment"===this.webcamConfig.facingMode,function(){return"Invalid webcam facing mode: "+_this.webcamConfig.facingMode+". Please provide 'user' or 'environment'"}),_b.label=1;case 1:return _b.trys.push([1,3,,4]),_a=this,[4,navigator.mediaDevices.getUserMedia({video:{deviceId:this.webcamConfig.deviceId,facingMode:this.webcamConfig.facingMode?this.webcamConfig.facingMode:"user",width:this.webcamVideoElement.width,height:this.webcamVideoElement.height}})];case 2:return _a.stream=_b.sent(),[3,4];case 3:throw(e_1=_b.sent()).message="Error thrown while initializing video stream: "+e_1.message,e_1;case 4:if(!this.stream)throw new Error("Could not obtain video from webcam.");try{this.webcamVideoElement.srcObject=this.stream}catch(error){console.log(error),this.webcamVideoElement.src=window.URL.createObjectURL(this.stream)}return this.webcamVideoElement.play(),this.isClosed=!1,[2,new Promise(function(resolve){_this.webcamVideoElement.onloadedmetadata=function(){resolve()}})]}})})},WebcamIterator.prototype.next=function(){return __awaiter(this,void 0,void 0,function(){var img;return __generator(this,function(_a){if(this.isClosed)return[2,{value:null,done:!0}];try{img=tfjs_core_1.browser.fromPixels(this.webcamVideoElement)}catch(e){throw new Error("Error thrown converting video to pixels: "+JSON.stringify(e))}if(!this.resize)return[2,{value:img,done:!1}];try{return[2,{value:this.cropAndResizeFrame(img),done:!1}]}catch(e){throw new Error("Error thrown cropping the video: "+e.message)}finally{img.dispose()}return[2]})})},WebcamIterator.prototype.needToResize=function(){return!(!this.webcamConfig.resizeWidth||!this.webcamConfig.resizeHeight||this.webcamVideoElement.width===this.webcamConfig.resizeWidth&&this.webcamVideoElement.height===this.webcamConfig.resizeHeight)},WebcamIterator.prototype.cropAndResizeFrame=function(img){var _this=this;return tfjs_core_1.tidy(function(){var resizedImage,expandedImage=img.toFloat().expandDims(0),shape=(resizedImage=tfjs_core_1.image.cropAndResize(expandedImage,_this.cropBox,_this.cropBoxInd,_this.cropSize,"bilinear")).shape;return resizedImage.reshape(shape.slice(1))})},WebcamIterator.prototype.capture=function(){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(_a){switch(_a.label){case 0:return[4,this.next()];case 1:return[2,_a.sent().value]}})})},WebcamIterator.prototype.stop=function(){this.stream.getTracks().forEach(function(track){return track.stop()});try{this.webcamVideoElement.srcObject=null}catch(error){console.log(error),this.webcamVideoElement.src=null}this.isClosed=!0},WebcamIterator.prototype.toArray=function(){throw new Error("Can not convert infinite video stream to array.")},WebcamIterator}(require("./lazy_iterator").LazyIterator);exports.WebcamIterator=WebcamIterator},{"./lazy_iterator":259,"@tensorflow/tfjs-core":148}],264:[function(require,module,exports){"use strict";var __awaiter=this&&this.__awaiter||function(thisArg,_arguments,P,generator){return new(P=P||Promise)(function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){result.done?resolve(result.value):new P(function(resolve){resolve(result.value)}).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())})},__generator=this&&this.__generator||function(thisArg,body){var f,y,t,g,_={label:0,sent:function(){if(1&t[0])throw t[1];return t[1]},trys:[],ops:[]};return g={next:verb(0),throw:verb(1),return:verb(2)},"function"==typeof Symbol&&(g[Symbol.iterator]=function(){return this}),g;function verb(n){return function(v){return function(op){if(f)throw new TypeError("Generator is already executing.");for(;_;)try{if(f=1,y&&(t=2&op[0]?y.return:op[0]?y.throw||((t=y.return)&&t.call(y),0):y.next)&&!(t=t.call(y,op[1])).done)return t;switch(y=0,t&&(op=[2&op[0],t.value]),op[0]){case 0:case 1:t=op;break;case 4:return _.label++,{value:op[1],done:!1};case 5:_.label++,y=op[1],op=[0];continue;case 7:op=_.ops.pop(),_.trys.pop();continue;default:if(!(t=0<(t=_.trys).length&&t[t.length-1])&&(6===op[0]||2===op[0])){_=0;continue}if(3===op[0]&&(!t||op[1]>t[0]&&op[1]<t[3])){_.label=op[1];break}if(6===op[0]&&_.label<t[1]){_.label=t[1],t=op;break}if(t&&_.label<t[2]){_.label=t[2],_.ops.push(op);break}t[2]&&_.ops.pop(),_.trys.pop();continue}op=body.call(thisArg,_)}catch(e){op=[6,e],y=0}finally{f=t=0}if(5&op[0])throw op[1];return{value:op[0]?op[1]:void 0,done:!0}}([n,v])}}};Object.defineProperty(exports,"__esModule",{value:!0});var dataset_1=require("./dataset"),csv_dataset_1=require("./datasets/csv_dataset"),lazy_iterator_1=require("./iterators/lazy_iterator"),microphone_iterator_1=require("./iterators/microphone_iterator"),webcam_iterator_1=require("./iterators/webcam_iterator"),url_data_source_1=require("./sources/url_data_source");exports.csv=function(source,csvConfig){return void 0===csvConfig&&(csvConfig={}),new csv_dataset_1.CSVDataset(new url_data_source_1.URLDataSource(source),csvConfig)},exports.func=function(f){var _this=this,iter=lazy_iterator_1.iteratorFromFunction(f);return dataset_1.datasetFromIteratorFn(function(){return __awaiter(_this,void 0,void 0,function(){return __generator(this,function(_a){return[2,iter]})})})},exports.generator=function(generator){var _this=this;return dataset_1.datasetFromIteratorFn(function(){return __awaiter(_this,void 0,void 0,function(){var gen;return __generator(this,function(_a){switch(_a.label){case 0:return[4,generator()];case 1:return gen=_a.sent(),[2,lazy_iterator_1.iteratorFromFunction(function(){return gen.next()})]}})})})},exports.webcam=function(webcamVideoElement,webcamConfig){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(_a){return[2,webcam_iterator_1.WebcamIterator.create(webcamVideoElement,webcamConfig)]})})},exports.microphone=function(microphoneConfig){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(_a){return[2,microphone_iterator_1.MicrophoneIterator.create(microphoneConfig)]})})}},{"./dataset":252,"./datasets/csv_dataset":253,"./iterators/lazy_iterator":259,"./iterators/microphone_iterator":260,"./iterators/webcam_iterator":263,"./sources/url_data_source":266}],265:[function(require,module,exports){"use strict";var extendStatics,__extends=this&&this.__extends||(extendStatics=function(d,b){return(extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p])})(d,b)},function(d,b){function __(){this.constructor=d}extendStatics(d,b),d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)}),__awaiter=this&&this.__awaiter||function(thisArg,_arguments,P,generator){return new(P=P||Promise)(function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){result.done?resolve(result.value):new P(function(resolve){resolve(result.value)}).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())})},__generator=this&&this.__generator||function(thisArg,body){var f,y,t,g,_={label:0,sent:function(){if(1&t[0])throw t[1];return t[1]},trys:[],ops:[]};return g={next:verb(0),throw:verb(1),return:verb(2)},"function"==typeof Symbol&&(g[Symbol.iterator]=function(){return this}),g;function verb(n){return function(v){return function(op){if(f)throw new TypeError("Generator is already executing.");for(;_;)try{if(f=1,y&&(t=2&op[0]?y.return:op[0]?y.throw||((t=y.return)&&t.call(y),0):y.next)&&!(t=t.call(y,op[1])).done)return t;switch(y=0,t&&(op=[2&op[0],t.value]),op[0]){case 0:case 1:t=op;break;case 4:return _.label++,{value:op[1],done:!1};case 5:_.label++,y=op[1],op=[0];continue;case 7:op=_.ops.pop(),_.trys.pop();continue;default:if(!(t=0<(t=_.trys).length&&t[t.length-1])&&(6===op[0]||2===op[0])){_=0;continue}if(3===op[0]&&(!t||op[1]>t[0]&&op[1]<t[3])){_.label=op[1];break}if(6===op[0]&&_.label<t[1]){_.label=t[1],t=op;break}if(t&&_.label<t[2]){_.label=t[2],_.ops.push(op);break}t[2]&&_.ops.pop(),_.trys.pop();continue}op=body.call(thisArg,_)}catch(e){op=[6,e],y=0}finally{f=t=0}if(5&op[0])throw op[1];return{value:op[0]?op[1]:void 0,done:!0}}([n,v])}}};Object.defineProperty(exports,"__esModule",{value:!0});var tfjs_core_1=require("@tensorflow/tfjs-core"),datasource_1=require("../datasource"),file_chunk_iterator_1=require("../iterators/file_chunk_iterator"),source_util_1=require("../util/source_util"),FileDataSource=function(_super){function FileDataSource(input,options){void 0===options&&(options={});var _this=_super.call(this)||this;return _this.input=input,_this.options=options,_this}return __extends(FileDataSource,_super),FileDataSource.prototype.iterator=function(){return __awaiter(this,void 0,void 0,function(){var fs;return __generator(this,function(_a){return source_util_1.isLocalPath(this.input)&&tfjs_core_1.ENV.get("IS_NODE")&&(fs=require("fs"),this.input=fs.readFileSync(this.input.substr(7))),[2,new file_chunk_iterator_1.FileChunkIterator(this.input,this.options)]})})},FileDataSource}(datasource_1.DataSource);exports.FileDataSource=FileDataSource},{"../datasource":255,"../iterators/file_chunk_iterator":258,"../util/source_util":271,"@tensorflow/tfjs-core":148,fs:333}],266:[function(require,module,exports){"use strict";var extendStatics,__extends=this&&this.__extends||(extendStatics=function(d,b){return(extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p])})(d,b)},function(d,b){function __(){this.constructor=d}extendStatics(d,b),d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)}),__awaiter=this&&this.__awaiter||function(thisArg,_arguments,P,generator){return new(P=P||Promise)(function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){result.done?resolve(result.value):new P(function(resolve){resolve(result.value)}).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())})},__generator=this&&this.__generator||function(thisArg,body){var f,y,t,g,_={label:0,sent:function(){if(1&t[0])throw t[1];return t[1]},trys:[],ops:[]};return g={next:verb(0),throw:verb(1),return:verb(2)},"function"==typeof Symbol&&(g[Symbol.iterator]=function(){return this}),g;function verb(n){return function(v){return function(op){if(f)throw new TypeError("Generator is already executing.");for(;_;)try{if(f=1,y&&(t=2&op[0]?y.return:op[0]?y.throw||((t=y.return)&&t.call(y),0):y.next)&&!(t=t.call(y,op[1])).done)return t;switch(y=0,t&&(op=[2&op[0],t.value]),op[0]){case 0:case 1:t=op;break;case 4:return _.label++,{value:op[1],done:!1};case 5:_.label++,y=op[1],op=[0];continue;case 7:op=_.ops.pop(),_.trys.pop();continue;default:if(!(t=0<(t=_.trys).length&&t[t.length-1])&&(6===op[0]||2===op[0])){_=0;continue}if(3===op[0]&&(!t||op[1]>t[0]&&op[1]<t[3])){_.label=op[1];break}if(6===op[0]&&_.label<t[1]){_.label=t[1],t=op;break}if(t&&_.label<t[2]){_.label=t[2],_.ops.push(op);break}t[2]&&_.ops.pop(),_.trys.pop();continue}op=body.call(thisArg,_)}catch(e){op=[6,e],y=0}finally{f=t=0}if(5&op[0])throw op[1];return{value:op[0]?op[1]:void 0,done:!0}}([n,v])}}};Object.defineProperty(exports,"__esModule",{value:!0});var datasource_1=require("../datasource"),url_chunk_iterator_1=require("../iterators/url_chunk_iterator"),source_util_1=require("../util/source_util"),file_data_source_1=require("./file_data_source"),URLDataSource=function(_super){function URLDataSource(url,fileOptions){void 0===fileOptions&&(fileOptions={});var _this=_super.call(this)||this;return _this.url=url,_this.fileOptions=fileOptions,_this}return __extends(URLDataSource,_super),URLDataSource.prototype.iterator=function(){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(_a){return source_util_1.isLocalPath(this.url)?[2,new file_data_source_1.FileDataSource(this.url,this.fileOptions).iterator()]:[2,url_chunk_iterator_1.urlChunkIterator(this.url,this.fileOptions)]})})},URLDataSource}(datasource_1.DataSource);exports.URLDataSource=URLDataSource},{"../datasource":255,"../iterators/url_chunk_iterator":262,"../util/source_util":271,"./file_data_source":265}],267:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var tf=require("@tensorflow/tfjs-core"),deep_map_1=require("./deep_map");function cloneIfTensor(item){return item instanceof tf.Tensor?{value:item.clone(),recurse:!1}:deep_map_1.isIterable(item)?{value:null,recurse:!0}:{value:item,recurse:!1}}exports.deepClone=function(container){return deep_map_1.deepMap(container,cloneIfTensor)}},{"./deep_map":268,"@tensorflow/tfjs-core":148}],268:[function(require,module,exports){"use strict";var __awaiter=this&&this.__awaiter||function(thisArg,_arguments,P,generator){return new(P=P||Promise)(function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){result.done?resolve(result.value):new P(function(resolve){resolve(result.value)}).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())})},__generator=this&&this.__generator||function(thisArg,body){var f,y,t,g,_={label:0,sent:function(){if(1&t[0])throw t[1];return t[1]},trys:[],ops:[]};return g={next:verb(0),throw:verb(1),return:verb(2)},"function"==typeof Symbol&&(g[Symbol.iterator]=function(){return this}),g;function verb(n){return function(v){return function(op){if(f)throw new TypeError("Generator is already executing.");for(;_;)try{if(f=1,y&&(t=2&op[0]?y.return:op[0]?y.throw||((t=y.return)&&t.call(y),0):y.next)&&!(t=t.call(y,op[1])).done)return t;switch(y=0,t&&(op=[2&op[0],t.value]),op[0]){case 0:case 1:t=op;break;case 4:return _.label++,{value:op[1],done:!1};case 5:_.label++,y=op[1],op=[0];continue;case 7:op=_.ops.pop(),_.trys.pop();continue;default:if(!(t=0<(t=_.trys).length&&t[t.length-1])&&(6===op[0]||2===op[0])){_=0;continue}if(3===op[0]&&(!t||op[1]>t[0]&&op[1]<t[3])){_.label=op[1];break}if(6===op[0]&&_.label<t[1]){_.label=t[1],t=op;break}if(t&&_.label<t[2]){_.label=t[2],_.ops.push(op);break}t[2]&&_.ops.pop(),_.trys.pop();continue}op=body.call(thisArg,_)}catch(e){op=[6,e],y=0}finally{f=t=0}if(5&op[0])throw op[1];return{value:op[0]?op[1]:void 0,done:!0}}([n,v])}}};Object.defineProperty(exports,"__esModule",{value:!0});var tf=require("@tensorflow/tfjs-core");function deepMapInternal(input,mapFn,seen,containedIn){if(void 0===seen&&(seen=new Map),void 0===containedIn&&(containedIn=new Set),null==input)return null;if(containedIn.has(input))throw new Error("Circular references are not supported.");if(seen.has(input))return seen.get(input);var result=mapFn(input);if(result.recurse&&null!==result.value)throw new Error("A deep map function may not return both a value and recurse=true.");if(result.recurse){if(isIterable(input)){var mappedIterable=Array.isArray(input)?[]:{};for(var k in containedIn.add(input),input){var childResult=deepMapInternal(input[k],mapFn,seen,containedIn);mappedIterable[k]=childResult}return containedIn.delete(input),mappedIterable}throw new Error("Can't recurse into non-iterable type: "+input)}return seen.set(input,result.value),result.value}function zipToList(x){return null===x?null:isIterable(x[0])?{value:null,recurse:!0}:{value:x,recurse:!1}}function isIterable(obj){return null!=obj&&(Array.isArray(obj)||"object"==typeof obj&&!(obj instanceof tf.Tensor))}exports.deepMap=function(input,mapFn){return deepMapInternal(input,mapFn)},exports.deepZip=function(inputs,zipFn){return void 0===zipFn&&(zipFn=zipToList),function deepZipInternal(inputs,zipFn,containedIn){void 0===containedIn&&(containedIn=new Set);var input=inputs[0];if(containedIn.has(input))throw new Error("Circular references are not supported.");var result=zipFn(inputs);if(result.recurse&&null!==result.value)throw new Error("A deep zip function may not return both a value and recurse=true.");{if(result.recurse){if(isIterable(input)){var mappedIterable=Array.isArray(input)?[]:{};containedIn.add(input);var _loop_1=function(k){var children=inputs.map(function(x){return x[k]}),childResult=deepZipInternal(children,zipFn,containedIn);mappedIterable[k]=childResult};for(var k in input)_loop_1(k);return containedIn.delete(input),mappedIterable}throw new Error("Can't recurse into non-iterable type: "+input)}return result.value}}(inputs,zipFn)},exports.zipToList=zipToList,exports.deepMapAndAwaitAll=function(input,mapFn){return __awaiter(this,void 0,void 0,function(){var seen,_i,_a,key,value,mappedValue;return __generator(this,function(_b){switch(_b.label){case 0:seen=new Map,deepMapInternal(input,mapFn,seen),_i=0,_a=Array.from(seen.keys()),_b.label=1;case 1:return _i<_a.length?(key=_a[_i],(value=seen.get(key))instanceof Promise?[4,value]:[3,3]):[3,4];case 2:mappedValue=_b.sent(),seen.set(key,mappedValue),_b.label=3;case 3:return _i++,[3,1];case 4:return[2,deepMapInternal(input,mapFn,seen)]}})})},exports.isIterable=isIterable,exports.canTensorify=function(obj){return null==obj||function(value){return null===value||"object"!=typeof value&&"function"!=typeof value}(obj)||Array.isArray(obj)||"object"==typeof obj&&obj instanceof tf.Tensor||tf.util.isTypedArray(obj)}},{"@tensorflow/tfjs-core":148}],269:[function(require,module,exports){"use strict";var extendStatics,__extends=this&&this.__extends||(extendStatics=function(d,b){return(extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p])})(d,b)},function(d,b){function __(){this.constructor=d}extendStatics(d,b),d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)});Object.defineProperty(exports,"__esModule",{value:!0});var GrowingRingBuffer=function(_super){function GrowingRingBuffer(){return _super.call(this,GrowingRingBuffer.INITIAL_CAPACITY)||this}return __extends(GrowingRingBuffer,_super),GrowingRingBuffer.prototype.isFull=function(){return!1},GrowingRingBuffer.prototype.push=function(value){_super.prototype.isFull.call(this)&&this.expand(),_super.prototype.push.call(this,value)},GrowingRingBuffer.prototype.unshift=function(value){_super.prototype.isFull.call(this)&&this.expand(),_super.prototype.unshift.call(this,value)},GrowingRingBuffer.prototype.expand=function(){for(var newCapacity=2*this.capacity,newData=new Array(newCapacity),len=this.length(),i=0;i<len;i++)newData[i]=this.get(this.wrap(this.begin+i));this.data=newData,this.capacity=newCapacity,this.doubledCapacity=2*this.capacity,this.begin=0,this.end=len},GrowingRingBuffer.INITIAL_CAPACITY=32,GrowingRingBuffer}(require("./ring_buffer").RingBuffer);exports.GrowingRingBuffer=GrowingRingBuffer},{"./ring_buffer":270}],270:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var RingBuffer=function(){function RingBuffer(capacity){if(this.capacity=capacity,this.begin=0,this.end=0,null==capacity)throw new RangeError("Can't create a ring buffer of unknown capacity.");if(capacity<1)throw new RangeError("Can't create ring buffer of capacity < 1.");this.data=new Array(capacity),this.doubledCapacity=2*capacity}return RingBuffer.prototype.wrap=function(index){for(;index<0;)index+=this.doubledCapacity;return index%this.doubledCapacity},RingBuffer.prototype.get=function(index){if(index<0)throw new RangeError("Can't get item at a negative index.");return this.data[index%this.capacity]},RingBuffer.prototype.set=function(index,value){if(index<0)throw new RangeError("Can't set item at a negative index.");this.data[index%this.capacity]=value},RingBuffer.prototype.length=function(){var length=this.end-this.begin;return length<0&&(length=this.doubledCapacity+length),length},RingBuffer.prototype.isFull=function(){return this.length()===this.capacity},RingBuffer.prototype.isEmpty=function(){return 0===this.length()},RingBuffer.prototype.push=function(value){if(this.isFull())throw new RangeError("Ring buffer is full.");this.set(this.end,value),this.end=this.wrap(this.end+1)},RingBuffer.prototype.pushAll=function(values){for(var _i=0,values_1=values;_i<values_1.length;_i++){var value=values_1[_i];this.push(value)}},RingBuffer.prototype.pop=function(){if(this.isEmpty())throw new RangeError("Ring buffer is empty.");this.end=this.wrap(this.end-1);var result=this.get(this.end);return this.set(this.end,void 0),result},RingBuffer.prototype.unshift=function(value){if(this.isFull())throw new RangeError("Ring buffer is full.");this.begin=this.wrap(this.begin-1),this.set(this.begin,value)},RingBuffer.prototype.shift=function(){if(this.isEmpty())throw new RangeError("Ring buffer is empty.");var result=this.get(this.begin);return this.set(this.begin,void 0),this.begin=this.wrap(this.begin+1),result},RingBuffer.prototype.shuffleExcise=function(relativeIndex){if(this.isEmpty())throw new RangeError("Ring buffer is empty.");var index=this.wrap(this.begin+relativeIndex),result=this.get(index);return this.set(index,this.pop()),result},RingBuffer}();exports.RingBuffer=RingBuffer},{}],271:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.isLocalPath=function(source){return"string"==typeof source&&"file://"===source.substr(0,7)}},{}],272:[function(require,module,exports){arguments[4][49][0].apply(exports,arguments)},{dup:49}],273:[function(require,module,exports){"use strict";var extendStatics,__extends=this&&this.__extends||(extendStatics=function(d,b){return(extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p])})(d,b)},function(d,b){function __(){this.constructor=d}extendStatics(d,b),d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)});Object.defineProperty(exports,"__esModule",{value:!0});var tfc=require("@tensorflow/tfjs-core"),tfjs_core_1=require("@tensorflow/tfjs-core"),K=require("./backend/tfjs_backend"),generic_utils_1=require("./utils/generic_utils"),Activation=function(_super){function Activation(){return null!==_super&&_super.apply(this,arguments)||this}return __extends(Activation,_super),Activation.prototype.getConfig=function(){return{}},Activation}(tfjs_core_1.serialization.Serializable),Elu=function(_super){function Elu(){return null!==_super&&_super.apply(this,arguments)||this}return __extends(Elu,_super),Elu.prototype.apply=function(x,alpha){return void 0===alpha&&(alpha=1),K.elu(x,alpha)},Elu.className="elu",Elu}(exports.Activation=Activation);exports.Elu=Elu,tfjs_core_1.serialization.registerClass(Elu);var Selu=function(_super){function Selu(){return null!==_super&&_super.apply(this,arguments)||this}return __extends(Selu,_super),Selu.prototype.apply=function(x){return tfc.selu(x)},Selu.className="selu",Selu}(Activation);exports.Selu=Selu,tfjs_core_1.serialization.registerClass(Selu);var Relu=function(_super){function Relu(){return null!==_super&&_super.apply(this,arguments)||this}return __extends(Relu,_super),Relu.prototype.apply=function(x){return tfc.relu(x)},Relu.className="relu",Relu}(Activation);exports.Relu=Relu,tfjs_core_1.serialization.registerClass(Relu);var Relu6=function(_super){function Relu6(){return null!==_super&&_super.apply(this,arguments)||this}return __extends(Relu6,_super),Relu6.prototype.apply=function(x){return tfjs_core_1.tidy(function(){return tfc.minimum(6,tfc.relu(x))})},Relu6.className="relu6",Relu6}(Activation);exports.Relu6=Relu6,tfjs_core_1.serialization.registerClass(Relu6);var Linear=function(_super){function Linear(){return null!==_super&&_super.apply(this,arguments)||this}return __extends(Linear,_super),Linear.prototype.apply=function(x){return x},Linear.className="linear",Linear}(Activation);exports.Linear=Linear,tfjs_core_1.serialization.registerClass(Linear);var Sigmoid=function(_super){function Sigmoid(){return null!==_super&&_super.apply(this,arguments)||this}return __extends(Sigmoid,_super),Sigmoid.prototype.apply=function(x){return tfc.sigmoid(x)},Sigmoid.className="sigmoid",Sigmoid}(Activation);exports.Sigmoid=Sigmoid,tfjs_core_1.serialization.registerClass(Sigmoid);var HardSigmoid=function(_super){function HardSigmoid(){return null!==_super&&_super.apply(this,arguments)||this}return __extends(HardSigmoid,_super),HardSigmoid.prototype.apply=function(x){return K.hardSigmoid(x)},HardSigmoid.className="hardSigmoid",HardSigmoid}(Activation);exports.HardSigmoid=HardSigmoid,tfjs_core_1.serialization.registerClass(HardSigmoid);var Softplus=function(_super){function Softplus(){return null!==_super&&_super.apply(this,arguments)||this}return __extends(Softplus,_super),Softplus.prototype.apply=function(x){return tfc.softplus(x)},Softplus.className="softplus",Softplus}(Activation);exports.Softplus=Softplus,tfjs_core_1.serialization.registerClass(Softplus);var Softsign=function(_super){function Softsign(){return null!==_super&&_super.apply(this,arguments)||this}return __extends(Softsign,_super),Softsign.prototype.apply=function(x){return K.softsign(x)},Softsign.className="softsign",Softsign}(Activation);exports.Softsign=Softsign,tfjs_core_1.serialization.registerClass(Softsign);var Tanh=function(_super){function Tanh(){return null!==_super&&_super.apply(this,arguments)||this}return __extends(Tanh,_super),Tanh.prototype.apply=function(x){return tfc.tanh(x)},Tanh.className="tanh",Tanh}(Activation);exports.Tanh=Tanh,tfjs_core_1.serialization.registerClass(Tanh);var Softmax=function(_super){function Softmax(){return null!==_super&&_super.apply(this,arguments)||this}return __extends(Softmax,_super),Softmax.prototype.apply=function(x,axis){return void 0===axis&&(axis=-1),tfc.softmax(x,axis)},Softmax.className="softmax",Softmax}(Activation);exports.Softmax=Softmax,tfjs_core_1.serialization.registerClass(Softmax);var LogSoftmax=function(_super){function LogSoftmax(){return null!==_super&&_super.apply(this,arguments)||this}return __extends(LogSoftmax,_super),LogSoftmax.prototype.apply=function(x,axis){return void 0===axis&&(axis=-1),tfc.logSoftmax(x,axis)},LogSoftmax.className="logSoftmax",LogSoftmax}(Activation);function deserializeActivation(config,customObjects){return void 0===customObjects&&(customObjects={}),generic_utils_1.deserializeKerasObject(config,tfjs_core_1.serialization.SerializationMap.getMap().classNameMap,customObjects,"activation")}exports.LogSoftmax=LogSoftmax,tfjs_core_1.serialization.registerClass(LogSoftmax),exports.serializeActivation=function(activation){return activation.getClassName()},exports.deserializeActivation=deserializeActivation,exports.getActivation=function(identifier){return null!=identifier?"string"!=typeof identifier?identifier instanceof Activation?identifier:deserializeActivation(identifier):((config={}).className=identifier,config.config={},deserializeActivation(config)):deserializeActivation(config={className:"linear",config:{}});var config}},{"./backend/tfjs_backend":276,"./utils/generic_utils":322,"@tensorflow/tfjs-core":148}],274:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var _epsilon,tfjs_core_1=require("@tensorflow/tfjs-core");exports.epsilon=function(){return null==_epsilon&&(_epsilon=tfjs_core_1.backend().epsilon()),_epsilon},exports.setEpsilon=function(e){_epsilon=e},exports.imageDataFormat=function(){return"channelsLast"}},{"@tensorflow/tfjs-core":148}],275:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var _nextUniqueTensorId=0;exports.getNextUniqueTensorId=function(){return _nextUniqueTensorId++};var _uidPrefixes={};exports.getUid=function(prefix){return void 0===prefix&&(prefix=""),prefix in _uidPrefixes||(_uidPrefixes[prefix]=0),_uidPrefixes[prefix]+=1,prefix+_uidPrefixes[prefix].toString()}},{}],276:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var tfc=require("@tensorflow/tfjs-core"),tfjs_core_1=require("@tensorflow/tfjs-core"),common_1=require("../common"),errors_1=require("../errors"),math_utils=require("../utils/math_utils"),common_2=require("./common"),backend="webgl";function expandDims(x,axis){void 0===axis&&(axis=-1);var outShape=x.shape.slice();return axis<0&&(axis=outShape.length+axis+1),outShape.splice(axis,0,1),x.reshape(outShape)}function sliceAlongFirstAxis(array,start,size){return tfjs_core_1.tidy(function(){switch(array.rank){case 1:return tfc.slice1d(array,start,size);case 2:return tfc.slice2d(array,[start,0],[size,array.shape[1]]);case 3:return tfc.slice3d(array,[start,0,0],[size,array.shape[1],array.shape[2]]);case 4:return tfc.slice4d(array,[start,0,0,0],[size,array.shape[1],array.shape[2],array.shape[3]]);default:throw new errors_1.ValueError("sliceAlongFirstAxis() received an unsupported tensor rank: "+array.rank)}})}function sliceAlongLastAxis(array,start,size){return tfjs_core_1.tidy(function(){switch(array.rank){case 1:return tfc.slice1d(array,start,size);case 2:return tfc.slice2d(array,[0,start],[array.shape[0],size]);case 3:return tfc.slice3d(array,[0,0,start],[array.shape[0],array.shape[1],size]);case 4:return tfc.slice4d(array,[0,0,0,start],[array.shape[0],array.shape[1],array.shape[2],size]);default:throw new errors_1.ValueError("sliceAlongLastAxis() received an unsupported tensor rank: "+array.rank)}})}function tile(x,n){if(Array.isArray(n)||(n=[n]),x.rank!==n.length)throw new errors_1.ValueError("The length of input n ("+n.length+") does not match the number of dimensions in input x ("+x.rank+")");return tfc.tile(x,n)}function reshapeBias(xRank,bias,dataFormat){var biasShape=bias.shape;if(1!==bias.rank&&bias.rank!==xRank)throw new errors_1.ValueError("Unexpected bias dimensions: "+bias.rank+"; expected it to be 1 or "+xRank);if(5===xRank){if("channelsFirst"===dataFormat)return 1===biasShape.length?bias.reshape([1,biasShape[0],1,1,1]):bias.reshape([1,biasShape[3],biasShape[0],biasShape[1],biasShape[2]]);if("channelsLast"===dataFormat)return 1===biasShape.length?bias.reshape([1,1,1,1,biasShape[0]]):bias.reshape([1].concat(biasShape))}else if(4===xRank){if("channelsFirst"===dataFormat)return 1===biasShape.length?bias.reshape([1,biasShape[0],1,1]):bias.reshape([1,biasShape[2],biasShape[0],biasShape[1]]);if("channelsLast"===dataFormat)return 1===biasShape.length?bias.reshape([1,1,1,biasShape[0]]):bias.reshape([1].concat(biasShape))}else if(3===xRank){if("channelsFirst"===dataFormat)return 1===biasShape.length?bias.reshape([1,biasShape[0],1]):bias.reshape([1,biasShape[1],biasShape[0]]);if("channelsLast"===dataFormat)return 1===biasShape.length?bias.reshape([1,1,biasShape[0]]):bias.reshape([1].concat(biasShape))}else if(xRank<3)return bias;throw new errors_1.ValueError("Unsupported input rank by biasAdd: "+bias.rank)}exports.setBackend=function(requestedBackend){tfc.setBackend(requestedBackend),backend=requestedBackend},exports.getBackend=function(){return backend},exports.isBackendSymbolic=function(){return!1},exports.countParams=function(x){var shape=x.shape;return 0<shape.length?shape.reduce(function(a,b){return a*b}):1},exports.cast=function(x,dtype){return x.asType(dtype)},exports.expandDims=expandDims,exports.repeat=function(x,n){return tfjs_core_1.tidy(function(){if(2!==x.shape.length)throw new errors_1.ValueError("repeat() expects a rank-2 tensor, but received a rank-"+x.shape.length+" tensor.");return tile(expandDims(x,1),[1,n,1])})},exports.flatten=function(x){var newShape=[math_utils.arrayProd(x.shape)];return x.reshape(newShape)},exports.batchFlatten=function(x){if(x.rank<=1)throw new errors_1.ValueError("batchFlatten requires a minimum rank of 2. Got rank: "+x.rank+".");var newShape=[x.shape[0],math_utils.arrayProd(x.shape,1)];return x.reshape(newShape)},exports.sliceAlongFirstAxis=sliceAlongFirstAxis,exports.sliceAlongLastAxis=sliceAlongLastAxis,exports.sliceAlongAxis=function(array,start,size,axis){return tfjs_core_1.tidy(function(){switch(array.rank){case 1:return tfc.slice1d(array,start,size);case 2:switch(axis){case 1:return sliceAlongFirstAxis(array,start,size);case 2:return sliceAlongLastAxis(array,start,size);default:throw new errors_1.ValueError("The axis is not within the rank of the tensor "+axis)}case 3:switch(axis){case 1:return sliceAlongFirstAxis(array,start,size);case 2:return tfc.slice3d(array,[0,start,0],[array.shape[0],size,array.shape[2]]);case 3:return sliceAlongLastAxis(array,start,size);default:throw new errors_1.ValueError("The axis is not within the rank of the tensor "+axis)}case 4:switch(axis){case 1:return sliceAlongFirstAxis(array,start,size);case 2:return tfc.slice4d(array,[0,start,0,0],[array.shape[0],size,array.shape[2],array.shape[3]]);case 3:return tfc.slice4d(array,[0,0,start,0],[array.shape[0],array.shape[1],size,array.shape[3]]);case 4:return sliceAlongLastAxis(array,start,size);default:throw new errors_1.ValueError("The axis is not within the rank of the tensor "+axis)}default:throw new errors_1.ValueError("sliceAlongLastAxis() received an unsupported tensor rank: "+array.rank)}})},exports.concatenate=function(tensors,axis){var rank;return void 0===axis&&(axis=-1),axis<0&&(axis=0!==(rank=tensors[0].rank)?rank:0),axis===tensors[0].rank&&(axis=-1),tfc.concat(tensors,axis)},exports.concatAlongFirstAxis=function(a,b){switch(a.rank){case 1:return tfc.concat1d([a,b]);case 2:return tfc.concat2d([a,b],0);case 3:return tfc.concat3d([a,b],0);case 4:return tfc.concat4d([a,b],0);default:throw new errors_1.ValueError("concatAlongFirstAxis() received an unsupported tensor rank: "+a.rank)}},exports.tile=tile,exports.randomNormal=function(shape,mean,stddev,dtype,seed){return void 0===mean&&(mean=0),void 0===stddev&&(stddev=1),tfc.randomNormal(shape,mean,stddev,dtype,seed)},exports.dot=function(a,b,activation,bias){if(a.rank<2||b.rank<2)throw new errors_1.NotImplementedError("dot requires both inputs to be rank >= 2 but got x shape = "+a.shape+" and y shape = "+b.shape);if(3<=b.rank&&a.shape.slice(-1)[0]!==(ySecondLastDim=b.shape.slice(-2)[0]))throw new errors_1.NotImplementedError("If rank y >= 3, then the second last dim of y must equal the last dim of x but got x shape = "+a.shape+" and  y shape = "+b.shape);if(2===a.rank&&2===b.rank){var transposeA=!1,transposeB=!1;return tfc.fused.matMul({a:a,b:b,transposeA:transposeA,transposeB:transposeB,bias:bias?reshapeBias(a.rank,bias,common_2.imageDataFormat()):null,activation:activation})}var aFirstDims=a.shape.slice(),aLastDim=aFirstDims.pop();a=a.reshape([-1,aLastDim]);var bShape=b.shape.slice(),bLastDim=bShape.pop(),ySecondLastDim=bShape.pop(),yOtherDims=bShape.concat([bLastDim]),perm=Array.from({length:b.rank},function(_,i){return 0===i?b.rank-2:i<=b.rank-2?i-1:i});b=b.transpose(perm).reshape([ySecondLastDim,-1]);var outputShape=aFirstDims.concat(yOtherDims);return transposeB=transposeA=!1,tfc.fused.matMul({a:a,b:b,transposeA:transposeA,transposeB:transposeB,bias:bias?reshapeBias(a.rank,bias,common_2.imageDataFormat()):null,activation:activation}).reshape(outputShape)},exports.sign=function(x){return tfjs_core_1.tidy(function(){var zerosLikeX=tfjs_core_1.zerosLike(x),onesLikeX=tfjs_core_1.onesLike(x);return tfjs_core_1.where(tfc.equal(x,zerosLikeX),zerosLikeX,tfjs_core_1.where(tfc.greater(x,tfjs_core_1.zerosLike(x)),onesLikeX,tfc.mul(-1,onesLikeX)))})},exports.oneHot=function(indices,numClasses){return tfjs_core_1.tidy(function(){if(1!==indices.rank)throw new Error("Only 1D one-hot tensors are supported in the deeplearn backend, at present.");return indices=indices.toInt(),tfc.oneHot(indices,numClasses).toFloat()})},exports.gather=function(reference,indices,axis){return tfjs_core_1.tidy(function(){return indices=Array.isArray(indices)?tfjs_core_1.tensor1d(indices,"int32"):indices.toInt(),tfc.gather(reference,indices,axis)})},exports.square=function(x){return tfc.mulStrict(x,x)},exports.pow=function(x,a){return tfjs_core_1.tidy(function(){if("number"==typeof a&&(a=tfjs_core_1.scalar(Math.round(a),"int32")),"int32"!==a.dtype)throw new errors_1.NotImplementedError("Non-int32 dtype ("+a.dtype+") is not supported by pow() yet");return tfc.pow(x,a)})},exports.biasAdd=function(x,bias,dataFormat){return tfjs_core_1.tidy(function(){return null==dataFormat&&(dataFormat=common_2.imageDataFormat()),common_1.checkDataFormat(dataFormat),x.add(reshapeBias(x.rank,bias,dataFormat))})},exports.elu=function(x,alpha){if(void 0===alpha&&(alpha=1),1!==alpha)throw new errors_1.NotImplementedError("Support for alpha values other than 1 ("+alpha+") is not implemented yet.");return tfc.elu(x)},exports.softsign=function(x){return tfjs_core_1.tidy(function(){return tfc.div(x,tfc.abs(x).add(1))})},exports.dropout=function(x,level,noiseShape,seed){return tfjs_core_1.tidy(function(){return tfc.dropout(x,level,noiseShape,seed)})},exports.hardSigmoid=function(x){return tfjs_core_1.tidy(function(){var y=tfc.add(.5,tfc.mul(.2,x));return tfc.clipByValue(y,0,1)})},exports.inTrainPhase=function(x,alt,training){return void 0===training&&(training=!1),training?x():alt()}},{"../common":279,"../errors":289,"../utils/math_utils":324,"./common":274,"@tensorflow/tfjs-core":148}],277:[function(require,module,exports){"use strict";var extendStatics,__extends=this&&this.__extends||(extendStatics=function(d,b){return(extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p])})(d,b)},function(d,b){function __(){this.constructor=d}extendStatics(d,b),d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)}),__awaiter=this&&this.__awaiter||function(thisArg,_arguments,P,generator){return new(P=P||Promise)(function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){result.done?resolve(result.value):new P(function(resolve){resolve(result.value)}).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())})},__generator=this&&this.__generator||function(thisArg,body){var f,y,t,g,_={label:0,sent:function(){if(1&t[0])throw t[1];return t[1]},trys:[],ops:[]};return g={next:verb(0),throw:verb(1),return:verb(2)},"function"==typeof Symbol&&(g[Symbol.iterator]=function(){return this}),g;function verb(n){return function(v){return function(op){if(f)throw new TypeError("Generator is already executing.");for(;_;)try{if(f=1,y&&(t=2&op[0]?y.return:op[0]?y.throw||((t=y.return)&&t.call(y),0):y.next)&&!(t=t.call(y,op[1])).done)return t;switch(y=0,t&&(op=[2&op[0],t.value]),op[0]){case 0:case 1:t=op;break;case 4:return _.label++,{value:op[1],done:!1};case 5:_.label++,y=op[1],op=[0];continue;case 7:op=_.ops.pop(),_.trys.pop();continue;default:if(!(t=0<(t=_.trys).length&&t[t.length-1])&&(6===op[0]||2===op[0])){_=0;continue}if(3===op[0]&&(!t||op[1]>t[0]&&op[1]<t[3])){_.label=op[1];break}if(6===op[0]&&_.label<t[1]){_.label=t[1],t=op;break}if(t&&_.label<t[2]){_.label=t[2],_.ops.push(op);break}t[2]&&_.ops.pop(),_.trys.pop();continue}op=body.call(thisArg,_)}catch(e){op=[6,e],y=0}finally{f=t=0}if(5&op[0])throw op[1];return{value:op[0]?op[1]:void 0,done:!0}}([n,v])}}};Object.defineProperty(exports,"__esModule",{value:!0});var tfjs_core_1=require("@tensorflow/tfjs-core"),errors_1=require("./errors"),logs_1=require("./logs"),generic_utils=require("./utils/generic_utils");!function(ModelLoggingVerbosity){ModelLoggingVerbosity[ModelLoggingVerbosity.SILENT=0]="SILENT",ModelLoggingVerbosity[ModelLoggingVerbosity.VERBOSE=1]="VERBOSE"}(exports.ModelLoggingVerbosity||(exports.ModelLoggingVerbosity={})),exports.DEFAULT_YIELD_EVERY_MS=125;var BaseCallback=function(){function BaseCallback(){this.validationData=null}return BaseCallback.prototype.setParams=function(params){this.params=params},BaseCallback.prototype.onEpochBegin=function(epoch,logs){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(_a){return[2]})})},BaseCallback.prototype.onEpochEnd=function(epoch,logs){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(_a){return[2]})})},BaseCallback.prototype.onBatchBegin=function(batch,logs){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(_a){return[2]})})},BaseCallback.prototype.onBatchEnd=function(batch,logs){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(_a){return[2]})})},BaseCallback.prototype.onTrainBegin=function(logs){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(_a){return[2]})})},BaseCallback.prototype.onTrainEnd=function(logs){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(_a){return[2]})})},BaseCallback.prototype.setModel=function(model){},BaseCallback}();exports.BaseCallback=BaseCallback;var CallbackList=function(){function CallbackList(callbacks,queueLength){void 0===queueLength&&(queueLength=10),null==callbacks&&(callbacks=[]),this.callbacks=callbacks,this.queueLength=queueLength}return CallbackList.prototype.append=function(callback){this.callbacks.push(callback)},CallbackList.prototype.setParams=function(params){for(var _i=0,_a=this.callbacks;_i<_a.length;_i++){_a[_i].setParams(params)}},CallbackList.prototype.setModel=function(model){for(var _i=0,_a=this.callbacks;_i<_a.length;_i++){_a[_i].setModel(model)}},CallbackList.prototype.onEpochBegin=function(epoch,logs){return __awaiter(this,void 0,void 0,function(){var _i,_a;return __generator(this,function(_b){switch(_b.label){case 0:null==logs&&(logs={}),_i=0,_a=this.callbacks,_b.label=1;case 1:return _i<_a.length?[4,_a[_i].onEpochBegin(epoch,logs)]:[3,4];case 2:_b.sent(),_b.label=3;case 3:return _i++,[3,1];case 4:return[2]}})})},CallbackList.prototype.onEpochEnd=function(epoch,logs){return __awaiter(this,void 0,void 0,function(){var _i,_a;return __generator(this,function(_b){switch(_b.label){case 0:null==logs&&(logs={}),_i=0,_a=this.callbacks,_b.label=1;case 1:return _i<_a.length?[4,_a[_i].onEpochEnd(epoch,logs)]:[3,4];case 2:_b.sent(),_b.label=3;case 3:return _i++,[3,1];case 4:return[2]}})})},CallbackList.prototype.onBatchBegin=function(batch,logs){return __awaiter(this,void 0,void 0,function(){var _i,_a;return __generator(this,function(_b){switch(_b.label){case 0:null==logs&&(logs={}),_i=0,_a=this.callbacks,_b.label=1;case 1:return _i<_a.length?[4,_a[_i].onBatchBegin(batch,logs)]:[3,4];case 2:_b.sent(),_b.label=3;case 3:return _i++,[3,1];case 4:return[2]}})})},CallbackList.prototype.onBatchEnd=function(batch,logs){return __awaiter(this,void 0,void 0,function(){var _i,_a;return __generator(this,function(_b){switch(_b.label){case 0:null==logs&&(logs={}),_i=0,_a=this.callbacks,_b.label=1;case 1:return _i<_a.length?[4,_a[_i].onBatchEnd(batch,logs)]:[3,4];case 2:_b.sent(),_b.label=3;case 3:return _i++,[3,1];case 4:return[2]}})})},CallbackList.prototype.onTrainBegin=function(logs){return __awaiter(this,void 0,void 0,function(){var _i,_a;return __generator(this,function(_b){switch(_b.label){case 0:null==logs&&(logs={}),_i=0,_a=this.callbacks,_b.label=1;case 1:return _i<_a.length?[4,_a[_i].onTrainBegin(logs)]:[3,4];case 2:_b.sent(),_b.label=3;case 3:return _i++,[3,1];case 4:return[2]}})})},CallbackList.prototype.onTrainEnd=function(logs){return __awaiter(this,void 0,void 0,function(){var _i,_a;return __generator(this,function(_b){switch(_b.label){case 0:null==logs&&(logs={}),_i=0,_a=this.callbacks,_b.label=1;case 1:return _i<_a.length?[4,_a[_i].onTrainEnd(logs)]:[3,4];case 2:_b.sent(),_b.label=3;case 3:return _i++,[3,1];case 4:return[2]}})})},CallbackList}();exports.CallbackList=CallbackList;var BaseLogger=function(_super){function BaseLogger(){return _super.call(this)||this}return __extends(BaseLogger,_super),BaseLogger.prototype.onEpochBegin=function(epoch){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(_a){return this.seen=0,this.totals={},[2]})})},BaseLogger.prototype.onBatchEnd=function(batch,logs){return __awaiter(this,void 0,void 0,function(){var batchSize,_loop_1,this_1,key,_this=this;return __generator(this,function(_a){for(key in null==logs&&(logs={}),batchSize=null==logs.size?0:logs.size,this.seen+=batchSize,_loop_1=function(key){var value=logs[key];if("number"==typeof value)this_1.totals.hasOwnProperty(key)||(this_1.totals[key]=0),this_1.totals[key]=this_1.totals[key]+value*batchSize;else{var oldTotalsToDispose=void 0;key in this_1.totals?oldTotalsToDispose=this_1.totals[key]:this_1.totals[key]=0,this_1.totals[key]=tfjs_core_1.tidy(function(){return tfjs_core_1.add(_this.totals[key],tfjs_core_1.mul(value,batchSize))}),null!=oldTotalsToDispose&&oldTotalsToDispose.dispose()}},this_1=this,logs)_loop_1(key);return[2]})})},BaseLogger.prototype.onEpochEnd=function(epoch,logs){return __awaiter(this,void 0,void 0,function(){var _loop_2,this_2,_i,_a,key,_this=this;return __generator(this,function(_b){if(null!=logs)for(_loop_2=function(key){if(null==this_2.totals[key])return"continue";"number"==typeof this_2.totals[key]?logs[key]=this_2.totals[key]/this_2.seen:tfjs_core_1.tidy(function(){logs[key]=tfjs_core_1.mul(tfjs_core_1.div(1,_this.seen),_this.totals[key]),_this.totals[key].dispose(),tfjs_core_1.keep(logs[key])})},_i=0,_a=(this_2=this).params.metrics;_i<_a.length;_i++)key=_a[_i],_loop_2(key);return[2]})})},BaseLogger}(BaseCallback);exports.BaseLogger=BaseLogger;var History=function(_super){function History(){return null!==_super&&_super.apply(this,arguments)||this}return __extends(History,_super),History.prototype.onTrainBegin=function(logs){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(_a){return this.epoch=[],this.history={},[2]})})},History.prototype.onEpochEnd=function(epoch,logs){return __awaiter(this,void 0,void 0,function(){var key;return __generator(this,function(_a){for(key in null==logs&&(logs={}),this.epoch.push(epoch),logs)null==this.history[key]&&(this.history[key]=[]),this.history[key].push(logs[key]);return[2]})})},History.prototype.syncData=function(){return __awaiter(this,void 0,void 0,function(){var promises,keys,indices,key,valueArray,i,valueScalar,values,n;return __generator(this,function(_a){switch(_a.label){case 0:for(key in promises=[],keys=[],indices=[],this.history)for(valueArray=this.history[key],i=0;i<valueArray.length;++i)"number"!=typeof valueArray[i]&&(valueScalar=valueArray[i],promises.push(valueScalar.data()),keys.push(key),indices.push(i));return[4,Promise.all(promises)];case 1:for(values=_a.sent(),n=0;n<values.length;++n)this.history[keys[n]][indices[n]].dispose(),this.history[keys[n]][indices[n]]=values[n][0];return[2]}})})},History}(BaseCallback);exports.History=History;var CustomCallback=function(_super){function CustomCallback(args,yieldEvery){var _this=_super.call(this)||this;if(_this.currentEpoch=0,_this.yieldEvery=yieldEvery||"auto","auto"===_this.yieldEvery&&(_this.yieldEvery=exports.DEFAULT_YIELD_EVERY_MS),"never"===_this.yieldEvery&&null!=args.onYield)throw new Error("yieldEvery is `never` but you provided an `onYield` callback. Either change `yieldEvery` or remove the callback");return tfjs_core_1.util.isNumber(_this.yieldEvery)&&(_this.maybeWait=generic_utils.debounce(_this.maybeWait.bind(_this),_this.yieldEvery)),_this.trainBegin=args.onTrainBegin,_this.trainEnd=args.onTrainEnd,_this.epochBegin=args.onEpochBegin,_this.epochEnd=args.onEpochEnd,_this.batchBegin=args.onBatchBegin,_this.batchEnd=args.onBatchEnd,_this.yield=args.onYield,_this}return __extends(CustomCallback,_super),CustomCallback.prototype.maybeWait=function(epoch,batch,logs){return __awaiter(this,void 0,void 0,function(){var ps;return __generator(this,function(_a){switch(_a.label){case 0:return ps=[],null==this.yield?[3,2]:[4,logs_1.resolveScalarsInLogs(logs)];case 1:_a.sent(),ps.push(this.yield(epoch,batch,logs)),_a.label=2;case 2:return ps.push(tfjs_core_1.nextFrame()),[4,Promise.all(ps)];case 3:return _a.sent(),[2]}})})},CustomCallback.prototype.onEpochBegin=function(epoch,logs){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(_a){switch(_a.label){case 0:return this.currentEpoch=epoch,null==this.epochBegin?[3,3]:[4,logs_1.resolveScalarsInLogs(logs)];case 1:return _a.sent(),[4,this.epochBegin(epoch,logs)];case 2:_a.sent(),_a.label=3;case 3:return[2]}})})},CustomCallback.prototype.onEpochEnd=function(epoch,logs){return __awaiter(this,void 0,void 0,function(){var ps;return __generator(this,function(_a){switch(_a.label){case 0:return ps=[],null==this.epochEnd?[3,2]:[4,logs_1.resolveScalarsInLogs(logs)];case 1:_a.sent(),ps.push(this.epochEnd(epoch,logs)),_a.label=2;case 2:return"epoch"===this.yieldEvery&&ps.push(tfjs_core_1.nextFrame()),[4,Promise.all(ps)];case 3:return _a.sent(),[2]}})})},CustomCallback.prototype.onBatchBegin=function(batch,logs){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(_a){switch(_a.label){case 0:return null==this.batchBegin?[3,3]:[4,logs_1.resolveScalarsInLogs(logs)];case 1:return _a.sent(),[4,this.batchBegin(batch,logs)];case 2:_a.sent(),_a.label=3;case 3:return[2]}})})},CustomCallback.prototype.onBatchEnd=function(batch,logs){return __awaiter(this,void 0,void 0,function(){var ps;return __generator(this,function(_a){switch(_a.label){case 0:return ps=[],null==this.batchEnd?[3,2]:[4,logs_1.resolveScalarsInLogs(logs)];case 1:_a.sent(),ps.push(this.batchEnd(batch,logs)),_a.label=2;case 2:return"batch"===this.yieldEvery?ps.push(tfjs_core_1.nextFrame()):tfjs_core_1.util.isNumber(this.yieldEvery)&&ps.push(this.maybeWait(this.currentEpoch,batch,logs)),[4,Promise.all(ps)];case 3:return _a.sent(),[2]}})})},CustomCallback.prototype.onTrainBegin=function(logs){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(_a){switch(_a.label){case 0:return null==this.trainBegin?[3,3]:[4,logs_1.resolveScalarsInLogs(logs)];case 1:return _a.sent(),[4,this.trainBegin(logs)];case 2:_a.sent(),_a.label=3;case 3:return[2]}})})},CustomCallback.prototype.onTrainEnd=function(logs){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(_a){switch(_a.label){case 0:return null==this.trainEnd?[3,3]:[4,logs_1.resolveScalarsInLogs(logs)];case 1:return _a.sent(),[4,this.trainEnd(logs)];case 2:_a.sent(),_a.label=3;case 3:return[2]}})})},CustomCallback}(BaseCallback);exports.CustomCallback=CustomCallback,exports.standardizeCallbacks=function(callbacks,yieldEvery){return null==callbacks&&(callbacks={}),callbacks instanceof BaseCallback?[callbacks]:Array.isArray(callbacks)&&callbacks[0]instanceof BaseCallback?callbacks:generic_utils.toList(callbacks).map(function(callbackConfig){return new CustomCallback(callbackConfig,yieldEvery)})};var CallbackConstructorRegistry=function(){function CallbackConstructorRegistry(){}return CallbackConstructorRegistry.registerCallbackConstructor=function(verbosityLevel,callbackConstructor){tfjs_core_1.util.assert(0<=verbosityLevel&&Number.isInteger(verbosityLevel),function(){return"Verbosity level is expected to be an integer >= 0, but got "+verbosityLevel}),CallbackConstructorRegistry.checkForDuplicate(callbackConstructor),null==CallbackConstructorRegistry.constructors[verbosityLevel]&&(CallbackConstructorRegistry.constructors[verbosityLevel]=[]),CallbackConstructorRegistry.constructors[verbosityLevel].push(callbackConstructor)},CallbackConstructorRegistry.checkForDuplicate=function(callbackConstructor){for(var levelName in CallbackConstructorRegistry.constructors){CallbackConstructorRegistry.constructors[+levelName].forEach(function(ctor){if(ctor===callbackConstructor)throw new errors_1.ValueError("Duplicate callback constructor.")})}},CallbackConstructorRegistry.clear=function(){CallbackConstructorRegistry.constructors={}},CallbackConstructorRegistry.createCallbacks=function(verbosityLevel){var constructors=[];for(var levelName in CallbackConstructorRegistry.constructors){var level=+levelName;level<=verbosityLevel&&constructors.push.apply(constructors,CallbackConstructorRegistry.constructors[level])}return constructors.map(function(ctor){return new ctor})},CallbackConstructorRegistry.constructors={},CallbackConstructorRegistry}();exports.CallbackConstructorRegistry=CallbackConstructorRegistry,exports.configureCallbacks=function(callbacks,verbose,epochs,initialEpoch,numTrainSamples,stepsPerEpoch,batchSize,doValidation,callbackMetrics){var history=new History,actualCallbacks=[new BaseLogger].concat(CallbackConstructorRegistry.createCallbacks(verbose));null!=callbacks&&actualCallbacks.push.apply(actualCallbacks,callbacks),actualCallbacks.push(history);var callbackList=new CallbackList(actualCallbacks);return callbackList.setParams({epochs:epochs,initialEpoch:initialEpoch,samples:numTrainSamples,steps:stepsPerEpoch,batchSize:batchSize,verbose:verbose,doValidation:doValidation,metrics:callbackMetrics}),{callbackList:callbackList,history:history}}},{"./errors":289,"./logs":314,"./utils/generic_utils":322,"@tensorflow/tfjs-core":148}],278:[function(require,module,exports){"use strict";var extendStatics,__extends=this&&this.__extends||(extendStatics=function(d,b){return(extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p])})(d,b)},function(d,b){function __(){this.constructor=d}extendStatics(d,b),d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)}),__awaiter=this&&this.__awaiter||function(thisArg,_arguments,P,generator){return new(P=P||Promise)(function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){result.done?resolve(result.value):new P(function(resolve){resolve(result.value)}).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())})},__generator=this&&this.__generator||function(thisArg,body){var f,y,t,g,_={label:0,sent:function(){if(1&t[0])throw t[1];return t[1]},trys:[],ops:[]};return g={next:verb(0),throw:verb(1),return:verb(2)},"function"==typeof Symbol&&(g[Symbol.iterator]=function(){return this}),g;function verb(n){return function(v){return function(op){if(f)throw new TypeError("Generator is already executing.");for(;_;)try{if(f=1,y&&(t=2&op[0]?y.return:op[0]?y.throw||((t=y.return)&&t.call(y),0):y.next)&&!(t=t.call(y,op[1])).done)return t;switch(y=0,t&&(op=[2&op[0],t.value]),op[0]){case 0:case 1:t=op;break;case 4:return _.label++,{value:op[1],done:!1};case 5:_.label++,y=op[1],op=[0];continue;case 7:op=_.ops.pop(),_.trys.pop();continue;default:if(!(t=0<(t=_.trys).length&&t[t.length-1])&&(6===op[0]||2===op[0])){_=0;continue}if(3===op[0]&&(!t||op[1]>t[0]&&op[1]<t[3])){_.label=op[1];break}if(6===op[0]&&_.label<t[1]){_.label=t[1],t=op;break}if(t&&_.label<t[2]){_.label=t[2],_.ops.push(op);break}t[2]&&_.ops.pop(),_.trys.pop();continue}op=body.call(thisArg,_)}catch(e){op=[6,e],y=0}finally{f=t=0}if(5&op[0])throw op[1];return{value:op[0]?op[1]:void 0,done:!0}}([n,v])}}};Object.defineProperty(exports,"__esModule",{value:!0});var base_callbacks_1=require("./base_callbacks"),training_1=require("./engine/training"),errors_1=require("./errors"),logs_1=require("./logs"),Callback=function(_super){function Callback(){var _this=null!==_super&&_super.apply(this,arguments)||this;return _this.model=null,_this}return __extends(Callback,_super),Callback.prototype.setModel=function(model){if(!(model instanceof training_1.LayersModel))throw new Error("model must be a LayersModel, not some other Container");this.model=model},Callback}(base_callbacks_1.BaseCallback);function less(currVal,prevVal){return currVal<prevVal}function greater(currVal,prevVal){return prevVal<currVal}var EarlyStopping=function(_super){function EarlyStopping(args){var _this=_super.call(this)||this;if(null==args&&(args={}),args.restoreBestWeights)throw new errors_1.NotImplementedError("restoreBestWeights = True is not implemented in EarlyStopping yet.");return _this.monitor=args.monitor||"val_loss",_this.minDelta=Math.abs(args.minDelta||0),_this.patience=args.patience||0,_this.verbose=args.verbose||0,_this.mode=args.mode||"auto",_this.baseline=args.baseline,-1===["auto","min","max"].indexOf(_this.mode)&&(console.warn("EarlyStopping mode '"+_this.mode+"' is invalid. Falling back to mode 'auto'."),_this.mode="auto"),"min"===_this.mode?_this.monitorFunc=less:"max"===_this.mode?_this.monitorFunc=greater:-1!==_this.monitor.indexOf("acc")?_this.monitorFunc=greater:_this.monitorFunc=less,_this.monitorFunc===less&&(_this.minDelta*=-1),_this}return __extends(EarlyStopping,_super),EarlyStopping.prototype.onTrainBegin=function(logs){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(_a){return this.wait=0,this.stoppedEpoch=0,null!=this.baseline?this.best=this.baseline:this.best=this.monitorFunc===less?1/0:-1/0,[2]})})},EarlyStopping.prototype.onEpochEnd=function(epoch,logs){return __awaiter(this,void 0,void 0,function(){var current;return __generator(this,function(_a){switch(_a.label){case 0:return[4,logs_1.resolveScalarsInLogs(logs)];case 1:return _a.sent(),null==(current=this.getMonitorValue(logs))?[2]:(this.monitorFunc(current-this.minDelta,this.best)?(this.best=current,this.wait=0):(this.wait++,this.wait>=this.patience&&(this.stoppedEpoch=epoch,this.model.stopTraining=!0)),[2])}})})},EarlyStopping.prototype.onTrainEnd=function(logs){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(_a){return 0<this.stoppedEpoch&&this.verbose&&console.log("Epoch "+this.stoppedEpoch+": early stopping."),[2]})})},EarlyStopping.prototype.getMonitorValue=function(logs){null==logs&&(logs={});var monitorValue=logs[this.monitor];return null==monitorValue&&console.warn("Metric for EarlyStopping "+this.monitor+" is not available. Available metrics are: "+Object.keys(logs)),monitorValue},EarlyStopping}(exports.Callback=Callback);function earlyStopping(args){return new EarlyStopping(args)}exports.EarlyStopping=EarlyStopping,exports.earlyStopping=earlyStopping,exports.callbacks={earlyStopping:earlyStopping}},{"./base_callbacks":277,"./engine/training":285,"./errors":289,"./logs":314}],279:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var common_1=require("./keras_format/common"),generic_utils_1=require("./utils/generic_utils"),nameMap=new Map;exports.checkDataFormat=function(value){generic_utils_1.checkStringTypeUnionValue(common_1.VALID_DATA_FORMAT_VALUES,"DataFormat",value)},exports.checkPaddingMode=function(value){generic_utils_1.checkStringTypeUnionValue(common_1.VALID_PADDING_MODE_VALUES,"PaddingMode",value)},exports.checkPoolMode=function(value){generic_utils_1.checkStringTypeUnionValue(common_1.VALID_POOL_MODE_VALUES,"PoolMode",value)};var _nameScopeStack=[],_nameScopeDivider="/";exports.nameScope=function(name,fn){_nameScopeStack.push(name);try{var val=fn();return _nameScopeStack.pop(),val}catch(e){throw _nameScopeStack.pop(),e}},exports.getScopedTensorName=function(tensorName){if(!isValidTensorName(tensorName))throw new Error("Not a valid tensor name: '"+tensorName+"'");return(0===_nameScopeStack.length?"":_nameScopeStack.join(_nameScopeDivider)+_nameScopeDivider)+tensorName},exports.getUniqueTensorName=function(scopedName){if(!isValidTensorName(scopedName))throw new Error("Not a valid tensor name: '"+scopedName+"'");nameMap.has(scopedName)||nameMap.set(scopedName,0);var index=nameMap.get(scopedName);if(nameMap.set(scopedName,nameMap.get(scopedName)+1),0<index){var result=scopedName+"_"+index;return nameMap.set(result,1),result}return scopedName};var tensorNameRegex=new RegExp(/^[A-Za-z0-9][-A-Za-z0-9\._\/]*$/);function isValidTensorName(name){return!!name.match(tensorNameRegex)}exports.isValidTensorName=isValidTensorName},{"./keras_format/common":299,"./utils/generic_utils":322}],280:[function(require,module,exports){"use strict";var extendStatics,__extends=this&&this.__extends||(extendStatics=function(d,b){return(extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p])})(d,b)},function(d,b){function __(){this.constructor=d}extendStatics(d,b),d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)});Object.defineProperty(exports,"__esModule",{value:!0});var tfc=require("@tensorflow/tfjs-core"),tfjs_core_1=require("@tensorflow/tfjs-core"),common_1=require("./backend/common"),generic_utils_1=require("./utils/generic_utils");function calcL2Norms(w,axis){return tfjs_core_1.tidy(function(){return tfc.sqrt(tfc.sum(tfc.mulStrict(w,w),axis,!0))})}var Constraint=function(_super){function Constraint(){return null!==_super&&_super.apply(this,arguments)||this}return __extends(Constraint,_super),Constraint.prototype.getConfig=function(){return{}},Constraint}(tfjs_core_1.serialization.Serializable),MaxNorm=function(_super){function MaxNorm(args){var _this=_super.call(this)||this;return _this.defaultMaxValue=2,_this.defaultAxis=0,_this.maxValue=null!=args.maxValue?args.maxValue:_this.defaultMaxValue,_this.axis=null!=args.axis?args.axis:_this.defaultAxis,_this}return __extends(MaxNorm,_super),MaxNorm.prototype.apply=function(w){var _this=this;return tfjs_core_1.tidy(function(){var norms=calcL2Norms(w,_this.axis),desired=tfc.clipByValue(norms,0,_this.maxValue);return tfc.mul(w,tfc.div(desired,tfc.add(common_1.epsilon(),norms)))})},MaxNorm.prototype.getConfig=function(){return{maxValue:this.maxValue,axis:this.axis}},MaxNorm.className="MaxNorm",MaxNorm}(exports.Constraint=Constraint);exports.MaxNorm=MaxNorm,tfjs_core_1.serialization.registerClass(MaxNorm);var UnitNorm=function(_super){function UnitNorm(args){var _this=_super.call(this)||this;return _this.defaultAxis=0,_this.axis=null!=args.axis?args.axis:_this.defaultAxis,_this}return __extends(UnitNorm,_super),UnitNorm.prototype.apply=function(w){var _this=this;return tfjs_core_1.tidy(function(){return tfc.div(w,tfc.add(common_1.epsilon(),calcL2Norms(w,_this.axis)))})},UnitNorm.prototype.getConfig=function(){return{axis:this.axis}},UnitNorm.className="UnitNorm",UnitNorm}(Constraint);exports.UnitNorm=UnitNorm,tfjs_core_1.serialization.registerClass(UnitNorm);var NonNeg=function(_super){function NonNeg(){return null!==_super&&_super.apply(this,arguments)||this}return __extends(NonNeg,_super),NonNeg.prototype.apply=function(w){return tfc.relu(w)},NonNeg.className="NonNeg",NonNeg}(Constraint);exports.NonNeg=NonNeg,tfjs_core_1.serialization.registerClass(NonNeg);var MinMaxNorm=function(_super){function MinMaxNorm(args){var _this=_super.call(this)||this;return _this.defaultMinValue=0,_this.defaultMaxValue=1,_this.defaultRate=1,_this.defaultAxis=0,_this.minValue=null!=args.minValue?args.minValue:_this.defaultMinValue,_this.maxValue=null!=args.maxValue?args.maxValue:_this.defaultMaxValue,_this.rate=null!=args.rate?args.rate:_this.defaultRate,_this.axis=null!=args.axis?args.axis:_this.defaultAxis,_this}return __extends(MinMaxNorm,_super),MinMaxNorm.prototype.apply=function(w){var _this=this;return tfjs_core_1.tidy(function(){var norms=calcL2Norms(w,_this.axis),desired=tfc.add(tfc.mul(_this.rate,tfc.clipByValue(norms,_this.minValue,_this.maxValue)),tfc.mul(1-_this.rate,norms));return tfc.mul(w,tfc.div(desired,tfc.add(common_1.epsilon(),norms)))})},MinMaxNorm.prototype.getConfig=function(){return{minValue:this.minValue,maxValue:this.maxValue,rate:this.rate,axis:this.axis}},MinMaxNorm.className="MinMaxNorm",MinMaxNorm}(Constraint);function deserializeConstraint(config,customObjects){return void 0===customObjects&&(customObjects={}),generic_utils_1.deserializeKerasObject(config,tfjs_core_1.serialization.SerializationMap.getMap().classNameMap,customObjects,"constraint")}exports.MinMaxNorm=MinMaxNorm,tfjs_core_1.serialization.registerClass(MinMaxNorm),exports.CONSTRAINT_IDENTIFIER_REGISTRY_SYMBOL_MAP={maxNorm:"MaxNorm",minMaxNorm:"MinMaxNorm",nonNeg:"NonNeg",unitNorm:"UnitNorm"},exports.serializeConstraint=function(constraint){return generic_utils_1.serializeKerasObject(constraint)},exports.deserializeConstraint=deserializeConstraint,exports.getConstraint=function(identifier){return null==identifier?null:"string"!=typeof identifier?identifier instanceof Constraint?identifier:deserializeConstraint(identifier):deserializeConstraint({className:identifier in exports.CONSTRAINT_IDENTIFIER_REGISTRY_SYMBOL_MAP?exports.CONSTRAINT_IDENTIFIER_REGISTRY_SYMBOL_MAP[identifier]:identifier,config:{}})}},{"./backend/common":274,"./utils/generic_utils":322,"@tensorflow/tfjs-core":148}],281:[function(require,module,exports){"use strict";var extendStatics,__extends=this&&this.__extends||(extendStatics=function(d,b){return(extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p])})(d,b)},function(d,b){function __(){this.constructor=d}extendStatics(d,b),d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)});Object.defineProperty(exports,"__esModule",{value:!0});var tfjs_core_1=require("@tensorflow/tfjs-core"),state_1=require("../backend/state"),errors_1=require("../errors"),serialization_1=require("../layers/serialization"),generic_utils=require("../utils/generic_utils"),serialization_utils_1=require("../utils/serialization_utils"),types_utils=require("../utils/types_utils"),variables_1=require("../variables"),version_1=require("../version"),executor_1=require("./executor"),input_layer_1=require("./input_layer"),topology_1=require("./topology"),Container=function(_super){function Container(args){var _this=_super.call(this,{})||this;if(_this.containerNodes=new Set,_this.name=args.name,null==_this.name){var prefix=_this.getClassName().toLowerCase();_this.name=state_1.getUid(prefix)}if(_this.supportsMasking=!1,_this.trainable_=!0,Array.isArray(args.inputs)?_this.inputs=args.inputs.slice():_this.inputs=[args.inputs],Array.isArray(args.outputs)?_this.outputs=args.outputs.slice():_this.outputs=[args.outputs],generic_utils.unique(_this.inputs).length!==_this.inputs.length)throw new errors_1.ValueError("The list of inputs passed to the model is redundant. All inputs should only appear once. Found: "+_this.inputs.map(function(x){return x.name}));generic_utils.unique(_this.outputs).length!==_this.outputs.length&&console.warn("The list of outputs passed to the model is redundant. All outputs should only appear once. Found: "+_this.outputs.map(function(x){return x.name})),_this.inputLayers=[],_this.inputLayersNodeIndices=[],_this.inputLayersTensorIndices=[],_this.outputLayers=[],_this.outputLayersNodeIndices=[],_this.outputLayersTensorIndices=[],_this.layers=[];for(var _i=0,_a=_this.outputs;_i<_a.length;_i++){var layer=(x=_a[_i]).sourceLayer,nodeIndex=x.nodeIndex,tensorIndex=x.tensorIndex;_this.outputLayers.push(layer),_this.outputLayersNodeIndices.push(nodeIndex),_this.outputLayersTensorIndices.push(tensorIndex)}for(var _b=0,_c=_this.inputs;_b<_c.length;_b++){layer=(x=_c[_b]).sourceLayer,nodeIndex=x.nodeIndex,tensorIndex=x.tensorIndex;generic_utils.assert(0===nodeIndex,"input layer has >1 nodes"),generic_utils.assert(0===tensorIndex,"input layer has >1 tensors"),_this.inputLayers.push(layer),_this.inputLayersNodeIndices.push(nodeIndex),_this.inputLayersTensorIndices.push(tensorIndex)}_this.inputNames=[],_this.outputNames=[],_this.feedInputShapes=[],_this.feedInputNames=[],_this.feedOutputNames=[];for(var i=0;i<_this.inputLayers.length;i++){if(!((layer=_this.inputLayers[i])instanceof input_layer_1.InputLayer))throw new TypeError("Input layers to a LayersModel must be InputLayer objects. Received inputs: "+args.inputs+". Input "+i+" (0-based) originates from layer type "+layer.getClassName()+".");_this.inputNames.push(layer.name),_this.feedInputShapes.push(layer.batchInputShape),_this.feedInputNames.push(layer.name)}for(var _d=0,_e=_this.outputLayers;_d<_e.length;_d++){layer=_e[_d];_this.outputNames.push(layer.name)}_this.internalInputShapes=_this.inputs.map(function(x){return x.shape}),_this.internalOutputShapes=_this.outputs.map(function(x){return x.shape});for(var nodesDepths={},nodeIDToNode={},layersDepths={},layerIDToLayer={},layerIndices={},nodesInDecreasingDepth=[],buildMapOfGraph=function(tensor,finishedNodes,nodesInProgress,layer,nodeIndex,tensorIndex){null!=layer&&null!=nodeIndex&&null!=tensorIndex||(layer=tensor.sourceLayer,nodeIndex=tensor.nodeIndex,tensorIndex=tensor.tensorIndex);var node=layer.inboundNodes[nodeIndex];if(-1!==nodesInProgress.indexOf(node))throw new errors_1.RuntimeError("The tensor "+tensor.name+' at layer "'+layer.name+'" is part of a cycle.');if(-1===finishedNodes.indexOf(node)){_this.containerNodes.add(Container.nodeKey(layer,nodeIndex)),layer.id in layerIndices||(layerIndices[layer.id]=Object.keys(layerIndices).length),-1===nodesInProgress.indexOf(node)&&nodesInProgress.push(node);for(var numInboundLayers=node.inboundLayers.length,i=0;i<numInboundLayers;i++){var x=node.inputTensors[i],layer_1=node.inboundLayers[i],nodeIndex_1=node.nodeIndices[i],tensorIndex_1=node.tensorIndices[i];buildMapOfGraph(x,finishedNodes,nodesInProgress,layer_1,nodeIndex_1,tensorIndex_1)}for(finishedNodes.push(node);0<=nodesInProgress.indexOf(node);)nodesInProgress.splice(nodesInProgress.indexOf(node),1);nodesInDecreasingDepth.push(node)}},finishedNodes=[],nodesInProgress=[],_f=0,_g=_this.outputs;_f<_g.length;_f++){var x=_g[_f];buildMapOfGraph(x,finishedNodes,nodesInProgress)}for(var _h=0,reversedNodesInDecreasingDepth_1=nodesInDecreasingDepth.slice().reverse();_h<reversedNodesInDecreasingDepth_1.length;_h++){(nodeIDToNode[(node=reversedNodesInDecreasingDepth_1[_h]).id]=node).id in nodesDepths||(nodesDepths[node.id]=0);var depth=nodesDepths[node.id],previousDepth=null==layersDepths[node.outboundLayer.id]?0:layersDepths[node.outboundLayer.id];depth=Math.max(depth,previousDepth),layersDepths[node.outboundLayer.id]=depth,layerIDToLayer[node.outboundLayer.id]=node.outboundLayer,nodesDepths[node.id]=depth;for(i=0;i<node.inboundLayers.length;i++){var inboundLayer=node.inboundLayers[i],inboundNode=(nodeIndex=node.nodeIndices[i],inboundLayer.inboundNodes[nodeIndex]),previousDepth_1=null==nodesDepths[inboundNode.id]?0:nodesDepths[inboundNode.id];nodesDepths[inboundNode.id]=Math.max(depth+1,previousDepth_1),nodeIDToNode[inboundNode.id]=inboundNode}}var nodesByDepth={};for(var nodeID in nodesDepths){(depth=nodesDepths[nodeID])in nodesByDepth||(nodesByDepth[depth]=[]),nodesByDepth[depth].push(nodeIDToNode[nodeID])}var layersByDepth={};for(var layerID in layersDepths){(depth=layersDepths[layerID])in layersByDepth||(layersByDepth[depth]=[]),layersByDepth[depth].push(layerIDToLayer[layerID])}var depthKeys=Object.keys(layersByDepth).map(function(x){return parseInt(x,10)}).sort(generic_utils.reverseNumberCompare);_this.layers=[];for(var _j=0,depthKeys_1=depthKeys;_j<depthKeys_1.length;_j++){var layersForDepth=layersByDepth[depth=depthKeys_1[_j]];layersForDepth.sort(function(a,b){var aIndex=layerIndices[a.id],bIndex=layerIndices[b.id];return aIndex<bIndex?-1:bIndex<aIndex?1:0});for(var _k=0,layersForDepth_1=layersForDepth;_k<layersForDepth_1.length;_k++){layer=layersForDepth_1[_k];_this.layers.push(layer)}}_this.layersByDepth=layersByDepth,depthKeys=Object.keys(nodesByDepth).map(function(x){return parseInt(x,10)}).sort(generic_utils.reverseNumberCompare);for(var computableTensors=_this.inputs.slice(),layersWithCompleteInput=[],_l=0,depthKeys_2=depthKeys;_l<depthKeys_2.length;_l++)for(var _m=0,_o=nodesByDepth[depth=depthKeys_2[_l]];_m<_o.length;_m++){var node;if(null!=(layer=(node=_o[_m]).outboundLayer)){for(var _p=0,_q=node.inputTensors;_p<_q.length;_p++){x=_q[_p];if(-1===computableTensors.indexOf(x))throw new errors_1.RuntimeError("Graph disconnected: cannot obtain value for tensor "+x+' at layer "'+layer.name+'". The following previous layers were accessed without issue: '+layersWithCompleteInput)}for(var _r=0,_s=node.outputTensors;_r<_s.length;_r++){x=_s[_r];computableTensors.push(x)}layersWithCompleteInput.push(layer.name)}}_this.nodesByDepth=nodesByDepth;for(var allNames=_this.layers.map(function(x){return x.name}),_loop_1=function(name_1){var numOccurrences=allNames.filter(function(x){return x===name_1}).length;if(1!==numOccurrences)throw new errors_1.RuntimeError('The name "'+name_1+'" is used '+numOccurrences+" times in the model. All layer names should be unique. Layer names: "+JSON.stringify(allNames))},_t=0,allNames_1=allNames;_t<allNames_1.length;_t++){_loop_1(allNames_1[_t])}return _this.outboundNodes=[],_this.inboundNodes=[],new topology_1.Node({outboundLayer:_this,inboundLayers:[],nodeIndices:[],tensorIndices:[],inputTensors:_this.inputs,outputTensors:_this.outputs,inputMasks:_this.inputs.map(function(x){return null}),outputMasks:_this.outputs.map(function(x){return null}),inputShapes:_this.inputs.map(function(x){return x.shape}),outputShapes:_this.outputs.map(function(x){return x.shape})}),_this.built=!0,_this._refCount=1,_this}return __extends(Container,_super),Container.prototype.assertNotDisposed=function(){if(0===this._refCount)throw new Error("Container '"+this.name+"' is already disposed.")},Container.prototype.dispose=function(){this.assertNotDisposed();var result={refCountAfterDispose:null,numDisposedVariables:0};if(0==--this._refCount)for(var _i=0,_a=this.layers;_i<_a.length;_i++){var layer=_a[_i];result.numDisposedVariables+=layer.dispose().numDisposedVariables}return result.refCountAfterDispose=this._refCount,result},Object.defineProperty(Container.prototype,"trainable",{get:function(){return this.trainable_},set:function(trainable){this.layers.forEach(function(layer){layer._trainableWeights.forEach(function(w){return w.trainable=trainable})}),this.trainable_=trainable},enumerable:!0,configurable:!0}),Object.defineProperty(Container.prototype,"trainableWeights",{get:function(){if(0<this._trainableWeights.length)throw new errors_1.ValueError("Container instance unexpectedly contains _trainableWeights.The trainable weights of a Container are a union of the trainable weights of its consituent Layers. Its own _trainableWeights must remain an empty Array.");if(!this.trainable)return[];for(var weights=[],_i=0,_a=this.layers;_i<_a.length;_i++){var layer=_a[_i];weights=weights.concat(layer.trainableWeights)}return weights},enumerable:!0,configurable:!0}),Object.defineProperty(Container.prototype,"nonTrainableWeights",{get:function(){for(var weights=[],_i=0,_a=this.layers;_i<_a.length;_i++){var layer=_a[_i];weights.push.apply(weights,layer.nonTrainableWeights)}if(this.trainable)return weights;for(var trainableWeights=[],_b=0,_c=this.layers;_b<_c.length;_b++){layer=_c[_b];trainableWeights.push.apply(trainableWeights,layer.trainableWeights)}return trainableWeights.concat(weights)},enumerable:!0,configurable:!0}),Object.defineProperty(Container.prototype,"weights",{get:function(){return this.trainableWeights.concat(this.nonTrainableWeights)},enumerable:!0,configurable:!0}),Container.prototype.loadWeights=function(weights,strict){void 0===strict&&(strict=!0);for(var nameToWeight={},totalWeightsCount=0,_i=0,_a=this.layers;_i<_a.length;_i++)for(var _b=0,_c=_a[_i].weights;_b<_c.length;_b++){var weight=_c[_b];if(null!=nameToWeight[weight.originalName])throw new errors_1.ValueError("Duplicate weight name: "+weight.originalName);nameToWeight[weight.originalName]=weight,totalWeightsCount++}var weightValueTuples=[];for(var name_2 in weights){if(null!=nameToWeight[name_2])weightValueTuples.push([nameToWeight[name_2],weights[name_2]]);else if(strict)throw new errors_1.ValueError("Provided weight data has no target variable: "+name_2);delete nameToWeight[name_2]}if(strict){var unsetNames=[];for(var name_3 in nameToWeight)unsetNames.push(name_3);if(0<unsetNames.length)throw new errors_1.ValueError(unsetNames.length+" of "+totalWeightsCount+" weights are not set: "+unsetNames)}variables_1.batchSetValue(weightValueTuples)},Container.prototype.updatedConfig=function(){var theConfig=this.getConfig(),modelConfig={};return modelConfig.className=this.getClassName(),modelConfig.config=theConfig,modelConfig.kerasVersion="tfjs-layers "+version_1.version,modelConfig.backend="TensorFlow.js",modelConfig},Container.prototype.toJSON=function(unused,returnString){void 0===returnString&&(returnString=!0);var modelConfig=serialization_utils_1.convertTsToPythonic(this.updatedConfig());return returnString?JSON.stringify(modelConfig):modelConfig},Container.prototype.call=function(inputs,kwargs){var _this=this;return tfjs_core_1.tidy(function(){inputs=generic_utils.toList(inputs);for(var feedDict=new executor_1.FeedDict,i=0;i<_this.inputs.length;++i)feedDict.add(_this.inputs[i],inputs[i]);return executor_1.execute(_this.outputs,feedDict,kwargs)})},Container.prototype.computeMask=function(inputs,mask){var _this=this;return tfjs_core_1.tidy(function(){var masks;return inputs=generic_utils.toList(inputs),masks=null==mask?generic_utils.pyListRepeat(null,inputs.length):generic_utils.toList(mask),_this.runInternalGraph(inputs,masks)[1]})},Container.prototype.computeOutputShape=function(inputShape){var inputShapes=types_utils.normalizeShapeList(inputShape);if(inputShapes.length!==this.inputLayers.length)throw new errors_1.ValueError("Invalid inputShape argument "+inputShape+": model has "+this.inputLayers.length+" tensor inputs.");for(var layersToOutputShapes={},i=0;i<inputShapes.length;i++){var layer=this.inputLayers[i],inputShape_1=inputShapes[i];layersToOutputShapes[shapeKey=layer.name+"_0_0"]=inputShape_1}var depthKeys=Object.keys(this.nodesByDepth).map(function(x){return parseInt(x,10)}).sort(generic_utils.reverseNumberCompare);if(1<depthKeys.length)for(var _i=0,depthKeys_3=depthKeys;_i<depthKeys_3.length;_i++)for(var depth=depthKeys_3[_i],_a=0,nodes_1=this.nodesByDepth[depth];_a<nodes_1.length;_a++){var node=nodes_1[_a];layer=node.outboundLayer;if(-1===this.inputLayers.map(function(x){return x.id}).indexOf(layer.id)){for(var inputShapes_1=[],j=0;j<node.inboundLayers.length;j++){var inboundLayer=node.inboundLayers[j],nodeIndex_2=node.nodeIndices[j],tensorIndex=node.tensorIndices[j],inputShape_2=layersToOutputShapes[shapeKey=inboundLayer.name+"_"+nodeIndex_2+"_"+tensorIndex];inputShapes_1.push(inputShape_2)}var outputShape=layer.computeOutputShape(generic_utils.singletonOrArray(inputShapes_1)),outputShapes_1=types_utils.normalizeShapeList(outputShape),nodeIndex=layer.inboundNodes.indexOf(node);for(j=0;j<outputShapes_1.length;j++){layersToOutputShapes[shapeKey=layer.name+"_"+nodeIndex+"_"+j]=outputShapes_1[j]}}}var outputShapes=[],outputShapeKeys=[];for(i=0;i<this.outputLayers.length;i++){layer=this.outputLayers[i],nodeIndex=this.outputLayersNodeIndices[i],tensorIndex=this.outputLayersTensorIndices[i];var shapeKey=layer.name+"_"+nodeIndex+"_"+tensorIndex;outputShapeKeys.push(shapeKey)}for(i=0;i<outputShapeKeys.length;i++){var key=outputShapeKeys[i];generic_utils.assert(key in layersToOutputShapes),outputShapes.push(layersToOutputShapes[key])}return generic_utils.singletonOrArray(outputShapes)},Container.prototype.runInternalGraph=function(inputs,masks){null==masks&&(masks=generic_utils.pyListRepeat(null,inputs.length));for(var tensorMap={},i=0;i<this.inputs.length;++i){var x=this.inputs[i],y=inputs[i],mask=masks[i];tensorMap[x.id]=[y,mask]}for(var _i=0,depthKeys_4=Object.keys(this.nodesByDepth).map(function(x){return parseInt(x,10)}).sort(generic_utils.reverseNumberCompare);_i<depthKeys_4.length;_i++)for(var depth=depthKeys_4[_i],_a=0,nodes_2=this.nodesByDepth[depth];_a<nodes_2.length;_a++){for(var node=nodes_2[_a],layer=node.outboundLayer,referenceInputTensors=node.inputTensors,referenceOutputTensors=node.outputTensors,computedData=new Array,_b=0,referenceInputTensors_1=referenceInputTensors;_b<referenceInputTensors_1.length;_b++){(x=referenceInputTensors_1[_b]).id in tensorMap&&computedData.push(tensorMap[x.id])}if(computedData.length===referenceInputTensors.length){var kwargs={},computedTensors=void 0,computedMasks=void 0,outputTensors_1=void 0,outputMasks_1=void 0;if(null!=node.callArgs&&(kwargs=node.callArgs),1===computedData.length){var _c=computedData[0],computedTensor=_c[0],computedMask=_c[1];null==kwargs.mask&&(kwargs.mask=computedMask),outputTensors_1=generic_utils.toList(layer.call(computedTensor,kwargs)),outputMasks_1=generic_utils.toList(layer.computeMask(computedTensor,computedMask)),computedTensors=[computedTensor],computedMasks=[computedMask]}else computedTensors=computedData.map(function(x){return x[0]}),computedMasks=computedData.map(function(x){return x[1]}),null==kwargs.mask&&(kwargs.mask=computedMasks),outputTensors_1=generic_utils.toList(layer.call(computedTensors,kwargs)),outputMasks_1=generic_utils.toList(layer.computeMask(computedTensors,computedMasks));if(layer.activityRegularizer)throw new errors_1.NotImplementedError("LayersModel invocation with concrete Tensor value(s) in the presence of activity regularizer(s) is not supported yet.");for(i=0;i<referenceOutputTensors.length;++i){x=referenceOutputTensors[i],y=outputTensors_1[i],mask=outputMasks_1[i];tensorMap[x.id]=[y,mask]}}}for(var outputTensors=[],outputMasks=[],outputShapes=[],_d=0,_e=this.outputs;_d<_e.length;_d++){x=_e[_d];generic_utils.assert(x.id in tensorMap,"Could not compute output "+x.name+" : "+x.id);var _f=tensorMap[x.id],tensor=_f[0];mask=_f[1];outputShapes.push(tensor.shape),outputTensors.push(tensor),outputMasks.push(mask)}return[outputTensors,outputMasks,outputShapes]},Container.prototype.buildNodeConversionMap=function(layers){for(var keptNodes,nodeConversionMap={},_i=0,_a=this.layers;_i<_a.length;_i++){var layer=_a[_i];keptNodes=layer instanceof Container?1:0;for(var originalNodeIndex=0;originalNodeIndex<layer.inboundNodes.length;originalNodeIndex++){var nodeKey=Container.nodeKey(layer,originalNodeIndex);this.containerNodes.has(nodeKey)&&(nodeConversionMap[nodeKey]=keptNodes,keptNodes+=1)}}return nodeConversionMap},Container.prototype.getLayer=function(name,index){if(null!=index){if(this.layers.length<=index)throw new errors_1.ValueError("Was asked to retrieve layer at index "+index+", but model only has "+this.layers.length+" layer(s).");return this.layers[index]}if(null==name)throw new errors_1.ValueError("Provide either a layer name or layer index");for(var _i=0,_a=this.layers;_i<_a.length;_i++){var layer=_a[_i];if(layer.name===name)return layer}throw new errors_1.ValueError("No such layer: "+name)},Container.prototype.calculateLosses=function(){var _this=this;return tfjs_core_1.tidy(function(){for(var losses=[],_i=0,_a=_this.layers;_i<_a.length;_i++)for(var layer=_a[_i],nodeIndex=0;nodeIndex<layer.inboundNodes.length;++nodeIndex){var nodeKey=Container.nodeKey(layer,nodeIndex);_this.containerNodes.has(nodeKey)&&losses.push.apply(losses,layer.calculateLosses())}return losses})},Container.prototype.getConfig=function(){for(var config={name:this.name},nodeConversionMap=this.buildNodeConversionMap(this.layers),layerConfigs=[],_i=0,_a=this.layers;_i<_a.length;_i++){for(var layerClassName=(layer=_a[_i]).getClassName(),layerConfig=layer.getConfig(),filteredInboundNodes=[],originalNodeIndex=0;originalNodeIndex<layer.inboundNodes.length;originalNodeIndex++){var node=layer.inboundNodes[originalNodeIndex],nodeKey=Container.nodeKey(layer,originalNodeIndex),kwargs={};if(this.containerNodes.has(nodeKey)){if(node.callArgs)try{JSON.stringify(node.callArgs),kwargs=node.callArgs}catch(err){console.warn("Layer "+layer.name+" was passed non-serializable keyword arguments: "+node.callArgs+". They will not be included in the serialized model (and thus will be missing at deserialization time)."),kwargs={}}if(0<node.inboundLayers.length){for(var nodeData=[],i=0;i<node.inboundLayers.length;i++){var inboundLayer=node.inboundLayers[i],nodeIndex=node.nodeIndices[i],tensorIndex=node.tensorIndices[i];null==(newNodeIndex=nodeConversionMap[Container.nodeKey(inboundLayer,nodeIndex)])&&(newNodeIndex=0),nodeData.push([inboundLayer.name,newNodeIndex,tensorIndex,kwargs])}filteredInboundNodes.push(nodeData)}}}var dict={};dict.name=layer.name,dict.className=layerClassName,dict.config=layerConfig,dict.inboundNodes=filteredInboundNodes,layerConfigs.push(dict)}config.layers=layerConfigs;var modelInputs=[];for(i=0;i<this.inputLayers.length;i++){var layer=this.inputLayers[i];nodeIndex=this.inputLayersNodeIndices[i],nodeKey=Container.nodeKey(layer,nodeIndex);if(this.containerNodes.has(nodeKey)){null==(newNodeIndex=nodeConversionMap[nodeKey])&&(newNodeIndex=0);tensorIndex=this.inputLayersTensorIndices[i];modelInputs.push([layer.name,newNodeIndex,tensorIndex])}}config.inputLayers=modelInputs;var modelOutputs=[];for(i=0;i<this.outputLayers.length;i++){layer=this.outputLayers[i],nodeIndex=this.outputLayersNodeIndices[i],nodeKey=Container.nodeKey(layer,nodeIndex);if(this.containerNodes.has(nodeKey)){var newNodeIndex;null==(newNodeIndex=nodeConversionMap[nodeKey])&&(newNodeIndex=0);tensorIndex=this.outputLayersTensorIndices[i];modelOutputs.push([layer.name,newNodeIndex,tensorIndex])}}return config.outputLayers=modelOutputs,config},Container.fromConfig=function(cls,config,customObjects,fastWeightInit){void 0===customObjects&&(customObjects={}),void 0===fastWeightInit&&(fastWeightInit=!1);var createdLayers={},unprocessedNodes={};function addUnprocessedNode(layer,nodeData){layer.name in unprocessedNodes?unprocessedNodes[layer.name].push(nodeData):unprocessedNodes[layer.name]=[nodeData]}function processNode(layer,nodeData){for(var kwargs,inputTensors=[],_i=0,nodeData_1=nodeData;_i<nodeData_1.length;_i++){var inputData=nodeData_1[_i],inboundLayerName=inputData[0],inboundNodeIndex=inputData[1],inboundTensorIndex=inputData[2];if(kwargs=null==inputData[3]?{}:inputData[3],!(inboundLayerName in createdLayers))return void addUnprocessedNode(layer,nodeData);var inboundLayer=createdLayers[inboundLayerName];if(inboundLayer.inboundNodes.length<=inboundNodeIndex)return void addUnprocessedNode(layer,nodeData);var inboundNode=inboundLayer.inboundNodes[inboundNodeIndex];inputTensors.push(inboundNode.outputTensors[inboundTensorIndex])}0<inputTensors.length&&layer.apply(generic_utils.singletonOrArray(inputTensors),kwargs)}function processLayer(layerData){var layerName=layerData.name,layer=serialization_1.deserialize(layerData,null!=config.customObjects?config.customObjects:{});layer.setFastWeightInitDuringBuild(fastWeightInit),createdLayers[layerName]=layer,layerData.inboundNodes.forEach(function(nodeData){if(!(nodeData instanceof Array))throw new errors_1.ValueError("Corrupted configuration, expected array for nodeData: "+nodeData);addUnprocessedNode(layer,nodeData)})}for(var name=config.name,layersFromConfig=config.layers,_i=0,layersFromConfig_1=layersFromConfig;_i<layersFromConfig_1.length;_i++){processLayer(layerData=layersFromConfig_1[_i])}for(;!generic_utils.isObjectEmpty(unprocessedNodes);)for(var _a=0,layersFromConfig_2=layersFromConfig;_a<layersFromConfig_2.length;_a++){var layerData=layersFromConfig_2[_a];if((layer=createdLayers[layerData.name]).name in unprocessedNodes){var currentUnprocessedNodesForLayer=unprocessedNodes[layer.name];delete unprocessedNodes[layer.name];for(var _b=0,currentUnprocessedNodesForLayer_1=currentUnprocessedNodesForLayer;_b<currentUnprocessedNodesForLayer_1.length;_b++){processNode(layer,currentUnprocessedNodesForLayer_1[_b])}}}for(var inputTensors=[],outputTensors=[],_c=0,inputLayersFromConfig_1=config.inputLayers;_c<inputLayersFromConfig_1.length;_c++){var layerName=(layerData=inputLayersFromConfig_1[_c])[0],nodeIndex=layerData[1],tensorIndex=layerData[2];generic_utils.assert(layerName in createdLayers);var layerOutputTensors=(layer=createdLayers[layerName]).inboundNodes[nodeIndex].outputTensors;inputTensors.push(layerOutputTensors[tensorIndex])}for(var _d=0,outputLayersFromConfig_1=config.outputLayers;_d<outputLayersFromConfig_1.length;_d++){layerName=(layerData=outputLayersFromConfig_1[_d])[0],nodeIndex=layerData[1],tensorIndex=layerData[2];generic_utils.assert(layerName in createdLayers);var layer;layerOutputTensors=(layer=createdLayers[layerName]).inboundNodes[nodeIndex].outputTensors;outputTensors.push(layerOutputTensors[tensorIndex])}return new cls({inputs:inputTensors,outputs:outputTensors,name:name})},Object.defineProperty(Container.prototype,"stateful",{get:function(){if(this._stateful)throw new errors_1.ValueError("Container instance unexpectedly has _stateful = true. The statefulness of a Container is determined by the Layers it contains. Its _stateful property must remain the default false.");for(var _i=0,_a=this.layers;_i<_a.length;_i++){if(_a[_i].stateful)return!0}return!1},enumerable:!0,configurable:!0}),Container.prototype.resetStates=function(){var _this=this;tfjs_core_1.tidy(function(){_this.layers.forEach(function(layer){layer.stateful&&layer.resetStates()})})},Container}(topology_1.Layer);exports.Container=Container},{"../backend/state":275,"../errors":289,"../layers/serialization":312,"../utils/generic_utils":322,"../utils/serialization_utils":325,"../utils/types_utils":326,"../variables":328,"../version":329,"./executor":282,"./input_layer":283,"./topology":284,"@tensorflow/tfjs-core":148}],282:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var tfjs_core_1=require("@tensorflow/tfjs-core"),errors_1=require("../errors"),generic_utils_1=require("../utils/generic_utils"),input_layer_1=require("./input_layer"),topology_1=require("./topology");var FeedDict=function(){function FeedDict(feeds){if(this.id2Value={},this.id2Mask={},this.name2Id={},feeds instanceof FeedDict)for(var id in feeds.id2Value)this.id2Value[id]=feeds.id2Value[id],id in feeds.id2Mask&&(this.id2Mask[id]=feeds.id2Mask[id]);else{if(null==feeds)return;for(var _i=0,feeds_1=feeds;_i<feeds_1.length;_i++){var feed=feeds_1[_i];this.add(feed.key,feed.value)}}}return FeedDict.prototype.add=function(key,value,mask){if(null!=this.id2Value[key.id])throw new errors_1.ValueError("Duplicate key: name="+key.name+", id="+key.id);return this.id2Value[key.id]=function(key,val){if(null==key.dtype||key.dtype===val.dtype)return val;try{return tfjs_core_1.cast(val,key.dtype)}catch(err){throw new errors_1.ValueError("The dtype of the feed ("+val.dtype+") can not be cast to the dtype of the key '"+key.name+"' ("+key.dtype+").")}}(key,value),this.name2Id[key.name]=key.id,null!=mask&&(this.id2Mask[key.id]=mask),this},FeedDict.prototype.addFeed=function(feed){this.add(feed.key,feed.value)},FeedDict.prototype.hasKey=function(key){return null!=this.id2Value[key.id]},FeedDict.prototype.names=function(){return Object.keys(this.name2Id)},FeedDict.prototype.getValue=function(key){if(key instanceof topology_1.SymbolicTensor){if(null==this.id2Value[key.id])throw new errors_1.ValueError("Nonexistent key: "+key.name);return this.id2Value[key.id]}var id=this.name2Id[key];if(null==id)throw new errors_1.ValueError("Feed dict has no SymbolicTensor name: "+key);return this.id2Value[id]},FeedDict.prototype.getMask=function(key){if(key instanceof topology_1.SymbolicTensor){if(null==this.id2Value[key.id])throw new errors_1.ValueError("Nonexistent key: "+key.name);return this.id2Mask[key.id]}var id=this.name2Id[key];if(null==id)throw new errors_1.ValueError("Feed dict has no SymbolicTensor name: "+key);return this.id2Mask[id]},FeedDict.prototype.disposeMasks=function(){null!=this.id2Mask&&tfjs_core_1.dispose(this.id2Mask)},FeedDict}();exports.FeedDict=FeedDict;var cachedSorted={},cachedRecipientCounts={};function getTopologicalSortAndRecipientCountsForOneFetch(fetch,feedDict){for(var visited=new Set,sorted=[],recipientMap={},_i=0,_a=feedDict.names();_i<_a.length;_i++){var key=_a[_i];visited.add(key)}var stack=[],marks=[];for(stack.push(fetch);0<stack.length;){var top_1=stack[stack.length-1];if(visited.has(top_1.name))stack.pop();else{var topIsMarked=marks[marks.length-1]===stack.length-1;if(0===top_1.inputs.length||topIsMarked)stack.pop(),sorted.push(top_1),visited.add(top_1.name),topIsMarked&&marks.pop();else{marks.push(stack.length-1);for(var _b=0,_c=top_1.inputs;_b<_c.length;_b++){var input=_c[_b];null==recipientMap[input.name]&&(recipientMap[input.name]=new Set),recipientMap[input.name].add(top_1.name),visited.has(input.name)||stack.push(input)}}}}return{sorted:sorted,recipientMap:recipientMap}}function getNodeOutputs(fetch){var layerOutputs;if(1===fetch.sourceLayer.inboundNodes.length)layerOutputs=fetch.sourceLayer.output;else{for(var nodeIndex=null,i=0;i<fetch.sourceLayer.inboundNodes.length;++i)for(var _i=0,_a=fetch.sourceLayer.inboundNodes[i].outputTensors;_i<_a.length;_i++){if(_a[_i].id===fetch.id){nodeIndex=i;break}}layerOutputs=fetch.sourceLayer.getOutputAt(nodeIndex)}return layerOutputs}exports.execute=function(fetches,feedDict,kwargs,probe){for(var training=null!=kwargs&&kwargs.training,arrayFetches=Array.isArray(fetches),fetchArray=arrayFetches?fetches:[fetches],outputNames=fetchArray.map(function(t){return t.name}),finalOutputs=[],feedNames=feedDict.names(),_i=0,outputNames_1=outputNames;_i<outputNames_1.length;_i++){var outputName=outputNames_1[_i];-1!==feedNames.indexOf(outputName)?finalOutputs.push(feedDict.getValue(outputName)):finalOutputs.push(null)}null!=probe&&(probe.maxNumTensors=-1/0,probe.minNumTensors=1/0);var sorted,recipientCounts,fetchAndFeedKey=outputNames.join(",")+"|"+feedDict.names().join(",");if(null==cachedSorted[fetchAndFeedKey]){var out=function(fetches,feedDict){tfjs_core_1.util.assert(null!=fetches&&0<fetches.length,function(){return"Expected at least one fetch, got none"});var finalSorted=[],finalRecipientMap={};if(1===fetches.length){var out=getTopologicalSortAndRecipientCountsForOneFetch(fetches[0],feedDict);finalSorted=out.sorted,finalRecipientMap=out.recipientMap}else for(var visited=new Set,_i=0,fetches_1=fetches;_i<fetches_1.length;_i++){for(var _a=getTopologicalSortAndRecipientCountsForOneFetch(fetches_1[_i],feedDict),sorted=_a.sorted,recipientMap=_a.recipientMap,_b=0,sorted_1=sorted;_b<sorted_1.length;_b++){var symbolicTensor=sorted_1[_b];visited.has(symbolicTensor.name)||(finalSorted.push(symbolicTensor),visited.add(symbolicTensor.name))}var _loop_1=function(name_1){null==finalRecipientMap[name_1]&&(finalRecipientMap[name_1]=new Set),recipientMap[name_1].forEach(function(recipient){return finalRecipientMap[name_1].add(recipient)})};for(var name_1 in recipientMap)_loop_1(name_1)}return{sorted:finalSorted,recipientCounts:function(recipientMap){var recipientCounts={};for(var name_2 in recipientMap)recipientCounts[name_2]=recipientMap[name_2].size;return recipientCounts}(finalRecipientMap)}}(fetchArray,feedDict);sorted=out.sorted,recipientCounts=out.recipientCounts,cachedSorted[fetchAndFeedKey]=sorted,cachedRecipientCounts[fetchAndFeedKey]=recipientCounts}sorted=cachedSorted[fetchAndFeedKey],recipientCounts={},training||Object.assign(recipientCounts,cachedRecipientCounts[fetchAndFeedKey]);for(var internalFeedDict=new FeedDict(feedDict),i=0;i<sorted.length;++i){if(null!=probe){var numTensors=tfjs_core_1.memory().numTensors;numTensors>probe.maxNumTensors&&(probe.maxNumTensors=numTensors),numTensors<probe.minNumTensors&&(probe.minNumTensors=numTensors)}var symbolic=sorted[i],srcLayer=symbolic.sourceLayer;if(!(srcLayer instanceof input_layer_1.InputLayer)){for(var inputValues=[],inputMasks=[],tensorsToDispose=[],maskExists=!1,_a=0,_b=symbolic.inputs;_a<_b.length;_a++){var input=_b[_a],value=internalFeedDict.getValue(input),mask=internalFeedDict.getMask(input);inputValues.push(value),inputMasks.push(mask),null!=mask&&(maskExists=!0),training||(recipientCounts[input.name]--,0!==recipientCounts[input.name]||feedDict.hasKey(input)||-1!==outputNames.indexOf(input.name)||value.isDisposed||!0===input.sourceLayer.stateful||tensorsToDispose.push(value))}maskExists&&((kwargs=kwargs||{}).mask=inputMasks[0]);var outputTensors=generic_utils_1.toList(srcLayer.apply(inputValues,kwargs)),outputMask=null;srcLayer.supportsMasking&&(outputMask=srcLayer.computeMask(inputValues,inputMasks));for(var layerOutputs=getNodeOutputs(symbolic),outputSymbolicTensors=Array.isArray(layerOutputs)?layerOutputs:[layerOutputs],i_1=0;i_1<outputSymbolicTensors.length;++i_1){internalFeedDict.hasKey(outputSymbolicTensors[i_1])||internalFeedDict.add(outputSymbolicTensors[i_1],outputTensors[i_1],Array.isArray(outputMask)?outputMask[0]:outputMask);var index=outputNames.indexOf(outputSymbolicTensors[i_1].name);-1!==index&&(finalOutputs[index]=outputTensors[i_1])}training||tfjs_core_1.dispose(tensorsToDispose)}}return internalFeedDict.disposeMasks(),arrayFetches?finalOutputs:finalOutputs[0]},exports.getTopologicalSortAndRecipientCountsForOneFetch=getTopologicalSortAndRecipientCountsForOneFetch},{"../errors":289,"../utils/generic_utils":322,"./input_layer":283,"./topology":284,"@tensorflow/tfjs-core":148}],283:[function(require,module,exports){"use strict";var extendStatics,__extends=this&&this.__extends||(extendStatics=function(d,b){return(extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p])})(d,b)},function(d,b){function __(){this.constructor=d}extendStatics(d,b),d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)});Object.defineProperty(exports,"__esModule",{value:!0});var tfjs_core_1=require("@tensorflow/tfjs-core"),state_1=require("../backend/state"),errors_1=require("../errors"),topology_1=require("./topology"),InputLayer=function(_super){function InputLayer(args){var _this=_super.call(this,{dtype:args.dtype,name:null!=args.name?args.name:state_1.getUid("input").toString()})||this;if(null==args.batchSize&&(args.batchSize=null),null==args.sparse&&(args.sparse=!1),_this.trainable=!1,_this.built=!0,_this.sparse=args.sparse,null!=args.inputShape&&null!=args.batchInputShape)throw new errors_1.ValueError("Only provide the inputShape OR batchInputShape argument to inputLayer, not both at the same time.");var batchInputShape=args.batchInputShape;if(null==batchInputShape){if(null==args.inputShape)throw new errors_1.ValueError("An InputLayer should be passed either a `batchInputShape` or an `inputShape`.");batchInputShape=[args.batchSize].concat(args.inputShape)}else if(null!=args.batchSize)throw new errors_1.ValueError("Cannot specify batchSize if batchInputShape is specified when creating an InputLayer.");var dtype=args.dtype||"float32";_this.batchInputShape=batchInputShape,_this.dtype=dtype,_this.inputSpec=[{shape:batchInputShape}];var inputTensor=new topology_1.SymbolicTensor(_this.dtype,_this.batchInputShape,_this,[],{},_this.name);return inputTensor.nodeIndex=0,inputTensor.tensorIndex=0,new topology_1.Node({outboundLayer:_this,inboundLayers:[],nodeIndices:[],tensorIndices:[],inputTensors:[inputTensor],outputTensors:[inputTensor],inputMasks:[null],outputMasks:[null],inputShapes:[batchInputShape],outputShapes:[batchInputShape]}),_this}return __extends(InputLayer,_super),InputLayer.prototype.apply=function(inputs,kwargs){throw new errors_1.ValueError("Cannot pass any input to an InputLayer's apply() method. InputLayer name: "+this.name)},InputLayer.prototype.dispose=function(){return{refCountAfterDispose:this._refCount,numDisposedVariables:0}},InputLayer.prototype.getConfig=function(){return{batchInputShape:this.batchInputShape,dtype:this.dtype,sparse:this.sparse,name:this.name}},InputLayer.className="InputLayer",InputLayer}(topology_1.Layer);exports.InputLayer=InputLayer,tfjs_core_1.serialization.registerClass(InputLayer),exports.Input=function(config){if(null==config.batchShape&&null==config.shape)throw new Error("Please provide to Input either a `shape` or a `batchShape` argument. Note that `shape` does not include the batch dimension.");if(null!=config.batchShape&&null!=config.shape)throw new errors_1.ValueError("Please provide either a `shape` or `batchShape` argument to Input, but not both.");var batchShape=config.batchShape;null!=config.shape&&null==batchShape&&(batchShape=[null].concat(config.shape));var dtype=config.dtype;return null==dtype&&(dtype="float32"),new InputLayer({batchInputShape:batchShape,name:config.name,dtype:dtype,sparse:config.sparse}).inboundNodes[0].outputTensors[0]}},{"../backend/state":275,"../errors":289,"./topology":284,"@tensorflow/tfjs-core":148}],284:[function(require,module,exports){"use strict";var extendStatics,__extends=this&&this.__extends||(extendStatics=function(d,b){return(extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p])})(d,b)},function(d,b){function __(){this.constructor=d}extendStatics(d,b),d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)});Object.defineProperty(exports,"__esModule",{value:!0});function InputSpec(args){this.dtype=args.dtype,this.shape=args.shape,null!=args.shape?this.ndim=args.shape.length:this.ndim=args.ndim,this.maxNDim=args.maxNDim,this.minNDim=args.minNDim,this.axes=args.axes||{}}var tfjs_core_1=require("@tensorflow/tfjs-core"),state_1=require("../backend/state"),common_1=require("../common"),errors_1=require("../errors"),initializers_1=require("../initializers"),generic_utils=require("../utils/generic_utils"),types_utils=require("../utils/types_utils"),variable_utils=require("../utils/variable_utils"),variables_1=require("../variables");exports.InputSpec=InputSpec;var SymbolicTensor=function(dtype,shape,sourceLayer,inputs,callArgs,name,outputTensorIndex){this.dtype=dtype,this.shape=shape,this.sourceLayer=sourceLayer,this.inputs=inputs,this.callArgs=callArgs,this.outputTensorIndex=outputTensorIndex,this.id=state_1.getNextUniqueTensorId(),null!=name&&(this.originalName=common_1.getScopedTensorName(name),this.name=common_1.getUniqueTensorName(this.originalName)),this.rank=shape.length};exports.SymbolicTensor=SymbolicTensor;var _nextNodeID=0,Node=function(){function Node(args,callArgs){this.callArgs=callArgs,this.id=_nextNodeID++,this.outboundLayer=args.outboundLayer,this.inboundLayers=args.inboundLayers,this.nodeIndices=args.nodeIndices,this.tensorIndices=args.tensorIndices,this.inputTensors=args.inputTensors,this.outputTensors=args.outputTensors,this.inputMasks=args.inputMasks,this.outputMasks=args.outputMasks,this.inputShapes=args.inputShapes,this.outputShapes=args.outputShapes;for(var _i=0,_a=args.inboundLayers;_i<_a.length;_i++){var layer=_a[_i];null!=layer&&layer.outboundNodes.push(this)}args.outboundLayer.inboundNodes.push(this)}return Node.prototype.getConfig=function(){for(var inboundNames=[],_i=0,_a=this.inboundLayers;_i<_a.length;_i++){var layer=_a[_i];null!=layer?inboundNames.push(layer.name):inboundNames.push(null)}return{outboundLayer:this.outboundLayer?this.outboundLayer.name:null,inboundLayers:inboundNames,nodeIndices:this.nodeIndices,tensorIndices:this.tensorIndices}},Node}();exports.Node=Node;var _nextLayerID=0,Layer=function(_super){function Layer(args){var _this=_super.call(this)||this;_this._callHook=null,_this._addedWeightNames=[],_this._stateful=!1,_this.id=_nextLayerID++,_this.activityRegularizer=null,_this.inputSpec=null,_this.supportsMasking=!1,_this._trainableWeights=[],_this._nonTrainableWeights=[],_this._losses=[],_this._updates=[],_this._built=!1,_this.inboundNodes=[],_this.outboundNodes=[];var name=args.name;if(!name){var prefix=_this.getClassName();name=generic_utils.toSnakeCase(prefix)+"_"+state_1.getUid(prefix)}if(_this.name=name,_this.trainable_=null==args.trainable||args.trainable,null!=args.inputShape||null!=args.batchInputShape){var batchInputShape=void 0;if(null!=args.batchInputShape)batchInputShape=args.batchInputShape;else if(null!=args.inputShape){var batchSize=null;null!=args.batchSize&&(batchSize=args.batchSize),batchInputShape=[batchSize].concat(args.inputShape)}_this.batchInputShape=batchInputShape;var dtype=args.dtype;null==dtype&&(dtype=args.inputDType),null==dtype&&(dtype="float32"),_this.dtype=dtype}return null!=args.weights?_this.initialWeights=args.weights:_this.initialWeights=null,_this._refCount=null,_this.fastWeightInitDuringBuild=!1,_this}return __extends(Layer,_super),Layer.nodeKey=function(layer,nodeIndex){return layer.name+"_ib-"+nodeIndex.toString()},Layer.prototype.getNodeAtIndex=function(nodeIndex,attrName){if(0===this.inboundNodes.length)throw new errors_1.RuntimeError("The layer has never been called and thus has no defined "+attrName+".");if(this.inboundNodes.length<=nodeIndex)throw new errors_1.ValueError("Asked to get "+attrName+" at node "+nodeIndex+", but the layer has only "+this.inboundNodes.length+" inbound nodes.");return this.inboundNodes[nodeIndex]},Layer.prototype.getInputAt=function(nodeIndex){return generic_utils.singletonOrArray(this.getNodeAtIndex(nodeIndex,"input").inputTensors)},Layer.prototype.getOutputAt=function(nodeIndex){return generic_utils.singletonOrArray(this.getNodeAtIndex(nodeIndex,"output").outputTensors)},Object.defineProperty(Layer.prototype,"input",{get:function(){if(1<this.inboundNodes.length)throw new errors_1.AttributeError("Layer "+this.name+' has multiple inbound nodes, hence the notion of "layer input" is ill-defined. Use `getInputAt(nodeIndex)` instead.');if(0===this.inboundNodes.length)throw new errors_1.AttributeError("Layer "+this.name+" is not connected, no input to return.");return generic_utils.singletonOrArray(this.getNodeAtIndex(0,"input").inputTensors)},enumerable:!0,configurable:!0}),Object.defineProperty(Layer.prototype,"output",{get:function(){if(0===this.inboundNodes.length)throw new errors_1.AttributeError("Layer "+this.name+" has no inbound nodes.");if(1<this.inboundNodes.length)throw new errors_1.AttributeError("Layer "+this.name+' has multiple inbound nodes, hence the notion of "layer output" is ill-defined. Use `getOutputAt(nodeIndex)` instead.');return generic_utils.singletonOrArray(this.getNodeAtIndex(0,"output").outputTensors)},enumerable:!0,configurable:!0}),Object.defineProperty(Layer.prototype,"losses",{get:function(){return this._losses},enumerable:!0,configurable:!0}),Layer.prototype.calculateLosses=function(){return this.losses.map(function(lossFn){return lossFn()})},Object.defineProperty(Layer.prototype,"updates",{get:function(){return this._updates},enumerable:!0,configurable:!0}),Object.defineProperty(Layer.prototype,"built",{get:function(){return this._built},set:function(built){this._built=built},enumerable:!0,configurable:!0}),Object.defineProperty(Layer.prototype,"trainable",{get:function(){return this.trainable_},set:function(trainable){this._trainableWeights.forEach(function(w){return w.trainable=trainable}),this.trainable_=trainable},enumerable:!0,configurable:!0}),Object.defineProperty(Layer.prototype,"trainableWeights",{get:function(){return this.trainable_?this._trainableWeights.filter(function(w){return w.trainable}):[]},set:function(weights){this._trainableWeights=weights},enumerable:!0,configurable:!0}),Object.defineProperty(Layer.prototype,"nonTrainableWeights",{get:function(){return this.trainable?this._trainableWeights.filter(function(w){return!w.trainable}).concat(this._nonTrainableWeights):this._trainableWeights.concat(this._nonTrainableWeights)},set:function(weights){this._nonTrainableWeights=weights},enumerable:!0,configurable:!0}),Object.defineProperty(Layer.prototype,"weights",{get:function(){return this.trainableWeights.concat(this.nonTrainableWeights)},enumerable:!0,configurable:!0}),Object.defineProperty(Layer.prototype,"stateful",{get:function(){return this._stateful},enumerable:!0,configurable:!0}),Layer.prototype.resetStates=function(){if(!this.stateful)throw new Error("Cannot call the resetStates() method of a non-stateful Layer object.")},Layer.prototype.assertInputCompatibility=function(inputs){if(inputs=generic_utils.toList(inputs),null!=this.inputSpec&&0!==this.inputSpec.length){var inputSpec=generic_utils.toList(this.inputSpec);if(inputs.length!==inputSpec.length)throw new errors_1.ValueError("Layer "+this.name+" expects "+inputSpec.length+" inputs, but it received "+inputs.length+" input tensors. Input received: "+inputs);for(var inputIndex=0;inputIndex<inputs.length;inputIndex++){var x=inputs[inputIndex],spec=inputSpec[inputIndex];if(null!=spec){var ndim=x.rank;if(null!=spec.ndim&&ndim!==spec.ndim)throw new errors_1.ValueError("Input "+inputIndex+" is incompatible with layer "+this.name+": expected ndim="+spec.ndim+", found ndim="+ndim);if(null!=spec.maxNDim&&ndim>spec.maxNDim)throw new errors_1.ValueError("Input "+inputIndex+" is incompatible with layer "+this.name+": expected max_ndim="+spec.maxNDim+", found ndim="+ndim);if(null!=spec.minNDim&&ndim<spec.minNDim)throw new errors_1.ValueError("Input "+inputIndex+" is incompatible with layer "+this.name+": expected min_ndim="+spec.minNDim+", found ndim="+ndim+".");if(null!=spec.dtype&&x.dtype!==spec.dtype)throw new errors_1.ValueError("Input "+inputIndex+" is incompatible with layer "+this.name+" : expected dtype="+spec.dtype+", found dtype="+x.dtype+".");if(spec.axes){var xShape=x.shape;for(var key in spec.axes){var axis=Number(key),value=spec.axes[key],xShapeAtAxis=0<=axis?xShape[axis]:xShape[xShape.length+axis];if(null!=value&&-1===[value,null].indexOf(xShapeAtAxis))throw new errors_1.ValueError("Input "+inputIndex+" is incompatible with layer "+this.name+": expected axis "+axis+" of input shape to have value "+value+" but got shape "+xShape+".")}}if(null!=spec.shape)for(var i=0;i<spec.shape.length;++i){var specDim=spec.shape[i],dim=x.shape[i];if(null!=specDim&&null!=dim&&specDim!==dim)throw new errors_1.ValueError("Input "+inputIndex+" is incompatible with layer "+this.name+": expected shape="+spec.shape+", found shape="+x.shape+".")}}}}},Layer.prototype.call=function(inputs,kwargs){return inputs},Layer.prototype.invokeCallHook=function(inputs,kwargs){null!=this._callHook&&this._callHook(inputs,kwargs)},Layer.prototype.setCallHook=function(callHook){this._callHook=callHook},Layer.prototype.clearCallHook=function(){this._callHook=null},Layer.prototype.apply=function(inputs,kwargs){var _this=this;kwargs=kwargs||{},this.assertNotDisposed();for(var inputsList=generic_utils.toList(inputs),allAreSymbolic=!0,_i=0,inputsList_1=inputsList;_i<inputsList_1.length;_i++){if(!(inputsList_1[_i]instanceof SymbolicTensor)){allAreSymbolic=!1;break}}for(var noneAreSymbolic=!0,_a=0,inputsList_2=inputsList;_a<inputsList_2.length;_a++){if(inputsList_2[_a]instanceof SymbolicTensor){noneAreSymbolic=!1;break}}if(allAreSymbolic===noneAreSymbolic)throw new errors_1.ValueError("Arguments to apply() must be all SymbolicTensors or all Tensors");return common_1.nameScope(this.name,function(){if(!_this.built){_this.assertInputCompatibility(inputs);for(var inputShapes=[],_i=0,_a=generic_utils.toList(inputs);_i<_a.length;_i++){var xElem=_a[_i];inputShapes.push(xElem.shape)}_this.build(generic_utils.singletonOrArray(inputShapes)),_this.built=!0,_this.initialWeights&&_this.setWeights(_this.initialWeights),null===_this._refCount&&noneAreSymbolic&&(_this._refCount=1)}if(_this.assertInputCompatibility(inputs),noneAreSymbolic){for(var output=_this.call(inputs,kwargs),outputListCopy=[],_b=0,outputList_1=generic_utils.toList(output);_b<outputList_1.length;_b++){var x=outputList_1[_b];-1!==inputsList.indexOf(x)&&(x=x.clone()),outputListCopy.push(x)}if(output=generic_utils.singletonOrArray(outputListCopy),null!=_this.activityRegularizer)throw new errors_1.NotImplementedError("Layer invocation in the presence of activity regularizer(s) is not supported yet.");return output}var inputShape=function(inputTensors){inputTensors=generic_utils.toList(inputTensors);for(var shapes=[],_i=0,inputTensors_1=inputTensors;_i<inputTensors_1.length;_i++){var x=inputTensors_1[_i];shapes.push(x.shape)}return generic_utils.singletonOrArray(shapes)}(inputs),outputShape=_this.computeOutputShape(inputShape);output=void 0;if(_this.warnOnIncompatibleInputShape(Array.isArray(inputs)?inputShape[0]:inputShape),output=null!=outputShape&&0<outputShape.length&&Array.isArray(outputShape[0])?outputShape.map(function(shape,index){return new SymbolicTensor("float32",shape,_this,generic_utils.toList(inputs),kwargs,_this.name,index)}):new SymbolicTensor("float32",outputShape,_this,generic_utils.toList(inputs),kwargs,_this.name),_this.addInboundNode(inputs,output,null,null,inputShape,outputShape,kwargs),_this._refCount++,null!=_this.activityRegularizer)throw new errors_1.NotImplementedError("Layer invocation in the presence of activity regularizer(s) is not supported yet.");return output})},Layer.prototype.warnOnIncompatibleInputShape=function(inputShape){if(null!=this.batchInputShape)if(inputShape.length!==this.batchInputShape.length)console.warn("The rank of the input tensor provided (shape: "+JSON.stringify(inputShape)+") does not match that of the batchInputShape ("+JSON.stringify(this.batchInputShape)+") of the layer "+this.name);else{var dimMismatch_1=!1;this.batchInputShape.forEach(function(dimension,i){null!=dimension&&null!=inputShape[i]&&inputShape[i]!==dimension&&(dimMismatch_1=!0)}),dimMismatch_1&&console.warn("The shape of the input tensor ("+JSON.stringify(inputShape)+") does not match the expectation of layer "+this.name+": "+JSON.stringify(this.batchInputShape))}},Object.defineProperty(Layer.prototype,"outputShape",{get:function(){if(null==this.inboundNodes||0===this.inboundNodes.length)throw new errors_1.AttributeError("The layer "+this.name+" has never been called and thus has no defined output shape.");for(var allOutputShapes=[],_i=0,_a=this.inboundNodes;_i<_a.length;_i++){var node=_a[_i],shapeString=JSON.stringify(node.outputShapes);-1===allOutputShapes.indexOf(shapeString)&&allOutputShapes.push(shapeString)}if(1!==allOutputShapes.length)throw new errors_1.AttributeError("The layer "+this.name+' has multiple inbound nodes with different output shapes. Hence the notion of "outut shape" is ill-defined for the layer.');var outputShapes=this.inboundNodes[0].outputShapes;return Array.isArray(outputShapes)&&Array.isArray(outputShapes[0])&&1===outputShapes.length?outputShapes[0]:outputShapes},enumerable:!0,configurable:!0}),Layer.prototype.countParams=function(){if(!this.built)throw new errors_1.RuntimeError("You tried to call countParams() on "+this.name+", but the layer is not built yet. Build it first by calling build(batchInputShape).");return variable_utils.countParamsInWeights(this.weights)},Layer.prototype.build=function(inputShape){this.built=!0},Layer.prototype.getWeights=function(trainableOnly){return void 0===trainableOnly&&(trainableOnly=!1),variables_1.batchGetValue(trainableOnly?this.trainableWeights:this.weights)},Layer.prototype.setWeights=function(weights){var _this=this;tfjs_core_1.tidy(function(){var params=_this.weights;if(params.length!==weights.length)throw new errors_1.ValueError('You called setWeights(weights) on layer "'+_this.name+'" with a weight list of length '+weights.length+", but the layer was expecting "+params.length+" weights. Provided weights: "+weights+"...");if(0!==params.length){for(var weightValueTuples=[],paramValues=variables_1.batchGetValue(params),i=0;i<paramValues.length;++i){var pv=paramValues[i],p=params[i],w=weights[i];if(!tfjs_core_1.util.arraysEqual(pv.shape,w.shape))throw new errors_1.ValueError("Layer weight shape "+pv.shape+" not compatible with provided weight shape "+w.shape);weightValueTuples.push([p,w])}variables_1.batchSetValue(weightValueTuples)}})},Layer.prototype.addWeight=function(name,shape,dtype,initializer,regularizer,trainable,constraint){if(-1!==this._addedWeightNames.indexOf(name))throw new errors_1.ValueError("Duplicate weight name "+name+" for layer "+this.name);this._addedWeightNames.push(name),null==dtype&&(dtype="float32"),this.fastWeightInitDuringBuild&&(initializer=initializers_1.getInitializer("zeros"));var initValue=initializer.apply(shape,dtype),weight=new variables_1.LayerVariable(initValue,dtype,name,trainable,constraint);return initValue.dispose(),null!=regularizer&&this.addLoss(function(){return regularizer.apply(weight.read())}),null==trainable&&(trainable=!0),trainable?this._trainableWeights.push(weight):this._nonTrainableWeights.push(weight),weight},Layer.prototype.setFastWeightInitDuringBuild=function(value){this.fastWeightInitDuringBuild=value},Layer.prototype.addLoss=function(losses){var _a;null==losses||Array.isArray(losses)&&0===losses.length||(losses=generic_utils.toList(losses),void 0!==this._losses&&null!==this._losses&&(_a=this.losses).push.apply(_a,losses))},Layer.prototype.computeOutputShape=function(inputShape){return inputShape},Layer.prototype.computeMask=function(inputs,mask){var _this=this;if(this.supportsMasking)return mask;if(null!=mask){if(!Array.isArray(mask))throw new TypeError("Layer "+this.name+" does not support masking, but was passed an inputMask.");mask.forEach(function(maskElement){if(null!=maskElement)throw new TypeError("Layer "+_this.name+" does not support masking, but was passed an inputMask.")})}return null},Layer.prototype.addInboundNode=function(inputTensors,outputTensors,inputMasks,outputMasks,inputShapes,outputShapes,kwargs){void 0===kwargs&&(kwargs=null);var inputTensorList=generic_utils.toList(inputTensors);outputTensors=generic_utils.toList(outputTensors),inputMasks=generic_utils.toList(inputMasks),outputMasks=generic_utils.toList(outputMasks),inputShapes=types_utils.normalizeShapeList(inputShapes),outputShapes=types_utils.normalizeShapeList(outputShapes);for(var inboundLayers=[],nodeIndices=[],tensorIndices=[],_i=0,inputTensorList_1=inputTensorList;_i<inputTensorList_1.length;_i++){var x=inputTensorList_1[_i];inboundLayers.push(x.sourceLayer),nodeIndices.push(x.nodeIndex),tensorIndices.push(x.tensorIndex)}new Node({outboundLayer:this,inboundLayers:inboundLayers,nodeIndices:nodeIndices,tensorIndices:tensorIndices,inputTensors:inputTensorList,outputTensors:outputTensors,inputMasks:inputMasks,outputMasks:outputMasks,inputShapes:inputShapes,outputShapes:outputShapes},kwargs);for(var i=0;i<outputTensors.length;i++)outputTensors[i].sourceLayer=this,outputTensors[i].nodeIndex=this.inboundNodes.length-1,outputTensors[i].tensorIndex=i},Layer.prototype.getConfig=function(){var config={name:this.name,trainable:this.trainable};return null!=this.batchInputShape&&(config.batchInputShape=this.batchInputShape),null!=this.dtype&&(config.dtype=this.dtype),config},Layer.prototype.disposeWeights=function(){return this.weights.forEach(function(weight){return weight.dispose()}),this.weights.length},Layer.prototype.assertNotDisposed=function(){if(0===this._refCount)throw new Error("Layer '"+this.name+"' is already disposed.")},Layer.prototype.dispose=function(){if(!this.built)throw new Error("Cannot dispose Layer "+this.name+" because it has not been built yet.");if(null===this._refCount)throw new Error("Cannot dispose Layer "+this.name+" because it has not been used yet.");this.assertNotDisposed();var numDisposedVariables=0;return 0==--this._refCount&&(numDisposedVariables=this.disposeWeights()),{refCountAfterDispose:this._refCount,numDisposedVariables:numDisposedVariables}},Layer}(tfjs_core_1.serialization.Serializable);exports.Layer=Layer,exports.getSourceInputs=function getSourceInputs(tensor,layer,nodeIndex){if((null==layer||null!=nodeIndex&&0<nodeIndex)&&(layer=tensor.sourceLayer,nodeIndex=tensor.nodeIndex),0===layer.inboundNodes.length)return[tensor];var node=layer.inboundNodes[nodeIndex];if(0===node.inboundLayers.length)return node.inputTensors;for(var sourceTensors=[],i=0;i<node.inboundLayers.length;i++)for(var _i=0,previousSources_1=getSourceInputs(node.inputTensors[i],node.inboundLayers[i],node.nodeIndices[i]);_i<previousSources_1.length;_i++){var x_1=previousSources_1[_i];-1===sourceTensors.indexOf(x_1)&&sourceTensors.push(x_1)}return sourceTensors}},{"../backend/state":275,"../common":279,"../errors":289,"../initializers":298,"../utils/generic_utils":322,"../utils/types_utils":326,"../utils/variable_utils":327,"../variables":328,"@tensorflow/tfjs-core":148}],285:[function(require,module,exports){"use strict";var extendStatics,__extends=this&&this.__extends||(extendStatics=function(d,b){return(extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p])})(d,b)},function(d,b){function __(){this.constructor=d}extendStatics(d,b),d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)}),__awaiter=this&&this.__awaiter||function(thisArg,_arguments,P,generator){return new(P=P||Promise)(function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){result.done?resolve(result.value):new P(function(resolve){resolve(result.value)}).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())})},__generator=this&&this.__generator||function(thisArg,body){var f,y,t,g,_={label:0,sent:function(){if(1&t[0])throw t[1];return t[1]},trys:[],ops:[]};return g={next:verb(0),throw:verb(1),return:verb(2)},"function"==typeof Symbol&&(g[Symbol.iterator]=function(){return this}),g;function verb(n){return function(v){return function(op){if(f)throw new TypeError("Generator is already executing.");for(;_;)try{if(f=1,y&&(t=2&op[0]?y.return:op[0]?y.throw||((t=y.return)&&t.call(y),0):y.next)&&!(t=t.call(y,op[1])).done)return t;switch(y=0,t&&(op=[2&op[0],t.value]),op[0]){case 0:case 1:t=op;break;case 4:return _.label++,{value:op[1],done:!1};case 5:_.label++,y=op[1],op=[0];continue;case 7:op=_.ops.pop(),_.trys.pop();continue;default:if(!(t=0<(t=_.trys).length&&t[t.length-1])&&(6===op[0]||2===op[0])){_=0;continue}if(3===op[0]&&(!t||op[1]>t[0]&&op[1]<t[3])){_.label=op[1];break}if(6===op[0]&&_.label<t[1]){_.label=t[1],t=op;break}if(t&&_.label<t[2]){_.label=t[2],_.ops.push(op);break}t[2]&&_.ops.pop(),_.trys.pop();continue}op=body.call(thisArg,_)}catch(e){op=[6,e],y=0}finally{f=t=0}if(5&op[0])throw op[1];return{value:op[0]?op[1]:void 0,done:!0}}([n,v])}}};Object.defineProperty(exports,"__esModule",{value:!0});var tfc=require("@tensorflow/tfjs-core"),tfjs_core_1=require("@tensorflow/tfjs-core"),K=require("../backend/tfjs_backend"),common_1=require("../common"),errors_1=require("../errors"),serialization_1=require("../layers/serialization"),losses=require("../losses"),Metrics=require("../metrics"),optimizers=require("../optimizers"),user_defined_metadata_1=require("../user_defined_metadata"),generic_utils_1=require("../utils/generic_utils"),layer_utils_1=require("../utils/layer_utils"),math_utils_1=require("../utils/math_utils"),serialization_utils_1=require("../utils/serialization_utils"),version_1=require("../version"),container_1=require("./container"),executor_1=require("./executor"),training_dataset_1=require("./training_dataset"),training_tensors_1=require("./training_tensors"),training_utils_1=require("./training_utils");function isDataTensor(x){return x instanceof tfjs_core_1.Tensor}function isDataArray(x){return Array.isArray(x)}function isDataDict(x){return!isDataTensor(x)&&!isDataArray(x)}function standardizeInputData(data,names,shapes,checkBatchAxis,exceptionPrefix){if(void 0===checkBatchAxis&&(checkBatchAxis=!0),void 0===exceptionPrefix&&(exceptionPrefix=""),null==names||0===names.length){if(null!=data){var gotUnexpectedData=!1;if(isDataArray(data)&&0<data.length)gotUnexpectedData=!0;else if(isDataDict(data)){for(var key in data)if(data.hasOwnProperty(key)){gotUnexpectedData=!0;break}}else gotUnexpectedData=!0;if(gotUnexpectedData)throw new errors_1.ValueError("Error when checking model "+exceptionPrefix+" expected no data, but got "+data)}return[]}if(null==data)return names.map(function(name){return null});var arrays;if(isDataDict(data)){data=data,arrays=[];for(var _i=0,names_1=names;_i<names_1.length;_i++){var name_1=names_1[_i];if(null==data[name_1])throw new errors_1.ValueError('No data provided for "'+name_1+'". Need data for each key in: '+names);arrays.push(data[name_1])}}else if(isDataArray(data)){if((data=data).length!==names.length)throw new errors_1.ValueError("Error when checking model "+exceptionPrefix+": the Array of Tensors that you are passing to your model is not the size the model expected. Expected to see "+names.length+" Tensor(s), but instead got the following list of Tensor(s): "+data);arrays=data}else{if(data=data,1<names.length)throw new errors_1.ValueError("The model "+exceptionPrefix+" expects "+names.length+" Tensor(s), but only received one Tensor. Found: Tensor with shape "+data.shape);arrays=[data]}if(arrays=training_tensors_1.ensureTensorsRank2OrHigher(arrays),null!=shapes)for(var i=0;i<names.length;++i)if(null!=shapes[i]){var array=arrays[i];if(array.shape.length!==shapes[i].length)throw new errors_1.ValueError("Error when checking "+exceptionPrefix+": expected "+names[i]+" to have "+shapes[i].length+" dimension(s). but got array with shape "+array.shape);for(var j=0;j<shapes[i].length;++j)if(0!==j||checkBatchAxis){var dim=array.shape[j],refDim=shapes[i][j];if(null!=refDim&&0<=refDim&&dim!==refDim)throw new errors_1.ValueError("Error when checking "+exceptionPrefix+": expected "+names[i]+" to have shape ["+shapes[i]+"], but got array with shape ["+array.shape+"].")}}return arrays}function checkArrayLengths(inputs,targets,weights){var setX=generic_utils_1.unique(inputs.map(function(input){return input.shape[0]}));setX.sort();var setY=generic_utils_1.unique(targets.map(function(target){return target.shape[0]}));if(setY.sort(),1<setX.length)throw new errors_1.ValueError("All input Tensors (x) should have the same number of samples. Got array shapes: "+JSON.stringify(inputs.map(function(input){return input.shape})));if(1<setY.length)throw new errors_1.ValueError("All target Tensors (y) should have the same number of samples. Got array shapes: "+JSON.stringify(targets.map(function(target){return target.shape})));if(0<setX.length&&0<setY.length&&!tfjs_core_1.util.arraysEqual(setX,setY))throw new errors_1.ValueError("Input Tensors should have the same number of samples as target Tensors. Found "+setX[0]+" input sample(s) and "+setY[0]+" target sample(s).")}function checkInputData(data,names,shapes,checkBatchAxis,exceptionPrefix){var arrays;if(void 0===checkBatchAxis&&(checkBatchAxis=!0),void 0===exceptionPrefix&&(exceptionPrefix=""),Array.isArray(data)){if(data.length!==names.length)throw new errors_1.ValueError("Error when checking model "+exceptionPrefix+": the Array of Tensors that you are passing to your model is not the size the the model expected. Expected to see "+names.length+" Tensor(s), but instead got "+data.length+" Tensors(s).");arrays=data}else{if(1<names.length)throw new errors_1.ValueError("The model expects "+names.length+" "+exceptionPrefix+" Tensors, but only received one Tensor. Found: array with shape "+JSON.stringify(data.shape)+".");arrays=[data]}if(null!=shapes)for(var i=0;i<names.length;++i)if(null!=shapes[i]){var array=arrays[i];if(array.shape.length!==shapes[i].length)throw new errors_1.ValueError("Error when checking "+exceptionPrefix+": expected "+names[i]+" to have "+shapes[i].length+" dimension(s), but got array with shape "+JSON.stringify(array.shape));for(var j=0;j<shapes[i].length;++j)if(0!==j||checkBatchAxis){var dim=array.shape[j],refDim=shapes[i][j];if(null!=refDim&&refDim!==dim)throw new errors_1.ValueError("Error when checking "+exceptionPrefix+": expected "+names[i]+" to have shape "+JSON.stringify(shapes[i])+" but got array with shape "+JSON.stringify(array.shape)+".")}}}function collectMetrics(metrics,outputNames){if(null==metrics||Array.isArray(metrics)&&0===metrics.length)return outputNames.map(function(name){return[]});var wrappedMetrics;if("string"==typeof metrics||"function"==typeof metrics)wrappedMetrics=[metrics];else{if(!Array.isArray(metrics)&&"object"!=typeof metrics)throw new TypeError("Type of metrics argument not understood. Expected an string,function, Array, or Object, found: "+metrics);wrappedMetrics=metrics}if(Array.isArray(wrappedMetrics))return outputNames.map(function(name){return wrappedMetrics});for(var nestedMetrics=[],_i=0,outputNames_1=outputNames;_i<outputNames_1.length;_i++){var name_2=outputNames_1[_i],outputMetrics=wrappedMetrics.hasOwnProperty(name_2)?wrappedMetrics[name_2]:[];Array.isArray(outputMetrics)||(outputMetrics=[outputMetrics]),nestedMetrics.push(outputMetrics)}return nestedMetrics}exports.isDataTensor=isDataTensor,exports.isDataArray=isDataArray,exports.isDataDict=isDataDict,exports.standardizeInputData=standardizeInputData,exports.checkArrayLengths=checkArrayLengths,exports.collectMetrics=collectMetrics;var LayersModel=function(_super){function LayersModel(args){var _this=_super.call(this,args)||this;return _this.isTraining=!1,_this}return __extends(LayersModel,_super),LayersModel.prototype.summary=function(lineLength,positions,printFn){if(void 0===printFn&&(printFn=console.log),!this.built)throw new errors_1.ValueError("This model has never been called, thus its weights have not been created yet. So no summary can be displayed. Build the model first (e.g., by calling it on some test data).");layer_utils_1.printSummary(this,lineLength,positions,printFn)},LayersModel.prototype.compile=function(args){var _this=this;if(null==args.loss&&(args.loss=[]),this.loss=args.loss,"string"==typeof args.optimizer)this.optimizer_=optimizers.getOptimizer(args.optimizer),this.isOptimizerOwned=!0;else{if(!(args.optimizer instanceof tfjs_core_1.Optimizer))throw new errors_1.ValueError("User-defined optimizer must be an instance of tf.Optimizer.");this.optimizer_=args.optimizer,this.isOptimizerOwned=!1}var lossFunctions=[];if(Array.isArray(args.loss)||"string"==typeof args.loss||"function"==typeof args.loss)if(Array.isArray(args.loss)){if(args.loss.length!==this.outputs.length)throw new errors_1.ValueError("When passing an Array as loss, it should have one entry per model output. The model has "+this.outputs.length+" output(s), but you passed loss="+args.loss+".");var theLosses=args.loss;lossFunctions=theLosses.map(function(l){return losses.get(l)})}else{var lossFunction_1=losses.get(args.loss);this.outputs.forEach(function(_){lossFunctions.push(lossFunction_1)})}else{for(var name_3 in args.loss=args.loss,args.loss)if(-1===this.outputNames.indexOf(name_3))throw new errors_1.ValueError('Unknown entry in loss dictionary: "'+name_3+'". Only expected the following keys: '+this.outputNames);for(var _i=0,_a=this.outputNames;_i<_a.length;_i++){var name_4=_a[_i];null==args.loss[name_4]&&console.warn('Output "'+name_4+'" is missing from loss dictionary. We assume this was done on purpose, and we will not be expecting data to be passed to '+name_4+" during training"),lossFunctions.push(losses.get(args.loss[name_4]))}}this.lossFunctions=lossFunctions,this.feedOutputNames=[],this.feedOutputShapes=[],this.feedLossFns=[];for(var i=0;i<this.outputs.length;++i){var shape=this.internalOutputShapes[i],name_5=this.outputNames[i];this.feedOutputNames.push(name_5),this.feedOutputShapes.push(shape),this.feedLossFns.push(this.lossFunctions[i])}var skipTargetIndices=[];this.metrics=args.metrics,this.metricsNames=["loss"],this.metricsTensors=[],common_1.nameScope("loss",function(){for(var i=0;i<_this.outputs.length;++i)if(-1===skipTargetIndices.indexOf(i)){var weightedLoss=_this.lossFunctions[i];1<_this.outputs.length&&(_this.metricsTensors.push([weightedLoss,i]),_this.metricsNames.push(_this.outputNames[i]+"_loss"))}});var nestedMetrics=collectMetrics(args.metrics,this.outputNames);common_1.nameScope("metric",function(){for(var _loop_1=function(i){if(-1!==skipTargetIndices.indexOf(i))return"continue";!function(metrics){for(var metricName,accFn,weightedMetricFn,_loop_2=function(metric){if("string"==typeof metric&&-1!==["accuracy","acc","crossentropy","ce"].indexOf(metric)){var outputShape=_this.internalOutputShapes[i];1===outputShape[outputShape.length-1]||_this.lossFunctions[i]===losses.binaryCrossentropy?-1!==["accuracy","acc"].indexOf(metric)?accFn=Metrics.binaryAccuracy:-1!==["crossentropy","ce"].indexOf(metric)&&(accFn=Metrics.binaryCrossentropy):_this.lossFunctions[i]===losses.sparseCategoricalCrossentropy?-1!==["accuracy","acc"].indexOf(metric)?accFn=Metrics.sparseCategoricalAccuracy:-1!==["crossentropy","ce"].indexOf(metric)&&(accFn=Metrics.sparseCategoricalCrossentropy):-1!==["accuracy","acc"].indexOf(metric)?accFn=Metrics.categoricalAccuracy:-1!==["crossentropy","ce"].indexOf(metric)&&(accFn=Metrics.categoricalCrossentropy);var suffix=void 0;-1!==["accuracy","acc"].indexOf(metric)?suffix="acc":-1!==["crossentropy","ce"].indexOf(metric)&&(suffix="ce"),weightedMetricFn=accFn,metricName=""+suffix}else{var metricFn=Metrics.get(metric);weightedMetricFn=metricFn,metricName=""+Metrics.getLossOrMetricName(metric)}var metricResult;common_1.nameScope(metricName,function(){metricResult=weightedMetricFn}),function(outputIndex,metricName,metricTensor){1<_this.outputNames.length&&(metricName=_this.outputNames[outputIndex]+"_"+metricName),_this.metricsNames.push(metricName),_this.metricsTensors.push([metricTensor,outputIndex])}(i,metricName,metricResult)},_i=0,metrics_1=metrics;_i<metrics_1.length;_i++){_loop_2(metrics_1[_i])}}(nestedMetrics[i])},i=0;i<_this.outputs.length;++i)_loop_1(i)}),this.collectedTrainableWeights=this.trainableWeights},LayersModel.prototype.checkTrainableWeightsConsistency=function(){null!=this.collectedTrainableWeights&&this.trainableWeights.length!==this.collectedTrainableWeights.length&&console.warn("Discrepancy between trainableweights and collected trainable weights. Did you set `model.trainable` without calling `model.compile()` afterwards?")},LayersModel.prototype.evaluate=function(x,y,args){void 0===args&&(args={});var batchSize=null==args.batchSize?32:args.batchSize;training_tensors_1.checkBatchSize(batchSize);var standardizedOuts=this.standardizeUserDataXY(x,y,!0,batchSize);try{var ins=standardizedOuts[0].concat(standardizedOuts[1]);this.makeTestFunction();var f=this.testFunction,testOuts=this.testLoop(f,ins,batchSize,args.verbose,args.steps);return generic_utils_1.singletonOrArray(testOuts)}finally{training_tensors_1.disposeNewTensors(standardizedOuts[0],x),training_tensors_1.disposeNewTensors(standardizedOuts[1],y)}},LayersModel.prototype.evaluateDataset=function(dataset,args){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(_a){return this.makeTestFunction(),[2,training_dataset_1.evaluateDataset(this,dataset,args)]})})},LayersModel.prototype.checkNumSamples=function(ins,batchSize,steps,stepsName){var numSamples;if(void 0===stepsName&&(stepsName="steps"),null!=steps){if((numSamples=null)!=batchSize)throw new errors_1.ValueError("If "+stepsName+" is set, batchSize must be null or undefined.Got batchSize = "+batchSize)}else{if(null==ins)throw new errors_1.ValueError("Either the input data should have a defined shape, or "+stepsName+" shoud be specified.");numSamples=Array.isArray(ins)?ins[0].shape[0]:ins.shape[0]}return numSamples},LayersModel.prototype.execute=function(inputs,outputs){if(Array.isArray(outputs)&&0===outputs.length)throw new errors_1.ValueError("`outputs` is an empty Array, which is not allowed.");var outputsIsArray=Array.isArray(outputs),outputNames=outputsIsArray?outputs:[outputs],outputSymbolicTensors=this.retrieveSymbolicTensors(outputNames),feedDict=new executor_1.FeedDict;if(inputs instanceof tfjs_core_1.Tensor&&(inputs=[inputs]),Array.isArray(inputs)){if(inputs.length!==this.inputs.length)throw new errors_1.ValueError("The number of inputs provided ("+inputs.length+") does not match the number of inputs of this model ("+this.inputs.length+").");for(var i=0;i<this.inputs.length;++i)feedDict.add(this.inputs[i],inputs[i])}else for(var _i=0,_a=this.inputs;_i<_a.length;_i++){var input=_a[_i],tensorValue=inputs[input.name];if(null==tensorValue)throw new errors_1.ValueError("No value is provided for the model's input "+input.name);feedDict.add(input,tensorValue)}var executeOutputs=executor_1.execute(outputSymbolicTensors,feedDict);return outputsIsArray?executeOutputs:executeOutputs[0]},LayersModel.prototype.retrieveSymbolicTensors=function(symbolicTensorNames){for(var outputSymbolicTensors=generic_utils_1.pyListRepeat(null,symbolicTensorNames.length),outputsRemaining=symbolicTensorNames.length,_i=0,_a=this.layers;_i<_a.length;_i++){for(var layer=_a[_i],layerOutputs=Array.isArray(layer.output)?layer.output:[layer.output],layerOutputNames=layerOutputs.map(function(output){return output.name}),i=0;i<symbolicTensorNames.length;++i){var index=layerOutputNames.indexOf(symbolicTensorNames[i]);if(-1!==index&&(outputSymbolicTensors[i]=layerOutputs[index],outputsRemaining--),0===outputsRemaining)break}if(0===outputsRemaining)break}if(0<outputsRemaining){var remainingNames_1=[];throw outputSymbolicTensors.forEach(function(tensor,i){null==tensor&&remainingNames_1.push(symbolicTensorNames[i])}),new errors_1.ValueError("Cannot find SymbolicTensors for output name(s): "+JSON.stringify(remainingNames_1))}return outputSymbolicTensors},LayersModel.prototype.predictLoop=function(ins,batchSize,verbose){var _this=this;return void 0===batchSize&&(batchSize=32),void 0===verbose&&(verbose=!1),tfc.tidy(function(){var numSamples=_this.checkNumSamples(ins);if(verbose)throw new errors_1.NotImplementedError("Verbose predictLoop() is not implemented yet.");for(var batches=training_tensors_1.makeBatches(numSamples,batchSize),outsBatches=_this.outputs.map(function(output){return[]}),_loop_3=function(batchIndex){tfc.tidy(function(){var batchStart=batches[batchIndex][0],batchEnd=batches[batchIndex][1],insBatch=training_tensors_1.sliceArrays(ins,batchStart,batchEnd),feeds=[];if(Array.isArray(insBatch))for(var i=0;i<insBatch.length;++i)feeds.push({key:_this.inputs[i],value:insBatch[i]});else feeds.push({key:_this.inputs[0],value:insBatch});var feedDict=new executor_1.FeedDict(feeds);return executor_1.execute(_this.outputs,feedDict)}).forEach(function(batchOut,i){return outsBatches[i].push(batchOut)})},batchIndex=0;batchIndex<batches.length;++batchIndex)_loop_3(batchIndex);return generic_utils_1.singletonOrArray(outsBatches.map(function(batches){return tfc.concat(batches,0)}))})},LayersModel.prototype.predict=function(x,args){void 0===args&&(args={});var xsRank2OrHigher=training_tensors_1.ensureTensorsRank2OrHigher(x);checkInputData(xsRank2OrHigher,this.inputNames,this.feedInputShapes,!1);try{var batchSize=null==args.batchSize?32:args.batchSize;return training_tensors_1.checkBatchSize(batchSize),this.predictLoop(xsRank2OrHigher,batchSize)}finally{training_tensors_1.disposeNewTensors(xsRank2OrHigher,x)}},LayersModel.prototype.predictOnBatch=function(x){checkInputData(x,this.inputNames,this.feedInputShapes,!0);var batchSize=(Array.isArray(x)?x[0]:x).shape[0];return this.predictLoop(x,batchSize)},LayersModel.prototype.standardizeUserDataXY=function(x,y,checkBatchAxis,batchSize){if(void 0===checkBatchAxis&&(checkBatchAxis=!0),null==this.optimizer_)throw new errors_1.RuntimeError("You must compile a model before training/testing. Use LayersModel.compile(modelCompileArgs).");for(var outputShapes=[],i=0;i<this.feedOutputShapes.length;++i){var outputShape=this.feedOutputShapes[i];this.feedLossFns[i]===losses.sparseCategoricalCrossentropy?outputShapes.push(outputShape.slice(0,outputShape.length-1).concat([1])):outputShapes.push(outputShape)}if(checkArrayLengths(x=standardizeInputData(x,this.feedInputNames,this.feedInputShapes,!1,"input"),y=standardizeInputData(y,this.feedOutputNames,outputShapes,!1,"target")),function(targets,lossFns,outputShapes){for(var keyLosses=[losses.meanSquaredError,losses.binaryCrossentropy,losses.categoricalCrossentropy],i=0;i<targets.length;++i){var y=targets[i],loss=lossFns[i],shape=outputShapes[i];if(null!=loss){if(loss===losses.categoricalCrossentropy&&1===y.shape[y.shape.length-1])throw new errors_1.ValueError("You are passing a target array of shape "+y.shape+" while using a loss 'categorical_crossentropy'. 'categorical_crossentropy'expects targets to be binary matrices (1s and 0s) of shape [samples, classes].");if(-1!==keyLosses.indexOf(loss))for(var slicedYShape=y.shape.slice(1),slicedShape=shape.slice(1),j=0;j<slicedYShape.length;++j){var targetDim=slicedYShape[j],outDim=slicedShape[j];if(null!=outDim&&targetDim!==outDim)throw new errors_1.ValueError("A target Tensor with shape "+y.shape+" was passed for an output of shape "+shape+", while using a loss function that expects targets to have the same shape as the output.")}}}}(y,this.feedLossFns,this.feedOutputShapes),this.stateful&&null!=batchSize&&0<batchSize&&x[0].shape[0]%batchSize!=0)throw new errors_1.ValueError("In a stateful network, you should only pass inputs with a number of samples that is divisible by the batch size "+batchSize+". Found: "+x[0].shape[0]+" sample(s).");return[x,y]},LayersModel.prototype.standardizeUserData=function(x,y,sampleWeight,classWeight,checkBatchAxis,batchSize){return void 0===checkBatchAxis&&(checkBatchAxis=!0),__awaiter(this,void 0,void 0,function(){var _a,standardXs,standardYs,standardSampleWeights,classWeights,i,_b,_c;return __generator(this,function(_d){switch(_d.label){case 0:if(_a=this.standardizeUserDataXY(x,y,checkBatchAxis,batchSize),standardXs=_a[0],standardYs=_a[1],null!=sampleWeight)throw new Error("sample weight is not supported yet.");if((standardSampleWeights=null)==classWeight)return[3,4];classWeights=training_utils_1.standardizeClassWeights(classWeight,this.outputNames),standardSampleWeights=[],i=0,_d.label=1;case 1:return i<classWeights.length?(_c=(_b=standardSampleWeights).push,[4,training_utils_1.standardizeWeights(standardYs[i],null,classWeights[i])]):[3,4];case 2:_c.apply(_b,[_d.sent()]),_d.label=3;case 3:return++i,[3,1];case 4:return[2,[standardXs,standardYs,standardSampleWeights]]}})})},LayersModel.prototype.testLoop=function(f,ins,batchSize,verbose,steps){var _this=this;return void 0===verbose&&(verbose=0),tfc.tidy(function(){var numSamples=_this.checkNumSamples(ins,batchSize,steps,"steps"),outs=[];if(0<verbose)throw new errors_1.NotImplementedError("Verbose mode is not implemented yet.");if(null!=steps)throw new errors_1.NotImplementedError("steps mode in testLoop() is not implemented yet");for(var batches=training_tensors_1.makeBatches(numSamples,batchSize),indexArray=tfjs_core_1.tensor1d(math_utils_1.range(0,numSamples)),batchIndex=0;batchIndex<batches.length;++batchIndex){var batchStart=batches[batchIndex][0],batchEnd=batches[batchIndex][1],batchIds=K.sliceAlongFirstAxis(indexArray,batchStart,batchEnd-batchStart),insBatch=training_tensors_1.sliceArraysByIndices(ins,batchIds),batchOuts=f(insBatch);if(0===batchIndex)for(var i=0;i<batchOuts.length;++i)outs.push(tfjs_core_1.scalar(0));for(i=0;i<batchOuts.length;++i){var batchOut=batchOuts[i];outs[i]=tfc.add(outs[i],tfc.mul(batchEnd-batchStart,batchOut))}}for(i=0;i<outs.length;++i)outs[i]=tfc.div(outs[i],numSamples);return outs})},LayersModel.prototype.getDedupedMetricsNames=function(){for(var outLabels=this.metricsNames,dedupedOutLabels=[],i=0;i<outLabels.length;++i){var label=outLabels[i],newLabel=label;if(1<generic_utils_1.count(outLabels,label))newLabel+="_"+generic_utils_1.count(outLabels.slice(0,i),label);dedupedOutLabels.push(newLabel)}return dedupedOutLabels},LayersModel.prototype.makeTrainFunction=function(){var _this=this;return function(data){var lossValues=[],inputs=data.slice(0,_this.inputs.length),targets=data.slice(_this.inputs.length,_this.inputs.length+_this.outputs.length),sampleWeights=data.slice(_this.inputs.length+_this.outputs.length,_this.inputs.length+2*_this.outputs.length),metricsValues=[],variables=_this.collectedTrainableWeights.map(function(param){return param.read()});return[_this.optimizer_.minimize(function(){for(var feeds=[],i=0;i<_this.inputs.length;++i)feeds.push({key:_this.inputs[i],value:inputs[i]});var totalLoss,feedDict=new executor_1.FeedDict(feeds),outputs=executor_1.execute(_this.outputs,feedDict,{training:!0});for(i=0;i<_this.lossFunctions.length;++i){var loss=(0,_this.lossFunctions[i])(targets[i],outputs[i]);null!=sampleWeights[i]&&(loss=training_utils_1.computeWeightedLoss(loss,sampleWeights[i]));var meanLoss=tfc.mean(loss);lossValues.push(meanLoss),totalLoss=0===i?loss:tfc.add(totalLoss,loss)}for(i=0;i<_this.metricsTensors.length;++i){var weightedMetric=void 0;if(1<_this.outputs.length&&i<_this.outputs.length)weightedMetric=lossValues[i];else{var metric=_this.metricsTensors[i][0],outputIndex=_this.metricsTensors[i][1];weightedMetric=tfc.mean(metric(targets[outputIndex],outputs[outputIndex]))}tfc.keep(weightedMetric),metricsValues.push(weightedMetric)}return totalLoss=tfc.mean(totalLoss),_this.calculateLosses().forEach(function(regularizerLoss){totalLoss=tfc.add(totalLoss,regularizerLoss)}),totalLoss},!0,variables)].concat(metricsValues)}},LayersModel.prototype.makeTestFunction=function(){var _this=this;this.testFunction=function(data){return tfc.tidy(function(){for(var totalLoss,valOutputs=[],inputs=data.slice(0,_this.inputs.length),targets=data.slice(_this.inputs.length,_this.inputs.length+_this.outputs.length),feeds=[],i=0;i<_this.inputs.length;++i)feeds.push({key:_this.inputs[i],value:inputs[i]});var feedDict=new executor_1.FeedDict(feeds),outputs=executor_1.execute(_this.outputs,feedDict);for(i=0;i<_this.lossFunctions.length;++i){var lossFunction=_this.lossFunctions[i],loss=tfc.mean(lossFunction(targets[i],outputs[i]));totalLoss=0===i?loss:tfc.add(totalLoss,loss),valOutputs.push(totalLoss)}for(i=0;i<_this.metricsTensors.length;++i){var metric=_this.metricsTensors[i][0],outputIndex=_this.metricsTensors[i][1],meanMetric=tfc.mean(metric(targets[outputIndex],outputs[outputIndex]));valOutputs.push(meanMetric)}return valOutputs})}},LayersModel.prototype.fit=function(x,y,args){return void 0===args&&(args={}),__awaiter(this,void 0,void 0,function(){return __generator(this,function(_a){return[2,training_tensors_1.fitTensors(this,x,y,args)]})})},LayersModel.prototype.fitDataset=function(dataset,args){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(_a){return[2,training_dataset_1.fitDataset(this,dataset,args)]})})},LayersModel.prototype.trainOnBatch=function(x,y){return __awaiter(this,void 0,void 0,function(){var standardizeOut,inputs,targets,trainFunction,losses,lossValues,_i,losses_1,v;return __generator(this,function(_a){switch(_a.label){case 0:return[4,this.standardizeUserData(x,y)];case 1:standardizeOut=_a.sent(),inputs=standardizeOut[0],targets=standardizeOut[1],trainFunction=this.makeTrainFunction(),losses=trainFunction(inputs.concat(targets)),lossValues=[],_i=0,losses_1=losses,_a.label=2;case 2:return _i<losses_1.length?[4,losses_1[_i].data()]:[3,5];case 3:v=_a.sent(),lossValues.push(v[0]),_a.label=4;case 4:return _i++,[3,2];case 5:return tfc.dispose(losses),[2,generic_utils_1.singletonOrArray(lossValues)]}})})},LayersModel.prototype.getNamedWeights=function(config){for(var namedWeights=[],trainableOnly=null!=config&&config.trainableOnly,weights=trainableOnly?this.trainableWeights:this.weights,weightValues=this.getWeights(trainableOnly),i=0;i<weights.length;++i)trainableOnly&&!weights[i].trainable||namedWeights.push({name:weights[i].originalName,tensor:weightValues[i]});return namedWeights},Object.defineProperty(LayersModel.prototype,"stopTraining",{get:function(){return this.stopTraining_},set:function(stop){this.stopTraining_=stop},enumerable:!0,configurable:!0}),Object.defineProperty(LayersModel.prototype,"optimizer",{get:function(){return this.optimizer_},set:function(optimizer){this.optimizer_!==optimizer&&(this.optimizer_=optimizer,this.isOptimizerOwned=!1)},enumerable:!0,configurable:!0}),LayersModel.prototype.dispose=function(){var result=_super.prototype.dispose.call(this);if(0===result.refCountAfterDispose&&null!=this.optimizer&&this.isOptimizerOwned){var numTensorsBeforeOptmizerDisposal=tfc.memory().numTensors;this.optimizer_.dispose(),result.numDisposedVariables+=numTensorsBeforeOptmizerDisposal-tfc.memory().numTensors}return result},LayersModel.prototype.getLossIdentifiers=function(){var lossNames;if("string"==typeof this.loss)lossNames=generic_utils_1.toSnakeCase(this.loss);else if(Array.isArray(this.loss)){for(var _i=0,_a=this.loss;_i<_a.length;_i++){if("string"!=typeof _a[_i])throw new Error("Serialization of non-string loss is not supported.")}lossNames=this.loss.map(function(name){return generic_utils_1.toSnakeCase(name)})}else{var outputNames=Object.keys(this.loss);lossNames={};for(var losses_2=this.loss,_b=0,outputNames_2=outputNames;_b<outputNames_2.length;_b++){var outputName=outputNames_2[_b];if("string"!=typeof losses_2[outputName])throw new Error("Serialization of non-string loss is not supported.");lossNames[outputName]=generic_utils_1.toSnakeCase(losses_2[outputName])}}return lossNames},LayersModel.prototype.getMetricIdentifiers=function(){if("string"==typeof this.metrics||"function"==typeof this.metrics)return[generic_utils_1.toSnakeCase(Metrics.getLossOrMetricName(this.metrics))];if(Array.isArray(this.metrics))return this.metrics.map(function(metric){return generic_utils_1.toSnakeCase(Metrics.getLossOrMetricName(metric))});var metricsIdentifiers={};for(var key in this.metrics)metricsIdentifiers[key]=generic_utils_1.toSnakeCase(Metrics.getLossOrMetricName(this.metrics[key]));return metricsIdentifiers},LayersModel.prototype.getTrainingConfig=function(){return{loss:this.getLossIdentifiers(),metrics:this.getMetricIdentifiers(),optimizer_config:{class_name:this.optimizer.getClassName(),config:this.optimizer.getConfig()}}},LayersModel.prototype.loadTrainingConfig=function(trainingConfig){if(null!=trainingConfig.weighted_metrics)throw new Error("Loading weight_metrics is not supported yet.");if(null!=trainingConfig.loss_weights)throw new Error("Loading loss_weights is not supported yet.");if(null!=trainingConfig.sample_weight_mode)throw new Error("Loading sample_weight_mode is not supported yet.");var loss,metrics,tsConfig=serialization_utils_1.convertPythonicToTs(trainingConfig.optimizer_config),optimizer=serialization_1.deserialize(tsConfig);if("string"==typeof trainingConfig.loss)loss=generic_utils_1.toCamelCase(trainingConfig.loss);else if(Array.isArray(trainingConfig.loss))loss=trainingConfig.loss.map(function(lossEntry){return generic_utils_1.toCamelCase(lossEntry)});else if(null!=trainingConfig.loss)for(var key in loss={},trainingConfig.loss)loss[key]=generic_utils_1.toCamelCase(trainingConfig.loss[key]);if(Array.isArray(trainingConfig.metrics))metrics=trainingConfig.metrics.map(function(metric){return generic_utils_1.toCamelCase(metric)});else if(null!=trainingConfig.metrics)for(var key in metrics={},trainingConfig.metrics)metrics[key]=generic_utils_1.toCamelCase(trainingConfig.metrics[key]);this.compile({loss:loss,metrics:metrics,optimizer:optimizer})},LayersModel.prototype.save=function(handlerOrURL,config){return __awaiter(this,void 0,void 0,function(){var _a,handlers,weightDataAndSpecs,modelConfig,modelArtifacts,weightType,_b,optimizerWeightData,optimizerWeightSpecs,_c,_d;return __generator(this,function(_e){switch(_e.label){case 0:if("string"==typeof handlerOrURL){if(0===(handlers=tfjs_core_1.io.getSaveHandlers(handlerOrURL)).length)throw new errors_1.ValueError("Cannot find any save handlers for URL '"+handlerOrURL+"'");if(1<handlers.length)throw new errors_1.ValueError("Found more than one ("+handlers.length+") save handlers for URL '"+handlerOrURL+"'");handlerOrURL=handlers[0]}if(null==handlerOrURL.save)throw new errors_1.ValueError("LayersModel.save() cannot proceed because the IOHandler provided does not have the `save` attribute defined.");return[4,tfjs_core_1.io.encodeWeights(this.getNamedWeights(config))];case 1:return weightDataAndSpecs=_e.sent(),!1,null,modelConfig=this.toJSON(null,!1),modelArtifacts={modelTopology:modelConfig,format:"layers-model",generatedBy:"TensorFlow.js tfjs-layers v"+version_1.version,convertedBy:null},null!=config&&config.includeOptimizer&&null!=this.optimizer?(modelArtifacts.trainingConfig=this.getTrainingConfig(),weightType="optimizer",_d=(_c=tfjs_core_1.io).encodeWeights,[4,this.optimizer.getWeights()]):[3,4];case 2:return[4,_d.apply(_c,[_e.sent(),weightType])];case 3:_b=_e.sent(),optimizerWeightData=_b.data,optimizerWeightSpecs=_b.specs,(_a=weightDataAndSpecs.specs).push.apply(_a,optimizerWeightSpecs),weightDataAndSpecs.data=tfjs_core_1.io.concatenateArrayBuffers([weightDataAndSpecs.data,optimizerWeightData]),_e.label=4;case 4:return null!=this.userDefinedMetadata&&(!0,user_defined_metadata_1.checkUserDefinedMetadata(this.userDefinedMetadata,this.name,!0),modelArtifacts.userDefinedMetadata=this.userDefinedMetadata),modelArtifacts.weightData=weightDataAndSpecs.data,modelArtifacts.weightSpecs=weightDataAndSpecs.specs,[2,handlerOrURL.save(modelArtifacts)]}})})},LayersModel.prototype.setUserDefinedMetadata=function(userDefinedMetadata){user_defined_metadata_1.checkUserDefinedMetadata(userDefinedMetadata,this.name),this.userDefinedMetadata=userDefinedMetadata},LayersModel.prototype.getUserDefinedMetadata=function(){return this.userDefinedMetadata},LayersModel.className="Model",LayersModel}(container_1.Container);exports.LayersModel=LayersModel,tfjs_core_1.serialization.registerClass(LayersModel)},{"../backend/tfjs_backend":276,"../common":279,"../errors":289,"../layers/serialization":312,"../losses":315,"../metrics":316,"../optimizers":318,"../user_defined_metadata":320,"../utils/generic_utils":322,"../utils/layer_utils":323,"../utils/math_utils":324,"../utils/serialization_utils":325,"../version":329,"./container":281,"./executor":282,"./training_dataset":286,"./training_tensors":287,"./training_utils":288,"@tensorflow/tfjs-core":148}],286:[function(require,module,exports){"use strict";var __awaiter=this&&this.__awaiter||function(thisArg,_arguments,P,generator){return new(P=P||Promise)(function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){result.done?resolve(result.value):new P(function(resolve){resolve(result.value)}).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())})},__generator=this&&this.__generator||function(thisArg,body){var f,y,t,g,_={label:0,sent:function(){if(1&t[0])throw t[1];return t[1]},trys:[],ops:[]};return g={next:verb(0),throw:verb(1),return:verb(2)},"function"==typeof Symbol&&(g[Symbol.iterator]=function(){return this}),g;function verb(n){return function(v){return function(op){if(f)throw new TypeError("Generator is already executing.");for(;_;)try{if(f=1,y&&(t=2&op[0]?y.return:op[0]?y.throw||((t=y.return)&&t.call(y),0):y.next)&&!(t=t.call(y,op[1])).done)return t;switch(y=0,t&&(op=[2&op[0],t.value]),op[0]){case 0:case 1:t=op;break;case 4:return _.label++,{value:op[1],done:!1};case 5:_.label++,y=op[1],op=[0];continue;case 7:op=_.ops.pop(),_.trys.pop();continue;default:if(!(t=0<(t=_.trys).length&&t[t.length-1])&&(6===op[0]||2===op[0])){_=0;continue}if(3===op[0]&&(!t||op[1]>t[0]&&op[1]<t[3])){_.label=op[1];break}if(6===op[0]&&_.label<t[1]){_.label=t[1],t=op;break}if(t&&_.label<t[2]){_.label=t[2],_.ops.push(op);break}t[2]&&_.ops.pop(),_.trys.pop();continue}op=body.call(thisArg,_)}catch(e){op=[6,e],y=0}finally{f=t=0}if(5&op[0])throw op[1];return{value:op[0]?op[1]:void 0,done:!0}}([n,v])}}};Object.defineProperty(exports,"__esModule",{value:!0});var tfc=require("@tensorflow/tfjs-core"),tfjs_core_1=require("@tensorflow/tfjs-core"),base_callbacks_1=require("../base_callbacks"),errors_1=require("../errors"),logs_1=require("../logs"),generic_utils_1=require("../utils/generic_utils"),training_utils_1=require("./training_utils"),DEFAULT_VALIDATION_BATCH_SIZE=32;function standardizeDataIteratorOutput(model,iteratorOut){var xs,ys,iteratorOutObj=iteratorOut;xs=iteratorOutObj.xs,ys=iteratorOutObj.ys,tfc.util.assert(null!=xs&&null!=ys,function(){return"A Dataset iterator for fitDataset() is expected to generate objects of the form `{xs: xVal, ys: yVal}`, where the two values may be `tf.Tensor`, an array of Tensors, or a map of string to Tensor.  The provided Dataset instead generates "+iteratorOut});var flattenedXs=flattenTensorOrArrayOrMap("input",model.inputNames,xs),flattenedYs=flattenTensorOrArrayOrMap("output",model.outputNames,ys),batchSize=flattenedXs[0].shape[0];tfc.util.assert(flattenedXs.length===model.inputs.length,function(){return"LayersModel has "+model.inputs.length+" inputs, but the dataset provides "+flattenedXs.length+" inputs.  (Expected input keys: "+JSON.stringify(model.inputNames)+")"}),tfc.util.assert(flattenedYs.length===model.outputs.length,function(){return"LayersModel has "+model.outputs.length+" outputs, but the dataset provides "+flattenedYs.length+" outputs.  (Expected output keys: "+JSON.stringify(model.outputNames)+")"});function _loop_1(xIndex){tfc.util.assert(flattenedXs[xIndex].shape[0]===batchSize,function(){return"Batch size mismatch: input "+model.inputNames[xIndex]+" has "+flattenedXs[xIndex].shape[0]+"; expected  "+batchSize+" based on input "+model.inputNames[0]+"."})}for(var xIndex in flattenedXs)_loop_1(xIndex);function _loop_2(yIndex){tfc.util.assert(flattenedYs[yIndex].shape[0]===batchSize,function(){return"Batch size mismatch: output "+model.outputNames[yIndex]+" has "+flattenedYs[yIndex].shape[0]+"; expected  "+batchSize+" based on input "+model.inputNames[0]+"."})}for(var yIndex in flattenedYs)_loop_2(yIndex);return{xs:flattenedXs,ys:flattenedYs}}function flattenTensorOrArrayOrMap(inputOrOutput,names,values){if(values instanceof tfc.Tensor)return[values];if(Array.isArray(values))return tfc.util.assert(values.length===names.length,function(){return"Received an array of "+values.length+" Tensors, but expected "+names.length+" to match the "+inputOrOutput+" keys "+names+"."}),values;for(var result=[],_i=0,names_1=names;_i<names_1.length;_i++){var name_1=names_1[_i];if(null==values[name_1])throw new errors_1.ValueError("The feature data generated by the dataset lacks the required "+inputOrOutput+" key '"+name_1+"'.");result.push(values[name_1])}return result}function isDatasetObject(dataset){return"function"==typeof dataset.iterator}exports.fitDataset=function(model,dataset,args){return __awaiter(this,void 0,void 0,function(){var hasBatchesPerEpoch,doValidation,valXs,valYs,validationData,trainFunction,outLabels,callbackMetrics,callbacks,verbose,_a,callbackList,history_1,epoch,dataIterator,epochLogs,stepsDone,batchIndex,iteratorOut,_b,xs,ys,batchLogs,sampleWeights,standardClassWeights,_c,_d,ins,outs,label,out,valOuts,_e,i;return __generator(this,function(_f){switch(_f.label){case 0:if(hasBatchesPerEpoch=null!=args.batchesPerEpoch,tfc.util.assert(null!=model.optimizer,function(){return"You must compile a model before training/testing. Use LayersModel.compile(modelCompileConfig)."}),tfc.util.assert(null!=args,function(){return"For fitDataset(), the 2nd argument (config) is required, but it is not provided in this call."}),tfc.util.assert(null!=args.epochs&&0<args.epochs&&Number.isInteger(args.epochs),function(){return"For fitDataset(), config.epochs is expected to be a positive integer, but got "+args.epochs}),tfc.util.assert(!hasBatchesPerEpoch||0<args.batchesPerEpoch&&Number.isInteger(args.batchesPerEpoch),function(){return"For fitDataset(), config.batchesPerEpoch is expected to be a positive integer if specified, but got "+args.batchesPerEpoch}),tfc.util.assert(null==args.validationSplit,function(){return"`validationSplit` is not supported by `fitDataset()`. Use validationData instead."}),model.isTraining)throw new Error("Cannot start training because another fit() call is ongoing.");model.isTraining=!0,_f.label=1;case 1:return _f.trys.push([1,,26,27]),doValidation=null!=args.validationData,valYs=valXs=void 0,doValidation&&(isDatasetObject(args.validationData)?tfc.util.assert(null==args.validationBatches||0<args.validationBatches&&Number.isInteger(args.validationBatches),function(){return"For fitDataset() with dataset-based validation, config.validationBatches is expected not to be provided, or to be a positive integer, but got "+args.validationBatches}):(validationData=function(data){if(3===data.length)throw new errors_1.NotImplementedError("Validation with sample weights is not implemented yet.");return{xs:data[0],ys:data[1]}}(args.validationData),valXs=validationData.xs,valYs=validationData.ys)),trainFunction=model.makeTrainFunction(),outLabels=model.getDedupedMetricsNames(),callbackMetrics=void 0,callbackMetrics=doValidation?outLabels.slice().concat(outLabels.map(function(n){return"val_"+n})):outLabels.slice(),callbacks=base_callbacks_1.standardizeCallbacks(args.callbacks,args.yieldEvery),verbose=null==args.verbose?1:args.verbose,_a=base_callbacks_1.configureCallbacks(callbacks,verbose,args.epochs,null,null,function(dataset,args){var stepsPerEpoch=null;null!=args.batchesPerEpoch?stepsPerEpoch=args.batchesPerEpoch:Number.isFinite(dataset.size)&&(stepsPerEpoch=dataset.size);return stepsPerEpoch}(dataset,args),null,doValidation,callbackMetrics),callbackList=_a.callbackList,history_1=_a.history,callbackList.setModel(model),model.history=history_1,[4,callbackList.onTrainBegin()];case 2:return _f.sent(),model.stopTraining_=!1,epoch=null==args.initialEpoch?0:args.initialEpoch,[4,dataset.iterator()];case 3:dataIterator=_f.sent(),_f.label=4;case 4:return epoch<args.epochs?(epochLogs={},[4,callbackList.onEpochBegin(epoch)]):[3,23];case 5:return _f.sent(),batchIndex=stepsDone=0,hasBatchesPerEpoch?[3,7]:[4,dataset.iterator()];case 6:dataIterator=_f.sent(),_f.label=7;case 7:return!hasBatchesPerEpoch||stepsDone<args.batchesPerEpoch?[4,dataIterator.next()]:[3,21];case 8:return iteratorOut=_f.sent(),hasBatchesPerEpoch&&iteratorOut.done?(console.warn("You provided `batchesPerEpoch` as "+args.batchesPerEpoch+", but your dataset iterator ran out of data after "+stepsDone+" batches; interrupting training. Make sure that your dataset can generate at least `batchesPerEpoch * epochs` batches (in this case, "+args.batchesPerEpoch*args.epochs+" batches). You may need to use the repeat() function when building your dataset."),[3,21]):null==iteratorOut.value?[3,15]:(_b=standardizeDataIteratorOutput(model,iteratorOut.value),xs=_b.xs,ys=_b.ys,(batchLogs={}).batch=batchIndex,batchLogs.size=xs[0].shape[0],[4,callbackList.onBatchBegin(batchIndex,batchLogs)]);case 9:if(_f.sent(),sampleWeights=[],null==args.classWeight)return[3,13];standardClassWeights=training_utils_1.standardizeClassWeights(args.classWeight,model.outputNames),i=0,_f.label=10;case 10:return i<standardClassWeights.length?(_d=(_c=sampleWeights).push,[4,training_utils_1.standardizeWeights(ys[i],null,standardClassWeights[i])]):[3,13];case 11:_d.apply(_c,[_f.sent()]),_f.label=12;case 12:return++i,[3,10];case 13:for(ins=xs.concat(ys).concat(sampleWeights),outs=trainFunction(ins),tfc.dispose(ins),i=0;i<outLabels.length;++i)label=outLabels[i],out=outs[i],batchLogs[label]=out,tfc.keep(out);return[4,callbackList.onBatchEnd(batchIndex,batchLogs)];case 14:_f.sent(),logs_1.disposeTensorsInLogs(batchLogs),batchIndex++,stepsDone++,_f.label=15;case 15:return(hasBatchesPerEpoch?stepsDone>=args.batchesPerEpoch:iteratorOut.done)?doValidation?(valOuts=void 0,isDatasetObject(args.validationData)?(_e=generic_utils_1.toList,[4,model.evaluateDataset(args.validationData,{batches:args.validationBatches})]):[3,17]):[3,19]:[3,20];case 16:return valOuts=_e.apply(void 0,[_f.sent()]),[3,18];case 17:valOuts=generic_utils_1.toList(model.evaluate(valXs,valYs,{batchSize:null==args.validationBatchSize?DEFAULT_VALIDATION_BATCH_SIZE:args.validationBatchSize,verbose:0})),_f.label=18;case 18:for(i=0;i<model.metricsNames.length;++i)epochLogs["val_"+model.metricsNames[i]]=valOuts[i];_f.label=19;case 19:return[3,21];case 20:return model.stopTraining_?[3,21]:[3,7];case 21:return[4,callbackList.onEpochEnd(epoch,epochLogs)];case 22:return _f.sent(),epoch++,model.stopTraining_?[3,23]:[3,4];case 23:return[4,callbackList.onTrainEnd()];case 24:return _f.sent(),[4,model.history.syncData()];case 25:return _f.sent(),[2,model.history];case 26:return model.isTraining=!1,[7];case 27:return[2]}})})},exports.evaluateDataset=function(model,dataset,args){return __awaiter(this,void 0,void 0,function(){var hasBatches,f,outs,dataIterator,_a,numExamples,batch,_loop_3,i,oldScalar;return __generator(this,function(_b){switch(_b.label){case 0:if(hasBatches=null!=(args=args||{}).batches,f=model.testFunction,outs=[],0<args.verbose)throw new errors_1.NotImplementedError("Verbose mode is not implemented yet.");return tfc.util.assert(!hasBatches||0<args.batches&&Number.isInteger(args.batches),function(){return"Test loop expects `batches` to be a positive integer, but received "+JSON.stringify(args.batches)}),function(iterator){return"function"==typeof iterator.next}(dataset)?(_a=dataset,[3,3]):[3,1];case 1:return[4,dataset.iterator()];case 2:_a=_b.sent(),_b.label=3;case 3:dataIterator=_a,batch=numExamples=0,_loop_3=function(){var iteratorOut;return __generator(this,function(_a){switch(_a.label){case 0:return[4,dataIterator.next()];case 1:return iteratorOut=_a.sent(),outs=tfc.tidy(function(){if(iteratorOut.value){var _a=standardizeDataIteratorOutput(model,iteratorOut.value),xs=_a.xs,ys=_a.ys,xsAndYs_1=xs.concat(ys),batchOuts=tfc.tidy(function(){return f(xsAndYs_1)});if(tfc.dispose(xsAndYs_1),0===batch)for(var i=0;i<batchOuts.length;++i)outs.push(tfjs_core_1.scalar(0));var batchSize_1=xsAndYs_1[0].shape[0],_loop_4=function(i){var batchOut=batchOuts[i],oldScalar=outs[i];outs[i]=tfc.tidy(function(){return tfc.add(outs[i],tfc.mul(batchSize_1,batchOut))}),0<batch&&tfc.dispose(oldScalar)};for(i=0;i<batchOuts.length;++i)_loop_4(i);tfc.dispose(batchOuts),numExamples+=batchSize_1,++batch}return outs}),iteratorOut.done?(hasBatches&&console.warn("Your dataset iterator ran out of data during evaluateDataset(). Interrupting evalution. Make sure that your dataset can generate at least `batches` batches (in this case, "+args.batches+" batches). You may need to use the repeat() function when building your dataset."),[2,"break"]):[2]}})},_b.label=4;case 4:return!hasBatches||batch<args.batches?[5,_loop_3()]:[3,6];case 5:return"break"===_b.sent()?[3,6]:[3,4];case 6:for(i=0;i<outs.length;++i)oldScalar=outs[i],outs[i]=tfc.div(outs[i],numExamples),tfc.dispose(oldScalar);return[2,generic_utils_1.singletonOrArray(outs)]}})})}},{"../base_callbacks":277,"../errors":289,"../logs":314,"../utils/generic_utils":322,"./training_utils":288,"@tensorflow/tfjs-core":148}],287:[function(require,module,exports){"use strict";var __awaiter=this&&this.__awaiter||function(thisArg,_arguments,P,generator){return new(P=P||Promise)(function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){result.done?resolve(result.value):new P(function(resolve){resolve(result.value)}).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())})},__generator=this&&this.__generator||function(thisArg,body){var f,y,t,g,_={label:0,sent:function(){if(1&t[0])throw t[1];return t[1]},trys:[],ops:[]};return g={next:verb(0),throw:verb(1),return:verb(2)},"function"==typeof Symbol&&(g[Symbol.iterator]=function(){return this}),g;function verb(n){return function(v){return function(op){if(f)throw new TypeError("Generator is already executing.");for(;_;)try{if(f=1,y&&(t=2&op[0]?y.return:op[0]?y.throw||((t=y.return)&&t.call(y),0):y.next)&&!(t=t.call(y,op[1])).done)return t;switch(y=0,t&&(op=[2&op[0],t.value]),op[0]){case 0:case 1:t=op;break;case 4:return _.label++,{value:op[1],done:!1};case 5:_.label++,y=op[1],op=[0];continue;case 7:op=_.ops.pop(),_.trys.pop();continue;default:if(!(t=0<(t=_.trys).length&&t[t.length-1])&&(6===op[0]||2===op[0])){_=0;continue}if(3===op[0]&&(!t||op[1]>t[0]&&op[1]<t[3])){_.label=op[1];break}if(6===op[0]&&_.label<t[1]){_.label=t[1],t=op;break}if(t&&_.label<t[2]){_.label=t[2],_.ops.push(op);break}t[2]&&_.ops.pop(),_.trys.pop();continue}op=body.call(thisArg,_)}catch(e){op=[6,e],y=0}finally{f=t=0}if(5&op[0])throw op[1];return{value:op[0]?op[1]:void 0,done:!0}}([n,v])}}};Object.defineProperty(exports,"__esModule",{value:!0});var tfc=require("@tensorflow/tfjs-core"),tfjs_core_1=require("@tensorflow/tfjs-core"),tfjs_backend_1=require("../backend/tfjs_backend"),base_callbacks_1=require("../base_callbacks"),errors_1=require("../errors"),logs_1=require("../logs"),math_utils_1=require("../utils/math_utils");function checkBatchSize(batchSize){tfc.util.assert(0<batchSize&&Number.isInteger(batchSize),function(){return"batchSize is required to be a positive integer, but got "+batchSize})}function sliceArrays(arrays,start,stop){return null==arrays?[null]:Array.isArray(arrays)?arrays.map(function(array){return tfjs_backend_1.sliceAlongFirstAxis(array,start,stop-start)}):tfjs_backend_1.sliceAlongFirstAxis(arrays,start,stop-start)}function sliceArraysByIndices(arrays,indices){return tfc.tidy(function(){return null==arrays?null:Array.isArray(arrays)?arrays.map(function(array){return sliceArraysByIndices(array,indices)}):tfjs_backend_1.gather(arrays,"int32"===indices.dtype?indices:indices.toInt())})}function makeBatches(size,batchSize){for(var output=[],batchStart=0,batchEnd=null;batchStart<size;)size<=(batchEnd=batchStart+batchSize)&&(batchEnd=size),output.push([batchStart,batchEnd]),batchStart=batchEnd;return output}function disposeNewTensors(tensors,refTensors){if(null!=tensors){var oldTensorIds=[];if(refTensors instanceof tfjs_core_1.Tensor)oldTensorIds.push(refTensors.id);else if(Array.isArray(refTensors))refTensors.forEach(function(t){return oldTensorIds.push(t.id)});else if(null!=refTensors)for(var name_1 in refTensors){var oldTensor=refTensors[name_1];oldTensorIds.push(oldTensor.id)}var tensorsToDispose=[];if(tensors instanceof tfjs_core_1.Tensor)-1===oldTensorIds.indexOf(tensors.id)&&tensorsToDispose.push(tensors);else if(Array.isArray(tensors))tensors.forEach(function(t){-1===oldTensorIds.indexOf(t.id)&&tensorsToDispose.push(t)});else if(null!=tensors)for(var name_2 in tensors){var tensor=tensors[name_2];-1===oldTensorIds.indexOf(tensor.id)&&tensorsToDispose.push(tensor)}tensorsToDispose.forEach(function(t){t.isDisposed||t.dispose()})}}exports.checkBatchSize=checkBatchSize,exports.sliceArrays=sliceArrays,exports.sliceArraysByIndices=sliceArraysByIndices,exports.makeBatches=makeBatches,exports.fitTensors=function(model,x,y,args){return void 0===args&&(args={}),__awaiter(this,void 0,void 0,function(){var inputs,targets,inputValX,inputValY,valX,valY,sampleWeights,batchSize,standardizedOuts,doValidation,valIns,valStandardized,splitAt,originalBatchSize,ins,trainFunction,outLabels,valFunction,callbackMetrics,callbacks;return __generator(this,function(_a){switch(_a.label){case 0:if(model.isTraining)throw new Error("Cannot start training because another fit() call is ongoing.");model.isTraining=!0,_a.label=1;case 1:return _a.trys.push([1,,7,8]),checkBatchSize(batchSize=null==args.batchSize?32:args.batchSize),!1,[4,model.standardizeUserData(x,y,args.sampleWeight,args.classWeight,!1,batchSize)];case 2:if(standardizedOuts=_a.sent(),inputs=standardizedOuts[0],targets=standardizedOuts[1],sampleWeights=standardizedOuts[2],doValidation=!1,valIns=void 0,!(null!=args.validationData&&0<args.validationData.length))return[3,4];if(doValidation=!0,2!==args.validationData.length)throw 3===args.validationData.length?new errors_1.NotImplementedError("validationData including sample weights is not supported yet."):new errors_1.ValueError("When passing validation data, it must contain 2 (valX, valY) or 3 (valX, valY, valSampleWeight) items; "+args.validationData+" is invalid.");return inputValX=args.validationData[0],inputValY=args.validationData[1],!0,[4,model.standardizeUserData(inputValX,inputValY,null,null,!0,batchSize)];case 3:return valStandardized=_a.sent(),valX=valStandardized[0],valY=valStandardized[1],valIns=valX.concat(valY),[3,5];case 4:null!=args.validationSplit&&0<args.validationSplit&&args.validationSplit<1?(doValidation=!0,splitAt=Math.floor(inputs[0].shape[0]*(1-args.validationSplit)),originalBatchSize=inputs[0].shape[0],valX=sliceArrays(inputs,splitAt,originalBatchSize),inputs=sliceArrays(inputs,0,splitAt),valY=sliceArrays(targets,splitAt,originalBatchSize),targets=sliceArrays(targets,0,splitAt),valIns=valX.concat(valY)):null!=args.validationSteps&&(doValidation=!0),_a.label=5;case 5:return ins=inputs.concat(targets).concat(sampleWeights),model.checkTrainableWeightsConsistency(),trainFunction=model.makeTrainFunction(),outLabels=model.getDedupedMetricsNames(),callbackMetrics=valFunction=void 0,callbackMetrics=doValidation?(model.makeTestFunction(),valFunction=model.testFunction,outLabels.slice().concat(outLabels.map(function(n){return"val_"+n}))):(valFunction=null,valIns=[],outLabels.slice()),callbacks=base_callbacks_1.standardizeCallbacks(args.callbacks,args.yieldEvery),[4,function(model,f,ins,outLabels,batchSize,epochs,verbose,callbacks,valF,valIns,shuffle,callbackMetrics,initialEpoch,stepsPerEpoch,validationSteps){return __awaiter(this,void 0,void 0,function(){var doValidation,numTrainSamples,indexArray,_a,callbackList,history,_loop_1,epoch;return __generator(this,function(_b){switch(_b.label){case 0:if(null==batchSize&&(batchSize=32),null==epochs&&(epochs=1),null==shuffle&&(shuffle=!0),null==initialEpoch&&(initialEpoch=0),doValidation=!1,null!=valF&&null!=valIns&&(doValidation=!0),null!=validationSteps&&(doValidation=!0,null==stepsPerEpoch))throw new errors_1.ValueError("Can only use `validationSteps` when doing step-wise training, i.e., `stepsPerEpoch` must be set.");return null!=(numTrainSamples=model.checkNumSamples(ins,batchSize,stepsPerEpoch,"steps_per_epoch"))&&(indexArray=math_utils_1.range(0,numTrainSamples)),null==verbose&&(verbose=1),_a=base_callbacks_1.configureCallbacks(callbacks,verbose,epochs,initialEpoch,numTrainSamples,stepsPerEpoch,batchSize,doValidation,callbackMetrics),callbackList=_a.callbackList,history=_a.history,callbackList.setModel(model),model.history=history,[4,callbackList.onTrainBegin()];case 1:_b.sent(),model.stopTraining_=!1,_loop_1=function(epoch){var epochLogs,epochIndexArray1D_1,batches_1,_loop_2,batchIndex;return __generator(this,function(_a){switch(_a.label){case 0:return[4,callbackList.onEpochBegin(epoch)];case 1:if(_a.sent(),epochLogs={},null==stepsPerEpoch)return[3,2];throw new errors_1.NotImplementedError("stepsPerEpoch mode is not implemented yet.");case 2:if("batch"===shuffle)throw new errors_1.NotImplementedError("batch shuffling is not implemneted yet");shuffle&&tfjs_core_1.util.shuffle(indexArray),epochIndexArray1D_1=tfjs_core_1.tensor1d(indexArray),batches_1=makeBatches(numTrainSamples,batchSize),_loop_2=function(batchIndex){var batchLogs;return __generator(this,function(_a){switch(_a.label){case 0:return batchLogs={},[4,callbackList.onBatchBegin(batchIndex,batchLogs)];case 1:return _a.sent(),tfc.tidy(function(){var batchStart=batches_1[batchIndex][0],batchEnd=batches_1[batchIndex][1],batchIds=tfjs_backend_1.sliceAlongFirstAxis(epochIndexArray1D_1,batchStart,batchEnd-batchStart);batchLogs.batch=batchIndex,batchLogs.size=batchEnd-batchStart;for(var insBatch=sliceArraysByIndices(ins,batchIds),outs=f(insBatch),i=0;i<outLabels.length;++i){var label=outLabels[i],out=outs[i];batchLogs[label]=out,tfc.keep(out)}if(batchIndex===batches_1.length-1&&doValidation){var valOuts=model.testLoop(valF,valIns,batchSize);for(i=0;i<outLabels.length;++i){label=outLabels[i],out=valOuts[i];tfc.keep(out),epochLogs["val_"+label]=out}}}),[4,callbackList.onBatchEnd(batchIndex,batchLogs)];case 2:return _a.sent(),logs_1.disposeTensorsInLogs(batchLogs),model.stopTraining_?[2,"break"]:[2]}})},batchIndex=0,_a.label=3;case 3:return batchIndex<batches_1.length?[5,_loop_2(batchIndex)]:[3,6];case 4:if("break"===_a.sent())return[3,6];_a.label=5;case 5:return++batchIndex,[3,3];case 6:epochIndexArray1D_1.dispose(),_a.label=7;case 7:return[4,callbackList.onEpochEnd(epoch,epochLogs)];case 8:return _a.sent(),model.stopTraining_?[2,"break"]:[2]}})},epoch=initialEpoch,_b.label=2;case 2:return epoch<epochs?[5,_loop_1(epoch)]:[3,5];case 3:if("break"===_b.sent())return[3,5];_b.label=4;case 4:return++epoch,[3,2];case 5:return[4,callbackList.onTrainEnd()];case 6:return _b.sent(),[4,model.history.syncData()];case 7:return _b.sent(),[2,model.history]}})})}(model,trainFunction,ins,outLabels,batchSize,args.epochs,args.verbose,callbacks,valFunction,valIns,args.shuffle,callbackMetrics,args.initialEpoch,null,null)];case 6:return[2,_a.sent()];case 7:return model.isTraining=!1,disposeNewTensors(inputs,x),disposeNewTensors(targets,y),disposeNewTensors(valX,inputValX),disposeNewTensors(valY,inputValY),null!=sampleWeights&&tfc.dispose(sampleWeights),[7];case 8:return[2]}})})},exports.ensureTensorsRank2OrHigher=function(tensors){var outs=[];tensors instanceof tfjs_core_1.Tensor&&(tensors=[tensors]);for(var i=0;i<tensors.length;++i){var tensor=tensors[i];if(1===tensor.rank)outs.push(tfjs_backend_1.expandDims(tensor,1));else{if(0===tensor.rank)throw new Error("Expected tensor to be at least 1D, but received a 0D tensor (scalar).");outs.push(tensor)}}return outs},exports.disposeNewTensors=disposeNewTensors},{"../backend/tfjs_backend":276,"../base_callbacks":277,"../errors":289,"../logs":314,"../utils/math_utils":324,"@tensorflow/tfjs-core":148}],288:[function(require,module,exports){"use strict";var __awaiter=this&&this.__awaiter||function(thisArg,_arguments,P,generator){return new(P=P||Promise)(function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){result.done?resolve(result.value):new P(function(resolve){resolve(result.value)}).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())})},__generator=this&&this.__generator||function(thisArg,body){var f,y,t,g,_={label:0,sent:function(){if(1&t[0])throw t[1];return t[1]},trys:[],ops:[]};return g={next:verb(0),throw:verb(1),return:verb(2)},"function"==typeof Symbol&&(g[Symbol.iterator]=function(){return this}),g;function verb(n){return function(v){return function(op){if(f)throw new TypeError("Generator is already executing.");for(;_;)try{if(f=1,y&&(t=2&op[0]?y.return:op[0]?y.throw||((t=y.return)&&t.call(y),0):y.next)&&!(t=t.call(y,op[1])).done)return t;switch(y=0,t&&(op=[2&op[0],t.value]),op[0]){case 0:case 1:t=op;break;case 4:return _.label++,{value:op[1],done:!1};case 5:_.label++,y=op[1],op=[0];continue;case 7:op=_.ops.pop(),_.trys.pop();continue;default:if(!(t=0<(t=_.trys).length&&t[t.length-1])&&(6===op[0]||2===op[0])){_=0;continue}if(3===op[0]&&(!t||op[1]>t[0]&&op[1]<t[3])){_.label=op[1];break}if(6===op[0]&&_.label<t[1]){_.label=t[1],t=op;break}if(t&&_.label<t[2]){_.label=t[2],_.ops.push(op);break}t[2]&&_.ops.pop(),_.trys.pop();continue}op=body.call(thisArg,_)}catch(e){op=[6,e],y=0}finally{f=t=0}if(5&op[0])throw op[1];return{value:op[0]?op[1]:void 0,done:!0}}([n,v])}}};Object.defineProperty(exports,"__esModule",{value:!0});var tfjs_core_1=require("@tensorflow/tfjs-core");function standardizeSampleOrClassWeights(xWeight,outputNames,weightType){var numOutputs=outputNames.length;if(null==xWeight||Array.isArray(xWeight)&&0===xWeight.length)return outputNames.map(function(name){return null});if(1===numOutputs)return Array.isArray(xWeight)&&1===xWeight.length?xWeight:"object"==typeof xWeight&&outputNames[0]in xWeight?[xWeight[outputNames[0]]]:[xWeight];if(Array.isArray(xWeight)){if(xWeight.length!==numOutputs)throw new Error("Provided "+weightType+" is an array of "+xWeight.length+" element(s), but the model has "+numOutputs+" outputs. Make sure a set of weights is provided for each model output.");return xWeight}if("object"==typeof xWeight&&0<Object.keys(xWeight).length&&"object"==typeof xWeight[Object.keys(xWeight)[0]]){var output_1=[];return outputNames.forEach(function(outputName){outputName in xWeight?output_1.push(xWeight[outputName]):output_1.push(null)}),output_1}throw new Error("The model has multiple ("+numOutputs+") outputs, so "+weightType+" must be either an array with "+numOutputs+" elements or an object with "+outputNames+" keys. Provided "+weightType+" not understood: "+JSON.stringify(xWeight))}exports.standardizeClassWeights=function(classWeight,outputNames){return standardizeSampleOrClassWeights(classWeight,outputNames,"classWeight")},exports.standardizeSampleWeights=function(classWeight,outputNames){return standardizeSampleOrClassWeights(classWeight,outputNames,"sampleWeight")},exports.standardizeWeights=function(y,sampleWeight,classWeight,sampleWeightMode){return __awaiter(this,void 0,void 0,function(){var yClasses,yClassIndices,_a,_b,classSampleWeight_1;return __generator(this,function(_c){switch(_c.label){case 0:if(null!=sampleWeight||null!=sampleWeightMode)throw new Error("Support sampleWeight is not implemented yet");return null==classWeight?[3,2]:(yClasses=tfjs_core_1.tidy(function(){if(1===y.shape.length)return y.clone();if(2!==y.shape.length)throw new Error("Unexpected rank of target (y) tensor ("+y.rank+") during handling of class weights. The rank is expected to be 1 or 2.");if(1<y.shape[1]){return y.argMax(1)}if(1===y.shape[1])return y.reshape([y.shape[0]]);throw new Error("Encountered unexpected last-dimension size ("+y.shape[1]+") during handling of class weights. The size is expected to be >= 1.")}),_b=(_a=Array).from,[4,yClasses.data()]);case 1:return yClassIndices=_b.apply(_a,[_c.sent()]),tfjs_core_1.dispose(yClasses),classSampleWeight_1=[],yClassIndices.forEach(function(classIndex){if(null==classWeight[classIndex])throw new Error("classWeight must contain all classes in the training data. The class "+classIndex+" exists in the data but not in classWeight");classSampleWeight_1.push(classWeight[classIndex])}),[2,tfjs_core_1.tensor1d(classSampleWeight_1,"float32")];case 2:return[2,null]}})})},exports.computeWeightedLoss=function(losses,sampleWeights){return tfjs_core_1.mul(losses,sampleWeights)}},{"@tensorflow/tfjs-core":148}],289:[function(require,module,exports){"use strict";var extendStatics,__extends=this&&this.__extends||(extendStatics=function(d,b){return(extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p])})(d,b)},function(d,b){function __(){this.constructor=d}extendStatics(d,b),d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)});Object.defineProperty(exports,"__esModule",{value:!0});var AttributeError=function(_super){function AttributeError(message){var _this=_super.call(this,message)||this;return Object.setPrototypeOf(_this,AttributeError.prototype),_this}return __extends(AttributeError,_super),AttributeError}(Error);exports.AttributeError=AttributeError;var RuntimeError=function(_super){function RuntimeError(message){var _this=_super.call(this,message)||this;return Object.setPrototypeOf(_this,RuntimeError.prototype),_this}return __extends(RuntimeError,_super),RuntimeError}(Error);exports.RuntimeError=RuntimeError;var ValueError=function(_super){function ValueError(message){var _this=_super.call(this,message)||this;return Object.setPrototypeOf(_this,ValueError.prototype),_this}return __extends(ValueError,_super),ValueError}(Error);exports.ValueError=ValueError;var NotImplementedError=function(_super){function NotImplementedError(message){var _this=_super.call(this,message)||this;return Object.setPrototypeOf(_this,NotImplementedError.prototype),_this}return __extends(NotImplementedError,_super),NotImplementedError}(Error);exports.NotImplementedError=NotImplementedError;var AssertionError=function(_super){function AssertionError(message){var _this=_super.call(this,message)||this;return Object.setPrototypeOf(_this,AssertionError.prototype),_this}return __extends(AssertionError,_super),AssertionError}(Error);exports.AssertionError=AssertionError;var IndexError=function(_super){function IndexError(message){var _this=_super.call(this,message)||this;return Object.setPrototypeOf(_this,IndexError.prototype),_this}return __extends(IndexError,_super),IndexError}(Error);exports.IndexError=IndexError},{}],290:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var base_callbacks_1=require("./base_callbacks"),input_layer_1=require("./engine/input_layer"),training_1=require("./engine/training"),models_1=require("./models");exports.model=function(args){return new training_1.LayersModel(args)},exports.sequential=function(config){return new models_1.Sequential(config)},exports.loadLayersModel=function(pathOrIOHandler,options){return null==options&&(options={}),models_1.loadLayersModelInternal(pathOrIOHandler,options)},exports.input=function(config){return input_layer_1.Input(config)},exports.registerCallbackConstructor=function(verbosityLevel,callbackConstructor){base_callbacks_1.CallbackConstructorRegistry.registerCallbackConstructor(verbosityLevel,callbackConstructor)}},{"./base_callbacks":277,"./engine/input_layer":283,"./engine/training":285,"./models":317}],291:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var constraints_1=require("./constraints");exports.maxNorm=function(args){return new constraints_1.MaxNorm(args)},exports.unitNorm=function(args){return new constraints_1.UnitNorm(args)},exports.nonNeg=function(){return new constraints_1.NonNeg},exports.minMaxNorm=function(config){return new constraints_1.MinMaxNorm(config)}},{"./constraints":280}],292:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var initializers_1=require("./initializers");exports.zeros=function(){return new initializers_1.Zeros},exports.ones=function(){return new initializers_1.Ones},exports.constant=function(args){return new initializers_1.Constant(args)},exports.randomUniform=function(args){return new initializers_1.RandomUniform(args)},exports.randomNormal=function(args){return new initializers_1.RandomNormal(args)},exports.truncatedNormal=function(args){return new initializers_1.TruncatedNormal(args)},exports.identity=function(args){return new initializers_1.Identity(args)},exports.varianceScaling=function(config){return new initializers_1.VarianceScaling(config)},exports.glorotUniform=function(args){return new initializers_1.GlorotUniform(args)},exports.glorotNormal=function(args){return new initializers_1.GlorotNormal(args)},exports.heNormal=function(args){return new initializers_1.HeNormal(args)},exports.heUniform=function(args){return new initializers_1.HeUniform(args)},exports.leCunNormal=function(args){return new initializers_1.LeCunNormal(args)},exports.leCunUniform=function(args){return new initializers_1.LeCunUniform(args)},exports.orthogonal=function(args){return new initializers_1.Orthogonal(args)}},{"./initializers":298}],293:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var input_layer_1=require("./engine/input_layer"),topology_1=require("./engine/topology");exports.Layer=topology_1.Layer;var exports_1=require("./exports");exports.input=exports_1.input;var advanced_activations_1=require("./layers/advanced_activations"),convolutional_1=require("./layers/convolutional"),convolutional_depthwise_1=require("./layers/convolutional_depthwise"),core_1=require("./layers/core"),embeddings_1=require("./layers/embeddings"),merge_1=require("./layers/merge"),noise_1=require("./layers/noise"),normalization_1=require("./layers/normalization"),padding_1=require("./layers/padding"),pooling_1=require("./layers/pooling"),recurrent_1=require("./layers/recurrent");exports.RNN=recurrent_1.RNN,exports.RNNCell=recurrent_1.RNNCell;var wrappers_1=require("./layers/wrappers");function averagePooling1d(args){return new pooling_1.AveragePooling1D(args)}function averagePooling2d(args){return new pooling_1.AveragePooling2D(args)}function averagePooling3d(args){return new pooling_1.AveragePooling3D(args)}function globalMaxPooling1d(args){return new pooling_1.GlobalMaxPooling1D(args)}function globalMaxPooling2d(args){return new pooling_1.GlobalMaxPooling2D(args)}function maxPooling1d(args){return new pooling_1.MaxPooling1D(args)}function maxPooling2d(args){return new pooling_1.MaxPooling2D(args)}exports.inputLayer=function(args){return new input_layer_1.InputLayer(args)},exports.elu=function(args){return new advanced_activations_1.ELU(args)},exports.reLU=function(args){return new advanced_activations_1.ReLU(args)},exports.leakyReLU=function(args){return new advanced_activations_1.LeakyReLU(args)},exports.prelu=function(args){return new advanced_activations_1.PReLU(args)},exports.softmax=function(args){return new advanced_activations_1.Softmax(args)},exports.thresholdedReLU=function(args){return new advanced_activations_1.ThresholdedReLU(args)},exports.conv1d=function(args){return new convolutional_1.Conv1D(args)},exports.conv2d=function(args){return new convolutional_1.Conv2D(args)},exports.conv2dTranspose=function(args){return new convolutional_1.Conv2DTranspose(args)},exports.conv3d=function(args){return new convolutional_1.Conv3D(args)},exports.separableConv2d=function(args){return new convolutional_1.SeparableConv2D(args)},exports.cropping2D=function(args){return new convolutional_1.Cropping2D(args)},exports.upSampling2d=function(args){return new convolutional_1.UpSampling2D(args)},exports.depthwiseConv2d=function(args){return new convolutional_depthwise_1.DepthwiseConv2D(args)},exports.activation=function(args){return new core_1.Activation(args)},exports.dense=function(args){return new core_1.Dense(args)},exports.dropout=function(args){return new core_1.Dropout(args)},exports.flatten=function(args){return new core_1.Flatten(args)},exports.repeatVector=function(args){return new core_1.RepeatVector(args)},exports.reshape=function(args){return new core_1.Reshape(args)},exports.permute=function(args){return new core_1.Permute(args)},exports.embedding=function(args){return new embeddings_1.Embedding(args)},exports.add=function(args){return new merge_1.Add(args)},exports.average=function(args){return new merge_1.Average(args)},exports.concatenate=function(args){return new merge_1.Concatenate(args)},exports.maximum=function(args){return new merge_1.Maximum(args)},exports.minimum=function(args){return new merge_1.Minimum(args)},exports.multiply=function(args){return new merge_1.Multiply(args)},exports.dot=function(args){return new merge_1.Dot(args)},exports.batchNormalization=function(args){return new normalization_1.BatchNormalization(args)},exports.zeroPadding2d=function(args){return new padding_1.ZeroPadding2D(args)},exports.averagePooling1d=averagePooling1d,exports.avgPool1d=function(args){return averagePooling1d(args)},exports.avgPooling1d=function(args){return averagePooling1d(args)},exports.averagePooling2d=averagePooling2d,exports.avgPool2d=function(args){return averagePooling2d(args)},exports.avgPooling2d=function(args){return averagePooling2d(args)},exports.averagePooling3d=averagePooling3d,exports.avgPool3d=function(args){return averagePooling3d(args)},exports.avgPooling3d=function(args){return averagePooling3d(args)},exports.globalAveragePooling1d=function(args){return new pooling_1.GlobalAveragePooling1D(args)},exports.globalAveragePooling2d=function(args){return new pooling_1.GlobalAveragePooling2D(args)},exports.globalMaxPooling1d=globalMaxPooling1d,exports.globalMaxPooling2d=globalMaxPooling2d,exports.maxPooling1d=maxPooling1d,exports.maxPooling2d=maxPooling2d,exports.maxPooling3d=function(args){return new pooling_1.MaxPooling3D(args)},exports.gru=function(args){return new recurrent_1.GRU(args)},exports.gruCell=function(args){return new recurrent_1.GRUCell(args)},exports.lstm=function(args){return new recurrent_1.LSTM(args)},exports.lstmCell=function(args){return new recurrent_1.LSTMCell(args)},exports.simpleRNN=function(args){return new recurrent_1.SimpleRNN(args)},exports.simpleRNNCell=function(args){return new recurrent_1.SimpleRNNCell(args)},exports.rnn=function(args){return new recurrent_1.RNN(args)},exports.stackedRNNCells=function(args){return new recurrent_1.StackedRNNCells(args)},exports.bidirectional=function(args){return new wrappers_1.Bidirectional(args)},exports.timeDistributed=function(args){return new wrappers_1.TimeDistributed(args)},exports.globalMaxPool1d=globalMaxPooling1d,exports.globalMaxPool2d=globalMaxPooling2d,exports.maxPool1d=maxPooling1d,exports.maxPool2d=maxPooling2d,exports.gaussianNoise=function(args){return new noise_1.GaussianNoise(args)},exports.gaussianDropout=function(args){return new noise_1.GaussianDropout(args)},exports.alphaDropout=function(args){return new noise_1.AlphaDropout(args)},exports.masking=function(args){return new core_1.Masking(args)}},{"./engine/input_layer":283,"./engine/topology":284,"./exports":290,"./layers/advanced_activations":301,"./layers/convolutional":302,"./layers/convolutional_depthwise":303,"./layers/core":304,"./layers/embeddings":305,"./layers/merge":306,"./layers/noise":307,"./layers/normalization":308,"./layers/padding":309,"./layers/pooling":310,"./layers/recurrent":311,"./layers/wrappers":313}],294:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var losses=require("./losses"),metrics=require("./metrics");exports.binaryAccuracy=function(yTrue,yPred){return metrics.binaryAccuracy(yTrue,yPred)},exports.binaryCrossentropy=function(yTrue,yPred){return metrics.binaryCrossentropy(yTrue,yPred)},exports.sparseCategoricalAccuracy=function(yTrue,yPred){return metrics.sparseCategoricalAccuracy(yTrue,yPred)},exports.categoricalAccuracy=function(yTrue,yPred){return metrics.categoricalAccuracy(yTrue,yPred)},exports.categoricalCrossentropy=function(yTrue,yPred){return metrics.categoricalCrossentropy(yTrue,yPred)},exports.precision=function(yTrue,yPred){return metrics.precision(yTrue,yPred)},exports.recall=function(yTrue,yPred){return metrics.recall(yTrue,yPred)},exports.cosineProximity=function(yTrue,yPred){return losses.cosineProximity(yTrue,yPred)},exports.meanAbsoluteError=function(yTrue,yPred){return losses.meanAbsoluteError(yTrue,yPred)},exports.meanAbsolutePercentageError=function(yTrue,yPred){return losses.meanAbsolutePercentageError(yTrue,yPred)},exports.MAPE=function(yTrue,yPred){return losses.meanAbsolutePercentageError(yTrue,yPred)},exports.mape=function(yTrue,yPred){return losses.meanAbsolutePercentageError(yTrue,yPred)},exports.meanSquaredError=function(yTrue,yPred){return losses.meanSquaredError(yTrue,yPred)},exports.MSE=function(yTrue,yPred){return losses.meanSquaredError(yTrue,yPred)},exports.mse=function(yTrue,yPred){return losses.meanSquaredError(yTrue,yPred)}},{"./losses":315,"./metrics":316}],295:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var models_1=require("./models");exports.modelFromJSON=models_1.modelFromJSON},{"./models":317}],296:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var regularizers=require("./regularizers"),regularizers_1=require("./regularizers");exports.l1l2=function(config){return new regularizers_1.L1L2(config)},exports.l1=function(config){return regularizers.l1(config)},exports.l2=function(config){return regularizers.l2(config)}},{"./regularizers":319}],297:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var constraints=require("./exports_constraints");exports.constraints=constraints;var initializers=require("./exports_initializers");exports.initializers=initializers;var layers=require("./exports_layers");exports.layers=layers;var metrics=require("./exports_metrics");exports.metrics=metrics;var models=require("./exports_models");exports.models=models;var regularizers=require("./exports_regularizers");exports.regularizers=regularizers;var base_callbacks_1=require("./base_callbacks");exports.CallbackList=base_callbacks_1.CallbackList,exports.CustomCallback=base_callbacks_1.CustomCallback,exports.History=base_callbacks_1.History;var callbacks_1=require("./callbacks");exports.Callback=callbacks_1.Callback,exports.callbacks=callbacks_1.callbacks,exports.EarlyStopping=callbacks_1.EarlyStopping;var topology_1=require("./engine/topology");exports.InputSpec=topology_1.InputSpec,exports.SymbolicTensor=topology_1.SymbolicTensor;var training_1=require("./engine/training");exports.LayersModel=training_1.LayersModel;var exports_1=require("./exports");exports.input=exports_1.input,exports.loadLayersModel=exports_1.loadLayersModel,exports.model=exports_1.model,exports.registerCallbackConstructor=exports_1.registerCallbackConstructor,exports.sequential=exports_1.sequential;var recurrent_1=require("./layers/recurrent");exports.RNN=recurrent_1.RNN;var models_1=require("./models");exports.Sequential=models_1.Sequential;var variables_1=require("./variables");exports.LayerVariable=variables_1.LayerVariable;var version_1=require("./version");exports.version_layers=version_1.version},{"./base_callbacks":277,"./callbacks":278,"./engine/topology":284,"./engine/training":285,"./exports":290,"./exports_constraints":291,"./exports_initializers":292,"./exports_layers":293,"./exports_metrics":294,"./exports_models":295,"./exports_regularizers":296,"./layers/recurrent":311,"./models":317,"./variables":328,"./version":329}],298:[function(require,module,exports){"use strict";var extendStatics,__extends=this&&this.__extends||(extendStatics=function(d,b){return(extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p])})(d,b)},function(d,b){function __(){this.constructor=d}extendStatics(d,b),d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)});Object.defineProperty(exports,"__esModule",{value:!0});var tfjs_core_1=require("@tensorflow/tfjs-core"),K=require("./backend/tfjs_backend"),common_1=require("./common"),errors_1=require("./errors"),initializer_config_1=require("./keras_format/initializer_config"),generic_utils_1=require("./utils/generic_utils"),math_utils_1=require("./utils/math_utils");function checkFanMode(value){generic_utils_1.checkStringTypeUnionValue(initializer_config_1.VALID_FAN_MODE_VALUES,"FanMode",value)}function checkDistribution(value){generic_utils_1.checkStringTypeUnionValue(initializer_config_1.VALID_DISTRIBUTION_VALUES,"Distribution",value)}exports.checkFanMode=checkFanMode,exports.checkDistribution=checkDistribution;var Initializer=function(_super){function Initializer(){return null!==_super&&_super.apply(this,arguments)||this}return __extends(Initializer,_super),Initializer.prototype.fromConfigUsesCustomObjects=function(){return!1},Initializer.prototype.getConfig=function(){return{}},Initializer}(tfjs_core_1.serialization.Serializable),Zeros=function(_super){function Zeros(){return null!==_super&&_super.apply(this,arguments)||this}return __extends(Zeros,_super),Zeros.prototype.apply=function(shape,dtype){return tfjs_core_1.zeros(shape,dtype)},Zeros.className="Zeros",Zeros}(exports.Initializer=Initializer);exports.Zeros=Zeros,tfjs_core_1.serialization.registerClass(Zeros);var Ones=function(_super){function Ones(){return null!==_super&&_super.apply(this,arguments)||this}return __extends(Ones,_super),Ones.prototype.apply=function(shape,dtype){return tfjs_core_1.ones(shape,dtype)},Ones.className="Ones",Ones}(Initializer);exports.Ones=Ones,tfjs_core_1.serialization.registerClass(Ones);var Constant=function(_super){function Constant(args){var _this=_super.call(this)||this;if("object"!=typeof args)throw new errors_1.ValueError("Expected argument of type ConstantConfig but got "+args);if(void 0===args.value)throw new errors_1.ValueError("config must have value set but got "+args);return _this.value=args.value,_this}return __extends(Constant,_super),Constant.prototype.apply=function(shape,dtype){var _this=this;return tfjs_core_1.tidy(function(){return tfjs_core_1.mul(tfjs_core_1.scalar(_this.value),tfjs_core_1.ones(shape,dtype))})},Constant.prototype.getConfig=function(){return{value:this.value}},Constant.className="Constant",Constant}(Initializer);exports.Constant=Constant,tfjs_core_1.serialization.registerClass(Constant);var RandomUniform=function(_super){function RandomUniform(args){var _this=_super.call(this)||this;return _this.DEFAULT_MINVAL=-.05,_this.DEFAULT_MAXVAL=.05,_this.minval=args.minval||_this.DEFAULT_MINVAL,_this.maxval=args.maxval||_this.DEFAULT_MAXVAL,_this.seed=args.seed,_this}return __extends(RandomUniform,_super),RandomUniform.prototype.apply=function(shape,dtype){return tfjs_core_1.randomUniform(shape,this.minval,this.maxval,dtype)},RandomUniform.prototype.getConfig=function(){return{minval:this.minval,maxval:this.maxval,seed:this.seed}},RandomUniform.className="RandomUniform",RandomUniform}(Initializer);exports.RandomUniform=RandomUniform,tfjs_core_1.serialization.registerClass(RandomUniform);var RandomNormal=function(_super){function RandomNormal(args){var _this=_super.call(this)||this;return _this.DEFAULT_MEAN=0,_this.DEFAULT_STDDEV=.05,_this.mean=args.mean||_this.DEFAULT_MEAN,_this.stddev=args.stddev||_this.DEFAULT_STDDEV,_this.seed=args.seed,_this}return __extends(RandomNormal,_super),RandomNormal.prototype.apply=function(shape,dtype){if("float32"!==(dtype=dtype||"float32")&&"int32"!==dtype)throw new errors_1.NotImplementedError("randomNormal does not support dType "+dtype+".");return K.randomNormal(shape,this.mean,this.stddev,dtype,this.seed)},RandomNormal.prototype.getConfig=function(){return{mean:this.mean,stddev:this.stddev,seed:this.seed}},RandomNormal.className="RandomNormal",RandomNormal}(Initializer);exports.RandomNormal=RandomNormal,tfjs_core_1.serialization.registerClass(RandomNormal);var TruncatedNormal=function(_super){function TruncatedNormal(args){var _this=_super.call(this)||this;return _this.DEFAULT_MEAN=0,_this.DEFAULT_STDDEV=.05,_this.mean=args.mean||_this.DEFAULT_MEAN,_this.stddev=args.stddev||_this.DEFAULT_STDDEV,_this.seed=args.seed,_this}return __extends(TruncatedNormal,_super),TruncatedNormal.prototype.apply=function(shape,dtype){if("float32"!==(dtype=dtype||"float32")&&"int32"!==dtype)throw new errors_1.NotImplementedError("truncatedNormal does not support dType "+dtype+".");return tfjs_core_1.truncatedNormal(shape,this.mean,this.stddev,dtype,this.seed)},TruncatedNormal.prototype.getConfig=function(){return{mean:this.mean,stddev:this.stddev,seed:this.seed}},TruncatedNormal.className="TruncatedNormal",TruncatedNormal}(Initializer);exports.TruncatedNormal=TruncatedNormal,tfjs_core_1.serialization.registerClass(TruncatedNormal);var Identity=function(_super){function Identity(args){var _this=_super.call(this)||this;return _this.gain=null!=args.gain?args.gain:1,_this}return __extends(Identity,_super),Identity.prototype.apply=function(shape,dtype){var _this=this;return tfjs_core_1.tidy(function(){if(2!==shape.length||shape[0]!==shape[1])throw new errors_1.ValueError("Identity matrix initializer can only be used for 2D square matrices.");return tfjs_core_1.mul(_this.gain,tfjs_core_1.eye(shape[0]))})},Identity.prototype.getConfig=function(){return{gain:this.gain}},Identity.className="Identity",Identity}(Initializer);exports.Identity=Identity,tfjs_core_1.serialization.registerClass(Identity);var VarianceScaling=function(_super){function VarianceScaling(args){var _this=_super.call(this)||this;if(args.scale<0)throw new errors_1.ValueError("scale must be a positive float. Got: "+args.scale);return _this.scale=null==args.scale?1:args.scale,_this.mode=null==args.mode?"fanIn":args.mode,checkFanMode(_this.mode),_this.distribution=null==args.distribution?"normal":args.distribution,checkDistribution(_this.distribution),_this.seed=args.seed,_this}return __extends(VarianceScaling,_super),VarianceScaling.prototype.apply=function(shape,dtype){var fans=function(shape,dataFormat){var fanIn,fanOut;if(void 0===dataFormat&&(dataFormat="channelsLast"),common_1.checkDataFormat(dataFormat),2===shape.length)fanIn=shape[0],fanOut=shape[1];else if(-1!==[3,4,5].indexOf(shape.length)){if("channelsFirst"===dataFormat){var receptiveFieldSize=math_utils_1.arrayProd(shape,2);fanIn=shape[1]*receptiveFieldSize,fanOut=shape[0]*receptiveFieldSize}else if("channelsLast"===dataFormat){receptiveFieldSize=math_utils_1.arrayProd(shape,0,shape.length-2);fanIn=shape[shape.length-2]*receptiveFieldSize,fanOut=shape[shape.length-1]*receptiveFieldSize}}else{var shapeProd=math_utils_1.arrayProd(shape);fanIn=Math.sqrt(shapeProd),fanOut=Math.sqrt(shapeProd)}return[fanIn,fanOut]}(shape),fanIn=fans[0],fanOut=fans[1],scale=this.scale;if("fanIn"===this.mode?scale/=Math.max(1,fanIn):"fanOut"===this.mode?scale/=Math.max(1,fanOut):scale/=Math.max(1,(fanIn+fanOut)/2),"normal"===this.distribution){var stddev=Math.sqrt(scale);if("float32"!==(dtype=dtype||"float32")&&"int32"!==dtype)throw new errors_1.NotImplementedError(this.getClassName()+" does not support dType "+dtype+".");return tfjs_core_1.truncatedNormal(shape,0,stddev,dtype,this.seed)}var limit=Math.sqrt(3*scale);return tfjs_core_1.randomUniform(shape,-limit,limit,dtype)},VarianceScaling.prototype.getConfig=function(){return{scale:this.scale,mode:this.mode,distribution:this.distribution,seed:this.seed}},VarianceScaling.className="VarianceScaling",VarianceScaling}(Initializer);exports.VarianceScaling=VarianceScaling,tfjs_core_1.serialization.registerClass(VarianceScaling);var GlorotUniform=function(_super){function GlorotUniform(args){return _super.call(this,{scale:1,mode:"fanAvg",distribution:"uniform",seed:null==args?null:args.seed})||this}return __extends(GlorotUniform,_super),GlorotUniform.prototype.getClassName=function(){return VarianceScaling.className},GlorotUniform.className="GlorotUniform",GlorotUniform}(VarianceScaling);exports.GlorotUniform=GlorotUniform,tfjs_core_1.serialization.registerClass(GlorotUniform);var GlorotNormal=function(_super){function GlorotNormal(args){return _super.call(this,{scale:1,mode:"fanAvg",distribution:"normal",seed:null==args?null:args.seed})||this}return __extends(GlorotNormal,_super),GlorotNormal.prototype.getClassName=function(){return VarianceScaling.className},GlorotNormal.className="GlorotNormal",GlorotNormal}(VarianceScaling);exports.GlorotNormal=GlorotNormal,tfjs_core_1.serialization.registerClass(GlorotNormal);var HeNormal=function(_super){function HeNormal(args){return _super.call(this,{scale:2,mode:"fanIn",distribution:"normal",seed:null==args?null:args.seed})||this}return __extends(HeNormal,_super),HeNormal.prototype.getClassName=function(){return VarianceScaling.className},HeNormal.className="HeNormal",HeNormal}(VarianceScaling);exports.HeNormal=HeNormal,tfjs_core_1.serialization.registerClass(HeNormal);var HeUniform=function(_super){function HeUniform(args){return _super.call(this,{scale:2,mode:"fanIn",distribution:"uniform",seed:null==args?null:args.seed})||this}return __extends(HeUniform,_super),HeUniform.prototype.getClassName=function(){return VarianceScaling.className},HeUniform.className="HeUniform",HeUniform}(VarianceScaling);exports.HeUniform=HeUniform,tfjs_core_1.serialization.registerClass(HeUniform);var LeCunNormal=function(_super){function LeCunNormal(args){return _super.call(this,{scale:1,mode:"fanIn",distribution:"normal",seed:null==args?null:args.seed})||this}return __extends(LeCunNormal,_super),LeCunNormal.prototype.getClassName=function(){return VarianceScaling.className},LeCunNormal.className="LeCunNormal",LeCunNormal}(VarianceScaling);exports.LeCunNormal=LeCunNormal,tfjs_core_1.serialization.registerClass(LeCunNormal);var LeCunUniform=function(_super){function LeCunUniform(args){return _super.call(this,{scale:1,mode:"fanIn",distribution:"uniform",seed:null==args?null:args.seed})||this}return __extends(LeCunUniform,_super),LeCunUniform.prototype.getClassName=function(){return VarianceScaling.className},LeCunUniform.className="LeCunNormal",LeCunUniform}(VarianceScaling);exports.LeCunUniform=LeCunUniform,tfjs_core_1.serialization.registerClass(LeCunUniform);var Orthogonal=function(_super){function Orthogonal(args){var _this=_super.call(this)||this;if(_this.DEFAULT_GAIN=1,_this.gain=null==args.gain?_this.DEFAULT_GAIN:args.gain,_this.seed=args.seed,null!=_this.seed)throw new errors_1.NotImplementedError("Random seed is not implemented for Orthogonal Initializer yet.");return _this}return __extends(Orthogonal,_super),Orthogonal.prototype.apply=function(shape,dtype){var _this=this;return tfjs_core_1.tidy(function(){if(2!==shape.length)throw new errors_1.NotImplementedError("The Orthogonal Initializer does not support non-2D shapes yet.");2e3<shape[0]*shape[1]&&console.warn("Orthogonal initializer is being called on a matrix with more than 2000 ("+shape[0]*shape[1]+") elements: Slowness may result.");var normalizedShape=shape[0]>shape[1]?[shape[1],shape[0]]:shape,a=K.randomNormal(normalizedShape,0,1,"float32"),q=tfjs_core_1.linalg.gramSchmidt(a);return shape[0]>shape[1]&&(q=q.transpose()),tfjs_core_1.mul(_this.gain,q)})},Orthogonal.prototype.getConfig=function(){return{gain:this.gain,seed:this.seed}},Orthogonal.className="Orthogonal",Orthogonal}(Initializer);function deserializeInitializer(config,customObjects){return void 0===customObjects&&(customObjects={}),generic_utils_1.deserializeKerasObject(config,tfjs_core_1.serialization.SerializationMap.getMap().classNameMap,customObjects,"initializer")}exports.Orthogonal=Orthogonal,tfjs_core_1.serialization.registerClass(Orthogonal),exports.INITIALIZER_IDENTIFIER_REGISTRY_SYMBOL_MAP={constant:"Constant",glorotNormal:"GlorotNormal",glorotUniform:"GlorotUniform",heNormal:"HeNormal",heUniform:"HeUniform",identity:"Identity",leCunNormal:"LeCunNormal",leCunUniform:"LeCunUniform",ones:"Ones",orthogonal:"Orthogonal",randomNormal:"RandomNormal",randomUniform:"RandomUniform",truncatedNormal:"TruncatedNormal",varianceScaling:"VarianceScaling",zeros:"Zeros"},exports.serializeInitializer=function(initializer){return generic_utils_1.serializeKerasObject(initializer)},exports.getInitializer=function(identifier){if("string"!=typeof identifier)return identifier instanceof Initializer?identifier:deserializeInitializer(identifier);var className=identifier in exports.INITIALIZER_IDENTIFIER_REGISTRY_SYMBOL_MAP?exports.INITIALIZER_IDENTIFIER_REGISTRY_SYMBOL_MAP[identifier]:identifier;if("GlorotNormal"===className)return new GlorotNormal;if("GlorotUniform"===className)return new GlorotUniform;if("HeNormal"===className)return new HeNormal;if("HeUniform"===className)return new HeUniform;if("LeCunNormal"===className)return new LeCunNormal;if("LeCunUniform"===className)return new LeCunUniform;var config={};return config.className=className,config.config={},deserializeInitializer(config)}},{"./backend/tfjs_backend":276,"./common":279,"./errors":289,"./keras_format/initializer_config":300,"./utils/generic_utils":322,"./utils/math_utils":324,"@tensorflow/tfjs-core":148}],299:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.VALID_DATA_FORMAT_VALUES=["channelsFirst","channelsLast"],exports.VALID_PADDING_MODE_VALUES=["valid","same","causal"],exports.VALID_POOL_MODE_VALUES=["max","avg"],exports.VALID_BIDIRECTIONAL_MERGE_MODES=["sum","mul","concat","ave"],exports.VALID_SAMPLE_WEIGHT_MODES=["temporal"]},{}],300:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.VALID_FAN_MODE_VALUES=["fanIn","fanOut","fanAvg"],exports.VALID_DISTRIBUTION_VALUES=["normal","uniform","truncatedNormal"],exports.initializerClassNames=["Zeros","Ones","Constant","RandomNormal","RandomUniform","TruncatedNormal","VarianceScaling","Orthogonal","Identity"]},{}],301:[function(require,module,exports){"use strict";var extendStatics,__extends=this&&this.__extends||(extendStatics=function(d,b){return(extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p])})(d,b)},function(d,b){function __(){this.constructor=d}extendStatics(d,b),d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)});Object.defineProperty(exports,"__esModule",{value:!0});var tfjs_core_1=require("@tensorflow/tfjs-core"),activations_1=require("../activations"),tfjs_backend_1=require("../backend/tfjs_backend"),constraints_1=require("../constraints"),topology_1=require("../engine/topology"),errors_1=require("../errors"),initializers_1=require("../initializers"),regularizers_1=require("../regularizers"),types_utils_1=require("../utils/types_utils"),ReLU=function(_super){function ReLU(args){var _this=_super.call(this,null==args?{}:args)||this;return _this.supportsMasking=!0,null!=args&&(_this.maxValue=args.maxValue),_this}return __extends(ReLU,_super),ReLU.prototype.call=function(inputs,kwargs){inputs=types_utils_1.getExactlyOneTensor(inputs);var output=tfjs_core_1.relu(inputs);return null!=this.maxValue&&(output=tfjs_core_1.clipByValue(output,0,this.maxValue)),output},ReLU.prototype.computeOutputShape=function(inputShape){return inputShape},ReLU.prototype.getConfig=function(){var config={maxValue:this.maxValue},baseConfig=_super.prototype.getConfig.call(this);return Object.assign(config,baseConfig),config},ReLU.className="ReLU",ReLU}(topology_1.Layer);exports.ReLU=ReLU,tfjs_core_1.serialization.registerClass(ReLU);var LeakyReLU=function(_super){function LeakyReLU(args){var _this=_super.call(this,null==args?{}:args)||this;return _this.DEFAULT_ALPHA=.3,null==args&&(args={}),_this.alpha=null==args.alpha?_this.DEFAULT_ALPHA:args.alpha,_this}return __extends(LeakyReLU,_super),LeakyReLU.prototype.call=function(inputs,kwargs){var x=types_utils_1.getExactlyOneTensor(inputs);return tfjs_core_1.leakyRelu(x,this.alpha)},LeakyReLU.prototype.computeOutputShape=function(inputShape){return inputShape},LeakyReLU.prototype.getConfig=function(){var config={alpha:this.alpha},baseConfig=_super.prototype.getConfig.call(this);return Object.assign(config,baseConfig),config},LeakyReLU.className="LeakyReLU",LeakyReLU}(topology_1.Layer);exports.LeakyReLU=LeakyReLU,tfjs_core_1.serialization.registerClass(LeakyReLU);var PReLU=function(_super){function PReLU(args){var _this=_super.call(this,null==args?{}:args)||this;if(_this.DEFAULT_ALPHA_INITIALIZER="zeros",null==args&&(args={}),_this.supportsMasking=!0,_this.alphaInitializer=initializers_1.getInitializer(args.alphaInitializer||_this.DEFAULT_ALPHA_INITIALIZER),_this.alphaRegularizer=regularizers_1.getRegularizer(args.alphaRegularizer),_this.alphaConstraint=constraints_1.getConstraint(args.alphaConstraint),null==args.sharedAxes)_this.sharedAxes=null;else if(Array.isArray(args.sharedAxes))_this.sharedAxes=args.sharedAxes;else{if("number"!=typeof args.sharedAxes)throw new errors_1.ValueError("Expected sharedAxes to be a number or an array of numbers, but got "+args.sharedAxes);_this.sharedAxes=[args.sharedAxes]}return _this}return __extends(PReLU,_super),PReLU.prototype.build=function(inputShape){var paramShape=(inputShape=types_utils_1.getExactlyOneShape(inputShape)).slice(1);if(null!=this.sharedAxes)for(var _i=0,_a=this.sharedAxes;_i<_a.length;_i++){paramShape[(i=_a[_i])-1]=1}this.alpha=this.addWeight("alpha",paramShape,"float32",this.alphaInitializer,this.alphaRegularizer,!0,this.alphaConstraint);var axes={};if(null!=this.sharedAxes)for(var i=1;i<inputShape.length;++i)axes[i]=inputShape[i];this.inputSpec=[new topology_1.InputSpec({ndim:inputShape.length,axes:axes})],this.built=!0},PReLU.prototype.call=function(inputs,kwargs){return inputs=types_utils_1.getExactlyOneTensor(inputs),tfjs_core_1.prelu(inputs,this.alpha.read())},PReLU.prototype.getConfig=function(){var config={alphaInitializer:initializers_1.serializeInitializer(this.alphaInitializer),alphaRegularizer:regularizers_1.serializeRegularizer(this.alphaRegularizer),alphaConstraint:constraints_1.serializeConstraint(this.alphaConstraint),sharedAxes:this.sharedAxes},baseConfig=_super.prototype.getConfig.call(this);return Object.assign(config,baseConfig),config},PReLU.className="PReLU",PReLU}(topology_1.Layer);exports.PReLU=PReLU,tfjs_core_1.serialization.registerClass(PReLU);var ELU=function(_super){function ELU(args){var _this=_super.call(this,null==args?{}:args)||this;if(_this.DEFAULT_ALPHA=1,null==args&&(args={}),null!=args.alpha&&args.alpha!==_this.DEFAULT_ALPHA)throw new errors_1.NotImplementedError("Non-default alpha value ("+args.alpha+") is not supported by the ELU layer yet.");return _this.alpha=null==args.alpha?_this.DEFAULT_ALPHA:args.alpha,_this}return __extends(ELU,_super),ELU.prototype.call=function(inputs,kwargs){var x=types_utils_1.getExactlyOneTensor(inputs);return tfjs_core_1.elu(x)},ELU.prototype.computeOutputShape=function(inputShape){return inputShape},ELU.prototype.getConfig=function(){var config={alpha:this.alpha},baseConfig=_super.prototype.getConfig.call(this);return Object.assign(config,baseConfig),config},ELU.className="ELU",ELU}(topology_1.Layer);exports.ELU=ELU,tfjs_core_1.serialization.registerClass(ELU);var ThresholdedReLU=function(_super){function ThresholdedReLU(args){var _this=_super.call(this,null==args?{}:args)||this;return _this.DEFAULT_THETA=1,null==args&&(args={}),_this.theta=null==args.theta?_this.DEFAULT_THETA:args.theta,_this}return __extends(ThresholdedReLU,_super),ThresholdedReLU.prototype.call=function(inputs,kwargs){var x=types_utils_1.getExactlyOneTensor(inputs);return x.mul(tfjs_backend_1.cast(x.greater(this.theta),"float32"))},ThresholdedReLU.prototype.computeOutputShape=function(inputShape){return inputShape},ThresholdedReLU.prototype.getConfig=function(){var config={theta:this.theta},baseConfig=_super.prototype.getConfig.call(this);return Object.assign(config,baseConfig),config},ThresholdedReLU.className="ThresholdedReLU",ThresholdedReLU}(topology_1.Layer);exports.ThresholdedReLU=ThresholdedReLU,tfjs_core_1.serialization.registerClass(ThresholdedReLU);var Softmax=function(_super){function Softmax(args){var _this=_super.call(this,null==args?{}:args)||this;return _this.DEFAULT_AXIS=1,null==args&&(args={}),_this.softmax=(new activations_1.Softmax).apply,_this.axis=null==args.axis?_this.DEFAULT_AXIS:args.axis,_this}return __extends(Softmax,_super),Softmax.prototype.call=function(inputs,kwargs){var x=types_utils_1.getExactlyOneTensor(inputs);return this.softmax(x,this.axis)},Softmax.prototype.computeOutputShape=function(inputShape){return inputShape},Softmax.prototype.getConfig=function(){var config={axis:this.axis},baseConfig=_super.prototype.getConfig.call(this);return Object.assign(config,baseConfig),config},Softmax.className="Softmax",Softmax}(topology_1.Layer);exports.Softmax=Softmax,tfjs_core_1.serialization.registerClass(Softmax)},{"../activations":273,"../backend/tfjs_backend":276,"../constraints":280,"../engine/topology":284,"../errors":289,"../initializers":298,"../regularizers":319,"../utils/types_utils":326,"@tensorflow/tfjs-core":148}],302:[function(require,module,exports){"use strict";var extendStatics,__extends=this&&this.__extends||(extendStatics=function(d,b){return(extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p])})(d,b)},function(d,b){function __(){this.constructor=d}extendStatics(d,b),d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)});Object.defineProperty(exports,"__esModule",{value:!0});var tfc=require("@tensorflow/tfjs-core"),tfjs_core_1=require("@tensorflow/tfjs-core"),activations_1=require("../activations"),common_1=require("../backend/common"),K=require("../backend/tfjs_backend"),common_2=require("../common"),constraints_1=require("../constraints"),topology_1=require("../engine/topology"),errors_1=require("../errors"),initializers_1=require("../initializers"),regularizers_1=require("../regularizers"),conv_utils_1=require("../utils/conv_utils"),generic_utils=require("../utils/generic_utils"),types_utils_1=require("../utils/types_utils");function preprocessConv2DInput(x,dataFormat){return tfjs_core_1.tidy(function(){return common_2.checkDataFormat(dataFormat),"channelsFirst"===dataFormat?tfc.transpose(x,[0,2,3,1]):x})}function preprocessConv3DInput(x,dataFormat){return tfjs_core_1.tidy(function(){return common_2.checkDataFormat(dataFormat),"channelsFirst"===dataFormat?tfc.transpose(x,[0,2,3,4,1]):x})}function conv1dWithBias(x,kernel,bias,strides,padding,dataFormat,dilationRate){return void 0===strides&&(strides=1),void 0===padding&&(padding="valid"),void 0===dilationRate&&(dilationRate=1),tfjs_core_1.tidy(function(){if(null==dataFormat&&(dataFormat=common_1.imageDataFormat()),common_2.checkDataFormat(dataFormat),3!==x.shape.length)throw new errors_1.ValueError("The input of a conv1dWithBias operation should be 3, but is "+x.shape.length+" instead.");if(3!==kernel.shape.length)throw new errors_1.ValueError("The kernel for a conv1dWithBias operation should be 3, but is "+kernel.shape.length+" instead");if(null!=bias&&1!==bias.shape.length)throw new errors_1.ValueError("The bias for a conv1dWithBias operation should be 1, but is "+kernel.shape.length+" instead");if("channelsFirst"===dataFormat&&(x=tfc.transpose(x,[0,2,1])),"causal"===padding)throw new errors_1.NotImplementedError("The support for CAUSAL padding mode in conv1dWithBias is not implemented yet.");var y=tfc.conv1d(x,kernel,strides,"same"===padding?"same":"valid","NWC",dilationRate);return null!=bias&&(y=K.biasAdd(y,bias)),y})}function conv2dWithBiasActivation(x,kernel,bias,strides,padding,dataFormat,dilationRate,activation){return void 0===strides&&(strides=[1,1]),void 0===padding&&(padding="valid"),void 0===activation&&(activation=null),tfjs_core_1.tidy(function(){if(null==dataFormat&&(dataFormat=common_1.imageDataFormat()),common_2.checkDataFormat(dataFormat),3!==x.rank&&4!==x.rank)throw new errors_1.ValueError("conv2dWithBiasActivation expects input to be of rank 3 or 4, but received "+x.rank+".");if(3!==kernel.rank&&4!==kernel.rank)throw new errors_1.ValueError("conv2dWithBiasActivation expects kernel to be of rank 3 or 4, but received "+x.rank+".");var y=preprocessConv2DInput(x,dataFormat);if("causal"===padding)throw new errors_1.NotImplementedError("The support for CAUSAL padding mode in conv1dWithBias is not implemented yet.");return y=tfc.fused.conv2d({x:y,filter:kernel,strides:strides,pad:"same"===padding?"same":"valid",dilations:dilationRate,dataFormat:"NHWC",bias:bias,activation:activation}),"channelsFirst"===dataFormat&&(y=tfc.transpose(y,[0,3,1,2])),y})}function conv3dWithBias(x,kernel,bias,strides,padding,dataFormat,dilationRate){return void 0===strides&&(strides=[1,1,1]),void 0===padding&&(padding="valid"),tfjs_core_1.tidy(function(){if(null==dataFormat&&(dataFormat=common_1.imageDataFormat()),common_2.checkDataFormat(dataFormat),4!==x.rank&&5!==x.rank)throw new errors_1.ValueError("conv3dWithBias expects input to be of rank 4 or 5, but received "+x.rank+".");if(4!==kernel.rank&&5!==kernel.rank)throw new errors_1.ValueError("conv3dWithBias expects kernel to be of rank 4 or 5, but received "+x.rank+".");var y=preprocessConv3DInput(x,dataFormat);if("causal"===padding)throw new errors_1.NotImplementedError("The support for CAUSAL padding mode in conv3dWithBias is not implemented yet.");return y=tfc.conv3d(y,kernel,strides,"same"===padding?"same":"valid","NDHWC",dilationRate),null!=bias&&(y=K.biasAdd(y,bias)),"channelsFirst"===dataFormat&&(y=tfc.transpose(y,[0,4,1,2,3])),y})}exports.preprocessConv2DInput=preprocessConv2DInput,exports.preprocessConv3DInput=preprocessConv3DInput,exports.conv1dWithBias=conv1dWithBias,exports.conv1d=function(x,kernel,strides,padding,dataFormat,dilationRate){return void 0===strides&&(strides=1),void 0===padding&&(padding="valid"),void 0===dilationRate&&(dilationRate=1),tfjs_core_1.tidy(function(){return common_2.checkDataFormat(dataFormat),conv1dWithBias(x,kernel,null,strides,padding,dataFormat,dilationRate)})},exports.conv2d=function(x,kernel,strides,padding,dataFormat,dilationRate){return void 0===strides&&(strides=[1,1]),void 0===padding&&(padding="valid"),tfjs_core_1.tidy(function(){return common_2.checkDataFormat(dataFormat),conv2dWithBiasActivation(x,kernel,null,strides,padding,dataFormat,dilationRate)})},exports.conv2dWithBiasActivation=conv2dWithBiasActivation,exports.conv3d=function(x,kernel,strides,padding,dataFormat,dilationRate){return void 0===strides&&(strides=[1,1,1]),void 0===padding&&(padding="valid"),tfjs_core_1.tidy(function(){return common_2.checkDataFormat(dataFormat),conv3dWithBias(x,kernel,null,strides,padding,dataFormat,dilationRate)})},exports.conv3dWithBias=conv3dWithBias;var BaseConv=function(_super){function BaseConv(rank,args){var _this=_super.call(this,args)||this;if(_this.bias=null,_this.DEFAULT_KERNEL_INITIALIZER="glorotNormal",_this.DEFAULT_BIAS_INITIALIZER="zeros",BaseConv.verifyArgs(args),_this.rank=rank,generic_utils.assertPositiveInteger(_this.rank,"rank"),1!==_this.rank&&2!==_this.rank&&3!==_this.rank)throw new errors_1.NotImplementedError("Convolution layer for rank other than 1, 2, or 3 ("+_this.rank+") is not implemented yet.");if(_this.kernelSize=conv_utils_1.normalizeArray(args.kernelSize,rank,"kernelSize"),_this.strides=conv_utils_1.normalizeArray(null==args.strides?1:args.strides,rank,"strides"),_this.padding=null==args.padding?"valid":args.padding,common_2.checkPaddingMode(_this.padding),_this.dataFormat=null==args.dataFormat?"channelsLast":args.dataFormat,common_2.checkDataFormat(_this.dataFormat),_this.activation=activations_1.getActivation(args.activation),_this.useBias=null==args.useBias||args.useBias,_this.biasInitializer=initializers_1.getInitializer(args.biasInitializer||_this.DEFAULT_BIAS_INITIALIZER),_this.biasConstraint=constraints_1.getConstraint(args.biasConstraint),_this.biasRegularizer=regularizers_1.getRegularizer(args.biasRegularizer),_this.activityRegularizer=regularizers_1.getRegularizer(args.activityRegularizer),_this.dilationRate=conv_utils_1.normalizeArray(null==args.dilationRate?1:args.dilationRate,rank,"dilationRate"),1===_this.rank&&Array.isArray(_this.dilationRate)&&1!==_this.dilationRate.length)throw new errors_1.ValueError("dilationRate must be a number or an array of a single number for 1D convolution, but received "+JSON.stringify(_this.dilationRate));if(2===_this.rank){if("number"==typeof _this.dilationRate)_this.dilationRate=[_this.dilationRate,_this.dilationRate];else if(2!==_this.dilationRate.length)throw new errors_1.ValueError("dilationRate must be a number or array of two numbers for 2D convolution, but received "+JSON.stringify(_this.dilationRate))}else if(3===_this.rank)if("number"==typeof _this.dilationRate)_this.dilationRate=[_this.dilationRate,_this.dilationRate,_this.dilationRate];else if(3!==_this.dilationRate.length)throw new errors_1.ValueError("dilationRate must be a number or array of three numbers for 3D convolution, but received "+JSON.stringify(_this.dilationRate));return _this}return __extends(BaseConv,_super),BaseConv.verifyArgs=function(args){if(generic_utils.assert("kernelSize"in args,"required key 'kernelSize' not in config"),"number"!=typeof args.kernelSize&&!generic_utils.checkArrayTypeAndLength(args.kernelSize,"number",1,3))throw new errors_1.ValueError("BaseConv expects config.kernelSize to be number or number[] with length 1, 2, or 3, but received "+JSON.stringify(args.kernelSize)+".")},BaseConv.prototype.getConfig=function(){var config={kernelSize:this.kernelSize,strides:this.strides,padding:this.padding,dataFormat:this.dataFormat,dilationRate:this.dilationRate,activation:activations_1.serializeActivation(this.activation),useBias:this.useBias,biasInitializer:initializers_1.serializeInitializer(this.biasInitializer),biasRegularizer:regularizers_1.serializeRegularizer(this.biasRegularizer),activityRegularizer:regularizers_1.serializeRegularizer(this.activityRegularizer),biasConstraint:constraints_1.serializeConstraint(this.biasConstraint)},baseConfig=_super.prototype.getConfig.call(this);return Object.assign(config,baseConfig),config},BaseConv}(topology_1.Layer),Conv=function(_super){function Conv(rank,args){var _this=_super.call(this,rank,args)||this;return _this.kernel=null,Conv.verifyArgs(args),_this.filters=args.filters,generic_utils.assertPositiveInteger(_this.filters,"filters"),_this.kernelInitializer=initializers_1.getInitializer(args.kernelInitializer||_this.DEFAULT_KERNEL_INITIALIZER),_this.kernelConstraint=constraints_1.getConstraint(args.kernelConstraint),_this.kernelRegularizer=regularizers_1.getRegularizer(args.kernelRegularizer),_this}return __extends(Conv,_super),Conv.prototype.build=function(inputShape){var _a;inputShape=types_utils_1.getExactlyOneShape(inputShape);var channelAxis="channelsFirst"===this.dataFormat?1:inputShape.length-1;if(null==inputShape[channelAxis])throw new errors_1.ValueError("The channel dimension of the input should be defined. Found "+inputShape[channelAxis]);var inputDim=inputShape[channelAxis],kernelShape=this.kernelSize.concat([inputDim,this.filters]);this.kernel=this.addWeight("kernel",kernelShape,null,this.kernelInitializer,this.kernelRegularizer,!0,this.kernelConstraint),this.useBias&&(this.bias=this.addWeight("bias",[this.filters],null,this.biasInitializer,this.biasRegularizer,!0,this.biasConstraint)),this.inputSpec=[{ndim:this.rank+2,axes:(_a={},_a[channelAxis]=inputDim,_a)}],this.built=!0},Conv.prototype.call=function(inputs,kwargs){var _this=this;return tfjs_core_1.tidy(function(){var outputs;inputs=types_utils_1.getExactlyOneTensor(inputs);var biasValue=null==_this.bias?null:_this.bias.read(),fusedActivationName=function(activationName){return"relu"===activationName?"relu":"linear"===activationName?"linear":null}(_this.activation.getClassName());if(null!=fusedActivationName&&2===_this.rank)outputs=conv2dWithBiasActivation(inputs,_this.kernel.read(),biasValue,_this.strides,_this.padding,_this.dataFormat,_this.dilationRate,fusedActivationName);else{if(1===_this.rank)outputs=conv1dWithBias(inputs,_this.kernel.read(),biasValue,_this.strides[0],_this.padding,_this.dataFormat,_this.dilationRate[0]);else if(2===_this.rank)outputs=conv2dWithBiasActivation(inputs,_this.kernel.read(),biasValue,_this.strides,_this.padding,_this.dataFormat,_this.dilationRate);else{if(3!==_this.rank)throw new errors_1.NotImplementedError("convolutions greater than 3D are not implemented yet.");outputs=conv3dWithBias(inputs,_this.kernel.read(),biasValue,_this.strides,_this.padding,_this.dataFormat,_this.dilationRate)}null!=_this.activation&&(outputs=_this.activation.apply(outputs))}return outputs})},Conv.prototype.computeOutputShape=function(inputShape){inputShape=types_utils_1.getExactlyOneShape(inputShape);for(var newSpace=[],space="channelsLast"===this.dataFormat?inputShape.slice(1,inputShape.length-1):inputShape.slice(2),i=0;i<space.length;++i){var newDim=conv_utils_1.convOutputLength(space[i],this.kernelSize[i],this.padding,this.strides[i],"number"==typeof this.dilationRate?this.dilationRate:this.dilationRate[i]);newSpace.push(newDim)}var outputShape=[inputShape[0]];return"channelsLast"===this.dataFormat?(outputShape=outputShape.concat(newSpace)).push(this.filters):(outputShape.push(this.filters),outputShape=outputShape.concat(newSpace)),outputShape},Conv.prototype.getConfig=function(){var config={filters:this.filters,kernelInitializer:initializers_1.serializeInitializer(this.kernelInitializer),kernelRegularizer:regularizers_1.serializeRegularizer(this.kernelRegularizer),kernelConstraint:constraints_1.serializeConstraint(this.kernelConstraint)},baseConfig=_super.prototype.getConfig.call(this);return Object.assign(config,baseConfig),config},Conv.verifyArgs=function(args){if(!("filters"in args)||"number"!=typeof args.filters||args.filters<1)throw new errors_1.ValueError("Convolution layer expected config.filters to be a 'number' > 0 but got "+JSON.stringify(args.filters))},Conv}(exports.BaseConv=BaseConv),Conv2D=function(_super){function Conv2D(args){var _this=_super.call(this,2,args)||this;return Conv2D.verifyArgs(args),_this}return __extends(Conv2D,_super),Conv2D.prototype.getConfig=function(){var config=_super.prototype.getConfig.call(this);return delete config.rank,config},Conv2D.verifyArgs=function(args){if("number"!=typeof args.kernelSize&&!generic_utils.checkArrayTypeAndLength(args.kernelSize,"number",1,2))throw new errors_1.ValueError("Conv2D expects config.kernelSize to be number or number[] with length 1 or 2, but received "+JSON.stringify(args.kernelSize)+".")},Conv2D.className="Conv2D",Conv2D}(exports.Conv=Conv);exports.Conv2D=Conv2D,tfjs_core_1.serialization.registerClass(Conv2D);var Conv3D=function(_super){function Conv3D(args){var _this=_super.call(this,3,args)||this;return Conv3D.verifyArgs(args),_this}return __extends(Conv3D,_super),Conv3D.prototype.getConfig=function(){var config=_super.prototype.getConfig.call(this);return delete config.rank,config},Conv3D.verifyArgs=function(args){if("number"!=typeof args.kernelSize&&(!Array.isArray(args.kernelSize)||1!==args.kernelSize.length&&3!==args.kernelSize.length))throw new errors_1.ValueError("Conv3D expects config.kernelSize to be number or [number, number, number], but received "+JSON.stringify(args.kernelSize)+".")},Conv3D.className="Conv3D",Conv3D}(Conv);exports.Conv3D=Conv3D,tfjs_core_1.serialization.registerClass(Conv3D);var Conv2DTranspose=function(_super){function Conv2DTranspose(args){var _this=_super.call(this,args)||this;if(_this.inputSpec=[new topology_1.InputSpec({ndim:4})],"same"!==_this.padding&&"valid"!==_this.padding)throw new errors_1.ValueError("Conv2DTranspose currently supports only padding modes 'same' and 'valid', but received padding mode "+_this.padding);return _this}return __extends(Conv2DTranspose,_super),Conv2DTranspose.prototype.build=function(inputShape){var _a;if(4!==(inputShape=types_utils_1.getExactlyOneShape(inputShape)).length)throw new errors_1.ValueError("Input should have rank 4; Received input shape: "+JSON.stringify(inputShape));var channelAxis="channelsFirst"===this.dataFormat?1:inputShape.length-1;if(null==inputShape[channelAxis])throw new errors_1.ValueError("The channel dimension of the inputs should be defined. Found `None`.");var inputDim=inputShape[channelAxis],kernelShape=this.kernelSize.concat([this.filters,inputDim]);this.kernel=this.addWeight("kernel",kernelShape,"float32",this.kernelInitializer,this.kernelRegularizer,!0,this.kernelConstraint),this.useBias&&(this.bias=this.addWeight("bias",[this.filters],"float32",this.biasInitializer,this.biasRegularizer,!0,this.biasConstraint)),this.inputSpec=[new topology_1.InputSpec({ndim:4,axes:(_a={},_a[channelAxis]=inputDim,_a)})],this.built=!0},Conv2DTranspose.prototype.call=function(inputs,kwargs){var _this=this;return tfc.tidy(function(){var input=types_utils_1.getExactlyOneTensor(inputs);if(4!==input.shape.length)throw new errors_1.ValueError("Conv2DTranspose.call() expects input tensor to be rank-4, but received a tensor of rank-"+input.shape.length);var hAxis,wAxis,inputShape=input.shape,batchSize=inputShape[0];wAxis="channelsFirst"===_this.dataFormat?(hAxis=2,3):(hAxis=1,2);var height=inputShape[hAxis],width=inputShape[wAxis],kernelH=_this.kernelSize[0],kernelW=_this.kernelSize[1],strideH=_this.strides[0],strideW=_this.strides[1],outputShape=[batchSize,conv_utils_1.deconvLength(height,strideH,kernelH,_this.padding),conv_utils_1.deconvLength(width,strideW,kernelW,_this.padding),_this.filters];"channelsLast"!==_this.dataFormat&&(input=tfc.transpose(input,[0,2,3,1]));var outputs=tfc.conv2dTranspose(input,_this.kernel.read(),outputShape,_this.strides,_this.padding);return"channelsLast"!==_this.dataFormat&&(outputs=tfc.transpose(outputs,[0,3,1,2])),null!=_this.bias&&(outputs=K.biasAdd(outputs,_this.bias.read(),_this.dataFormat)),null!=_this.activation&&(outputs=_this.activation.apply(outputs)),outputs})},Conv2DTranspose.prototype.computeOutputShape=function(inputShape){var channelAxis,heightAxis,widthAxis,outputShape=(inputShape=types_utils_1.getExactlyOneShape(inputShape)).slice();widthAxis="channelsFirst"===this.dataFormat?(channelAxis=1,heightAxis=2,3):(channelAxis=3,heightAxis=1,2);var kernelH=this.kernelSize[0],kernelW=this.kernelSize[1],strideH=this.strides[0],strideW=this.strides[1];return outputShape[channelAxis]=this.filters,outputShape[heightAxis]=conv_utils_1.deconvLength(outputShape[heightAxis],strideH,kernelH,this.padding),outputShape[widthAxis]=conv_utils_1.deconvLength(outputShape[widthAxis],strideW,kernelW,this.padding),outputShape},Conv2DTranspose.prototype.getConfig=function(){var config=_super.prototype.getConfig.call(this);return delete config.dilationRate,config},Conv2DTranspose.className="Conv2DTranspose",Conv2DTranspose}(Conv2D);exports.Conv2DTranspose=Conv2DTranspose,tfjs_core_1.serialization.registerClass(Conv2DTranspose);var SeparableConv=function(_super){function SeparableConv(rank,config){var _this=_super.call(this,rank,config)||this;if(_this.DEFAULT_DEPTHWISE_INITIALIZER="glorotUniform",_this.DEFAULT_POINTWISE_INITIALIZER="glorotUniform",_this.depthwiseKernel=null,(_this.pointwiseKernel=null)==config.filters)throw new errors_1.ValueError("The `filters` configuration field is required by SeparableConv, but is unspecified.");if(null!=config.kernelInitializer||null!=config.kernelRegularizer||null!=config.kernelConstraint)throw new errors_1.ValueError("Fields kernelInitializer, kernelRegularizer and kernelConstraint are invalid for SeparableConv2D. Use depthwiseInitializer, depthwiseRegularizer, depthwiseConstraint, pointwiseInitializer, pointwiseRegularizer and pointwiseConstraint instead.");if(null!=config.padding&&"same"!==config.padding&&"valid"!==config.padding)throw new errors_1.ValueError("SeparableConv"+_this.rank+"D supports only padding modes: 'same' and 'valid', but received "+JSON.stringify(config.padding));return _this.depthMultiplier=null==config.depthMultiplier?1:config.depthMultiplier,_this.depthwiseInitializer=initializers_1.getInitializer(config.depthwiseInitializer||_this.DEFAULT_DEPTHWISE_INITIALIZER),_this.depthwiseRegularizer=regularizers_1.getRegularizer(config.depthwiseRegularizer),_this.depthwiseConstraint=constraints_1.getConstraint(config.depthwiseConstraint),_this.pointwiseInitializer=initializers_1.getInitializer(config.depthwiseInitializer||_this.DEFAULT_POINTWISE_INITIALIZER),_this.pointwiseRegularizer=regularizers_1.getRegularizer(config.pointwiseRegularizer),_this.pointwiseConstraint=constraints_1.getConstraint(config.pointwiseConstraint),_this}return __extends(SeparableConv,_super),SeparableConv.prototype.build=function(inputShape){var _a;if((inputShape=types_utils_1.getExactlyOneShape(inputShape)).length<this.rank+2)throw new errors_1.ValueError("Inputs to SeparableConv"+this.rank+"D should have rank "+(this.rank+2)+", but received input shape: "+JSON.stringify(inputShape));var channelAxis="channelsFirst"===this.dataFormat?1:inputShape.length-1;if(null==inputShape[channelAxis]||inputShape[channelAxis]<0)throw new errors_1.ValueError("The channel dimension of the inputs should be defined, but found "+JSON.stringify(inputShape[channelAxis]));for(var inputDim=inputShape[channelAxis],depthwiseKernelShape=this.kernelSize.concat([inputDim,this.depthMultiplier]),pointwiseKernelShape=[],i=0;i<this.rank;++i)pointwiseKernelShape.push(1);pointwiseKernelShape.push(inputDim*this.depthMultiplier,this.filters);this.depthwiseKernel=this.addWeight("depthwise_kernel",depthwiseKernelShape,"float32",this.depthwiseInitializer,this.depthwiseRegularizer,!0,this.depthwiseConstraint),this.pointwiseKernel=this.addWeight("pointwise_kernel",pointwiseKernelShape,"float32",this.pointwiseInitializer,this.pointwiseRegularizer,!0,this.pointwiseConstraint),this.useBias?this.bias=this.addWeight("bias",[this.filters],"float32",this.biasInitializer,this.biasRegularizer,!0,this.biasConstraint):this.bias=null,this.inputSpec=[new topology_1.InputSpec({ndim:this.rank+2,axes:(_a={},_a[channelAxis]=inputDim,_a)})],this.built=!0},SeparableConv.prototype.call=function(inputs,kwargs){var _this=this;return tfjs_core_1.tidy(function(){var output;if(inputs=types_utils_1.getExactlyOneTensor(inputs),1===_this.rank)throw new errors_1.NotImplementedError("1D separable convolution is not implemented yet.");return 2===_this.rank&&("channelsFirst"===_this.dataFormat&&(inputs=tfc.transpose(inputs,[0,2,3,1])),output=tfc.separableConv2d(inputs,_this.depthwiseKernel.read(),_this.pointwiseKernel.read(),_this.strides,_this.padding,_this.dilationRate,"NHWC")),_this.useBias&&(output=K.biasAdd(output,_this.bias.read(),_this.dataFormat)),null!=_this.activation&&(output=_this.activation.apply(output)),"channelsFirst"===_this.dataFormat&&(output=tfc.transpose(output,[0,3,1,2])),output})},SeparableConv.prototype.getConfig=function(){var config=_super.prototype.getConfig.call(this);return delete config.rank,delete config.kernelInitializer,delete config.kernelRegularizer,delete config.kernelConstraint,config.depthwiseInitializer=initializers_1.serializeInitializer(this.depthwiseInitializer),config.pointwiseInitializer=initializers_1.serializeInitializer(this.pointwiseInitializer),config.depthwiseRegularizer=regularizers_1.serializeRegularizer(this.depthwiseRegularizer),config.pointwiseRegularizer=regularizers_1.serializeRegularizer(this.pointwiseRegularizer),config.depthwiseConstraint=constraints_1.serializeConstraint(this.depthwiseConstraint),config.pointwiseConstraint=constraints_1.serializeConstraint(this.pointwiseConstraint),config},SeparableConv.className="SeparableConv",SeparableConv}(Conv),SeparableConv2D=function(_super){function SeparableConv2D(args){return _super.call(this,2,args)||this}return __extends(SeparableConv2D,_super),SeparableConv2D.className="SeparableConv2D",SeparableConv2D}(exports.SeparableConv=SeparableConv);exports.SeparableConv2D=SeparableConv2D,tfjs_core_1.serialization.registerClass(SeparableConv2D);var Conv1D=function(_super){function Conv1D(args){var _this=_super.call(this,1,args)||this;return Conv1D.verifyArgs(args),_this.inputSpec=[{ndim:3}],_this}return __extends(Conv1D,_super),Conv1D.prototype.getConfig=function(){var config=_super.prototype.getConfig.call(this);return delete config.rank,delete config.dataFormat,config},Conv1D.verifyArgs=function(args){if("number"!=typeof args.kernelSize&&!generic_utils.checkArrayTypeAndLength(args.kernelSize,"number",1,1))throw new errors_1.ValueError("Conv1D expects config.kernelSize to be number or number[] with length 1, but received "+JSON.stringify(args.kernelSize)+".")},Conv1D.className="Conv1D",Conv1D}(Conv);exports.Conv1D=Conv1D,tfjs_core_1.serialization.registerClass(Conv1D);var Cropping2D=function(_super){function Cropping2D(args){var _this=_super.call(this,args)||this;return"number"==typeof args.cropping?_this.cropping=[[args.cropping,args.cropping],[args.cropping,args.cropping]]:"number"==typeof args.cropping[0]?_this.cropping=[[args.cropping[0],args.cropping[0]],[args.cropping[1],args.cropping[1]]]:_this.cropping=args.cropping,_this.dataFormat=void 0===args.dataFormat?"channelsLast":args.dataFormat,_this.inputSpec=[{ndim:4}],_this}return __extends(Cropping2D,_super),Cropping2D.prototype.computeOutputShape=function(inputShape){return"channelsFirst"===this.dataFormat?[inputShape[0],inputShape[1],inputShape[2]-this.cropping[0][0]-this.cropping[0][1],inputShape[3]-this.cropping[1][0]-this.cropping[1][1]]:[inputShape[0],inputShape[1]-this.cropping[0][0]-this.cropping[0][1],inputShape[2]-this.cropping[1][0]-this.cropping[1][1],inputShape[3]]},Cropping2D.prototype.call=function(inputs,kwargs){var _this=this;return tfjs_core_1.tidy(function(){if(inputs=types_utils_1.getExactlyOneTensor(inputs),"channelsLast"===_this.dataFormat){var hSliced=K.sliceAlongAxis(inputs,_this.cropping[0][0],inputs.shape[1]-_this.cropping[0][0]-_this.cropping[0][1],2);return K.sliceAlongAxis(hSliced,_this.cropping[1][0],inputs.shape[2]-_this.cropping[1][1]-_this.cropping[1][0],3)}hSliced=K.sliceAlongAxis(inputs,_this.cropping[0][0],inputs.shape[2]-_this.cropping[0][0]-_this.cropping[0][1],3);return K.sliceAlongAxis(hSliced,_this.cropping[1][0],inputs.shape[3]-_this.cropping[1][1]-_this.cropping[1][0],4)})},Cropping2D.prototype.getConfig=function(){var config={cropping:this.cropping,dataFormat:this.dataFormat},baseConfig=_super.prototype.getConfig.call(this);return Object.assign(config,baseConfig),config},Cropping2D.className="Cropping2D",Cropping2D}(topology_1.Layer);exports.Cropping2D=Cropping2D,tfjs_core_1.serialization.registerClass(Cropping2D);var UpSampling2D=function(_super){function UpSampling2D(args){var _this=_super.call(this,args)||this;return _this.DEFAULT_SIZE=[2,2],_this.inputSpec=[{ndim:4}],_this.size=null==args.size?_this.DEFAULT_SIZE:args.size,_this.dataFormat=null==args.dataFormat?"channelsLast":args.dataFormat,_this}return __extends(UpSampling2D,_super),UpSampling2D.prototype.computeOutputShape=function(inputShape){if("channelsFirst"===this.dataFormat){var height=null==inputShape[2]?null:this.size[0]*inputShape[2],width=null==inputShape[3]?null:this.size[1]*inputShape[3];return[inputShape[0],inputShape[1],height,width]}height=null==inputShape[1]?null:this.size[0]*inputShape[1],width=null==inputShape[2]?null:this.size[1]*inputShape[2];return[inputShape[0],height,width,inputShape[3]]},UpSampling2D.prototype.call=function(inputs,kwargs){var _this=this;return tfc.tidy(function(){var input=types_utils_1.getExactlyOneTensor(inputs),inputShape=input.shape;if("channelsFirst"===_this.dataFormat){input=tfc.transpose(input,[0,2,3,1]);var height=_this.size[0]*inputShape[2],width=_this.size[1]*inputShape[3],resized=input.resizeNearestNeighbor([height,width]);return tfc.transpose(resized,[0,3,1,2])}height=_this.size[0]*inputShape[1],width=_this.size[1]*inputShape[2];return input.resizeNearestNeighbor([height,width])})},UpSampling2D.prototype.getConfig=function(){var config={size:this.size,dataFormat:this.dataFormat},baseConfig=_super.prototype.getConfig.call(this);return Object.assign(config,baseConfig),config},UpSampling2D.className="UpSampling2D",UpSampling2D}(topology_1.Layer);exports.UpSampling2D=UpSampling2D,tfjs_core_1.serialization.registerClass(UpSampling2D)},{"../activations":273,"../backend/common":274,"../backend/tfjs_backend":276,"../common":279,"../constraints":280,"../engine/topology":284,"../errors":289,"../initializers":298,"../regularizers":319,"../utils/conv_utils":321,"../utils/generic_utils":322,"../utils/types_utils":326,"@tensorflow/tfjs-core":148}],303:[function(require,module,exports){"use strict";var extendStatics,__extends=this&&this.__extends||(extendStatics=function(d,b){return(extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p])})(d,b)},function(d,b){function __(){this.constructor=d}extendStatics(d,b),d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)});Object.defineProperty(exports,"__esModule",{value:!0});var tfc=require("@tensorflow/tfjs-core"),tfjs_core_1=require("@tensorflow/tfjs-core"),common_1=require("../backend/common"),K=require("../backend/tfjs_backend"),common_2=require("../common"),constraints_1=require("../constraints"),errors_1=require("../errors"),initializers_1=require("../initializers"),regularizers_1=require("../regularizers"),conv_utils_1=require("../utils/conv_utils"),types_utils_1=require("../utils/types_utils"),convolutional_1=require("./convolutional");function depthwiseConv2d(x,depthwiseKernel,strides,padding,dataFormat,dilationRate){return void 0===strides&&(strides=[1,1]),void 0===padding&&(padding="valid"),tfjs_core_1.tidy(function(){null==dataFormat&&(dataFormat=common_1.imageDataFormat()),common_2.checkDataFormat(dataFormat);var y=convolutional_1.preprocessConv2DInput(x,dataFormat);if(4!==x.rank)throw new errors_1.ValueError("Input for depthwiseConv2d is required to be 4-D, but is instead "+x.rank+"-D");if(4!==depthwiseKernel.rank)throw new errors_1.ValueError("depthwiseKernel is required to be 4-D, but is instead "+depthwiseKernel.rank+"-D");return y=tfc.depthwiseConv2d(y,depthwiseKernel,strides,"same"===padding?"same":"valid","NHWC",dilationRate),"channelsFirst"===dataFormat&&(y=tfc.transpose(y,[0,3,1,2])),y})}exports.depthwiseConv2d=depthwiseConv2d;var DepthwiseConv2D=function(_super){function DepthwiseConv2D(args){var _this=_super.call(this,2,args)||this;return _this.depthwiseKernel=null,_this.depthMultiplier=null==args.depthMultiplier?1:args.depthMultiplier,_this.depthwiseInitializer=initializers_1.getInitializer(args.depthwiseInitializer||_this.DEFAULT_KERNEL_INITIALIZER),_this.depthwiseConstraint=constraints_1.getConstraint(args.depthwiseConstraint),_this.depthwiseRegularizer=regularizers_1.getRegularizer(args.depthwiseRegularizer),_this}return __extends(DepthwiseConv2D,_super),DepthwiseConv2D.prototype.build=function(inputShape){if((inputShape=types_utils_1.getExactlyOneShape(inputShape)).length<4)throw new errors_1.ValueError("Inputs to DepthwiseConv2D should have rank 4. Received input shape: "+JSON.stringify(inputShape)+".");var channelAxis="channelsFirst"===this.dataFormat?1:3;if(null==inputShape[channelAxis]||inputShape[channelAxis]<0)throw new errors_1.ValueError("The channel dimension of the inputs to DepthwiseConv2D should be defined, but is not ("+inputShape[channelAxis]+").");var inputDim=inputShape[channelAxis],depthwiseKernelShape=[this.kernelSize[0],this.kernelSize[1],inputDim,this.depthMultiplier];this.depthwiseKernel=this.addWeight("depthwise_kernel",depthwiseKernelShape,null,this.depthwiseInitializer,this.depthwiseRegularizer,!0,this.depthwiseConstraint),this.useBias?this.bias=this.addWeight("bias",[inputDim*this.depthMultiplier],null,this.biasInitializer,this.biasRegularizer,!0,this.biasConstraint):this.bias=null,this.built=!0},DepthwiseConv2D.prototype.call=function(inputs,kwargs){var _this=this;return tfjs_core_1.tidy(function(){var outputs=depthwiseConv2d(inputs=types_utils_1.getExactlyOneTensor(inputs),_this.depthwiseKernel.read(),_this.strides,_this.padding,_this.dataFormat,null);return _this.useBias&&(outputs=K.biasAdd(outputs,_this.bias.read(),_this.dataFormat)),null!=_this.activation&&(outputs=_this.activation.apply(outputs)),outputs})},DepthwiseConv2D.prototype.computeOutputShape=function(inputShape){inputShape=types_utils_1.getExactlyOneShape(inputShape);var rows="channelsFirst"===this.dataFormat?inputShape[2]:inputShape[1],cols="channelsFirst"===this.dataFormat?inputShape[3]:inputShape[2],outFilters="channelsFirst"===this.dataFormat?inputShape[1]*this.depthMultiplier:inputShape[3]*this.depthMultiplier,outRows=conv_utils_1.convOutputLength(rows,this.kernelSize[0],this.padding,this.strides[0]),outCols=conv_utils_1.convOutputLength(cols,this.kernelSize[1],this.padding,this.strides[1]);return"channelsFirst"===this.dataFormat?[inputShape[0],outFilters,outRows,outCols]:[inputShape[0],outRows,outCols,outFilters]},DepthwiseConv2D.prototype.getConfig=function(){var config=_super.prototype.getConfig.call(this);return config.depthMultiplier=this.depthMultiplier,config.depthwiseInitializer=initializers_1.serializeInitializer(this.depthwiseInitializer),config.depthwiseRegularizer=regularizers_1.serializeRegularizer(this.depthwiseRegularizer),config.depthwiseConstraint=constraints_1.serializeConstraint(this.depthwiseRegularizer),config},DepthwiseConv2D.className="DepthwiseConv2D",DepthwiseConv2D}(convolutional_1.BaseConv);exports.DepthwiseConv2D=DepthwiseConv2D,tfjs_core_1.serialization.registerClass(DepthwiseConv2D)},{"../backend/common":274,"../backend/tfjs_backend":276,"../common":279,"../constraints":280,"../errors":289,"../initializers":298,"../regularizers":319,"../utils/conv_utils":321,"../utils/types_utils":326,"./convolutional":302,"@tensorflow/tfjs-core":148}],304:[function(require,module,exports){"use strict";var extendStatics,__extends=this&&this.__extends||(extendStatics=function(d,b){return(extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p])})(d,b)},function(d,b){function __(){this.constructor=d}extendStatics(d,b),d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)});Object.defineProperty(exports,"__esModule",{value:!0});var tfjs_core_1=require("@tensorflow/tfjs-core"),activations_1=require("../activations"),K=require("../backend/tfjs_backend"),constraints_1=require("../constraints"),topology_1=require("../engine/topology"),errors_1=require("../errors"),initializers_1=require("../initializers"),regularizers_1=require("../regularizers"),generic_utils_1=require("../utils/generic_utils"),math_utils_1=require("../utils/math_utils"),types_utils_1=require("../utils/types_utils");var Dropout=function(_super){function Dropout(args){var _this=_super.call(this,args)||this;return _this.rate=Math.max(Math.min(args.rate,1),0),_this.noiseShape=args.noiseShape,_this.seed=args.seed,_this.supportsMasking=!0,_this}return __extends(Dropout,_super),Dropout.prototype.getNoiseShape=function(input){if(null==this.noiseShape)return this.noiseShape;for(var inputShape=input.shape,noiseShape=[],i=0;i<this.noiseShape.length;++i)noiseShape.push(null==this.noiseShape[i]?inputShape[i]:this.noiseShape[i]);return noiseShape},Dropout.prototype.call=function(inputs,kwargs){var _this=this;return tfjs_core_1.tidy(function(){_this.invokeCallHook(inputs,kwargs);var input=types_utils_1.getExactlyOneTensor(inputs);if(0<_this.rate&&_this.rate<1){var training=null!=kwargs.training&&kwargs.training,noiseShape_1=_this.getNoiseShape(input);return K.inTrainPhase(function(){return K.dropout(input,_this.rate,noiseShape_1,_this.seed)},function(){return input},training)}return inputs})},Dropout.prototype.getConfig=function(){var config={rate:this.rate,noiseShape:this.noiseShape,seed:this.seed},baseConfig=_super.prototype.getConfig.call(this);return Object.assign(config,baseConfig),config},Dropout.prototype.dispose=function(){return _super.prototype.dispose.call(this)},Dropout.className="Dropout",Dropout}(topology_1.Layer);exports.Dropout=Dropout,tfjs_core_1.serialization.registerClass(Dropout);var Dense=function(_super){function Dense(args){var _this=_super.call(this,args)||this;if(_this.activation=null,_this.useBias=!0,_this.kernel=null,_this.bias=null,_this.DEFAULT_KERNEL_INITIALIZER="glorotNormal",_this.DEFAULT_BIAS_INITIALIZER="zeros",null==args.batchInputShape&&null==args.inputShape&&null!=args.inputDim){var batchSize=null;null!=args.batchSize&&(batchSize=args.batchSize),_this.batchInputShape=[batchSize,args.inputDim]}return _this.units=args.units,generic_utils_1.assertPositiveInteger(_this.units,"units"),_this.activation=activations_1.getActivation(args.activation),null!=args.useBias&&(_this.useBias=args.useBias),_this.kernelInitializer=initializers_1.getInitializer(args.kernelInitializer||_this.DEFAULT_KERNEL_INITIALIZER),_this.biasInitializer=initializers_1.getInitializer(args.biasInitializer||_this.DEFAULT_BIAS_INITIALIZER),_this.kernelConstraint=constraints_1.getConstraint(args.kernelConstraint),_this.biasConstraint=constraints_1.getConstraint(args.biasConstraint),_this.kernelRegularizer=regularizers_1.getRegularizer(args.kernelRegularizer),_this.biasRegularizer=regularizers_1.getRegularizer(args.biasRegularizer),_this.activityRegularizer=regularizers_1.getRegularizer(args.activityRegularizer),_this.supportsMasking=!0,_this.inputSpec=[{minNDim:2}],_this}return __extends(Dense,_super),Dense.prototype.build=function(inputShape){var _a,inputLastDim=(inputShape=types_utils_1.getExactlyOneShape(inputShape))[inputShape.length-1];null==this.kernel&&(this.kernel=this.addWeight("kernel",[inputLastDim,this.units],null,this.kernelInitializer,this.kernelRegularizer,!0,this.kernelConstraint),this.useBias&&(this.bias=this.addWeight("bias",[this.units],null,this.biasInitializer,this.biasRegularizer,!0,this.biasConstraint))),this.inputSpec=[{minNDim:2,axes:(_a={},_a[-1]=inputLastDim,_a)}],this.built=!0},Dense.prototype.computeOutputShape=function(inputShape){var outputShape=(inputShape=types_utils_1.getExactlyOneShape(inputShape)).slice();return outputShape[outputShape.length-1]=this.units,outputShape},Dense.prototype.call=function(inputs,kwargs){var _this=this;return tfjs_core_1.tidy(function(){_this.invokeCallHook(inputs,kwargs);var output,input=types_utils_1.getExactlyOneTensor(inputs),fusedActivationName=function(activationName){return"relu"===activationName?"relu":"linear"===activationName?"linear":null}(_this.activation.getClassName());return null!=fusedActivationName?output=K.dot(input,_this.kernel.read(),fusedActivationName,_this.bias?_this.bias.read():null):(output=K.dot(input,_this.kernel.read()),null!=_this.bias&&(output=K.biasAdd(output,_this.bias.read())),null!=_this.activation&&(output=_this.activation.apply(output))),output})},Dense.prototype.getConfig=function(){var config={units:this.units,activation:activations_1.serializeActivation(this.activation),useBias:this.useBias,kernelInitializer:initializers_1.serializeInitializer(this.kernelInitializer),biasInitializer:initializers_1.serializeInitializer(this.biasInitializer),kernelRegularizer:regularizers_1.serializeRegularizer(this.kernelRegularizer),biasRegularizer:regularizers_1.serializeRegularizer(this.biasRegularizer),activityRegularizer:regularizers_1.serializeRegularizer(this.activityRegularizer),kernelConstraint:constraints_1.serializeConstraint(this.kernelConstraint),biasConstraint:constraints_1.serializeConstraint(this.biasConstraint)},baseConfig=_super.prototype.getConfig.call(this);return Object.assign(config,baseConfig),config},Dense.className="Dense",Dense}(topology_1.Layer);exports.Dense=Dense,tfjs_core_1.serialization.registerClass(Dense);var Flatten=function(_super){function Flatten(args){var _this=_super.call(this,args||{})||this;return _this.inputSpec=[{minNDim:3}],_this}return __extends(Flatten,_super),Flatten.prototype.computeOutputShape=function(inputShape){for(var _i=0,_a=(inputShape=types_utils_1.getExactlyOneShape(inputShape)).slice(1);_i<_a.length;_i++){if(null==_a[_i])throw new errors_1.ValueError('The shape of the input to "Flatten" is not fully defined (got '+inputShape.slice(1)+'). Make sure to pass a complete "input_shape" or "batch_input_shape" argument to the first layer in your model.')}return[inputShape[0],math_utils_1.arrayProd(inputShape,1)]},Flatten.prototype.call=function(inputs,kwargs){var _this=this;return tfjs_core_1.tidy(function(){return _this.invokeCallHook(inputs,kwargs),K.batchFlatten(types_utils_1.getExactlyOneTensor(inputs))})},Flatten.className="Flatten",Flatten}(topology_1.Layer);exports.Flatten=Flatten,tfjs_core_1.serialization.registerClass(Flatten);var Activation=function(_super){function Activation(args){var _this=_super.call(this,args)||this;return _this.supportsMasking=!0,_this.activation=activations_1.getActivation(args.activation),_this}return __extends(Activation,_super),Activation.prototype.call=function(inputs,kwargs){var _this=this;return tfjs_core_1.tidy(function(){_this.invokeCallHook(inputs,kwargs);var input=types_utils_1.getExactlyOneTensor(inputs);return _this.activation.apply(input)})},Activation.prototype.getConfig=function(){var config={activation:activations_1.serializeActivation(this.activation)},baseConfig=_super.prototype.getConfig.call(this);return Object.assign(config,baseConfig),config},Activation.className="Activation",Activation}(topology_1.Layer);exports.Activation=Activation,tfjs_core_1.serialization.registerClass(Activation);var RepeatVector=function(_super){function RepeatVector(args){var _this=_super.call(this,args)||this;return _this.n=args.n,_this.inputSpec=[{ndim:2}],_this}return __extends(RepeatVector,_super),RepeatVector.prototype.computeOutputShape=function(inputShape){return[inputShape[0],this.n,inputShape[1]]},RepeatVector.prototype.call=function(inputs,kwargs){var _this=this;return tfjs_core_1.tidy(function(){return inputs=types_utils_1.getExactlyOneTensor(inputs),K.repeat(inputs,_this.n)})},RepeatVector.prototype.getConfig=function(){var config={n:this.n},baseConfig=_super.prototype.getConfig.call(this);return Object.assign(config,baseConfig),config},RepeatVector.className="RepeatVector",RepeatVector}(topology_1.Layer);exports.RepeatVector=RepeatVector,tfjs_core_1.serialization.registerClass(RepeatVector);var Reshape=function(_super){function Reshape(args){var _this=_super.call(this,args)||this;_this.targetShape=args.targetShape;for(var i=0;i<_this.targetShape.length;++i)_this.isUnknown(_this.targetShape[i])&&(_this.targetShape[i]=null);return _this}return __extends(Reshape,_super),Reshape.prototype.isUnknown=function(dim){return dim<0||null==dim},Reshape.prototype.fixUnknownDimension=function(inputShape,outputShape){for(var errorMsg="Total size of new array must be unchanged.",finalShape=outputShape.slice(),known=1,unknown=null,i=0;i<finalShape.length;++i){var dim=finalShape[i];if(this.isUnknown(dim)){if(null!==unknown)throw new errors_1.ValueError("Can only specifiy one unknown dimension.");unknown=i}else known*=dim}var originalSize=math_utils_1.arrayProd(inputShape);if(null!==unknown){if(0===known||originalSize%known!=0)throw new errors_1.ValueError(errorMsg);finalShape[unknown]=originalSize/known}else if(originalSize!==known)throw new errors_1.ValueError(errorMsg);return finalShape},Reshape.prototype.computeOutputShape=function(inputShape){for(var anyUnknownDims=!1,i=0;i<inputShape.length;++i)if(this.isUnknown(inputShape[i])){anyUnknownDims=!0;break}return anyUnknownDims?inputShape.slice(0,1).concat(this.targetShape):inputShape.slice(0,1).concat(this.fixUnknownDimension(inputShape.slice(1),this.targetShape))},Reshape.prototype.call=function(inputs,kwargs){var _this=this;return tfjs_core_1.tidy(function(){_this.invokeCallHook(inputs,kwargs);var input=types_utils_1.getExactlyOneTensor(inputs),inputShape=input.shape,outputShape=inputShape.slice(0,1).concat(_this.fixUnknownDimension(inputShape.slice(1),_this.targetShape));return input.reshape(outputShape)})},Reshape.prototype.getConfig=function(){var config={targetShape:this.targetShape},baseConfig=_super.prototype.getConfig.call(this);return Object.assign(config,baseConfig),config},Reshape.className="Reshape",Reshape}(topology_1.Layer);exports.Reshape=Reshape,tfjs_core_1.serialization.registerClass(Reshape);var Permute=function(_super){function Permute(args){var _this=_super.call(this,args)||this;if(null==args.dims)throw new Error("Required configuration field `dims` is missing during Permute constructor call.");if(!Array.isArray(args.dims))throw new Error("Permute constructor requires `dims` to be an Array, but received "+args.dims+" instead.");var expectedSortedIndices=math_utils_1.range(1,args.dims.length+1);if(!tfjs_core_1.util.arraysEqual(args.dims.slice().sort(),expectedSortedIndices))throw new Error("Invalid permutation `dims`: "+JSON.stringify(args.dims)+" `dims` must contain consecutive integers starting from 1.");return _this.dims=args.dims,_this.dimsIncludingBatch=[0].concat(_this.dims),_this.inputSpec=[new topology_1.InputSpec({ndim:_this.dims.length+1})],_this}return __extends(Permute,_super),Permute.prototype.computeOutputShape=function(inputShape){var outputShape=(inputShape=types_utils_1.getExactlyOneShape(inputShape)).slice();return this.dims.forEach(function(dim,i){outputShape[i+1]=inputShape[dim]}),outputShape},Permute.prototype.call=function(inputs,kwargs){return tfjs_core_1.transpose(types_utils_1.getExactlyOneTensor(inputs),this.dimsIncludingBatch)},Permute.prototype.getConfig=function(){var config={dims:this.dims},baseConfig=_super.prototype.getConfig.call(this);return Object.assign(config,baseConfig),config},Permute.className="Permute",Permute}(topology_1.Layer);exports.Permute=Permute,tfjs_core_1.serialization.registerClass(Permute);var Masking=function(_super){function Masking(args){var _this=_super.call(this,null==args?{}:args)||this;return _this.supportsMasking=!0,_this.maskValue=null!=args?null==args.maskValue?0:args.maskValue:0,_this}return __extends(Masking,_super),Masking.prototype.computeOutputShape=function(inputShape){return inputShape},Masking.prototype.getConfig=function(){var baseConfig=_super.prototype.getConfig.call(this),config={maskValue:this.maskValue};return Object.assign(config,baseConfig),config},Masking.prototype.computeMask=function(inputs,mask){var input=types_utils_1.getExactlyOneTensor(inputs);return tfjs_core_1.any(tfjs_core_1.notEqual(input,this.maskValue),-1)},Masking.prototype.call=function(inputs,kwargs){var _this=this;return tfjs_core_1.tidy(function(){_this.invokeCallHook(inputs,kwargs);var input=types_utils_1.getExactlyOneTensor(inputs),booleanMask=tfjs_core_1.any(tfjs_core_1.notEqual(input,_this.maskValue),-1,!0);return input.mul(booleanMask.asType(input.dtype))})},Masking.className="Masking",Masking}(topology_1.Layer);exports.Masking=Masking,tfjs_core_1.serialization.registerClass(Masking)},{"../activations":273,"../backend/tfjs_backend":276,"../constraints":280,"../engine/topology":284,"../errors":289,"../initializers":298,"../regularizers":319,"../utils/generic_utils":322,"../utils/math_utils":324,"../utils/types_utils":326,"@tensorflow/tfjs-core":148}],305:[function(require,module,exports){"use strict";var extendStatics,__extends=this&&this.__extends||(extendStatics=function(d,b){return(extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p])})(d,b)},function(d,b){function __(){this.constructor=d}extendStatics(d,b),d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)});Object.defineProperty(exports,"__esModule",{value:!0});var tfjs_core_1=require("@tensorflow/tfjs-core"),K=require("../backend/tfjs_backend"),constraints_1=require("../constraints"),topology_1=require("../engine/topology"),errors_1=require("../errors"),initializers_1=require("../initializers"),regularizers_1=require("../regularizers"),generic_utils=require("../utils/generic_utils"),types_utils_1=require("../utils/types_utils"),Embedding=function(_super){function Embedding(args){var _this=_super.call(this,args)||this;if(_this.embeddings=null,_this.DEFAULT_EMBEDDINGS_INITIALIZER="randomUniform",null==args.batchInputShape&&null==args.inputShape){var batchSize=null;null!=args.batchSize&&(batchSize=args.batchSize),null==args.inputLength?_this.batchInputShape=[batchSize,null]:_this.batchInputShape=[batchSize].concat(generic_utils.toList(args.inputLength))}return _this.inputDim=args.inputDim,generic_utils.assertPositiveInteger(_this.inputDim,"inputDim"),_this.outputDim=args.outputDim,generic_utils.assertPositiveInteger(_this.outputDim,"outputDim"),_this.embeddingsInitializer=initializers_1.getInitializer(args.embeddingsInitializer||_this.DEFAULT_EMBEDDINGS_INITIALIZER),_this.embeddingsRegularizer=regularizers_1.getRegularizer(args.embeddingsRegularizer),_this.activityRegularizer=regularizers_1.getRegularizer(args.activityRegularizer),_this.embeddingsConstraint=constraints_1.getConstraint(args.embeddingsConstraint),_this.maskZero=args.maskZero,_this.supportsMasking=args.maskZero,_this.inputLength=args.inputLength,_this}return __extends(Embedding,_super),Embedding.prototype.build=function(inputShape){this.embeddings=this.addWeight("embeddings",[this.inputDim,this.outputDim],this.dtype,this.embeddingsInitializer,this.embeddingsRegularizer,!0,this.embeddingsConstraint),this.built=!0},Embedding.prototype.warnOnIncompatibleInputShape=function(inputShape){},Embedding.prototype.computeMask=function(inputs,mask){var _this=this;return tfjs_core_1.tidy(function(){return _this.maskZero?(inputs=types_utils_1.getExactlyOneTensor(inputs),tfjs_core_1.notEqual(inputs,tfjs_core_1.zerosLike(inputs))):null})},Embedding.prototype.computeOutputShape=function(inputShape){if(inputShape=types_utils_1.getExactlyOneShape(inputShape),null==this.inputLength)return inputShape.concat([this.outputDim]);var inLens=generic_utils.toList(this.inputLength);if(inLens.length!==inputShape.length-1)throw new errors_1.ValueError('"inputLength" is '+this.inputLength+", but received input shape has shape "+inputShape);for(var i=0,k=0;k<inLens.length;++k){var s1=inLens[k],s2=inputShape[k+1];if(null!=s1&&null!=s2&&s1!==s2)throw new errors_1.ValueError('"inputLength" is '+this.inputLength+", but received input shape has shape "+inputShape);null==s1&&(inLens[i]=s2),i++}return[inputShape[0]].concat(inLens,[this.outputDim])},Embedding.prototype.call=function(inputs,kwargs){var _this=this;return tfjs_core_1.tidy(function(){_this.invokeCallHook(inputs,kwargs);var input=types_utils_1.getExactlyOneTensor(inputs);return"int32"!==input.dtype&&(input=K.cast(input,"int32")),K.gather(_this.embeddings.read(),input.as1D()).reshape(types_utils_1.getExactlyOneShape(_this.computeOutputShape(input.shape)))})},Embedding.prototype.getConfig=function(){var config={inputDim:this.inputDim,outputDim:this.outputDim,embeddingsInitializer:initializers_1.serializeInitializer(this.embeddingsInitializer),embeddingsRegularizer:regularizers_1.serializeRegularizer(this.embeddingsRegularizer),activityRegularizer:regularizers_1.serializeRegularizer(this.activityRegularizer),embeddingsConstraint:constraints_1.serializeConstraint(this.embeddingsConstraint),maskZero:this.maskZero,inputLength:this.inputLength},baseConfig=_super.prototype.getConfig.call(this);return Object.assign(config,baseConfig),config},Embedding.className="Embedding",Embedding}(topology_1.Layer);exports.Embedding=Embedding,tfjs_core_1.serialization.registerClass(Embedding)},{"../backend/tfjs_backend":276,"../constraints":280,"../engine/topology":284,"../errors":289,"../initializers":298,"../regularizers":319,"../utils/generic_utils":322,"../utils/types_utils":326,"@tensorflow/tfjs-core":148}],306:[function(require,module,exports){"use strict";var extendStatics,__extends=this&&this.__extends||(extendStatics=function(d,b){return(extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p])})(d,b)},function(d,b){function __(){this.constructor=d}extendStatics(d,b),d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)});Object.defineProperty(exports,"__esModule",{value:!0});var tfc=require("@tensorflow/tfjs-core"),tfjs_core_1=require("@tensorflow/tfjs-core"),K=require("../backend/tfjs_backend"),topology_1=require("../engine/topology"),errors_1=require("../errors"),losses_1=require("../losses"),generic_utils=require("../utils/generic_utils"),mathUtils=require("../utils/math_utils"),types_utils_1=require("../utils/types_utils"),Merge=function(_super){function Merge(args){var _this=_super.call(this,args||{})||this;return _this.supportsMasking=!0,_this}return __extends(Merge,_super),Merge.prototype.mergeFunction=function(inputs){throw new errors_1.NotImplementedError},Merge.prototype.computeElementwiseOpOutputShape=function(shape1,shape2){if(null==shape1||null==shape2)return null;if(shape1.length<shape2.length)return this.computeElementwiseOpOutputShape(shape2,shape1);if(0===shape2.length)return shape1;for(var outputShape=shape1.slice(0,shape1.length-shape2.length),k=0;k<shape2.length;++k){var i=shape1[shape1.length-shape2.length+k],j=shape2[k];if(null==i||null==j||i<0||j<0)outputShape.push(null);else if(1===i)outputShape.push(j);else if(1===j)outputShape.push(i);else{if(i!==j)throw new errors_1.ValueError("Operands could not be broadcast together with shapes "+JSON.stringify(shape1)+" "+JSON.stringify(shape2));outputShape.push(i)}}return outputShape},Merge.prototype.build=function(inputShape){if(Array.isArray(inputShape)&&!Array.isArray(inputShape[0])&&(inputShape=[types_utils_1.getExactlyOneShape(inputShape)]),(inputShape=inputShape).length<2)throw new errors_1.ValueError("A merge layer should be called on an Array of at least 2 inputs. Got "+inputShape.length+" input(s).");for(var batchSizes=[],_i=0,inputShape_1=inputShape;_i<inputShape_1.length;_i++){null!=(shape=inputShape_1[_i])&&null!==shape[0]&&batchSizes.push(shape[0])}if(1<(batchSizes=generic_utils.unique(batchSizes)).length)throw new errors_1.ValueError("Can not merge tensors with different batch sizes. Got tensors with shapes: "+JSON.stringify(inputShape)+".");for(var outputShape=null==inputShape[0]?null:inputShape[0].slice(1),i=1;i<inputShape.length;++i){var shape=null==inputShape[i]?null:inputShape[i].slice(1);outputShape=this.computeElementwiseOpOutputShape(outputShape,shape)}var allRanks=inputShape.map(function(shape){return shape.length});-1===inputShape.indexOf(null)&&1===generic_utils.unique(allRanks).length?this.reshapeRequired=!1:this.reshapeRequired=!0},Merge.prototype.call=function(inputs,kwargs){var _this=this;return tfjs_core_1.tidy(function(){if(inputs=inputs,_this.reshapeRequired){var reshapedInputs=[],inputDims=inputs.map(function(input){return input.rank});if(-1===inputDims.indexOf(null)){for(var maxNDim=mathUtils.max(inputDims),_i=0,inputs_1=inputs;_i<inputs_1.length;_i++){for(var xNDim=(x=inputs_1[_i]).rank,k=0;k<maxNDim-xNDim;++k)x=K.expandDims(x,1);reshapedInputs.push(x)}return _this.mergeFunction(reshapedInputs)}for(var transposed=!1,_a=0,inputs_2=inputs;_a<inputs_2.length;_a++){var x;if(null==(xNDim=(x=inputs_2[_a]).rank)){var xShape=x.shape,batchSize=xShape[0],newShape=xShape.slice(1).concat([batchSize]),xTransposed=x.reshape([batchSize].concat(mathUtils.arrayProd(xShape.slice(1))));xTransposed=(xTransposed=tfc.transpose(xTransposed,[1,0])).reshape(newShape),reshapedInputs.push(xTransposed),transposed=!0}else if(1<xNDim){var dims=mathUtils.range(1,xNDim).concat([0]);reshapedInputs.push(tfc.transpose(x,dims)),transposed=!0}else reshapedInputs.push(x)}var y=_this.mergeFunction(reshapedInputs),yNDim=y.rank;if(transposed)if(null==yNDim){var yShape=y.shape;newShape=[batchSize=yShape[yShape.length-1]].concat(yShape.slice(0,yShape.length-1));y=tfc.transpose(y.reshape([-1,batchSize]),[1,0]).reshape(newShape)}else if(1<yNDim){dims=[yNDim-1].concat(mathUtils.range(0,yNDim-1));y=tfc.transpose(y,dims)}return y}return _this.mergeFunction(inputs)})},Merge.prototype.computeOutputShape=function(inputShape){var outputShape;outputShape=null==(inputShape=inputShape)[0]?null:inputShape[0].slice(1);for(var i=1;i<inputShape.length;++i){var shape=null==inputShape[i]?null:inputShape[i].slice(1);outputShape=this.computeElementwiseOpOutputShape(outputShape,shape)}for(var batchSizes=[],_i=0,inputShape_2=inputShape;_i<inputShape_2.length;_i++){null!=(shape=inputShape_2[_i])&&null!==shape[0]&&batchSizes.push(shape[0])}return outputShape=1===(batchSizes=generic_utils.unique(batchSizes)).length?batchSizes.concat(outputShape):[null].concat(outputShape)},Merge.prototype.computeMask=function(inputs,mask){return tfc.tidy(function(){if(null==mask)return null;if(!Array.isArray(mask))throw new errors_1.ValueError("`mask` should be an Array");if(!Array.isArray(inputs))throw new errors_1.ValueError("`inputs` should be an Array");if(mask.length!==inputs.length)throw new errors_1.ValueError("The Array 'inputs' and 'mask' are expected to have the same length, but have different lengths ("+inputs.length+" vs "+mask.length+")");if(mask.every(function(m){return null==m}))return null;for(var output=(mask=mask.map(function(m){return null==m?m:tfc.expandDims(m,0)}))[0],i=1;i<mask.length-1;++i)output=tfc.logicalAnd(output,mask[i]);return output})},Merge}(topology_1.Layer),Add=function(_super){function Add(args){return _super.call(this,args)||this}return __extends(Add,_super),Add.prototype.mergeFunction=function(inputs){return tfjs_core_1.tidy(function(){for(var output=inputs[0].clone(),i=1;i<inputs.length;++i)output=tfc.add(output,inputs[i]);return output})},Add.className="Add",Add}(exports.Merge=Merge);exports.Add=Add,tfjs_core_1.serialization.registerClass(Add),exports.add=function(config){return Array.isArray(config)?new Add({}).apply(config):new Add(config)};var Multiply=function(_super){function Multiply(args){return _super.call(this,args)||this}return __extends(Multiply,_super),Multiply.prototype.mergeFunction=function(inputs){return tfjs_core_1.tidy(function(){for(var output=inputs[0].clone(),i=1;i<inputs.length;++i)output=tfc.mul(output,inputs[i]);return output})},Multiply.className="Multiply",Multiply}(Merge);exports.Multiply=Multiply,tfjs_core_1.serialization.registerClass(Multiply),exports.multiply=function(config){return Array.isArray(config)?new Multiply({}).apply(config):new Multiply(config)};var Average=function(_super){function Average(args){return _super.call(this,args)||this}return __extends(Average,_super),Average.prototype.mergeFunction=function(inputs){return tfjs_core_1.tidy(function(){for(var output=inputs[0].clone(),i=1;i<inputs.length;++i)output=tfc.add(output,inputs[i]);return tfc.mul(1/inputs.length,output)})},Average.className="Average",Average}(Merge);exports.Average=Average,tfjs_core_1.serialization.registerClass(Average),exports.average=function(config){return Array.isArray(config)?new Average({}).apply(config):new Average(config)};var Maximum=function(_super){function Maximum(args){return _super.call(this,args)||this}return __extends(Maximum,_super),Maximum.prototype.mergeFunction=function(inputs){return tfjs_core_1.tidy(function(){for(var output=inputs[0],i=1;i<inputs.length;++i)output=tfc.maximum(output,inputs[i]);return output})},Maximum.className="Maximum",Maximum}(Merge);exports.Maximum=Maximum,tfjs_core_1.serialization.registerClass(Maximum),exports.maximum=function(config){return Array.isArray(config)?new Maximum({}).apply(config):new Maximum(config)};var Minimum=function(_super){function Minimum(args){return _super.call(this,args)||this}return __extends(Minimum,_super),Minimum.prototype.mergeFunction=function(inputs){return tfjs_core_1.tidy(function(){for(var output=inputs[0],i=1;i<inputs.length;++i)output=tfc.minimum(output,inputs[i]);return output})},Minimum.className="Minimum",Minimum}(Merge);exports.Minimum=Minimum,tfjs_core_1.serialization.registerClass(Minimum),exports.minimum=function(config){return Array.isArray(config)?new Minimum({}).apply(config):new Minimum(config)};var Concatenate=function(_super){function Concatenate(args){var _this=_super.call(this,args)||this;return _this.DEFAULT_AXIS=-1,null==args&&(args={}),_this.axis=null==args.axis?_this.DEFAULT_AXIS:args.axis,_this.supportsMasking=!0,_this.reshapeRequired=!1,_this}return __extends(Concatenate,_super),Concatenate.prototype.build=function(inputShape){if(!Array.isArray(inputShape)||!Array.isArray(inputShape[0])||1===inputShape.length)throw new errors_1.ValueError("A `Concatenate` layer should be called on a list of at least 2 inputs");for(var allNoneShape=!0,_i=0,inputShape_3=inputShape=inputShape;_i<inputShape_3.length;_i++){if(null!=(shape=inputShape_3[_i])){allNoneShape=!1;break}}if(!allNoneShape){for(var shapeSet=[],i=0;i<inputShape.length;++i){var shapeWithoutConcatAxis=inputShape[i].slice();shapeWithoutConcatAxis.splice(this.axis,1);for(var exists=!1,_a=0,shapeSet_1=shapeSet;_a<shapeSet_1.length;_a++){var shape=shapeSet_1[_a];if(tfjs_core_1.util.arraysEqual(shape,shapeWithoutConcatAxis)){exists=!0;break}}exists||shapeSet.push(shapeWithoutConcatAxis)}if(1<shapeSet.length)throw new errors_1.ValueError("A `Concatenate` layer requires inputs with matching shapes except for the concat axis. Got input shapes: "+JSON.stringify(inputShape))}},Concatenate.prototype.mergeFunction=function(inputs){var _this=this;return tfjs_core_1.tidy(function(){return K.concatenate(inputs,_this.axis)})},Concatenate.prototype.computeOutputShape=function(inputShape){if(!Array.isArray(inputShape)||!Array.isArray(inputShape[0]))throw new errors_1.ValueError("A `Concatenate` layer should be called on a list of inputs.");for(var inputShapes=inputShape,outputShape=inputShapes[0].slice(),axis=this.axis<0?outputShape.length+this.axis:this.axis,_i=0,_a=inputShapes.slice(1);_i<_a.length;_i++){var shape=_a[_i];if(null==outputShape[axis]||null==shape[axis]){outputShape[axis]=null;break}outputShape[axis]+=shape[axis]}return outputShape},Concatenate.prototype.computeMask=function(inputs,mask){var _this=this;if(null==mask)return null;if(!Array.isArray(mask))throw new errors_1.ValueError("`mask` should be an array for Concatenate");if(!Array.isArray(inputs))throw new errors_1.ValueError("`inputs` should be an array for Concatenate");if(mask.length!==inputs.length)throw new errors_1.ValueError("Mismatch in the length of mask ("+mask.length+") and the legnth of inputs ("+inputs.length+")");return tfc.tidy(function(){var allNullMasks=!0;if(mask.forEach(function(m){null==m||(allNullMasks=!1)}),allNullMasks)return null;for(var outputMasks=[],i=0;i<inputs.length;++i)null==mask[i]?outputMasks.push(tfc.onesLike(inputs[i]).asType("bool")):mask[i].rank<inputs[i].rank?outputMasks.push(tfc.expandDims(mask[i],-1)):outputMasks.push(mask[i]);var concatenatedMasks=tfc.concat(outputMasks,_this.axis);return tfc.all(concatenatedMasks,-1,!1)})},Concatenate.prototype.getConfig=function(){var config={axis:this.axis},baseConfig=_super.prototype.getConfig.call(this);return Object.assign(config,baseConfig),config},Concatenate.className="Concatenate",Concatenate}(Merge);function interpretAxis(axis,dim){for(;axis<0;)axis+=dim;return axis}exports.Concatenate=Concatenate,tfjs_core_1.serialization.registerClass(Concatenate),exports.concatenate=function(config){return Array.isArray(config)?new Concatenate({}).apply(config):new Concatenate(config)};var Dot=function(_super){function Dot(args){var _this=_super.call(this,args)||this;return _this.axes=args.axes,_this.normalize=null!=args.normalize&&args.normalize,_this.supportsMasking=!0,_this.reshapeRequired=!1,_this}return __extends(Dot,_super),Dot.prototype.build=function(inputShape){tfc.util.assert(Array.isArray(inputShape)&&2===inputShape.length&&Array.isArray(inputShape[0])&&Array.isArray(inputShape[1]),function(){return"A `Dot` layer should be called on a list of exactly 2 inputs."});var shape1=inputShape[0],shape2=inputShape[1];if(3<shape1.length||3<shape2.length)throw new errors_1.NotImplementedError("Dot layer does not support tensors of 4D or higher rank yet.");var axes=this.interpretAxes(shape1,shape2);if(shape1[axes[0]]!==shape2[axes[1]])throw new errors_1.ValueError("Dimension incompatibility: "+shape1[axes[0]]+" !== "+shape2[axes[1]])},Dot.prototype.mergeFunction=function(inputs){if(2!==inputs.length)throw new errors_1.ValueError("A `Dot` layer must be called on exactly 2 inputs, but received "+inputs.length+" input(s).");var axes,x1=inputs[0],x2=inputs[1];return axes=Array.isArray(this.axes)?this.axes.map(function(axis,i){return interpretAxis(axis,inputs[i].shape.length)}):[interpretAxis(this.axes,x1.shape.length),interpretAxis(this.axes,x2.shape.length)],this.normalize&&(x1=losses_1.l2Normalize(x1,axes[0]),x2=losses_1.l2Normalize(x2,axes[1])),function(x,y,axes){if(3<x.shape.length||3<y.shape.length)throw new errors_1.NotImplementedError("batchDot is not implemented for tensors of 4D or higher rank yet");if(tfc.util.assert(2<=x.shape.length,function(){return"batchDot requires the rank of x to be >= 2, but got "+x.shape.length}),tfc.util.assert(2<=x.shape.length,function(){return"batchDot requires the rank of y to be >= 2, but got "+y.shape.length}),"number"==typeof axes&&(axes=[axes,axes]),"complex64"===x.dtype||"complex64"===y.dtype)throw new errors_1.NotImplementedError("batchDot is not implemented for complex64-type Tensors yet.");var xNDim=x.shape.length,yNDim=y.shape.length;null==axes&&(axes=[xNDim-1,yNDim-2]);var axesArray=axes;return tfc.tidy(function(){var diff,out;if(yNDim<xNDim){diff=xNDim-yNDim;for(var diffShape=[],i=0;i<diff;++i)diffShape.push(1);y=y.reshape(y.shape.concat(diffShape))}else if(xNDim<yNDim){diff=yNDim-xNDim;for(diffShape=[],i=0;i<diff;++i)diffShape.push(1);x=x.reshape(x.shape.concat(diffShape))}else diff=0;if(2===x.shape.length&&2===y.shape.length)out=axesArray[0]===axesArray[1]?x.mulStrict(y).sum(axesArray[0]):x.transpose([1,0]).mulStrict(y).sum(axesArray[1]);else{var adjX=axesArray[0]!==x.shape.length-1,adjY=axesArray[1]===y.shape.length-1;out=x.matMul(y,adjX,adjY)}if(0<diff){var idx=void 0,squeezeAxes=[];for(i=idx=yNDim<xNDim?xNDim+yNDim-3:xNDim-1;i<idx+diff;++i)squeezeAxes.push(i);out=out.squeeze(squeezeAxes)}return 1===out.shape.length&&(out=out.expandDims(1)),out})}(x1,x2,axes)},Dot.prototype.interpretAxes=function(shape1,shape2){return Array.isArray(this.axes)?this.axes:[interpretAxis(this.axes,shape1.length),interpretAxis(this.axes,shape2.length)]},Dot.prototype.computeOutputShape=function(inputShape){tfc.util.assert(Array.isArray(inputShape)&&2===inputShape.length&&Array.isArray(inputShape[0])&&Array.isArray(inputShape[1]),function(){return"A `Dot` layer should be called on a list of exactly 2 inputs."});var shape1=inputShape[0].slice(),shape2=inputShape[1].slice();if(3<shape1.length||3<shape2.length)throw new errors_1.NotImplementedError("Dot layer does not support tensors of 4D or higher rank yet.");var axes=this.interpretAxes(shape1,shape2);shape1.splice(axes[0],1),shape2.splice(axes[1],1),shape2.splice(0,1);var outputShape=shape1.concat(shape2);return 1===outputShape.length&&outputShape.push(1),outputShape},Dot.prototype.computeMask=function(inputs,mask){return null},Dot.prototype.getConfig=function(){var config={axes:this.axes,normalize:this.normalize},baseConfig=_super.prototype.getConfig.call(this);return Object.assign(config,baseConfig),config},Dot.className="Dot",Dot}(Merge);exports.Dot=Dot,tfjs_core_1.serialization.registerClass(Dot)},{"../backend/tfjs_backend":276,"../engine/topology":284,"../errors":289,"../losses":315,"../utils/generic_utils":322,"../utils/math_utils":324,"../utils/types_utils":326,"@tensorflow/tfjs-core":148}],307:[function(require,module,exports){"use strict";var extendStatics,__extends=this&&this.__extends||(extendStatics=function(d,b){return(extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p])})(d,b)},function(d,b){function __(){this.constructor=d}extendStatics(d,b),d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)});Object.defineProperty(exports,"__esModule",{value:!0});var tfjs_core_1=require("@tensorflow/tfjs-core"),K=require("../backend/tfjs_backend"),topology_1=require("../engine/topology"),types_utils_1=require("../utils/types_utils"),GaussianNoise=function(_super){function GaussianNoise(args){var _this=_super.call(this,args)||this;return _this.supportsMasking=!0,_this.stddev=args.stddev,_this}return __extends(GaussianNoise,_super),GaussianNoise.prototype.computeOutputShape=function(inputShape){return inputShape},GaussianNoise.prototype.getConfig=function(){var baseConfig=_super.prototype.getConfig.call(this),config={stddev:this.stddev};return Object.assign(config,baseConfig),config},GaussianNoise.prototype.call=function(inputs,kwargs){var _this=this;return tfjs_core_1.tidy(function(){_this.invokeCallHook(inputs,kwargs);var input=types_utils_1.getExactlyOneTensor(inputs);return K.inTrainPhase(function(){return K.randomNormal(input.shape,0,_this.stddev).add(input)},function(){return input},kwargs.training||!1)})},GaussianNoise.className="GaussianNoise",GaussianNoise}(topology_1.Layer);exports.GaussianNoise=GaussianNoise,tfjs_core_1.serialization.registerClass(GaussianNoise);var GaussianDropout=function(_super){function GaussianDropout(args){var _this=_super.call(this,args)||this;return _this.supportsMasking=!0,_this.rate=args.rate,_this}return __extends(GaussianDropout,_super),GaussianDropout.prototype.computeOutputShape=function(inputShape){return inputShape},GaussianDropout.prototype.getConfig=function(){var baseConfig=_super.prototype.getConfig.call(this),config={rate:this.rate};return Object.assign(config,baseConfig),config},GaussianDropout.prototype.call=function(inputs,kwargs){var _this=this;return tfjs_core_1.tidy(function(){_this.invokeCallHook(inputs,kwargs);var input=types_utils_1.getExactlyOneTensor(inputs);if(0<_this.rate&&_this.rate<1){return K.inTrainPhase(function(){var stddev=Math.sqrt(_this.rate/(1-_this.rate));return input.mul(K.randomNormal(input.shape,1,stddev))},function(){return input},kwargs.training||!1)}return input})},GaussianDropout.className="GaussianDropout",GaussianDropout}(topology_1.Layer);exports.GaussianDropout=GaussianDropout,tfjs_core_1.serialization.registerClass(GaussianDropout);var AlphaDropout=function(_super){function AlphaDropout(args){var _this=_super.call(this,args)||this;return _this.supportsMasking=!0,_this.rate=args.rate,_this.noiseShape=args.noiseShape,_this}return __extends(AlphaDropout,_super),AlphaDropout.prototype._getNoiseShape=function(inputs){return this.noiseShape||types_utils_1.getExactlyOneTensor(inputs).shape},AlphaDropout.prototype.computeOutputShape=function(inputShape){return inputShape},AlphaDropout.prototype.getConfig=function(){var baseConfig=_super.prototype.getConfig.call(this),config={rate:this.rate};return Object.assign(config,baseConfig),config},AlphaDropout.prototype.call=function(inputs,kwargs){var _this=this;return tfjs_core_1.tidy(function(){if(_this.rate<1&&0<_this.rate){var noiseShape_1=_this._getNoiseShape(inputs);return K.inTrainPhase(function(){var input=types_utils_1.getExactlyOneTensor(inputs),alphaP=-1.7580993408473766,keptIdx=tfjs_core_1.greaterEqual(tfjs_core_1.randomUniform(noiseShape_1),_this.rate);keptIdx=K.cast(keptIdx,"float32");var a=Math.pow((1-_this.rate)*(1+_this.rate*Math.pow(alphaP,2)),-.5),b=-a*alphaP*_this.rate;return input.mul(keptIdx).add(keptIdx.add(-1).mul(alphaP)).mul(a).add(b)},function(){return types_utils_1.getExactlyOneTensor(inputs)},kwargs.training||!1)}return inputs})},AlphaDropout.className="AlphaDropout",AlphaDropout}(topology_1.Layer);exports.AlphaDropout=AlphaDropout,tfjs_core_1.serialization.registerClass(AlphaDropout)},{"../backend/tfjs_backend":276,"../engine/topology":284,"../utils/types_utils":326,"@tensorflow/tfjs-core":148}],308:[function(require,module,exports){"use strict";var extendStatics,__extends=this&&this.__extends||(extendStatics=function(d,b){return(extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p])})(d,b)},function(d,b){function __(){this.constructor=d}extendStatics(d,b),d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)});Object.defineProperty(exports,"__esModule",{value:!0});var tfc=require("@tensorflow/tfjs-core"),tfjs_core_1=require("@tensorflow/tfjs-core"),constraints_1=require("../constraints"),topology_1=require("../engine/topology"),errors_1=require("../errors"),initializers_1=require("../initializers"),regularizers_1=require("../regularizers"),generic_utils=require("../utils/generic_utils"),math_utils=require("../utils/math_utils"),types_utils_1=require("../utils/types_utils");function batchNormalization(x,mean,variance,beta,gamma,epsilon){var out;if(void 0===epsilon&&(epsilon=.001),2===x.rank)out=tfc.batchNorm2d(x,mean,variance,beta,gamma,epsilon);else if(3===x.rank)out=tfc.batchNorm3d(x,mean,variance,beta,gamma,epsilon);else{if(4!==x.rank)throw new errors_1.NotImplementedError("batchNormalization is not implemented for array of rank "+x.rank+" yet");out=tfc.batchNorm4d(x,mean,variance,beta,gamma,epsilon)}return out}function normalizeBatchInTraining(x,gamma,beta,reductionAxes,epsilon){return void 0===epsilon&&(epsilon=.001),tfjs_core_1.util.arraysEqual(reductionAxes.slice().sort(),math_utils.range(0,x.rank-1))?function(x,gamma,beta,reductionAxes,epsilon){return void 0===epsilon&&(epsilon=.001),tfjs_core_1.tidy(function(){var meanAndVariance=tfc.moments(x,reductionAxes),mean=meanAndVariance.mean,variance=meanAndVariance.variance;return[batchNormalization(x,mean,variance,beta,gamma,epsilon),mean,variance]})}(x,gamma,beta,reductionAxes,epsilon):function(x,gamma,beta,reductionAxes,epsilon){return void 0===epsilon&&(epsilon=.001),tfjs_core_1.tidy(function(){for(var meanAndVariance=tfc.moments(x,reductionAxes),mean=meanAndVariance.mean,variance=meanAndVariance.variance,targetShape=[],_i=0,_a=math_utils.range(0,x.rank);_i<_a.length;_i++){var axis=_a[_i];-1!==reductionAxes.indexOf(axis)?targetShape.push(1):targetShape.push(x.shape[axis])}var broadcastMean=mean.reshape(targetShape),broadcastVariance=variance.reshape(targetShape),broadcastGamma=null==gamma?null:gamma.reshape(targetShape),broadcastBeta=null==beta?null:beta.reshape(targetShape);return[batchNormalization(x,broadcastMean,broadcastVariance,broadcastBeta,broadcastGamma,epsilon),mean,variance]})}(x,gamma,beta,reductionAxes,epsilon)}exports.batchNormalization=batchNormalization,exports.normalizeBatchInTraining=normalizeBatchInTraining;var BatchNormalization=function(_super){function BatchNormalization(args){var _this=this;return null==args&&(args={}),(_this=_super.call(this,args)||this).supportsMasking=!0,_this.axis=null==args.axis?-1:args.axis,_this.momentum=null==args.momentum?.99:args.momentum,_this.epsilon=null==args.epsilon?.001:args.epsilon,_this.center=null==args.center||args.center,_this.scale=null==args.scale||args.scale,_this.betaInitializer=initializers_1.getInitializer(args.betaInitializer||"zeros"),_this.gammaInitializer=initializers_1.getInitializer(args.gammaInitializer||"ones"),_this.movingMeanInitializer=initializers_1.getInitializer(args.movingMeanInitializer||"zeros"),_this.movingVarianceInitializer=initializers_1.getInitializer(args.movingVarianceInitializer||"ones"),_this.betaConstraint=constraints_1.getConstraint(args.betaConstraint),_this.gammaConstraint=constraints_1.getConstraint(args.gammaConstraint),_this.betaRegularizer=regularizers_1.getRegularizer(args.betaRegularizer),_this.gammaRegularizer=regularizers_1.getRegularizer(args.gammaRegularizer),_this}return __extends(BatchNormalization,_super),BatchNormalization.prototype.build=function(inputShape){var _a;inputShape=types_utils_1.getExactlyOneShape(inputShape);var axis=0<=this.axis?this.axis:this.axis+inputShape.length,dim=inputShape[axis];if(null==dim)throw new errors_1.ValueError("Axis "+axis+" of input tensor should have a defined dimension but the layer received an input with shape "+JSON.stringify(inputShape)+".");this.inputSpec=[new topology_1.InputSpec({ndim:inputShape.length,axes:(_a={},_a[axis]=dim,_a)})];var shape=[dim];this.scale&&(this.gamma=this.addWeight("gamma",shape,null,this.gammaInitializer,this.gammaRegularizer,!0,this.gammaConstraint)),this.center&&(this.beta=this.addWeight("beta",shape,null,this.betaInitializer,this.betaRegularizer,!0,this.betaConstraint)),this.movingMean=this.addWeight("moving_mean",shape,null,this.movingMeanInitializer,null,!1),this.movingVariance=this.addWeight("moving_variance",shape,null,this.movingVarianceInitializer,null,!1),this.built=!0},BatchNormalization.prototype.call=function(inputs,kwargs){var _this=this;return tfjs_core_1.tidy(function(){var training=null!=kwargs.training&&kwargs.training,input=types_utils_1.getExactlyOneTensor(inputs),inputShape=input.shape,ndim=inputShape.length,reductionAxes=math_utils.range(0,ndim),axis=0<=_this.axis?_this.axis:_this.axis+ndim;reductionAxes.splice(axis,1);var broadcastShape=generic_utils.pyListRepeat(1,ndim);broadcastShape[axis]=inputShape[axis];var sortedReductionAxes=reductionAxes.slice();sortedReductionAxes.sort();var needsBroadcasting=!tfjs_core_1.util.arraysEqual(sortedReductionAxes,math_utils.range(0,ndim).slice(0,ndim-1));if(!training)return function(){if(needsBroadcasting){var broadcastMovingMean=_this.movingMean.read().reshape(broadcastShape),broadcastMovingVariance=_this.movingVariance.read().reshape(broadcastShape),broadcastBeta=_this.center?_this.beta.read().reshape(broadcastShape):null,broadcastGamma=_this.scale?_this.gamma.read().reshape(broadcastShape):null;return batchNormalization(input,broadcastMovingMean,broadcastMovingVariance,broadcastBeta,broadcastGamma,_this.epsilon)}return batchNormalization(input,_this.movingMean.read(),_this.movingVariance.read(),null==_this.beta?null:_this.beta.read(),null==_this.gamma?null:_this.gamma.read(),_this.epsilon)}();function doMovingAverage(variable,value,momentum){tfc.tidy(function(){var decay=1-momentum,origValue=variable.read(),updateDelta=origValue.sub(value).mul(decay);variable.write(origValue.sub(updateDelta))})}var _a=normalizeBatchInTraining(input,_this.gamma.read(),_this.beta.read(),reductionAxes,_this.epsilon),normedTraining=_a[0],mean=_a[1],variance=_a[2];return doMovingAverage(_this.movingMean,mean,_this.momentum),doMovingAverage(_this.movingVariance,variance,_this.momentum),normedTraining})},BatchNormalization.prototype.getConfig=function(){var config={axis:this.axis,momentum:this.momentum,epsilon:this.epsilon,center:this.center,scale:this.scale,betaInitializer:initializers_1.serializeInitializer(this.betaInitializer),gammaInitializer:initializers_1.serializeInitializer(this.gammaInitializer),movingMeanInitializer:initializers_1.serializeInitializer(this.movingMeanInitializer),movingVarianceInitializer:initializers_1.serializeInitializer(this.movingVarianceInitializer),betaRegularizer:regularizers_1.serializeRegularizer(this.betaRegularizer),gammaRegularizer:regularizers_1.serializeRegularizer(this.gammaRegularizer),betaConstraint:constraints_1.serializeConstraint(this.betaConstraint),gammaConstraint:constraints_1.serializeConstraint(this.gammaConstraint)},baseConfig=_super.prototype.getConfig.call(this);return Object.assign(config,baseConfig),config},BatchNormalization.className="BatchNormalization",BatchNormalization}(topology_1.Layer);exports.BatchNormalization=BatchNormalization,tfjs_core_1.serialization.registerClass(BatchNormalization)},{"../constraints":280,"../engine/topology":284,"../errors":289,"../initializers":298,"../regularizers":319,"../utils/generic_utils":322,"../utils/math_utils":324,"../utils/types_utils":326,"@tensorflow/tfjs-core":148}],309:[function(require,module,exports){"use strict";var extendStatics,__extends=this&&this.__extends||(extendStatics=function(d,b){return(extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p])})(d,b)},function(d,b){function __(){this.constructor=d}extendStatics(d,b),d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)});Object.defineProperty(exports,"__esModule",{value:!0});var tfc=require("@tensorflow/tfjs-core"),tfjs_core_1=require("@tensorflow/tfjs-core"),common_1=require("../backend/common"),topology_1=require("../engine/topology"),errors_1=require("../errors"),types_utils_1=require("../utils/types_utils");function spatial2dPadding(x,padding,dataFormat){return tfjs_core_1.tidy(function(){if(4!==x.rank)throw new errors_1.ValueError("temporalPadding expects input tensor to be 4-D, but received a "+x.rank+"-D tensor.");if(null==padding&&(padding=[[1,1],[1,1]]),2!==padding.length||2!==padding[0].length||2!==padding[1].length)throw new errors_1.ValueError("spatial2dPadding expects `padding` to be an Array of two Arrays, each of which is an Array of two integers.");if(null==dataFormat&&(dataFormat=common_1.imageDataFormat()),"channelsLast"!==dataFormat&&"channelsFirst"!==dataFormat)throw new errors_1.ValueError("Unknown data format: "+dataFormat+". Supported data formats are 'channelsLast' and 'channelsFirst.");var pattern;return pattern="channelsFirst"===dataFormat?[[0,0],[0,0],padding[0],padding[1]]:[[0,0],padding[0],padding[1],[0,0]],tfc.pad(x,pattern)})}exports.temporalPadding=function(x,padding){return tfjs_core_1.tidy(function(){if(3!==x.rank)throw new errors_1.ValueError("temporalPadding expects input tensor to be 3-D, but received a "+x.rank+"-D tensor.");if(null==padding&&(padding=[1,1]),2!==padding.length)throw new errors_1.ValueError("temporalPadding expects input padding pattern to be a length-2 array, but received a length-"+padding.length+" array.");var pattern=[[0,0],padding,[0,0]];return tfc.pad(x,pattern)})},exports.spatial2dPadding=spatial2dPadding;var ZeroPadding2D=function(_super){function ZeroPadding2D(args){var _this=this;if(null==args&&(args={}),(_this=_super.call(this,args)||this).dataFormat=null==args.dataFormat?common_1.imageDataFormat():args.dataFormat,null==args.padding)_this.padding=[[1,1],[1,1]];else if("number"==typeof args.padding)_this.padding=[[args.padding,args.padding],[args.padding,args.padding]];else{if(args.padding=args.padding,2!==args.padding.length)throw new errors_1.ValueError("ZeroPadding2D expects padding to be a length-2 array, but received a length-"+args.padding.length+" array.");var heightPadding=void 0,widthPadding=void 0;if("number"==typeof args.padding[0])heightPadding=[args.padding[0],args.padding[0]],widthPadding=[args.padding[1],args.padding[1]];else{if(args.padding=args.padding,2!==args.padding[0].length)throw new errors_1.ValueError("ZeroPadding2D expects height padding to be a length-2 array, but received a length-"+args.padding[0].length+" array.");if(heightPadding=args.padding[0],2!==args.padding[1].length)throw new errors_1.ValueError("ZeroPadding2D expects width padding to be a length-2 array, but received a length-"+args.padding[1].length+" array.");widthPadding=args.padding[1]}_this.padding=[heightPadding,widthPadding]}return _this.inputSpec=[new topology_1.InputSpec({ndim:4})],_this}return __extends(ZeroPadding2D,_super),ZeroPadding2D.prototype.computeOutputShape=function(inputShape){var rows,cols;return inputShape=types_utils_1.getExactlyOneShape(inputShape),"channelsFirst"===this.dataFormat?(rows=null!=inputShape[2]&&0<=inputShape[2]?inputShape[2]+this.padding[0][0]+this.padding[0][1]:null,cols=null!=inputShape[3]&&0<=inputShape[3]?inputShape[3]+this.padding[1][0]+this.padding[1][1]:null,[inputShape[0],inputShape[1],rows,cols]):(rows=null!=inputShape[1]&&0<=inputShape[1]?inputShape[1]+this.padding[0][0]+this.padding[0][1]:null,cols=null!=inputShape[2]&&0<=inputShape[2]?inputShape[2]+this.padding[1][0]+this.padding[1][1]:null,[inputShape[0],rows,cols,inputShape[3]])},ZeroPadding2D.prototype.call=function(inputs,kwargs){var _this=this;return tfjs_core_1.tidy(function(){return spatial2dPadding(types_utils_1.getExactlyOneTensor(inputs),_this.padding,_this.dataFormat)})},ZeroPadding2D.prototype.getConfig=function(){var config={padding:this.padding,dataFormat:this.dataFormat},baseConfig=_super.prototype.getConfig.call(this);return Object.assign(config,baseConfig),config},ZeroPadding2D.className="ZeroPadding2D",ZeroPadding2D}(topology_1.Layer);exports.ZeroPadding2D=ZeroPadding2D,tfjs_core_1.serialization.registerClass(ZeroPadding2D)},{"../backend/common":274,"../engine/topology":284,"../errors":289,"../utils/types_utils":326,"@tensorflow/tfjs-core":148}],310:[function(require,module,exports){"use strict";var extendStatics,__extends=this&&this.__extends||(extendStatics=function(d,b){return(extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p])})(d,b)},function(d,b){function __(){this.constructor=d}extendStatics(d,b),d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)});Object.defineProperty(exports,"__esModule",{value:!0});var tfc=require("@tensorflow/tfjs-core"),tfjs_core_1=require("@tensorflow/tfjs-core"),common_1=require("../backend/common"),K=require("../backend/tfjs_backend"),common_2=require("../common"),topology_1=require("../engine/topology"),topology_2=require("../engine/topology"),errors_1=require("../errors"),conv_utils_1=require("../utils/conv_utils"),generic_utils_1=require("../utils/generic_utils"),types_utils_1=require("../utils/types_utils"),convolutional_1=require("./convolutional");function pool2d(x,poolSize,strides,padding,dataFormat,poolMode){return tfjs_core_1.tidy(function(){var y;common_2.checkDataFormat(dataFormat),common_2.checkPoolMode(poolMode),common_2.checkPaddingMode(padding),null==strides&&(strides=[1,1]),null==padding&&(padding="valid"),null==dataFormat&&(dataFormat=common_1.imageDataFormat()),null==poolMode&&(poolMode="max"),x=convolutional_1.preprocessConv2DInput(x,dataFormat);var paddingString="same"===padding?"same":"valid";return y="max"===poolMode?tfc.maxPool(x,poolSize,strides,paddingString):tfc.avgPool(x,poolSize,strides,paddingString),"channelsFirst"===dataFormat&&(y=tfc.transpose(y,[0,3,1,2])),y})}function pool3d(x,poolSize,strides,padding,dataFormat,poolMode){return tfjs_core_1.tidy(function(){var y;common_2.checkDataFormat(dataFormat),common_2.checkPoolMode(poolMode),common_2.checkPaddingMode(padding),null==strides&&(strides=[1,1,1]),null==padding&&(padding="valid"),null==dataFormat&&(dataFormat=common_1.imageDataFormat()),null==poolMode&&(poolMode="max"),x=convolutional_1.preprocessConv3DInput(x,dataFormat);var paddingString="same"===padding?"same":"valid";return y="max"===poolMode?tfc.maxPool3d(x,poolSize,strides,paddingString):tfc.avgPool3d(x,poolSize,strides,paddingString),"channelsFirst"===dataFormat&&(y=tfc.transpose(y,[0,4,1,2,3])),y})}exports.pool2d=pool2d,exports.pool3d=pool3d;var Pooling1D=function(_super){function Pooling1D(args){var _this=this;if(null==args.poolSize&&(args.poolSize=2),_this=_super.call(this,args)||this,"number"==typeof args.poolSize)_this.poolSize=[args.poolSize];else{if(!Array.isArray(args.poolSize)||1!==args.poolSize.length||"number"!=typeof args.poolSize[0])throw new errors_1.ValueError("poolSize for 1D convolutional layer must be a number or an Array of a single number, but received "+JSON.stringify(args.poolSize));_this.poolSize=args.poolSize}if(generic_utils_1.assertPositiveInteger(_this.poolSize,"poolSize"),null==args.strides)_this.strides=_this.poolSize;else if("number"==typeof args.strides)_this.strides=[args.strides];else{if(!Array.isArray(args.strides)||1!==args.strides.length||"number"!=typeof args.strides[0])throw new errors_1.ValueError("strides for 1D convolutional layer must be a number or an Array of a single number, but received "+JSON.stringify(args.strides));_this.strides=args.strides}return generic_utils_1.assertPositiveInteger(_this.strides,"strides"),_this.padding=null==args.padding?"valid":args.padding,common_2.checkPaddingMode(_this.padding),_this.inputSpec=[new topology_1.InputSpec({ndim:3})],_this}return __extends(Pooling1D,_super),Pooling1D.prototype.computeOutputShape=function(inputShape){inputShape=types_utils_1.getExactlyOneShape(inputShape);var length=conv_utils_1.convOutputLength(inputShape[1],this.poolSize[0],this.padding,this.strides[0]);return[inputShape[0],length,inputShape[2]]},Pooling1D.prototype.call=function(inputs,kwargs){var _this=this;return tfjs_core_1.tidy(function(){_this.invokeCallHook(inputs,kwargs),inputs=K.expandDims(types_utils_1.getExactlyOneTensor(inputs),2);var output=_this.poolingFunction(types_utils_1.getExactlyOneTensor(inputs),[_this.poolSize[0],1],[_this.strides[0],1],_this.padding,"channelsLast");return tfc.squeeze(output,[2])})},Pooling1D.prototype.getConfig=function(){var config={poolSize:this.poolSize,padding:this.padding,strides:this.strides},baseConfig=_super.prototype.getConfig.call(this);return Object.assign(config,baseConfig),config},Pooling1D}(topology_2.Layer),MaxPooling1D=function(_super){function MaxPooling1D(args){return _super.call(this,args)||this}return __extends(MaxPooling1D,_super),MaxPooling1D.prototype.poolingFunction=function(inputs,poolSize,strides,padding,dataFormat){return common_2.checkDataFormat(dataFormat),common_2.checkPaddingMode(padding),pool2d(inputs,poolSize,strides,padding,dataFormat,"max")},MaxPooling1D.className="MaxPooling1D",MaxPooling1D}(exports.Pooling1D=Pooling1D);exports.MaxPooling1D=MaxPooling1D,tfjs_core_1.serialization.registerClass(MaxPooling1D);var AveragePooling1D=function(_super){function AveragePooling1D(args){return _super.call(this,args)||this}return __extends(AveragePooling1D,_super),AveragePooling1D.prototype.poolingFunction=function(inputs,poolSize,strides,padding,dataFormat){return common_2.checkDataFormat(dataFormat),common_2.checkPaddingMode(padding),pool2d(inputs,poolSize,strides,padding,dataFormat,"avg")},AveragePooling1D.className="AveragePooling1D",AveragePooling1D}(Pooling1D);exports.AveragePooling1D=AveragePooling1D,tfjs_core_1.serialization.registerClass(AveragePooling1D);var Pooling2D=function(_super){function Pooling2D(args){var _this=this;if(null==args.poolSize&&(args.poolSize=[2,2]),(_this=_super.call(this,args)||this).poolSize=Array.isArray(args.poolSize)?args.poolSize:[args.poolSize,args.poolSize],null==args.strides)_this.strides=_this.poolSize;else if(Array.isArray(args.strides)){if(2!==args.strides.length)throw new errors_1.ValueError("If the strides property of a 2D pooling layer is an Array, it is expected to have a length of 2, but received length "+args.strides.length+".");_this.strides=args.strides}else _this.strides=[args.strides,args.strides];return generic_utils_1.assertPositiveInteger(_this.poolSize,"poolSize"),generic_utils_1.assertPositiveInteger(_this.strides,"strides"),_this.padding=null==args.padding?"valid":args.padding,_this.dataFormat=null==args.dataFormat?"channelsLast":args.dataFormat,common_2.checkDataFormat(_this.dataFormat),common_2.checkPaddingMode(_this.padding),_this.inputSpec=[new topology_1.InputSpec({ndim:4})],_this}return __extends(Pooling2D,_super),Pooling2D.prototype.computeOutputShape=function(inputShape){inputShape=types_utils_1.getExactlyOneShape(inputShape);var rows="channelsFirst"===this.dataFormat?inputShape[2]:inputShape[1],cols="channelsFirst"===this.dataFormat?inputShape[3]:inputShape[2];return rows=conv_utils_1.convOutputLength(rows,this.poolSize[0],this.padding,this.strides[0]),cols=conv_utils_1.convOutputLength(cols,this.poolSize[1],this.padding,this.strides[1]),"channelsFirst"===this.dataFormat?[inputShape[0],inputShape[1],rows,cols]:[inputShape[0],rows,cols,inputShape[3]]},Pooling2D.prototype.call=function(inputs,kwargs){var _this=this;return tfjs_core_1.tidy(function(){return _this.invokeCallHook(inputs,kwargs),_this.poolingFunction(types_utils_1.getExactlyOneTensor(inputs),_this.poolSize,_this.strides,_this.padding,_this.dataFormat)})},Pooling2D.prototype.getConfig=function(){var config={poolSize:this.poolSize,padding:this.padding,strides:this.strides,dataFormat:this.dataFormat},baseConfig=_super.prototype.getConfig.call(this);return Object.assign(config,baseConfig),config},Pooling2D}(topology_2.Layer),MaxPooling2D=function(_super){function MaxPooling2D(args){return _super.call(this,args)||this}return __extends(MaxPooling2D,_super),MaxPooling2D.prototype.poolingFunction=function(inputs,poolSize,strides,padding,dataFormat){return common_2.checkDataFormat(dataFormat),common_2.checkPaddingMode(padding),pool2d(inputs,poolSize,strides,padding,dataFormat,"max")},MaxPooling2D.className="MaxPooling2D",MaxPooling2D}(exports.Pooling2D=Pooling2D);exports.MaxPooling2D=MaxPooling2D,tfjs_core_1.serialization.registerClass(MaxPooling2D);var AveragePooling2D=function(_super){function AveragePooling2D(args){return _super.call(this,args)||this}return __extends(AveragePooling2D,_super),AveragePooling2D.prototype.poolingFunction=function(inputs,poolSize,strides,padding,dataFormat){return common_2.checkDataFormat(dataFormat),common_2.checkPaddingMode(padding),pool2d(inputs,poolSize,strides,padding,dataFormat,"avg")},AveragePooling2D.className="AveragePooling2D",AveragePooling2D}(Pooling2D);exports.AveragePooling2D=AveragePooling2D,tfjs_core_1.serialization.registerClass(AveragePooling2D);var Pooling3D=function(_super){function Pooling3D(args){var _this=this;if(null==args.poolSize&&(args.poolSize=[2,2,2]),(_this=_super.call(this,args)||this).poolSize=Array.isArray(args.poolSize)?args.poolSize:[args.poolSize,args.poolSize,args.poolSize],null==args.strides)_this.strides=_this.poolSize;else if(Array.isArray(args.strides)){if(3!==args.strides.length)throw new errors_1.ValueError("If the strides property of a 3D pooling layer is an Array, it is expected to have a length of 3, but received length "+args.strides.length+".");_this.strides=args.strides}else _this.strides=[args.strides,args.strides,args.strides];return generic_utils_1.assertPositiveInteger(_this.poolSize,"poolSize"),generic_utils_1.assertPositiveInteger(_this.strides,"strides"),_this.padding=null==args.padding?"valid":args.padding,_this.dataFormat=null==args.dataFormat?"channelsLast":args.dataFormat,common_2.checkDataFormat(_this.dataFormat),common_2.checkPaddingMode(_this.padding),_this.inputSpec=[new topology_1.InputSpec({ndim:5})],_this}return __extends(Pooling3D,_super),Pooling3D.prototype.computeOutputShape=function(inputShape){inputShape=types_utils_1.getExactlyOneShape(inputShape);var depths="channelsFirst"===this.dataFormat?inputShape[2]:inputShape[1],rows="channelsFirst"===this.dataFormat?inputShape[3]:inputShape[2],cols="channelsFirst"===this.dataFormat?inputShape[4]:inputShape[3];return depths=conv_utils_1.convOutputLength(depths,this.poolSize[0],this.padding,this.strides[0]),rows=conv_utils_1.convOutputLength(rows,this.poolSize[1],this.padding,this.strides[1]),cols=conv_utils_1.convOutputLength(cols,this.poolSize[2],this.padding,this.strides[2]),"channelsFirst"===this.dataFormat?[inputShape[0],inputShape[1],depths,rows,cols]:[inputShape[0],depths,rows,cols,inputShape[4]]},Pooling3D.prototype.call=function(inputs,kwargs){var _this=this;return tfjs_core_1.tidy(function(){return _this.invokeCallHook(inputs,kwargs),_this.poolingFunction(types_utils_1.getExactlyOneTensor(inputs),_this.poolSize,_this.strides,_this.padding,_this.dataFormat)})},Pooling3D.prototype.getConfig=function(){var config={poolSize:this.poolSize,padding:this.padding,strides:this.strides,dataFormat:this.dataFormat},baseConfig=_super.prototype.getConfig.call(this);return Object.assign(config,baseConfig),config},Pooling3D}(topology_2.Layer),MaxPooling3D=function(_super){function MaxPooling3D(args){return _super.call(this,args)||this}return __extends(MaxPooling3D,_super),MaxPooling3D.prototype.poolingFunction=function(inputs,poolSize,strides,padding,dataFormat){return common_2.checkDataFormat(dataFormat),common_2.checkPaddingMode(padding),pool3d(inputs,poolSize,strides,padding,dataFormat,"max")},MaxPooling3D.className="MaxPooling3D",MaxPooling3D}(exports.Pooling3D=Pooling3D);exports.MaxPooling3D=MaxPooling3D,tfjs_core_1.serialization.registerClass(MaxPooling3D);var AveragePooling3D=function(_super){function AveragePooling3D(args){return _super.call(this,args)||this}return __extends(AveragePooling3D,_super),AveragePooling3D.prototype.poolingFunction=function(inputs,poolSize,strides,padding,dataFormat){return common_2.checkDataFormat(dataFormat),common_2.checkPaddingMode(padding),pool3d(inputs,poolSize,strides,padding,dataFormat,"avg")},AveragePooling3D.className="AveragePooling3D",AveragePooling3D}(Pooling3D);exports.AveragePooling3D=AveragePooling3D,tfjs_core_1.serialization.registerClass(AveragePooling3D);var GlobalPooling1D=function(_super){function GlobalPooling1D(args){var _this=_super.call(this,args)||this;return _this.inputSpec=[new topology_1.InputSpec({ndim:3})],_this}return __extends(GlobalPooling1D,_super),GlobalPooling1D.prototype.computeOutputShape=function(inputShape){return[inputShape[0],inputShape[2]]},GlobalPooling1D.prototype.call=function(inputs,kwargs){throw new errors_1.NotImplementedError},GlobalPooling1D}(topology_2.Layer),GlobalAveragePooling1D=function(_super){function GlobalAveragePooling1D(args){return _super.call(this,args||{})||this}return __extends(GlobalAveragePooling1D,_super),GlobalAveragePooling1D.prototype.call=function(inputs,kwargs){return tfjs_core_1.tidy(function(){var input=types_utils_1.getExactlyOneTensor(inputs);return tfc.mean(input,1)})},GlobalAveragePooling1D.className="GlobalAveragePooling1D",GlobalAveragePooling1D}(exports.GlobalPooling1D=GlobalPooling1D);exports.GlobalAveragePooling1D=GlobalAveragePooling1D,tfjs_core_1.serialization.registerClass(GlobalAveragePooling1D);var GlobalMaxPooling1D=function(_super){function GlobalMaxPooling1D(args){return _super.call(this,args||{})||this}return __extends(GlobalMaxPooling1D,_super),GlobalMaxPooling1D.prototype.call=function(inputs,kwargs){return tfjs_core_1.tidy(function(){var input=types_utils_1.getExactlyOneTensor(inputs);return tfc.max(input,1)})},GlobalMaxPooling1D.className="GlobalMaxPooling1D",GlobalMaxPooling1D}(GlobalPooling1D);exports.GlobalMaxPooling1D=GlobalMaxPooling1D,tfjs_core_1.serialization.registerClass(GlobalMaxPooling1D);var GlobalPooling2D=function(_super){function GlobalPooling2D(args){var _this=_super.call(this,args)||this;return _this.dataFormat=null==args.dataFormat?"channelsLast":args.dataFormat,common_2.checkDataFormat(_this.dataFormat),_this.inputSpec=[new topology_1.InputSpec({ndim:4})],_this}return __extends(GlobalPooling2D,_super),GlobalPooling2D.prototype.computeOutputShape=function(inputShape){return inputShape=inputShape,"channelsLast"===this.dataFormat?[inputShape[0],inputShape[3]]:[inputShape[0],inputShape[1]]},GlobalPooling2D.prototype.call=function(inputs,kwargs){throw new errors_1.NotImplementedError},GlobalPooling2D.prototype.getConfig=function(){var config={dataFormat:this.dataFormat},baseConfig=_super.prototype.getConfig.call(this);return Object.assign(config,baseConfig),config},GlobalPooling2D}(topology_2.Layer),GlobalAveragePooling2D=function(_super){function GlobalAveragePooling2D(){return null!==_super&&_super.apply(this,arguments)||this}return __extends(GlobalAveragePooling2D,_super),GlobalAveragePooling2D.prototype.call=function(inputs,kwargs){var _this=this;return tfjs_core_1.tidy(function(){var input=types_utils_1.getExactlyOneTensor(inputs);return"channelsLast"===_this.dataFormat?tfc.mean(input,[1,2]):tfc.mean(input,[2,3])})},GlobalAveragePooling2D.className="GlobalAveragePooling2D",GlobalAveragePooling2D}(exports.GlobalPooling2D=GlobalPooling2D);exports.GlobalAveragePooling2D=GlobalAveragePooling2D,tfjs_core_1.serialization.registerClass(GlobalAveragePooling2D);var GlobalMaxPooling2D=function(_super){function GlobalMaxPooling2D(){return null!==_super&&_super.apply(this,arguments)||this}return __extends(GlobalMaxPooling2D,_super),GlobalMaxPooling2D.prototype.call=function(inputs,kwargs){var _this=this;return tfjs_core_1.tidy(function(){var input=types_utils_1.getExactlyOneTensor(inputs);return"channelsLast"===_this.dataFormat?tfc.max(input,[1,2]):tfc.max(input,[2,3])})},GlobalMaxPooling2D.className="GlobalMaxPooling2D",GlobalMaxPooling2D}(GlobalPooling2D);exports.GlobalMaxPooling2D=GlobalMaxPooling2D,tfjs_core_1.serialization.registerClass(GlobalMaxPooling2D)},{"../backend/common":274,"../backend/tfjs_backend":276,"../common":279,"../engine/topology":284,"../errors":289,"../utils/conv_utils":321,"../utils/generic_utils":322,"../utils/types_utils":326,"./convolutional":302,"@tensorflow/tfjs-core":148}],311:[function(require,module,exports){"use strict";var extendStatics,__extends=this&&this.__extends||(extendStatics=function(d,b){return(extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p])})(d,b)},function(d,b){function __(){this.constructor=d}extendStatics(d,b),d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)});Object.defineProperty(exports,"__esModule",{value:!0});var tfc=require("@tensorflow/tfjs-core"),tfjs_core_1=require("@tensorflow/tfjs-core"),activations_1=require("../activations"),K=require("../backend/tfjs_backend"),constraints_1=require("../constraints"),topology_1=require("../engine/topology"),topology_2=require("../engine/topology"),errors_1=require("../errors"),initializers_1=require("../initializers"),regularizers_1=require("../regularizers"),generic_utils_1=require("../utils/generic_utils"),math_utils=require("../utils/math_utils"),types_utils_1=require("../utils/types_utils"),variables_1=require("../variables"),serialization_1=require("./serialization");function standardizeArgs(inputs,initialState,constants,numConstants){if(Array.isArray(inputs)){if(null!=initialState||null!=constants)throw new errors_1.ValueError("When inputs is an array, neither initialState or constants should be provided");null!=numConstants&&(constants=inputs.slice(inputs.length-numConstants,inputs.length),inputs=inputs.slice(0,inputs.length-numConstants)),1<inputs.length&&(initialState=inputs.slice(1,inputs.length)),inputs=inputs[0]}function toListOrNull(x){return null==x||Array.isArray(x)?x:[x]}return{inputs:inputs,initialState:initialState=toListOrNull(initialState),constants:constants=toListOrNull(constants)}}function rnn(stepFunction,inputs,initialStates,goBackwards,mask,constants,unroll,needPerStepOutputs){return void 0===goBackwards&&(goBackwards=!1),void 0===unroll&&(unroll=!1),void 0===needPerStepOutputs&&(needPerStepOutputs=!1),tfc.tidy(function(){var ndim=inputs.shape.length;if(ndim<3)throw new errors_1.ValueError("Input should be at least 3D, but is "+ndim+"D.");var axes=[1,0].concat(math_utils.range(2,ndim));if(inputs=tfc.transpose(inputs,axes),null!=constants)throw new errors_1.NotImplementedError("The rnn() functoin of the deeplearn.js backend does not support constants yet.");unroll&&console.warn("Backend rnn(): the unroll = true option is not applicable to the imperative deeplearn.js backend."),null!=mask&&((mask=mask.asType("bool").asType("float32")).rank===ndim-1&&(mask=tfc.expandDims(mask,-1)),mask=tfc.transpose(mask,axes)),goBackwards&&(inputs=tfc.reverse(inputs,0),null!=mask&&(mask=tfc.reverse(mask,0)));var lastOutput,perStepMasks,perStepOutputs=[],states=initialStates,timeSteps=inputs.shape[0],perStepInputs=tfc.unstack(inputs);null!=mask&&(perStepMasks=tfc.unstack(mask));for(var outputs,_loop_1=function(t){var currentInput=perStepInputs[t],stepOutputs=tfc.tidy(function(){return stepFunction(currentInput,states)});if(null==mask)lastOutput=stepOutputs[0],states=stepOutputs[1];else{var maskedOutputs=tfc.tidy(function(){var stepMask=perStepMasks[t],negStepMask=tfc.onesLike(stepMask).sub(stepMask);return{output:stepOutputs[0].mul(stepMask).addStrict(states[0].mul(negStepMask)),newStates:states.map(function(state,i){return stepOutputs[1][i].mul(stepMask).addStrict(state.mul(negStepMask))})}});lastOutput=maskedOutputs.output,states=maskedOutputs.newStates}needPerStepOutputs&&perStepOutputs.push(lastOutput)},t=0;t<timeSteps;++t)_loop_1(t);if(needPerStepOutputs){outputs=tfc.stack(perStepOutputs,1)}return[lastOutput,outputs,states]})}exports.standardizeArgs=standardizeArgs,exports.rnn=rnn;var RNN=function(_super){function RNN(args){var cell,_this=_super.call(this,args)||this;if(null==args.cell)throw new errors_1.ValueError("cell property is missing for the constructor of RNN.");if(null==(cell=Array.isArray(args.cell)?new StackedRNNCells({cells:args.cell}):args.cell).stateSize)throw new errors_1.ValueError("The RNN cell should have an attribute `stateSize` (tuple of integers, one integer per RNN state).");return _this.cell=cell,_this.returnSequences=null!=args.returnSequences&&args.returnSequences,_this.returnState=null!=args.returnState&&args.returnState,_this.goBackwards=null!=args.goBackwards&&args.goBackwards,_this._stateful=null!=args.stateful&&args.stateful,_this.unroll=null!=args.unroll&&args.unroll,_this.supportsMasking=!0,_this.inputSpec=[new topology_1.InputSpec({ndim:3})],_this.stateSpec=null,_this.states_=null,_this.numConstants=null,_this.keptStates=[],_this}return __extends(RNN,_super),RNN.prototype.getStates=function(){if(null!=this.states_)return this.states_;var numStates=Array.isArray(this.cell.stateSize)?this.cell.stateSize.length:1;return math_utils.range(0,numStates).map(function(x){return null})},RNN.prototype.setStates=function(states){this.states_=states},RNN.prototype.computeOutputShape=function(inputShape){types_utils_1.isArrayOfShapes(inputShape)&&(inputShape=inputShape[0]),inputShape=inputShape;var stateSize=this.cell.stateSize;Array.isArray(stateSize)||(stateSize=[stateSize]);var outputShape,outputDim=stateSize[0];if(outputShape=this.returnSequences?[inputShape[0],inputShape[1],outputDim]:[inputShape[0],outputDim],this.returnState){for(var stateShape=[],_i=0,stateSize_1=stateSize;_i<stateSize_1.length;_i++){var dim=stateSize_1[_i];stateShape.push([inputShape[0],dim])}return[outputShape].concat(stateShape)}return outputShape},RNN.prototype.computeMask=function(inputs,mask){var _this=this;return tfc.tidy(function(){Array.isArray(mask)&&(mask=mask[0]);var outputMask=_this.returnSequences?mask:null;if(_this.returnState){var stateMask=_this.states.map(function(s){return null});return[outputMask].concat(stateMask)}return outputMask})},Object.defineProperty(RNN.prototype,"states",{get:function(){if(null!=this.states_)return this.states_;for(var numStates=Array.isArray(this.cell.stateSize)?this.cell.stateSize.length:1,output=[],i=0;i<numStates;++i)output.push(null);return output},set:function(s){this.states_=s},enumerable:!0,configurable:!0}),RNN.prototype.build=function(inputShape){if(null!=this.numConstants)throw new errors_1.NotImplementedError("Constants support is not implemented in RNN yet.");types_utils_1.isArrayOfShapes(inputShape)&&(inputShape=inputShape[0]),inputShape=inputShape;var batchSize=this.stateful?inputShape[0]:null,inputDim=inputShape[inputShape.length-1];this.inputSpec[0]=new topology_1.InputSpec({shape:[batchSize,null,inputDim]});var stateSize,stepInputShape=[inputShape[0]].concat(inputShape.slice(2));if(this.cell.build(stepInputShape),stateSize=Array.isArray(this.cell.stateSize)?this.cell.stateSize:[this.cell.stateSize],null!=this.stateSpec){if(!tfjs_core_1.util.arraysEqual(this.stateSpec.map(function(spec){return spec.shape[spec.shape.length-1]}),stateSize))throw new errors_1.ValueError("An initialState was passed that is not compatible with cell.stateSize. Received stateSpec="+this.stateSpec+"; However cell.stateSize is "+this.cell.stateSize)}else this.stateSpec=stateSize.map(function(dim){return new topology_1.InputSpec({shape:[null,dim]})});this.stateful&&this.resetStates()},RNN.prototype.resetStates=function(states,training){var _this=this;void 0===training&&(training=!1),tfjs_core_1.tidy(function(){if(!_this.stateful)throw new errors_1.AttributeError("Cannot call resetStates() on an RNN Layer that is not stateful.");var batchSize=_this.inputSpec[0].shape[0];if(null==batchSize)throw new errors_1.ValueError("If an RNN is stateful, it needs to know its batch size. Specify the batch size of your input tensors: \n- If using a Sequential model, specify the batch size by passing a `batchInputShape` option to your first layer.\n- If using the functional API, specify the batch size by passing a `batchShape` option to your Input layer.");if(null==_this.states_)Array.isArray(_this.cell.stateSize)?_this.states_=_this.cell.stateSize.map(function(dim){return tfc.zeros([batchSize,dim])}):_this.states_=[tfc.zeros([batchSize,_this.cell.stateSize])];else if(null==states)tfc.dispose(_this.states_),null!=_this.keptStates&&(tfc.dispose(_this.keptStates),_this.keptStates=[]),Array.isArray(_this.cell.stateSize)?_this.states_=_this.cell.stateSize.map(function(dim){return tfc.zeros([batchSize,dim])}):_this.states_[0]=tfc.zeros([batchSize,_this.cell.stateSize]);else{if(Array.isArray(states)||(states=[states]),states.length!==_this.states_.length)throw new errors_1.ValueError("Layer "+_this.name+" expects "+_this.states_.length+" state(s), but it received "+states.length+" state value(s). Input received: "+states);!0===training?_this.keptStates.push(_this.states_.slice()):tfc.dispose(_this.states_);for(var index=0;index<_this.states_.length;++index){var value=states[index],dim=Array.isArray(_this.cell.stateSize)?_this.cell.stateSize[index]:_this.cell.stateSize,expectedShape=[batchSize,dim];if(!tfjs_core_1.util.arraysEqual(value.shape,expectedShape))throw new errors_1.ValueError("State "+index+" is incompatible with layer "+_this.name+": expected shape="+expectedShape+", received shape="+value.shape);_this.states_[index]=value}}_this.states_=_this.states_.map(function(state){return tfc.keep(state.clone())})})},RNN.prototype.apply=function(inputs,kwargs){var initialState=null==kwargs?null:kwargs.initialState,constants=null==kwargs?null:kwargs.constants;null==kwargs&&(kwargs={});var standardized=standardizeArgs(inputs,initialState,constants,this.numConstants);inputs=standardized.inputs,initialState=standardized.initialState,constants=standardized.constants;var additionalInputs=[],additionalSpecs=[];if(null!=initialState){kwargs.initialState=initialState,additionalInputs=additionalInputs.concat(initialState),this.stateSpec=[];for(var _i=0,initialState_1=initialState;_i<initialState_1.length;_i++){var state=initialState_1[_i];this.stateSpec.push(new topology_1.InputSpec({shape:state.shape}))}additionalSpecs=additionalSpecs.concat(this.stateSpec)}if(null!=constants&&(kwargs.constants=constants,additionalInputs=additionalInputs.concat(constants),this.numConstants=constants.length),additionalInputs[0]instanceof topology_1.SymbolicTensor){var fullInput=[inputs].concat(additionalInputs),fullInputSpec=this.inputSpec.concat(additionalSpecs),originalInputSpec=this.inputSpec;this.inputSpec=fullInputSpec;var output=_super.prototype.apply.call(this,fullInput,kwargs);return this.inputSpec=originalInputSpec,output}return _super.prototype.apply.call(this,inputs,kwargs)},RNN.prototype.call=function(inputs,kwargs){var _this=this;return tfjs_core_1.tidy(function(){var mask=null==kwargs?null:kwargs.mask,training=null==kwargs?null:kwargs.training,initialState=null==kwargs?null:kwargs.initialState;inputs=types_utils_1.getExactlyOneTensor(inputs),null==initialState&&(initialState=_this.stateful?_this.states_:_this.getInitialState(inputs));var numStates=Array.isArray(_this.cell.stateSize)?_this.cell.stateSize.length:1;if(initialState.length!==numStates)throw new errors_1.ValueError("RNN Layer has "+numStates+" state(s) but was passed "+initialState.length+" initial state(s).");_this.unroll&&console.warn("Ignoring unroll = true for RNN layer, due to imperative backend.");var cellCallKwargs={training:training},rnnOutputs=rnn(function(inputs,states){var outputs=_this.cell.call([inputs].concat(states),cellCallKwargs);return[outputs[0],outputs.slice(1)]},inputs,initialState,_this.goBackwards,mask,null,_this.unroll,_this.returnSequences),lastOutput=rnnOutputs[0],outputs=rnnOutputs[1],states=rnnOutputs[2];_this.stateful&&_this.resetStates(states,training);var output=_this.returnSequences?outputs:lastOutput;return _this.returnState?[output].concat(states):output})},RNN.prototype.getInitialState=function(inputs){var _this=this;return tfjs_core_1.tidy(function(){var initialState=tfc.zeros(inputs.shape);return initialState=tfc.sum(initialState,[1,2]),initialState=K.expandDims(initialState),Array.isArray(_this.cell.stateSize)?_this.cell.stateSize.map(function(dim){return 1<dim?K.tile(initialState,[1,dim]):initialState}):1<_this.cell.stateSize?[K.tile(initialState,[1,_this.cell.stateSize])]:[initialState]})},Object.defineProperty(RNN.prototype,"trainableWeights",{get:function(){return this.trainable?this.cell.trainableWeights:[]},enumerable:!0,configurable:!0}),Object.defineProperty(RNN.prototype,"nonTrainableWeights",{get:function(){return this.trainable?this.cell.nonTrainableWeights:this.cell.weights},enumerable:!0,configurable:!0}),RNN.prototype.setFastWeightInitDuringBuild=function(value){_super.prototype.setFastWeightInitDuringBuild.call(this,value),null!=this.cell&&this.cell.setFastWeightInitDuringBuild(value)},RNN.prototype.getConfig=function(){var config={returnSequences:this.returnSequences,returnState:this.returnState,goBackwards:this.goBackwards,stateful:this.stateful,unroll:this.unroll};null!=this.numConstants&&(config.numConstants=this.numConstants);var cellConfig=this.cell.getConfig();config.cell={className:this.cell.getClassName(),config:cellConfig};var baseConfig=_super.prototype.getConfig.call(this);return Object.assign(config,baseConfig),config},RNN.fromConfig=function(cls,config,customObjects){void 0===customObjects&&(customObjects={});var cellConfig=config.cell,cell=serialization_1.deserialize(cellConfig,customObjects);return new cls(Object.assign(config,{cell:cell}))},RNN.className="RNN",RNN}(topology_2.Layer);exports.RNN=RNN,tfjs_core_1.serialization.registerClass(RNN);var RNNCell=function(_super){function RNNCell(){return null!==_super&&_super.apply(this,arguments)||this}return __extends(RNNCell,_super),RNNCell}(topology_2.Layer),SimpleRNNCell=function(_super){function SimpleRNNCell(args){var _this=_super.call(this,args)||this;return _this.DEFAULT_ACTIVATION="tanh",_this.DEFAULT_KERNEL_INITIALIZER="glorotNormal",_this.DEFAULT_RECURRENT_INITIALIZER="orthogonal",_this.DEFAULT_BIAS_INITIALIZER="zeros",_this.units=args.units,generic_utils_1.assertPositiveInteger(_this.units,"units"),_this.activation=activations_1.getActivation(null==args.activation?_this.DEFAULT_ACTIVATION:args.activation),_this.useBias=null==args.useBias||args.useBias,_this.kernelInitializer=initializers_1.getInitializer(args.kernelInitializer||_this.DEFAULT_KERNEL_INITIALIZER),_this.recurrentInitializer=initializers_1.getInitializer(args.recurrentInitializer||_this.DEFAULT_RECURRENT_INITIALIZER),_this.biasInitializer=initializers_1.getInitializer(args.biasInitializer||_this.DEFAULT_BIAS_INITIALIZER),_this.kernelRegularizer=regularizers_1.getRegularizer(args.kernelRegularizer),_this.recurrentRegularizer=regularizers_1.getRegularizer(args.recurrentRegularizer),_this.biasRegularizer=regularizers_1.getRegularizer(args.biasRegularizer),_this.kernelConstraint=constraints_1.getConstraint(args.kernelConstraint),_this.recurrentConstraint=constraints_1.getConstraint(args.recurrentConstraint),_this.biasConstraint=constraints_1.getConstraint(args.biasConstraint),_this.dropout=math_utils.min([1,math_utils.max([0,null==args.dropout?0:args.dropout])]),_this.recurrentDropout=math_utils.min([1,math_utils.max([0,null==args.recurrentDropout?0:args.recurrentDropout])]),_this.stateSize=_this.units,_this.dropoutMask=null,_this.recurrentDropoutMask=null,_this}return __extends(SimpleRNNCell,_super),SimpleRNNCell.prototype.build=function(inputShape){inputShape=types_utils_1.getExactlyOneShape(inputShape),this.kernel=this.addWeight("kernel",[inputShape[inputShape.length-1],this.units],null,this.kernelInitializer,this.kernelRegularizer,!0,this.kernelConstraint),this.recurrentKernel=this.addWeight("recurrent_kernel",[this.units,this.units],null,this.recurrentInitializer,this.recurrentRegularizer,!0,this.recurrentConstraint),this.useBias?this.bias=this.addWeight("bias",[this.units],null,this.biasInitializer,this.biasRegularizer,!0,this.biasConstraint):this.bias=null,this.built=!0},SimpleRNNCell.prototype.call=function(inputs,kwargs){var _this=this;return tfjs_core_1.tidy(function(){if(2!==(inputs=inputs).length)throw new errors_1.ValueError("SimpleRNNCell expects 2 input Tensors, got "+inputs.length+".");var prevOutput=inputs[1];inputs=inputs[0];var h,training=null!=kwargs.training&&kwargs.training;0<_this.dropout&&_this.dropout<1&&null==_this.dropoutMask&&(_this.dropoutMask=generateDropoutMask(function(){return tfc.onesLike(inputs)},_this.dropout,training)),0<_this.recurrentDropout&&_this.recurrentDropout<1&&null==_this.recurrentDropoutMask&&(_this.recurrentDropoutMask=generateDropoutMask(function(){return tfc.onesLike(prevOutput)},_this.recurrentDropout,training));var dpMask=_this.dropoutMask,recDpMask=_this.recurrentDropoutMask;h=null!=dpMask?K.dot(tfc.mul(inputs,dpMask),_this.kernel.read()):K.dot(inputs,_this.kernel.read()),null!=_this.bias&&(h=K.biasAdd(h,_this.bias.read())),null!=recDpMask&&(prevOutput=tfc.mul(prevOutput,recDpMask));var output=tfc.add(h,K.dot(prevOutput,_this.recurrentKernel.read()));return null!=_this.activation&&(output=_this.activation.apply(output)),[output,output]})},SimpleRNNCell.prototype.getConfig=function(){var config={units:this.units,activation:activations_1.serializeActivation(this.activation),useBias:this.useBias,kernelInitializer:initializers_1.serializeInitializer(this.kernelInitializer),recurrentInitializer:initializers_1.serializeInitializer(this.recurrentInitializer),biasInitializer:initializers_1.serializeInitializer(this.biasInitializer),kernelRegularizer:regularizers_1.serializeRegularizer(this.kernelRegularizer),recurrentRegularizer:regularizers_1.serializeRegularizer(this.recurrentRegularizer),biasRegularizer:regularizers_1.serializeRegularizer(this.biasRegularizer),activityRegularizer:regularizers_1.serializeRegularizer(this.activityRegularizer),kernelConstraint:constraints_1.serializeConstraint(this.kernelConstraint),recurrentConstraint:constraints_1.serializeConstraint(this.recurrentConstraint),biasConstraint:constraints_1.serializeConstraint(this.biasConstraint),dropout:this.dropout,recurrentDropout:this.recurrentDropout},baseConfig=_super.prototype.getConfig.call(this);return Object.assign(config,baseConfig),config},SimpleRNNCell.className="SimpleRNNCell",SimpleRNNCell}(exports.RNNCell=RNNCell);exports.SimpleRNNCell=SimpleRNNCell,tfjs_core_1.serialization.registerClass(SimpleRNNCell);var SimpleRNN=function(_super){function SimpleRNN(args){return args.cell=new SimpleRNNCell(args),_super.call(this,args)||this}return __extends(SimpleRNN,_super),SimpleRNN.prototype.call=function(inputs,kwargs){var _this=this;return tfjs_core_1.tidy(function(){null!=_this.cell.dropoutMask&&(tfc.dispose(_this.cell.dropoutMask),_this.cell.dropoutMask=null),null!=_this.cell.recurrentDropoutMask&&(tfc.dispose(_this.cell.recurrentDropoutMask),_this.cell.recurrentDropoutMask=null);var mask=null==kwargs?null:kwargs.mask,training=null==kwargs?null:kwargs.training,initialState=null==kwargs?null:kwargs.initialState;return _super.prototype.call.call(_this,inputs,{mask:mask,training:training,initialState:initialState})})},Object.defineProperty(SimpleRNN.prototype,"units",{get:function(){return this.cell.units},enumerable:!0,configurable:!0}),Object.defineProperty(SimpleRNN.prototype,"activation",{get:function(){return this.cell.activation},enumerable:!0,configurable:!0}),Object.defineProperty(SimpleRNN.prototype,"useBias",{get:function(){return this.cell.useBias},enumerable:!0,configurable:!0}),Object.defineProperty(SimpleRNN.prototype,"kernelInitializer",{get:function(){return this.cell.kernelInitializer},enumerable:!0,configurable:!0}),Object.defineProperty(SimpleRNN.prototype,"recurrentInitializer",{get:function(){return this.cell.recurrentInitializer},enumerable:!0,configurable:!0}),Object.defineProperty(SimpleRNN.prototype,"biasInitializer",{get:function(){return this.cell.biasInitializer},enumerable:!0,configurable:!0}),Object.defineProperty(SimpleRNN.prototype,"kernelRegularizer",{get:function(){return this.cell.kernelRegularizer},enumerable:!0,configurable:!0}),Object.defineProperty(SimpleRNN.prototype,"recurrentRegularizer",{get:function(){return this.cell.recurrentRegularizer},enumerable:!0,configurable:!0}),Object.defineProperty(SimpleRNN.prototype,"biasRegularizer",{get:function(){return this.cell.biasRegularizer},enumerable:!0,configurable:!0}),Object.defineProperty(SimpleRNN.prototype,"kernelConstraint",{get:function(){return this.cell.kernelConstraint},enumerable:!0,configurable:!0}),Object.defineProperty(SimpleRNN.prototype,"recurrentConstraint",{get:function(){return this.cell.recurrentConstraint},enumerable:!0,configurable:!0}),Object.defineProperty(SimpleRNN.prototype,"biasConstraint",{get:function(){return this.cell.biasConstraint},enumerable:!0,configurable:!0}),Object.defineProperty(SimpleRNN.prototype,"dropout",{get:function(){return this.cell.dropout},enumerable:!0,configurable:!0}),Object.defineProperty(SimpleRNN.prototype,"recurrentDropout",{get:function(){return this.cell.recurrentDropout},enumerable:!0,configurable:!0}),SimpleRNN.prototype.getConfig=function(){var config={units:this.units,activation:activations_1.serializeActivation(this.activation),useBias:this.useBias,kernelInitializer:initializers_1.serializeInitializer(this.kernelInitializer),recurrentInitializer:initializers_1.serializeInitializer(this.recurrentInitializer),biasInitializer:initializers_1.serializeInitializer(this.biasInitializer),kernelRegularizer:regularizers_1.serializeRegularizer(this.kernelRegularizer),recurrentRegularizer:regularizers_1.serializeRegularizer(this.recurrentRegularizer),biasRegularizer:regularizers_1.serializeRegularizer(this.biasRegularizer),activityRegularizer:regularizers_1.serializeRegularizer(this.activityRegularizer),kernelConstraint:constraints_1.serializeConstraint(this.kernelConstraint),recurrentConstraint:constraints_1.serializeConstraint(this.recurrentConstraint),biasConstraint:constraints_1.serializeConstraint(this.biasConstraint),dropout:this.dropout,recurrentDropout:this.recurrentDropout},baseConfig=_super.prototype.getConfig.call(this);return delete baseConfig.cell,Object.assign(config,baseConfig),config},SimpleRNN.fromConfig=function(cls,config){return new cls(config)},SimpleRNN.className="SimpleRNN",SimpleRNN}(RNN);exports.SimpleRNN=SimpleRNN,tfjs_core_1.serialization.registerClass(SimpleRNN);var GRUCell=function(_super){function GRUCell(args){var _this=_super.call(this,args)||this;return _this.DEFAULT_ACTIVATION="tanh",_this.DEFAULT_RECURRENT_ACTIVATION="hardSigmoid",_this.DEFAULT_KERNEL_INITIALIZER="glorotNormal",_this.DEFAULT_RECURRENT_INITIALIZER="orthogonal",_this.DEFAULT_BIAS_INITIALIZER="zeros",_this.units=args.units,generic_utils_1.assertPositiveInteger(_this.units,"units"),_this.activation=activations_1.getActivation(void 0===args.activation?_this.DEFAULT_ACTIVATION:args.activation),_this.recurrentActivation=activations_1.getActivation(void 0===args.recurrentActivation?_this.DEFAULT_RECURRENT_ACTIVATION:args.recurrentActivation),_this.useBias=null==args.useBias||args.useBias,_this.kernelInitializer=initializers_1.getInitializer(args.kernelInitializer||_this.DEFAULT_KERNEL_INITIALIZER),_this.recurrentInitializer=initializers_1.getInitializer(args.recurrentInitializer||_this.DEFAULT_RECURRENT_INITIALIZER),_this.biasInitializer=initializers_1.getInitializer(args.biasInitializer||_this.DEFAULT_BIAS_INITIALIZER),_this.kernelRegularizer=regularizers_1.getRegularizer(args.kernelRegularizer),_this.recurrentRegularizer=regularizers_1.getRegularizer(args.recurrentRegularizer),_this.biasRegularizer=regularizers_1.getRegularizer(args.biasRegularizer),_this.kernelConstraint=constraints_1.getConstraint(args.kernelConstraint),_this.recurrentConstraint=constraints_1.getConstraint(args.recurrentConstraint),_this.biasConstraint=constraints_1.getConstraint(args.biasConstraint),_this.dropout=math_utils.min([1,math_utils.max([0,null==args.dropout?0:args.dropout])]),_this.recurrentDropout=math_utils.min([1,math_utils.max([0,null==args.recurrentDropout?0:args.recurrentDropout])]),_this.implementation=args.implementation,_this.stateSize=_this.units,_this.dropoutMask=null,_this.recurrentDropoutMask=null,_this}return __extends(GRUCell,_super),GRUCell.prototype.build=function(inputShape){var inputDim=(inputShape=types_utils_1.getExactlyOneShape(inputShape))[inputShape.length-1];this.kernel=this.addWeight("kernel",[inputDim,3*this.units],null,this.kernelInitializer,this.kernelRegularizer,!0,this.kernelConstraint),this.recurrentKernel=this.addWeight("recurrent_kernel",[this.units,3*this.units],null,this.recurrentInitializer,this.recurrentRegularizer,!0,this.recurrentConstraint),this.useBias?this.bias=this.addWeight("bias",[3*this.units],null,this.biasInitializer,this.biasRegularizer,!0,this.biasConstraint):this.bias=null,this.built=!0},GRUCell.prototype.call=function(inputs,kwargs){var _this=this;return tfjs_core_1.tidy(function(){if(2!==(inputs=inputs).length)throw new errors_1.ValueError("GRUCell expects 2 input Tensors (inputs, h, c), got "+inputs.length+".");var training=null!=kwargs.training&&kwargs.training,hTMinus1=inputs[1];inputs=inputs[0],0<_this.dropout&&_this.dropout<1&&null==_this.dropoutMask&&(_this.dropoutMask=generateDropoutMask(function(){return tfc.onesLike(inputs)},_this.dropout,training,3)),0<_this.recurrentDropout&&_this.recurrentDropout<1&&null==_this.recurrentDropoutMask&&(_this.recurrentDropoutMask=generateDropoutMask(function(){return tfc.onesLike(hTMinus1)},_this.recurrentDropout,training,3));var z,r,hh,dpMask=_this.dropoutMask,recDpMask=_this.recurrentDropoutMask;0<_this.dropout&&_this.dropout<1&&(inputs=tfc.mul(inputs,dpMask[0]));var matrixX=K.dot(inputs,_this.kernel.read());_this.useBias&&(matrixX=K.biasAdd(matrixX,_this.bias.read())),0<_this.recurrentDropout&&_this.recurrentDropout<1&&(hTMinus1=tfc.mul(hTMinus1,recDpMask[0]));var recurrentKernelValue=_this.recurrentKernel.read(),_a=tfc.split(recurrentKernelValue,[2*_this.units,_this.units],recurrentKernelValue.rank-1),rk1=_a[0],rk2=_a[1],matrixInner=K.dot(hTMinus1,rk1),_b=tfc.split(matrixX,3,matrixX.rank-1),xZ=_b[0],xR=_b[1],xH=_b[2],_c=tfc.split(matrixInner,2,matrixInner.rank-1),recurrentZ=_c[0],recurrentR=_c[1];z=_this.recurrentActivation.apply(tfc.add(xZ,recurrentZ)),r=_this.recurrentActivation.apply(tfc.add(xR,recurrentR));var recurrentH=K.dot(tfc.mul(r,hTMinus1),rk2);hh=_this.activation.apply(tfc.add(xH,recurrentH));var h=tfc.add(tfc.mul(z,hTMinus1),tfc.mul(tfc.add(1,tfc.neg(z)),hh));return[h,h]})},GRUCell.prototype.getConfig=function(){var config={units:this.units,activation:activations_1.serializeActivation(this.activation),recurrentActivation:activations_1.serializeActivation(this.recurrentActivation),useBias:this.useBias,kernelInitializer:initializers_1.serializeInitializer(this.kernelInitializer),recurrentInitializer:initializers_1.serializeInitializer(this.recurrentInitializer),biasInitializer:initializers_1.serializeInitializer(this.biasInitializer),kernelRegularizer:regularizers_1.serializeRegularizer(this.kernelRegularizer),recurrentRegularizer:regularizers_1.serializeRegularizer(this.recurrentRegularizer),biasRegularizer:regularizers_1.serializeRegularizer(this.biasRegularizer),activityRegularizer:regularizers_1.serializeRegularizer(this.activityRegularizer),kernelConstraint:constraints_1.serializeConstraint(this.kernelConstraint),recurrentConstraint:constraints_1.serializeConstraint(this.recurrentConstraint),biasConstraint:constraints_1.serializeConstraint(this.biasConstraint),dropout:this.dropout,recurrentDropout:this.recurrentDropout,implementation:this.implementation},baseConfig=_super.prototype.getConfig.call(this);return Object.assign(config,baseConfig),config},GRUCell.className="GRUCell",GRUCell}(RNNCell);exports.GRUCell=GRUCell,tfjs_core_1.serialization.registerClass(GRUCell);var GRU=function(_super){function GRU(args){return 0===args.implementation&&console.warn("`implementation=0` has been deprecated, and now defaults to `implementation=1`. Please update your layer call."),args.cell=new GRUCell(args),_super.call(this,args)||this}return __extends(GRU,_super),GRU.prototype.call=function(inputs,kwargs){var _this=this;return tfjs_core_1.tidy(function(){null!=_this.cell.dropoutMask&&(tfc.dispose(_this.cell.dropoutMask),_this.cell.dropoutMask=null),null!=_this.cell.recurrentDropoutMask&&(tfc.dispose(_this.cell.recurrentDropoutMask),_this.cell.recurrentDropoutMask=null);var mask=null==kwargs?null:kwargs.mask,training=null==kwargs?null:kwargs.training,initialState=null==kwargs?null:kwargs.initialState;return _super.prototype.call.call(_this,inputs,{mask:mask,training:training,initialState:initialState})})},Object.defineProperty(GRU.prototype,"units",{get:function(){return this.cell.units},enumerable:!0,configurable:!0}),Object.defineProperty(GRU.prototype,"activation",{get:function(){return this.cell.activation},enumerable:!0,configurable:!0}),Object.defineProperty(GRU.prototype,"recurrentActivation",{get:function(){return this.cell.recurrentActivation},enumerable:!0,configurable:!0}),Object.defineProperty(GRU.prototype,"useBias",{get:function(){return this.cell.useBias},enumerable:!0,configurable:!0}),Object.defineProperty(GRU.prototype,"kernelInitializer",{get:function(){return this.cell.kernelInitializer},enumerable:!0,configurable:!0}),Object.defineProperty(GRU.prototype,"recurrentInitializer",{get:function(){return this.cell.recurrentInitializer},enumerable:!0,configurable:!0}),Object.defineProperty(GRU.prototype,"biasInitializer",{get:function(){return this.cell.biasInitializer},enumerable:!0,configurable:!0}),Object.defineProperty(GRU.prototype,"kernelRegularizer",{get:function(){return this.cell.kernelRegularizer},enumerable:!0,configurable:!0}),Object.defineProperty(GRU.prototype,"recurrentRegularizer",{get:function(){return this.cell.recurrentRegularizer},enumerable:!0,configurable:!0}),Object.defineProperty(GRU.prototype,"biasRegularizer",{get:function(){return this.cell.biasRegularizer},enumerable:!0,configurable:!0}),Object.defineProperty(GRU.prototype,"kernelConstraint",{get:function(){return this.cell.kernelConstraint},enumerable:!0,configurable:!0}),Object.defineProperty(GRU.prototype,"recurrentConstraint",{get:function(){return this.cell.recurrentConstraint},enumerable:!0,configurable:!0}),Object.defineProperty(GRU.prototype,"biasConstraint",{get:function(){return this.cell.biasConstraint},enumerable:!0,configurable:!0}),Object.defineProperty(GRU.prototype,"dropout",{get:function(){return this.cell.dropout},enumerable:!0,configurable:!0}),Object.defineProperty(GRU.prototype,"recurrentDropout",{get:function(){return this.cell.recurrentDropout},enumerable:!0,configurable:!0}),Object.defineProperty(GRU.prototype,"implementation",{get:function(){return this.cell.implementation},enumerable:!0,configurable:!0}),GRU.prototype.getConfig=function(){var config={units:this.units,activation:activations_1.serializeActivation(this.activation),recurrentActivation:activations_1.serializeActivation(this.recurrentActivation),useBias:this.useBias,kernelInitializer:initializers_1.serializeInitializer(this.kernelInitializer),recurrentInitializer:initializers_1.serializeInitializer(this.recurrentInitializer),biasInitializer:initializers_1.serializeInitializer(this.biasInitializer),kernelRegularizer:regularizers_1.serializeRegularizer(this.kernelRegularizer),recurrentRegularizer:regularizers_1.serializeRegularizer(this.recurrentRegularizer),biasRegularizer:regularizers_1.serializeRegularizer(this.biasRegularizer),activityRegularizer:regularizers_1.serializeRegularizer(this.activityRegularizer),kernelConstraint:constraints_1.serializeConstraint(this.kernelConstraint),recurrentConstraint:constraints_1.serializeConstraint(this.recurrentConstraint),biasConstraint:constraints_1.serializeConstraint(this.biasConstraint),dropout:this.dropout,recurrentDropout:this.recurrentDropout,implementation:this.implementation},baseConfig=_super.prototype.getConfig.call(this);return delete baseConfig.cell,Object.assign(config,baseConfig),config},GRU.fromConfig=function(cls,config){return 0===config.implmentation&&(config.implementation=1),new cls(config)},GRU.className="GRU",GRU}(RNN);exports.GRU=GRU,tfjs_core_1.serialization.registerClass(GRU);var LSTMCell=function(_super){function LSTMCell(args){var _this=_super.call(this,args)||this;return _this.DEFAULT_ACTIVATION="tanh",_this.DEFAULT_RECURRENT_ACTIVATION="hardSigmoid",_this.DEFAULT_KERNEL_INITIALIZER="glorotNormal",_this.DEFAULT_RECURRENT_INITIALIZER="orthogonal",_this.DEFAULT_BIAS_INITIALIZER="zeros",_this.units=args.units,generic_utils_1.assertPositiveInteger(_this.units,"units"),_this.activation=activations_1.getActivation(void 0===args.activation?_this.DEFAULT_ACTIVATION:args.activation),_this.recurrentActivation=activations_1.getActivation(void 0===args.recurrentActivation?_this.DEFAULT_RECURRENT_ACTIVATION:args.recurrentActivation),_this.useBias=null==args.useBias||args.useBias,_this.kernelInitializer=initializers_1.getInitializer(args.kernelInitializer||_this.DEFAULT_KERNEL_INITIALIZER),_this.recurrentInitializer=initializers_1.getInitializer(args.recurrentInitializer||_this.DEFAULT_RECURRENT_INITIALIZER),_this.biasInitializer=initializers_1.getInitializer(args.biasInitializer||_this.DEFAULT_BIAS_INITIALIZER),_this.unitForgetBias=args.unitForgetBias,_this.kernelRegularizer=regularizers_1.getRegularizer(args.kernelRegularizer),_this.recurrentRegularizer=regularizers_1.getRegularizer(args.recurrentRegularizer),_this.biasRegularizer=regularizers_1.getRegularizer(args.biasRegularizer),_this.kernelConstraint=constraints_1.getConstraint(args.kernelConstraint),_this.recurrentConstraint=constraints_1.getConstraint(args.recurrentConstraint),_this.biasConstraint=constraints_1.getConstraint(args.biasConstraint),_this.dropout=math_utils.min([1,math_utils.max([0,null==args.dropout?0:args.dropout])]),_this.recurrentDropout=math_utils.min([1,math_utils.max([0,null==args.recurrentDropout?0:args.recurrentDropout])]),_this.implementation=args.implementation,_this.stateSize=[_this.units,_this.units],_this.dropoutMask=null,_this.recurrentDropoutMask=null,_this}return __extends(LSTMCell,_super),LSTMCell.prototype.build=function(inputShape){var _a,biasInitializer,_super,inputDim=(inputShape=types_utils_1.getExactlyOneShape(inputShape))[inputShape.length-1];if(this.kernel=this.addWeight("kernel",[inputDim,4*this.units],null,this.kernelInitializer,this.kernelRegularizer,!0,this.kernelConstraint),this.recurrentKernel=this.addWeight("recurrent_kernel",[this.units,4*this.units],null,this.recurrentInitializer,this.recurrentRegularizer,!0,this.recurrentConstraint),this.useBias){if(this.unitForgetBias){var capturedBiasInit_1=this.biasInitializer,capturedUnits_1=this.units;_super=initializers_1.Initializer,__extends(CustomInit,_super),CustomInit.prototype.apply=function(shape,dtype){var bI=capturedBiasInit_1.apply([capturedUnits_1]),bF=(new initializers_1.Ones).apply([capturedUnits_1]),bCAndH=capturedBiasInit_1.apply([2*capturedUnits_1]);return K.concatAlongFirstAxis(K.concatAlongFirstAxis(bI,bF),bCAndH)},(_a=CustomInit).className="CustomInit",biasInitializer=new _a}else biasInitializer=this.biasInitializer;this.bias=this.addWeight("bias",[4*this.units],null,biasInitializer,this.biasRegularizer,!0,this.biasConstraint)}else this.bias=null;function CustomInit(){return null!==_super&&_super.apply(this,arguments)||this}this.built=!0},LSTMCell.prototype.call=function(inputs,kwargs){var _this=this;return tfjs_core_1.tidy(function(){var training=null!=kwargs.training&&kwargs.training;if(3!==(inputs=inputs).length)throw new errors_1.ValueError("LSTMCell expects 3 input Tensors (inputs, h, c), got "+inputs.length+".");var hTMinus1=inputs[1],cTMinus1=inputs[2];inputs=inputs[0],0<_this.dropout&&_this.dropout<1&&null==_this.dropoutMask&&(_this.dropoutMask=generateDropoutMask(function(){return tfc.onesLike(inputs)},_this.dropout,training,4)),0<_this.recurrentDropout&&_this.recurrentDropout<1&&null==_this.recurrentDropoutMask&&(_this.recurrentDropoutMask=generateDropoutMask(function(){return tfc.onesLike(hTMinus1)},_this.recurrentDropout,training,4));var i,f,c,o,dpMask=_this.dropoutMask,recDpMask=_this.recurrentDropoutMask;0<_this.dropout&&_this.dropout<1&&(inputs=tfc.mul(inputs,dpMask[0]));var z=K.dot(inputs,_this.kernel.read());0<_this.recurrentDropout&&_this.recurrentDropout<1&&(hTMinus1=tfc.mul(hTMinus1,recDpMask[0])),z=tfc.add(z,K.dot(hTMinus1,_this.recurrentKernel.read())),_this.useBias&&(z=K.biasAdd(z,_this.bias.read()));var _a=tfc.split(z,4,z.rank-1),z0=_a[0],z1=_a[1],z2=_a[2],z3=_a[3];i=_this.recurrentActivation.apply(z0),f=_this.recurrentActivation.apply(z1),c=tfc.add(tfc.mul(f,cTMinus1),tfc.mul(i,_this.activation.apply(z2))),o=_this.recurrentActivation.apply(z3);var h=tfc.mul(o,_this.activation.apply(c));return[h,h,c]})},LSTMCell.prototype.getConfig=function(){var config={units:this.units,activation:activations_1.serializeActivation(this.activation),recurrentActivation:activations_1.serializeActivation(this.recurrentActivation),useBias:this.useBias,kernelInitializer:initializers_1.serializeInitializer(this.kernelInitializer),recurrentInitializer:initializers_1.serializeInitializer(this.recurrentInitializer),biasInitializer:initializers_1.serializeInitializer(this.biasInitializer),unitForgetBias:this.unitForgetBias,kernelRegularizer:regularizers_1.serializeRegularizer(this.kernelRegularizer),recurrentRegularizer:regularizers_1.serializeRegularizer(this.recurrentRegularizer),biasRegularizer:regularizers_1.serializeRegularizer(this.biasRegularizer),activityRegularizer:regularizers_1.serializeRegularizer(this.activityRegularizer),kernelConstraint:constraints_1.serializeConstraint(this.kernelConstraint),recurrentConstraint:constraints_1.serializeConstraint(this.recurrentConstraint),biasConstraint:constraints_1.serializeConstraint(this.biasConstraint),dropout:this.dropout,recurrentDropout:this.recurrentDropout,implementation:this.implementation},baseConfig=_super.prototype.getConfig.call(this);return Object.assign(config,baseConfig),config},LSTMCell.className="LSTMCell",LSTMCell}(RNNCell);exports.LSTMCell=LSTMCell,tfjs_core_1.serialization.registerClass(LSTMCell);var LSTM=function(_super){function LSTM(args){return 0===args.implementation&&console.warn("`implementation=0` has been deprecated, and now defaults to `implementation=1`. Please update your layer call."),args.cell=new LSTMCell(args),_super.call(this,args)||this}return __extends(LSTM,_super),LSTM.prototype.call=function(inputs,kwargs){var _this=this;return tfjs_core_1.tidy(function(){null!=_this.cell.dropoutMask&&(tfc.dispose(_this.cell.dropoutMask),_this.cell.dropoutMask=null),null!=_this.cell.recurrentDropoutMask&&(tfc.dispose(_this.cell.recurrentDropoutMask),_this.cell.recurrentDropoutMask=null);var mask=null==kwargs?null:kwargs.mask,training=null==kwargs?null:kwargs.training,initialState=null==kwargs?null:kwargs.initialState;return _super.prototype.call.call(_this,inputs,{mask:mask,training:training,initialState:initialState})})},Object.defineProperty(LSTM.prototype,"units",{get:function(){return this.cell.units},enumerable:!0,configurable:!0}),Object.defineProperty(LSTM.prototype,"activation",{get:function(){return this.cell.activation},enumerable:!0,configurable:!0}),Object.defineProperty(LSTM.prototype,"recurrentActivation",{get:function(){return this.cell.recurrentActivation},enumerable:!0,configurable:!0}),Object.defineProperty(LSTM.prototype,"useBias",{get:function(){return this.cell.useBias},enumerable:!0,configurable:!0}),Object.defineProperty(LSTM.prototype,"kernelInitializer",{get:function(){return this.cell.kernelInitializer},enumerable:!0,configurable:!0}),Object.defineProperty(LSTM.prototype,"recurrentInitializer",{get:function(){return this.cell.recurrentInitializer},enumerable:!0,configurable:!0}),Object.defineProperty(LSTM.prototype,"biasInitializer",{get:function(){return this.cell.biasInitializer},enumerable:!0,configurable:!0}),Object.defineProperty(LSTM.prototype,"unitForgetBias",{get:function(){return this.cell.unitForgetBias},enumerable:!0,configurable:!0}),Object.defineProperty(LSTM.prototype,"kernelRegularizer",{get:function(){return this.cell.kernelRegularizer},enumerable:!0,configurable:!0}),Object.defineProperty(LSTM.prototype,"recurrentRegularizer",{get:function(){return this.cell.recurrentRegularizer},enumerable:!0,configurable:!0}),Object.defineProperty(LSTM.prototype,"biasRegularizer",{get:function(){return this.cell.biasRegularizer},enumerable:!0,configurable:!0}),Object.defineProperty(LSTM.prototype,"kernelConstraint",{get:function(){return this.cell.kernelConstraint},enumerable:!0,configurable:!0}),Object.defineProperty(LSTM.prototype,"recurrentConstraint",{get:function(){return this.cell.recurrentConstraint},enumerable:!0,configurable:!0}),Object.defineProperty(LSTM.prototype,"biasConstraint",{get:function(){return this.cell.biasConstraint},enumerable:!0,configurable:!0}),Object.defineProperty(LSTM.prototype,"dropout",{get:function(){return this.cell.dropout},enumerable:!0,configurable:!0}),Object.defineProperty(LSTM.prototype,"recurrentDropout",{get:function(){return this.cell.recurrentDropout},enumerable:!0,configurable:!0}),Object.defineProperty(LSTM.prototype,"implementation",{get:function(){return this.cell.implementation},enumerable:!0,configurable:!0}),LSTM.prototype.getConfig=function(){var config={units:this.units,activation:activations_1.serializeActivation(this.activation),recurrentActivation:activations_1.serializeActivation(this.recurrentActivation),useBias:this.useBias,kernelInitializer:initializers_1.serializeInitializer(this.kernelInitializer),recurrentInitializer:initializers_1.serializeInitializer(this.recurrentInitializer),biasInitializer:initializers_1.serializeInitializer(this.biasInitializer),unitForgetBias:this.unitForgetBias,kernelRegularizer:regularizers_1.serializeRegularizer(this.kernelRegularizer),recurrentRegularizer:regularizers_1.serializeRegularizer(this.recurrentRegularizer),biasRegularizer:regularizers_1.serializeRegularizer(this.biasRegularizer),activityRegularizer:regularizers_1.serializeRegularizer(this.activityRegularizer),kernelConstraint:constraints_1.serializeConstraint(this.kernelConstraint),recurrentConstraint:constraints_1.serializeConstraint(this.recurrentConstraint),biasConstraint:constraints_1.serializeConstraint(this.biasConstraint),dropout:this.dropout,recurrentDropout:this.recurrentDropout,implementation:this.implementation},baseConfig=_super.prototype.getConfig.call(this);return delete baseConfig.cell,Object.assign(config,baseConfig),config},LSTM.fromConfig=function(cls,config){return 0===config.implmentation&&(config.implementation=1),new cls(config)},LSTM.className="LSTM",LSTM}(RNN);exports.LSTM=LSTM,tfjs_core_1.serialization.registerClass(LSTM);var StackedRNNCells=function(_super){function StackedRNNCells(args){var _this=_super.call(this,args)||this;return _this.cells=args.cells,_this}return __extends(StackedRNNCells,_super),Object.defineProperty(StackedRNNCells.prototype,"stateSize",{get:function(){for(var stateSize=[],_i=0,_a=this.cells.slice().reverse();_i<_a.length;_i++){var cell=_a[_i];Array.isArray(cell.stateSize)?stateSize.push.apply(stateSize,cell.stateSize):stateSize.push(cell.stateSize)}return stateSize},enumerable:!0,configurable:!0}),StackedRNNCells.prototype.call=function(inputs,kwargs){var _this=this;return tfjs_core_1.tidy(function(){for(var states=(inputs=inputs).slice(1),nestedStates=[],_i=0,_a=_this.cells.slice().reverse();_i<_a.length;_i++){var cell=_a[_i];Array.isArray(cell.stateSize)?nestedStates.push(states.splice(0,cell.stateSize.length)):nestedStates.push(states.splice(0,1))}nestedStates.reverse();for(var callInputs,newNestedStates=[],i=0;i<_this.cells.length;++i){cell=_this.cells[i];states=nestedStates[i],callInputs=0===i?[inputs[0]].concat(states):[callInputs[0]].concat(states),callInputs=cell.call(callInputs,kwargs),newNestedStates.push(callInputs.slice(1))}states=[];for(var _b=0,_c=newNestedStates.slice().reverse();_b<_c.length;_b++){var cellStates=_c[_b];states.push.apply(states,cellStates)}return[callInputs[0]].concat(states)})},StackedRNNCells.prototype.build=function(inputShape){var outputDim;types_utils_1.isArrayOfShapes(inputShape)&&(inputShape=inputShape[0]),inputShape=inputShape;for(var _i=0,_a=this.cells;_i<_a.length;_i++){var cell=_a[_i];cell.build(inputShape),outputDim=Array.isArray(cell.stateSize)?cell.stateSize[0]:cell.stateSize,inputShape=[inputShape[0],outputDim]}this.built=!0},StackedRNNCells.prototype.getConfig=function(){for(var cellConfigs=[],_i=0,_a=this.cells;_i<_a.length;_i++){var cell=_a[_i];cellConfigs.push({className:cell.getClassName(),config:cell.getConfig()})}var config={cells:cellConfigs},baseConfig=_super.prototype.getConfig.call(this);return Object.assign(config,baseConfig),config},StackedRNNCells.fromConfig=function(cls,config,customObjects){void 0===customObjects&&(customObjects={});for(var cells=[],_i=0,_a=config.cells;_i<_a.length;_i++){var cellConfig=_a[_i];cells.push(serialization_1.deserialize(cellConfig,customObjects))}return new cls({cells:cells})},Object.defineProperty(StackedRNNCells.prototype,"trainableWeights",{get:function(){if(!this.trainable)return[];for(var weights=[],_i=0,_a=this.cells;_i<_a.length;_i++){var cell=_a[_i];weights.push.apply(weights,cell.trainableWeights)}return weights},enumerable:!0,configurable:!0}),Object.defineProperty(StackedRNNCells.prototype,"nonTrainableWeights",{get:function(){for(var weights=[],_i=0,_a=this.cells;_i<_a.length;_i++){var cell=_a[_i];weights.push.apply(weights,cell.nonTrainableWeights)}if(this.trainable)return weights;for(var trainableWeights=[],_b=0,_c=this.cells;_b<_c.length;_b++){cell=_c[_b];trainableWeights.push.apply(trainableWeights,cell.trainableWeights)}return trainableWeights.concat(weights)},enumerable:!0,configurable:!0}),StackedRNNCells.prototype.getWeights=function(){for(var weights=[],_i=0,_a=this.cells;_i<_a.length;_i++){var cell=_a[_i];weights.push.apply(weights,cell.weights)}return variables_1.batchGetValue(weights)},StackedRNNCells.prototype.setWeights=function(weights){for(var tuples=[],_i=0,_a=this.cells;_i<_a.length;_i++)for(var cell=_a[_i],numParams=cell.weights.length,inputWeights=weights.splice(numParams),i=0;i<cell.weights.length;++i)tuples.push([cell.weights[i],inputWeights[i]]);variables_1.batchSetValue(tuples)},StackedRNNCells.className="StackedRNNCells",StackedRNNCells}(RNNCell);function generateDropoutMask(ones,rate,training,count){function droppedInputs(){return K.dropout(ones(),rate)}if(void 0===training&&(training=null),void 0===count&&(count=1),1<count){for(var mask=[],i=0;i<count;i++)mask.push(K.inTrainPhase(droppedInputs,ones,training));return mask.map(function(m){return tfc.keep(m.clone())})}return tfc.keep(K.inTrainPhase(droppedInputs,ones,training).clone())}exports.StackedRNNCells=StackedRNNCells,tfjs_core_1.serialization.registerClass(StackedRNNCells)},{"../activations":273,"../backend/tfjs_backend":276,"../constraints":280,"../engine/topology":284,"../errors":289,"../initializers":298,"../regularizers":319,"../utils/generic_utils":322,"../utils/math_utils":324,"../utils/types_utils":326,"../variables":328,"./serialization":312,"@tensorflow/tfjs-core":148}],312:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var tfjs_core_1=require("@tensorflow/tfjs-core"),generic_utils_1=require("../utils/generic_utils");exports.deserialize=function(config,customObjects,fastWeightInit){return void 0===customObjects&&(customObjects={}),void 0===fastWeightInit&&(fastWeightInit=!1),generic_utils_1.deserializeKerasObject(config,tfjs_core_1.serialization.SerializationMap.getMap().classNameMap,customObjects,"layer",fastWeightInit)}},{"../utils/generic_utils":322,"@tensorflow/tfjs-core":148}],313:[function(require,module,exports){"use strict";var extendStatics,__extends=this&&this.__extends||(extendStatics=function(d,b){return(extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p])})(d,b)},function(d,b){function __(){this.constructor=d}extendStatics(d,b),d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)});Object.defineProperty(exports,"__esModule",{value:!0});var tfc=require("@tensorflow/tfjs-core"),tfjs_core_1=require("@tensorflow/tfjs-core"),K=require("../backend/tfjs_backend"),common_1=require("../common"),topology_1=require("../engine/topology"),errors_1=require("../errors"),common_2=require("../keras_format/common"),generic_utils=require("../utils/generic_utils"),types_utils_1=require("../utils/types_utils"),recurrent_1=require("./recurrent"),serialization_1=require("./serialization"),Wrapper=function(_super){function Wrapper(args){var _this=_super.call(this,args)||this;return _this.layer=args.layer,_this}return __extends(Wrapper,_super),Wrapper.prototype.build=function(inputShape){this.built=!0},Object.defineProperty(Wrapper.prototype,"trainable",{get:function(){return null!=this.layer&&this.layer.trainable},set:function(value){null!=this.layer&&(this.layer.trainable=value)},enumerable:!0,configurable:!0}),Object.defineProperty(Wrapper.prototype,"trainableWeights",{get:function(){return this.layer.trainableWeights},enumerable:!0,configurable:!0}),Object.defineProperty(Wrapper.prototype,"nonTrainableWeights",{get:function(){return this.layer.nonTrainableWeights},enumerable:!0,configurable:!0}),Object.defineProperty(Wrapper.prototype,"updates",{get:function(){return this.layer._updates},enumerable:!0,configurable:!0}),Object.defineProperty(Wrapper.prototype,"losses",{get:function(){return this.layer.losses},enumerable:!0,configurable:!0}),Wrapper.prototype.getWeights=function(){return this.layer.getWeights()},Wrapper.prototype.setWeights=function(weights){this.layer.setWeights(weights)},Wrapper.prototype.getConfig=function(){var config={layer:{className:this.layer.getClassName(),config:this.layer.getConfig()}},baseConfig=_super.prototype.getConfig.call(this);return Object.assign(config,baseConfig),config},Wrapper.prototype.setFastWeightInitDuringBuild=function(value){_super.prototype.setFastWeightInitDuringBuild.call(this,value),null!=this.layer&&this.layer.setFastWeightInitDuringBuild(value)},Wrapper.fromConfig=function(cls,config,customObjects){void 0===customObjects&&(customObjects={});var layerConfig=config.layer,layer=serialization_1.deserialize(layerConfig,customObjects);delete config.layer;var newConfig={layer:layer};return Object.assign(newConfig,config),new cls(newConfig)},Wrapper}(topology_1.Layer),TimeDistributed=function(_super){function TimeDistributed(args){var _this=_super.call(this,args)||this;return _this.supportsMasking=!0,_this}return __extends(TimeDistributed,_super),TimeDistributed.prototype.build=function(inputShape){if((inputShape=types_utils_1.getExactlyOneShape(inputShape)).length<3)throw new errors_1.ValueError("TimeDistributed layer expects an input shape >= 3D, but received input shape "+JSON.stringify(inputShape));this.inputSpec=[{shape:inputShape}];var childInputShape=[inputShape[0]].concat(inputShape.slice(2));this.layer.built||(this.layer.build(childInputShape),this.layer.built=!0),_super.prototype.build.call(this,inputShape)},TimeDistributed.prototype.computeOutputShape=function(inputShape){var childInputShape=[(inputShape=types_utils_1.getExactlyOneShape(inputShape))[0]].concat(inputShape.slice(2)),childOutputShape=this.layer.computeOutputShape(childInputShape),timesteps=inputShape[1];return[childOutputShape[0],timesteps].concat(childOutputShape.slice(1))},TimeDistributed.prototype.call=function(inputs,kwargs){var _this=this;return tfjs_core_1.tidy(function(){inputs=types_utils_1.getExactlyOneTensor(inputs);return recurrent_1.rnn(function(inputs,states){return[types_utils_1.getExactlyOneTensor(_this.layer.call(inputs,kwargs)),[]]},inputs,[],!1,null,null,!1,!0)[1]})},TimeDistributed.className="TimeDistributed",TimeDistributed}(exports.Wrapper=Wrapper);function checkBidirectionalMergeMode(value){generic_utils.checkStringTypeUnionValue(common_2.VALID_BIDIRECTIONAL_MERGE_MODES,"BidirectionalMergeMode",value)}exports.TimeDistributed=TimeDistributed,tfjs_core_1.serialization.registerClass(TimeDistributed),exports.checkBidirectionalMergeMode=checkBidirectionalMergeMode;var Bidirectional=function(_super){function Bidirectional(args){var _this=_super.call(this,args)||this,layerConfig=args.layer.getConfig(),forwDict={};forwDict.className=args.layer.getClassName(),forwDict.config=layerConfig,_this.forwardLayer=serialization_1.deserialize(forwDict),layerConfig.goBackwards=!0!==layerConfig.goBackwards;var backDict={};if(backDict.className=args.layer.getClassName(),backDict.config=layerConfig,_this.backwardLayer=serialization_1.deserialize(backDict),_this.forwardLayer.name="forward_"+_this.forwardLayer.name,_this.backwardLayer.name="backward_"+_this.backwardLayer.name,_this.mergeMode=void 0===args.mergeMode?"concat":args.mergeMode,checkBidirectionalMergeMode(_this.mergeMode),args.weights)throw new errors_1.NotImplementedError("weights support is not implemented for Bidirectional layer yet.");return _this._stateful=args.layer.stateful,_this.returnSequences=args.layer.returnSequences,_this.returnState=args.layer.returnState,_this.supportsMasking=!0,_this._trainable=!0,_this.inputSpec=args.layer.inputSpec,_this.numConstants=null,_this}return __extends(Bidirectional,_super),Object.defineProperty(Bidirectional.prototype,"trainable",{get:function(){return this._trainable},set:function(value){this._trainable=value,null!=this.forwardLayer&&(this.forwardLayer.trainable=value),null!=this.backwardLayer&&(this.backwardLayer.trainable=value)},enumerable:!0,configurable:!0}),Bidirectional.prototype.getWeights=function(){return this.forwardLayer.getWeights().concat(this.backwardLayer.getWeights())},Bidirectional.prototype.setWeights=function(weights){var numWeights=weights.length,numeightsOver2=Math.floor(numWeights/2);this.forwardLayer.setWeights(weights.slice(0,numeightsOver2)),this.backwardLayer.setWeights(weights.slice(numeightsOver2))},Bidirectional.prototype.computeOutputShape=function(inputShape){var outputShape,outputShapes,stateShape,layerShapes=this.forwardLayer.computeOutputShape(inputShape);return Array.isArray(layerShapes)&&Array.isArray(layerShapes[0])||(layerShapes=[layerShapes]),layerShapes=layerShapes,outputShape=outputShape=(this.returnState&&(stateShape=layerShapes.slice(1)),layerShapes[0]),outputShapes="concat"===this.mergeMode?(outputShape[outputShape.length-1]*=2,[outputShape]):null==this.mergeMode?[outputShape,outputShape.slice()]:[outputShape],this.returnState?null==this.mergeMode?outputShapes.concat(stateShape).concat(stateShape.slice()):[outputShape].concat(stateShape).concat(stateShape.slice()):generic_utils.singletonOrArray(outputShapes)},Bidirectional.prototype.apply=function(inputs,kwargs){var initialState=null==kwargs?null:kwargs.initialState,constants=null==kwargs?null:kwargs.constants;null==kwargs&&(kwargs={});var standardized=recurrent_1.standardizeArgs(inputs,initialState,constants,this.numConstants);if(inputs=standardized.inputs,initialState=standardized.initialState,constants=standardized.constants,Array.isArray(inputs)&&(initialState=inputs.slice(1),inputs=inputs[0]),(null==initialState||0===initialState.length)&&null==constants)return _super.prototype.apply.call(this,inputs,kwargs);var additionalInputs=[],additionalSpecs=[];if(null!=initialState){var numStates=initialState.length;if(0<numStates%2)throw new errors_1.ValueError("When passing `initialState` to a Bidrectional RNN, the state should be an Array containing the states of the underlying RNNs.");kwargs.initialState=initialState,additionalInputs.push.apply(additionalInputs,initialState);var stateSpecs=initialState.map(function(state){return new topology_1.InputSpec({shape:state.shape})});this.forwardLayer.stateSpec=stateSpecs.slice(0,numStates/2),this.backwardLayer.stateSpec=stateSpecs.slice(numStates/2),additionalSpecs.push.apply(additionalSpecs,stateSpecs)}if(null!=constants)throw new errors_1.NotImplementedError("Support for constants in Bidirectional layers is not implemented yet.");for(var isSymbolicTensor=additionalInputs[0]instanceof topology_1.SymbolicTensor,_i=0,additionalInputs_1=additionalInputs;_i<additionalInputs_1.length;_i++){if(additionalInputs_1[_i]instanceof topology_1.SymbolicTensor!=isSymbolicTensor)throw new errors_1.ValueError("The initial state of a Bidirectional layer cannot be specified as a mix of symbolic and non-symbolic tensors")}if(isSymbolicTensor){var fullInput=[inputs].concat(additionalInputs),fullInputSpec=this.inputSpec.concat(additionalSpecs),originalInputSpec=this.inputSpec;this.inputSpec=fullInputSpec;var output=_super.prototype.apply.call(this,fullInput,kwargs);return this.inputSpec=originalInputSpec,output}return _super.prototype.apply.call(this,inputs,kwargs)},Bidirectional.prototype.call=function(inputs,kwargs){var _this=this;return tfjs_core_1.tidy(function(){if(null!=kwargs.mask)throw new errors_1.NotImplementedError("The support for masking is not implemented for Bidirectional layers yet.");var y,yRev,states,output,initialState=kwargs.initialState;if(null==initialState)y=_this.forwardLayer.call(inputs,kwargs),yRev=_this.backwardLayer.call(inputs,kwargs);else{var forwardState=initialState.slice(0,initialState.length/2),backwardState=initialState.slice(initialState.length/2);y=_this.forwardLayer.call(inputs,Object.assign(kwargs,{initialState:forwardState})),yRev=_this.backwardLayer.call(inputs,Object.assign(kwargs,{initialState:backwardState}))}return _this.returnState&&(Array.isArray(y)&&(states=y.slice(1).concat(yRev.slice(1))),y=y[0],yRev=yRev[0]),_this.returnSequences&&(yRev=tfc.reverse(yRev,1)),"concat"===_this.mergeMode?output=K.concatenate([y,yRev]):"sum"===_this.mergeMode?output=tfc.add(y,yRev):"ave"===_this.mergeMode?output=tfc.mul(.5,tfc.add(y,yRev)):"mul"===_this.mergeMode?output=tfc.mul(y,yRev):null==_this.mergeMode&&(output=[y,yRev]),_this.returnState?null==_this.mergeMode?output.concat(states):[output].concat(states):output})},Bidirectional.prototype.resetStates=function(states){this.forwardLayer.resetStates(),this.backwardLayer.resetStates()},Bidirectional.prototype.build=function(inputShape){var _this=this;common_1.nameScope(this.forwardLayer.name,function(){_this.forwardLayer.build(inputShape)}),common_1.nameScope(this.backwardLayer.name,function(){_this.backwardLayer.build(inputShape)}),this.built=!0},Object.defineProperty(Bidirectional.prototype,"trainableWeights",{get:function(){return this.forwardLayer.trainableWeights.concat(this.backwardLayer.trainableWeights)},enumerable:!0,configurable:!0}),Object.defineProperty(Bidirectional.prototype,"nonTrainableWeights",{get:function(){return this.forwardLayer.nonTrainableWeights.concat(this.backwardLayer.nonTrainableWeights)},enumerable:!0,configurable:!0}),Bidirectional.prototype.setFastWeightInitDuringBuild=function(value){_super.prototype.setFastWeightInitDuringBuild.call(this,value),null!=this.forwardLayer&&this.forwardLayer.setFastWeightInitDuringBuild(value),null!=this.backwardLayer&&this.backwardLayer.setFastWeightInitDuringBuild(value)},Bidirectional.prototype.getConfig=function(){var config={mergeMode:this.mergeMode},baseConfig=_super.prototype.getConfig.call(this);return Object.assign(config,baseConfig),config},Bidirectional.fromConfig=function(cls,config){var rnnLayer=serialization_1.deserialize(config.layer);if(delete config.layer,null!=config.numConstants)throw new errors_1.NotImplementedError("Deserialization of a Bidirectional layer with numConstants present is not supported yet.");var newConfig=config;return newConfig.layer=rnnLayer,new cls(newConfig)},Bidirectional.className="Bidirectional",Bidirectional}(Wrapper);exports.Bidirectional=Bidirectional,tfjs_core_1.serialization.registerClass(Bidirectional)},{"../backend/tfjs_backend":276,"../common":279,"../engine/topology":284,"../errors":289,"../keras_format/common":299,"../utils/generic_utils":322,"../utils/types_utils":326,"./recurrent":311,"./serialization":312,"@tensorflow/tfjs-core":148}],314:[function(require,module,exports){"use strict";var __awaiter=this&&this.__awaiter||function(thisArg,_arguments,P,generator){return new(P=P||Promise)(function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){result.done?resolve(result.value):new P(function(resolve){resolve(result.value)}).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())})},__generator=this&&this.__generator||function(thisArg,body){var f,y,t,g,_={label:0,sent:function(){if(1&t[0])throw t[1];return t[1]},trys:[],ops:[]};return g={next:verb(0),throw:verb(1),return:verb(2)},"function"==typeof Symbol&&(g[Symbol.iterator]=function(){return this}),g;function verb(n){return function(v){return function(op){if(f)throw new TypeError("Generator is already executing.");for(;_;)try{if(f=1,y&&(t=2&op[0]?y.return:op[0]?y.throw||((t=y.return)&&t.call(y),0):y.next)&&!(t=t.call(y,op[1])).done)return t;switch(y=0,t&&(op=[2&op[0],t.value]),op[0]){case 0:case 1:t=op;break;case 4:return _.label++,{value:op[1],done:!1};case 5:_.label++,y=op[1],op=[0];continue;case 7:op=_.ops.pop(),_.trys.pop();continue;default:if(!(t=0<(t=_.trys).length&&t[t.length-1])&&(6===op[0]||2===op[0])){_=0;continue}if(3===op[0]&&(!t||op[1]>t[0]&&op[1]<t[3])){_.label=op[1];break}if(6===op[0]&&_.label<t[1]){_.label=t[1],t=op;break}if(t&&_.label<t[2]){_.label=t[2],_.ops.push(op);break}t[2]&&_.ops.pop(),_.trys.pop();continue}op=body.call(thisArg,_)}catch(e){op=[6,e],y=0}finally{f=t=0}if(5&op[0])throw op[1];return{value:op[0]?op[1]:void 0,done:!0}}([n,v])}}};Object.defineProperty(exports,"__esModule",{value:!0});var tfjs_core_1=require("@tensorflow/tfjs-core");exports.resolveScalarsInLogs=function(logs){return __awaiter(this,void 0,void 0,function(){var promises,keys,scalarsToDispose,key,value,valueScalar,values,i;return __generator(this,function(_a){switch(_a.label){case 0:if(null==logs)return[2];for(key in promises=[],keys=[],scalarsToDispose=[],logs)"number"!=typeof(value=logs[key])&&(valueScalar=value,promises.push(valueScalar.data()),keys.push(key),scalarsToDispose.push(valueScalar));return 0<promises.length?[4,Promise.all(promises)]:[3,2];case 1:for(values=_a.sent(),i=0;i<values.length;++i)logs[keys[i]]=values[i][0];tfjs_core_1.dispose(scalarsToDispose),_a.label=2;case 2:return[2]}})})},exports.disposeTensorsInLogs=function(logs){if(null!=logs)for(var key in logs){var value=logs[key];"number"!=typeof value&&value.dispose()}}},{"@tensorflow/tfjs-core":148}],315:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var tfc=require("@tensorflow/tfjs-core"),tfjs_core_1=require("@tensorflow/tfjs-core"),common_1=require("./backend/common"),K=require("./backend/tfjs_backend"),errors_1=require("./errors");function l2Normalize(x,axis){return tfjs_core_1.tidy(function(){"float32"!==x.dtype&&(x=x.asType("float32"));var squareSum=tfc.sum(K.square(x),axis,!0),epsilonTensor=tfc.fill(squareSum.shape,common_1.epsilon()),norm=tfc.sqrt(tfc.maximum(squareSum,epsilonTensor));return tfc.div(x,norm)})}function meanSquaredError(yTrue,yPred){return tfjs_core_1.tidy(function(){return tfc.mean(K.square(tfc.sub(yPred,yTrue)),-1)})}function meanAbsoluteError(yTrue,yPred){return tfjs_core_1.tidy(function(){return tfc.mean(tfc.abs(tfc.sub(yPred,yTrue)),-1)})}function meanAbsolutePercentageError(yTrue,yPred){return tfjs_core_1.tidy(function(){var diff=tfc.sub(yTrue,yPred),clippedTrue=tfc.clipByValue(tfc.abs(yTrue),common_1.epsilon(),Number.MAX_VALUE),absResult=tfc.abs(tfc.div(diff,clippedTrue));return tfc.mul(100,tfc.mean(absResult,-1))})}function meanSquaredLogarithmicError(yTrue,yPred){return tfjs_core_1.tidy(function(){var clippedPred=tfc.clipByValue(yPred,common_1.epsilon(),Number.MAX_VALUE),firstLog=tfc.log(tfc.add(1,clippedPred)),clippedTrue=tfc.clipByValue(yTrue,common_1.epsilon(),Number.MAX_VALUE),secondLog=tfc.log(tfc.add(1,clippedTrue));return tfc.mean(K.square(tfc.sub(firstLog,secondLog)),-1)})}function squaredHinge(yTrue,yPred){return tfjs_core_1.tidy(function(){var maxResult=tfc.maximum(0,tfc.sub(1,tfc.mul(yTrue,yPred)));return tfc.mean(K.square(maxResult),-1)})}function hinge(yTrue,yPred){return tfjs_core_1.tidy(function(){var maxResult=tfc.maximum(0,tfc.sub(1,tfc.mul(yTrue,yPred)));return tfc.mean(maxResult,-1)})}function categoricalHinge(yTrue,yPred){return tfjs_core_1.tidy(function(){var pos=tfc.sum(tfc.mul(yTrue,yPred),-1),neg=tfc.max(tfc.mul(tfc.sub(1,yTrue),yPred),-1);return tfc.maximum(0,tfc.add(1,tfc.sub(neg,pos)))})}function logcosh(yTrue,yPred){return tfjs_core_1.tidy(function(){var log2=Math.log(2),predictionDiff=tfc.sub(yPred,yTrue),logcoshResult=tfc.sub(tfc.add(predictionDiff,tfc.softplus(tfc.mul(-2,predictionDiff))),log2);return tfc.mean(logcoshResult,-1)})}function categoricalCrossentropy(target,output,fromLogits){return void 0===fromLogits&&(fromLogits=!1),tfjs_core_1.tidy(function(){if(fromLogits)output=tfc.softmax(output);else{var outputSum=tfc.sum(output,output.shape.length-1,!0);output=tfc.div(output,outputSum)}return output=tfc.clipByValue(output,common_1.epsilon(),1-common_1.epsilon()),tfc.neg(tfc.sum(tfc.mul(target.toFloat(),tfc.log(output)),output.shape.length-1))})}function sparseCategoricalCrossentropy(target,output){return tfjs_core_1.tidy(function(){var flatTarget=tfc.floor(K.flatten(target)).toInt(),outputShape=(output=tfc.clipByValue(output,common_1.epsilon(),1-common_1.epsilon())).shape;return categoricalCrossentropy(tfc.oneHot(flatTarget,outputShape[outputShape.length-1]).reshape(outputShape),output,!1)})}function sigmoidCrossEntropyWithLogits(labels,logits){if(!tfjs_core_1.util.arraysEqual(labels.shape,logits.shape))throw new errors_1.ValueError("logits and labels must have the same shape, but got shapes "+JSON.stringify(labels.shape)+" and "+JSON.stringify(logits.shape));return tfjs_core_1.tidy(function(){var reluLogits=logits.relu(),negAbsLogits=logits.abs().neg();return reluLogits.sub(logits.mul(labels)).add(negAbsLogits.exp().log1p())})}function binaryCrossentropy(yTrue,yPred){return tfjs_core_1.tidy(function(){var y;return y=tfc.clipByValue(yPred,common_1.epsilon(),1-common_1.epsilon()),y=tfc.log(tfc.div(y,tfc.sub(1,y))),tfc.mean(sigmoidCrossEntropyWithLogits(yTrue,y),-1)})}function kullbackLeiblerDivergence(yTrue,yPred){return tfjs_core_1.tidy(function(){var clippedTrue=tfc.clipByValue(yTrue,common_1.epsilon(),1),clippedPred=tfc.clipByValue(yPred,common_1.epsilon(),1);return tfc.sum(tfc.mul(yTrue,tfc.log(tfc.div(clippedTrue,clippedPred))),-1)})}function poisson(yTrue,yPred){return tfjs_core_1.tidy(function(){var logPred=tfc.log(tfc.add(common_1.epsilon(),yPred));return tfc.mean(tfc.sub(yPred,tfc.mul(yTrue,logPred)),-1)})}function cosineProximity(yTrue,yPred){return tfjs_core_1.tidy(function(){var trueNormalized=l2Normalize(yTrue,-1),predNormalized=l2Normalize(yPred,-1),trueXPred=tfc.mul(trueNormalized,predNormalized);return tfc.neg(tfc.sum(trueXPred,-1))})}exports.l2Normalize=l2Normalize,exports.meanSquaredError=meanSquaredError,exports.meanAbsoluteError=meanAbsoluteError,exports.meanAbsolutePercentageError=meanAbsolutePercentageError,exports.meanSquaredLogarithmicError=meanSquaredLogarithmicError,exports.squaredHinge=squaredHinge,exports.hinge=hinge,exports.categoricalHinge=categoricalHinge,exports.logcosh=logcosh,exports.categoricalCrossentropy=categoricalCrossentropy,exports.sparseCategoricalCrossentropy=sparseCategoricalCrossentropy,exports.sigmoidCrossEntropyWithLogits=sigmoidCrossEntropyWithLogits,exports.binaryCrossentropy=binaryCrossentropy,exports.kullbackLeiblerDivergence=kullbackLeiblerDivergence,exports.poisson=poisson,exports.cosineProximity=cosineProximity,exports.mse=meanSquaredError,exports.MSE=meanSquaredError,exports.mae=meanAbsoluteError,exports.MAE=meanAbsoluteError,exports.mape=meanAbsolutePercentageError,exports.MAPE=meanAbsolutePercentageError,exports.msle=meanSquaredLogarithmicError,exports.MSLE=meanSquaredLogarithmicError,exports.kld=kullbackLeiblerDivergence,exports.KLD=kullbackLeiblerDivergence,exports.cosine=cosineProximity,exports.lossesMap={meanSquaredError:meanSquaredError,meanAbsoluteError:meanAbsoluteError,meanAbsolutePercentageError:meanAbsolutePercentageError,meanSquaredLogarithmicError:meanSquaredLogarithmicError,squaredHinge:squaredHinge,hinge:hinge,categoricalHinge:categoricalHinge,logcosh:logcosh,categoricalCrossentropy:categoricalCrossentropy,sparseCategoricalCrossentropy:sparseCategoricalCrossentropy,binaryCrossentropy:binaryCrossentropy,kullbackLeiblerDivergence:kullbackLeiblerDivergence,poisson:poisson,cosineProximity:cosineProximity},exports.get=function(identifierOrFn){if("string"!=typeof identifierOrFn)return identifierOrFn;if(identifierOrFn in exports.lossesMap)return exports.lossesMap[identifierOrFn];var errMsg="Unknown loss "+identifierOrFn;throw identifierOrFn.toLowerCase().includes("softmaxcrossentropy")&&(errMsg="Unknown loss "+identifierOrFn+'. Use "categoricalCrossentropy" as the string name for tf.losses.softmaxCrossEntropy'),new errors_1.ValueError(errMsg)}},{"./backend/common":274,"./backend/tfjs_backend":276,"./errors":289,"@tensorflow/tfjs-core":148}],316:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var tfc=require("@tensorflow/tfjs-core"),tfjs_core_1=require("@tensorflow/tfjs-core"),K=require("./backend/tfjs_backend"),errors_1=require("./errors"),losses_1=require("./losses"),losses_2=require("./losses"),losses_3=require("./losses"),util=require("./utils/generic_utils");function binaryAccuracy(yTrue,yPred){return tfjs_core_1.tidy(function(){var threshold=tfc.mul(.5,tfc.onesLike(yPred)),yPredThresholded=K.cast(tfc.greater(yPred,threshold),yTrue.dtype);return tfc.mean(tfc.equal(yTrue,yPredThresholded),-1)})}function categoricalAccuracy(yTrue,yPred){return tfjs_core_1.tidy(function(){return K.cast(tfc.equal(tfc.argMax(yTrue,-1),tfc.argMax(yPred,-1)),"float32")})}function truePositives(yTrue,yPred){return tfjs_core_1.tidy(function(){return tfc.logicalAnd(yTrue.equal(1),yPred.equal(1)).sum().cast("float32")})}function precision(yTrue,yPred){return tfjs_core_1.tidy(function(){var tp=truePositives(yTrue,yPred),fp=function(yTrue,yPred){return tfjs_core_1.tidy(function(){return tfc.logicalAnd(yTrue.equal(0),yPred.equal(1)).sum().cast("float32")})}(yTrue,yPred),denominator=tp.add(fp);return tfc.where(tfc.greater(denominator,0),tp.div(denominator),0).cast("float32")})}exports.binaryAccuracy=binaryAccuracy,exports.categoricalAccuracy=categoricalAccuracy,exports.precision=precision,exports.recall=function(yTrue,yPred){return tfjs_core_1.tidy(function(){var tp=truePositives(yTrue,yPred),fn=function(yTrue,yPred){return tfjs_core_1.tidy(function(){return tfc.logicalAnd(yTrue.equal(1),yPred.equal(0)).sum().cast("float32")})}(yTrue,yPred),denominator=tp.add(fn);return tfc.where(tfc.greater(denominator,0),tp.div(denominator),0).cast("float32")})},exports.binaryCrossentropy=function(yTrue,yPred){return losses_2.binaryCrossentropy(yTrue,yPred)},exports.sparseCategoricalAccuracy=function(yTrue,yPred){return yTrue.rank===yPred.rank&&(yTrue=yTrue.squeeze([yTrue.rank-1])),(yPred=yPred.argMax(-1)).dtype!==yTrue.dtype&&(yPred=yPred.asType(yTrue.dtype)),tfc.equal(yTrue,yPred).asType("float32")},exports.topKCategoricalAccuracy=function(yTrue,yPred){throw new errors_1.NotImplementedError},exports.sparseTopKCategoricalAccuracy=function(yTrue,yPred){throw new errors_1.NotImplementedError},exports.mse=losses_1.meanSquaredError,exports.MSE=losses_1.meanSquaredError,exports.mae=losses_1.meanAbsoluteError,exports.MAE=losses_1.meanAbsoluteError,exports.mape=losses_1.meanAbsolutePercentageError,exports.MAPE=losses_1.meanAbsolutePercentageError,exports.categoricalCrossentropy=losses_1.categoricalCrossentropy,exports.cosine=losses_1.cosineProximity,exports.sparseCategoricalCrossentropy=losses_1.sparseCategoricalCrossentropy,exports.metricsMap={binaryAccuracy:binaryAccuracy,categoricalAccuracy:categoricalAccuracy,precision:precision,categoricalCrossentropy:exports.categoricalCrossentropy,sparseCategoricalCrossentropy:exports.sparseCategoricalCrossentropy,mse:exports.mse,MSE:exports.MSE,mae:exports.mae,MAE:exports.MAE,mape:exports.mape,MAPE:exports.MAPE,cosine:exports.cosine},exports.get=function(identifier){if("string"==typeof identifier&&identifier in exports.metricsMap)return exports.metricsMap[identifier];if("string"!=typeof identifier&&null!=identifier)return identifier;throw new errors_1.ValueError("Unknown metric "+identifier)},exports.getLossOrMetricName=function(fn){if(util.assert(null!==fn,"Unknown LossOrMetricFn "+fn),"string"==typeof fn)return fn;for(var fnName=void 0,_i=0,_a=Object.keys(losses_3.lossesMap);_i<_a.length;_i++){var key=_a[_i];if(losses_3.lossesMap[key]===fn){fnName=key;break}}if(void 0!==fnName)return fnName;for(var _b=0,_c=Object.keys(exports.metricsMap);_b<_c.length;_b++){key=_c[_b];if(exports.metricsMap[key]===fn){fnName=key;break}}return void 0!==fnName?fnName:fn.name}},{"./backend/tfjs_backend":276,"./errors":289,"./losses":315,"./utils/generic_utils":322,"@tensorflow/tfjs-core":148}],317:[function(require,module,exports){"use strict";var extendStatics,__extends=this&&this.__extends||(extendStatics=function(d,b){return(extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p])})(d,b)},function(d,b){function __(){this.constructor=d}extendStatics(d,b),d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)}),__awaiter=this&&this.__awaiter||function(thisArg,_arguments,P,generator){return new(P=P||Promise)(function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){result.done?resolve(result.value):new P(function(resolve){resolve(result.value)}).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())})},__generator=this&&this.__generator||function(thisArg,body){var f,y,t,g,_={label:0,sent:function(){if(1&t[0])throw t[1];return t[1]},trys:[],ops:[]};return g={next:verb(0),throw:verb(1),return:verb(2)},"function"==typeof Symbol&&(g[Symbol.iterator]=function(){return this}),g;function verb(n){return function(v){return function(op){if(f)throw new TypeError("Generator is already executing.");for(;_;)try{if(f=1,y&&(t=2&op[0]?y.return:op[0]?y.throw||((t=y.return)&&t.call(y),0):y.next)&&!(t=t.call(y,op[1])).done)return t;switch(y=0,t&&(op=[2&op[0],t.value]),op[0]){case 0:case 1:t=op;break;case 4:return _.label++,{value:op[1],done:!1};case 5:_.label++,y=op[1],op=[0];continue;case 7:op=_.ops.pop(),_.trys.pop();continue;default:if(!(t=0<(t=_.trys).length&&t[t.length-1])&&(6===op[0]||2===op[0])){_=0;continue}if(3===op[0]&&(!t||op[1]>t[0]&&op[1]<t[3])){_.label=op[1];break}if(6===op[0]&&_.label<t[1]){_.label=t[1],t=op;break}if(t&&_.label<t[2]){_.label=t[2],_.ops.push(op);break}t[2]&&_.ops.pop(),_.trys.pop();continue}op=body.call(thisArg,_)}catch(e){op=[6,e],y=0}finally{f=t=0}if(5&op[0])throw op[1];return{value:op[0]?op[1]:void 0,done:!0}}([n,v])}}};Object.defineProperty(exports,"__esModule",{value:!0});var tfjs_core_1=require("@tensorflow/tfjs-core"),state_1=require("./backend/state"),input_layer_1=require("./engine/input_layer"),topology_1=require("./engine/topology"),training_1=require("./engine/training"),errors_1=require("./errors"),serialization_1=require("./layers/serialization"),generic_utils=require("./utils/generic_utils"),serialization_utils_1=require("./utils/serialization_utils"),types_utils_1=require("./utils/types_utils");function loadLayersModelFromIOHandler(handler,customObjects,options){return __awaiter(this,void 0,void 0,function(){var artifacts,modelTopology,strict,fastWeightInit,model,trainingConfig,_a,modelWeights,optimizerWeights;return __generator(this,function(_b){switch(_b.label){case 0:if(null==options&&(options={}),null==handler.load)throw new errors_1.ValueError("Cannot proceed with model loading because the IOHandler provided does not have the `load` method implemented.");return[4,handler.load()];case 1:if(artifacts=_b.sent(),null!=(modelTopology=artifacts.modelTopology).model_config&&(modelTopology=modelTopology.model_config),strict=null==options.strict||options.strict,fastWeightInit=null!=artifacts.weightData&&null!=artifacts.weightSpecs&&strict,model=serialization_1.deserialize(serialization_utils_1.convertPythonicToTs(modelTopology),customObjects,fastWeightInit),null!=(trainingConfig=artifacts.trainingConfig)&&model.loadTrainingConfig(trainingConfig),null!=artifacts.userDefinedMetadata&&model.setUserDefinedMetadata(artifacts.userDefinedMetadata),null==artifacts.weightData)return[3,4];if(null==artifacts.weightSpecs)throw new errors_1.ValueError("LayersModel artifacts contains weight data, but not weight specs. Therefore loading of weights cannot proceed.");return modelWeights=(_a=function(buffer,specs){var name2Tensor=tfjs_core_1.io.decodeWeights(buffer,specs),modelWeights={},optimizerWeights=[];return specs.forEach(function(spec){"optimizer"===spec.group?optimizerWeights.push({name:spec.name,tensor:name2Tensor[spec.name]}):modelWeights[spec.name]=name2Tensor[spec.name]}),{modelWeights:modelWeights,optimizerWeights:optimizerWeights}}(artifacts.weightData,artifacts.weightSpecs)).modelWeights,optimizerWeights=_a.optimizerWeights,model.loadWeights(modelWeights,strict),null!=model.optimizer&&0<optimizerWeights.length?[4,model.optimizer.setWeights(optimizerWeights)]:[3,3];case 2:_b.sent(),_b.label=3;case 3:tfjs_core_1.dispose(modelWeights),tfjs_core_1.dispose(optimizerWeights.map(function(w){return w.tensor})),_b.label=4;case 4:return[2,model]}})})}exports.modelFromJSON=function(modelAndWeightsConfig,customObjects){return __awaiter(this,void 0,void 0,function(){var modelTopology,tsConfig,model,weightValues,uniqueWeightValues,_i,_a,weight;return __generator(this,function(_b){switch(_b.label){case 0:return"modelTopology"in modelAndWeightsConfig||(modelAndWeightsConfig={modelTopology:modelAndWeightsConfig}),null!=(modelTopology=(modelAndWeightsConfig=modelAndWeightsConfig).modelTopology).model_config&&(modelTopology=modelTopology.model_config),tsConfig=serialization_utils_1.convertPythonicToTs(modelTopology),model=serialization_1.deserialize(tsConfig,customObjects),null==modelAndWeightsConfig.weightsManifest?[3,2]:[4,tfjs_core_1.io.loadWeights(modelAndWeightsConfig.weightsManifest,modelAndWeightsConfig.pathPrefix,model.weights.map(function(weight){return weight.originalName}))];case 1:for(weightValues=_b.sent(),uniqueWeightValues={},_i=0,_a=model.weights;_i<_a.length;_i++)weight=_a[_i],uniqueWeightValues[weight.originalName]=weightValues[weight.originalName];model.loadWeights(uniqueWeightValues),tfjs_core_1.dispose(weightValues),_b.label=2;case 2:return[2,model]}})})},exports.loadLayersModelInternal=function(pathOrIOHandler,options){return __awaiter(this,void 0,void 0,function(){var handlers;return __generator(this,function(_a){if(null==options&&(options={}),"string"==typeof pathOrIOHandler){if(0===(handlers=tfjs_core_1.io.getLoadHandlers(pathOrIOHandler,options.onProgress)).length)handlers.push(tfjs_core_1.io.browserHTTPRequest(pathOrIOHandler,options));else if(1<handlers.length)throw new errors_1.ValueError("Found more than one ("+handlers.length+") load handlers for URL '"+pathOrIOHandler+"'");pathOrIOHandler=handlers[0]}return[2,loadLayersModelFromIOHandler(pathOrIOHandler,void 0,options)]})})},exports.loadLayersModelFromIOHandler=loadLayersModelFromIOHandler;var Sequential=function(_super){function Sequential(args){var _this=_super.call(this,{inputs:[],outputs:[]})||this;if(args=args||{},_this.trainable=!0,_this.built=!1,_this.name=null!=args.name?args.name:state_1.getUid("sequential_"),null!=args.layers)for(var _i=0,_a=args.layers;_i<_a.length;_i++){var layer=_a[_i];_this.add(layer)}return _this}return __extends(Sequential,_super),Sequential.prototype.checkShape=function(layer){if(layer.inboundNodes[0].outputTensors[0].shape.some(function(x){return x<0}))throw new errors_1.ValueError("Negative dimension size caused by adding layer "+layer.name+" with input shape ["+layer.inboundNodes[0].inputTensors[0].shape+"]")},Sequential.prototype.add=function(layer){var modelLayer,isLayerModelInstance=layer instanceof Sequential||layer instanceof training_1.LayersModel;if(isLayerModelInstance){if(1!==(modelLayer=layer).outputs.length)throw new errors_1.ValueError("All layers in a Sequential model should have a single output tensor. For multi-output layers, use the functional API.");if(1!==modelLayer.inputs.length)throw new errors_1.ValueError("All layers in a Sequential model should have a single input tensor. For multi-input layers, use the functional API.")}if(0===this.outputs.length){if(0===layer.inboundNodes.length){if(null==layer.batchInputShape)throw new errors_1.ValueError("The first layer in a Sequential model must get an `inputShape` or `batchInputShape` argument.");var x=input_layer_1.Input({batchShape:layer.batchInputShape,dtype:layer.dtype,name:layer.name+"_input"});layer.apply(x)}if(isLayerModelInstance)this.outputs=modelLayer.outputs,this.inputs=modelLayer.inputs;else{if(1!==layer.inboundNodes.length)throw new errors_1.ValueError("A layer added to a Sequential model must not already be connected somewhere else. LayersModel received layer "+layer.name+" which has "+layer.inboundNodes.length+" pre-existing inbound connections.");if(1!==layer.inboundNodes[0].outputTensors.length)throw new errors_1.ValueError("All layers in a Sequential model should have a single output tensor. For multi-output layers, use the functional API.");this.checkShape(layer),this.outputs=[layer.inboundNodes[0].outputTensors[0]],this.inputs=topology_1.getSourceInputs(this.outputs[0])}this.inboundNodes=[],new topology_1.Node({outboundLayer:this,inboundLayers:[],nodeIndices:[],tensorIndices:[],inputTensors:this.inputs,outputTensors:this.outputs,inputMasks:generic_utils.pyListRepeat(null,this.inputs.length),outputMasks:[null],inputShapes:this.inputs.map(function(x){return x.shape}),outputShapes:this.outputs[0].shape})}else{var outputTensor=layer.apply(this.outputs[0]);if(Array.isArray(outputTensor))throw new TypeError("All layers in a Sequential model should have a single output tensor. For multi-output layers, use the functional API.");this.checkShape(layer),this.outputs=[outputTensor],this.inboundNodes[0].outputTensors=this.outputs,this.inboundNodes[0].outputShapes=[this.outputs[0].shape]}this.layers.push(layer),this.built=!1},Sequential.prototype.pop=function(){if(0===this.layers.length)throw new TypeError("There are no layers in the model.");if(this.layers.pop(),0===this.layers.length)this.outputs=[],this.inboundNodes=[],this.outboundNodes=[];else{var lastLayerIndex=this.layers.length-1;this.layers[lastLayerIndex].outboundNodes=[],this.outputs=[this.layers[lastLayerIndex].output],this.inboundNodes[0].outputTensors=this.outputs,this.inboundNodes[0].outputShapes=[this.outputs[0].shape]}},Sequential.prototype.call=function(inputs,kwargs){return null==this.model&&this.build(),this.model.call(inputs,kwargs)},Sequential.prototype.build=function(inputShape){if(types_utils_1.getExactlyOneShape(inputShape),0===this.inputs.length||0===this.outputs.length)throw new TypeError("Sequential model cannot be built: model is empty. Add some layers first.");this.model=new training_1.LayersModel({inputs:this.inputs,outputs:this.outputs[0],name:this.name+"_model"}),this.model.trainable=this.trainable,this.supportsMasking=this.model.supportsMasking,this.inputLayers=this.model.inputLayers,this.inputLayersNodeIndices=this.model.inputLayersNodeIndices,this.inputLayersTensorIndices=this.model.inputLayersTensorIndices,this.outputLayers=this.model.outputLayers,this.outputLayersNodeIndices=this.model.outputLayersNodeIndices,this.outputLayersTensorIndices=this.model.outputLayersTensorIndices,this.nodesByDepth=this.model.nodesByDepth,this.containerNodes=this.model.containerNodes,this.outputNames=this.model.outputNames,this.inputNames=this.model.inputNames,this.built=!0},Sequential.prototype.countParams=function(){return this.built||this.build(),_super.prototype.countParams.call(this)},Sequential.prototype.summary=function(lineLength,positions,printFn){void 0===printFn&&(printFn=console.log),this.built||this.build(),_super.prototype.summary.call(this,lineLength,positions,printFn)},Sequential.prototype.setWeights=function(weights){null==this.model&&this.build(),this.model.setWeights(weights)},Sequential.prototype.evaluate=function(x,y,args){if(void 0===args&&(args={}),!this.built)throw new errors_1.RuntimeError("The model needs to be compiled before being used.");return this.model.evaluate(x,y,args)},Sequential.prototype.evaluateDataset=function(dataset,args){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(_a){if(!this.built)throw new errors_1.RuntimeError("The model needs to be compiled before being used.");return[2,this.model.evaluateDataset(dataset,args)]})})},Sequential.prototype.predict=function(x,args){return void 0===args&&(args={}),null==this.model&&this.build(),this.model.predict(x,args)},Sequential.prototype.predictOnBatch=function(x){return null==this.model&&this.build(),this.model.predictOnBatch(x)},Sequential.prototype.compile=function(args){this.build(),this.model.compile(args),this.optimizer_=this.model.optimizer,this.isOptimizerOwned=this.model.isOptimizerOwned,this.loss=this.model.loss,this.metrics=this.model.metrics,this.metricsTensors=this.model.metricsTensors,this.metricsNames=this.model.metricsNames},Object.defineProperty(Sequential.prototype,"optimizer",{get:function(){return null==this.model?void 0:this.model.optimizer},set:function(optimizer){this.model.optimizer=optimizer},enumerable:!0,configurable:!0}),Sequential.prototype.fit=function(x,y,args){return void 0===args&&(args={}),__awaiter(this,void 0,void 0,function(){return __generator(this,function(_a){if(!this.built)throw new errors_1.RuntimeError("The model needs to be compiled before being used.");return[2,this.model.fit(x,y,args)]})})},Sequential.prototype.fitDataset=function(dataset,args){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(_a){if(!this.built)throw new errors_1.RuntimeError("The model needs to be compiled before being used.");return[2,this.model.fitDataset(dataset,args)]})})},Sequential.prototype.trainOnBatch=function(x,y){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(_a){return[2,this.model.trainOnBatch(x,y)]})})},Sequential.fromConfig=function(cls,config,customObjects,fastWeightInit){var configArray;void 0===customObjects&&(customObjects={}),void 0===fastWeightInit&&(fastWeightInit=!1);var extraModelConfig={};if(config instanceof Array){if(null==config[0].className||"Merge"===config[0].className)throw new errors_1.ValueError("Legacy serialization format not supported yet.");configArray=config}else tfjs_core_1.util.assert(null!=config.layers,function(){return"When the config data for a Sequential model is not an Array, it must be an Object that contains the 'layers' field."}),configArray=config.layers,delete config.layers,extraModelConfig=config;var model=new cls(extraModelConfig);if(!(model instanceof Sequential))throw new errors_1.NotImplementedError("Sequential.fromConfig called on non-Sequential input: "+model);for(var _i=0,configArray_1=configArray;_i<configArray_1.length;_i++){var conf=configArray_1[_i],layer=serialization_1.deserialize(conf,void 0,fastWeightInit);fastWeightInit&&layer.setFastWeightInitDuringBuild(!0),model.add(layer)}return model},Object.defineProperty(Sequential.prototype,"stopTraining",{get:function(){if(null==this.model)throw new errors_1.ValueError("Cannot get the stopTraining property of a sequential model before it is compiled.");return this.model.stopTraining},set:function(stop){if(null==this.model)throw new errors_1.ValueError("Cannot set the stopTraining property of a sequential model before it is compiled.");this.model.stopTraining=stop},enumerable:!0,configurable:!0}),Sequential.prototype.getConfig=function(){for(var config=[],_i=0,_a=this.layers;_i<_a.length;_i++){var layer=_a[_i],dict={};dict.className=layer.getClassName(),dict.config=layer.getConfig(),config.push(dict)}return config},Sequential.className="Sequential",Sequential}(training_1.LayersModel);exports.Sequential=Sequential,tfjs_core_1.serialization.registerClass(Sequential)},{"./backend/state":275,"./engine/input_layer":283,"./engine/topology":284,"./engine/training":285,"./errors":289,"./layers/serialization":312,"./utils/generic_utils":322,"./utils/serialization_utils":325,"./utils/types_utils":326,"@tensorflow/tfjs-core":148}],318:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var tfjs_core_1=require("@tensorflow/tfjs-core"),common_1=require("./backend/common"),errors_1=require("./errors");exports.getOptimizer=function(identifier){var optimizerMap={Adagrad:function(){return tfjs_core_1.train.adagrad(.01)},Adadelta:function(){return tfjs_core_1.train.adadelta(1,.95,common_1.epsilon())},Adam:function(){return tfjs_core_1.train.adam(.001,.9,.999,common_1.epsilon())},Adamax:function(){return tfjs_core_1.train.adamax(.002,.9,.999,common_1.epsilon(),0)},RMSProp:function(){return tfjs_core_1.train.rmsprop(.001,.9,0,common_1.epsilon())},SGD:function(){return tfjs_core_1.train.sgd(.01)}};if(optimizerMap.adagrad=optimizerMap.Adagrad,optimizerMap.adadelta=optimizerMap.Adadelta,optimizerMap.adam=optimizerMap.Adam,optimizerMap.adamax=optimizerMap.Adamax,optimizerMap.rmsprop=optimizerMap.RMSProp,optimizerMap.sgd=optimizerMap.SGD,identifier in optimizerMap)return optimizerMap[identifier]();throw new errors_1.ValueError("Unknown Optimizer "+identifier)}},{"./backend/common":274,"./errors":289,"@tensorflow/tfjs-core":148}],319:[function(require,module,exports){"use strict";var extendStatics,__extends=this&&this.__extends||(extendStatics=function(d,b){return(extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p])})(d,b)},function(d,b){function __(){this.constructor=d}extendStatics(d,b),d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)});Object.defineProperty(exports,"__esModule",{value:!0});var tfc=require("@tensorflow/tfjs-core"),tfjs_core_1=require("@tensorflow/tfjs-core"),K=require("./backend/tfjs_backend"),generic_utils_1=require("./utils/generic_utils");function assertObjectArgs(args){if(null!=args&&"object"!=typeof args)throw new Error("Argument to L1L2 regularizer's constructor is expected to be an object, but received: "+args)}var Regularizer=function(_super){function Regularizer(){return null!==_super&&_super.apply(this,arguments)||this}return __extends(Regularizer,_super),Regularizer}(tfjs_core_1.serialization.Serializable),L1L2=function(_super){function L1L2(args){var _this=_super.call(this)||this;return assertObjectArgs(args),_this.l1=null==args||null==args.l1?.01:args.l1,_this.l2=null==args||null==args.l2?.01:args.l2,_this.hasL1=0!==_this.l1,_this.hasL2=0!==_this.l2,_this}return __extends(L1L2,_super),L1L2.prototype.apply=function(x){var _this=this;return tfjs_core_1.tidy(function(){var regularization=tfjs_core_1.zeros([1]);return _this.hasL1&&(regularization=tfjs_core_1.add(regularization,tfjs_core_1.sum(tfc.mul(_this.l1,tfjs_core_1.abs(x))))),_this.hasL2&&(regularization=tfjs_core_1.add(regularization,tfjs_core_1.sum(tfc.mul(_this.l2,K.square(x))))),regularization.asScalar()})},L1L2.prototype.getConfig=function(){return{l1:this.l1,l2:this.l2}},L1L2.fromConfig=function(cls,config){return new cls({l1:config.l1,l2:config.l2})},L1L2.className="L1L2",L1L2}(exports.Regularizer=Regularizer);function deserializeRegularizer(config,customObjects){return void 0===customObjects&&(customObjects={}),generic_utils_1.deserializeKerasObject(config,tfjs_core_1.serialization.SerializationMap.getMap().classNameMap,customObjects,"regularizer")}exports.L1L2=L1L2,tfjs_core_1.serialization.registerClass(L1L2),exports.l1=function(args){return assertObjectArgs(args),new L1L2({l1:null!=args?args.l1:null,l2:0})},exports.l2=function(args){return assertObjectArgs(args),new L1L2({l2:null!=args?args.l2:null,l1:0})},exports.REGULARIZER_IDENTIFIER_REGISTRY_SYMBOL_MAP={l1l2:"L1L2"},exports.serializeRegularizer=function(constraint){return generic_utils_1.serializeKerasObject(constraint)},exports.deserializeRegularizer=deserializeRegularizer,exports.getRegularizer=function(identifier){return null==identifier?null:"string"!=typeof identifier?identifier instanceof Regularizer?identifier:deserializeRegularizer(identifier):deserializeRegularizer({className:identifier in exports.REGULARIZER_IDENTIFIER_REGISTRY_SYMBOL_MAP?exports.REGULARIZER_IDENTIFIER_REGISTRY_SYMBOL_MAP[identifier]:identifier,config:{}})}},{"./backend/tfjs_backend":276,"./utils/generic_utils":322,"@tensorflow/tfjs-core":148}],320:[function(require,module,exports){"use strict";function plainObjectCheck(x){if(null===x)return!0;if("object"==typeof x){if(Object.getPrototypeOf(x)===Object.prototype){for(var _i=0,keys_1=Object.keys(x);_i<keys_1.length;_i++){var key=keys_1[_i];if("string"!=typeof key)return!1;if(!plainObjectCheck(x[key]))return!1}return!0}if(Array.isArray(x)){for(var _a=0,x_1=x;_a<x_1.length;_a++){if(!plainObjectCheck(x_1[_a]))return!1}return!0}return!1}var xType=typeof x;return"string"==xType||"number"==xType||"boolean"==xType}Object.defineProperty(exports,"__esModule",{value:!0}),exports.MAX_USER_DEFINED_METADATA_SERIALIZED_LENGTH=1048576,exports.checkUserDefinedMetadata=function(userDefinedMetadata,modelName,checkSize){if(void 0===checkSize&&(checkSize=!1),null==userDefinedMetadata||"object"!=typeof userDefinedMetadata||Object.getPrototypeOf(userDefinedMetadata)!==Object.prototype||!plainObjectCheck(userDefinedMetadata))throw new Error("User-defined metadata is expected to be a JSON object, but is not.");if(checkSize){var out=JSON.stringify(userDefinedMetadata);out.length>exports.MAX_USER_DEFINED_METADATA_SERIALIZED_LENGTH&&console.warn('User-defined metadata of model "'+modelName+'" is too large in size (length='+out.length+" when serialized). It is not recommended to store such large objects in user-defined metadata. Please make sure its serialized length is <= "+exports.MAX_USER_DEFINED_METADATA_SERIALIZED_LENGTH+".")}},exports.plainObjectCheck=plainObjectCheck},{}],321:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var errors_1=require("../errors"),generic_utils_1=require("./generic_utils"),math_utils_1=require("./math_utils");exports.normalizeArray=function(value,n,name){if("number"==typeof value)return generic_utils_1.pyListRepeat(value,n);if(value.length!==n)throw new errors_1.ValueError("The "+name+" argument must be an integer or tuple of "+n+" integers. Received: "+value.length+" elements.");for(var i=0;i<n;++i){var singleValue=value[i];if(!math_utils_1.isInteger(singleValue))throw new errors_1.ValueError("The "+name+" argument must be an integer or tuple of "+n+" integers. Received: "+JSON.stringify(value)+" including a non-integer number "+singleValue)}return value},exports.convOutputLength=function(inputLength,filterSize,padding,stride,dilation){return void 0===dilation&&(dilation=1),null==inputLength?inputLength:(outputLength="same"===padding?inputLength:inputLength-(filterSize+(filterSize-1)*(dilation-1))+1,Math.floor((outputLength+stride-1)/stride));var outputLength},exports.deconvLength=function(dimSize,strideSize,kernelSize,padding){if(null==dimSize)return null;if("valid"===padding)dimSize=dimSize*strideSize+math_utils_1.max([kernelSize-strideSize,0]);else{if("same"!==padding)throw new errors_1.ValueError("Unsupport padding mode: "+padding+".");dimSize*=strideSize}return dimSize}},{"../errors":289,"./generic_utils":322,"./math_utils":324}],322:[function(require,module,exports){"use strict";var __assign=this&&this.__assign||function(){return(__assign=Object.assign||function(t){for(var s,i=1,n=arguments.length;i<n;i++)for(var p in s=arguments[i])Object.prototype.hasOwnProperty.call(s,p)&&(t[p]=s[p]);return t}).apply(this,arguments)};Object.defineProperty(exports,"__esModule",{value:!0});var tfjs_core_1=require("@tensorflow/tfjs-core"),errors_1=require("../errors");function assert(val,message){if(!val)throw new errors_1.AssertionError(message)}function toList(x){return Array.isArray(x)?x:[x]}exports.pyListRepeat=function(value,numValues){if(Array.isArray(value)){for(var newArray=[],i=0;i<numValues;i++)newArray=newArray.concat(value);return newArray}return(newArray=new Array(numValues)).fill(value),newArray},exports.assert=assert,exports.count=function(array,refernce){for(var counter=0,_i=0,array_1=array;_i<array_1.length;_i++){array_1[_i]===refernce&&counter++}return counter},exports.singletonOrArray=function(xs){return 1===xs.length?xs[0]:xs},exports.toList=toList,exports.objectListUid=function(objs){for(var retVal="",_i=0,objectList_1=toList(objs);_i<objectList_1.length;_i++){var obj=objectList_1[_i];if(null==obj.id)throw new errors_1.ValueError("Object "+obj+" passed to objectListUid without an id");""!==retVal&&(retVal+=", "),retVal+=Math.abs(obj.id)}return retVal},exports.toSnakeCase=function(name){var insecure=name.replace(/(.)([A-Z][a-z0-9]+)/g,"$1_$2").replace(/([a-z])([A-Z])/g,"$1_$2").toLowerCase();return"_"!==insecure[0]?insecure:"private"+insecure},exports.toCamelCase=function(identifier){return identifier.length<=1?identifier:-1===identifier.indexOf("_")?identifier:identifier.replace(/[_]+(\w|$)/g,function(m,p1){return p1.toUpperCase()})};var _GLOBAL_CUSTOM_OBJECTS={};function numberCompare(a,b){return a<b?-1:b<a?1:0}function formatAsFriendlyString(value){return null===value?"null":Array.isArray(value)?"["+value.map(function(v){return formatAsFriendlyString(v)}).join(",")+"]":"string"==typeof value?'"'+value+'"':""+value}exports.serializeKerasObject=function(instance){if(null==instance)return null;var dict={};return dict.className=instance.getClassName(),dict.config=instance.getConfig(),dict},exports.deserializeKerasObject=function(identifier,moduleObjects,customObjects,printableModuleName,fastWeightInit){var _a,_b,_c;if(void 0===moduleObjects&&(moduleObjects={}),void 0===customObjects&&(customObjects={}),void 0===printableModuleName&&(printableModuleName="object"),void 0===fastWeightInit&&(fastWeightInit=!1),"string"==typeof identifier){var functionName=identifier,fn=void 0;if(functionName in customObjects)fn=customObjects[functionName];else if(functionName in _GLOBAL_CUSTOM_OBJECTS)fn=_GLOBAL_CUSTOM_OBJECTS[functionName];else if(null==(fn=moduleObjects[functionName]))throw new errors_1.ValueError("Unknown "+printableModuleName+": "+identifier+". This may be due to one of the following reasons:\n1. The "+printableModuleName+" is defined in Python, in which case it needs to be ported to TensorFlow.js or your JavaScript code.\n2. The custom "+printableModuleName+" is defined in JavaScript, but is not registered properly with tf.serialization.registerClass().");return fn}var config=identifier;if(null==config.className||null==config.config)throw new errors_1.ValueError(printableModuleName+": Improper config format: "+JSON.stringify(config)+".\n'className' and 'config' must set.");var className=config.className,cls=void 0,fromConfig=void 0;if(className in customObjects?(cls=(_a=customObjects[className])[0],fromConfig=_a[1]):className in _GLOBAL_CUSTOM_OBJECTS?(cls=(_b=_GLOBAL_CUSTOM_OBJECTS.className)[0],fromConfig=_b[1]):className in moduleObjects&&(cls=(_c=moduleObjects[className])[0],fromConfig=_c[1]),null==cls)throw new errors_1.ValueError("Unknown "+printableModuleName+": "+className+". This may be due to one of the following reasons:\n1. The "+printableModuleName+" is defined in Python, in which case it needs to be ported to TensorFlow.js or your JavaScript code.\n2. The custom "+printableModuleName+" is defined in JavaScript, but is not registered properly with tf.serialization.registerClass().");if(null!=fromConfig){for(var customObjectsCombined={},_i=0,_d=Object.keys(_GLOBAL_CUSTOM_OBJECTS);_i<_d.length;_i++){customObjectsCombined[key=_d[_i]]=_GLOBAL_CUSTOM_OBJECTS[key]}for(var _e=0,_f=Object.keys(customObjects);_e<_f.length;_e++){customObjectsCombined[key=_f[_e]]=customObjects[key]}config.config.customObjects=customObjectsCombined;for(var backupCustomObjects=__assign({},_GLOBAL_CUSTOM_OBJECTS),_g=0,_h=Object.keys(customObjects);_g<_h.length;_g++){var key=_h[_g];_GLOBAL_CUSTOM_OBJECTS[key]=customObjects[key]}!function convertNDArrayScalarsInConfig(config){if(null!=config&&"object"==typeof config)if(Array.isArray(config))config.forEach(function(configItem){return convertNDArrayScalarsInConfig(configItem)});else for(var _i=0,fields_1=Object.keys(config);_i<fields_1.length;_i++){var field=fields_1[_i],value=config[field];null!=value&&"object"==typeof value&&(Array.isArray(value)||"ndarray"!==value.type||"number"!=typeof value.value?convertNDArrayScalarsInConfig(value):config[field]=value.value)}}(config.config);var returnObj=fromConfig(cls,config.config,customObjects,fastWeightInit);return _GLOBAL_CUSTOM_OBJECTS=__assign({},backupCustomObjects),returnObj}backupCustomObjects=__assign({},_GLOBAL_CUSTOM_OBJECTS);for(var _j=0,_k=Object.keys(customObjects);_j<_k.length;_j++){key=_k[_j];_GLOBAL_CUSTOM_OBJECTS[key]=customObjects[key]}return returnObj=new cls(config.config),_GLOBAL_CUSTOM_OBJECTS=__assign({},backupCustomObjects),returnObj},exports.numberCompare=numberCompare,exports.reverseNumberCompare=function(a,b){return-1*numberCompare(a,b)},exports.stringToDType=function(dtype){switch(dtype){case"float32":return"float32";default:throw new errors_1.ValueError("Invalid dtype: "+dtype)}},exports.stringsEqual=function(xs,ys){if(null==xs||null==ys)return xs===ys;if(xs.length!==ys.length)return!1;for(var i=0;i<xs.length;++i)if(xs[i]!==ys[i])return!1;return!0},exports.unique=function(xs){if(null==xs)return xs;for(var out=[],_i=0,xs_1=xs;_i<xs_1.length;_i++){var x=xs_1[_i];-1===out.indexOf(x)&&out.push(x)}return out},exports.isObjectEmpty=function(obj){if(null==obj)throw new errors_1.ValueError("Invalid value in obj: "+JSON.stringify(obj));for(var key in obj)if(obj.hasOwnProperty(key))return!1;return!0},exports.checkStringTypeUnionValue=function(values,label,value){if(null!=value&&values.indexOf(value)<0)throw new errors_1.ValueError(value+" is not a valid "+label+".  Valid values are "+values+" or null/undefined.")},exports.checkArrayTypeAndLength=function(x,expectedType,minLength,maxLength){return void 0===minLength&&(minLength=0),void 0===maxLength&&(maxLength=1/0),assert(0<=minLength),assert(minLength<=maxLength),Array.isArray(x)&&x.length>=minLength&&x.length<=maxLength&&x.every(function(e){return typeof e===expectedType})},exports.assertPositiveInteger=function assertPositiveInteger(value,name){Array.isArray(value)?(tfjs_core_1.util.assert(0<value.length,function(){return name+" is unexpectedly an empty array."}),value.forEach(function(v,i){return assertPositiveInteger(v,"element "+(i+1)+" of "+name)})):tfjs_core_1.util.assert(Number.isInteger(value)&&0<value,function(){return"Expected "+name+" to be a positive integer, but got "+formatAsFriendlyString(value)+"."})},exports.formatAsFriendlyString=formatAsFriendlyString,exports.debounce=function(f,waitMs){var lastResult,lastTime=tfjs_core_1.util.now();return function(){for(var args=[],_i=0;_i<arguments.length;_i++)args[_i]=arguments[_i];var now=tfjs_core_1.util.now();return now-lastTime<waitMs?lastResult:(lastTime=now,lastResult=f.apply(void 0,args))}}},{"../errors":289,"@tensorflow/tfjs-core":148}],323:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var variable_utils_1=require("./variable_utils");function printRow(fields,positions,printFn){void 0===printFn&&(printFn=console.log);for(var line="",i=0;i<fields.length;++i)0<i&&(line=line.slice(0,line.length-1)+" "),line=(line+=fields[i]).slice(0,positions[i]),line+=" ".repeat(positions[i]-line.length);printFn(line)}function printLayerSummary(layer,positions,printFn){var outputShape;try{outputShape=JSON.stringify(layer.outputShape)}catch(err){outputShape="multiple"}printRow([layer.name+" ("+layer.getClassName()+")",outputShape,layer.countParams().toString()],positions,printFn)}function printLayerSummaryWithConnections(layer,positions,relevantNodes,printFn){var outputShape;try{outputShape=JSON.stringify(layer.outputShape)}catch(err){outputShape="multiple"}for(var connections=[],_i=0,_a=layer.inboundNodes;_i<_a.length;_i++){var node=_a[_i];if(!(null!=relevantNodes&&0<relevantNodes.length&&-1===relevantNodes.indexOf(node)))for(var i=0;i<node.inboundLayers.length;++i){var inboundLayer=node.inboundLayers[i].name,inboundLayerIndex=node.nodeIndices[i],inboundTensorIndex=node.tensorIndices[i];connections.push(inboundLayer+"["+inboundLayerIndex+"]["+inboundTensorIndex+"]")}}var name=layer.name,className=layer.getClassName(),firstConnection=0===connections.length?"":connections[0];printRow([name+" ("+className+")",outputShape,layer.countParams().toString(),firstConnection],positions,printFn);for(i=1;i<connections.length;++i)printRow(["","","",connections[i]],positions,printFn)}exports.printSummary=function(model,lineLength,positions,printFn){void 0===printFn&&(printFn=console.log);var relevantNodes,sequentialLike=function(model){var sequentialLike=!0,nodesByDepth=[],nodes=[];for(var depth in model.nodesByDepth)nodesByDepth.push(model.nodesByDepth[depth]);for(var _i=0,nodesByDepth_1=nodesByDepth;_i<nodesByDepth_1.length;_i++){var depthNodes=nodesByDepth_1[_i];if(1<depthNodes.length||1===depthNodes.length&&1<depthNodes[0].inboundLayers.length){sequentialLike=!1;break}nodes.push.apply(nodes,depthNodes)}if(sequentialLike)for(var _a=0,_b=model.layers;_a<_b.length;_a++){for(var layer=_b[_a],flag=!1,_c=0,_d=layer.inboundNodes;_c<_d.length;_c++){var node=_d[_c];if(-1!==nodes.indexOf(node)){if(flag){sequentialLike=!1;break}flag=!0}}if(!sequentialLike)break}return sequentialLike}(model),toDisplay=["Layer (type)","Output shape","Param #"];if((positions=sequentialLike?(lineLength=lineLength||65,positions||[.45,.85,1]):(lineLength=lineLength||98,positions||[.33,.55,.67,1]))[positions.length-1]<=1&&(positions=positions.map(function(p){return Math.floor(lineLength*p)})),!sequentialLike)for(var depth in toDisplay.push("Receives inputs"),relevantNodes=[],model.nodesByDepth)relevantNodes.push.apply(relevantNodes,model.nodesByDepth[depth]);printFn("_".repeat(lineLength)),printRow(toDisplay,positions,printFn),printFn("=".repeat(lineLength));for(var layers=model.layers,i=0;i<layers.length;++i)sequentialLike?printLayerSummary(layers[i],positions,printFn):printLayerSummaryWithConnections(layers[i],positions,relevantNodes,printFn),printFn((i===layers.length-1?"=":"_").repeat(lineLength));model.checkTrainableWeightsConsistency();var trainableCount=function(model){var trainableCount;trainableCount=null!=model.collectedTrainableWeights?variable_utils_1.countParamsInWeights(model.collectedTrainableWeights):variable_utils_1.countParamsInWeights(model.trainableWeights);return trainableCount}(model),nonTrainableCount=variable_utils_1.countParamsInWeights(model.nonTrainableWeights);printFn("Total params: "+(trainableCount+nonTrainableCount)),printFn("Trainable params: "+trainableCount),printFn("Non-trainable params: "+nonTrainableCount),printFn("_".repeat(lineLength))}},{"./variable_utils":327}],324:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var tfc=require("@tensorflow/tfjs-core"),tfjs_core_1=require("@tensorflow/tfjs-core"),errors_1=require("../errors");function toArray1D(array){return array=Array.isArray(array)?new Float32Array(array):array,tfjs_core_1.tensor1d(array)}function sum(array){return tfc.sum(toArray1D(array)).dataSync()[0]}function mean(array){return sum(array)/array.length}exports.isInteger=function(x){return x===parseInt(x.toString(),10)},exports.arrayProd=function(array,begin,end){null==begin&&(begin=0),null==end&&(end=array.length);for(var prod=1,i=begin;i<end;++i)prod*=array[i];return prod},exports.min=function(array){return tfc.min(toArray1D(array)).dataSync()[0]},exports.max=function(array){return tfc.max(toArray1D(array)).dataSync()[0]},exports.sum=sum,exports.mean=mean,exports.variance=function(array){var demeaned=tfc.sub(toArray1D(array),tfjs_core_1.scalar(mean(array)));return tfc.sum(tfc.mulStrict(demeaned,demeaned)).dataSync()[0]/array.length},exports.median=function(array){var arraySorted=array.slice().sort(function(a,b){return a-b}),lowIdx=Math.floor((arraySorted.length-1)/2),highIdx=Math.ceil((arraySorted.length-1)/2);return lowIdx===highIdx?arraySorted[lowIdx]:(arraySorted[lowIdx]+arraySorted[highIdx])/2},exports.range=function(begin,end){if(end<begin)throw new errors_1.ValueError("end ("+end+") < begin ("+begin+") is forbidden.");for(var out=[],i=begin;i<end;++i)out.push(i);return out}},{"../errors":289,"@tensorflow/tfjs-core":148}],325:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var generic_utils=require("../utils/generic_utils");function isArrayItemInputOrOutputName(key,index,value){return("inboundNodes"===key||"outputLayers"===key||"inputLayers"===key)&&0===index&&"string"==typeof value}exports.convertPythonicToTs=function convertPythonicToTs(pythonicConfig,key){if(null===pythonicConfig)return null;if("string"==typeof pythonicConfig)return generic_utils.toCamelCase(pythonicConfig);if("number"==typeof pythonicConfig||"boolean"==typeof pythonicConfig)return pythonicConfig;if(pythonicConfig instanceof Array){for(var tsArray=[],arrayLength=pythonicConfig.length,i=0;i<arrayLength;++i){var item=pythonicConfig[i];isArrayItemInputOrOutputName(key,i,item)?tsArray.push(item):tsArray.push(convertPythonicToTs(item,key))}return tsArray}for(var tsDict={},_i=0,_a=Object.keys(pythonicConfig);_i<_a.length;_i++){var pythonicKey=_a[_i],pythonicValue=pythonicConfig[pythonicKey];if("name"===pythonicKey&&"string"==typeof pythonicValue)tsDict[pythonicKey]=pythonicValue;else{var tsKey=generic_utils.toCamelCase(pythonicKey);tsDict[tsKey]=convertPythonicToTs(pythonicValue,tsKey)}}return tsDict},exports.convertTsToPythonic=function convertTsToPythonic(tsConfig,key){if(null==tsConfig)return null;if("string"==typeof tsConfig)return generic_utils.toSnakeCase(tsConfig);if("number"==typeof tsConfig||"boolean"==typeof tsConfig)return tsConfig;if(tsConfig instanceof Array){for(var pyArray=[],arrayLength=tsConfig.length,i=0;i<arrayLength;++i){var item=tsConfig[i];isArrayItemInputOrOutputName(key,i,item)?pyArray.push(item):pyArray.push(convertTsToPythonic(item,key))}return pyArray}for(var pyDict={},_i=0,_a=Object.keys(tsConfig);_i<_a.length;_i++){var tsKey=_a[_i],tsValue=tsConfig[tsKey],pyKey=generic_utils.toSnakeCase(tsKey);pyDict[pyKey]="name"!==tsKey&&"className"!==tsKey||"string"!=typeof tsValue?convertTsToPythonic(tsValue,tsKey):tsValue}return pyDict}},{"../utils/generic_utils":322}],326:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var errors_1=require("../errors");exports.isArrayOfShapes=function(x){return Array.isArray(x)&&Array.isArray(x[0])},exports.normalizeShapeList=function(x){return 0===x.length?[]:Array.isArray(x[0])?x:[x]},exports.getExactlyOneTensor=function(xs){var x;if(Array.isArray(xs)){if(1!==xs.length)throw new errors_1.ValueError("Expected Tensor length to be 1; got "+xs.length);x=xs[0]}else x=xs;return x},exports.getExactlyOneShape=function(shapes){if(Array.isArray(shapes)&&Array.isArray(shapes[0])){if(1===shapes.length)return(shapes=shapes)[0];throw new errors_1.ValueError("Expected exactly 1 Shape; got "+shapes.length)}return shapes}},{"../errors":289}],327:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.countParamsInWeights=function(weights){for(var count=0,_i=0,weights_1=weights;_i<weights_1.length;_i++){var weight=weights_1[_i];0===weight.shape.length?count+=1:count+=weight.shape.reduce(function(a,b){return a*b})}return count}},{}],328:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var tfc=require("@tensorflow/tfjs-core"),tfjs_core_1=require("@tensorflow/tfjs-core"),state_1=require("./backend/state"),common_1=require("./common"),errors_1=require("./errors"),LayerVariable=function(){function LayerVariable(val,dtype,name,trainable,constraint){void 0===dtype&&(dtype="float32"),void 0===name&&(name="Variable"),void 0===trainable&&(trainable=!0),void 0===constraint&&(constraint=null),this.dtype=null==dtype?"float32":dtype,this.shape=val.shape,this.id=state_1.getNextUniqueTensorId(),name=null==name?"Variable":name,this.originalName=common_1.getScopedTensorName(name),this.name=common_1.getUniqueTensorName(this.originalName),this.trainable_=trainable,this.constraint=constraint,this.val=tfc.variable(val,this.trainable_,this.name,this.dtype)}return LayerVariable.prototype.read=function(){return this.assertNotDisposed(),this.val},LayerVariable.prototype.write=function(newVal){return this.assertNotDisposed(),function(x,y){if(x.shape.toString()!==y.shape.toString())throw new Error("Shape mismatch: "+JSON.stringify(x.shape)+" vs. "+JSON.stringify(y.shape))}(this.val,newVal),this.val.id!==newVal.id&&(this.val.assign(newVal),null!=this.constraint&&this.val.assign(this.constraint.apply(this.val))),this},LayerVariable.prototype.dispose=function(){this.assertNotDisposed(),this.val.dispose()},LayerVariable.prototype.assertNotDisposed=function(){if(this.val.isDisposed)throw new Error("LayersVariable "+this.name+" is already disposed.")},Object.defineProperty(LayerVariable.prototype,"trainable",{get:function(){return this.trainable_},set:function(trainable){this.trainable_=trainable,this.val.trainable=trainable},enumerable:!0,configurable:!0}),LayerVariable}();exports.LayerVariable=LayerVariable,exports.variable=function(x,dtype,name,constraint){return new LayerVariable(x,dtype,name,!0,constraint)},exports.zerosVariable=function(shape,dtype,name){return new LayerVariable(tfc.zeros(shape),dtype,name)},exports.zerosLike=function(x,dtype,name){return new LayerVariable(tfc.zerosLike(x),dtype,name)},exports.onesVariable=function(shape,dtype,name){var allocated=tfc.ones(shape);return new LayerVariable(allocated,dtype,name)},exports.onesLike=function(x,dtype,name){var allocated=tfc.onesLike(x);return new LayerVariable(allocated,dtype,name)},exports.eyeVariable=function(size,dtype,name){return new LayerVariable(tfc.eye(size),dtype,name)},exports.randomUniformVariable=function(shape,minval,maxval,dtype,seed,name){return void 0===name&&(name="randomUniform"),new LayerVariable(tfc.randomUniform(shape,minval,maxval,dtype),dtype,name)},exports.truncatedNormalVariable=function(shape,mean,stddev,dtype,seed,name){if(void 0===mean&&(mean=0),void 0===stddev&&(stddev=1),void 0===name&&(name="truncatedNormal"),"float32"!==(dtype=dtype||"float32")&&"int32"!==dtype)throw new errors_1.NotImplementedError("randomNormal does not support dType "+dtype+".");return new LayerVariable(tfc.truncatedNormal(shape,mean,stddev,dtype,seed),dtype,name)},exports.randomNormalVariable=function(shape,mean,stddev,dtype,seed,name){if(void 0===mean&&(mean=0),void 0===stddev&&(stddev=1),void 0===name&&(name="randomNormal"),"float32"!==(dtype=dtype||"float32")&&"int32"!==dtype)throw new errors_1.NotImplementedError("randomNormalVariable does not support dType "+dtype+".");return new LayerVariable(tfc.randomNormal(shape,mean,stddev,dtype,seed),dtype,name)},exports.update=function(x,xNew){return x.write(xNew)},exports.updateAdd=function(x,increment){return x.write(tfc.add(x.read(),increment))},exports.updateSub=function(x,decrement){return x.write(tfc.sub(x.read(),decrement))},exports.batchGetValue=function(xs){return xs.map(function(x){return x.read()})},exports.batchSetValue=function(variablesAndValues){variablesAndValues.forEach(function(variableAndValue){variableAndValue[0].write(variableAndValue[1])})},exports.gradients=function(lossFn,variables){var variableList=variables.map(function(variable){return variable.read()}),valudAndGrads=tfjs_core_1.variableGrads(lossFn,variableList);return variables.map(function(variable){return valudAndGrads.grads[variable.name]})}},{"./backend/state":275,"./common":279,"./errors":289,"@tensorflow/tfjs-core":148}],329:[function(require,module,exports){arguments[4][49][0].apply(exports,arguments)},{dup:49}],330:[function(require,module,exports){"use strict";function __export(m){for(var p in m)exports.hasOwnProperty(p)||(exports[p]=m[p])}Object.defineProperty(exports,"__esModule",{value:!0}),__export(require("@tensorflow/tfjs-core")),__export(require("@tensorflow/tfjs-layers")),__export(require("@tensorflow/tfjs-converter"));var data=require("@tensorflow/tfjs-data");exports.data=data;var tfjs_core_1=require("@tensorflow/tfjs-core"),tfjs_data_1=require("@tensorflow/tfjs-data"),tfjs_layers_1=require("@tensorflow/tfjs-layers"),tfjs_converter_1=require("@tensorflow/tfjs-converter"),version_1=require("./version");exports.version={"tfjs-core":tfjs_core_1.version_core,"tfjs-data":tfjs_data_1.version_data,"tfjs-layers":tfjs_layers_1.version_layers,"tfjs-converter":tfjs_converter_1.version_converter,tfjs:version_1.version}},{"./version":331,"@tensorflow/tfjs-converter":11,"@tensorflow/tfjs-core":148,"@tensorflow/tfjs-data":256,"@tensorflow/tfjs-layers":297}],331:[function(require,module,exports){arguments[4][49][0].apply(exports,arguments)},{dup:49}],332:[function(require,module,exports){"use strict";exports.byteLength=function(b64){var lens=getLens(b64),validLen=lens[0],placeHoldersLen=lens[1];return 3*(validLen+placeHoldersLen)/4-placeHoldersLen},exports.toByteArray=function(b64){for(var tmp,lens=getLens(b64),validLen=lens[0],placeHoldersLen=lens[1],arr=new Arr(function(b64,validLen,placeHoldersLen){return 3*(validLen+placeHoldersLen)/4-placeHoldersLen}(0,validLen,placeHoldersLen)),curByte=0,len=0<placeHoldersLen?validLen-4:validLen,i=0;i<len;i+=4)tmp=revLookup[b64.charCodeAt(i)]<<18|revLookup[b64.charCodeAt(i+1)]<<12|revLookup[b64.charCodeAt(i+2)]<<6|revLookup[b64.charCodeAt(i+3)],arr[curByte++]=tmp>>16&255,arr[curByte++]=tmp>>8&255,arr[curByte++]=255&tmp;2===placeHoldersLen&&(tmp=revLookup[b64.charCodeAt(i)]<<2|revLookup[b64.charCodeAt(i+1)]>>4,arr[curByte++]=255&tmp);1===placeHoldersLen&&(tmp=revLookup[b64.charCodeAt(i)]<<10|revLookup[b64.charCodeAt(i+1)]<<4|revLookup[b64.charCodeAt(i+2)]>>2,arr[curByte++]=tmp>>8&255,arr[curByte++]=255&tmp);return arr},exports.fromByteArray=function(uint8){for(var tmp,len=uint8.length,extraBytes=len%3,parts=[],i=0,len2=len-extraBytes;i<len2;i+=16383)parts.push(encodeChunk(uint8,i,len2<i+16383?len2:i+16383));1==extraBytes?(tmp=uint8[len-1],parts.push(lookup[tmp>>2]+lookup[tmp<<4&63]+"==")):2==extraBytes&&(tmp=(uint8[len-2]<<8)+uint8[len-1],parts.push(lookup[tmp>>10]+lookup[tmp>>4&63]+lookup[tmp<<2&63]+"="));return parts.join("")};for(var lookup=[],revLookup=[],Arr="undefined"!=typeof Uint8Array?Uint8Array:Array,code="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",i=0,len=code.length;i<len;++i)lookup[i]=code[i],revLookup[code.charCodeAt(i)]=i;function getLens(b64){var len=b64.length;if(0<len%4)throw new Error("Invalid string. Length must be a multiple of 4");var validLen=b64.indexOf("=");return-1===validLen&&(validLen=len),[validLen,validLen===len?0:4-validLen%4]}function encodeChunk(uint8,start,end){for(var tmp,num,output=[],i=start;i<end;i+=3)tmp=(uint8[i]<<16&16711680)+(uint8[i+1]<<8&65280)+(255&uint8[i+2]),output.push(lookup[(num=tmp)>>18&63]+lookup[num>>12&63]+lookup[num>>6&63]+lookup[63&num]);return output.join("")}revLookup["-".charCodeAt(0)]=62,revLookup["_".charCodeAt(0)]=63},{}],333:[function(require,module,exports){},{}],334:[function(require,module,exports){(function(Buffer){"use strict";var base64=require("base64-js"),ieee754=require("ieee754");exports.Buffer=Buffer,exports.SlowBuffer=function(length){+length!=length&&(length=0);return Buffer.alloc(+length)},exports.INSPECT_MAX_BYTES=50;var K_MAX_LENGTH=2147483647;function createBuffer(length){if(K_MAX_LENGTH<length)throw new RangeError('The value "'+length+'" is invalid for option "size"');var buf=new Uint8Array(length);return buf.__proto__=Buffer.prototype,buf}function Buffer(arg,encodingOrOffset,length){if("number"!=typeof arg)return from(arg,encodingOrOffset,length);if("string"==typeof encodingOrOffset)throw new TypeError('The "string" argument must be of type string. Received type number');return allocUnsafe(arg)}function from(value,encodingOrOffset,length){if("string"==typeof value)return function(string,encoding){"string"==typeof encoding&&""!==encoding||(encoding="utf8");if(!Buffer.isEncoding(encoding))throw new TypeError("Unknown encoding: "+encoding);var length=0|byteLength(string,encoding),buf=createBuffer(length),actual=buf.write(string,encoding);actual!==length&&(buf=buf.slice(0,actual));return buf}(value,encodingOrOffset);if(ArrayBuffer.isView(value))return fromArrayLike(value);if(null==value)throw TypeError("The first argument must be one of type string, Buffer, ArrayBuffer, Array, or Array-like Object. Received type "+typeof value);if(isInstance(value,ArrayBuffer)||value&&isInstance(value.buffer,ArrayBuffer))return function(array,byteOffset,length){if(byteOffset<0||array.byteLength<byteOffset)throw new RangeError('"offset" is outside of buffer bounds');if(array.byteLength<byteOffset+(length||0))throw new RangeError('"length" is outside of buffer bounds');var buf;buf=void 0===byteOffset&&void 0===length?new Uint8Array(array):void 0===length?new Uint8Array(array,byteOffset):new Uint8Array(array,byteOffset,length);return buf.__proto__=Buffer.prototype,buf}(value,encodingOrOffset,length);if("number"==typeof value)throw new TypeError('The "value" argument must not be of type number. Received type number');var valueOf=value.valueOf&&value.valueOf();if(null!=valueOf&&valueOf!==value)return Buffer.from(valueOf,encodingOrOffset,length);var b=function(obj){if(Buffer.isBuffer(obj)){var len=0|checked(obj.length),buf=createBuffer(len);return 0===buf.length||obj.copy(buf,0,0,len),buf}if(void 0!==obj.length)return"number"!=typeof obj.length||numberIsNaN(obj.length)?createBuffer(0):fromArrayLike(obj);if("Buffer"===obj.type&&Array.isArray(obj.data))return fromArrayLike(obj.data)}(value);if(b)return b;if("undefined"!=typeof Symbol&&null!=Symbol.toPrimitive&&"function"==typeof value[Symbol.toPrimitive])return Buffer.from(value[Symbol.toPrimitive]("string"),encodingOrOffset,length);throw new TypeError("The first argument must be one of type string, Buffer, ArrayBuffer, Array, or Array-like Object. Received type "+typeof value)}function assertSize(size){if("number"!=typeof size)throw new TypeError('"size" argument must be of type number');if(size<0)throw new RangeError('The value "'+size+'" is invalid for option "size"')}function allocUnsafe(size){return assertSize(size),createBuffer(size<0?0:0|checked(size))}function fromArrayLike(array){for(var length=array.length<0?0:0|checked(array.length),buf=createBuffer(length),i=0;i<length;i+=1)buf[i]=255&array[i];return buf}function checked(length){if(K_MAX_LENGTH<=length)throw new RangeError("Attempt to allocate Buffer larger than maximum size: 0x"+K_MAX_LENGTH.toString(16)+" bytes");return 0|length}function byteLength(string,encoding){if(Buffer.isBuffer(string))return string.length;if(ArrayBuffer.isView(string)||isInstance(string,ArrayBuffer))return string.byteLength;if("string"!=typeof string)throw new TypeError('The "string" argument must be one of type string, Buffer, or ArrayBuffer. Received type '+typeof string);var len=string.length,mustMatch=2<arguments.length&&!0===arguments[2];if(!mustMatch&&0===len)return 0;for(var loweredCase=!1;;)switch(encoding){case"ascii":case"latin1":case"binary":return len;case"utf8":case"utf-8":return utf8ToBytes(string).length;case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return 2*len;case"hex":return len>>>1;case"base64":return base64ToBytes(string).length;default:if(loweredCase)return mustMatch?-1:utf8ToBytes(string).length;encoding=(""+encoding).toLowerCase(),loweredCase=!0}}function swap(b,n,m){var i=b[n];b[n]=b[m],b[m]=i}function bidirectionalIndexOf(buffer,val,byteOffset,encoding,dir){if(0===buffer.length)return-1;if("string"==typeof byteOffset?(encoding=byteOffset,byteOffset=0):2147483647<byteOffset?byteOffset=2147483647:byteOffset<-2147483648&&(byteOffset=-2147483648),numberIsNaN(byteOffset=+byteOffset)&&(byteOffset=dir?0:buffer.length-1),byteOffset<0&&(byteOffset=buffer.length+byteOffset),byteOffset>=buffer.length){if(dir)return-1;byteOffset=buffer.length-1}else if(byteOffset<0){if(!dir)return-1;byteOffset=0}if("string"==typeof val&&(val=Buffer.from(val,encoding)),Buffer.isBuffer(val))return 0===val.length?-1:arrayIndexOf(buffer,val,byteOffset,encoding,dir);if("number"==typeof val)return val&=255,"function"==typeof Uint8Array.prototype.indexOf?dir?Uint8Array.prototype.indexOf.call(buffer,val,byteOffset):Uint8Array.prototype.lastIndexOf.call(buffer,val,byteOffset):arrayIndexOf(buffer,[val],byteOffset,encoding,dir);throw new TypeError("val must be string, number or Buffer")}function arrayIndexOf(arr,val,byteOffset,encoding,dir){var i,indexSize=1,arrLength=arr.length,valLength=val.length;if(void 0!==encoding&&("ucs2"===(encoding=String(encoding).toLowerCase())||"ucs-2"===encoding||"utf16le"===encoding||"utf-16le"===encoding)){if(arr.length<2||val.length<2)return-1;arrLength/=indexSize=2,valLength/=2,byteOffset/=2}function read(buf,i){return 1===indexSize?buf[i]:buf.readUInt16BE(i*indexSize)}if(dir){var foundIndex=-1;for(i=byteOffset;i<arrLength;i++)if(read(arr,i)===read(val,-1===foundIndex?0:i-foundIndex)){if(-1===foundIndex&&(foundIndex=i),i-foundIndex+1===valLength)return foundIndex*indexSize}else-1!==foundIndex&&(i-=i-foundIndex),foundIndex=-1}else for(arrLength<byteOffset+valLength&&(byteOffset=arrLength-valLength),i=byteOffset;0<=i;i--){for(var found=!0,j=0;j<valLength;j++)if(read(arr,i+j)!==read(val,j)){found=!1;break}if(found)return i}return-1}function hexWrite(buf,string,offset,length){offset=Number(offset)||0;var remaining=buf.length-offset;length?remaining<(length=Number(length))&&(length=remaining):length=remaining;var strLen=string.length;strLen/2<length&&(length=strLen/2);for(var i=0;i<length;++i){var parsed=parseInt(string.substr(2*i,2),16);if(numberIsNaN(parsed))return i;buf[offset+i]=parsed}return i}function utf8Write(buf,string,offset,length){return blitBuffer(utf8ToBytes(string,buf.length-offset),buf,offset,length)}function asciiWrite(buf,string,offset,length){return blitBuffer(function(str){for(var byteArray=[],i=0;i<str.length;++i)byteArray.push(255&str.charCodeAt(i));return byteArray}(string),buf,offset,length)}function latin1Write(buf,string,offset,length){return asciiWrite(buf,string,offset,length)}function base64Write(buf,string,offset,length){return blitBuffer(base64ToBytes(string),buf,offset,length)}function ucs2Write(buf,string,offset,length){return blitBuffer(function(str,units){for(var c,hi,lo,byteArray=[],i=0;i<str.length&&!((units-=2)<0);++i)c=str.charCodeAt(i),hi=c>>8,lo=c%256,byteArray.push(lo),byteArray.push(hi);return byteArray}(string,buf.length-offset),buf,offset,length)}function base64Slice(buf,start,end){return 0===start&&end===buf.length?base64.fromByteArray(buf):base64.fromByteArray(buf.slice(start,end))}function utf8Slice(buf,start,end){end=Math.min(buf.length,end);for(var res=[],i=start;i<end;){var secondByte,thirdByte,fourthByte,tempCodePoint,firstByte=buf[i],codePoint=null,bytesPerSequence=239<firstByte?4:223<firstByte?3:191<firstByte?2:1;if(i+bytesPerSequence<=end)switch(bytesPerSequence){case 1:firstByte<128&&(codePoint=firstByte);break;case 2:128==(192&(secondByte=buf[i+1]))&&127<(tempCodePoint=(31&firstByte)<<6|63&secondByte)&&(codePoint=tempCodePoint);break;case 3:secondByte=buf[i+1],thirdByte=buf[i+2],128==(192&secondByte)&&128==(192&thirdByte)&&2047<(tempCodePoint=(15&firstByte)<<12|(63&secondByte)<<6|63&thirdByte)&&(tempCodePoint<55296||57343<tempCodePoint)&&(codePoint=tempCodePoint);break;case 4:secondByte=buf[i+1],thirdByte=buf[i+2],fourthByte=buf[i+3],128==(192&secondByte)&&128==(192&thirdByte)&&128==(192&fourthByte)&&65535<(tempCodePoint=(15&firstByte)<<18|(63&secondByte)<<12|(63&thirdByte)<<6|63&fourthByte)&&tempCodePoint<1114112&&(codePoint=tempCodePoint)}null===codePoint?(codePoint=65533,bytesPerSequence=1):65535<codePoint&&(codePoint-=65536,res.push(codePoint>>>10&1023|55296),codePoint=56320|1023&codePoint),res.push(codePoint),i+=bytesPerSequence}return function(codePoints){var len=codePoints.length;if(len<=MAX_ARGUMENTS_LENGTH)return String.fromCharCode.apply(String,codePoints);var res="",i=0;for(;i<len;)res+=String.fromCharCode.apply(String,codePoints.slice(i,i+=MAX_ARGUMENTS_LENGTH));return res}(res)}exports.kMaxLength=K_MAX_LENGTH,(Buffer.TYPED_ARRAY_SUPPORT=function(){try{var arr=new Uint8Array(1);return arr.__proto__={__proto__:Uint8Array.prototype,foo:function(){return 42}},42===arr.foo()}catch(e){return!1}}())||"undefined"==typeof console||"function"!=typeof console.error||console.error("This browser lacks typed array (Uint8Array) support which is required by `buffer` v5.x. Use `buffer` v4.x if you require old browser support."),Object.defineProperty(Buffer.prototype,"parent",{enumerable:!0,get:function(){if(Buffer.isBuffer(this))return this.buffer}}),Object.defineProperty(Buffer.prototype,"offset",{enumerable:!0,get:function(){if(Buffer.isBuffer(this))return this.byteOffset}}),"undefined"!=typeof Symbol&&null!=Symbol.species&&Buffer[Symbol.species]===Buffer&&Object.defineProperty(Buffer,Symbol.species,{value:null,configurable:!0,enumerable:!1,writable:!1}),Buffer.poolSize=8192,Buffer.from=function(value,encodingOrOffset,length){return from(value,encodingOrOffset,length)},Buffer.prototype.__proto__=Uint8Array.prototype,Buffer.__proto__=Uint8Array,Buffer.alloc=function(size,fill,encoding){return function(size,fill,encoding){return assertSize(size),size<=0?createBuffer(size):void 0!==fill?"string"==typeof encoding?createBuffer(size).fill(fill,encoding):createBuffer(size).fill(fill):createBuffer(size)}(size,fill,encoding)},Buffer.allocUnsafe=function(size){return allocUnsafe(size)},Buffer.allocUnsafeSlow=function(size){return allocUnsafe(size)},Buffer.isBuffer=function(b){return null!=b&&!0===b._isBuffer&&b!==Buffer.prototype},Buffer.compare=function(a,b){if(isInstance(a,Uint8Array)&&(a=Buffer.from(a,a.offset,a.byteLength)),isInstance(b,Uint8Array)&&(b=Buffer.from(b,b.offset,b.byteLength)),!Buffer.isBuffer(a)||!Buffer.isBuffer(b))throw new TypeError('The "buf1", "buf2" arguments must be one of type Buffer or Uint8Array');if(a===b)return 0;for(var x=a.length,y=b.length,i=0,len=Math.min(x,y);i<len;++i)if(a[i]!==b[i]){x=a[i],y=b[i];break}return x<y?-1:y<x?1:0},Buffer.isEncoding=function(encoding){switch(String(encoding).toLowerCase()){case"hex":case"utf8":case"utf-8":case"ascii":case"latin1":case"binary":case"base64":case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return!0;default:return!1}},Buffer.concat=function(list,length){if(!Array.isArray(list))throw new TypeError('"list" argument must be an Array of Buffers');if(0===list.length)return Buffer.alloc(0);var i;if(void 0===length)for(i=length=0;i<list.length;++i)length+=list[i].length;var buffer=Buffer.allocUnsafe(length),pos=0;for(i=0;i<list.length;++i){var buf=list[i];if(isInstance(buf,Uint8Array)&&(buf=Buffer.from(buf)),!Buffer.isBuffer(buf))throw new TypeError('"list" argument must be an Array of Buffers');buf.copy(buffer,pos),pos+=buf.length}return buffer},Buffer.byteLength=byteLength,Buffer.prototype._isBuffer=!0,Buffer.prototype.swap16=function(){var len=this.length;if(len%2!=0)throw new RangeError("Buffer size must be a multiple of 16-bits");for(var i=0;i<len;i+=2)swap(this,i,i+1);return this},Buffer.prototype.swap32=function(){var len=this.length;if(len%4!=0)throw new RangeError("Buffer size must be a multiple of 32-bits");for(var i=0;i<len;i+=4)swap(this,i,i+3),swap(this,i+1,i+2);return this},Buffer.prototype.swap64=function(){var len=this.length;if(len%8!=0)throw new RangeError("Buffer size must be a multiple of 64-bits");for(var i=0;i<len;i+=8)swap(this,i,i+7),swap(this,i+1,i+6),swap(this,i+2,i+5),swap(this,i+3,i+4);return this},Buffer.prototype.toLocaleString=Buffer.prototype.toString=function(){var length=this.length;return 0===length?"":0===arguments.length?utf8Slice(this,0,length):function(encoding,start,end){var loweredCase=!1;if((void 0===start||start<0)&&(start=0),start>this.length)return"";if((void 0===end||end>this.length)&&(end=this.length),end<=0)return"";if((end>>>=0)<=(start>>>=0))return"";for(encoding=encoding||"utf8";;)switch(encoding){case"hex":return hexSlice(this,start,end);case"utf8":case"utf-8":return utf8Slice(this,start,end);case"ascii":return asciiSlice(this,start,end);case"latin1":case"binary":return latin1Slice(this,start,end);case"base64":return base64Slice(this,start,end);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return utf16leSlice(this,start,end);default:if(loweredCase)throw new TypeError("Unknown encoding: "+encoding);encoding=(encoding+"").toLowerCase(),loweredCase=!0}}.apply(this,arguments)},Buffer.prototype.equals=function(b){if(!Buffer.isBuffer(b))throw new TypeError("Argument must be a Buffer");return this===b||0===Buffer.compare(this,b)},Buffer.prototype.inspect=function(){var str="",max=exports.INSPECT_MAX_BYTES;return str=this.toString("hex",0,max).replace(/(.{2})/g,"$1 ").trim(),this.length>max&&(str+=" ... "),"<Buffer "+str+">"},Buffer.prototype.compare=function(target,start,end,thisStart,thisEnd){if(isInstance(target,Uint8Array)&&(target=Buffer.from(target,target.offset,target.byteLength)),!Buffer.isBuffer(target))throw new TypeError('The "target" argument must be one of type Buffer or Uint8Array. Received type '+typeof target);if(void 0===start&&(start=0),void 0===end&&(end=target?target.length:0),void 0===thisStart&&(thisStart=0),void 0===thisEnd&&(thisEnd=this.length),start<0||end>target.length||thisStart<0||thisEnd>this.length)throw new RangeError("out of range index");if(thisEnd<=thisStart&&end<=start)return 0;if(thisEnd<=thisStart)return-1;if(end<=start)return 1;if(this===target)return 0;for(var x=(thisEnd>>>=0)-(thisStart>>>=0),y=(end>>>=0)-(start>>>=0),len=Math.min(x,y),thisCopy=this.slice(thisStart,thisEnd),targetCopy=target.slice(start,end),i=0;i<len;++i)if(thisCopy[i]!==targetCopy[i]){x=thisCopy[i],y=targetCopy[i];break}return x<y?-1:y<x?1:0},Buffer.prototype.includes=function(val,byteOffset,encoding){return-1!==this.indexOf(val,byteOffset,encoding)},Buffer.prototype.indexOf=function(val,byteOffset,encoding){return bidirectionalIndexOf(this,val,byteOffset,encoding,!0)},Buffer.prototype.lastIndexOf=function(val,byteOffset,encoding){return bidirectionalIndexOf(this,val,byteOffset,encoding,!1)},Buffer.prototype.write=function(string,offset,length,encoding){if(void 0===offset)encoding="utf8",length=this.length,offset=0;else if(void 0===length&&"string"==typeof offset)encoding=offset,length=this.length,offset=0;else{if(!isFinite(offset))throw new Error("Buffer.write(string, encoding, offset[, length]) is no longer supported");offset>>>=0,isFinite(length)?(length>>>=0,void 0===encoding&&(encoding="utf8")):(encoding=length,length=void 0)}var remaining=this.length-offset;if((void 0===length||remaining<length)&&(length=remaining),0<string.length&&(length<0||offset<0)||offset>this.length)throw new RangeError("Attempt to write outside buffer bounds");encoding=encoding||"utf8";for(var loweredCase=!1;;)switch(encoding){case"hex":return hexWrite(this,string,offset,length);case"utf8":case"utf-8":return utf8Write(this,string,offset,length);case"ascii":return asciiWrite(this,string,offset,length);case"latin1":case"binary":return latin1Write(this,string,offset,length);case"base64":return base64Write(this,string,offset,length);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return ucs2Write(this,string,offset,length);default:if(loweredCase)throw new TypeError("Unknown encoding: "+encoding);encoding=(""+encoding).toLowerCase(),loweredCase=!0}},Buffer.prototype.toJSON=function(){return{type:"Buffer",data:Array.prototype.slice.call(this._arr||this,0)}};var MAX_ARGUMENTS_LENGTH=4096;function asciiSlice(buf,start,end){var ret="";end=Math.min(buf.length,end);for(var i=start;i<end;++i)ret+=String.fromCharCode(127&buf[i]);return ret}function latin1Slice(buf,start,end){var ret="";end=Math.min(buf.length,end);for(var i=start;i<end;++i)ret+=String.fromCharCode(buf[i]);return ret}function hexSlice(buf,start,end){var len=buf.length;(!start||start<0)&&(start=0),(!end||end<0||len<end)&&(end=len);for(var out="",i=start;i<end;++i)out+=toHex(buf[i]);return out}function utf16leSlice(buf,start,end){for(var bytes=buf.slice(start,end),res="",i=0;i<bytes.length;i+=2)res+=String.fromCharCode(bytes[i]+256*bytes[i+1]);return res}function checkOffset(offset,ext,length){if(offset%1!=0||offset<0)throw new RangeError("offset is not uint");if(length<offset+ext)throw new RangeError("Trying to access beyond buffer length")}function checkInt(buf,value,offset,ext,max,min){if(!Buffer.isBuffer(buf))throw new TypeError('"buffer" argument must be a Buffer instance');if(max<value||value<min)throw new RangeError('"value" argument is out of bounds');if(offset+ext>buf.length)throw new RangeError("Index out of range")}function checkIEEE754(buf,value,offset,ext){if(offset+ext>buf.length)throw new RangeError("Index out of range");if(offset<0)throw new RangeError("Index out of range")}function writeFloat(buf,value,offset,littleEndian,noAssert){return value=+value,offset>>>=0,noAssert||checkIEEE754(buf,0,offset,4),ieee754.write(buf,value,offset,littleEndian,23,4),offset+4}function writeDouble(buf,value,offset,littleEndian,noAssert){return value=+value,offset>>>=0,noAssert||checkIEEE754(buf,0,offset,8),ieee754.write(buf,value,offset,littleEndian,52,8),offset+8}Buffer.prototype.slice=function(start,end){var len=this.length;(start=~~start)<0?(start+=len)<0&&(start=0):len<start&&(start=len),(end=void 0===end?len:~~end)<0?(end+=len)<0&&(end=0):len<end&&(end=len),end<start&&(end=start);var newBuf=this.subarray(start,end);return newBuf.__proto__=Buffer.prototype,newBuf},Buffer.prototype.readUIntLE=function(offset,byteLength,noAssert){offset>>>=0,byteLength>>>=0,noAssert||checkOffset(offset,byteLength,this.length);for(var val=this[offset],mul=1,i=0;++i<byteLength&&(mul*=256);)val+=this[offset+i]*mul;return val},Buffer.prototype.readUIntBE=function(offset,byteLength,noAssert){offset>>>=0,byteLength>>>=0,noAssert||checkOffset(offset,byteLength,this.length);for(var val=this[offset+--byteLength],mul=1;0<byteLength&&(mul*=256);)val+=this[offset+--byteLength]*mul;return val},Buffer.prototype.readUInt8=function(offset,noAssert){return offset>>>=0,noAssert||checkOffset(offset,1,this.length),this[offset]},Buffer.prototype.readUInt16LE=function(offset,noAssert){return offset>>>=0,noAssert||checkOffset(offset,2,this.length),this[offset]|this[offset+1]<<8},Buffer.prototype.readUInt16BE=function(offset,noAssert){return offset>>>=0,noAssert||checkOffset(offset,2,this.length),this[offset]<<8|this[offset+1]},Buffer.prototype.readUInt32LE=function(offset,noAssert){return offset>>>=0,noAssert||checkOffset(offset,4,this.length),(this[offset]|this[offset+1]<<8|this[offset+2]<<16)+16777216*this[offset+3]},Buffer.prototype.readUInt32BE=function(offset,noAssert){return offset>>>=0,noAssert||checkOffset(offset,4,this.length),16777216*this[offset]+(this[offset+1]<<16|this[offset+2]<<8|this[offset+3])},Buffer.prototype.readIntLE=function(offset,byteLength,noAssert){offset>>>=0,byteLength>>>=0,noAssert||checkOffset(offset,byteLength,this.length);for(var val=this[offset],mul=1,i=0;++i<byteLength&&(mul*=256);)val+=this[offset+i]*mul;return(mul*=128)<=val&&(val-=Math.pow(2,8*byteLength)),val},Buffer.prototype.readIntBE=function(offset,byteLength,noAssert){offset>>>=0,byteLength>>>=0,noAssert||checkOffset(offset,byteLength,this.length);for(var i=byteLength,mul=1,val=this[offset+--i];0<i&&(mul*=256);)val+=this[offset+--i]*mul;return(mul*=128)<=val&&(val-=Math.pow(2,8*byteLength)),val},Buffer.prototype.readInt8=function(offset,noAssert){return offset>>>=0,noAssert||checkOffset(offset,1,this.length),128&this[offset]?-1*(255-this[offset]+1):this[offset]},Buffer.prototype.readInt16LE=function(offset,noAssert){offset>>>=0,noAssert||checkOffset(offset,2,this.length);var val=this[offset]|this[offset+1]<<8;return 32768&val?4294901760|val:val},Buffer.prototype.readInt16BE=function(offset,noAssert){offset>>>=0,noAssert||checkOffset(offset,2,this.length);var val=this[offset+1]|this[offset]<<8;return 32768&val?4294901760|val:val},Buffer.prototype.readInt32LE=function(offset,noAssert){return offset>>>=0,noAssert||checkOffset(offset,4,this.length),this[offset]|this[offset+1]<<8|this[offset+2]<<16|this[offset+3]<<24},Buffer.prototype.readInt32BE=function(offset,noAssert){return offset>>>=0,noAssert||checkOffset(offset,4,this.length),this[offset]<<24|this[offset+1]<<16|this[offset+2]<<8|this[offset+3]},Buffer.prototype.readFloatLE=function(offset,noAssert){return offset>>>=0,noAssert||checkOffset(offset,4,this.length),ieee754.read(this,offset,!0,23,4)},Buffer.prototype.readFloatBE=function(offset,noAssert){return offset>>>=0,noAssert||checkOffset(offset,4,this.length),ieee754.read(this,offset,!1,23,4)},Buffer.prototype.readDoubleLE=function(offset,noAssert){return offset>>>=0,noAssert||checkOffset(offset,8,this.length),ieee754.read(this,offset,!0,52,8)},Buffer.prototype.readDoubleBE=function(offset,noAssert){return offset>>>=0,noAssert||checkOffset(offset,8,this.length),ieee754.read(this,offset,!1,52,8)},Buffer.prototype.writeUIntLE=function(value,offset,byteLength,noAssert){value=+value,offset>>>=0,byteLength>>>=0,noAssert||checkInt(this,value,offset,byteLength,Math.pow(2,8*byteLength)-1,0);var mul=1,i=0;for(this[offset]=255&value;++i<byteLength&&(mul*=256);)this[offset+i]=value/mul&255;return offset+byteLength},Buffer.prototype.writeUIntBE=function(value,offset,byteLength,noAssert){value=+value,offset>>>=0,byteLength>>>=0,noAssert||checkInt(this,value,offset,byteLength,Math.pow(2,8*byteLength)-1,0);var i=byteLength-1,mul=1;for(this[offset+i]=255&value;0<=--i&&(mul*=256);)this[offset+i]=value/mul&255;return offset+byteLength},Buffer.prototype.writeUInt8=function(value,offset,noAssert){return value=+value,offset>>>=0,noAssert||checkInt(this,value,offset,1,255,0),this[offset]=255&value,offset+1},Buffer.prototype.writeUInt16LE=function(value,offset,noAssert){return value=+value,offset>>>=0,noAssert||checkInt(this,value,offset,2,65535,0),this[offset]=255&value,this[offset+1]=value>>>8,offset+2},Buffer.prototype.writeUInt16BE=function(value,offset,noAssert){return value=+value,offset>>>=0,noAssert||checkInt(this,value,offset,2,65535,0),this[offset]=value>>>8,this[offset+1]=255&value,offset+2},Buffer.prototype.writeUInt32LE=function(value,offset,noAssert){return value=+value,offset>>>=0,noAssert||checkInt(this,value,offset,4,4294967295,0),this[offset+3]=value>>>24,this[offset+2]=value>>>16,this[offset+1]=value>>>8,this[offset]=255&value,offset+4},Buffer.prototype.writeUInt32BE=function(value,offset,noAssert){return value=+value,offset>>>=0,noAssert||checkInt(this,value,offset,4,4294967295,0),this[offset]=value>>>24,this[offset+1]=value>>>16,this[offset+2]=value>>>8,this[offset+3]=255&value,offset+4},Buffer.prototype.writeIntLE=function(value,offset,byteLength,noAssert){if(value=+value,offset>>>=0,!noAssert){var limit=Math.pow(2,8*byteLength-1);checkInt(this,value,offset,byteLength,limit-1,-limit)}var i=0,mul=1,sub=0;for(this[offset]=255&value;++i<byteLength&&(mul*=256);)value<0&&0===sub&&0!==this[offset+i-1]&&(sub=1),this[offset+i]=(value/mul>>0)-sub&255;return offset+byteLength},Buffer.prototype.writeIntBE=function(value,offset,byteLength,noAssert){if(value=+value,offset>>>=0,!noAssert){var limit=Math.pow(2,8*byteLength-1);checkInt(this,value,offset,byteLength,limit-1,-limit)}var i=byteLength-1,mul=1,sub=0;for(this[offset+i]=255&value;0<=--i&&(mul*=256);)value<0&&0===sub&&0!==this[offset+i+1]&&(sub=1),this[offset+i]=(value/mul>>0)-sub&255;return offset+byteLength},Buffer.prototype.writeInt8=function(value,offset,noAssert){return value=+value,offset>>>=0,noAssert||checkInt(this,value,offset,1,127,-128),value<0&&(value=255+value+1),this[offset]=255&value,offset+1},Buffer.prototype.writeInt16LE=function(value,offset,noAssert){return value=+value,offset>>>=0,noAssert||checkInt(this,value,offset,2,32767,-32768),this[offset]=255&value,this[offset+1]=value>>>8,offset+2},Buffer.prototype.writeInt16BE=function(value,offset,noAssert){return value=+value,offset>>>=0,noAssert||checkInt(this,value,offset,2,32767,-32768),this[offset]=value>>>8,this[offset+1]=255&value,offset+2},Buffer.prototype.writeInt32LE=function(value,offset,noAssert){return value=+value,offset>>>=0,noAssert||checkInt(this,value,offset,4,2147483647,-2147483648),this[offset]=255&value,this[offset+1]=value>>>8,this[offset+2]=value>>>16,this[offset+3]=value>>>24,offset+4},Buffer.prototype.writeInt32BE=function(value,offset,noAssert){return value=+value,offset>>>=0,noAssert||checkInt(this,value,offset,4,2147483647,-2147483648),value<0&&(value=4294967295+value+1),this[offset]=value>>>24,this[offset+1]=value>>>16,this[offset+2]=value>>>8,this[offset+3]=255&value,offset+4},Buffer.prototype.writeFloatLE=function(value,offset,noAssert){return writeFloat(this,value,offset,!0,noAssert)},Buffer.prototype.writeFloatBE=function(value,offset,noAssert){return writeFloat(this,value,offset,!1,noAssert)},Buffer.prototype.writeDoubleLE=function(value,offset,noAssert){return writeDouble(this,value,offset,!0,noAssert)},Buffer.prototype.writeDoubleBE=function(value,offset,noAssert){return writeDouble(this,value,offset,!1,noAssert)},Buffer.prototype.copy=function(target,targetStart,start,end){if(!Buffer.isBuffer(target))throw new TypeError("argument should be a Buffer");if(start=start||0,end||0===end||(end=this.length),targetStart>=target.length&&(targetStart=target.length),targetStart=targetStart||0,0<end&&end<start&&(end=start),end===start)return 0;if(0===target.length||0===this.length)return 0;if(targetStart<0)throw new RangeError("targetStart out of bounds");if(start<0||start>=this.length)throw new RangeError("Index out of range");if(end<0)throw new RangeError("sourceEnd out of bounds");end>this.length&&(end=this.length),target.length-targetStart<end-start&&(end=target.length-targetStart+start);var len=end-start;if(this===target&&"function"==typeof Uint8Array.prototype.copyWithin)this.copyWithin(targetStart,start,end);else if(this===target&&start<targetStart&&targetStart<end)for(var i=len-1;0<=i;--i)target[i+targetStart]=this[i+start];else Uint8Array.prototype.set.call(target,this.subarray(start,end),targetStart);return len},Buffer.prototype.fill=function(val,start,end,encoding){if("string"==typeof val){if("string"==typeof start?(encoding=start,start=0,end=this.length):"string"==typeof end&&(encoding=end,end=this.length),void 0!==encoding&&"string"!=typeof encoding)throw new TypeError("encoding must be a string");if("string"==typeof encoding&&!Buffer.isEncoding(encoding))throw new TypeError("Unknown encoding: "+encoding);if(1===val.length){var code=val.charCodeAt(0);("utf8"===encoding&&code<128||"latin1"===encoding)&&(val=code)}}else"number"==typeof val&&(val&=255);if(start<0||this.length<start||this.length<end)throw new RangeError("Out of range index");if(end<=start)return this;var i;if(start>>>=0,end=void 0===end?this.length:end>>>0,"number"==typeof(val=val||0))for(i=start;i<end;++i)this[i]=val;else{var bytes=Buffer.isBuffer(val)?val:Buffer.from(val,encoding),len=bytes.length;if(0===len)throw new TypeError('The value "'+val+'" is invalid for argument "value"');for(i=0;i<end-start;++i)this[i+start]=bytes[i%len]}return this};var INVALID_BASE64_RE=/[^+/0-9A-Za-z-_]/g;function toHex(n){return n<16?"0"+n.toString(16):n.toString(16)}function utf8ToBytes(string,units){var codePoint;units=units||1/0;for(var length=string.length,leadSurrogate=null,bytes=[],i=0;i<length;++i){if(55295<(codePoint=string.charCodeAt(i))&&codePoint<57344){if(!leadSurrogate){if(56319<codePoint){-1<(units-=3)&&bytes.push(239,191,189);continue}if(i+1===length){-1<(units-=3)&&bytes.push(239,191,189);continue}leadSurrogate=codePoint;continue}if(codePoint<56320){-1<(units-=3)&&bytes.push(239,191,189),leadSurrogate=codePoint;continue}codePoint=65536+(leadSurrogate-55296<<10|codePoint-56320)}else leadSurrogate&&-1<(units-=3)&&bytes.push(239,191,189);if(leadSurrogate=null,codePoint<128){if((units-=1)<0)break;bytes.push(codePoint)}else if(codePoint<2048){if((units-=2)<0)break;bytes.push(codePoint>>6|192,63&codePoint|128)}else if(codePoint<65536){if((units-=3)<0)break;bytes.push(codePoint>>12|224,codePoint>>6&63|128,63&codePoint|128)}else{if(!(codePoint<1114112))throw new Error("Invalid code point");if((units-=4)<0)break;bytes.push(codePoint>>18|240,codePoint>>12&63|128,codePoint>>6&63|128,63&codePoint|128)}}return bytes}function base64ToBytes(str){return base64.toByteArray(function(str){if((str=(str=str.split("=")[0]).trim().replace(INVALID_BASE64_RE,"")).length<2)return"";for(;str.length%4!=0;)str+="=";return str}(str))}function blitBuffer(src,dst,offset,length){for(var i=0;i<length&&!(i+offset>=dst.length||i>=src.length);++i)dst[i+offset]=src[i];return i}function isInstance(obj,type){return obj instanceof type||null!=obj&&null!=obj.constructor&&null!=obj.constructor.name&&obj.constructor.name===type.name}function numberIsNaN(obj){return obj!=obj}}).call(this,require("buffer").Buffer)},{"base64-js":332,buffer:334,ieee754:335}],335:[function(require,module,exports){exports.read=function(buffer,offset,isLE,mLen,nBytes){var e,m,eLen=8*nBytes-mLen-1,eMax=(1<<eLen)-1,eBias=eMax>>1,nBits=-7,i=isLE?nBytes-1:0,d=isLE?-1:1,s=buffer[offset+i];for(i+=d,e=s&(1<<-nBits)-1,s>>=-nBits,nBits+=eLen;0<nBits;e=256*e+buffer[offset+i],i+=d,nBits-=8);for(m=e&(1<<-nBits)-1,e>>=-nBits,nBits+=mLen;0<nBits;m=256*m+buffer[offset+i],i+=d,nBits-=8);if(0===e)e=1-eBias;else{if(e===eMax)return m?NaN:1/0*(s?-1:1);m+=Math.pow(2,mLen),e-=eBias}return(s?-1:1)*m*Math.pow(2,e-mLen)},exports.write=function(buffer,value,offset,isLE,mLen,nBytes){var e,m,c,eLen=8*nBytes-mLen-1,eMax=(1<<eLen)-1,eBias=eMax>>1,rt=23===mLen?Math.pow(2,-24)-Math.pow(2,-77):0,i=isLE?0:nBytes-1,d=isLE?1:-1,s=value<0||0===value&&1/value<0?1:0;for(value=Math.abs(value),isNaN(value)||value===1/0?(m=isNaN(value)?1:0,e=eMax):(e=Math.floor(Math.log(value)/Math.LN2),value*(c=Math.pow(2,-e))<1&&(e--,c*=2),2<=(value+=1<=e+eBias?rt/c:rt*Math.pow(2,1-eBias))*c&&(e++,c/=2),eMax<=e+eBias?(m=0,e=eMax):1<=e+eBias?(m=(value*c-1)*Math.pow(2,mLen),e+=eBias):(m=value*Math.pow(2,eBias-1)*Math.pow(2,mLen),e=0));8<=mLen;buffer[offset+i]=255&m,i+=d,m/=256,mLen-=8);for(e=e<<mLen|m,eLen+=mLen;0<eLen;buffer[offset+i]=255&e,i+=d,e/=256,eLen-=8);buffer[offset+i-d]|=128*s}},{}],336:[function(require,module,exports){var root,factory;root=this,factory=function(){function bitsToNum(ba){return ba.reduce(function(s,n){return 2*s+n},0)}function byteToBitArr(bite){for(var a=[],i=7;0<=i;i--)a.push(!!(bite&1<<i));return a}function Stream(data){this.data=data,this.len=this.data.length,this.pos=0,this.readByte=function(){if(this.pos>=this.data.length)throw new Error("Attempted to read past end of stream.");return data instanceof Uint8Array?data[this.pos++]:255&data.charCodeAt(this.pos++)},this.readBytes=function(n){for(var bytes=[],i=0;i<n;i++)bytes.push(this.readByte());return bytes},this.read=function(n){for(var s="",i=0;i<n;i++)s+=String.fromCharCode(this.readByte());return s},this.readUnsigned=function(){var a=this.readBytes(2);return(a[1]<<8)+a[0]}}function parseGIF(st,handler){function parseCT(entries){for(var ct=[],i=0;i<entries;i++)ct.push(st.readBytes(3));return ct}function readSubBlocks(){var size,data;for(data="";size=st.readByte(),data+=st.read(size),0!==size;);return data}function parseImg(img){img.leftPos=st.readUnsigned(),img.topPos=st.readUnsigned(),img.width=st.readUnsigned(),img.height=st.readUnsigned();var bits=byteToBitArr(st.readByte());img.lctFlag=bits.shift(),img.interlaced=bits.shift(),img.sorted=bits.shift(),img.reserved=bits.splice(0,2),img.lctSize=bitsToNum(bits.splice(0,3)),img.lctFlag&&(img.lct=parseCT(1<<img.lctSize+1)),img.lzwMinCodeSize=st.readByte();var lzwData=readSubBlocks();img.pixels=function(minCodeSize,data){function readCode(size){for(var code=0,i=0;i<size;i++)data.charCodeAt(pos>>3)&1<<(7&pos)&&(code|=1<<i),pos++;return code}function clear(){dict=[],codeSize=minCodeSize+1;for(var i=0;i<clearCode;i++)dict[i]=[i];dict[clearCode]=[],dict[eoiCode]=null}for(var code,last,pos=0,output=[],clearCode=1<<minCodeSize,eoiCode=1+clearCode,codeSize=minCodeSize+1,dict=[];;)if(last=code,(code=readCode(codeSize))!==clearCode){if(code===eoiCode)break;if(code<dict.length)last!==clearCode&&dict.push(dict[last].concat(dict[code][0]));else{if(code!==dict.length)throw new Error("Invalid LZW code.");dict.push(dict[last].concat(dict[last][0]))}output.push.apply(output,dict[code]),dict.length===1<<codeSize&&codeSize<12&&codeSize++}else clear();return output}(img.lzwMinCodeSize,lzwData),img.interlaced&&(img.pixels=function(pixels,width){function cpRow(toRow,fromRow){var fromPixels=pixels.slice(fromRow*width,(fromRow+1)*width);newPixels.splice.apply(newPixels,[toRow*width,width].concat(fromPixels))}for(var newPixels=new Array(pixels.length),rows=pixels.length/width,offsets=[0,4,2,1],steps=[8,8,4,2],fromRow=0,pass=0;pass<4;pass++)for(var toRow=offsets[pass];toRow<rows;toRow+=steps[pass])cpRow(toRow,fromRow),fromRow++;return newPixels}(img.pixels,img.width)),handler.img&&handler.img(img)}handler=handler||{};var parseBlock=function(){var block={};switch(block.sentinel=st.readByte(),String.fromCharCode(block.sentinel)){case"!":block.type="ext",function(block){switch(block.label=st.readByte(),block.label){case 249:block.extType="gce",function(block){st.readByte();var bits=byteToBitArr(st.readByte());block.reserved=bits.splice(0,3),block.disposalMethod=bitsToNum(bits.splice(0,3)),block.userInput=bits.shift(),block.transparencyGiven=bits.shift(),block.delayTime=st.readUnsigned(),block.transparencyIndex=st.readByte(),block.terminator=st.readByte(),handler.gce&&handler.gce(block)}(block);break;case 254:block.extType="com",function(block){block.comment=readSubBlocks(),handler.com&&handler.com(block)}(block);break;case 1:block.extType="pte",function(block){st.readByte();block.ptHeader=st.readBytes(12),block.ptData=readSubBlocks(),handler.pte&&handler.pte(block)}(block);break;case 255:block.extType="app",function(block){st.readByte();switch(block.identifier=st.read(8),block.authCode=st.read(3),block.identifier){case"NETSCAPE":!function(block){st.readByte();block.unknown=st.readByte(),block.iterations=st.readUnsigned(),block.terminator=st.readByte(),handler.app&&handler.app.NETSCAPE&&handler.app.NETSCAPE(block)}(block);break;default:!function(block){block.appData=readSubBlocks(),handler.app&&handler.app[block.identifier]&&handler.app[block.identifier](block)}(block)}}(block);break;default:block.extType="unknown",function(block){block.data=readSubBlocks(),handler.unknown&&handler.unknown(block)}(block)}}(block);break;case",":block.type="img",parseImg(block);break;case";":block.type="eof",handler.eof&&handler.eof(block);break;default:throw new Error("Unknown block: 0x"+block.sentinel.toString(16))}"eof"!==block.type&&setTimeout(parseBlock,0)};!function(){var hdr={};if(hdr.sig=st.read(3),hdr.ver=st.read(3),"GIF"!==hdr.sig)throw new Error("Not a GIF file.");hdr.width=st.readUnsigned(),hdr.height=st.readUnsigned();var bits=byteToBitArr(st.readByte());hdr.gctFlag=bits.shift(),hdr.colorRes=bitsToNum(bits.splice(0,3)),hdr.sorted=bits.shift(),hdr.gctSize=bitsToNum(bits.splice(0,3)),hdr.bgColor=st.readByte(),hdr.pixelAspectRatio=st.readByte(),hdr.gctFlag&&(hdr.gct=parseCT(1<<hdr.gctSize+1)),handler.hdr&&handler.hdr(hdr)}(),setTimeout(parseBlock,0)}return function(opts){var stream,hdr,options={vp_l:0,vp_t:0,vp_w:null,vp_h:null,c_w:null,c_h:null};for(var i in opts)options[i]=opts[i];options.vp_w&&options.vp_h&&(options.is_vp=!0);var loadError=null,loading=!1,transparency=null,delay=null,disposalMethod=null,disposalRestoreFromIdx=null,lastDisposalMethod=null,frame=null,lastImg=null,playing=!0,ctx_scaled=!1,frames=[],frameOffsets=[],gif=options.gif;void 0===options.auto_play&&(options.auto_play=!gif.getAttribute("rel:auto_play")||"1"==gif.getAttribute("rel:auto_play"));function clear(){lastDisposalMethod=disposalMethod,frame=disposalMethod=delay=transparency=null}function doParse(){try{parseGIF(stream,handler)}catch(err){doLoadError("parse")}}function setSizes(w,h){canvas.width=w*get_canvas_scale(),canvas.height=h*get_canvas_scale(),toolbar.style.minWidth=w*get_canvas_scale()+"px",tmpCanvas.width=w,tmpCanvas.height=h,tmpCanvas.style.width=w+"px",tmpCanvas.style.height=h+"px",tmpCanvas.getContext("2d").setTransform(1,0,0,1,0,0)}function doShowProgress(pos,length,draw){if(draw&&showProgressBar){var mid,top,width,height=progressBarHeight;if(options.is_vp)width=ctx_scaled?(top=(options.vp_t+options.vp_h-height)/get_canvas_scale(),height/=get_canvas_scale(),mid=options.vp_l/get_canvas_scale()+pos/length*(options.vp_w/get_canvas_scale()),canvas.width/get_canvas_scale()):(top=options.vp_t+options.vp_h-height,height=height,mid=options.vp_l+pos/length*options.vp_w,canvas.width);else top=(canvas.height-height)/(ctx_scaled?get_canvas_scale():1),mid=pos/length*canvas.width/(ctx_scaled?get_canvas_scale():1),width=canvas.width/(ctx_scaled?get_canvas_scale():1),height/=ctx_scaled?get_canvas_scale():1;ctx.fillStyle=progressBarBackgroundColor,ctx.fillRect(mid,top,width-mid,height),ctx.fillStyle=progressBarForegroundColor,ctx.fillRect(0,top,mid,height)}}function doDecodeProgress(draw){doShowProgress(stream.pos,stream.data.length,draw)}function doNothing(){}function withProgress(fn,draw){return function(block){fn(block),doDecodeProgress(draw)}}function init(){var parent=gif.parentNode,div=document.createElement("div");canvas=document.createElement("canvas"),ctx=canvas.getContext("2d"),toolbar=document.createElement("div"),tmpCanvas=document.createElement("canvas"),div.width=canvas.width=gif.width,div.height=canvas.height=gif.height,toolbar.style.minWidth=gif.width+"px",div.className="jsgif",toolbar.className="jsgif_toolbar",div.appendChild(canvas),div.appendChild(toolbar),parent.insertBefore(div,gif),parent.removeChild(gif),options.c_w&&options.c_h&&setSizes(options.c_w,options.c_h),initialized=!0}function load_setup(callback){return!loading&&(load_callback=callback||!1,loading=!0,frames=[],clear(),!(lastImg=frame=lastDisposalMethod=disposalRestoreFromIdx=null))}var canvas,ctx,toolbar,tmpCanvas,onEndListener=options.hasOwnProperty("on_end")?options.on_end:null,loopDelay=options.hasOwnProperty("loop_delay")?options.loop_delay:0,overrideLoopMode=options.hasOwnProperty("loop_mode")?options.loop_mode:"auto",drawWhileLoading=!options.hasOwnProperty("draw_while_loading")||options.draw_while_loading,showProgressBar=!!drawWhileLoading&&(!options.hasOwnProperty("show_progress_bar")||options.show_progress_bar),progressBarHeight=options.hasOwnProperty("progressbar_height")?options.progressbar_height:25,progressBarBackgroundColor=options.hasOwnProperty("progressbar_background_color")?options.progressbar_background_color:"rgba(255,255,255,0.4)",progressBarForegroundColor=options.hasOwnProperty("progressbar_foreground_color")?options.progressbar_foreground_color:"rgba(255,0,22,.8)",doLoadError=function(originOfError){loadError=originOfError,hdr={width:gif.width,height:gif.height},frames=[],ctx.fillStyle="black",ctx.fillRect(0,0,options.c_w?options.c_w:hdr.width,options.c_h?options.c_h:hdr.height),ctx.strokeStyle="red",ctx.lineWidth=3,ctx.moveTo(0,0),ctx.lineTo(options.c_w?options.c_w:hdr.width,options.c_h?options.c_h:hdr.height),ctx.moveTo(0,options.c_h?options.c_h:hdr.height),ctx.lineTo(options.c_w?options.c_w:hdr.width,0),ctx.stroke()},pushFrame=function(){frame&&(frames.push({data:frame.getImageData(0,0,hdr.width,hdr.height),delay:delay}),frameOffsets.push({x:0,y:0}))},player=function(){function stepFrame(amount){i+=amount,putFrame()}var stepping,doStep,i=-1,iterationCount=0,step=(stepping=!1,doStep=function(){if(stepping=playing){stepFrame(1);var delay=10*frames[i].delay;delay=delay||100,0==(i+1+frames.length)%frames.length?(delay+=loopDelay,setTimeout(completeLoop,delay)):setTimeout(doStep,delay)}},function(){stepping||setTimeout(doStep,0)});function completeLoop(){null!==onEndListener&&onEndListener(gif),iterationCount++,!1!==overrideLoopMode||iterationCount<0?doStep():playing=stepping=!1}var putFrame=function(){var offset;(i=parseInt(i,10))>frames.length-1&&(i=0),i<0&&(i=0),offset=frameOffsets[i],tmpCanvas.getContext("2d").putImageData(frames[i].data,offset.x,offset.y),ctx.globalCompositeOperation="copy",ctx.drawImage(tmpCanvas,0,0)};return{init:function(){loadError||(options.c_w&&options.c_h||ctx.scale(get_canvas_scale(),get_canvas_scale()),options.auto_play?step():(i=0,putFrame()))},step:step,play:function(){playing=!0,step()},pause:function(){playing=!1},playing:playing,move_relative:stepFrame,current_frame:function(){return i},length:function(){return frames.length},move_to:function(frame_idx){i=frame_idx,putFrame()}}}(),handler={hdr:withProgress(function(_hdr){setSizes((hdr=_hdr).width,hdr.height)}),gce:withProgress(function(gce){pushFrame(),clear(),transparency=gce.transparencyGiven?gce.transparencyIndex:null,delay=gce.delayTime,disposalMethod=gce.disposalMethod}),com:withProgress(doNothing),app:{NETSCAPE:withProgress(doNothing)},img:withProgress(function(img){frame=frame||tmpCanvas.getContext("2d");var currIdx=frames.length,ct=img.lctFlag?img.lct:hdr.gct;0<currIdx&&(3===lastDisposalMethod?null!==disposalRestoreFromIdx?frame.putImageData(frames[disposalRestoreFromIdx].data,0,0):frame.clearRect(lastImg.leftPos,lastImg.topPos,lastImg.width,lastImg.height):disposalRestoreFromIdx=currIdx-1,2===lastDisposalMethod&&frame.clearRect(lastImg.leftPos,lastImg.topPos,lastImg.width,lastImg.height));var imgData=frame.getImageData(img.leftPos,img.topPos,img.width,img.height);img.pixels.forEach(function(pixel,i){pixel!==transparency&&(imgData.data[4*i+0]=ct[pixel][0],imgData.data[4*i+1]=ct[pixel][1],imgData.data[4*i+2]=ct[pixel][2],imgData.data[4*i+3]=255)}),frame.putImageData(imgData,img.leftPos,img.topPos),ctx_scaled||(ctx.scale(get_canvas_scale(),get_canvas_scale()),ctx_scaled=!0),drawWhileLoading&&(ctx.drawImage(tmpCanvas,0,0),drawWhileLoading=options.auto_play),lastImg=img},!0),eof:function(block){pushFrame(),doDecodeProgress(!1),options.c_w&&options.c_h||(canvas.width=hdr.width*get_canvas_scale(),canvas.height=hdr.height*get_canvas_scale()),player.init(),loading=!1,load_callback&&load_callback(gif)}},get_canvas_scale=function(){return options.max_width&&hdr&&hdr.width>options.max_width?options.max_width/hdr.width:1},initialized=!1,load_callback=!1;return{play:player.play,pause:player.pause,move_relative:player.move_relative,move_to:player.move_to,get_playing:function(){return playing},get_canvas:function(){return canvas},get_canvas_scale:function(){return get_canvas_scale()},get_loading:function(){return loading},get_auto_play:function(){return options.auto_play},get_length:function(){return player.length()},get_current_frame:function(){return player.current_frame()},load_url:function(src,callback){if(load_setup(callback)){var h=new XMLHttpRequest;h.open("GET",src,!0),"overrideMimeType"in h?h.overrideMimeType("text/plain; charset=x-user-defined"):"responseType"in h?h.responseType="arraybuffer":h.setRequestHeader("Accept-Charset","x-user-defined"),h.onloadstart=function(){initialized||init()},h.onload=function(e){200!=this.status&&doLoadError("xhr - response"),"response"in this||(this.response=new VBArray(this.responseText).toArray().map(String.fromCharCode).join(""));var data=this.response;0<data.toString().indexOf("ArrayBuffer")&&(data=new Uint8Array(data)),stream=new Stream(data),setTimeout(doParse,0)},h.onprogress=function(e){e.lengthComputable&&doShowProgress(e.loaded,e.total,!0)},h.onerror=function(){doLoadError("xhr")},h.send()}},load:function(callback){this.load_url(gif.getAttribute("rel:animated_src")||gif.src,callback)},load_raw:function(arr,callback){load_setup(callback)&&(initialized||init(),stream=new Stream(arr),setTimeout(doParse,0))},set_frame_offset:function(frame,offset){frameOffsets[frame]?(void 0!==offset.x&&(frameOffsets[frame].x=offset.x),void 0!==offset.y&&(frameOffsets[frame].y=offset.y)):frameOffsets[frame]=offset}}}},"object"==typeof exports?module.exports=factory():root.SuperGif=factory()},{}],337:[function(require,module,exports){var cachedSetTimeout,cachedClearTimeout,process=module.exports={};function defaultSetTimout(){throw new Error("setTimeout has not been defined")}function defaultClearTimeout(){throw new Error("clearTimeout has not been defined")}function runTimeout(fun){if(cachedSetTimeout===setTimeout)return setTimeout(fun,0);if((cachedSetTimeout===defaultSetTimout||!cachedSetTimeout)&&setTimeout)return cachedSetTimeout=setTimeout,setTimeout(fun,0);try{return cachedSetTimeout(fun,0)}catch(e){try{return cachedSetTimeout.call(null,fun,0)}catch(e){return cachedSetTimeout.call(this,fun,0)}}}!function(){try{cachedSetTimeout="function"==typeof setTimeout?setTimeout:defaultSetTimout}catch(e){cachedSetTimeout=defaultSetTimout}try{cachedClearTimeout="function"==typeof clearTimeout?clearTimeout:defaultClearTimeout}catch(e){cachedClearTimeout=defaultClearTimeout}}();var currentQueue,queue=[],draining=!1,queueIndex=-1;function cleanUpNextTick(){draining&&currentQueue&&(draining=!1,currentQueue.length?queue=currentQueue.concat(queue):queueIndex=-1,queue.length&&drainQueue())}function drainQueue(){if(!draining){var timeout=runTimeout(cleanUpNextTick);draining=!0;for(var len=queue.length;len;){for(currentQueue=queue,queue=[];++queueIndex<len;)currentQueue&&currentQueue[queueIndex].run();queueIndex=-1,len=queue.length}currentQueue=null,draining=!1,function(marker){if(cachedClearTimeout===clearTimeout)return clearTimeout(marker);if((cachedClearTimeout===defaultClearTimeout||!cachedClearTimeout)&&clearTimeout)return cachedClearTimeout=clearTimeout,clearTimeout(marker);try{cachedClearTimeout(marker)}catch(e){try{return cachedClearTimeout.call(null,marker)}catch(e){return cachedClearTimeout.call(this,marker)}}}(timeout)}}function Item(fun,array){this.fun=fun,this.array=array}function noop(){}process.nextTick=function(fun){var args=new Array(arguments.length-1);if(1<arguments.length)for(var i=1;i<arguments.length;i++)args[i-1]=arguments[i];queue.push(new Item(fun,args)),1!==queue.length||draining||runTimeout(drainQueue)},Item.prototype.run=function(){this.fun.apply(null,this.array)},process.title="browser",process.browser=!0,process.env={},process.argv=[],process.version="",process.versions={},process.on=noop,process.addListener=noop,process.once=noop,process.off=noop,process.removeListener=noop,process.removeAllListeners=noop,process.emit=noop,process.prependListener=noop,process.prependOnceListener=noop,process.listeners=function(name){return[]},process.binding=function(name){throw new Error("process.binding is not supported")},process.cwd=function(){return"/"},process.chdir=function(dir){throw new Error("process.chdir is not supported")},process.umask=function(){return 0}},{}],338:[function(require,module,exports){arguments[4][244][0].apply(exports,arguments)},{"./lib/alea":339,"./lib/tychei":340,"./lib/xor128":341,"./lib/xor4096":342,"./lib/xorshift7":343,"./lib/xorwow":344,"./seedrandom":345,dup:244}],339:[function(require,module,exports){!function(global,module,define){function Alea(seed){var me=this,mash=function(){var n=4022871197;return function(data){data=String(data);for(var i=0;i<data.length;i++){var h=.02519603282416938*(n+=data.charCodeAt(i));h-=n=h>>>0,n=(h*=n)>>>0,n+=4294967296*(h-=n)}return 2.3283064365386963e-10*(n>>>0)}}();me.next=function(){var t=2091639*me.s0+2.3283064365386963e-10*me.c;return me.s0=me.s1,me.s1=me.s2,me.s2=t-(me.c=0|t)},me.c=1,me.s0=mash(" "),me.s1=mash(" "),me.s2=mash(" "),me.s0-=mash(seed),me.s0<0&&(me.s0+=1),me.s1-=mash(seed),me.s1<0&&(me.s1+=1),me.s2-=mash(seed),me.s2<0&&(me.s2+=1),mash=null}function copy(f,t){return t.c=f.c,t.s0=f.s0,t.s1=f.s1,t.s2=f.s2,t}function impl(seed,opts){var xg=new Alea(seed),state=opts&&opts.state,prng=xg.next;return prng.int32=function(){return 4294967296*xg.next()|0},prng.double=function(){return prng()+11102230246251565e-32*(2097152*prng()|0)},prng.quick=prng,state&&("object"==typeof state&&copy(state,xg),prng.state=function(){return copy(xg,{})}),prng}module&&module.exports?module.exports=impl:define&&define.amd?define(function(){return impl}):this.alea=impl}(0,"object"==typeof module&&module,!1)},{}],340:[function(require,module,exports){arguments[4][246][0].apply(exports,arguments)},{dup:246}],341:[function(require,module,exports){arguments[4][247][0].apply(exports,arguments)},{dup:247}],342:[function(require,module,exports){arguments[4][248][0].apply(exports,arguments)},{dup:248}],343:[function(require,module,exports){arguments[4][249][0].apply(exports,arguments)},{dup:249}],344:[function(require,module,exports){arguments[4][250][0].apply(exports,arguments)},{dup:250}],345:[function(require,module,exports){!function(pool,math){var nodecrypto,global=eval("this"),width=256,startdenom=math.pow(width,6),significance=math.pow(2,52),overflow=2*significance,mask=width-1;function seedrandom(seed,options,callback){function prng(){for(var n=arc4.g(6),d=startdenom,x=0;n<significance;)n=(n+x)*width,d*=width,x=arc4.g(1);for(;overflow<=n;)n/=2,d/=2,x>>>=1;return(n+x)/d}var key=[],shortseed=mixkey(function flatten(obj,depth){var prop,result=[],typ=typeof obj;if(depth&&"object"==typ)for(prop in obj)try{result.push(flatten(obj[prop],depth-1))}catch(e){}return result.length?result:"string"==typ?obj:obj+"\0"}((options=1==options?{entropy:!0}:options||{}).entropy?[seed,tostring(pool)]:null==seed?function(){try{var out;return nodecrypto&&(out=nodecrypto.randomBytes)?out=out(width):(out=new Uint8Array(width),(global.crypto||global.msCrypto).getRandomValues(out)),tostring(out)}catch(e){var browser=global.navigator,plugins=browser&&browser.plugins;return[+new Date,global,plugins,global.screen,tostring(pool)]}}():seed,3),key),arc4=new ARC4(key);return prng.int32=function(){return 0|arc4.g(4)},prng.quick=function(){return arc4.g(4)/4294967296},prng.double=prng,mixkey(tostring(arc4.S),pool),(options.pass||callback||function(prng,seed,is_math_call,state){return state&&(state.S&&copy(state,arc4),prng.state=function(){return copy(arc4,{})}),is_math_call?(math.random=prng,seed):prng})(prng,shortseed,"global"in options?options.global:this==math,options.state)}function ARC4(key){var t,keylen=key.length,me=this,i=0,j=me.i=me.j=0,s=me.S=[];for(keylen||(key=[keylen++]);i<width;)s[i]=i++;for(i=0;i<width;i++)s[i]=s[j=mask&j+key[i%keylen]+(t=s[i])],s[j]=t;(me.g=function(count){for(var t,r=0,i=me.i,j=me.j,s=me.S;count--;)t=s[i=mask&i+1],r=r*width+s[mask&(s[i]=s[j=mask&j+t])+(s[j]=t)];return me.i=i,me.j=j,r})(width)}function copy(f,t){return t.i=f.i,t.j=f.j,t.S=f.S.slice(),t}function mixkey(seed,key){for(var smear,stringseed=seed+"",j=0;j<stringseed.length;)key[mask&j]=mask&(smear^=19*key[mask&j])+stringseed.charCodeAt(j++);return tostring(key)}function tostring(a){return String.fromCharCode.apply(0,a)}if(mixkey(math.random(),pool),"object"==typeof module&&module.exports){module.exports=seedrandom;try{nodecrypto=require("crypto")}catch(ex){}}else math.seedrandom=seedrandom}([],Math)},{crypto:333}],346:[function(require,module,exports){(function(setImmediate,clearImmediate){var nextTick=require("process/browser.js").nextTick,apply=Function.prototype.apply,slice=Array.prototype.slice,immediateIds={},nextImmediateId=0;function Timeout(id,clearFn){this._id=id,this._clearFn=clearFn}exports.setTimeout=function(){return new Timeout(apply.call(setTimeout,window,arguments),clearTimeout)},exports.setInterval=function(){return new Timeout(apply.call(setInterval,window,arguments),clearInterval)},exports.clearTimeout=exports.clearInterval=function(timeout){timeout.close()},Timeout.prototype.unref=Timeout.prototype.ref=function(){},Timeout.prototype.close=function(){this._clearFn.call(window,this._id)},exports.enroll=function(item,msecs){clearTimeout(item._idleTimeoutId),item._idleTimeout=msecs},exports.unenroll=function(item){clearTimeout(item._idleTimeoutId),item._idleTimeout=-1},exports._unrefActive=exports.active=function(item){clearTimeout(item._idleTimeoutId);var msecs=item._idleTimeout;0<=msecs&&(item._idleTimeoutId=setTimeout(function(){item._onTimeout&&item._onTimeout()},msecs))},exports.setImmediate="function"==typeof setImmediate?setImmediate:function(fn){var id=nextImmediateId++,args=!(arguments.length<2)&&slice.call(arguments,1);return immediateIds[id]=!0,nextTick(function(){immediateIds[id]&&(args?fn.apply(null,args):fn.call(null),exports.clearImmediate(id))}),id},exports.clearImmediate="function"==typeof clearImmediate?clearImmediate:function(id){delete immediateIds[id]}}).call(this,require("timers").setImmediate,require("timers").clearImmediate)},{"process/browser.js":337,timers:346}]},{},[3])(3)});

(()=>{const e=(...)=>document.getElementById(...),t=(...)=>document.querySelector(...),s=(...)=>document.querySelectorAll(...);function a(e){const t=Math.round(e),s=t%1e3,a=Math.floor(t/1e3)%60,n=Math.floor(t/6e4);return{ms:s.toString().padStart(3,"0"),s:a.toString().padStart(2,"0"),m:n.toString()}}function n(e){const t=Math.abs(Math.floor((new Date-e)/1e3));let s=Math.floor(t/31536e3);return s>1?`${s} years`:(s=Math.floor(t/2592e3),s>1?`${s} months`:(s=Math.floor(t/86400),s>1?`${s} days`:(s=Math.floor(t/3600),s>1?`${s} hours`:(s=Math.floor(t/60),s>1?`${s} minutes`:`${Math.floor(t)} seconds`))))}function o(e){let t=Math.floor(e/3600);return t>1?`${t}<span>H</span>`:(t=Math.floor(e/60),t>1?`${t}<span>M</span>`:`${Math.floor(e)}<span>S</span>`)}function i(e){const t=Math.abs(Math.floor((new Date-e)/1e3));if(t<10)return"now";let s=Math.floor(t/86400);return s>1?`${s}d`:(s=Math.floor(t/3600),s>1?`${s}h`:(s=Math.floor(t/60),s>1?`${s}m`:`${Math.floor(t)}s`))}function r(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML.replace(/"/g,"&quot;").replace(/'/g,"&apos;")}const l={5e5:"",4e5:"",1e5:"",9e4:"",5e4:"",4e4:"",1e4:"",9e3:"",5e3:"",4e3:"",1e3:"",900:"",500:"",400:"",100:"",90:"",50:"",40:"",10:"",9:"",5:"",4:"",1:""};function c(e){const t=Object.keys(l);let s="";for(e=Math.max(0,Math.floor(e));e>=1;)for(let a=t.length-1;a>=0;a--)if(e/parseInt(t[a])>=1){e-=parseInt(t[a]),s+=l[t[a]];break}return s}const d=new Map;function u(e){if(d.has(e))return d.get(e);const t=`data:image/svg+xml;base64,${new Identicon(MD5(e),{background:[0,0,0,200],margin:.15,size:300,brightness:.48,saturation:.65,format:"svg"}).toString()}`;return d.set(e,t),t}function m(e=1,t=4,s="ABCDEFGHJKLMNPQRSTUVWXYZ"){let a="";const n=e+Math.floor((t-e+1)*Math.random());for(let e=0;e<n;e++)a+=s[Math.floor(Math.random()*s.length)];return a}function g(e){"loading"===document.readyState?document.addEventListener("DOMContentLoaded",e,!1):e()}let h;function f(){const t=TETRIO_ENV.countdown-Date.now();if(t<=0)e("prelaunch_countdown").innerHTML="00:00:00",clearInterval(h),e("prelaunch").classList.add("hiding"),setTimeout((()=>{e("prelaunch").classList.add("hidden")}),7500);else{var s=Math.floor(t/36e5),a=Math.floor(t%36e5/6e4),n=Math.floor(t%6e4/1e3);s<10&&(s="0"+s),a<10&&(a="0"+a),n<10&&(n="0"+n),e("prelaunch_countdown").innerHTML=s+":"+a+'<span class="sec">:'+n+"</span>"}}function _(e){e()}function b(e){}function y(){return!1}function v(e){return void 0===e?e:JSON.parse(JSON.stringify(e))}g((()=>{TETRIO_ENV.countdown&&TETRIO_ENV.countdown>Date.now()&&(e("prelaunch").classList.remove("hidden"),h=setInterval((()=>{f()}),100),f())})),msgpackr.addExtension({type:1,read:e=>null===e?{success:!0}:{success:!0,...e}}),msgpackr.addExtension({type:2,read:e=>null===e?{success:!1}:{success:!1,error:e}});const w=(()=>{const e=new msgpackr.Packr({bundleStrings:!0}),t=new msgpackr.Unpackr({bundleStrings:!0});return{send:s=>{let{method:a=(()=>{throw new Error("XHR: A method is required")})(),url:n=(()=>{throw new Error("XHR: A path is required")})(),body:o,authenticated:i,parse:r=!0,ignoreSuccess:l=!1,headers:c={},accept:d,type:p="application/vnd.osk.theorypack"}=s;void 0===i&&(i=n.startsWith("/api/")),void 0===d&&(d=n.startsWith("/api/")?"application/vnd.osk.theorypack":"*/*");const u=new XMLHttpRequest;return u.open(a,n,!0),u.setRequestHeader("Accept",d),"application/vnd.osk.theorypack"===d&&(u.responseType="arraybuffer"),"string"==typeof o?u.setRequestHeader("Content-Type","text/plain"):o instanceof FormData||"object"==typeof o&&(u.setRequestHeader("Content-Type",p),"application/json"===p?o=JSON.stringify(o):"application/vnd.osk.theorypack"===p&&(o=e.pack(o))),i&&z.loggedIn()&&u.setRequestHeader("Authorization",`Bearer ${z.token()}`),Object.keys(c).forEach((e=>{u.setRequestHeader(e,c[e])})),new Promise(((e,s)=>{u.onload=()=>{if(4===u.readyState){if(!r)return void e(u.responseText);let a=null;switch(u.getResponseHeader("Content-Type").split(";")[0]){case"application/json":a=JSON.parse(u.responseText);break;case"application/vnd.osk.theorypack":a=t.unpack(new Uint8Array(u.response))}if(!l){if(!a)return void s({success:!1,error:{msg:"A connection error has occured"}});if(!a.success)return void s(a)}e(a)}},u.onerror=()=>{s({success:!1,error:{msg:"A connection error has occured"}})},u.send(o)}))},get:(e,t={},s={})=>{let a=!1;return Object.keys(t).forEach((s=>{e+=`${a?"&":"?"}${encodeURIComponent(s)}=${encodeURIComponent(t[s])}`,a=!0})),w.send({method:"GET",url:e,...s})},post:(e,t,s={})=>w.send({method:"POST",url:e,body:t,...s})}})(),k={};let L=0,E=[];function x(t){let s=t;if("string"==typeof t&&(s={msg:t}),s.suppressable&&(te.notifications.suppress&&document.body.classList.contains("ingame_phys")||kn()))return void E.push(s);const a=document.createElement("div");if(a.classList.add("notification"),a.classList.add("ns"),a.setAttribute("style",`--pri: ${s.color||"#FFFFFF"}; --sec: ${s.subcolor||"#000000"};`),a.style.borderColor=s.color||"#FFFFFF",a.style.backgroundColor=s.bgcolor||"#060606DD",a.style.color=s.fgcolor||"#FFFFFF",a.setAttribute("data-nid",++L),e("notifications").appendChild(a),s.classes&&s.classes.forEach((e=>{a.classList.add(e)})),s.icon){a.classList.add("has_image");const e=document.createElement("img");e.classList.add("notification_icon"),e.src=s.icon.includes("/")?s.icon:`res/icon/${s.icon}.svg`,a.appendChild(e)}if(s.subicon){const e=document.createElement("img");e.classList.add("notification_icon_sub"),e.src=s.subicon.includes("/")?s.subicon:`res/icon/${s.subicon}.svg`,a.appendChild(e)}if(s.header){const e=document.createElement("h1");e.innerHTML=s.header,a.appendChild(e)}const n=document.createElement("p");if(n.innerHTML=s.msg,a.appendChild(n),s.buttons=s.buttons||[],s.buttons.length){const e=document.createElement("div");e.classList.add("notification_button_holder"),e.classList.add("flex-row"),e.classList.add("ns"),a.appendChild(e),s.buttons.forEach((t=>{const s=document.createElement("div");s.classList.add("notification_button"),s.classList.add("flex-item"),s.innerHTML=`${t.icon?`<img src="${t.icon}" />`:""}${t.label}`,t.classes.forEach((e=>{s.classList.add(e)})),s.addEventListener("click",(()=>{t.onclick((()=>{M(a)}))})),e.appendChild(s)}))}return k[L]=setTimeout((()=>{M(a)}),s.timeout||5e3),a.addEventListener("click",s.onclick?()=>{s.onclick((()=>{M(a)}))}:()=>{M(a)}),a}function T(e){return x({msg:e,color:"#FF4200",icon:"error"})}function I(e){return x({msg:e,color:"#6AFF3C",icon:"ok"})}function S(e){let t=e.error?e.error.msg||"no error message":"no error";return e.error&&e.error.stack&&(t+=`<p class="notification-stack">${e.error.name}&lt;${e.error.constructorName}&gt;: ${e.error.errorMessage}<br><br>${e.error.stack.replace(/\n/g,"<br>")}</p>`),x({msg:t,color:"#FF4200",icon:"error",classes:e.error&&e.error.stack?["hasstack"]:[]})}function M(e){e.classList.add("despawning"),setTimeout((()=>{e.parentNode&&e.parentNode.removeChild(e)}),500)}function A(t,s){if(!t||!e("notifications").contains(t))return x(s);let a=s;"string"==typeof s&&(a={msg:s});const n=t;if(n.innerHTML="",n.style.borderColor=a.color||"#FFFFFF",a.icon){n.classList.add("has_image");const e=document.createElement("img");e.classList.add("notification_icon"),e.src=`res/icon/${a.icon}.svg`,n.appendChild(e)}const o=document.createElement("p");return o.innerHTML=a.msg,n.appendChild(o),a.timeout&&(clearTimeout(k[n.getAttribute("data-nid")]),k[L]=setTimeout((()=>{M(n)}),a.timeout||5e3)),n}function C(){E.forEach((e=>{x(e)})),E=[]}function R(t){let s=t;"string"==typeof t&&(s={msg:t});const a=document.createElement("div");a.classList.add("waterfall_item"),a.classList.add("ns"),a.style.setProperty("--bgc",s.bgcolor||"#888888"),a.style.color=s.fgcolor||"#FFFFFF",e("waterfall").prepend(a);const n=document.createElement("p");n.classList.add("ns"),n.innerHTML=s.msg,a.appendChild(n),setTimeout((()=>{H(a)}),s.timeout||5e3);const o=n.getBoundingClientRect();return xn.play("waterfall",{x:o.left+o.width/2,y:o.top+1.3*o.height,w:o.width,h:o.height,color:Rn(s.bgcolor)||8947848}),a}function H(e){e.classList.add("despawning"),setTimeout((()=>{e.parentNode.removeChild(e)}),500)}function $(t){const s=document.createElement("div");if(s.classList.add("killfeed_item"),s.classList.add("ns"),s.classList.toggle("killer",t.killer==z.username()),s.classList.toggle("victim",t.victim==z.username()),e("killfeed").prepend(s),null!==t.killer&&void 0!==t.killer){const e=document.createElement("p");e.classList.add("ns"),e.innerHTML=t.killer.toUpperCase(),s.appendChild(e)}const a=document.createElement("img");if(a.src=`/res/icon/elim-${t.type||"sizzle"}.svg`,s.appendChild(a),null!==t.victim&&void 0!==t.victim){const e=document.createElement("p");e.classList.add("ns"),e.innerHTML=t.victim.toUpperCase(),s.appendChild(e)}return setTimeout((()=>{O(s)}),1e4),s}function O(e){e.classList.add("despawning"),setTimeout((()=>{e.parentNode.removeChild(e)}),500)}const P={};function D(t){const s=`dlg_${Date.now()}${Math.floor(1e6*Math.random())}`,a=document.createElement("div");if(a.classList.add("oob_modal"),a.classList.add("hidden"),a.id=s,e("dialogs").appendChild(a),t.title){const e=document.createElement("h1");e.innerHTML=t.title,a.appendChild(e)}if(t.msg){const e=document.createElement("p");e.innerHTML=t.msg,a.appendChild(e)}t.classes&&t.classes.forEach((e=>{a.classList.add(e)}));const n=document.createElement("div");return n.classList.add("oob_button_holder"),n.classList.add("flex-row"),n.classList.add("ns"),a.appendChild(n),t.buttons.forEach((e=>{const t=document.createElement("div");t.classList.add("oob_button"),t.classList.add("flex-item"),t.innerHTML=e.label,e.classes.forEach((e=>{t.classList.add(e)})),e.id&&(t.id=e.id),t.addEventListener("click",(()=>{e.callback((()=>{N(a)}),a)})),n.appendChild(t)})),setTimeout((()=>{a.classList.remove("hidden"),Ae.push(),Ae.bindGuide(Ce.dialog)}),1),e("dialogs").classList.remove("hidden"),bt(),P[s]={id:s,options:t,el:a},a}function N(e,t=!1){e.classList.contains("hidden")||(e.classList.add("hidden"),yt(),Ae.pop(),t&&P[e.id]&&P[e.id].onskip&&P[e.id].onskip(),delete P[e.id],setTimeout((()=>{1===e.parentNode.childElementCount&&e.parentNode.classList.add("hidden"),e.parentNode.removeChild(e)}),500))}g((()=>{e("dialogs").addEventListener("mousedown",(t=>{if(t.target!==e("dialogs"))return;if(!e("dialogs").children.length)return;const s=e("dialogs").children[e("dialogs").children.length-1];s.classList.contains("noclickout")||s.classList.contains("hidden")||(N(s,!0),Os.play("menuclick"))}))})),g((()=>{document.addEventListener("keydown",(function(t){if(t.repeat)return;let s=t.code;if("NumpadEnter"===s&&(s="Enter"),"Enter"!==s&&"Escape"!==s)return;if(!t.target.getAttribute(`data-${s.toLowerCase()}`))return;const a=e(t.target.getAttribute(`data-${s.toLowerCase()}`));"input"===a.tagName.toLowerCase()||"textarea"===a.tagName.toLowerCase()?a.focus():a.click(),t.preventDefault()}))}));let F=!1;const U=function(){const t={sfx:{state:"loading SFX..."},fonts:{state:null},textures:{state:null},feecof:{state:null},homebanner:{state:"loading home banner data..."},environment:{state:"checking for game updates..."}};let s=0;const a=[];let n=!1,o=!1,i=window.I;function r(){e("preload").classList.add("hidden"),a.forEach((e=>{e()})),function(){const e=G.quickjoin;if(!e)return;switch(e.substring(0,2)){case"R:":Ds.navigateToShortID(e.trim());break;case"r:":Ds.navigateToLongID(e.trim());break;case"P:":case"D:":break;case"S:":Ke(void 0,e.length>2?e.substring(2).trim():void 0);break;default:ct("connecting to live servers"),o=!0,ga.require().then((t=>{dt(),et("playmulti"),t.maintenance&&document.body.classList.add("maintenance"),ka.joinRoom(e.trim())})).catch((()=>{dt(),T("could not connect to live servers")}))}}(),o||document.body.classList.contains("banstatus_restrict")||ga.connect()}function l(){let s="";Object.keys(t).forEach((e=>{t[e].state&&(s+=`<p>${t[e].state}</p>`)})),e("preload_msgs").innerHTML=s}return window.I=void 0,g((()=>{"devel"===TETRIO_ENV.mode&&document.body.classList.add("devel"),e("js_load_error").classList.add("handled"),PIXI.utils.isWebGLSupported()||e("no_webgl_error").classList.remove("hidden"),l()})),g((()=>{console.log("%cTETR.IO","color: #DFC0F3;\n\t\t\t\t\t display: block;\n\t\t\t\t\t font-size: 5em;\n\t\t\t\t\t font-weight: 900;\n\t\t\t\t\t text-shadow: 0px 0px 2px #9150BA;\n\t\t\t\t\t background-color: #45345088;\n\t\t\t\t\t padding: 0 0.25em;\n\t\t\t\t\t border-radius: 3px;"),console.log("%cPlease be careful when pasting anything in the console. Attackers may be out to steal your login information.","color: #FFA69F;\n\t\t\t\t\t display: block;\n\t\t\t\t\t font-size: 1.2em;\n\t\t\t\t\t font-weight: 900;\n\t\t\t\t\t text-shadow: 0px 0px 2px #D53428;\n\t\t\t\t\t background-color: #993B2288;\n\t\t\t\t\t padding: 0 1em;\n\t\t\t\t\t border-radius: 3px;")})),{i:function(){return i},finishLoad:function(a){t[a].state=null,l(),++s===Object.keys(t).length&&(e("preload").classList.add("ready"),n&&r())},setState:function(e,s){t[e].state=s,l()},finish:function(){s===Object.keys(t).length&&r(),n=!0},ready:function(e){a.push(e)},unready:function(){n&&(e("preload").classList.remove("hidden"),n=!1,lt())},update:function(e=!1,t){F=!0,e||x({msg:"installing a required update... if this seems stuck, hit CTRL+F5 to force a reload",color:"#0060FF",icon:"update",timeout:15e3});const s=()=>{t?location.replace(`/${location.search.length>1?`${location.search}&`:"?"}hv=${t}${location.hash.length>1?`#${location.hash}`:""}`):location.reload(!0)};try{V((()=>{s()}))}catch(e){console.error(e)}setTimeout((()=>{s()}),1e3)}}}();let B=0;const X=(()=>{const s={"tetr-io_300x250_1":{name:"Quick Play Lobby",enabled:!0,refresh:!0,refresh_time:3e4},"tetr-io_970X250_1":{name:"Homebanner Mega",enabled:!0,refresh:!0,refresh_time:3e4,min_width:1600},"tetr-io_970X250_2":{name:"Custom Room Results Mega",enabled:!0,refresh:!0,refresh_time:3e4,min_width:1600},"tetr-io_728x90_1":{name:"Homebanner",enabled:!0,refresh:!0,refresh_time:3e4,max_width:1600},"tetr-io_728x90_2":{name:"Solo Menu",enabled:!0,refresh:!0,refresh_time:3e4},"tetr-io_728x90_3":{name:"Multiplayer Menu",enabled:!0,refresh:!0,refresh_time:3e4},"tetr-io_728x90_4":{name:"Custom Room Lobby",enabled:!0,refresh:!0,refresh_time:3e4},"tetr-io_728x90_5":{name:"Custom Room Results",enabled:!0,refresh:!0,refresh_time:3e4,max_width:1600},"tetr-io_728x90_6":{name:"Tetra League Home",enabled:!0,refresh:!0,refresh_time:3e4},"tetr-io_728x90_7":{name:"Solo Results",enabled:!0,refresh:!0,refresh_time:3e4},"tetr-io_728x90_8":{name:"Login Screen",enabled:!0,refresh:!1},"tetr-io_728x90_9":{name:"Welcome Back Screen",enabled:!0,refresh:!1},"tetr-io_728x90_10":{name:"Ingame Banner",enabled:!1,refresh:!0,refresh_time:3e4,safezones:[["bottom","tetr-io_728x90_10",60]],bodyclasses:["igceriad-mounted_bottom"],animated:!0,unmountIfNotLoaded:!0,onlyApplySafeZonesWhenLoaded:!0}},a={login:["tetr-io_728x90_8","tetr-io_728x90_9"],main:["tetr-io_728x90_1","tetr-io_728x90_2","tetr-io_728x90_3","tetr-io_728x90_4","tetr-io_728x90_5","tetr-io_728x90_6","tetr-io_728x90_7","tetr-io_300x250_1"],ingame:["tetr-io_728x90_10"]};function n(a){if(aiptag&&s[a])if(!s[a].enabled||window.innerWidth<(s[a].min_width||0)||window.innerWidth>=(s[a].max_width||9999))e(a).classList.add("hidden");else if(!document.body.classList.contains("ceriad_disabled")){if(e(a).classList.remove("hidden"),s[a].mounted||(console.log(`${a} mounted, now ${++B} mounts`),s[a].animated&&(e(a).getBoundingClientRect(),e(a).classList.remove("hiding"))),s[a].mounted=!0,s[a].elapsed=0,aiptag.cmd.display.push((function(){aipDisplayTag.display(a)})),s[a].safezones&&!s[a].onlyApplySafeZonesWhenLoaded)for(const e of s[a].safezones)ws(...e);if(s[a].bodyclasses)for(const e of s[a].bodyclasses)document.body.classList.add(e);if(s[a].unmountIfNotLoaded||s[a].onlyApplySafeZonesWhenLoaded){let n=performance.now(),i=setInterval((()=>{if(!s[a].mounted)return void clearInterval(i);let r=!0;if((""===e(a).innerHTML||t(`#${a}>div`)&&""===t(`#${a}>div`).innerHTML)&&(r=!1),r){if(clearInterval(i),s[a].onlyApplySafeZonesWhenLoaded&&s[a].safezones)for(const e of s[a].safezones)ws(...e)}else performance.now()-n>=5e3&&(clearInterval(i),s[a].unmountIfNotLoaded&&(console.log(`${a} unmounted, no content available after ${performance.now()-n}ms`),o(a)))}),100)}}}function o(t){if(aiptag&&s[t]&&s[t].enabled){if(""!==e(t).innerHTML&&(e(t).innerHTML=""),s[t].mounted&&console.log(`${t} unmounted, now ${--B} mounts`),s[t].mounted=!1,s[t].elapsed=0,s[t].safezones)for(const e of s[t].safezones)ks(...e);if(s[t].bodyclasses)for(const e of s[t].bodyclasses)document.body.classList.remove(e);s[t].animated&&(e(t).classList.add("hiding"),setTimeout((()=>{s[t].mounted||e(t).classList.add("hidden")}),500))}}function i(e){a[e]&&a[e].forEach((e=>{o(e)}))}function r(){Object.keys(s).forEach((e=>{o(e)}))}let l=0;g((()=>{e("consentbutton").addEventListener("click",(()=>{window.aipAPItag&&(window.location="?cmpscreen")})),setInterval((()=>{"visible"===document.visibilityState&&(e("menus").classList.contains("hidden")&&e("preload").classList.contains("hidden")?(i("login"),i("main")):i("ingame"),function(e=!1){if(e||!l)return void(l=Date.now());const t=Date.now()-l;l=Date.now(),Object.keys(s).forEach((e=>{s[e].enabled&&s[e].refresh&&s[e].mounted&&(s[e].elapsed=(s[e].elapsed||0)+t,s[e].elapsed>=s[e].refresh_time&&n(e))}))}())}),1e3),window.IS_ELECTRON||(s["tetr-io_728x90_10"].enabled=!0)}));let c=!1;return{mount:n,mountGroup:function(e){a[e]&&a[e].forEach((e=>{n(e)}))},mountIfMounted:function(e){aiptag&&s[e]&&s[e].enabled&&s[e].refresh&&s[e].mounted&&n(e)},unmount:o,unmountGroup:i,unmountAll:r,loadProvider:function(){if(c)return;c=!0;const e=document.createElement("script");e.async=!0,e.src="https://api.adinplay.com/libs/aiptag/pub/TTI/tetr.io/tag.min.js",e.onload=()=>{console.log("Ceriad provider has been loaded successfully.")},e.onerror=()=>{console.log("Ceriad provider could not be loaded."),document.body.classList.add("ceriad_unavailable"),document.body.classList.add("ceriad_disabled"),r()},document.head.insertAdjacentElement("beforeend",e)}}})(),z=(()=>{const t={loggedIn:!1,token:"",id:"",username:""};function s(){localStorage.setItem("userToken",t.token),localStorage.setItem("userID",t.id),localStorage.setItem("username",t.username)}async function a(e,t){if(!crypto.subtle)return;e=await crypto.subtle.importKey("raw",e,"AES-CBC",!1,["encrypt"]);const s=crypto.getRandomValues(new Uint8Array(16)),a=await crypto.subtle.encrypt({name:"AES-CBC",iv:s},e,(new TextEncoder).encode(t));return btoa(JSON.stringify({x:btoa(String.fromCharCode(...new Uint8Array(a))),z:btoa(String.fromCharCode(...s))}))}return function(){const e=localStorage.getItem("userToken"),s=localStorage.getItem("userID"),a=localStorage.getItem("username");e?(t.loggedIn=!0,t.token=e,t.id=s,t.username=a):(t.loggedIn=!1,t.token="",t.id="",t.username="")}(),{loggedIn:()=>t.loggedIn,id:()=>t.id,token:()=>t.token,username:()=>t.username,changeUsername:e=>{t.username=e,s()},logout:(e=!1)=>{t.loggedIn=!1,t.token="",t.id="",t.username="",Ut.resetZen(),s()},login:(e,a,n,o=!0)=>{t.loggedIn=!0,t.token=e,t.id=a,t.username=n,o&&s()},anon:()=>document.body.classList.contains("anon"),getUserInfoOrDie:function(e,t){return new Promise(((s,n)=>{Le.getWhenReady((async o=>{w.get("/api/users/me",void 0,{headers:{"X-Session-ID":e,"X-Connection-ID":await a(t,o)}}).then((e=>{s(e.user)}),(e=>{if(e.error&&"A-LINED"===e.error.msg)return window.location=e.error.redirect,void Y();U.unready(),n()}))}))}))},requestPassword:function(t){if(document.body.classList.contains("uses2fa"))return D({title:"PASSWORD REQUESTED",msg:`to continue, please re-enter the password for <span class="inline_self">${localStorage.getItem("username").toUpperCase()}</span><br><input data-escape="request_password_cancel" data-enter="request_password_totp" id="request_password" type="password" placeholder="PASSWORD" autocomplete="current-password"><br><br>as well as a six-digit code from your authenticator app, or one of your recovery codes<br><input data-escape="request_password_cancel" data-enter="request_password_submit" id="request_password_totp" placeholder="six digits" class="mono_input centered_input" autocomplete="off">`,buttons:[{label:"CANCEL",classes:[],id:"request_password_cancel",callback:e=>{e()}},{label:"SUBMIT",classes:["pri"],id:"request_password_submit",callback:s=>{t(e("request_password").value,e("request_password_totp").value),s()}}]}),void e("request_password").focus();D({title:"PASSWORD REQUESTED",msg:`to continue, please re-enter the password for <span class="inline_self">${localStorage.getItem("username").toUpperCase()}</span><br><input data-escape="request_password_cancel" data-enter="request_password_submit" id="request_password" type="password" placeholder="PASSWORD" autocomplete="current-password">`,buttons:[{label:"CANCEL",classes:[],id:"request_password_cancel",callback:e=>{e()}},{label:"SUBMIT",classes:["pri"],id:"request_password_submit",callback:s=>{t(e("request_password").value,""),s()}}]}),e("request_password").focus()},esc:a}})(),G=(()=>{const t=`SESS-${Math.floor(Math.random()*Number.MAX_SAFE_INTEGER)}`;let a=null;const o=window.location.hash.substring(1);history.replaceState(null,null," ");let i=!1,l=[],c=!1;function d(s){return new Promise(((o,i)=>{z.getUserInfoOrDie(t,a).then((t=>{s&&(s.classList.remove("busy"),h(s),e("captcha_form").classList.remove("busy"),h(e("captcha_form")),e("totp_form").classList.remove("busy"),h(e("totp_form")),e("entry_form").classList.remove("busy"),h(e("entry_form"))),t.username!==z.username()&&(x({msg:`your username was changed from ${z.username().toUpperCase()} to ${t.username.toUpperCase()}.`,color:"#FFD800",icon:"swaphost",timeout:3e4}),z.changeUsername(t.username)),e("me_username").innerHTML=t.username,e("me_username").classList.toggle("lu",t.username.length>13),e("tetra_me_username").innerHTML=t.username,Ks(js(t.xp),e("me_level")),Qs(t.xp,!0),Ut.loadZen(t.zen),"anon"===t.role?(document.body.classList.add("anon"),localStorage.setItem("moonKagariUsername","X-ANON")):(document.body.classList.remove("anon"),!t.email&&t.xp>11756&&It(),Ut.setRecords(t.records||{}),localStorage.setItem("lastUsername",t.username),localStorage.setItem("moonKagariUsername",t.username)),document.body.classList.toggle("uses2fa",!!t.totp&&!!t.totp.enabled),document.body.classList.toggle("dmfriendonly","everyone"!==(t.privacy_dm||"everyone")),document.body.classList.toggle("bot","bot"===t.role),document.body.classList.toggle("staff",["mod","admin"].includes(t.role)),document.body.setAttribute("data-country",t.country),document.body.setAttribute("data-country-hidden",!1===t.privacy_showcounty?"yes":"no");try{_paq.push(["setCustomDimension",1,t.role]),"anon"!==t.role&&_paq.push(["setUserId",t.username])}catch(e){console.error(e)}if(setTimeout((()=>{try{_paq.push(["setCustomDimension",2,window.IS_ELECTRON?`TETR.IO Desktop v${window.CLIENT_VERSION}${te.electron.adblock?" (ads blocked)":""}`:"Browser"+(window.aiptag.settings?"":" (ads blocked)")])}catch(e){console.error(e)}}),2500),document.body.classList.toggle("supporter",!!t.supporter),document.body.classList.toggle("supporter_at_launch",!!t.supporter),localStorage.setItem("wasLastSupporter",t.supporter||["mod","admin"].includes(t.role)?"Yes, that's it!":"No, that's wrong!"),t.supporter||["mod","admin"].includes(t.role)||window.IS_ELECTRON&&te.electron.adblock||X.loadProvider(),l=t.warnings,c=!!t.thanked,"ok"===t.bannedstatus)_(),document.body.classList.remove("trapped"),localStorage.removeItem("trapped");else{document.body.classList.add("trapped"),localStorage.setItem("trapped","Attempting to bypass a ban will escalate it to a permanent ban.");let s="silence"==t.bannedstatus?"SILENCED users may not chat or create public rooms, but can still submit scores and play online.":"RESTRICTED users may not play online or submit scores.",a=1;t.banlist.forEach((e=>{s+=`</p><p>&nbsp;</p><p class="modal_also">#${a++}: ban id ${e._id}</p><p>your ${e.from} was ${"silence"==e.type?"silenced":"restricted"} at ${new Date(e.ts).toLocaleString()} for the following reason:</p><p class="banreason">${r(e.reason)}${e.context&&e.context.chat&&e.context.chat.length?`<span class="context">${e.context.chat.map((e=>`[${t.username.toUpperCase()}] ${r(e)}`)).join("\n")}</span>`:""}</p><p>this ban ${Date.parse(e.expires)-Date.parse(e.ts)>=54e12?"will not expire":`expires in ${n(Date.parse(e.expires))}`}.`})),e("ban_header").innerHTML="YOU HAVE BEEN "+("silence"==t.bannedstatus?"SILENCED":"RESTRICTED"),e("ban_reasons").outerHTML=`<p id="ban_reasons">${s}</p>`,e("banned_warning").classList.remove("hidden"),e("banned_warning_iponly").classList.toggle("hidden",t.banlist.some((e=>"account"===e.from))),document.body.classList.add(`banstatus_${t.bannedstatus}`)}e("me_leaguerank").classList.toggle("hidden","z"===t.league.rank),e("me_leaguerank").src=`/res/league-ranks/${t.league.rank}.png`,t.avatar_revision?e("me_avatar").setAttribute("src",`/user-content/avatars/${t._id}.jpg?rv=${t.avatar_revision}`):"anon"!==t.role&&e("me_avatar").setAttribute("src",u(t._id)),(t.supporter||["mod","admin"].includes(t.role))&&(document.body.classList.add("ceriad_exempt"),document.body.classList.add("ceriad_disabled"),X.unmountAll(),document.cookie="ceriad_exempt=1;max-age=31536000;domain=tetr.io"),X.unmountGroup("login"),o(t)})).catch((t=>{console.log(t),U.unready(),s&&(s.classList.remove("busy"),h(s),e("captcha_form").classList.remove("busy"),h(e("captcha_form")),e("totp_form").classList.remove("busy"),h(e("totp_form"))),T("you were logged out. please log in again!"),e("entry_username").value=z.username(),e("entry_button").click()}))}))}function p(){if(!PIXI.utils.isWebGLSupported())return;"Attempting to bypass a ban will escalate it to a permanent ban."===localStorage.getItem("trapped")&&document.body.classList.add("trapped");const t=function(){if(!o)return;let t=!1;const a=o.substring(0,2);return"P:"!==a&&"D:"!==a?(s(".quickjoin").forEach((e=>{switch(a){case"R:":case"r:":e.innerHTML="opening replay <span></span>",e.querySelector("span").textContent=o;break;case"S:":e.innerHTML="supporting <span></span>",e.querySelector("span").textContent=o.substring(2),t=!0;break;default:e.innerHTML="joining room <span></span>",e.querySelector("span").textContent=!1!==te.video.hideroomids?`#${o}`:"<hidden>"}e.classList.remove("hidden")})),s(".electron_jump").forEach((t=>{t.classList.remove("hidden"),t.addEventListener("click",(function(t){h(e("entry_form")),h(e("return_form")),f(e("electron_form")),window.location=`tetrio://${o}`}))})),s(".electron_jump_also").forEach((e=>{e.classList.remove("hidden")})),t):void 0}();"P:"!==o.substring(0,2)?"D:"!==o.substring(0,2)?(window.IS_ELECTRON?document.body.classList.add("no_login_ceriad"):(vt("Login Screen"),"Yes, that's it!"===localStorage.getItem("wasLastSupporter")?document.body.classList.add("no_login_ceriad"):X.loadProvider()),z.loggedIn()?(f(e("return_form")),e("return_is").innerHTML=z.username().toUpperCase(),(t||window.IS_ELECTRON&&"never"!==te.electron.loginskip)&&("always"===(te.electron.loginskip||"always")||o)&&(e("return_form").classList.add("busy"),d(e("return_form")))):f(e("entry_form"))):f(e("deletion_step1_form")):f(e("reset_step2_form"))}function h(e){e.classList.add("hidden"),setTimeout((()=>{e.classList.contains("hidden")&&e.classList.add("noop")}),300)}function f(e){e.classList.remove("noop"),e.getBoundingClientRect(),e.classList.remove("hidden"),document.body.classList.contains("no_login_ceriad")||("return_form"===e.id?X.mount("tetr-io_728x90_9"):"entry_form"===e.id&&X.mount("tetr-io_728x90_8"))}function _(){if(!l.length)return void(c?D({msg:'</p><center><img src="/res/hifive.png" /><h1>THANK YOU FOR REPORTING</h1></center><p>thank you for your recent report! reports like yours help us identify those who disrupt TETR.IO for everyone.</p><p>your recent reports led to actions against a badly behaving player and their account. thank you for making TETR.IO a better place!</p><p>we hope you\'ll continue assisting us by reporting bad behavior in the future, as well.</p><br><p>TETR.IO STAFF',classes:["noclickout"],buttons:[{label:"OK",classes:[],callback:e=>{e(),U.finish()}}]}):U.finish());const e=l.shift();D({title:"YOU HAVE BEEN WARNED",msg:`a TETR.IO moderator has left a message for you. please read it thoroughly.</p><p>&nbsp;</p><p class="modal_also">warning id ${e._id}</p><p>you were warned at ${new Date(e.ts).toLocaleString()} for the following reason:</p><p class="banreason">${r(e.reason)}${e.context&&e.context.chat&&e.context.chat.length?`<span class="context">${e.context.chat.map((e=>`[${z.username().toUpperCase()}] ${r(e)}`)).join("\n")}</span>`:""}`,classes:["ban_modal","noclickout"],buttons:[{label:"OK",classes:[],callback:e=>{e(),_()}}]})}return g((()=>{w.get("/api/server/environment",void 0,{headers:{"X-Session-ID":t}}).then((t=>{a=Uint8Array.from(atob(t.vx),(e=>e.charCodeAt(0))),U.finishLoad("environment"),window.IS_ELECTRON&&(console.log("%cUsing the Desktop Client","color: #F3E5C0;\n\t\t\t\t\t\t font-size: 1.2em;\n\t\t\t\t\t\t font-weight: 900;\n\t\t\t\t\t\t text-shadow: 0px 0px 2px #BAB650;\n\t\t\t\t\t\t background-color: #504C3488;\n\t\t\t\t\t\t padding: 0 1em;\n\t\t\t\t\t\t border-radius: 3px;"),q()),t.signature.build.id!==TETRIO_ENV.build.id||"creamykagarin18451"!==document.body.getAttribute("data-v")?(console.log(`%cOut of date. Local build ${TETRIO_ENV.build.id} does not match server build ${t.signature.build.id}`,"color: #FF8E8E;\n\t\t\t\t\t font-size: 1.2em;\n\t\t\t\t\t font-weight: 900;\n\t\t\t\t\t text-shadow: 0px 0px 2px #E83737;\n\t\t\t\t\t background-color: #B6181888;\n\t\t\t\t\t padding: 0 1em;\n\t\t\t\t\t border-radius: 3px;"),U.update(!1,`${t.signature.commit.id}.${t.signature.serverCycle}.${t.signature.build.id}`)):(console.log(`%cUp to date. Local version ${TETRIO_ENV.version}-${TETRIO_ENV.mode} | Commit ${TETRIO_ENV.commit.id} (${new Date(TETRIO_ENV.commit.time).toLocaleString()}) | Server cycle ${TETRIO_ENV.serverCycle} | Build ${TETRIO_ENV.build.id} (${new Date(TETRIO_ENV.build.time).toLocaleString()})`,"color: #C0F3C8;\n\t\t\t\t\t font-size: 1.2em;\n\t\t\t\t\t font-weight: 900;\n\t\t\t\t\t text-shadow: 0px 0px 2px #50BA5C;\n\t\t\t\t\t background-color: #34503788;\n\t\t\t\t\t padding: 0 1em;\n\t\t\t\t\t border-radius: 3px;"),p()),e("preform_players_entry").innerHTML=t.stats.players.toLocaleString("en-US"),e("preform_players_return").innerHTML=t.stats.players.toLocaleString("en-US"),e("preform_games_entry").innerHTML=t.stats.gamesplayed.toLocaleString("en-US"),e("preform_games_return").innerHTML=t.stats.gamesplayed.toLocaleString("en-US"),e("preform_hours_entry").innerHTML=Math.floor(t.stats.gametime/3600).toLocaleString("en-US"),e("preform_hours_return").innerHTML=Math.floor(t.stats.gametime/3600).toLocaleString("en-US")}),(e=>{U.finishLoad("environment"),window.IS_ELECTRON&&(console.log("%cUsing the Desktop Client","color: #F3E5C0;\n\t\t\t\t\t\t font-size: 1.2em;\n\t\t\t\t\t\t font-weight: 900;\n\t\t\t\t\t\t text-shadow: 0px 0px 2px #BAB650;\n\t\t\t\t\t\t background-color: #504C3488;\n\t\t\t\t\t\t padding: 0 1em;\n\t\t\t\t\t\t border-radius: 3px;"),q()),T("failed to check for updates. check your connection!"),p()})),e("entry_button").addEventListener("click",(function(t){let s=e("entry_username").value.toLowerCase();if(!s){if(localStorage.getItem("defaultAnonUsername"))e("entry_username").value=localStorage.getItem("defaultAnonUsername");else{const t=`GUEST-${m(6,10,"0123456789AIUEO_")}`;localStorage.setItem("defaultAnonUsername",t),e("entry_username").value=t}return s=e("entry_username").value.toLowerCase(),e("entry_form").classList.add("busy"),void e("askregister_anon").click()}e("entry_form").classList.add("busy"),w.get(`/api/users/${encodeURIComponent(s)}/exists`).then((t=>{e("entry_form").classList.remove("busy"),h(e("entry_form")),t.exists?(e("login_is").innerHTML=s.toUpperCase(),e("login_password_username_field").value=s.toUpperCase(),f(e("login_form")),e("login_password").focus()):(e("askregister_is").innerHTML=s.toUpperCase(),e("register_password_username_field").value=s.toUpperCase(),f(e("askregister_form")))}),(t=>{e("entry_form").classList.remove("busy"),S(t)}))})),e("askregister_back").addEventListener("click",(function(t){h(e("askregister_form")),f(e("entry_form")),e("entry_username").focus()})),e("askregister_register").addEventListener("click",(function(t){h(e("askregister_form")),localStorage.getItem("lastUsername")?(f(e("registeralt_form")),e("registeralt_username").textContent=localStorage.getItem("lastUsername").toUpperCase()):(f(e("register_form")),e("register_password_email_field").focus())})),e("registeralt_back").addEventListener("click",(function(t){h(e("registeralt_form")),f(e("entry_form")),e("entry_username").focus()})),e("registeralt_continue").addEventListener("click",(function(t){h(e("registeralt_form")),f(e("register_form")),e("register_password_email_field").focus()})),e("register_button").addEventListener("click",(function(s){const a=e("entry_username").value.toLowerCase(),o=e("register_password_email_field").value,l=e("register_password").value;l===e("register_password_confirmation").value?(e("register_form").classList.add("busy"),w.post("/api/users/create",{username:a,password:l,email:o||void 0,captcha:e("captcha").value},{headers:{"X-Session-ID":t}}).then((t=>{e("register_password").value="",e("register_password_confirmation").value="",x("welcome!"),i=!0,z.login(t.token,t.userid,a),d(e("register_form"))}),(t=>{if(t.error&&"BLOCK"===t.error.msg){document.body.classList.add("trapped"),localStorage.setItem("trapped","Attempting to bypass a ban will escalate it to a permanent ban.");let s="BLOCKED users or IPs may not create accounts. try using an existing account.",a=1;return t.error.banlist.forEach((e=>{s+=`</p><p>&nbsp;</p><p class="modal_also">#${a++}: ban id ${e._id}</p><p>your ${e.from} was ${"silence"==e.type?"silenced":"restrict"==e.type?"restricted":"blocked"} at ${new Date(e.ts).toLocaleString()} for the following reason:</p><p class="banreason">${r(e.reason)}</p><p>this ban ${Date.parse(e.expires)-Date.parse(e.ts)>=54e12?"will not expire":`expires in ${n(Date.parse(e.expires))}`}.`})),e("block_reasons").outerHTML=`<p id="block_reasons">${s}</p>`,e("blocked_warning").classList.remove("hidden"),e("blocked_warning_iponly").classList.toggle("hidden",t.error.banlist.some((e=>"account"===e.from))),t.error.infinite&&(e("block_header").innerHTML="YOU HAVE BEEN BANNED FROM TETR.IO",e("blocked_warning").classList.remove("ban_modal"),e("blocked_warning").classList.add("crash_modal")),e("register_form").classList.remove("busy"),e("captcha_form").classList.remove("busy"),h(e("register_form")),void h(e("captcha_form"))}if(t.error&&"CAPTCHA"===t.error.msg)return e("captcha").value="",e("register_form").classList.remove("busy"),e("captcha_form").classList.remove("busy"),e("captcha_button").setAttribute("data-for","register_button"),e("captcha_image").innerHTML=t.error.captcha,h(e("register_form")),void f(e("captcha_form"));e("register_form").classList.remove("busy"),e("captcha_form").classList.remove("busy"),S(t)}))):T("those passwords don't match")})),e("register_back").addEventListener("click",(function(t){h(e("register_form")),f(e("askregister_form")),e("register_password").value="",e("register_password_confirmation").value=""})),e("login_button").addEventListener("click",(function(t){const s=e("entry_username").value.toLowerCase(),a=e("login_password").value;e("login_form").classList.add("busy"),w.post("/api/users/authenticate",{username:s,password:a,totp:e("totp").value}).then((t=>{e("login_password").value="",z.login(t.token,t.userid,s),d(e("login_form"))}),(t=>{if(t.error&&"BLOCK"===t.error.msg){document.body.classList.add("trapped"),localStorage.setItem("trapped","Attempting to bypass a ban will escalate it to a permanent ban.");let s="BLOCKED users or IPs may not use TETR.IO.",a=1;return t.error.banlist.forEach((e=>{s+=`</p><p>&nbsp;</p><p class="modal_also">#${a++}: ban id ${e._id}</p><p>your ${e.from} was ${"silence"==e.type?"silenced":"restrict"==e.type?"restricted":"blocked"} at ${new Date(e.ts).toLocaleString()} for the following reason:</p><p class="banreason">${r(e.reason)}</p><p>this ban ${Date.parse(e.expires)-Date.parse(e.ts)>=54e12?"will not expire":`expires in ${n(Date.parse(e.expires))}`}.`})),e("block_reasons").outerHTML=`<p id="block_reasons">${s}</p>`,e("blocked_warning").classList.remove("hidden"),e("blocked_warning_iponly").classList.toggle("hidden",t.error.banlist.some((e=>"account"===e.from))),t.error.infinite&&(e("block_header").innerHTML="YOU HAVE BEEN BANNED FROM TETR.IO",e("blocked_warning").classList.remove("ban_modal"),e("blocked_warning").classList.add("crash_modal")),e("login_form").classList.remove("busy"),void h(e("login_form"))}if(t.error&&"TOTP"===t.error.msg)return e("totp").value="",e("login_form").classList.remove("busy"),e("totp_form").classList.remove("busy"),e("totp_button").setAttribute("data-for","login_button"),h(e("login_form")),void f(e("totp_form"));e("totp_form").classList.remove("busy"),e("login_form").classList.remove("busy"),S(t)}))})),e("login_back").addEventListener("click",(function(t){h(e("login_form")),f(e("entry_form")),e("entry_username").focus(),e("login_password").value=""})),e("login_reset").addEventListener("click",(function(t){h(e("login_form")),f(e("request_reset_form")),e("request_reset_email").focus(),e("login_password").value=""})),e("request_reset_back").addEventListener("click",(function(t){h(e("request_reset_form")),f(e("login_form")),e("login_password").focus(),e("request_reset_email").value=""})),e("request_reset_button").addEventListener("click",(function(s){const a=e("entry_username").value.toLowerCase(),n=e("request_reset_email").value;e("request_reset_form").classList.add("busy"),w.post("/api/users/requestPasswordReset",{username:a,email:n,captcha:e("captcha").value},{headers:{"X-Session-ID":t}}).then((t=>{I("if the email you entered was correct, you should be receiving an email shortly!"),e("request_reset_form").classList.remove("busy"),e("request_reset_back").click(),e("captcha_form").classList.remove("busy"),h(e("captcha_form"))}),(t=>{if(t.error&&"CAPTCHA"===t.error.msg)return e("captcha").value="",e("request_reset_form").classList.remove("busy"),e("captcha_form").classList.remove("busy"),e("captcha_button").setAttribute("data-for","request_reset_button"),e("captcha_image").innerHTML=t.error.captcha,h(e("request_reset_form")),f(e("captcha_form")),void e("captcha_form").classList.remove("busy");e("request_reset_form").classList.remove("busy"),e("captcha_form").classList.remove("busy"),S(t)}))})),e("reset_step2_button").addEventListener("click",(function(t){const s=o.substring(2),a=e("reset_step2_password").value;a===e("reset_step2_password_confirmation").value?(e("reset_step2_form").classList.add("busy"),w.post("/api/users/resetPassword",{recoveryid:s,password:a}).then((t=>{e("reset_step2_password").value="",e("reset_step2_password_confirmation").value="",I("password reset!"),h(e("reset_step2_form")),f(e("entry_form")),e("entry_username").focus()}),(t=>{e("reset_step2_form").classList.remove("busy"),S(t)}))):T("those passwords don't match")})),e("askregister_anon").addEventListener("click",(function(s){const a=e("entry_username").value.toLowerCase();e("askregister_form").classList.add("busy"),w.post("/api/users/anonymousJoin",{username:a,captcha:e("captcha").value},{headers:{"X-Session-ID":t}}).then((t=>{t.newname||a.startsWith("guest-")||x("this name has been used before - please consider registering a full account!"),i=!0,z.login(t.token,t.userid,a,!1),d(e("askregister_form"))}),(t=>{if(t.error&&"BLOCK"===t.error.msg){document.body.classList.add("trapped"),localStorage.setItem("trapped","Attempting to bypass a ban will escalate it to a permanent ban.");let s="BLOCKED users or IPs may not use TETR.IO. try using an existing account.",a=1;return t.error.banlist.forEach((e=>{s+=`</p><p>&nbsp;</p><p class="modal_also">#${a++}: ban id ${e._id}</p><p>your ${e.from} was ${"silence"==e.type?"silenced":"restrict"==e.type?"restricted":"blocked"} at ${new Date(e.ts).toLocaleString()} for the following reason:</p><p class="banreason">${r(e.reason)}</p><p>this ban ${Date.parse(e.expires)-Date.parse(e.ts)>=54e12?"will not expire":`expires in ${n(Date.parse(e.expires))}`}.`})),e("block_reasons").outerHTML=`<p id="block_reasons">${s}</p>`,e("blocked_warning").classList.remove("hidden"),e("blocked_warning_iponly").classList.toggle("hidden",t.error.banlist.some((e=>"account"===e.from))),t.error.infinite&&(e("block_header").innerHTML="YOU HAVE BEEN BANNED FROM TETR.IO",e("blocked_warning").classList.remove("ban_modal"),e("blocked_warning").classList.add("crash_modal")),e("askregister_form").classList.remove("busy"),e("captcha_form").classList.remove("busy"),h(e("askregister_form")),h(e("entry_form")),void h(e("captcha_form"))}if(t.error&&"CAPTCHA"===t.error.msg)return e("captcha").value="",e("askregister_form").classList.remove("busy"),e("captcha_form").classList.remove("busy"),e("entry_form").classList.remove("busy"),e("captcha_button").setAttribute("data-for","askregister_anon"),e("captcha_image").innerHTML=t.error.captcha,h(e("askregister_form")),h(e("entry_form")),void f(e("captcha_form"));e("askregister_form").classList.remove("busy"),e("captcha_form").classList.remove("busy"),S(t)}))})),e("captcha_button").addEventListener("click",(function(t){e("captcha").value&&(e("captcha_form").classList.add("busy"),e(e("captcha_button").getAttribute("data-for")).click())})),e("totp_button").addEventListener("click",(function(t){e("totp").value&&(e("totp_form").classList.add("busy"),e(e("totp_button").getAttribute("data-for")).click())})),e("return_logout").addEventListener("click",(function(t){const s=()=>{h(e("return_form")),z.logout(!0),f(e("entry_form"))};document.body.classList.contains("trapped")||"Attempting to bypass a ban will escalate it to a permanent ban."===localStorage.getItem("trapped")?(h(e("return_form")),D({title:"AS A STERN REMINDER",msg:'IF YOU HAVE BEEN SILENCED, RESTRICTED OR OTHERWISE BANNED, YOU MAY NEVER SWITCH TO ANOTHER ACCOUNT TO EVADE THE BAN. THIS INCLUDES SWITCHING TO AN ANONYMOUS ACCOUNT. EVADING A BAN MAKES IT PERMANENT.</p><p class="modal_warning">exceptions apply if the ban was not meant for you, or when logging out of an alternate account. for more info, read the <a href="/about/rules/" target="_blank">community rules</a>.',classes:["crash_modal","noclickout"],buttons:[{label:"CANCEL",classes:[],callback:t=>{f(e("return_form")),t()}},{label:"I'M NOT EVADING!",classes:["pri"],callback:t=>{f(e("return_form")),t(),s()}}]})):s()})),e("return_button").addEventListener("click",(function(t){e("return_form").classList.add("busy"),d(e("return_form"))})),e("ban_skip_button").addEventListener("click",(function(t){e("banned_warning").classList.add("hidden"),_()})),e("deletion_step1_button").addEventListener("click",(function(t){h(e("deletion_step1_form")),f(e("deletion_step2_form"))})),e("deletion_step1_cancel").addEventListener("click",(function(e){U.update(!0)})),e("deletion_step2_button").addEventListener("click",(function(t){h(e("deletion_step2_form")),f(e("deletion_step3_form")),e("deletion_spanner").classList.remove("hidden")})),e("deletion_step2_cancel").addEventListener("click",(function(e){U.update(!0)}));let s=10,l=!1;function c(){l||(s--,e("deletion_countdown").innerHTML=Math.max(0,s),-1===s?(e("deletion_cancel_holder").remove(),e("deletion_countdown").remove(),e("deletion_header").innerHTML="DESTRUCTION!",setTimeout((()=>{w.post("/api/users/finalizeDeletion",{deletionid:o.substring(2)}).then((t=>{z.logout(),e("deletion_header").innerHTML="ACCOUNT DELETED",e("deletion_final_form").classList.add("shudder"),setTimeout((()=>{e("deletion_final_form").classList.remove("shudder")}),150),setTimeout((()=>{U.update(!0)}),5e3)}),(t=>{e("deletion_header").innerHTML="an error has occured",S(t)}))}),500)):setTimeout(c,1e3))}e("deletion_step3_button").addEventListener("click",(function(t){h(e("deletion_step3_form")),f(e("deletion_final_form")),setTimeout(c,1e3)})),e("deletion_step3_cancel").addEventListener("click",(function(e){U.update(!0)})),e("deletion_final_cancel").addEventListener("click",(function(e){l=!0,U.update(!0)}))})),{quickjoin:o,newacc:()=>i}})();let j=null,W=null;function q(){document.body.classList.add("electron"),navigator.onLine||document.body.classList.add("offline"),window.addEventListener("offline",(function(e){document.body.classList.add("offline")})),window.addEventListener("online",(function(e){document.body.classList.remove("offline")})),document.addEventListener("keydown",(t=>{if(!t.repeat){if("f5"===t.key.toLowerCase()||"r"===t.key.toLowerCase()&&t.ctrlKey){if(!F&&document.body.classList.contains("ingame_phys")&&e("menus").classList.contains("hidden")&&0===ht)return;U.update(!0)}("I"===t.key&&t.ctrlKey||"f12"===t.key.toLowerCase())&&window.IPC.send("devtools"),"f11"===t.key.toLowerCase()&&"darwin"!==PLATFORM_TYPE&&window.IPC.send("fullscreen"),"f4"!==t.key.toLowerCase()||j||(j=setTimeout((()=>{window.IPC.send("emergency")}),5e3),W=setTimeout((()=>{x("keep holding F4 to enable SAFE MODE")}),1e3))}}),!1),document.addEventListener("keyup",(e=>{"f4"===e.key.toLowerCase()&&j&&(clearTimeout(j),clearTimeout(W),j=null,W=null)}),!1),window.IPC.on("goto",((t,s)=>{if(!e("preload").classList.contains("hidden")||document.body.classList.contains("ingame")||ga&&ga.isConnected()&&s.startsWith("https://tetr.io/#"))return F=!0,void(window.location=s);const a=s.replace("https://tetr.io/#","");switch(a.substring(0,2)){case"R:":Ds.navigateToShortID(a.trim());break;case"r:":Ds.navigateToLongID(a.trim());break;case"P:":case"D:":break;default:ct("connecting to live servers"),ga.require().then((e=>{dt(),et("playmulti"),e.maintenance&&document.body.classList.add("maintenance"),ka.joinRoom(a.trim())})).catch((()=>{dt(),T("could not connect to live servers")}))}}))}function K(){}function Y(){window.IS_ELECTRON?(F=!0,window.IPC.send("close")):console.error("Tried to exit while not on Electron")}function V(e){window.IS_ELECTRON?(window.IPC.send("nuke"),setTimeout((()=>{caches.delete("tetrio-dyn").then(e).catch((e=>{console.error(e)}))}),500)):e()}function Z(t){window.IS_ELECTRON&&!1!==te.electron.presence&&(t.largeImageText=z.anon()?"Playing anonymously":`${z.username().toUpperCase()} - Lv. ${e("me_level").innerHTML}${e("me_leaguerank").classList.contains("hidden")?"":` - ${e("me_leaguerank").getAttribute("src").replace("/res/league-ranks/","").replace(".png","").toUpperCase()}`}`,z.anon()||(t.buttons=[{label:"View Profile",url:`https://ch.tetr.io/u/${z.username()}`}]),window.IPC.send("presence",t))}function J(){window.IS_ELECTRON&&!1!==te.electron.taskbarflash&&window.IPC.send("flash")}function Q(e){window.IS_ELECTRON&&window.IPC.send("blockmovement",!!e)}const ee=(()=>{let e=!1,t=!1;window.addEventListener("gamepadconnected",(()=>{e=!0,x({msg:"a controller was connected",color:"#6AFF3C",icon:"connect"}),PIXI.Ticker.shared.add(o)})),window.addEventListener("gamepaddisconnected",(()=>{e=!1,x({msg:"a controller was disconnected",color:"#FF783C",icon:"disconnect"}),PIXI.Ticker.shared.remove(o)})),window.addEventListener("keydown",(()=>{t=!1}),!0);const s={};let a=10,n=2;function o(o){if(!e)return;const i=navigator.getGamepads?navigator.getGamepads():navigator.webkitGetGamepads?navigator.webkitGetGamepads:[];let r;for(let e=0;e<i.length;e++)i[e]&&(r=i[e]);for(let e=0;e<r.axes.length;e++){const i=`Axis_${e}_Pos`,l=r.axes[e]>(te.controls.sensitivity||.5),c=`Axis_${e}_Neg`,d=r.axes[e]<-1*(te.controls.sensitivity||.5);void 0!==s[i]&&s[i]!==l?(s[i]=l,a=10,n=2,t=!0,document.dispatchEvent(new CustomEvent("gp"+(l?"down":"up"),{detail:i}))):void 0===s[i]?s[i]=l:l&&(a>0?a-=o:n>0?n-=o:(n=2,t=!0,document.dispatchEvent(new CustomEvent("gprepeat",{detail:i,repeat:!0})))),void 0!==s[c]&&s[c]!==d?(s[c]=d,a=10,n=2,t=!0,document.dispatchEvent(new CustomEvent("gp"+(d?"down":"up"),{detail:c}))):void 0===s[c]?s[c]=d:d&&(a>0?a-=o:n>0?n-=o:(n=2,t=!0,document.dispatchEvent(new CustomEvent("gprepeat",{detail:c,repeat:!0}))))}for(let e=0;e<r.buttons.length;e++){const i=`Button_${e}`,l=r.buttons[e].value>(te.controls.sensitivity||.5);void 0!==s[i]&&s[i]!==l?(s[i]=l,a=10,n=2,t=!0,document.dispatchEvent(new CustomEvent("gp"+(l?"down":"up"),{detail:i}))):void 0===s[i]?s[i]=l:l&&(a>0?a-=o:n>0?n-=o:(n=2,t=!0,document.dispatchEvent(new CustomEvent("gprepeat",{detail:i,repeat:!0}))))}}return{pulse:function(s,a,n){if(!e||!t)return;if(0==te.controls.vibration)return;const o=navigator.getGamepads?navigator.getGamepads():navigator.webkitGetGamepads?navigator.webkitGetGamepads:[];let i;for(let e=0;e<o.length;e++)o[e]&&(i=o[e]);i.vibrationActuator&&i.vibrationActuator.playEffect&&i.vibrationActuator.playEffect("dual-rumble",{startDelay:0,duration:s,weakMagnitude:Math.min(1,(te.controls.vibration||1)*a),strongMagnitude:Math.min(1,(te.controls.vibration||1)*n)})},WEAK_GLIDE:[25,0,.15],WEAK_TAP:[50,0,.15],HARDDROP:[25,0,.2],CLEARLINE:[200,.3,.3],CLEARSPIN:[200,1,.3],CLEARQUAD:[300,.3,.6],CLEARB2B:[300,.6,.6],SPIN:[50,1,0],DAMAGE_SMALL:[150,.7,0],DAMAGE_MEDIUM:[250,.7,.7],DAMAGE_LARGE:[350,1,1],GARBAGERISE:[150,.5,0],CLEAR:[300,.5,1],TOPOUT:[500,.5,1],GARBAGESMASH:[500,1,1]}})(),te={controls:{style:"guideline",custom:{moveLeft:[],moveRight:[],softDrop:[],hardDrop:[],rotateCCW:[],rotateCW:[],rotate180:[],hold:[],exit:[],retry:[],chat:[],target1:[],target2:[],target3:[],target4:[],menuUp:[],menuDown:[],menuLeft:[],menuRight:[],menuBack:[],menuConfirm:[],openSocial:[]},sensitivity:.5,vibration:1},handling:{arr:2,das:10,dcd:0,sdf:6,safelock:!0,cancel:!1},volume:{disable:!1,music:.45,sfx:.4,stereo:.5,others:!0,attacks:!0,next:!1,noreset:!0,oof:!0,scrollable:!0,bgmtweak:{}},video:{graphics:"high",caching:"medium",actiontext:"all",particles:.6,background:.3,bounciness:1,shakiness:1,gridopacity:.1,boardopacity:.85,shadowopacity:.15,zoom:1,alwaystiny:!1,nosuperlobbyanim:!1,colorshadow:!1,sidebyside:!0,spin:!0,chatfilter:!0,background_url:null,background_usecustom:null,nochat:!1,hideroomids:!1,emotes:!0,emotes_anim:!0,siren:!0,powersave:!1,invert:!1,nobg:!1,chatbg:!0,replaytoolsnocollapse:!1,kos:!0,fire:!0,focuswarning:!0,hidenetwork:!1,guide:!0,lowrescounters:!1,desktopnotifications:!0,lowres:!1,webgl:"webgl2",bloom:1,chroma:.5,flashwave:1},gameoptions:{pro_40l:!1,pro_40l_alert:!1,pro_40l_retry:!1,stride_40l:!1,slot_40l_counter1:void 0,slot_40l_counter2:void 0,slot_40l_counter3:void 0,slot_40l_counter4:void 0,slot_40l_counter5:void 0,pro_blitz:!1,pro_blitz_alert:!1,pro_blitz_retry:!1,stride_blitz:!1,slot_blitz_counter1:void 0,slot_blitz_counter2:void 0,slot_blitz_counter3:void 0,slot_blitz_counter4:void 0,slot_blitz_counter5:void 0},electron:{loginskip:"always",frameratelimit:"4x",presence:!0,taskbarflash:!0,anglecompat:!1,adblock:!1},notifications:{suppress:!1,forcesound:!0,online:"ingame",offline:"off",dm:"both",dm_pending:"both",invite:"both",other:"both"}},se="ID_2";let ae={moveLeft:["A","KEYA","NUMPAD4"],moveRight:["D","KEYD","NUMPAD6"],softDrop:["W","KEYW","NUMPAD8"],hardDrop:["S","KEYS","NUMPAD5"],rotateCCW:["ARROWLEFT","LEFT","NUMPAD7"],rotateCW:["ARROWRIGHT","RIGHT","NUMPAD9"],rotate180:["ARROWUP","UP","NUMPAD2"],hold:["SHIFT","SHIFTLEFT","NUMPADENTER"],exit:["ESCAPE"],retry:["R","KEYR"],chat:["T","KEYT"],target1:["1","DIGIT1"],target2:["2","DIGIT2"],target3:["3","DIGIT3"],target4:["4","DIGIT4"],menuUp:["W","KEYW","ARROWUP","UP"],menuDown:["S","KEYS","ARROWDOWN","DOWN"],menuLeft:["A","KEYA","ARROWLEFT","LEFT"],menuRight:["D","KEYD","ARROWRIGHT","RIGHT"],menuBack:["ESCAPE","BACKSPACE"],menuConfirm:["ENTER","NUMPADENTER","SPACE"],openSocial:["TAB"]};const ne={moveLeft:["ARROWLEFT","LEFT","NUMPAD4"],moveRight:["ARROWRIGHT","RIGHT","NUMPAD6"],softDrop:["ARROWDOWN","DOWN","NUMPAD2"],hardDrop:["SPACE","NUMPAD8"],rotateCCW:["CONTROL","CONTROLLEFT","Z","KEYZ","NUMPAD3","NUMPAD7"],rotateCW:["ARROWUP","UP","X","KEYX","NUMPAD1","NUMPAD5","NUMPAD9"],rotate180:["A","KEYA"],hold:["SHIFT","SHIFTLEFT","C","KEYC","NUMPAD0"],exit:["ESCAPE"],retry:["R","KEYR"],chat:["T","KEYT"],target1:["1","DIGIT1"],target2:["2","DIGIT2"],target3:["3","DIGIT3"],target4:["4","DIGIT4"],menuUp:["W","KEYW","ARROWUP","UP"],menuDown:["S","KEYS","ARROWDOWN","DOWN"],menuLeft:["A","KEYA","ARROWLEFT","LEFT"],menuRight:["D","KEYD","ARROWRIGHT","RIGHT"],menuBack:["ESCAPE","BACKSPACE"],menuConfirm:["ENTER","NUMPADENTER","SPACE"],openSocial:["TAB"]},oe={moveLeft:["A","KEYA","NUMPAD4"],moveRight:["D","KEYD","NUMPAD6"],softDrop:["W","KEYW","NUMPAD8"],hardDrop:["S","KEYS","NUMPAD5"],rotateCCW:["ARROWLEFT","LEFT","NUMPAD7"],rotateCW:["ARROWRIGHT","RIGHT","NUMPAD9"],rotate180:["ARROWUP","UP","NUMPAD2"],hold:["SHIFT","SHIFTLEFT","NUMPADENTER"],exit:["ESCAPE"],retry:["R","KEYR"],chat:["T","KEYT"],target1:["1","DIGIT1"],target2:["2","DIGIT2"],target3:["3","DIGIT3"],target4:["4","DIGIT4"],menuUp:["W","KEYW","ARROWUP","UP"],menuDown:["S","KEYS","ARROWDOWN","DOWN"],menuLeft:["A","KEYA","ARROWLEFT","LEFT"],menuRight:["D","KEYD","ARROWRIGHT","RIGHT"],menuBack:["ESCAPE","BACKSPACE"],menuConfirm:["ENTER","NUMPADENTER","SPACE"],openSocial:["TAB"]};let ie=["../res/bg/1.jpg","../res/bg/2.jpg","../res/bg/3.jpg","../res/bg/4.jpg","../res/bg/5.jpg","../res/bg/6.jpg","../res/bg/7.jpg","../res/bg/8.jpg","../res/bg/9.jpg","../res/bg/10.jpg","../res/bg/11.jpg","../res/bg/12.jpg","../res/bg/13.jpg","../res/bg/14.jpg","../res/bg/15.jpg","../res/bg/16.jpg","../res/bg/17.jpg","../res/bg/18.jpg","../res/bg/19.jpg","../res/bg/20.jpg","../res/bg/21.jpg","../res/bg/22.jpg","../res/bg/23.jpg","../res/bg/24.jpg","../res/bg/25.jpg","../res/bg/26.jpg","../res/bg/27.jpg","../res/bg/28.jpg","../res/bg/29.jpg","../res/bg/30.jpg","../res/bg/31.jpg","../res/bg/32.jpg","../res/bg/33.jpg","../res/bg/34.jpg","../res/bg/35.jpg"],re=[],le="";function ce(){localStorage.setItem("userConfig",JSON.stringify(te))}function de(){const e=localStorage.getItem("userConfig");if(!e){console.log("First boot - welcome to TETR.IO!");localStorage.getItem("feecofScore");return localStorage.getItem("feecofScore")<3e5?te.video.graphics="low":localStorage.getItem("feecofScore")<6e5?te.video.graphics="medium":localStorage.getItem("feecofScore")<1e6||!window.IS_ELECTRON?te.video.graphics="high":te.video.graphics="ultra",void console.log(`Autoselected graphics mode ${te.video.graphics}`)}Object.assign(te,JSON.parse(e))}let pe=-1;function ue(){switch(Object.keys(ne).forEach((e=>{void 0===te.controls.custom[e]&&(te.controls.custom[e]=[])})),te.controls.style){case"guideline":Object.assign(ae,ne);break;case"wasd":Object.assign(ae,oe);break;case"custom":Object.assign(ae,te.controls.custom);let e=!1;Object.keys(ae).forEach((t=>{ae[t].forEach((t=>{null!==t&&t!==t.toUpperCase()&&(e=!0)}))})),e&&(te.controls.custom=ne,Object.assign(ae,te.controls.custom),x({msg:"your keybinds were reset due to an update. please re-enter them!",color:"#FF4200",icon:"error",timeout:15e3}))}te.handling.arr=parseFloat(te.handling.arr),te.handling.das=parseFloat(te.handling.das),te.handling.sdf=parseFloat(te.handling.sdf),te.handling.dcd=parseFloat(te.handling.dcd||0),Ps.setVolume(te.volume.music),document.body.setAttribute("data-graphics",te.video.graphics),Fn&&te.video.background!==pe&&(Fn.alpha=te.video.background,pe=te.video.background),re=[],(te.video.background_url||"").split(",").forEach((e=>{re.push(e.trim())})),Nn&&(Nn.alpha=Math.min(1,10*te.video.background)),document.body.classList.toggle("noingamechat",!!te.video.nochat),document.body.classList.toggle("hideroomids",!!te.video.hideroomids),e("multi_join").type=te.video.hideroomids?"password":"text",document.body.classList.toggle("invert",!!te.video.invert),document.body.classList.toggle("nobg",!!te.video.nobg),document.body.classList.toggle("chatbg",!!te.video.chatbg),document.body.classList.toggle("replaytoolsnocollapse",!!te.video.replaytoolsnocollapse),document.body.classList.toggle("hidenetwork",!!te.video.hidenetwork),document.body.classList.toggle("hidefocuswarning",!1===te.video.focuswarning),document.body.classList.toggle("ceriad_blocked",!!window.IS_ELECTRON&&!!te.electron.adblock),document.body.classList.toggle("ceriad_disabled",document.body.classList.contains("ceriad_blocked")||document.body.classList.contains("ceriad_exempt")||document.body.classList.contains("ceriad_unavailable")),e("sys_guide").classList.toggle("hidden",!1===te.video.guide),e("room_opts_welcome").classList.toggle("hidden",!1===te.video.guide),to(),eo(),window.IS_ELECTRON&&window.IPC.send("anglecompat",!!te.electron.anglecompat),ge()}function me(e){return e.code?e.code.toUpperCase():!!e.key&&(" "===e.key?"SPACE":3===e.location?`NUMPAD${e.key.toUpperCase()}`:e.key.toUpperCase())}function ge(){fe(!1,!0);for(const e of document.getElementsByClassName("controls_keybinds_style"))e.classList.remove("pressed");e(`controls_keybinds_style_${te.controls.style}`).classList.add("pressed");for(const e of document.getElementsByClassName("controls_keybinds_list"))e.classList.add("hidden");e(`controls_keybinds_list_${te.controls.style}`).classList.remove("hidden");for(const e of document.getElementsByClassName("keybind_custom")){const t=te.controls.custom[e.getAttribute("data-key")],s=t&&t.length&&t[parseInt(e.getAttribute("data-id"))]||"[NOT SET]";e.textContent=s,e.setAttribute("data-value",s)}for(const e of document.getElementsByClassName("keybind_custom")){const t=e.getAttribute("data-value"),a=e.getAttribute("data-scope");"[NOT SET]"!==t&&s(`.keybind_custom${"global"!==a?`[data-scope="${a}"]`:""}[data-value="${t.replace(/"/g,"&quot;")}"]`).length>=2||"[NOT SET]"!==t&&"global"!==a&&s(`.keybind_custom[data-scope="global"][data-value="${t.replace(/"/g,"&quot;")}"]`).length>=1?e.classList.add("keybind_warning"):e.classList.remove("keybind_warning")}for(const e of document.getElementsByClassName("guide_keybind")){const t=ae[e.getAttribute("data-key")].filter((e=>!!e));e.textContent=t&&t.length?t.join(", "):"[NOT SET]"}e("controls_sensitivity").value=te.controls.sensitivity||.5,e("controls_sensitivity_field").value=100-Math.round(100*(te.controls.sensitivity||.5)),e("controls_vibration").value=te.controls.vibration||1,e("controls_vibration_field").value=0==te.controls.vibration?"OFF":Math.round(100*(te.controls.vibration||1)),e("handling_arr").value=te.handling.arr,e("handling_arr_field").value=te.handling.arr,e("handling_arr_field_ms").value=`${Math.round(te.handling.arr*(1e3/60))}MS`,e("handling_das").value=te.handling.das,e("handling_das_field").value=te.handling.das,e("handling_das_field_ms").value=`${Math.round(te.handling.das*(1e3/60))}MS`,e("handling_dcd").value=te.handling.dcd||0,e("handling_dcd_field").value=te.handling.dcd||0,e("handling_dcd_field_ms").value=`${Math.round((te.handling.dcd||0)*(1e3/60))}MS`,e("handling_sdf").value=te.handling.sdf,e("handling_sdf_field").value=41==te.handling.sdf?"":te.handling.sdf,e("handling_safelock").classList.toggle("checked",!1!==te.handling.safelock),e("handling_cancel").classList.toggle("checked",!!te.handling.cancel),e("volume_music").value=te.volume.music,e("volume_music_field").value=0==te.volume.music?"MUTE":Math.round(100*te.volume.music),e("volume_overlay_mus_value").style.backgroundImage=`linear-gradient(to top, #FFF 0%, #FFF ${Math.round(100*te.volume.music)}%, #FFF2 ${Math.round(100*te.volume.music)}%, #FFF2 100%)`,e("volume_sfx").value=te.volume.sfx,e("volume_sfx_field").value=0==te.volume.sfx?"MUTE":Math.round(100*te.volume.sfx),e("volume_overlay_sfx_value").style.backgroundImage=`linear-gradient(to top, #FFF 0%, #FFF ${Math.round(100*te.volume.sfx)}%, #FFF2 ${Math.round(100*te.volume.sfx)}%, #FFF2 100%)`,e("volume_stereo").value=te.volume.stereo,e("volume_stereo_field").value=0==te.volume.stereo?"OFF":Math.round(100*te.volume.stereo),e("volume_disable").classList.toggle("checked",!!te.volume.disable),e("volume_next").classList.toggle("checked",te.volume.next),e("volume_others").classList.toggle("checked",te.volume.others),e("volume_scrollable").classList.toggle("checked",!1!==te.volume.scrollable),e("volume_attacks").classList.toggle("checked",!1!==te.volume.attacks),e("volume_noreset").classList.toggle("checked",!1!==te.volume.noreset),e("volume_oof").classList.toggle("checked",!1!==te.volume.oof);for(const e of document.getElementsByClassName("video_graphics"))e.classList.remove("pressed");e(`video_graphics_${te.video.graphics}`).classList.add("pressed");for(const e of document.getElementsByClassName("video_caching"))e.classList.remove("pressed");e(`video_caching_${te.video.caching||"medium"}`).classList.add("pressed");for(const e of document.getElementsByClassName("video_actiontext"))e.classList.remove("pressed");e(`video_actiontext_${te.video.actiontext||"all"}`).classList.add("pressed");for(const e of document.getElementsByClassName("video_webgl"))e.classList.remove("pressed");e(`video_webgl_${te.video.webgl||"webgl2"}`).classList.add("pressed"),e("video_particles").value=te.video.particles||.6,e("video_particles_field").value=Math.round(100*(te.video.particles||.6)),e("video_background").value=te.video.background,e("video_background_field").value=Math.round(100*te.video.background),e("video_bounciness").value=te.video.bounciness,e("video_bounciness_field").value=Math.round(100*te.video.bounciness),e("video_shakiness").value=te.video.shakiness,e("video_shakiness_field").value=Math.round(100*te.video.shakiness),e("video_gridopacity").value=void 0===te.video.gridopacity?.1:te.video.gridopacity,e("video_gridopacity_field").value=Math.round(100*(void 0===te.video.gridopacity?.1:te.video.gridopacity)),e("video_boardopacity").value=void 0===te.video.boardopacity?.85:te.video.boardopacity,e("video_boardopacity_field").value=Math.round(100*(void 0===te.video.boardopacity?.85:te.video.boardopacity)),e("video_shadowopacity").value=void 0===te.video.shadowopacity?.15:te.video.shadowopacity,e("video_shadowopacity_field").value=Math.round(100*(void 0===te.video.shadowopacity?.15:te.video.shadowopacity)),e("video_zoom").value=void 0===te.video.zoom?1:te.video.zoom,e("video_zoom_field").value=Math.round(100*(void 0===te.video.zoom?1:te.video.zoom)),e("video_bloom").value=void 0===te.video.bloom?1:te.video.bloom,e("video_bloom_field").value=0==te.video.bloom?"OFF":Math.round(100*(void 0===te.video.bloom?1:te.video.bloom)),e("video_chroma").value=void 0===te.video.chroma?.5:te.video.chroma,e("video_chroma_field").value=0==te.video.chroma?"OFF":Math.round(100*(void 0===te.video.chroma?.5:te.video.chroma)),e("video_flashwave").value=void 0===te.video.flashwave?1:te.video.flashwave,e("video_flashwave_field").value=0==te.video.flashwave?"OFF":Math.round(100*(void 0===te.video.flashwave?1:te.video.flashwave)),e("video_powersave").classList.toggle("checked",!!te.video.powersave),e("video_alwaystiny").classList.toggle("checked",!!te.video.alwaystiny),e("video_nosuperlobbyanim").classList.toggle("checked",!!te.video.nosuperlobbyanim),e("video_colorshadow").classList.toggle("checked",!!te.video.colorshadow),e("video_sidebyside").classList.toggle("checked",!!te.video.sidebyside),e("video_spin").classList.toggle("checked",!!te.video.spin),e("video_chatfilter").classList.toggle("checked",!1!==te.video.chatfilter),e("video_nochat").classList.toggle("checked",!!te.video.nochat),e("video_hideroomids").classList.toggle("checked",!!te.video.hideroomids),e("video_emotes").classList.toggle("checked",!1!==te.video.emotes),e("video_emotes_anim").classList.toggle("checked",!1!==te.video.emotes_anim),e("video_invert").classList.toggle("checked",!!te.video.invert),e("video_nobg").classList.toggle("checked",!!te.video.nobg),e("video_chatbg").classList.toggle("checked",!!te.video.chatbg),e("video_replaytoolsnocollapse").classList.toggle("checked",!!te.video.replaytoolsnocollapse),e("video_kos").classList.toggle("checked",!1!==te.video.kos),e("video_fire").classList.toggle("checked",!1!==te.video.fire),e("video_focuswarning").classList.toggle("checked",!1!==te.video.focuswarning),e("video_hidenetwork").classList.toggle("checked",!!te.video.hidenetwork),e("video_guide").classList.toggle("checked",!1!==te.video.guide),e("video_desktopnotifications").classList.toggle("checked",!1!==te.video.desktopnotifications),e("video_siren").classList.toggle("checked",!1!==te.video.siren),e("video_lowrescounters").classList.toggle("checked",!!te.video.lowrescounters),e("video_lowres").classList.toggle("checked",!!te.video.lowres),e("config_background_usecustom").classList.toggle("checked",te.video.background_usecustom===se),e("config_background_url").value=te.video.background_url||"",e("diyusi_strategy_1").querySelector("h1").textContent=(ae.target1[0]||"*").toLowerCase(),e("diyusi_strategy_2").querySelector("h1").textContent=(ae.target2[0]||"*").toLowerCase(),e("diyusi_strategy_3").querySelector("h1").textContent=(ae.target3[0]||"*").toLowerCase(),e("diyusi_strategy_4").querySelector("h1").textContent=(ae.target4[0]||"*").toLowerCase(),e("pro_40l").classList.toggle("checked",!!te.gameoptions.pro_40l),e("pro_40l_alert").classList.toggle("checked",!!te.gameoptions.pro_40l_alert),e("pro_40l_retry").classList.toggle("checked",!!te.gameoptions.pro_40l_retry),e("stride_40l").classList.toggle("checked",!!te.gameoptions.stride_40l),e("slot_40l_counter1").textContent=te.gameoptions.slot_40l_counter1||"---default---",e("slot_40l_counter2").textContent=te.gameoptions.slot_40l_counter2||"---default---",e("slot_40l_counter3").textContent=te.gameoptions.slot_40l_counter3||"---default---",e("slot_40l_counter4").textContent=te.gameoptions.slot_40l_counter4||"---default---",e("slot_40l_counter5").textContent=te.gameoptions.slot_40l_counter5||"---default---",e("pro_blitz").classList.toggle("checked",!!te.gameoptions.pro_blitz),e("pro_blitz_alert").classList.toggle("checked",!!te.gameoptions.pro_blitz_alert),e("pro_blitz_retry").classList.toggle("checked",!!te.gameoptions.pro_blitz_retry),e("stride_blitz").classList.toggle("checked",!!te.gameoptions.stride_blitz),e("slot_blitz_counter1").textContent=te.gameoptions.slot_blitz_counter1||"---default---",e("slot_blitz_counter2").textContent=te.gameoptions.slot_blitz_counter2||"---default---",e("slot_blitz_counter3").textContent=te.gameoptions.slot_blitz_counter3||"---default---",e("slot_blitz_counter4").textContent=te.gameoptions.slot_blitz_counter4||"---default---",e("slot_blitz_counter5").textContent=te.gameoptions.slot_blitz_counter5||"---default---";for(const e of document.getElementsByClassName("electron_loginskip"))e.classList.remove("pressed");e(`electron_loginskip_${te.electron.loginskip||"always"}`).classList.add("pressed");for(const e of document.getElementsByClassName("electron_frameratelimit"))e.classList.remove("pressed");e(`electron_frameratelimit_${te.electron.frameratelimit||"4x"}`).classList.add("pressed"),e("config_electron_presence").classList.toggle("checked",!1!==te.electron.presence),e("config_electron_taskbarflash").classList.toggle("checked",!1!==te.electron.taskbarflash),e("config_electron_anglecompat").classList.toggle("checked",!!te.electron.anglecompat),e("config_electron_adblock").classList.toggle("checked",!!te.electron.adblock),Ps.randomOstPools.random.forEach((e=>{s(`.bgmtweak_option[data-id="${e}"]`).forEach((t=>{t.classList.toggle("pressed",t.getAttribute("data-option")===((te.volume.bgmtweak||{})[e]||"base"))}))})),e("notifications_suppress").classList.toggle("checked",!1!==te.notifications.suppress),e("notifications_forcesound").classList.toggle("checked",!!te.notifications.forcesound);for(const e of document.getElementsByClassName("notifications_online"))e.classList.remove("pressed");e(`notifications_online_${te.notifications.online}`).classList.add("pressed");for(const e of document.getElementsByClassName("notifications_offline"))e.classList.remove("pressed");e(`notifications_offline_${te.notifications.offline}`).classList.add("pressed");for(const e of document.getElementsByClassName("notifications_dm"))e.classList.remove("pressed");e(`notifications_dm_${te.notifications.dm}`).classList.add("pressed");for(const e of document.getElementsByClassName("notifications_dm_pending"))e.classList.remove("pressed");e(`notifications_dm_pending_${te.notifications.dm_pending}`).classList.add("pressed");for(const e of document.getElementsByClassName("notifications_invite"))e.classList.remove("pressed");e(`notifications_invite_${te.notifications.invite}`).classList.add("pressed");for(const e of document.getElementsByClassName("notifications_other"))e.classList.remove("pressed");e(`notifications_other_${te.notifications.other}`).classList.add("pressed")}de();let he=-1;function fe(e,t,s=!1){if(!Dn)return;const a=te.video.background_usecustom===se?re:ie,n=a.join(",");if(!e&&n===le)return;if(e&&n===le&&1===a.length)return;le=n;let o=Math.floor(Math.random()*a.length);for(;o===he&&a.length>1;)o=Math.floor(Math.random()*a.length);he=o,t?Dn.setBackground(a[o],!0):(Dn.setBackground(a[o]),s||xn.play("bgtransition"))}let _e=()=>{};function be(t){e("keybind_request").classList.remove("hidden"),_e=t,document.addEventListener("keydown",ye,!1),document.addEventListener("gpdown",ye,!1),setTimeout((()=>{document.addEventListener("click",ve,!1)}),0)}function ye(t){document.removeEventListener("keydown",ye,!1),document.removeEventListener("gpdown",ye,!1),document.removeEventListener("click",ve,!1),e("keybind_request").classList.add("hidden"),_e(me(t)||t.detail.toUpperCase()),t.preventDefault()}function ve(t){document.removeEventListener("keydown",ye,!1),document.removeEventListener("gpdown",ye,!1),document.removeEventListener("click",ve,!1),e("keybind_request").classList.add("hidden"),_e("X-NOKEY"),t.preventDefault()}const we=(t,s)=>{e(t).addEventListener("click",(function(e){!1!==s(e)&&(ce(),ue())}))},ke=(t,s)=>{e(t).addEventListener("input",(function(e){!1!==s(e)&&(ce(),ue())}))};U.ready((function(t){let s="";Ps.randomOstPools.random.forEach((e=>{s+=`<div class="control_group flex-row bgmtweaking">\n\t\t\t\t\t<h1 class="bgmtweak_header rg_target_pri" data-id="${e}" data-hover="tap" data-hit="click">${Ps.ost[e].artist} - ${Ps.ost[e].name} (${Ps.ost[e].genre})</h1>\n\t\t\t\t\t<div class="control_button flex-item bgmtweak_option rg_target_pri" data-id="${e}" data-option="ban" data-hover="tap" data-hit="click" title="Never play this song.">BAN</div>\n\t\t\t\t\t<div class="control_button flex-item bgmtweak_option rg_target_pri" data-id="${e}" data-option="minmin" data-hover="tap" data-hit="click" title="Play this song far less often.">--</div>\n\t\t\t\t\t<div class="control_button flex-item bgmtweak_option rg_target_pri" data-id="${e}" data-option="min" data-hover="tap" data-hit="click" title="Play this song less often.">-</div>\n\t\t\t\t\t<div class="control_button flex-item bgmtweak_option rg_target_pri" data-id="${e}" data-option="base" data-hover="tap" data-hit="click" title="Play this song a normal amount.">=</div>\n\t\t\t\t\t<div class="control_button flex-item bgmtweak_option rg_target_pri" data-id="${e}" data-option="plus" data-hover="tap" data-hit="click" title="Play this song more often.">+</div>\n\t\t\t\t\t<div class="control_button flex-item bgmtweak_option rg_target_pri" data-id="${e}" data-option="plusplus" data-hover="tap" data-hit="click" title="Play this song far more often.">++</div>\n\t\t\t\t</div>`})),e("bgmtweak").innerHTML=s,de(),ue(),"legacy"===te.video.webgl&&x({msg:"using LEGACY WEBGL - this may slow down your game. if your device supports it, switch to WEBGL 2 in CONFIG!",color:"#FFC600",icon:"warning",timeout:1e4}),setTimeout((()=>{fe(!1,!1,!0)}),300),setTimeout((()=>{eo()}),2e3),we("finish_guide_room",(()=>{te.video.guide=!1,e("room_opts_room").click()})),we("finish_guide_sys",(()=>(e("sys_guide").classList.add("hiding"),e("room_opts_room").click(),setTimeout((()=>{te.video.guide=!1,ce(),ue()}),1e3),!1))),we("controls_keybinds_style_guideline",(()=>{te.controls.style="guideline"})),we("controls_keybinds_style_wasd",(()=>{te.controls.style="wasd"})),we("controls_keybinds_style_custom",(()=>{te.controls.style="custom"}));for(const e of document.getElementsByClassName("keybind_custom"))e.addEventListener("click",(function(t){be((t=>{te.controls.custom[e.getAttribute("data-key")][parseInt(e.getAttribute("data-id"))]="X-NOKEY"===t?"":t,ce(),ue()}))}));ke("controls_sensitivity",(()=>{te.controls.sensitivity=e("controls_sensitivity").value})),ke("controls_vibration",(()=>{te.controls.vibration=e("controls_vibration").value}));const a=()=>{ga&&ga.isConnected()&&ga.updateHandling()};ke("handling_arr",(()=>{te.handling.arr=parseFloat(e("handling_arr").value),a()})),ke("handling_das",(()=>{te.handling.das=parseFloat(e("handling_das").value),a()})),ke("handling_dcd",(()=>{te.handling.dcd=parseFloat(e("handling_dcd").value),a()})),ke("handling_sdf",(()=>{te.handling.sdf=parseFloat(e("handling_sdf").value),a()})),we("handling_safelock",(()=>{te.handling.safelock=!e("handling_safelock").classList.contains("checked"),a()})),we("handling_cancel",(()=>{te.handling.cancel=!e("handling_cancel").classList.contains("checked"),a()}));for(const e of document.getElementsByClassName("stat_field"))e.addEventListener("click",(function(t){const s=e.closest(".stat");Ge(s.querySelector(".stat_name").textContent,"enter a new value",s.querySelector(".stat_range").getAttribute("min"),s.querySelector(".stat_range").getAttribute("max"),s.querySelector(".stat_range").getAttribute("step")||"1",s.querySelector(".stat_range").value,(e=>{s.querySelector(".stat_range").value=e,s.querySelector(".stat_range").dispatchEvent(new Event("input",{bubbles:!0,cancelable:!0})),ce(),ue()}))}));we("handling_reset",(()=>{te.handling.arr=2,te.handling.das=10,te.handling.dcd=1,te.handling.sdf=6,a()})),e("handling_test").addEventListener("click",(function(e){Ut.testControls()})),ke("volume_music",(()=>{te.volume.music=e("volume_music").value})),ke("volume_sfx",(()=>{te.volume.sfx=e("volume_sfx").value})),ke("volume_stereo",(()=>{te.volume.stereo=e("volume_stereo").value})),we("volume_next",(()=>{te.volume.next=!e("volume_next").classList.contains("checked")})),we("volume_others",(()=>{te.volume.others=!e("volume_others").classList.contains("checked")})),we("volume_scrollable",(()=>{te.volume.scrollable=!e("volume_scrollable").classList.contains("checked")})),we("volume_attacks",(()=>{te.volume.attacks=!e("volume_attacks").classList.contains("checked")})),we("volume_noreset",(()=>{te.volume.noreset=!e("volume_noreset").classList.contains("checked")})),we("volume_oof",(()=>{te.volume.oof=!e("volume_oof").classList.contains("checked")})),we("volume_disable",(()=>{te.volume.disable=!e("volume_disable").classList.contains("checked")}));let n=null;window.addEventListener("wheel",(function(t){if(!1===te.volume.scrollable)return;if(!document.body.classList.contains("ingame")&&!t.altKey)return;if(t.target.closest("#ingame_chat_container")&&!t.altKey)return;if(t.target.closest("#zen_panel_content")&&!t.altKey)return;const s=Math.sign(-t.deltaY);if(t.target.closest("#volume_overlay_sfx"))te.volume.sfx=Math.max(0,Math.min(1,te.volume.sfx+.05*s));else if(t.target.closest("#volume_overlay_mus"))te.volume.music=Math.max(0,Math.min(1,te.volume.music+.05*s));else{let e=te.volume.sfx*(.25*s);e=1===s?Math.max(.05,e):Math.min(-.05,e),te.volume.sfx=Math.max(0,Math.min(1,parseFloat(te.volume.sfx)+e));let t=te.volume.music*(.25*s);t=1===s?Math.max(.05,t):Math.min(-.05,t),te.volume.music=Math.max(0,Math.min(1,parseFloat(te.volume.music)+t))}e("volume_overlay").classList.remove("hidden"),e("volume_overlay").classList.remove("hiding"),setTimeout((()=>{e("volume_overlay").classList.add("hiding")}),100),n&&clearTimeout(n),n=setTimeout((()=>{e("volume_overlay").classList.add("hidden")}),5100),ce(),ue(),t.altKey&&t.preventDefault()}),{passive:!1}),we("video_graphics_minimal",(()=>{te.video.graphics="minimal",te.video.lowres=!0,te.video.sidebyside=!1,Pn.unset(),x({msg:"changing GRAPHICS LEVEL requires a restart to fully go in effect. hit F5 on your keyboard to restart.",color:"#FFC600",icon:"warning"}),e("dirtyflag_gfx").innerHTML=`DIRTY (${te.video.graphics})`})),we("video_graphics_low",(()=>{"minimal"===te.video.graphics&&(te.video.lowres=!1,te.video.sidebyside=!0),te.video.graphics="low",Pn.unset(),x({msg:"changing GRAPHICS LEVEL requires a restart to fully go in effect. hit F5 on your keyboard to restart.",color:"#FFC600",icon:"warning"}),e("dirtyflag_gfx").innerHTML=`DIRTY (${te.video.graphics})`})),we("video_graphics_medium",(()=>{"minimal"===te.video.graphics&&(te.video.lowres=!1,te.video.sidebyside=!0),te.video.graphics="medium",Pn.unset(),x({msg:"changing GRAPHICS LEVEL requires a restart to fully go in effect. hit F5 on your keyboard to restart.",color:"#FFC600",icon:"warning"}),e("dirtyflag_gfx").innerHTML=`DIRTY (${te.video.graphics})`})),we("video_graphics_high",(()=>{"minimal"===te.video.graphics&&(te.video.lowres=!1,te.video.sidebyside=!0),te.video.graphics="high",Pn.set(),x({msg:"changing GRAPHICS LEVEL requires a restart to fully go in effect. hit F5 on your keyboard to restart.",color:"#FFC600",icon:"warning"}),e("dirtyflag_gfx").innerHTML=`DIRTY (${te.video.graphics})`})),we("video_graphics_ultra",(()=>{"minimal"===te.video.graphics&&(te.video.lowres=!1,te.video.sidebyside=!0),te.video.graphics="ultra",Pn.set(),x({msg:"changing GRAPHICS LEVEL requires a restart to fully go in effect. hit F5 on your keyboard to restart.",color:"#FFC600",icon:"warning"}),window.IS_ELECTRON||x({msg:"you are not using TETR.IO DESKTOP - ULTRA graphics may be less performant.",color:"#FFC600",icon:"warning"}),e("dirtyflag_gfx").innerHTML=`DIRTY (${te.video.graphics})`})),we("video_caching_low",(()=>{te.video.caching="low",x({msg:"changing CACHING LEVEL requires a restart to fully go in effect. hit F5 on your keyboard to restart.",color:"#FFC600",icon:"warning"}),e("dirtyflag_gfx").innerHTML=`DIRTY (${te.video.graphics})`})),we("video_caching_medium",(()=>{te.video.caching="medium",x({msg:"changing CACHING LEVEL requires a restart to fully go in effect. hit F5 on your keyboard to restart.",color:"#FFC600",icon:"warning"}),e("dirtyflag_gfx").innerHTML=`DIRTY (${te.video.graphics})`})),we("video_caching_high",(()=>{te.video.caching="high",x({msg:"changing CACHING LEVEL requires a restart to fully go in effect. hit F5 on your keyboard to restart.",color:"#FFC600",icon:"warning"}),e("dirtyflag_gfx").innerHTML=`DIRTY (${te.video.graphics})`})),we("video_webgl_legacy",(()=>(D({title:"USE LEGACY WEBGL?",msg:'LEGACY WEBGL is the slowest WEBGL mode and may introduce bugs. only use it if the other modes do not work for you (for example, you see graphical glitches or flickering while playing)!</p><p class="modal_also">when reporting a bug, please mention LEGACY WEBGL is enabled.',buttons:[{label:"CANCEL",classes:[],callback:e=>{e()}},{label:"USE LEGACY WEBGL",classes:["sec"],callback:t=>{te.video.webgl="legacy",ce(),ue(),x({msg:"changing WEBGL MODE requires a restart to fully go in effect. hit F5 on your keyboard to restart.",color:"#FFC600",icon:"warning"}),e("dirtyflag_gl").innerHTML=`DIRTY (${te.video.webgl})`,t()}}]}),!1))),we("video_webgl_webgl1",(()=>{te.video.webgl="webgl1",x({msg:"changing WEBGL MODE requires a restart to fully go in effect. hit F5 on your keyboard to restart.",color:"#FFC600",icon:"warning"}),e("dirtyflag_gl").innerHTML=`DIRTY (${te.video.webgl})`})),we("video_webgl_webgl2",(()=>{te.video.webgl="webgl2",x({msg:"changing WEBGL MODE requires a restart to fully go in effect. hit F5 on your keyboard to restart.",color:"#FFC600",icon:"warning"}),e("dirtyflag_gl").innerHTML=`DIRTY (${te.video.webgl})`})),we("video_actiontext_off",(()=>{te.video.actiontext="off"})),we("video_actiontext_some",(()=>{te.video.actiontext="some"})),we("video_actiontext_all",(()=>{te.video.actiontext="all"})),ke("video_particles",(()=>{te.video.particles=e("video_particles").value})),ke("video_background",(()=>{te.video.background=e("video_background").value})),ke("video_bounciness",(()=>{te.video.bounciness=e("video_bounciness").value})),ke("video_shakiness",(()=>{te.video.shakiness=e("video_shakiness").value})),ke("video_gridopacity",(()=>{te.video.gridopacity=e("video_gridopacity").value})),ke("video_boardopacity",(()=>{te.video.boardopacity=e("video_boardopacity").value})),ke("video_shadowopacity",(()=>{te.video.shadowopacity=e("video_shadowopacity").value})),ke("video_zoom",(()=>{te.video.zoom=e("video_zoom").value,ys(!0)})),ke("video_bloom",(()=>{te.video.bloom=e("video_bloom").value})),ke("video_chroma",(()=>{te.video.chroma=e("video_chroma").value})),ke("video_flashwave",(()=>{te.video.flashwave=e("video_flashwave").value})),we("video_powersave",(()=>{te.video.powersave=!e("video_powersave").classList.contains("checked"),x({msg:"changing POWER SAVE requires a restart to go in effect. hit F5 on your keyboard to restart.",color:"#FFC600",icon:"warning"}),e("dirtyflag_gfx").innerHTML=`DIRTY (${te.video.graphics})`})),we("video_lowres",(()=>{te.video.lowres=!e("video_lowres").classList.contains("checked"),x({msg:"changing LOW RESOLUTION MODE requires a restart to go in effect. hit F5 on your keyboard to restart.",color:"#FFC600",icon:"warning"}),e("dirtyflag_gfx").innerHTML=`DIRTY (${te.video.graphics})`})),we("video_guide",(()=>{te.video.guide=!e("video_guide").classList.contains("checked"),te.video.guide?e("room_opts_welcome").click():e("room_opts_room").click()})),we("video_desktopnotifications",(()=>{te.video.desktopnotifications=!e("video_desktopnotifications").classList.contains("checked"),te.video.desktopnotifications&&Pt(!0)})),we("video_lowrescounters",(()=>{te.video.lowrescounters=!e("video_lowrescounters").classList.contains("checked")})),we("video_alwaystiny",(()=>{te.video.alwaystiny=!e("video_alwaystiny").classList.contains("checked")})),we("video_nosuperlobbyanim",(()=>{te.video.nosuperlobbyanim=!e("video_nosuperlobbyanim").classList.contains("checked")})),we("video_colorshadow",(()=>{te.video.colorshadow=!e("video_colorshadow").classList.contains("checked")})),we("video_sidebyside",(()=>{te.video.sidebyside=!e("video_sidebyside").classList.contains("checked")})),we("video_spin",(()=>{te.video.spin=!e("video_spin").classList.contains("checked")})),we("video_chatfilter",(()=>{te.video.chatfilter=!e("video_chatfilter").classList.contains("checked")})),we("video_nochat",(()=>{te.video.nochat=!e("video_nochat").classList.contains("checked")})),we("video_hideroomids",(()=>{te.video.hideroomids=!e("video_hideroomids").classList.contains("checked")})),we("video_emotes",(()=>{te.video.emotes=!e("video_emotes").classList.contains("checked")})),we("video_emotes_anim",(()=>{te.video.emotes_anim=!e("video_emotes_anim").classList.contains("checked")})),we("video_invert",(()=>{te.video.invert=!e("video_invert").classList.contains("checked")})),we("video_nobg",(()=>{te.video.nobg=!e("video_nobg").classList.contains("checked")})),we("video_chatbg",(()=>{te.video.chatbg=!e("video_chatbg").classList.contains("checked")})),we("video_replaytoolsnocollapse",(()=>{te.video.replaytoolsnocollapse=!e("video_replaytoolsnocollapse").classList.contains("checked")})),we("video_kos",(()=>{te.video.kos=!e("video_kos").classList.contains("checked")})),we("video_fire",(()=>{te.video.fire=!e("video_fire").classList.contains("checked")})),we("video_focuswarning",(()=>{te.video.focuswarning=!e("video_focuswarning").classList.contains("checked")})),we("video_hidenetwork",(()=>{te.video.hidenetwork=!e("video_hidenetwork").classList.contains("checked")})),we("video_siren",(()=>{te.video.siren=!e("video_siren").classList.contains("checked")})),e("config_background_url").addEventListener("keyup",(function(t){te.video.background_url=e("config_background_url").value,ce(),ue()})),we("config_background_usecustom",(()=>{te.video.background_usecustom=e("config_background_usecustom").classList.contains("checked")?null:se})),we("pro_40l",(()=>{te.gameoptions.pro_40l=!e("pro_40l").classList.contains("checked")})),we("pro_40l_alert",(()=>{te.gameoptions.pro_40l_alert=!e("pro_40l_alert").classList.contains("checked")})),we("pro_40l_retry",(()=>{te.gameoptions.pro_40l_retry=!e("pro_40l_retry").classList.contains("checked")})),we("stride_40l",(()=>{te.gameoptions.stride_40l=!e("stride_40l").classList.contains("checked")})),ke("slot_40l_counter1",(()=>{te.gameoptions.slot_40l_counter1="---default---"===e("slot_40l_counter1").innerHTML?void 0:e("slot_40l_counter1").innerHTML})),ke("slot_40l_counter2",(()=>{te.gameoptions.slot_40l_counter2="---default---"===e("slot_40l_counter2").innerHTML?void 0:e("slot_40l_counter2").innerHTML})),ke("slot_40l_counter3",(()=>{te.gameoptions.slot_40l_counter3="---default---"===e("slot_40l_counter3").innerHTML?void 0:e("slot_40l_counter3").innerHTML})),ke("slot_40l_counter4",(()=>{te.gameoptions.slot_40l_counter4="---default---"===e("slot_40l_counter4").innerHTML?void 0:e("slot_40l_counter4").innerHTML})),ke("slot_40l_counter5",(()=>{te.gameoptions.slot_40l_counter5="---default---"===e("slot_40l_counter5").innerHTML?void 0:e("slot_40l_counter5").innerHTML})),we("pro_blitz",(()=>{te.gameoptions.pro_blitz=!e("pro_blitz").classList.contains("checked")})),we("pro_blitz_alert",(()=>{te.gameoptions.pro_blitz_alert=!e("pro_blitz_alert").classList.contains("checked")})),we("pro_blitz_retry",(()=>{te.gameoptions.pro_blitz_retry=!e("pro_blitz_retry").classList.contains("checked")})),we("stride_blitz",(()=>{te.gameoptions.stride_blitz=!e("stride_blitz").classList.contains("checked")})),ke("slot_blitz_counter1",(()=>{te.gameoptions.slot_blitz_counter1="---default---"===e("slot_blitz_counter1").innerHTML?void 0:e("slot_blitz_counter1").innerHTML})),ke("slot_blitz_counter2",(()=>{te.gameoptions.slot_blitz_counter2="---default---"===e("slot_blitz_counter2").innerHTML?void 0:e("slot_blitz_counter2").innerHTML})),ke("slot_blitz_counter3",(()=>{te.gameoptions.slot_blitz_counter3="---default---"===e("slot_blitz_counter3").innerHTML?void 0:e("slot_blitz_counter3").innerHTML})),ke("slot_blitz_counter4",(()=>{te.gameoptions.slot_blitz_counter4="---default---"===e("slot_blitz_counter4").innerHTML?void 0:e("slot_blitz_counter4").innerHTML})),ke("slot_blitz_counter5",(()=>{te.gameoptions.slot_blitz_counter5="---default---"===e("slot_blitz_counter5").innerHTML?void 0:e("slot_blitz_counter5").innerHTML})),we("electron_loginskip_never",(()=>{te.electron.loginskip="never"})),we("electron_loginskip_quickjoin",(()=>{te.electron.loginskip="quickjoin"})),we("electron_loginskip_always",(()=>{te.electron.loginskip="always"})),we("electron_frameratelimit_1x",(()=>{te.electron.frameratelimit="1x"})),we("electron_frameratelimit_2x",(()=>{te.electron.frameratelimit="2x"})),we("electron_frameratelimit_4x",(()=>{te.electron.frameratelimit="4x"})),we("electron_frameratelimit_off",(()=>{te.electron.frameratelimit="off"})),we("config_electron_presence",(()=>{te.electron.presence=!e("config_electron_presence").classList.contains("checked")})),we("config_electron_taskbarflash",(()=>{te.electron.taskbarflash=!e("config_electron_taskbarflash").classList.contains("checked")})),we("config_electron_anglecompat",(()=>{te.electron.anglecompat=!e("config_electron_anglecompat").classList.contains("checked"),x({msg:"changing STREAMER COMPATIBILITY MODE requires a full restart to go in effect. close TETR.IO, then reopen it.",color:"#FFC600",icon:"warning"}),e("dirtyflag_client").innerHTML="DIRTY"})),we("config_electron_vsync",(()=>{window.IPC.send("vsync",!e("config_electron_vsync").classList.contains("checked")),x({msg:"changing HARD VSYNC MODE requires a full restart to go in effect. close TETR.IO, then reopen it.",color:"#FFC600",icon:"warning"}),e("dirtyflag_client").innerHTML="DIRTY",e("config_electron_vsync").classList.toggle("checked"),e("config_electron_frameratelimit").classList.toggle("disable-cfg")})),we("config_electron_adblock",(()=>{te.electron.adblock=!e("config_electron_adblock").classList.contains("checked"),te.electron.adblock&&(ct("one moment"),w.get("/api/tetra/specialthanks").then((e=>{dt();let t="";e.supporters.forEach((e=>{t+=`<a class="adblock_st ${e.username?`tetra_pop" data-hover="tap" data-hit="click" data-username="${e.username}"`:'noclick"'}>${e.flip?e.username.toUpperCase():e.name}</a>, `})),D({title:"3RD PARTY ADS DISABLED",msg:`this toggle made possible by these generous supporters:</p><p>${t.slice(0,-2)}</p><p>please, consider supporting the sole developer behind TETR.IO!`,classes:["supporter_modal"],buttons:[{label:"NO",classes:[],callback:e=>{try{_paq.push(["trackEvent","Advertising","Block","Config toggle (no conversion)"])}catch(e){}e()}},{label:"SUPPORT!",classes:["pri"],callback:e=>{try{_paq.push(["trackEvent","Advertising","Block","Config toggle (converted)"])}catch(e){}e(),Ke()}}]})}),(e=>{try{_paq.push(["trackEvent","Advertising","Block","Config toggle (could not load dialog)"])}catch(e){}dt()})))}));for(const e of document.getElementsByClassName("bgmtweak_option"))e.addEventListener("click",(function(t){void 0===te.volume.bgmtweak&&(te.volume.bgmtweak={}),te.volume.bgmtweak[e.getAttribute("data-id")]=e.getAttribute("data-option"),ce(),ue()}));for(const e of document.getElementsByClassName("bgmtweak_header"))e.addEventListener("click",(function(t){Ps.playSmoothOrRandom(e.getAttribute("data-id"))}));we("notifications_suppress",(()=>{te.notifications.suppress=!e("notifications_suppress").classList.contains("checked")})),we("notifications_forcesound",(()=>{te.notifications.forcesound=!e("notifications_forcesound").classList.contains("checked")})),we("notifications_online_off",(()=>{te.notifications.online="off"})),we("notifications_online_ingame",(()=>{te.notifications.online="ingame"})),we("notifications_online_both",(()=>{te.notifications.online="both"})),we("notifications_offline_off",(()=>{te.notifications.offline="off"})),we("notifications_offline_ingame",(()=>{te.notifications.offline="ingame"})),we("notifications_offline_both",(()=>{te.notifications.offline="both"})),we("notifications_dm_off",(()=>{te.notifications.dm="off"})),we("notifications_dm_ingame",(()=>{te.notifications.dm="ingame"})),we("notifications_dm_both",(()=>{te.notifications.dm="both"})),we("notifications_dm_pending_off",(()=>{te.notifications.dm_pending="off"})),we("notifications_dm_pending_ingame",(()=>{te.notifications.dm_pending="ingame"})),we("notifications_dm_pending_both",(()=>{te.notifications.dm_pending="both"})),we("notifications_invite_ingame",(()=>{te.notifications.invite="ingame"})),we("notifications_invite_both",(()=>{te.notifications.invite="both"})),we("notifications_other_ingame",(()=>{te.notifications.other="ingame"})),we("notifications_other_both",(()=>{te.notifications.other="both"}))}));const Le=(()=>{let e=null,t=[];return g((()=>{!async function(){let s="No-GPU";const a=document.createElement("canvas").getContext("webgl");if(a){const e=a.getExtension("WEBGL_debug_renderer_info");e&&(s=a.getParameter(e.UNMASKED_RENDERER_WEBGL))}let n=navigator.hardwareConcurrency||0,o=navigator.deviceMemory||0,i=navigator.userAgent.replace("//","--")||"No-UA";const r=await FingerprintJS.load();let l=(await r.get()).visitorId,c=localStorage.getItem("debugIdentity");c||(c=`${Date.now()}-${Math.floor(1e9*Math.random())}`.replace("//","--"),localStorage.setItem("debugIdentity",c)),c=c.replace("//","--");let d=`${window.screen.availWidth}x${window.screen.availHeight}@${window.devicePixelRatio||1}`,p={};switch(te.controls.style){case"guideline":Object.assign(p,ne);break;case"wasd":Object.assign(p,oe);break;case"custom":Object.assign(p,te.controls.custom)}let u=`${p.moveLeft[0]||"?"}, ${p.moveRight[0]||"?"}, ${p.softDrop[0]||"?"}, ${p.hardDrop[0]||"?"}, ${p.rotateCCW[0]||"?"}, ${p.rotateCW[0]||"?"}, ${p.rotate180[0]||"?"}, ${p.hold[0]||"?"}`.replace("//","--"),m=`${te.handling.arr}F ARR, ${te.handling.das}F DAS, ${te.handling.sdf}X SDF`,g=window.BASEBOARD||"N/A";e="xHW-"+btoa(`${i} // ${n}-core // ${o}-GB // ${s} // ${l} // ${c} // ${d} // ${u} // ${m} // ${g}`),t.forEach((t=>{t(e)}))}()})),{get:()=>e,getWhenReady:s=>{e?s(e):t.push(s)}}})(),Ee="\n---default---,DEFAULT,use the default option;\n---empty---,EMPTY,leave this slot empty;\nscore,SCORE,display the score in this slot;\nspp,SCORE (per piece),display the score and score per piece in this slot;\nstopwatch,STOPWATCH,display the time passed in this slot;\nlines,LINES,display the amount of cleared lines in this slot;\npieces,PIECES,display the amount of placed pieces and speed in this slot;\nkeys,INPUTS,display the amount of buttonpresses in this slot;\nfinesse,FINESSE,display your finesse in this slot;\nfinesse_l,FINESSE (SMALLER),display your finesse in this slot (for use on the left-hand side);\nhold,HOLD,display the amount of held pieces in this slot;\nallclears,ALL CLEARS,display the amount of ALL CLEARS in this slot\n".replace(/\n/g,""),xe="\n---default---,DEFAULT,use the default option;\n---empty---,EMPTY,leave this slot empty;\nscore,SCORE,display the score in this slot;\nspp,SCORE (per piece),display the score and score per piece in this slot;\ntimer,TIMER,display the time remaining in this slot;\nlines,LINES,display the amount of cleared lines in this slot;\nlevel,LEVEL,display the current level in this slot;\npieces,PIECES,display the amount of placed pieces and speed in this slot;\nkeys,INPUTS,display the amount of buttonpresses in this slot;\nfinesse,FINESSE,display your finesse in this slot;\nfinesse_l,FINESSE (SMALLER),display your finesse in this slot (for use on the left-hand side);\nhold,HOLD,display the amount of held pieces in this slot;\nallclears,ALL CLEARS,display the amount of ALL CLEARS in this slot\n".replace(/\n/g,"");U.ready((function(t){e("slot_40l_counter1").setAttribute("data-items",Ee),e("slot_40l_counter2").setAttribute("data-items",Ee),e("slot_40l_counter3").setAttribute("data-items",Ee),e("slot_40l_counter4").setAttribute("data-items",Ee),e("slot_40l_counter5").setAttribute("data-items",Ee),e("slot_blitz_counter1").setAttribute("data-items",xe),e("slot_blitz_counter2").setAttribute("data-items",xe),e("slot_blitz_counter3").setAttribute("data-items",xe),e("slot_blitz_counter4").setAttribute("data-items",xe),e("slot_blitz_counter5").setAttribute("data-items",xe)}));const Te="\n---empty---,EMPTY,leave this slot empty;\nscore,SCORE,display the score in this slot;\nspp,SCORE (per piece),display the score and score per piece in this slot;\nstopwatch,STOPWATCH,display the time passed in this slot;\ntimer,TIMER,display the time remaining in this slot (for TIMED objective);\nlines,LINES,display the amount of cleared lines in this slot;\nlevel,LEVEL,display the current level in this slot;\npieces,PIECES,display the amount of placed pieces and speed in this slot;\nkeys,INPUTS,display the amount of buttonpresses in this slot;\nhold,HOLD,display the amount of held pieces in this slot;\nallclears,ALL CLEARS,display the amount of ALL CLEARS in this slot\n".replace(/\n/g,""),Ie=[{id:"room_content_room",classes:"hidden",blocks:[{title:"GENERAL",options:[{id:"meta.name",label:"room name",title:"Name this room will display in the listing as",type:"text",classes:"imp",attributes:'maxlength="64" minlength="1"'},{id:"meta.userlimit",label:"player limit",title:"Maximum players in this room. 0 = no limit. Does not apply retroactively.",type:"number",classes:"",attributes:'max="999" min="0"'},{id:"meta.allowAnonymous",label:"allow anonymous users to join",title:"Whether to allow anonymous users to enter this room. Does not apply retroactively.",type:"checkbox",classes:"",attributes:""},{id:"meta.bgm",label:"music",title:"Background song to play. If random, not everyone will hear the same song.",type:"music",classes:"imp",attributes:""}]}]},{id:"room_content_match",classes:"hidden",blocks:[{title:"GENERAL",options:[{id:"meta.match.type",label:"game mode",title:"Game mode.",type:"spinner",classes:"super-imp",attributes:'data-items="versus,VERSUS,a battle royale! who can survive the longest?"'},{id:"meta.match.ft",label:"first to (FT)",title:"Amount of rounds one must win to win the game.",type:"number",classes:"imp",attributes:'max="1000" min="1"'},{id:"meta.match.wb",label:"win by (WB)",title:"Amount of points one must have over the second place to secure the win.",type:"number",classes:"imp",attributes:'max="1000" min="1"'},{id:"game.options.stock",label:"stock",title:"Amount of extra lives one has.",type:"number",classes:"",attributes:'max="10" min="0"'}]}]},{id:"room_content_game",classes:"hidden",blocks:[{title:"GENERAL",options:[{id:"game.options.bagtype",label:"random bag type",title:"The type of system used to generate random pieces.",type:"spinner",classes:"imp",attributes:'data-items="7-bag,7-BAG,keep shuffling a bag of the 7 tetrominoes;14-bag,14-BAG,keep shuffling a bag of 2x the 7 tetrominoes;classic,CLASSIC,random with repetition protection;pairs,PAIRS,alternate between 2 tetrominoes;total mayhem,TOTAL MAYHEM,completely random generation"'},{id:"game.options.spinbonuses",label:"allowed spins",title:"The type of pieces allowed to do spins.",type:"spinner",classes:"imp",attributes:'data-items="T-spins,T-SPINS,receive bonuses for spinning T-pieces;all,ALL-SPIN,receive bonuses for spinning all pieces;stupid,STUPID,everything is a spin because YEAH WHY NOT (O-spin SUPPORTED!);none,NONE,receive no spin bonuses"'},{id:"game.options.allow180",label:"allow 180 spins",title:"Whether to allow the 180 rotation key to be used.",type:"checkbox",classes:"imp",attributes:""},{id:"game.options.kickset",label:"kick table",title:"The type of kicks that pieces can do.",type:"spinner",classes:"",attributes:'data-items="SRS+,SRS+,the default natural rotation system with symmetric I-piece rotation;SRS,SRS,the standard natural rotation system;SRS-X,SRS-X,SRS with more powerful 180 spins;TETRA-X,TETRA-X,novel rotation system by DR OCELOT;NRS,NRS,the classic rotation system;ARS,ARS,rotation system used in arcade games;ASC,ASC,permissive rotation system by WINTERNEBS;none,NONE,no kicks possible"'},{id:"game.options.allow_harddrop",label:"use hard drop",title:"Whether to allow use of the Hard Drop button.",type:"checkbox",classes:"",attributes:""},{id:"game.options.display_next",label:"use NEXT queue",title:"Whether to show the NEXT queue.",type:"checkbox",classes:"",attributes:""},{id:"game.options.display_hold",label:"use HOLD queue",title:"Whether to use the HOLD queue.",type:"checkbox",classes:"",attributes:""},{id:"game.options.nextcount",label:"next pieces",title:"Amount of pieces shown in the NEXT queue, if said queue is enabled.",type:"number",classes:"",attributes:'min="1" max="5"'},{id:"game.options.display_shadow",label:"show shadow piece",title:"Whether to show the shadow piece.",type:"checkbox",classes:"",attributes:""},{id:"game.options.are",label:"ARE",title:"Amount of time in frames in between a piece being placed and the next one spawning.",type:"number",classes:"",attributes:'min="0" max="300"'},{id:"game.options.lineclear_are",label:"line clear ARE",title:"Amount of time in frames in between a piece being placed and the next one spawning, if a line was cleared.",type:"number",classes:"",attributes:'min="0" max="300"'},{id:"game.options.room_handling",label:"enforce below handling settings",title:"Whether to enforce the handling settings below.",type:"checkbox",classes:"",attributes:""},{id:"game.options.room_handling_arr",label:"enforced ARR",title:'Auto Repeat Rate, enforced if "enforce below handling settings" is enabled.',type:"number",classes:"",attributes:'min="0" max="5" step="0.1"'},{id:"game.options.room_handling_das",label:"enforced DAS",title:'Delayed Auto Shift, enforced if "enforce below handling settings" is enabled.',type:"number",classes:"",attributes:'min="1" max="20" step="0.1"'},{id:"game.options.room_handling_sdf",label:"enforced SDF",title:'Soft Drop Factor, enforced if "enforce below handling settings" is enabled. Use 21 for MAX.',type:"number",classes:"",attributes:'min="5" max="21"'}]},{title:"GRAVITY & MARGIN TIME",options:[{id:"game.options.g",label:"gravity",title:"Starting gravity (how fast blocks drop). Higher is faster.",type:"number",classes:"",attributes:'max="20" min="0" step="0.01"'},{id:"game.options.gincrease",label:"gravity increase",title:"The amount of gravity increase per second.",type:"number",classes:"",attributes:'max="1" min="0" step="0.0001"'},{id:"game.options.gmargin",label:"gravity margin time",title:"Amount of time in frames until the gravity starts to increase.",type:"number",classes:"",attributes:'max="100000" min="0" step="1"'},{id:"game.options.garbagemultiplier",label:"garbage multiplier",title:"Starting garbage multiplier. 1 means normal amount of garbage, 2 means double.",type:"number",classes:"",attributes:'max="100" min="0" step="0.1"'},{id:"game.options.garbagemargin",label:"garbage margin time",title:"Amount of time in frames until the garbage multiplier starts to increase.",type:"number",classes:"",attributes:'max="100000" min="0" step="1"'},{id:"game.options.garbageincrease",label:"garbage increase",title:"The amount of garbage multiplier increase per second.",type:"number",classes:"",attributes:'max="1" min="0" step="0.0001"'},{id:"game.options.locktime",label:"lock delay",title:"If not using master levels, the amount of frames until a piece locks down.",type:"number",classes:"",attributes:'min="1"'},{id:"game.options.garbagespeed",label:"garbage travel speed",title:"The time it takes in frames for garbage to travel.",type:"number",classes:"",attributes:'min="1" max="600"'},{id:"game.options.garbagecap",label:"garbage cap",title:"Amount of garbage that may enter the screen at once.",type:"number",classes:"",attributes:'min="1" max="40"'},{id:"game.options.garbagecapincrease",label:"garbage cap increase",title:"The amount of garbage cap increase per second.",type:"number",classes:"",attributes:'max="1" min="0" step="0.0001"'},{id:"game.options.garbagecapmax",label:"garbage cap max",title:"Maximum amount the garbage cap may reach.",type:"number",classes:"",attributes:'min="1" max="40"'},{id:"game.options.passthrough",label:"garbage passthrough",title:"If enabled, attacks cannot be canceled while in transit or during latency.",type:"checkbox",classes:"",attributes:""},{id:"game.options.manual_allowed",label:"allow manual targeting",title:"Whether to allow users to click boards to manually target them.",type:"checkbox",classes:"",attributes:""},{id:"game.options.b2bchaining",label:"enable back-to-back chaining",title:"Whether to make long Back-to-Back chains become more powerful.",type:"checkbox",classes:"",attributes:""},{id:"game.options.clutch",label:"enable clutch clears",title:"Whether to allow out-of-bound placements when they clear a line.",type:"checkbox",classes:"",attributes:""}]}]}],Se=[{id:"custom_content_game",classes:"",blocks:[{title:"GENERAL",options:[{id:"bagtype",label:"random bag type",title:"The type of system used to generate random pieces.",type:"spinner",classes:"imp",value:"7bag",attributes:'data-items="7-bag,7-BAG,keep shuffling a bag of the 7 tetrominoes;14-bag,14-BAG,keep shuffling a bag of 2x the 7 tetrominoes;classic,CLASSIC,random with repetition protection;pairs,PAIRS,alternate between 2 tetrominoes;total mayhem,TOTAL MAYHEM,completely random generation"'},{id:"spinbonuses",label:"allowed spins",title:"The type of pieces allowed to do spins.",type:"spinner",classes:"imp",value:"T-spins",attributes:'data-items="T-spins,T-SPINS,receive bonuses for spinning T-pieces;all,ALL-SPIN,receive bonuses for spinning all pieces;stupid,STUPID,everything is a spin because YEAH WHY NOT (O-spin SUPPORTED!);none,NONE,receive no spin bonuses"'},{id:"seed_random",label:'use random seed (overrides "seed")',title:"Whether to use a random seed.",type:"checkbox",classes:"",attributes:"checked"},{id:"seed",label:"seed",title:'Seed to use, if "use random seed" is not checked.',type:"number",classes:"",attributes:'max="2147483647" min="0" value="0"'},{id:"can_retry",label:"allow retry",title:"Whether to allow retrying.",type:"checkbox",classes:"",attributes:"checked"},{id:"stock",label:"stock",title:"Amount of extra lives one has.",type:"number",classes:"",attributes:'max="10" min="0" value="0"'},{id:"clutch",label:"enable clutch clears",title:"Whether to allow out-of-bound placements when they clear a line.",type:"checkbox",classes:"",attributes:"checked"},{id:"boardwidth",label:"board width",title:"The width of the playing field.",type:"number",classes:"",attributes:'max="20" min="4" value="10"'},{id:"boardheight",label:"board height",title:"The height of the playing field.",type:"number",classes:"",attributes:'max="40" min="4" value="20"'}]},{title:"CONTROLS",options:[{id:"allow180",label:"allow 180 spins",title:"Whether to allow the 180 rotation key to be used.",type:"checkbox",classes:"",attributes:"checked"},{id:"kickset",label:"kick table",title:"The type of kicks that pieces can do.",type:"spinner",classes:"",value:"SRS+",attributes:'data-items="SRS+,SRS+,the default natural rotation system with symmetric I-piece rotation;SRS,SRS,the standard natural rotation system;SRS-X,SRS-X,SRS with more powerful 180 spins;TETRA-X,TETRA-X,novel rotation system by DR OCELOT;NRS,NRS,the classic rotation system;ARS,ARS,rotation system used in arcade games;ASC,ASC,permissive rotation system by WINTERNEBS;none,NONE,no kicks possible"'},{id:"allow_harddrop",label:"use hard drop",title:"Whether to allow use of the Hard Drop button.",type:"checkbox",classes:"",attributes:"checked"},{id:"display_next",label:"use NEXT queue",title:"Whether to show the NEXT queue.",type:"checkbox",classes:"",attributes:"checked"},{id:"display_hold",label:"use HOLD queue",title:"Whether to use the HOLD queue.",type:"checkbox",classes:"",attributes:"checked"},{id:"nextcount",label:"next pieces",title:"Amount of pieces shown in the NEXT queue, if said queue is enabled.",type:"number",classes:"",attributes:'min="1" value="5" max="5"'},{id:"infinitemovement",label:"infinite movement",title:"Whether to never lock, as long as you keep moving the piece.",type:"checkbox",classes:"",attributes:""},{id:"display_shadow",label:"show shadow piece",title:"Whether to show the shadow piece.",type:"checkbox",classes:"",attributes:"checked"},{id:"are",label:"ARE",title:"Amount of time in frames in between a piece being placed and the next one spawning.",type:"number",classes:"",attributes:'min="0" value="0" max="300"'},{id:"lineclear_are",label:"line clear ARE",title:"Amount of time in frames in between a piece being placed and the next one spawning, if a line was cleared.",type:"number",classes:"",attributes:'min="0" value="0" max="300"'}]},{title:"GRAVITY & LEVELLING",options:[{id:"g",label:"gravity",title:"Gravity (how fast blocks drop). Higher is faster.",type:"number",classes:"",attributes:'max="20" min="0" step="0.01" value="0.02"'},{id:"levels",label:'use levelling (overrides "gravity")',title:"Whether to allow players to level up. Overrides the normal gravity.",type:"checkbox",classes:"",attributes:"checked"},{id:"masterlevels",label:"use master levels",title:"If enabled, allow levels past 20 to become MASTER LEVELS (faster lock-down time and less resets).",type:"checkbox",classes:"",attributes:""},{id:"startinglevel",label:"starting level",title:"Level to start at.",type:"number",classes:"",attributes:'value="1" min="1"'},{id:"levelspeed",label:"level speed",title:"How fast you clear levels.",type:"number",classes:"",attributes:'step="0.01" value="1"'},{id:"levelstatic",label:'use static levelling (overrides "level speed")',title:"Use a static amount of lines to level up.",type:"checkbox",classes:"",attributes:"checked"},{id:"levelstaticspeed",label:"level static speed",title:"If using static levelling, the amount of lines needed to clear a level.",type:"number",classes:"",attributes:'min="1" value="10"'},{id:"gbase",label:"base gravity",title:"When using levels, the starting gravity.",type:"number",classes:"",attributes:'step="0.01" value="0.8"'},{id:"gspeed",label:"gravity increase",title:"When using levels, the speed with which gravity increases.",type:"number",classes:"",attributes:'step="0.001" value="0.007"'},{id:"locktime",label:"lock delay",title:"If not using master levels, the amount of frames until a piece locks down.",type:"number",classes:"",attributes:'min="1" value="30"'}]}]},{id:"custom_content_objective",classes:"hidden",blocks:[{title:"GENERAL",options:[{id:"x_resulttype",label:"key",title:"The counter you will be judged on at the end of the game.",type:"spinner",classes:"super-imp",value:"score",attributes:'data-items="score,SCORE,final score will be displayed;time,TIME,final time will be displayed;lines,LINES,final line count will be displayed"'},{id:"objective_type",label:"objective",title:"Game mode.",type:"spinner",classes:"super-imp",value:"lines",attributes:'data-items="none,NONE,play infinitely;lines,LINES,get to a set amount of lines to clear;timed,TIMED,play for a set amount of time to clear"'},{id:"objective_count",label:"count",title:"Amount of primary key to get in LINES mode. For example, in LINES mode this would be the amount of lines to be cleared.",type:"number",classes:"imp",attributes:'min="1" value="150"'},{id:"objective_time",label:"time",title:"Amount of time in milliseconds. For example, in TIMED mode this would be the amount of time until the game ends.",type:"number",classes:"imp",attributes:'min="1" value="120000"'},{id:"topoutisclear",label:"topping out is OK",title:"If enabled, still display the results screen if the player tops out.",type:"checkbox",classes:"",attributes:"checked"}]}]},{id:"custom_content_meta",classes:"hidden",blocks:[{title:"INTRO",options:[{id:"mission",label:"mission",title:"Text displayed before starting game.",type:"text",classes:"imp",attributes:'value="CUSTOM GAME"'},{id:"stride",label:"stride mode",title:"Speeds up animations and disables some of the below settings.",type:"checkbox",classes:"",attributes:""},{id:"countdown",label:"play countdown",title:"Whether to play a countdown.",type:"checkbox",classes:"",attributes:"checked"},{id:"countdown_count",label:"countdown count",title:"Amount of steps in the countdown.",type:"number",classes:"",attributes:'min="1" value="3" max="60"'},{id:"countdown_interval",label:"countdown interval",title:"Amount of milliseconds between countdown ticks.",type:"number",classes:"",attributes:'min="1" value="1000"'},{id:"precountdown",label:"time before countdown",title:"Amount of milliseconds before the countdown is started.",type:"number",classes:"",attributes:'min="1" value="3000"'},{id:"prestart",label:"time before start",title:"Amount of milliseconds before the game is created.",type:"number",classes:"",attributes:'min="1" value="1000"'},{id:"zoominto",label:"zoom animation",title:"Type of animation to play when starting.",type:"spinner",classes:"",value:"slow",attributes:'data-items="none,NO ANIMATION,display no animation;fast,FAST,display a fast animation;slow,SLOW,display a slow animation;cinematic,CINEMATIC,display a very slow animation"'}]},{title:"COUNTERS",options:[{id:"slot_counter1",label:"left counter slot 1",title:"The type of metric to display in the first left-hand slot.",type:"spinner",classes:"",value:"stopwatch",attributes:`data-items="${Te}"`},{id:"slot_counter2",label:"left counter slot 2",title:"The type of metric to display in the second left-hand slot.",type:"spinner",classes:"",value:"lines",attributes:`data-items="${Te}"`},{id:"slot_counter3",label:"left counter slot 3",title:"The type of metric to display in the third left-hand slot.",type:"spinner",classes:"",value:"level",attributes:`data-items="${Te}"`},{id:"slot_counter4",label:"left counter slot 4",title:"The type of metric to display in the fourth left-hand slot.",type:"spinner",classes:"",value:"---empty---",attributes:`data-items="${Te}"`},{id:"slot_counter5",label:"right counter slot",title:"The type of metric to display in the right-hand slot.",type:"spinner",classes:"",value:"score",attributes:`data-items="${Te}"`},{id:"absolute_lines",label:"enforce absolute line count",title:"Do not display the progression through the level in the line count.",type:"checkbox",classes:"",attributes:"checked"},{id:"display_progress",label:"display progress bar",title:"Whether to display the progress bar on the right.",type:"checkbox",classes:"",attributes:"checked"}]}]}];function Me(e,t){let s="";return e.forEach((e=>{s+=`<div class="scroller room_content tab_content ${e.classes}" data-scope="${t}" id="${e.id}"><p class="rc_moreinfo ns">hover over a setting for more info</p>`,e.blocks.forEach((e=>{s+=`<div class="scroller_block light"><h2 class="ns">${e.title}</h2>`,e.options.forEach((e=>{switch(e.type){case"text":s+=`<div class="room_config_row flex-row ${e.classes}" title="${e.title}">\n\t\t\t\t\t\t\t\t\t<div class="room_config_label flex-item ns">${e.label}</div>\n\t\t\t\t\t\t\t\t\t<input class="room_config_item flex-item" data-index="${e.id}" ${e.attributes}>\n\t\t\t\t\t\t\t\t</div>`;break;case"number":s+=`<div class="room_config_row flex-row ${e.classes}" title="${e.title}">\n\t\t\t\t\t\t\t\t\t<div class="room_config_label flex-item ns">${e.label}</div>\n\t\t\t\t\t\t\t\t\t<input type="number" class="room_config_item flex-item" data-index="${e.id}" ${e.attributes}>\n\t\t\t\t\t\t\t\t</div>`;break;case"checkbox":s+=`<div class="room_config_row flex-row ${e.classes}" title="${e.title}">\n\t\t\t\t\t\t\t\t\t<div class="room_config_label flex-item ns">${e.label}</div>\n\t\t\t\t\t\t\t\t\t<label class="rc_switch flex-item"><input type="checkbox" class="room_config_item" data-index="${e.id}" ${e.attributes}><span class="rc_switch_knob"></span></label>\n\t\t\t\t\t\t\t\t</div>`;break;case"spinner":s+=`<div class="room_config_row flex-row ${e.classes}" title="${e.title}">\n\t\t\t\t\t\t\t\t\t<div class="room_config_label flex-item ns">${e.label}</div>\n\t\t\t\t\t\t\t\t\t<div class="room_config_item room_config_spinner flex-item ns" data-index="${e.id}" ${e.attributes}>${e.value||""}</div>\n\t\t\t\t\t\t\t\t</div>`;break;case"music":s+=`<div class="room_config_row flex-row ${e.classes}" title="${e.title}">\n\t\t\t\t\t\t\t\t\t<div class="room_config_label flex-item ns">${e.label}</div>\n\t\t\t\t\t\t\t\t\t<div class="room_config_item room_config_spinner flex-item music_picker ns" data-index="${e.id}" ${e.attributes}></div>\n\t\t\t\t\t\t\t\t</div>`}})),s+="</div>"})),s+="</div>"})),s}U.ready((function(t){e("room_opts_save").outerHTML=Me(Ie,"room_opts")+e("room_opts_save").outerHTML,e("custom_content_container").innerHTML=Me(Se,"custom_opts"),!1===te.video.guide&&(e("room_opts_welcome").classList.remove("active"),e("room_opts_room").classList.add("active"),e("room_content_welcome").classList.add("hidden"),e("room_content_room").classList.remove("hidden"))}));const Ae=(()=>{let e={},a=!1,n=null,o=null,i=null;const r=[];function l(){if(!a||!e)return;if(!o||!i||null===i.offsetParent)return void n.classList.add("hidden");n.classList.remove("hidden");const t=i.getBoundingClientRect();n.style.left=`${t.left}px`,n.style.top=`${t.top}px`,n.style.width=`${t.width}px`,n.style.height=`${t.height}px`,n.classList.toggle("input",["input","textarea"].includes(document.activeElement.tagName.toLowerCase())),n.classList.toggle("noclick",i.classList.contains("noclick"))}function c(e){const t=e.split("!");return 2===t.length?{tags:t[0].split(""),selector:t[1]}:{tags:[],selector:t[0]}}function d(t){const a=function(e,t=null){const a=c(e);let n=Array.from(s(a.selector));if(n=n.filter((e=>(null!==e.offsetParent||e.classList.contains("rb_bypass"))&&null===e.closest(".hidden"))),a.tags.includes("f")&&n.splice(1),a.tags.includes("l")&&n.splice(0,n.length-1),t&&a.tags.includes("n")){const e=n.indexOf(t);-1!==e&&n.length?n=[n[(e+1)%n.length]]:n.splice(1)}if(t&&a.tags.includes("p")){const e=n.indexOf(t);-1!==e&&n.length?n=[n[(e-1+n.length)%n.length]]:n.splice(0,n.length-1)}return n[0]||null}(t,i);a?(i=a,o=function(t,a){const n=c(t);let o=Array.from(s(n.selector));o=o.filter((e=>(null!==e.offsetParent||e.classList.contains("rb_bypass"))&&null===e.closest(".hidden")));const i=o.indexOf(a);let r=n.selector;return 0===i?r=`f!${n.selector}`:i===o.length-1&&(r=`l!${n.selector}`),e.items[r]?r:n.selector}(t,i),c(t).tags.includes("s")||function(e){const t=document.createElement("div");return t.classList.add("elgh"),t.style.left=`${e.offsetLeft}px`,t.style.top=`${e.offsetTop}px`,t.style.width=`${Math.max(0,Math.min(e.offsetParent.offsetWidth-e.offsetLeft-30,e.offsetWidth))}px`,t.style.height=`${e.offsetHeight}px`,e.offsetParent.appendChild(t),setTimeout((()=>{t.remove()}),1e3),t}(i).scrollIntoView({behavior:"smooth",block:"center",inline:"nearest"}),i.getAttribute("data-hover")&&Os.play(`menu${i.getAttribute("data-hover")}`)):o=t}function p(t){e=t,e.starter?d(e.starter):(o=null,i=null)}U.ready((function(e){n=document.createElement("div"),n.id="ribbonglide",document.body.appendChild(n),PIXI.Ticker.shared.add(l)}));let u=null;function m(e){if("none"===window.getComputedStyle(e,null).getPropertyValue("pointer-events"))return Os.play("no"),n.classList.add("no"),null!==u&&clearTimeout(u),void setTimeout((()=>{n.classList.remove("no"),u=null}),100);ee.pulse(...ee.WEAK_TAP),Os.play("ribbon_tap",.5),e.focus(),e.click()}return{push:()=>{r.push({guide:e,targeted:o,targetedElement:i})},pop:()=>{!function(){const t=r.pop();t&&(e=t.guide,o=t.targeted,i=t.targetedElement)}()},tryClick:e=>{m(e)},isEngaged:()=>a,engage:()=>{a=!0,document.body.classList.add("ribbonglide_engaged")},disengage:()=>{a=!1,document.body.classList.remove("ribbonglide_engaged")},bindGuide:e=>{p(e)},rebind:()=>{p(e)},action:s=>{!function(s){if(a&&!i&&d(o),a&&o&&e&&e.items&&void 0!==e.items[o])if(void 0===e.items[o][s]&&"confirm"===s&&i)m(i);else if(void 0===e.items[o][s]&&"back"===s&&e.back)m(t(e.back));else if(void 0!==e.items[o][s])if("string"==typeof e.items[o][s])Os.play("ribbon",.5),ee.pulse(...ee.WEAK_GLIDE),d(e.items[o][s]);else{const t=e.items[o][s](i);t&&(Os.play("ribbon"),ee.pulse(...ee.WEAK_GLIDE),d(t))}}(s)}}})(),Ce={home:{starter:"f!.scroller_item",back:"#exit_electron",items:{".scroller_item":{up:"p!.scroller_item",down:"n!.scroller_item"}}},play1p:{starter:"f!.scroller_item",back:"#back",items:{".scroller_item":{up:"p!.scroller_item",down:"n!.scroller_item"}}},"40l":{starter:"#start_40l",back:"#back",items:{"#start_40l":{left:"#music_picker_40l",right:"#music_picker_40l",up:"l!.checkbox",down:"f!.checkbox"},"#music_picker_40l":{left:"#start_40l",right:"#start_40l",up:"l!.checkbox",down:"f!.checkbox"},"f!.checkbox":{up:"#start_40l",down:"n!.checkbox"},"l!.checkbox":{up:"p!.checkbox",down:"#start_40l"},".checkbox":{up:"p!.checkbox",down:"n!.checkbox"}}},blitz:{starter:"#start_blitz",back:"#back",items:{"#start_blitz":{up:"l!.checkbox",down:"f!.checkbox"},"f!.checkbox":{up:"#start_blitz",down:"n!.checkbox"},"l!.checkbox":{up:"p!.checkbox",down:"#start_blitz"},".checkbox":{up:"p!.checkbox",down:"n!.checkbox"}}},zen:{starter:"#start_zen",back:"#back",items:{"#start_zen":{}}},custom:{starter:"#start_custom",back:"#back",items:{"#custom_export":{up:"l!.room_config_row",down:"#start_custom"},"#start_custom":{left:"#music_picker_custom",right:"#music_picker_custom",up:"#custom_export",down:"f!.room_tab"},"#music_picker_custom":{left:"#start_custom",right:"#start_custom",up:"#custom_export",down:"f!.room_tab"},".room_tab":{left:"p!.room_tab",right:"n!.room_tab",up:"#start_custom",down:"n!.room_config_row"},"f!.room_config_row":{up:"f!.room_tab",down:"n!.room_config_row",confirm:e=>{Ae.tryClick(e.querySelector(".room_config_item"))}},"l!.room_config_row":{up:"p!.room_config_row",down:"#custom_export",confirm:e=>{Ae.tryClick(e.querySelector(".room_config_item"))}},".room_config_row":{up:"p!.room_config_row",down:"n!.room_config_row",confirm:e=>{Ae.tryClick(e.querySelector(".room_config_item"))}}}},about:{starter:"#about_line_logo",back:"#back",items:{"#about_line_logo":{up:"l!.scroller_item",down:"f!.credit_st"},".credit_st":{left:"p!.credit_st",right:"n!.credit_st",up:"#about_line_logo",down:"f!.scroller_item"},"f!.scroller_item":{up:"l!.credit_st",down:"n!.scroller_item"},"l!.scroller_item":{up:"p!.scroller_item",down:"#about_line_logo"},".scroller_item":{up:"p!.scroller_item",down:"n!.scroller_item"}}},playmulti:{starter:"f!.scroller_item",back:"#back",items:{"#multi_join":{up:"l!.scroller_item",down:"f!.scroller_item",confirm:e=>{Ae.tryClick(e)}},"f!.scroller_item":{up:"#multi_join",down:"n!.scroller_item"},"l!.scroller_item":{up:"p!.scroller_item",down:"#multi_join"},".scroller_item":{up:"p!.scroller_item",down:"n!.scroller_item"}}},multilisting:{starter:"f!.room_listing_item",back:"#back",items:{".room_listing_item":{up:"p!.room_listing_item",down:"n!.room_listing_item"}}},lobby:{starter:"#roomid_container",back:"#leaveroom",items:{"#roomid_container":{up:"#room_opts_save",down:"f!.room_tab"},".room_tab":{left:"p!.room_tab",right:"n!.room_tab",up:"#roomid_container",down:"f!.room_config_row"},"f!.room_config_row":{up:"f!.room_tab",down:"n!.room_config_row",confirm:t=>{e("roomview").classList.contains("hosting")&&Ae.tryClick(t.querySelector(".room_config_item"))}},"l!.room_config_row":{up:"p!.room_config_row",down:"#room_opts_save",confirm:t=>{e("roomview").classList.contains("hosting")&&Ae.tryClick(t.querySelector(".room_config_item"))}},".room_config_row":{up:"p!.room_config_row",down:"n!.room_config_row",confirm:t=>{e("roomview").classList.contains("hosting")&&Ae.tryClick(t.querySelector(".room_config_item"))}},"#room_opts_save":{up:"l!.room_config_row",down:"#roomid_container",confirm:t=>{e("roomview").classList.contains("hosting")&&Ae.tryClick(t)}}}},victory:{starter:"f!.playerresult",back:"#backtoroom",items:{".playerresult":{up:"p!.playerresult",down:"n!.playerresult"}}},multilog:{starter:"f!.leagueplayer",back:"#back",items:{".leagueplayer":{up:"l!.multilog_result",down:"f!.multilog_result",left:"p!.leagueplayer",right:"n!.leagueplayer"},"f!.multilog_result":{up:"f!.leagueplayer",down:"n!.multilog_result"},"l!.multilog_result":{up:"p!.multilog_result",down:"f!.leagueplayer"},".multilog_result":{up:"p!.multilog_result",down:"n!.multilog_result"}}},league:{starter:"s!#enter_matchmaking",back:"#back",items:{"#enter_matchmaking":{up:"#league_tetra",down:"#league_tetra"},"#league_tetra":{up:"#enter_matchmaking",down:"#enter_matchmaking"}}},endleague:{starter:"f!.leagueplayer",back:"#backtoleague",items:{".leagueplayer":{up:"p!.leagueplayer",down:"n!.leagueplayer",left:"p!.leagueplayer",right:"n!.leagueplayer"}}},tetra:{starter:"#tetra_standalone",back:"#back",items:{"#tetra_find":{up:"l!#tetra_news_content a",down:"#tetra_standalone"},"#tetra_standalone":{up:"#tetra_find",down:"#tetra_leaderboards"},"#tetra_leaderboards":{up:"#tetra_standalone",down:"#tetra_me",left:"#tetra_me",right:"#tetra_players"},"#tetra_me":{up:"#tetra_leaderboards",down:"f!#tetra_news_content a",left:"#tetra_players",right:"#tetra_players"},"#tetra_players":{up:"#tetra_leaderboards",down:"f!#tetra_news_content a",left:"#tetra_me",right:"#tetra_me"},"f!#tetra_news_content a":{up:"#tetra_me",left:"#tetra_players",down:"n!#tetra_news_content a",right:"n!#tetra_news_content a"},"l!#tetra_news_content a":{up:"p!#tetra_news_content a",left:"p!#tetra_news_content a",down:"#tetra_find",right:"#tetra_find"},"#tetra_news_content a":{up:"p!#tetra_news_content a",left:"p!#tetra_news_content a",down:"n!#tetra_news_content a",right:"n!#tetra_news_content a"}}},tetra_records:{starter:"f!.control_button",back:"#back",items:{".control_button":{up:"l!.record_item",down:"f!.record_item",left:"p!.control_button",right:"n!.control_button"},"f!.record_item":{up:"f!.control_button",down:"n!.record_item"},"l!.record_item":{up:"p!.record_item",down:"f!.control_button"},".record_item":{up:"p!.record_item",down:"n!.record_item"}}},tetra_me:{starter:"f!.control_button",back:"#back",items:{".control_button":{up:"l!.record_item",down:"f!.record_item",left:"p!.control_button",right:"n!.control_button"},"f!.record_item":{up:"f!.control_button",down:"n!.record_item"},"l!.record_item":{up:"p!.record_item",down:"f!.control_button"},".record_item":{up:"p!.record_item",down:"n!.record_item"}}},tetra_players:{starter:"f!.control_button",back:"#back",items:{".control_button":{up:"l!.record_item",down:"f!.record_item",left:"p!.control_button",right:"n!.control_button"},"f!.record_item":{up:"f!.control_button",down:"n!.record_item"},"l!.record_item":{up:"p!.record_item",down:"f!.control_button"},".record_item":{up:"p!.record_item",down:"n!.record_item"}}},results:{starter:"f!.rg_target_pri",back:"#back",items:{".rg_target_pri":{up:"p!.rg_target_pri",left:"p!.rg_target_pri",down:"n!.rg_target_pri",right:"n!.rg_target_pri"}}},config:{starter:"f!.rg_target_pri",back:"#back",items:{".rg_target_pri":{up:"p!.rg_target_pri",down:"n!.rg_target_pri",left:e=>{if("range"!==e.getAttribute("type"))return"p!.rg_target_pri";{let t=parseFloat(e.getAttribute("step"))||1;e.classList.contains("range_reversed")||(t*=-1),e.value=Math.min(parseFloat(e.getAttribute("max")),Math.max(parseFloat(e.getAttribute("min")),parseFloat(e.value)+t)),e.dispatchEvent(new Event("input",{bubbles:!0,cancelable:!0}))}},right:e=>{if("range"!==e.getAttribute("type"))return"n!.rg_target_pri";{let t=parseFloat(e.getAttribute("step"))||1;e.classList.contains("range_reversed")&&(t*=-1),e.value=Math.min(parseFloat(e.getAttribute("max")),Math.max(parseFloat(e.getAttribute("min")),parseFloat(e.value)+t)),e.dispatchEvent(new Event("input",{bubbles:!0,cancelable:!0}))}}}}},config_account:{starter:"f!.rg_target_pri",back:"#back",items:{".rg_target_pri":{up:"p!.rg_target_pri",down:"n!.rg_target_pri",left:"p!.rg_target_pri",right:"n!.rg_target_pri"}}},config_bgmtweak:{starter:"f!.rg_target_pri",back:"#back",items:{".rg_target_pri":{up:"p!.rg_target_pri",down:"n!.rg_target_pri",left:"p!.rg_target_pri",right:"n!.rg_target_pri"}}},config_electron:{starter:"f!.rg_target_pri",back:"#back",items:{".rg_target_pri":{up:"p!.rg_target_pri",down:"n!.rg_target_pri",left:"p!.rg_target_pri",right:"n!.rg_target_pri"}}},list_request:{starter:"f!#list_request .scroller_item",back:"#list_request_back",items:{"#list_request .scroller_item":{up:"p!#list_request .scroller_item",down:"n!#list_request .scroller_item"}}},tetra_dialog:{starter:".tetra_modal_close",back:".tetra_modal_close",items:{".tetra_modal_close":{up:"l!.tetra_button",down:"f!.tetra_button"},".tetra_button":{up:".tetra_modal_close",down:".tetra_modal_close",left:"p!.tetra_button",right:"n!.tetra_button"}}},dialog:{starter:"f!.oob_button",items:{".oob_button":{left:"p!.oob_button",right:"n!.oob_button"}}},social:{starter:"f!.oob_button",items:{".oob_button":{left:"p!.oob_button",right:"n!.oob_button"}}}};function Re(){D({title:"DELETE YOUR ACCOUNT?",msg:`delete your account <span class="inline_self">${e("config_account_username_field").value}</span> and all attached data?</p><p class="modal_also">this cannot be undone.`,classes:["crash_modal"],buttons:[{label:"CANCEL",classes:[],callback:e=>{e()}},{label:"DELETE!",classes:["pri"],callback:e=>{e(),He()}}]})}function He(){D({title:"DELETE YOUR ACCOUNT?",msg:`no seriously, are you sure you want to delete <span class="inline_self">${e("config_account_username_field").value}</span> and EVERYTHING INVOLVED, like your replays, badges, XP, rating, etc?</p><p class="modal_also">you can never get it back!!!`,classes:["crash_modal","shudder"],buttons:[{label:"CANCEL",classes:[],callback:e=>{e()}},{label:"DELETE!!!",classes:["pri"],callback:e=>{e(),$e()}}]})}function $e(){D({title:`DELETING ${e("config_account_username_field").value}`,msg:'please type your username<br><input class="usernamelike" data-escape="account_delete_cancel" data-enter="account_delete_submit" id="account_delete" placeholder="YOUR USERNAME" value="">',buttons:[{label:"CANCEL",classes:[],id:"account_delete_cancel",callback:e=>{e()}},{label:"SUBMIT",classes:["pri"],id:"account_delete_submit",callback:t=>{t(),e("account_delete").value.toUpperCase()===e("config_account_username_field").value?Oe():T("wrong username - deletion aborted")}}]}),e("account_delete").focus()}function Oe(){z.requestPassword(((e,t)=>{ct("requesting deletion"),w.post("/api/users/requestDeletion",{password:e,totp:t}).then((e=>{I("an email has been sent with further instructions!"),dt()}),(e=>{dt(),S(e)}))}))}const Pe=(()=>{let e,t=!1,s=!1,a=[];function n(){t||s||(s=!0,nsfwjs.load("/res/ml/").then((s=>{e=s,t=!0,a.forEach((e=>{e()}))})))}return{request:function(s=(()=>{})){return new Promise(((o,i)=>{n();const r=document.createElement("input");r.type="file",r.setAttribute("accept",".png,.jpg,.jpeg,.gif,image/gif,image/png,image/jpg,image/jpeg"),r.onchange=r=>{s();const l=document.createElement("img"),c=r.target.files[0];if(c.size>=2097152)return void i("sorry, that file's too large!");const d=new FileReader;d.readAsDataURL(c),d.onload=()=>{var s;l.src=d.result,s=()=>{setTimeout((()=>{try{e.classify(l).then((e=>{let t=0;["Porn","Sexy","Hentai"].includes(e[0].className)?t=2:e.forEach((e=>{["Porn","Sexy","Hentai"].includes(e.className)&&(e.probability>=.4?t=Math.max(t,2):e.probability>=.1&&(t=Math.max(t,1)))})),o({safetyLevel:t,image:c,predictions:e})})).catch((()=>{o({safetyLevel:1,image:c,predictions:[]})}))}catch(e){o({safetyLevel:1,image:c,predictions:[]})}}),100)},n(),t?s():a.push(s)}},r.click()}))}}})();let De,Ne=0,Fe="z",Ue=-1,Be={};const Xe={none:{back:null,header:"HOME",footer:"pick a game mode"},home:{back:null,header:"HOME",footer:'welcome to <span class="cheeky">TETRIO</span>!',onenter:()=>{Ps.playSmooth(document.body.classList.contains("inpair")||document.body.classList.contains("matchmaking")?"touhoudaiensei":"kuchu-toshi"),document.body.classList.contains("inpair")||document.body.classList.contains("matchmaking")||yn("online","menus"),X.mount("tetr-io_728x90_1"),X.mount("tetr-io_970X250_1"),vt("Homebanner")},onreenter:()=>{X.mount("tetr-io_728x90_1"),X.mount("tetr-io_970X250_1"),vt("Homebanner")},onexit:()=>{X.unmount("tetr-io_728x90_1"),X.unmount("tetr-io_970X250_1")}},about:{back:"home",header:"ABOUT",footer:'thank you for playing <span class="cheeky">TETRIO</span>!',onenter:()=>{Ds.loadSpecialThanks()}},play1p:{back:"home",header:"SOLO",footer:"pick a game mode",onenter:()=>{e("zen_count").innerHTML=Ut.getZen().level,X.mount("tetr-io_728x90_2"),vt("Solo Home Menu")},onreenter:()=>{X.mount("tetr-io_728x90_2"),vt("Solo Home Menu")},onexit:()=>{X.unmount("tetr-io_728x90_2")}},playmulti:{back:"home",header:"MULTIPLAYER",footer:"pick a game mode",onback:()=>{document.body.classList.contains("inpair")||document.body.classList.contains("matchmaking")||ga.unrequire()},onenter:()=>{Ps.playSmooth(document.body.classList.contains("inpair")||document.body.classList.contains("matchmaking")?"touhoudaiensei":"kuchu-toshi"),w.get("/api/rooms/menu").then((t=>{e("quickplay_players").innerHTML=`${t.quickplay.playing}${t.quickplay.total-t.quickplay.playing?`<span class="room_listing_spectators">+${t.quickplay.total-t.quickplay.playing}</span>`:""}`,e("quickplay_players").classList.toggle("empty",!t.quickplay.playing),e("room_count").innerHTML=`${t.roomcount}`,e("room_count").classList.toggle("empty",!t.roomcount),e("room_count").classList.toggle("singular",1===t.roomcount)}),(t=>{e("quickplay_players").innerHTML="0",e("quickplay_players").classList.add("empty")})),document.body.classList.contains("inpair")||document.body.classList.contains("matchmaking")||yn("online","menus"),X.mount("tetr-io_728x90_3"),vt("Multiplayer Home Menu")},onreenter:()=>{X.mount("tetr-io_728x90_3"),vt("Multiplayer Home Menu")},onexit:()=>{X.unmount("tetr-io_728x90_3")}},multilisting:{back:"playmulti",header:"MULTIPLAYER / ROOM LISTING",footer:"pick a room to join!",onenter:()=>{ka.loadListing(),e("roomlisting_scroller").scrollTop=0}},lobby:{back:null,header:"",footer:"",onenter:()=>{Ps.playSmooth("smoke"),e("room_chat").scrollTop=e("room_chat").scrollHeight+100,ya&&"X-QP"===ya?X.mount("tetr-io_300x250_1"):X.mount("tetr-io_728x90_4"),vt(ya&&"X-QP"===ya?"Quick Play Lobby":"Custom Room Lobby")},onreenter:()=>{ya&&"X-QP"===ya?X.mount("tetr-io_300x250_1"):X.mount("tetr-io_728x90_4")},onexit:()=>{X.unmount("tetr-io_300x250_1"),X.unmount("tetr-io_728x90_4")}},victory:{back:null,header:"RESULTS",footer:"the results are in!",onenter:()=>{Ps.playSmooth("aijin-sanka"),e("victoryview").scrollTop=-200,e("vvsc").scrollTop=-200,X.mount("tetr-io_970X250_2"),X.mount("tetr-io_728x90_5"),vt("Multiplayer Results")},onreenter:()=>{X.mount("tetr-io_970X250_2"),X.mount("tetr-io_728x90_5"),vt("Multiplayer Results")},onexit:()=>{X.unmount("tetr-io_970X250_2"),X.unmount("tetr-io_728x90_5")}},multilog:{back:"home",header:"RESULTS",footer:"the results are in!"},league:{back:"playmulti",header:"TETRA LEAGUE",footer:"face off against others and rise up through the ranks!",onenter:()=>{Ps.playSmooth("touhoudaiensei"),e("leagueview").scrollTop=0,We(),X.mount("tetr-io_728x90_6"),vt("League Home")},onreenter:()=>{X.mount("tetr-io_728x90_6"),vt("League Home")},onexit:()=>{X.unmount("tetr-io_728x90_6")}},endleague:{back:null,header:"TETRA LEAGUE / RESULTS",footer:"the results are in!",onenter:()=>{e("league_chat").scrollTop=e("league_chat").scrollHeight+100,vt("League Results")}},tetra:{back:"home",header:"TETRA CHANNEL",footer:"welcome to TETRA CHANNEL!",onenter:()=>{Ps.playSmooth(document.body.classList.contains("inpair")||document.body.classList.contains("matchmaking")?"touhoudaiensei":"shikiichi-made-mousukoshi"),Ds.loadNews(),Ds.loadTwitch(),vt("Tetra Home")}},tetra_records:{back:"tetra",header:"TETRA CHANNEL / LEADERBOARDS",footer:"top the global leaderboards!",onenter:()=>{Ds.loadRecords("40l_global","tetra_records")}},tetra_me:{back:"tetra",header:"TETRA CHANNEL / ME",footer:"view your achievements!",onenter:()=>{Ds.loadRecords("any_userrecent_CURRENTID","tetra_me")}},tetra_players:{back:"tetra",header:"TETRA CHANNEL / PLAYERS",footer:"view other players and their achievements!",onenter:()=>{Ds.loadUserList("tetra_player_league_stream","/api/users/by/league"),e("tetra_players_league").classList.add("pressed"),e("tetra_players_xp").classList.remove("pressed"),e("tetra_player_league_stream").classList.remove("hidden"),e("tetra_player_xp_stream").classList.add("hidden")}},"40l":{back:"play1p",header:"40 LINES",footer:"press START to begin playing"},blitz:{back:"play1p",header:"BLITZ",footer:"press START to begin playing"},zen:{back:"play1p",header:"ZEN",footer:"press START to begin playing"},custom:{back:"play1p",header:"CUSTOM",footer:"press START to begin playing"},results:{back:"home",header:"RESULTS",footer:"GAME TYPE: the results are in!",onenter:()=>{e("results_stats_set_overview").classList.add("pressed"),e("results_stats_set_full").classList.remove("pressed"),e("results_stats_overview").classList.remove("hidden"),e("results_stats_full").classList.add("hidden"),X.mount("tetr-io_728x90_7"),vt("Solo Results")},onreenter:()=>{X.mount("tetr-io_728x90_7"),vt("Solo Results")},onexit:()=>{X.unmount("tetr-io_728x90_7")}},config:{back:"home",header:"CONFIG",footer:'tweak your settings for a better <span class="cheeky">TETRIO</span> experience'},config_account:{back:"config",header:"CONFIG / ACCOUNT",footer:'change settings in your <span class="cheeky">TETRIO</span> account'},config_account_orders:{back:"config_account",header:"CONFIG / ACCOUNT / ORDERS",footer:"view past orders for your account"},config_bgmtweak:{back:"config",header:"CONFIG / BGM TWEAKER",footer:"change how often some songs play"},config_electron:{back:"config",header:'CONFIG / <span class="cheeky">TETRIO</span> DESKTOP',footer:'change <span class="cheeky">TETRIO</span> DESKTOP settings'}};let ze="none";function Ge(t,s,a,n,o,i,r){D({title:t,msg:`${s}<br><input data-escape="request_number_cancel" data-enter="request_number_submit" id="request_number" type="number" placeholder="NUMBER" autocomplete="off" value="${i}" step="${o}" min="${a}" max="${n}">`,buttons:[{label:"CANCEL",classes:[],id:"request_number_cancel",callback:e=>{e()}},{label:"SUBMIT",classes:["pri"],id:"request_number_submit",callback:t=>{r(e("request_number").value),t()}}]}),e("request_number").focus()}function je(t,s,a,n){D({title:t,msg:`${s}<br><span style="font-family: 'PFW'; font-size: 1.35em;">#</span><input data-escape="request_roomid_cancel" data-enter="request_roomid_submit" id="request_roomid" placeholder="ROOM ID" autocomplete="off" value="${a}" minlength="1" maxlength="16" class="mono_input usernamelike" style="width: calc(100% - 1.5em); margin-left: 0.2em;">`,buttons:[{label:"CANCEL",classes:[],id:"request_roomid_cancel",callback:e=>{e()}},{label:"SUBMIT",classes:["pri"],id:"request_roomid_submit",callback:t=>{n(e("request_roomid").value),t()}}]}),e("request_roomid").focus()}function We(){"league"!==ze||e("menus").classList.contains("hidden")||ht<1||w.get("/api/rooms/league").then((t=>{e("mm_queuecount_count").innerHTML=t.info.queue,e("mm_playercount_count").innerHTML=t.info.players}),(t=>{e("mm_queuecount_count").innerHTML="0",e("mm_playercount_count").innerHTML="0"}))}function qe(){return!document.body.classList.contains("supporter")&&(!document.body.classList.contains("staff")&&(Ke("THIS ACTION REQUIRES SUPPORTER"),!0))}function Ke(t="SUPPORT TETR.IO",s){if(TETRIO_ENV.novault)return void T("purchases are disabled on this installation");D({title:t,msg:`</p><div class="dialog_long">\n\t\t\t\t<p class="supporter_bumper">\n\t\t\t\t\tEver since starting TETR.IO back in February of 2019, I've always tried running it in a way I feel is fair. While it may be an .io-game, I don't want to go down the path of other such games. I want to pride myself on my game, not on my bottom line. TETR.IO will always be <b>free-to-win</b>, with monetization being optional for all players. Please help me sustain this goal, by supporting me, and get some cool benefits! While they won't improve your skill, they might make you stand out among friends, and rep your support! \n\t\t\t\t\t<span class="supporter_bumper_footer">&mdash; osk, founder and developer of TETR.IO</span>\n\t\t\t\t</p>\n\t\t\t\t<div class="supporter-perk"><img src="/res/supporter-perk-badge.png" />show off with a very special <span>profile badge</span></div>\n\t\t\t\t<div class="supporter-perk"><img src="/res/supporter-perk-customize.png" />customize your profile with a <span>profile banner</span> and <span>about me</span> section</div>\n\t\t\t\t<div class="supporter-perk"><img src="/res/supporter-perk-amend.png" />easily <span>change your username</span> once a month and <span>change your country</span> on demand</div>\n\t\t\t\t<div class="supporter-perk"><img src="/res/supporter-perk-emotes.png" />get access to <span>exclusive supporter emotes</span></div>\n\t\t\t\t<div class="supporter-perk"><img src="/res/supporter-perk-vanityroom.png" />set a <span>custom room ID</span> on your public and private rooms</div>\n\t\t\t\t<div class="supporter-perk"><img src="/res/supporter-perk-friends.png" />have up to <span>500 friends</span>, up from 50</div>\n\t\t\t\t<div class="supporter-perk"><img src="/res/supporter-perk-discordrole.png" />get an exclusive <span>supporter role</span> in the discord</div>\n\t\t\t\t<div class="supporter-perk"><img src="/res/supporter-perk-ads.png" />hide all <span>ads</span> from the game and tetra channel</div>\n\t\t\t\t<div class="supporter-perk"><img src="/res/supporter-perk-love.png" />and get that warm feeling of <span>supporting a project you love</span></div>\n\t\t\t\t<div class="supporter_payment_block">\n\t\t\t\t\t<p>TETR.IO Supporter is a <b>non-recurring payment</b>. If you buy it while still being a supporter, it will extend the duration of your existing supporter status.</p>\n\t\t\t\t\t<div class="checkbox minor_checkbox ${s?"checked":""}" id="supporter_payment_block_gift">Gift to other player(s)</div>\n\t\t\t\t\t<input placeholder="the recipients' usernames, separated by spaces" id="supporter_payment_block_recipient" autocomplete="off" class="minor_input usernamelike" value="${s?r(s).toLowerCase():""}">\n\t\t\t\t\t<input type="range" min="1" max="24" value="${s?"1":"3"}" class="minor_range" id="supporter_payment_block_duration">\n\t\t\t\t\t<div class="supporter_payment_price" id="supporter_payment_price">\n\t\t\t\t\t\t<div>3 months</div>\n\t\t\t\t\t\t15\n\t\t\t\t\t</div>\n\t\t\t\t\t<div class="supporter_payment_custom" id="supporter_payment_custom">...or pick a custom length (up to 1200 months)</div>\n\t\t\t\t\t<p class="supporter_payment_also">will be converted to your local currency on payment</p>\n\t\t\t\t</div>\n\t\t\t</div><p>`,classes:["supporter_modal"],buttons:[{label:"BACK",classes:[],callback:e=>{e()}},{label:"SUPPORT!",classes:["pri"],callback:t=>{const s=e("supporter_payment_block_recipient").value.toLowerCase().replace(/,/g,"").replace(/\s+/g," ").trim().split(" "),a=e("supporter_payment_block_gift").classList.contains("checked"),n=a&&s.length>1?1:Math.max(1,Math.min(1200,parseInt(e("supporter_payment_block_duration").value)));At("supporter",{months:n,price:(a?s.length:1)*(Math.min(TETRIO_ENV.catalog.supporter.bulk_after,n)*(a?TETRIO_ENV.catalog.supporter.price_gift:TETRIO_ENV.catalog.supporter.price))+Math.max(0,n-TETRIO_ENV.catalog.supporter.bulk_after)*(a?TETRIO_ENV.catalog.supporter.price_gift_bulk:TETRIO_ENV.catalog.supporter.price_bulk),isgift:a,recipients:a?s:void 0},(()=>{t()}))}}]});const a=()=>{const t=e("supporter_payment_block_gift").classList.contains("checked"),s=t?e("supporter_payment_block_recipient").value.toLowerCase().replace(/,/g,"").replace(/\s+/g," ").trim().split(" ").length:1,a=s>1?1:Math.max(1,Math.min(1200,parseInt(e("supporter_payment_block_duration").value))),n=s*(Math.min(TETRIO_ENV.catalog.supporter.bulk_after,a)*(t?TETRIO_ENV.catalog.supporter.price_gift:TETRIO_ENV.catalog.supporter.price))+Math.max(0,a-TETRIO_ENV.catalog.supporter.bulk_after)*(t?TETRIO_ENV.catalog.supporter.price_gift_bulk:TETRIO_ENV.catalog.supporter.price_bulk),o=s*(Math.min(TETRIO_ENV.catalog.supporter.normal_bulk_after,a)*(t?TETRIO_ENV.catalog.supporter.normal_price_gift:TETRIO_ENV.catalog.supporter.normal_price))+Math.max(0,a-TETRIO_ENV.catalog.supporter.normal_bulk_after)*(t?TETRIO_ENV.catalog.supporter.normal_price_gift_bulk:TETRIO_ENV.catalog.supporter.normal_price_bulk),i=s*a*TETRIO_ENV.catalog.supporter.price,r=s*a*TETRIO_ENV.catalog.supporter.normal_price,l=parseInt(e("supporter_payment_block_duration").getAttribute("max"));e("supporter_payment_block_duration").style.background=`linear-gradient(to right, #FFF 0%, #FFF ${(a-1)/(l-1)*100}%, #000A ${(a-1)/(l-1)*100}%, #000A 100%)`,e("supporter_payment_block_duration").style.display=s>1?"none":"inline-block",e("supporter_payment_custom").style.display=s>1?"none":"inline-block",e("supporter_payment_price").innerHTML=s>1?`<div>${s} recipients</div>${n!==o?`<span class="slashed_price">${o%1==0?o:o.toFixed(2)}</span> `:""}${n%1==0?n:n.toFixed(2)}${n!==o?` <span class="offer special">${Math.round(100*(1-n/o))}% OFF!</span>`:""}${n!==i?` <span class="offer">save ${Math.round(100*(1-n/r))}% ${n!==o?"in total ":""}by ${t?"gifting":"buying in bulk"}</span>`:""}`:`<div>${a} month${1===a?"":"s"}${a>=12?` <span>(${Math.floor(a/12)} year${1===Math.floor(a/12)?"":"s"}${a%12==0?"":`, ${a%12} month${a%12==1?"":"s"}`})</span>`:""}</div>${n!==o?`<span class="slashed_price">${o%1==0?o:o.toFixed(2)}</span> `:""}${n%1==0?n:n.toFixed(2)}${n!==o?` <span class="offer special">${Math.round(100*(1-n/o))}% OFF!</span>`:""}${n!==i?` <span class="offer">save ${Math.round(100*(1-n/r))}% ${n!==o?"in total ":""}by ${t?"gifting":"buying in bulk"}</span>`:""}`,1===a&&e("supporter_payment_block_duration").setAttribute("max",24)};a(),e("supporter_payment_block_gift").addEventListener("click",(()=>{e("supporter_payment_block_gift").classList.toggle("checked"),a()})),e("supporter_payment_block_duration").addEventListener("input",(()=>{a()})),e("supporter_payment_block_recipient").addEventListener("keyup",(()=>{a()})),e("supporter_payment_custom").addEventListener("click",(()=>{Ge("CUSTOM LENGTH","enter an amount of months (max: 1200)",1,1200,1,e("supporter_payment_block_duration").value,(t=>{t=Math.max(1,Math.min(1200,parseInt(t))),e("supporter_payment_block_duration").setAttribute("max",Math.max(24,t)),e("supporter_payment_block_duration").value=t,a()}))}))}function Ye(e,t){if("supporter"===e)D({title:t.isgift?"THANK YOU FOR GIFTING!":"THANK YOU FOR SUPPORTING!",msg:`</p>\n\t\t\t\t\t\t<center>\n\t\t\t\t\t\t\t<img src="/res/supporter-tag-shiny.png" />\n\t\t\t\t\t\t\t<p>${t.isgift?`YOUR GIFT HAS BEEN SENT TO <b>${t.recipients.length>1?`ALL ${t.recipients.length} LUCKY PLAYERS`:r(t.recipients[0].toUpperCase())}</b>!`:document.body.classList.contains("supporter_at_launch")?"YOUR SUPPORTER STATUS HAS BEEN EXTENDED!":"YOU ARE NOW A TETR.IO SUPPORTER!"}</p>\n\t\t\t\t\t\t</center>\n\t\t\t\t\t\t<p class="supporter_bumper">Thank you very, <b>very</b> much for ${t.isgift?"gifting Supporter":"supporting"} &mdash; ${t.isgift?"their benefits should be applied instantly":document.body.classList.contains("supporter_at_launch")?"your tag has been extended":"your benefits should be applied instantly"}. With your support, I can keep developing TETR.IO as we both love it. ${t.isgift?"You're awesome!":document.body.classList.contains("supporter_at_launch")?"Stay awesome!":"You're awesome!"}<span class="supporter_bumper_footer">&mdash; osk</span></p>\n\t\t\t\t\t<p>`,classes:["supporter_modal"],buttons:[{label:"CLOSE",classes:[],callback:e=>{e()}}]}),Os.play("supporter"),t.isgift||(document.body.classList.add("supporter"),document.body.classList.add("ceriad_exempt"),document.body.classList.add("ceriad_disabled"),X.unmountAll(),localStorage.setItem("wasLastSupporter","Yes, that's it!"),document.cookie="ceriad_exempt=1;max-age=31536000;domain=tetr.io",kt.expires=kt.hasSupporter?kt.expires+1e3*t.months*3600*24*30.5:Date.now()+1e3*t.months*3600*24*30.5,kt.hasSupporter=!0),kt.total=kt.total?kt.total+t.price:t.price,Tt()}function Ve(e,t){const s=document.createElement("input");document.body.appendChild(s),s.value=e,s.select(),document.execCommand("copy"),document.body.removeChild(s),x(`${t||`"${e}"`} copied!`)}function Ze(t,s){const a=document.createElement("div");a.className=`shout ${t}`,a.innerHTML=s,e("majorshouts").appendChild(a),setTimeout((()=>{a.remove()}),5e3),"ultra"===te.video.graphics&&Gn&&No.majorShoutStyles[t]&&No.majorShoutStyles[t]()}function Je(t){if(!te.volume.music)return;const s=e("now_playing"),a=e("now_playing_jp");s.innerHTML=`${Ps.ost[t].artist.toUpperCase()} - ${Ps.ost[t].name.toUpperCase()}`,a.innerHTML=`${Ps.ost[t].jpartist} - ${Ps.ost[t].jpname}`,s.classList.remove("hidden"),a.classList.remove("hidden"),setTimeout((()=>{s.classList.add("hidden"),a.classList.add("hidden")}),5e3)}function Qe(t){e("menus").setAttribute("data-menu-type",t)}function et(t,s){(Xe[ze].onexit||(()=>{}))(),ze=t,e("menus").querySelectorAll("[data-menuview]").forEach((e=>{e.getAttribute("data-menuview")!==t&&(e.classList.contains("hidden")||(e.classList.add("hidden"),setTimeout((()=>{e.classList.contains("hidden")&&e.classList.add("thidden")}),666)))})),Xe[t].back||e("back").classList.add("hidden"),e("exit_electron").classList.toggle("hidden","home"!==t);const a=()=>{e("menus").setAttribute("data-menu-type",t),e("menus").querySelectorAll("[data-menuview]").forEach((e=>{e.getAttribute("data-menuview")===t&&(e.classList.remove("thidden"),e.getBoundingClientRect(),e.classList.remove("hidden"))})),Xe[t].back&&e("back").classList.remove("hidden"),e("header_text").innerHTML=Xe[t].header,e("footer_text").innerHTML=Xe[t].footer,(Xe[t].onenter||(()=>{}))()};s?mt(a):a(),Ae.bindGuide(Ce[t]||{})}U.ready((function(t){let a;st(!0),et("home"),e("back").addEventListener("click",(function(e){Xe[ze].back&&((Xe[ze].onback||(()=>{}))(),et(Xe[ze].back))})),e("exit_electron").addEventListener("click",(function(e){window.IS_ELECTRON&&D({title:"EXIT TETR.IO?",msg:"",buttons:[{label:"CANCEL",classes:[],callback:e=>{e()}},{label:"EXIT",classes:["pri"],callback:e=>{ut(),ct("see you next time!"),Y()}}]})})),e("volume_tweak").addEventListener("click",(function(e){et("config_bgmtweak")})),e("config_electron").addEventListener("click",(function(t){window.IS_ELECTRON&&(e("electron_ver").innerHTML=CLIENT_VERSION,window.EMERGENCY_MODE&&e("config_electron_emergency").classList.remove("hidden"),e("electron_frameratelimit_1x").innerHTML=1*(window.REFRESH_RATE||60)+" fps",e("electron_frameratelimit_2x").innerHTML=2*(window.REFRESH_RATE||60)+" fps",e("electron_frameratelimit_4x").innerHTML=4*(window.REFRESH_RATE||60)+" fps",e("config_electron_vsync").classList.toggle("checked",!!window.VSYNC_ON),e("config_electron_frameratelimit").classList.toggle("disable-cfg",!!window.VSYNC_ON),et("config_electron"))})),e("config_export").addEventListener("click",(function(e){const t=new Blob([JSON.stringify(te)],{type:"application/json"}),s=document.createElement("a");s.download="config.ttc",s.href=(window.webkitURL||window.URL).createObjectURL(t),s.dataset.downloadurl=["application/json",s.download,s.href].join(":"),document.body.appendChild(s),s.click(),document.body.removeChild(s)})),e("play_solo").addEventListener("click",(function(e){et("play1p")})),e("sig_about").addEventListener("click",(function(e){et("about")})),e("about_blog").addEventListener("click",(function(e){window.open("https://blog.osk.sh/","_blank")})),e("about_issues").addEventListener("click",(function(e){window.open("https://github.com/tetrio/issues","_blank")})),e("about_discord").addEventListener("click",(function(e){window.open("https://l.tetr.io/discord","_blank")})),e("about_harddrop").addEventListener("click",(function(e){window.open("https://discord.gg/harddrop","_blank")})),e("about_legal").addEventListener("click",(function(e){window.open("/about/","_blank")})),e("about_support").addEventListener("click",(function(e){window.open("/about/support/","_blank")})),e("about_patchnotes").addEventListener("click",(function(e){window.open("/about/patchnotes/","_blank")})),e("about_music").addEventListener("click",(function(e){it((e=>{Ps.playSmoothOrRandom(e)}))})),e("about_supporter").addEventListener("click",(function(e){Ke()})),e("about_desktop").addEventListener("click",(function(e){window.open("/about/desktop/","_blank")})),e("footer_github").addEventListener("click",(function(e){window.open("https://github.com/tetrio/issues","_blank")})),e("footer_discord").addEventListener("click",(function(e){window.open("https://l.tetr.io/discord","_blank")})),e("footer_supporter").addEventListener("click",(function(e){Ke()})),e("footer_twitter").addEventListener("click",(function(e){window.open("https://twitter.com/tetriogame","_blank")})),e("footer_desktop").addEventListener("click",(function(e){window.open("/about/desktop/","_blank")})),e("game_40l").addEventListener("click",(function(e){et("40l")})),e("game_blitz").addEventListener("click",(function(e){et("blitz")})),e("game_zen").addEventListener("click",(function(e){et("zen")})),e("game_custom").addEventListener("click",(function(e){et("custom")})),e("start_40l").addEventListener("click",(()=>{Ut.play40L({song:e("music_picker_40l").getAttribute("data-song")}),fe(!0),e("music_picker_results").setAttribute("data-song",e("music_picker_40l").getAttribute("data-song")),e("music_picker_results").innerHTML=e("music_picker_40l").innerHTML})),e("start_blitz").addEventListener("click",(()=>{Ut.playBlitz({song:"hyper-velocity"}),fe(!0)})),e("start_zen").addEventListener("click",(()=>{Ut.playZen({}),fe(!0)})),e("zen_destroy").addEventListener("click",(()=>{D({title:"DESTROY ZEN PROGRESS?",msg:'you\'ll be reset to LEVEL 1 and 0 SCORE, with an empty board to start anew.</p><p class="modal_also">this cannot be undone.',classes:["crash_modal"],buttons:[{label:"CANCEL",classes:[],callback:e=>{e()}},{label:"RESET ZEN",classes:["pri"],callback:e=>{e(),D({title:"REALLY DESTROY ZEN PROGRESS?",msg:"ARE YOU SURE YOU WON'T REGRET DESTROYING YOUR ZEN PROGRESS???",classes:["crash_modal","shudder"],buttons:[{label:"CANCEL",classes:[],callback:e=>{e()}},{label:"I'M CERTAIN",classes:["pri"],callback:e=>{Ut.resetZen(),Ut.saveZen(Ut.getZen()),I("it's gone!"),e()}}]})}}]})})),e("start_custom").addEventListener("click",(()=>{Ut.playCustom({song:e("music_picker_custom").getAttribute("data-song")}),fe(!0),e("music_picker_results").setAttribute("data-song",e("music_picker_custom").getAttribute("data-song")),e("music_picker_results").innerHTML=e("music_picker_custom").innerHTML})),e("start_results").addEventListener("click",(()=>{Ut.playAgain({song:e("music_picker_results").getAttribute("data-song")}),fe(!0)})),e("sig_config").addEventListener("click",(function(e){et("config")})),document.addEventListener("click",(function(e){e.target.closest("[data-hit]")&&Os.play(`menu${e.target.closest("[data-hit]").getAttribute("data-hit")}`)})),document.addEventListener("mouseover",(function(e){e.target.closest("[data-hover]")&&e.target.closest("[data-hover]").getAttribute("data-hover")&&(!a||!a.closest("[data-hover]")||a&&a.closest("[data-hover]").outerHTML!==e.target.closest("[data-hover]").outerHTML)&&Os.play(`menu${e.target.closest("[data-hover]").getAttribute("data-hover")}`),a=e.target.closest("[data-hover]")})),document.addEventListener("click",(function(e){e.target.classList.contains("collapse_target")&&e.target.closest(".collapsible")&&e.target.closest(".collapsible").classList.toggle("collapsed")})),document.addEventListener("click",(function(e){e.target.classList.contains("music_picker")&&it((t=>{if(e.target.setAttribute("data-song",t),Ps.ost[t])e.target.innerHTML=`${Ps.ost[t].artist.toLowerCase()} - ${Ps.ost[t].name.toLowerCase()}`;else switch(t){case"RANDOM":e.target.innerHTML="RANDOM";break;case"RANDOMcalm":e.target.innerHTML="RANDOM: CALM";break;case"RANDOMbattle":e.target.innerHTML="RANDOM: BATTLE";break;default:e.target.innerHTML=t}e.target.dispatchEvent(new Event("input"))}))})),document.addEventListener("click",(function(e){e.target.classList.contains("replayid")&&Ve(`https://tetr.io/#${e.target.innerHTML}`,"replay link")})),document.addEventListener("click",(function(t){t.target.classList.contains("tab")&&(s(`.tab[data-scope="${t.target.getAttribute("data-scope")}"]`).forEach((e=>{e.classList.remove("pressed"),e.classList.remove("active")})),t.target.classList.add("pressed"),t.target.classList.add("active"),s(`.tab_content[data-scope="${t.target.getAttribute("data-scope")}"]`).forEach((e=>{e.classList.add("hidden")})),t.target.getAttribute("data-target")&&e(t.target.getAttribute("data-target")).classList.remove("hidden"))})),e("list_request_back").addEventListener("click",(function(t){Ae.pop(),e("list_request").classList.add("hidden")})),Be={gravitymode:"relaxed",gravitystatic:20,counters:"off",leveling:"on",garbagemode:"off",cheeselayer_height:6,cheesetimer_interval:4,cheesemessiness:100},document.addEventListener("click",(function(e){e.target.classList.contains("panel_option")&&(e.target.closest(".panel_optionset").querySelectorAll(".panel_option").forEach((e=>{e.classList.remove("selected")})),e.target.classList.add("selected"),Be[e.target.getAttribute("data-key")]=e.target.getAttribute("data-value"),De&&De.pullZenConfig())})),document.addEventListener("input",(function(e){e.target.classList.contains("panel_input")&&(Be[e.target.getAttribute("data-key")]="number"===e.target.getAttribute("type")?parseFloat(e.target.value):e.target.value,De&&De.pullZenConfig())}))})),window.SHOW_SUPPORTER_DIALOG=(e="SUPPORT TETR.IO")=>{Ke(e)};let tt=!1;function st(t){t?(tt||((Xe[ze].onreenter||(()=>{}))(),bt(),tt=t),e("menus").classList.remove("hidden")):(tt&&((Xe[ze].onexit||(()=>{}))(),yt(),tt=t,X.unmountGroup("main")),e("menus").classList.add("hidden"))}function at(){e("list_request").classList.contains("hidden")||(Ae.pop(),e("list_request").classList.add("hidden"))}let nt=()=>{};function ot(t,s,a){nt=s;const n=e("list_request_scroller");for(;n.firstChild;)n.removeChild(n.firstChild);t.forEach((t=>{const s=document.createElement("div");if(s.classList.add("scroller_item"),s.classList.add("ns"),s.setAttribute("data-id",t.id),s.setAttribute("data-hover","tap"),s.setAttribute("data-hit","click"),s.setAttribute("data-keybind",t.key||"X-NOKEY"),n.appendChild(s),t.image){const e=document.createElement("img");e.src=t.image,s.appendChild(e),s.classList.add("has_image")}t.classes&&s.classList.add(...t.classes),t.attributes&&Object.keys(t.attributes).forEach((e=>{s.setAttribute(e,t.attributes[e])}));const a=document.createElement("h1");if(a.innerHTML=t.name,s.appendChild(a),t.description){const e=document.createElement("p");e.innerHTML=t.description,s.appendChild(e),s.classList.add("has_description")}s.addEventListener("click",(function(t){Ae.pop(),e("list_request").classList.add("hidden"),nt(s.getAttribute("data-id"))}))})),e("list_request_back").classList.toggle("hidden",!a),e("list_request").classList.remove("hidden"),Ae.push(),Ae.bindGuide(Ce.list_request)}function it(e){const t=[{id:"RANDOM",name:"RANDOM",description:"pick a completely random BGM for me"},{id:"RANDOMcalm",name:"RANDOM: CALM",description:"pick a random calmer BGM for me"},{id:"RANDOMbattle",name:"RANDOM: BATTLE",description:"pick a random intenser battle BGM for me"}];Object.keys(Ps.ost).forEach((e=>{Ps.ost[e].hidden||t.push({id:e,name:Ps.ost[e].name,description:`${Ps.ost[e].artist} - ${Ps.ost[e].genre}`})})),ot(t,(t=>{e(t)}),!0)}function rt(e){ot([{id:"retry",name:"RETRY",key:"retry"},{id:"back",name:"BACK TO TITLE",key:"exit"}],(t=>{e(t)}))}function lt(){st(!1),et("none"),Ps.stop(),De&&(De.end(),De.destroy(),maingame=void 0)}function ct(t){e("afterloader_text").innerHTML=t,e("afterloader").classList.remove("hidden"),document.activeElement.blur()}function dt(){e("afterloader").classList.add("hidden")}let pt=0;function ut(){pt=(new Date).getTime(),e("kuro").classList.remove("hidden"),document.activeElement.blur()}function mt(e){const t=500-((new Date).getTime()-pt);t<1?e():setTimeout((()=>{e()}),t)}function gt(){mt((()=>{e("kuro").classList.add("hidden")}))}let ht=0,ft=null,_t=!1;function bt(){0===ht&&(document.body.classList.remove("ingame"),document.body.getBoundingClientRect(),ft&&clearTimeout(ft),_t&&Ae.engage()),ht++}function yt(){ht=Math.max(0,ht-1),0===ht&&e("preload").classList.contains("hidden")&&(ft&&clearTimeout(ft),ft=setTimeout((()=>{0===ht&&(document.body.classList.add("ingame"),wt())}),1e3),_t=Ae.isEngaged(),Ae.disengage(),setTimeout((()=>{0===ht&&e("replaytools").classList.contains("hidden")&&X.mountGroup("ingame")}),1))}function vt(e){try{_paq.push(["trackEvent","Advertising","Impression",e])}catch(e){}}function wt(){Math.random()<.5?(e("enter_matchmaking").insertAdjacentElement("beforebegin",e("tetr-io_728x90_6")),e("tetr-io_728x90_6").classList.remove("ceriad_bg_r"),e("tetr-io_728x90_6").classList.add("ceriad_bg_rt"),e("tetr-io_728x90_6").classList.remove("ceriad_mt")):(e("enter_matchmaking").insertAdjacentElement("afterend",e("tetr-io_728x90_6")),e("tetr-io_728x90_6").classList.remove("ceriad_bg_rt"),e("tetr-io_728x90_6").classList.add("ceriad_bg_r"),e("tetr-io_728x90_6").classList.add("ceriad_mt")),Math.random()<.33?e("results_starter_anchor").insertAdjacentElement("beforebegin",e("tetr-io_728x90_7")):Math.random()<.67?e("results_starter_anchor").insertAdjacentElement("afterend",e("tetr-io_728x90_7")):e("results_replayinfo_anchor").insertAdjacentElement("afterend",e("tetr-io_728x90_7")),e("roomview").classList.toggle("ceriad_right_aligned_experiment",Math.random()>=.5)}U.ready((function(s){function a(t){0!==ht&&e("social").classList.contains("hiding")&&e("afterloader").classList.contains("hidden")&&Object.keys(ae).forEach((e=>{if(ae[e].includes(me(t)||t.detail.toUpperCase())&&e.startsWith("menu")){if(("menuConfirm"===e||"menuBack"===e)&&(t.repeat||"gprepeat"===t.type))return;return["input","textarea"].includes(document.activeElement.tagName.toLowerCase())?void(Ae.isEngaged()&&"menuConfirm"===e&&document.activeElement.blur()):(Ae.action(e.substring(4).toLowerCase()),t.stopPropagation(),t.preventDefault(),void(Ae.isEngaged()||(Os.play("ribbon_on"),Ae.engage())))}}))}document.addEventListener("keydown",a,!1),document.addEventListener("gpdown",a,!1),document.addEventListener("gprepeat",a,!1),document.addEventListener("mousemove",(function(e){0!==ht&&Ae.isEngaged()&&(Os.play("ribbon_off"),Ae.disengage())}),{passive:!0}),document.addEventListener("wheel",(function(e){0!==ht&&Ae.isEngaged()&&(Os.play("ribbon_off"),Ae.disengage())}),{passive:!0});let n,o=!0,i=0;window.addEventListener("beforeunload",(function(t){if(window.IS_ELECTRON)if(F)ga&&ga.isConnected()&&ga.abort();else{if(o)return o=!1,i=0,D({title:"EXIT TETR.IO?",msg:"",onskip:()=>{i=0,o=!0},buttons:[{label:"CANCEL",classes:[],callback:e=>{i=0,o=!0,e()}},{label:"EXIT",classes:["pri"],callback:e=>{o=!0,i=0,ga&&ga.isConnected()&&ga.abort(),ut(),ct("see you next time!"),Y()}}]}),t.preventDefault(),t.returnValue="Exit TETR.IO?","Exit TETR.IO?";if(!(++i>=5))return t.preventDefault(),t.returnValue="Exit TETR.IO?","Exit TETR.IO?";ga&&ga.isConnected()&&ga.abort(),Y(),ut(),ct("see you next time!")}else{if(!F&&document.body.classList.contains("ingame_phys")&&e("menus").classList.contains("hidden")&&0===ht)return t.preventDefault(),t.returnValue="You are still ingame. Closing this tab will disconnect you. You will lose the game and may receive a penalty!","You are still ingame. Closing this tab will disconnect you. You will lose the game and may receive a penalty!";ga&&ga.isConnected()&&ga.abort()}})),window.addEventListener("hashchange",(function(e){window.location.href=`/${window.location.hash}`,F=!0,window.location.reload()})),window.addEventListener("focus",(function(e){document.body.classList.remove("nofocus"),wn(),n&&(clearTimeout(n),n=null)})),window.addEventListener("blur",(function(e){document.body.classList.add("nofocus"),n&&(clearTimeout(n),n=null),n=setTimeout((()=>{vn(),n=null}),6e5)})),window.addEventListener("visibilitychange",(function(e){!1!==te.volume.oof&&("visible"===document.visibilityState?Ps.setVolume(te.volume.music):Ps.setVolume(0)),"visible"===document.visibilityState?eo():eo(10)})),e("ingame_chat_input").addEventListener("focus",(function(e){document.body.classList.add("chatfocus")})),e("ingame_chat_input").addEventListener("blur",(function(e){document.body.classList.remove("chatfocus")})),e("menus").addEventListener("dragover",(e=>{e.stopPropagation(),e.preventDefault(),e.dataTransfer.dropEffect="copy"}),!1);let r,l="";function c(t){"results"!==ze||e("menus").classList.contains("hidden")||e("results").classList.contains("isreplay")||1!==ht||Object.keys(ae).forEach((s=>{ae[s].includes(me(t)||t.detail.toUpperCase())&&"retry"===s&&e("start_results").click()}))}function d(t){e("list_request").classList.contains("hidden")||Object.keys(ae).forEach((s=>{ae[s].includes(me(t)||t.detail.toUpperCase())&&e("list_request").querySelectorAll(".scroller_item").forEach((e=>{e.getAttribute("data-keybind")!==s||e.click()}))}))}window.DEVHOOK_LOAD_REPLAY_RAW=t=>{Ut.showResults(t.endcontext,{gametype:t.endcontext.gametype,back:"home",isreplay:!0,username:t.user.username,ts:t.ts,replay:t}),e("results").classList.add("fakereplay"),l=t._id},e("menus").addEventListener("drop",(t=>{t.stopPropagation(),t.preventDefault();const s=t.dataTransfer.files[0];if(!s)return;if(!/\.tt([rpc]|rm)$/.test(s.name))return void T("TETR.IO cannot open this file");if(ga&&!ga.isBackground())return void T("you cannot drop a file onto TETR.IO while connected to live servers");if(document.body.classList.contains("ingame"))return void T("you cannot drop a file onto TETR.IO while ingame");const a=new FileReader;a.onload=()=>{dt();try{const t=JSON.parse(a.result);/\.ttr$/.test(s.name)?(Ut.showResults(t.endcontext,{gametype:t.endcontext.gametype,back:"home",isreplay:!0,username:t.user.username,ts:t.ts,replay:t}),l=t._id,l&&w.get(`/api/games/${encodeURIComponent(t._id)}/exists`).then((s=>{t._id===l&&(s.exists||e("results").classList.add("fakereplay"))}),(e=>{}))):/\.ttrm$/.test(s.name)?(Ut.showMultiLog({...t,back:"home"}),l=t._id,l&&w.get(`/api/games/${encodeURIComponent(t._id)}/exists`).then((s=>{t._id===l&&(s.exists||e("multilogview").classList.add("noreplay"))}),(e=>{}))):/\.ttp$/.test(s.name)?(Ut.setGameOpts(t),I("custom game loaded!")):/\.ttc$/.test(s.name)&&D({title:"IMPORT CONFIG?",msg:'are you sure you wish to import this CONFIG file? it will override your current CONFIG.</p><p class="modal_warning">DO NOT IMPORT A CONFIG YOU DO NOT TRUST!</p><p class="modal_also">your current CONFIG will be lost.',buttons:[{label:"CANCEL",classes:[],callback:e=>{e()}},{label:"IMPORT",classes:["sec"],callback:e=>{e(),Object.assign(te,t),ue(),ce(),I("config loaded. you must hit F5 for all the changes to properly take effect!"),ga&&ga.isConnected()&&ga.updateHandling()}}]})}catch(e){return T("file load failed!"),void console.log(e)}},ct("loading file"),a.readAsText(s)}),!1),document.addEventListener("keydown",(e=>{9===e.keyCode&&e.preventDefault()}),!1),document.addEventListener("keydown",c,!1),document.addEventListener("gpdown",c,!1),document.addEventListener("keydown",d,!1),document.addEventListener("gpdown",d,!1),document.addEventListener("mousemove",(function(e){r?clearTimeout(r):document.body.classList.remove("idlemouse"),r=setTimeout((()=>{document.body.classList.add("idlemouse"),r=null}),5e3)})),t("style.darkreader")&&x({msg:"you seem to be using the extension DARK READER. this extension WILL mess with the TETR.IO interface, and may cause performance issues. please consider disabling it!",color:"#FFD800",icon:"warning",timeout:15e3})}));const kt={hasSupporter:!1,expires:0,total:0};U.ready((function(a){e("config_account").addEventListener("click",(function(a){ct("requesting account data");const n=`SESS-${Math.floor(Math.random()*Number.MAX_SAFE_INTEGER)}`;w.get("/api/server/environment",void 0,{headers:{"X-Session-ID":n}}).then((async a=>{w.get("/api/users/me",void 0,{headers:{"X-Session-ID":n,"X-Connection-ID":await z.esc(Uint8Array.from(atob(a.vx),(e=>e.charCodeAt(0))),Le.get())}}).then((a=>{e("config_account_username").value=a.user.username,e("config_account_username_field").value=a.user.username.toUpperCase(),a.user.avatar_revision?e("config_account_avatar").innerHTML=`<img class="avatar" src="/user-content/avatars/${a.user._id}.jpg?rv=${a.user.avatar_revision}" /> ${a.user.username.toUpperCase()}`:e("config_account_avatar").innerHTML=`<img class="avatar" src="${u(a.user._id)}" /> No avatar set`,e("config_account_banner_link").setAttribute("href",`https://ch.tetr.io/u/${a.user.username}`),e("config_account_bio_link").setAttribute("href",`https://ch.tetr.io/u/${a.user.username}`),a.user.banner_revision?e("config_account_banner").innerHTML=`<img class="banner" src="/user-content/banners/${a.user._id}.jpg?rv=${a.user.banner_revision}" /> ${a.user.username.toUpperCase()}`:e("config_account_banner").innerHTML='<img class="banner" src="/res/banner.png" /> No banner set',e("config_account_bio").value=a.user.bio||"",a.user.email?(e("config_account_email_warning").classList.add("hidden"),e("config_account_email").value=a.user.email):(e("config_account_email_warning").classList.remove("hidden"),e("config_account_email").value=""),e("config_account_privacy_showwon").classList.toggle("checked",!1!==a.user.privacy_showwon),e("config_account_privacy_showplayed").classList.toggle("checked",!1!==a.user.privacy_showplayed),e("config_account_privacy_showgametime").classList.toggle("checked",!1!==a.user.privacy_showgametime),e("config_account_privacy_showcountry").classList.toggle("checked",!1!==a.user.privacy_showcountry),e("config_account_country").innerHTML=`<img class="flag" src="/res/flags/${(a.user.country||"xx").toLowerCase()}.png" /> ${Co[a.user.country||"XX"]}`,kt.hasSupporter=a.user.supporter,kt.expires=a.user.supporter_expires,kt.total=a.user.total_supported,Tt(),t("#account_connection_discord p").innerHTML=a.user.connections.discord?r(a.user.connections.discord.username):"Click to link",e("account_connection_discord").classList.toggle("linked",!!a.user.connections.discord),e("config_account_totp_label").innerHTML=a.user.totp.enabled?"ENABLED":"NOT ENABLED",e("config_account_totp_tokens").innerHTML=a.user.totp.enabled?`you have <b>${a.user.totp.codes_remaining}</b>/8 recovery codes remaining.`:"",e("config_account_totp_enable").classList.toggle("hidden",!!a.user.totp.enabled),e("config_account_totp_resetrecovery").classList.toggle("hidden",!a.user.totp.enabled),e("config_account_totp_disable").classList.toggle("hidden",!a.user.totp.enabled),document.body.classList.toggle("uses2fa",!!a.user.totp&&!!a.user.totp.enabled),s(".config_account_privacy_privatemode").forEach((e=>{e.classList.toggle("pressed",e.id===`config_account_privacy_privatemode_${a.user.privacy_privatemode||"public"}`)})),s(".config_account_privacy_status_shallow").forEach((e=>{e.classList.toggle("pressed",e.id===`config_account_privacy_status_shallow_${a.user.privacy_status_shallow||"everyone"}`)})),e("config_account_privacy_status_deep_friends").classList.toggle("disabled","nobody"===a.user.privacy_status_shallow),e("config_account_privacy_status_deep_everyone").classList.toggle("disabled",["nobody","friends"].includes(a.user.privacy_status_shallow)),s(".config_account_privacy_status_deep").forEach((e=>{e.classList.toggle("pressed",e.id===`config_account_privacy_status_deep_${a.user.privacy_status_deep||"everyone"}`)})),e("config_account_privacy_status_exact_friends").classList.toggle("disabled","nobody"===a.user.privacy_status_deep),e("config_account_privacy_status_exact_everyone").classList.toggle("disabled",["nobody","friends"].includes(a.user.privacy_status_deep)),s(".config_account_privacy_status_exact").forEach((e=>{e.classList.toggle("pressed",e.id===`config_account_privacy_status_exact_${a.user.privacy_status_exact||"friends"}`)})),s(".config_account_privacy_dm").forEach((e=>{e.classList.toggle("pressed",e.id===`config_account_privacy_dm_${a.user.privacy_dm||"everyone"}`)})),document.body.classList.toggle("dmfriendonly","everyone"!==(a.user.privacy_dm||"everyone")),s(".config_account_privacy_invite").forEach((e=>{e.classList.toggle("pressed",e.id===`config_account_privacy_invite_${a.user.privacy_invite||"friends"}`)})),dt(),et("config_account")}),(e=>{dt(),S(e)}))}),(e=>{dt(),S(e)}))})),e("config_account_supporter_support").addEventListener("click",(function(e){Ke()})),e("config_account_logout").addEventListener("click",(function(t){document.body.classList.contains("trapped")||"Attempting to bypass a ban will escalate it to a permanent ban."===localStorage.getItem("trapped")?D({title:"AS A STERN REMINDER",msg:'IF YOU HAVE BEEN SILENCED, RESTRICTED OR OTHERWISE BANNED, YOU MAY NEVER SWITCH TO ANOTHER ACCOUNT TO EVADE THE BAN. THIS INCLUDES SWITCHING TO AN ANONYMOUS ACCOUNT. EVADING A BAN MAKES IT PERMANENT.</p><p class="modal_warning">exceptions apply if the ban was not meant for you, or when logging out of an alternate account. for more info, read the <a href="/about/rules/" target="_blank">community rules</a>.',classes:["crash_modal","noclickout"],buttons:[{label:"CANCEL",classes:[],callback:e=>{e()}},{label:"I'M NOT EVADING!",classes:["pri"],callback:e=>{ut(),ct("see you next time!"),z.logout(),U.update(!0)}}]}):D({title:"LOG OUT?",msg:`log out from <span class="inline_self">${e("config_account_username_field").value}</span>?`,buttons:[{label:"CANCEL",classes:[],callback:e=>{e()}},{label:"LOG OUT",classes:["pri"],callback:e=>{ut(),ct("see you next time!"),z.logout(),U.update(!0)}}]})})),e("config_account_logoutall").addEventListener("click",(function(t){document.body.classList.contains("trapped")||"Attempting to bypass a ban will escalate it to a permanent ban."===localStorage.getItem("trapped")?D({title:"AS A STERN REMINDER",msg:'IF YOU HAVE BEEN SILENCED, RESTRICTED OR OTHERWISE BANNED, YOU MAY NEVER SWITCH TO ANOTHER ACCOUNT TO EVADE THE BAN. THIS INCLUDES SWITCHING TO AN ANONYMOUS ACCOUNT. EVADING A BAN MAKES IT PERMANENT.</p><p class="modal_warning">exceptions apply if the ban was not meant for you, or when logging out of an alternate account. for more info, read the <a href="/about/rules/" target="_blank">community rules</a>.',classes:["crash_modal","noclickout"],buttons:[{label:"CANCEL",classes:[],callback:e=>{e()}},{label:"I'M NOT EVADING!",classes:["pri"],callback:e=>{ut(),ct("logging out all"),w.post("/api/users/cycle").then((e=>{ct("see you next time!"),z.logout(),U.update(!0)}),(e=>{dt(),S(e)}))}}]}):D({title:"LOG OUT ALL?",msg:`log out all devices logged into <span class="inline_self">${e("config_account_username_field").value}</span>, including this one? this will disconnect you everywhere - use it if you forgot to log out somewhere.`,buttons:[{label:"CANCEL",classes:[],callback:e=>{e()}},{label:"LOG OUT ALL",classes:["sec"],callback:e=>{ut(),ct("logging out all"),w.post("/api/users/cycle").then((e=>{ct("see you next time!"),z.logout(),U.update(!0)}),(e=>{dt(),S(e)}))}}]})})),e("config_account_password_save").addEventListener("click",(function(t){const s=e("config_account_password").value,a=e("config_account_password_again").value;s?s===a?z.requestPassword(((t,a)=>{ct("saving new account data"),w.post("/api/users/setPassword",{old:t,new:s,totp:a}).then((t=>{e("config_account_password").value="",e("config_account_password_again").value="",I("password changed!"),ct("see you next time!"),z.logout(),U.update(!0)}),(e=>{dt(),S(e)}))})):T("those passwords don't match"):T("you must enter a new password")})),e("config_account_privacy_showwon").addEventListener("click",(function(t){e("config_account_privacy_showwon").classList.toggle("checked")})),e("config_account_privacy_showplayed").addEventListener("click",(function(t){e("config_account_privacy_showplayed").classList.toggle("checked")})),e("config_account_privacy_showgametime").addEventListener("click",(function(t){e("config_account_privacy_showgametime").classList.toggle("checked")})),e("config_account_privacy_showcountry").addEventListener("click",(function(t){e("config_account_privacy_showcountry").classList.toggle("checked")})),e("config_account_privacy_privatemode_private").addEventListener("click",(function(e){s(".config_account_privacy_privatemode").forEach((t=>{t.classList.toggle("pressed",t.id===e.target.id)}))})),e("config_account_privacy_privatemode_public").addEventListener("click",(function(e){s(".config_account_privacy_privatemode").forEach((t=>{t.classList.toggle("pressed",t.id===e.target.id)}))})),e("config_account_privacy_status_shallow_nobody").addEventListener("click",(function(t){s(".config_account_privacy_status_shallow").forEach((e=>{e.classList.toggle("pressed",e.id===t.target.id)})),e("config_account_privacy_status_deep_friends").classList.add("disabled"),e("config_account_privacy_status_deep_everyone").classList.add("disabled"),e("config_account_privacy_status_deep_friends").classList.contains("pressed")&&e("config_account_privacy_status_deep_nobody").click(),e("config_account_privacy_status_deep_everyone").classList.contains("pressed")&&e("config_account_privacy_status_deep_nobody").click()})),e("config_account_privacy_status_shallow_friends").addEventListener("click",(function(t){s(".config_account_privacy_status_shallow").forEach((e=>{e.classList.toggle("pressed",e.id===t.target.id)})),e("config_account_privacy_status_deep_friends").classList.remove("disabled"),e("config_account_privacy_status_deep_everyone").classList.add("disabled"),e("config_account_privacy_status_deep_everyone").classList.contains("pressed")&&e("config_account_privacy_status_deep_friends").click()})),e("config_account_privacy_status_shallow_everyone").addEventListener("click",(function(t){s(".config_account_privacy_status_shallow").forEach((e=>{e.classList.toggle("pressed",e.id===t.target.id)})),e("config_account_privacy_status_deep_friends").classList.remove("disabled"),e("config_account_privacy_status_deep_everyone").classList.remove("disabled")})),e("config_account_privacy_status_deep_nobody").addEventListener("click",(function(t){s(".config_account_privacy_status_deep").forEach((e=>{e.classList.toggle("pressed",e.id===t.target.id)})),e("config_account_privacy_status_exact_friends").classList.add("disabled"),e("config_account_privacy_status_exact_everyone").classList.add("disabled"),e("config_account_privacy_status_exact_friends").classList.contains("pressed")&&e("config_account_privacy_status_exact_nobody").click(),e("config_account_privacy_status_exact_everyone").classList.contains("pressed")&&e("config_account_privacy_status_exact_nobody").click()})),e("config_account_privacy_status_deep_friends").addEventListener("click",(function(t){s(".config_account_privacy_status_deep").forEach((e=>{e.classList.toggle("pressed",e.id===t.target.id)})),e("config_account_privacy_status_exact_friends").classList.remove("disabled"),e("config_account_privacy_status_exact_everyone").classList.add("disabled"),e("config_account_privacy_status_exact_everyone").classList.contains("pressed")&&e("config_account_privacy_status_exact_friends").click()})),e("config_account_privacy_status_deep_everyone").addEventListener("click",(function(t){s(".config_account_privacy_status_deep").forEach((e=>{e.classList.toggle("pressed",e.id===t.target.id)})),e("config_account_privacy_status_exact_friends").classList.remove("disabled"),e("config_account_privacy_status_exact_everyone").classList.remove("disabled")})),e("config_account_privacy_status_exact_nobody").addEventListener("click",(function(e){s(".config_account_privacy_status_exact").forEach((t=>{t.classList.toggle("pressed",t.id===e.target.id)}))})),e("config_account_privacy_status_exact_friends").addEventListener("click",(function(e){s(".config_account_privacy_status_exact").forEach((t=>{t.classList.toggle("pressed",t.id===e.target.id)}))})),e("config_account_privacy_status_exact_everyone").addEventListener("click",(function(e){s(".config_account_privacy_status_exact").forEach((t=>{t.classList.toggle("pressed",t.id===e.target.id)}))})),e("config_account_privacy_dm_nobody").addEventListener("click",(function(e){s(".config_account_privacy_dm").forEach((t=>{t.classList.toggle("pressed",t.id===e.target.id)})),document.body.classList.add("dmfriendonly")})),e("config_account_privacy_dm_friends").addEventListener("click",(function(e){s(".config_account_privacy_dm").forEach((t=>{t.classList.toggle("pressed",t.id===e.target.id)})),document.body.classList.add("dmfriendonly")})),e("config_account_privacy_dm_everyone").addEventListener("click",(function(e){s(".config_account_privacy_dm").forEach((t=>{t.classList.toggle("pressed",t.id===e.target.id)})),document.body.classList.remove("dmfriendonly")})),e("config_account_privacy_invite_nobody").addEventListener("click",(function(e){s(".config_account_privacy_invite").forEach((t=>{t.classList.toggle("pressed",t.id===e.target.id)}))})),e("config_account_privacy_invite_friends").addEventListener("click",(function(e){s(".config_account_privacy_invite").forEach((t=>{t.classList.toggle("pressed",t.id===e.target.id)}))})),e("config_account_privacy_invite_everyone").addEventListener("click",(function(e){s(".config_account_privacy_invite").forEach((t=>{t.classList.toggle("pressed",t.id===e.target.id)}))})),e("config_account_email_save").addEventListener("click",(function(t){const s=e("config_account_email").value;s?z.requestPassword(((t,a)=>{ct("saving new account data"),w.post("/api/users/setEmail",{password:t,email:s,totp:a}).then((t=>{I("email changed!"),e("config_account_email_warning").classList.add("hidden"),dt()}),(e=>{dt(),S(e)}))})):T("you must enter a new email")})),e("config_account_privacy_save").addEventListener("click",(function(t){ct("saving new account data"),w.post("/api/users/setPreferences",{privacy_showwon:e("config_account_privacy_showwon").classList.contains("checked"),privacy_showplayed:e("config_account_privacy_showplayed").classList.contains("checked"),privacy_showgametime:e("config_account_privacy_showgametime").classList.contains("checked"),privacy_showcountry:e("config_account_privacy_showcountry").classList.contains("checked"),privacy_privatemode:e("config_account_privacy_privatemode_private").classList.contains("pressed")?"private":"public",privacy_status_shallow:e("config_account_privacy_status_shallow_nobody").classList.contains("pressed")?"nobody":e("config_account_privacy_status_shallow_friends").classList.contains("pressed")?"friends":"everyone",privacy_status_deep:e("config_account_privacy_status_deep_nobody").classList.contains("pressed")?"nobody":e("config_account_privacy_status_deep_friends").classList.contains("pressed")?"friends":"everyone",privacy_status_exact:e("config_account_privacy_status_exact_nobody").classList.contains("pressed")?"nobody":e("config_account_privacy_status_exact_friends").classList.contains("pressed")?"friends":"everyone",privacy_dm:e("config_account_privacy_dm_nobody").classList.contains("pressed")?"nobody":e("config_account_privacy_dm_friends").classList.contains("pressed")?"friends":"everyone",privacy_invite:e("config_account_privacy_invite_nobody").classList.contains("pressed")?"nobody":e("config_account_privacy_invite_friends").classList.contains("pressed")?"friends":"everyone"}).then((e=>{I("privacy preferences changed!"),dt()}),(e=>{dt(),S(e)}))})),e("config_account_country_change").addEventListener("click",(function(t){if(qe())return;const s=[];Object.keys(Co).forEach((e=>{["XX","XM"].includes(e)||s.push({id:e,name:`<img class="flag" style="height: 0.88em; vertical-align: middle;" src="/res/flags/${e.toLowerCase()}.png" /> <span class="i18n_mono">${Co[e]}</span>`,description:e})})),ot(s,(t=>{ct("saving new account data"),w.post("/api/users/setCountry",{country:t}).then((s=>{e("config_account_country").innerHTML=`<img class="flag" src="/res/flags/${t.toLowerCase()}.png" /> ${Co[t]}`,I("country changed!"),dt()}),(e=>{dt(),S(e)}))}),!0)})),e("config_account_username_save").addEventListener("click",(function(t){if(qe())return;const s=e("config_account_username").value;s&&s!==z.username()?D({title:"CHANGE USERNAME?",msg:`change your username from <span class="inline_self">${e("config_account_username_field").value}</span> to <span class="inline_self">${r(s.toUpperCase())}</span>? this will log you out everywhere, and your previous username will be freed. this process will try to rename everywhere it can, but some links may be broken.</p><p class="modal_also">you can do this only once a month.`,buttons:[{label:"CANCEL",classes:[],callback:e=>{e()}},{label:"CHANGE IT!",classes:["sec"],callback:e=>{e(),z.requestPassword(((e,t)=>{ct("changing username"),w.post("/api/users/setUsername",{password:e,username:s,totp:t}).then((e=>{D({title:"USERNAME CHANGED",msg:"your username was changed successfully. from now on, you must log in using your new username.",classes:["noclickout"],buttons:[{label:"GOT IT!",classes:["pri"],callback:e=>{ut(),ct("see you next time!"),z.changeUsername(s),U.update(!0)}}]}),dt()}),(e=>{dt(),S(e)}))}))}}]}):T("you must enter a new username")}));let o=!1;window.DEVHOOK_BYPASS_NSFW_CHECK=()=>{console.log("%cYou have just DISABLED the NSFW check temporarily. The purpose of this console command is ONLY to allow you to upload false positives.","color: #FFFFFF;\n\t\t\t\t\t\t\t display: block;\n\t\t\t\t\t\t\t font-size: 1.2em;\n\t\t\t\t\t\t\t font-weight: 900;\n\t\t\t\t\t\t\t text-shadow: 0px 0px 2px #FFFFFF;\n\t\t\t\t\t\t\t background-color: #FF0000;\n\t\t\t\t\t\t\t padding: 0 1em;\n\t\t\t\t\t\t\t border-radius: 3px;"),console.log("%cUPLOADING EXPLICIT IMAGES WILL GET YOUR ACCOUNT RESTRICTED. UNDERSTOOD?","color: #FF0000;\n\t\t\t\t\t\t\t display: block;\n\t\t\t\t\t\t\t font-size: 1.2em;\n\t\t\t\t\t\t\t font-weight: 900;\n\t\t\t\t\t\t\t text-shadow: 0px 0px 2px #FF0000;\n\t\t\t\t\t\t\t background-color: #FFFF00;\n\t\t\t\t\t\t\t padding: 0 1em;\n\t\t\t\t\t\t\t border-radius: 3px;"),o=!0},e("config_account_avatar_change").addEventListener("click",(function(t){Pe.request((()=>{ct("setting avatar")})).then((t=>{if(2===t.safetyLevel&&!o)return console.log(t.predictions),dt(),void D({title:"IMAGE REJECTED",msg:'this image was detected as potentially explicit. you must use a different image.</p><p class="modal_also">using an explicit avatar will get your account restricted.',classes:["noclickout","crash_modal"],buttons:[{label:"GOT IT",classes:["pri"],callback:e=>{e()}}]});const s=()=>{const s=new FormData;s.append("file",t.image),w.post("/api/upload/avatar",s).then((t=>{e("config_account_avatar").innerHTML=`<img class="avatar" src="/user-content/avatars/${z.id()}.jpg?rv=${t.avatar_revision}" /> ${z.username().toUpperCase()}`,e("me_avatar").setAttribute("src",`/user-content/avatars/${z.id()}.jpg?rv=${t.avatar_revision}`),I("avatar updated!"),dt()}),(e=>{dt(),S(e)}))};1===t.safetyLevel||o?D({title:"WARNING",msg:"are you sure you wish to upload this avatar? by uploading an avatar, you understand that if this avatar is deemed explicit, your account will be restricted.",classes:["noclickout"],buttons:[{label:"CANCEL",classes:[],callback:e=>{dt(),e()}},{label:"CONTINUE",classes:["pri"],callback:e=>{s(),e()}}]}):s()})).catch((e=>{console.error(e),dt(),T("string"==typeof e?e:"sorry, that file cannot be uploaded")}))})),e("config_account_avatar_remove").addEventListener("click",(function(t){D({title:"REMOVE AVATAR",msg:"remove your avatar? it'll be replaced by a generic identicon.",classes:[],buttons:[{label:"CANCEL",classes:[],callback:e=>{e()}},{label:"REMOVE",classes:["sec"],callback:t=>{t(),ct("removing avatar"),w.post("/api/users/removeAvatar").then((t=>{e("config_account_avatar").innerHTML=`<img class="avatar" src="${u(z.id())}" /> No avatar set`,e("me_avatar").setAttribute("src",u(z.id())),I("avatar removed!"),dt()}),(e=>{dt(),S(e)}))}}]})})),e("config_account_banner_change").addEventListener("click",(function(t){qe()||Pe.request((()=>{ct("setting banner")})).then((t=>{if(2===t.safetyLevel&&!o)return console.log(t.predictions),dt(),void D({title:"IMAGE REJECTED",msg:"this image was detected as potentially explicit. please use a different image.",classes:["noclickout","crash_modal"],buttons:[{label:"GOT IT",classes:["pri"],callback:e=>{e()}}]});const s=new FormData;s.append("file",t.image),w.post("/api/upload/banner",s).then((t=>{e("config_account_banner").innerHTML=`<img class="banner" src="/user-content/banners/${z.id()}.jpg?rv=${t.banner_revision}" /> ${z.username().toUpperCase()}`,I("banner updated!"),dt()}),(e=>{dt(),S(e)}))})).catch((e=>{console.error(e),dt(),T("string"==typeof e?e:"sorry, that file cannot be uploaded")}))})),e("config_account_banner_remove").addEventListener("click",(function(t){qe()||D({title:"REMOVE BANNER",msg:"remove your banner?",classes:[],buttons:[{label:"CANCEL",classes:[],callback:e=>{e()}},{label:"REMOVE",classes:["sec"],callback:t=>{t(),ct("removing banner"),w.post("/api/users/removeBanner").then((t=>{e("config_account_banner").innerHTML='<img class="banner" src="/res/banner.png" /> No banner set',I("banner removed!"),dt()}),(e=>{dt(),S(e)}))}}]})})),e("config_account_bio_save").addEventListener("click",(function(t){if(qe())return;const s=(e("config_account_bio").value||"").trim();ct("saving new bio"),w.post("/api/users/setBio",{bio:s}).then((e=>{I("bio changed!"),dt()}),(e=>{dt(),S(e)}))})),e("config_account_delete").addEventListener("click",(function(t){e("config_account_email_warning").classList.contains("hidden")?Re():T("you must set an email before deleting your account.")})),e("config_account_totp_enable").addEventListener("click",(function(t){ct("generating tokens"),w.post("/api/users/initialize2fa").then((t=>{dt(),D({title:"ENABLE TWO-FACTOR AUTHENTICATION",msg:`scan the following QR code with your favourite authenticator app (like AUTHY or GOOGLE AUTHENTICATOR), then enter the six-digit code into the box below to enable two-factor authentication<br><br><center><img src="${r(t.qr)}" /></center><br><br><input data-escape="totp_enable_cancel" data-enter="totp_enable_submit" id="totp_enable" placeholder="six digits" class="mono_input centered_input" autocomplete="off">`,classes:["wide_modal"],buttons:[{label:"CANCEL",classes:[],id:"totp_enable_cancel",callback:e=>{e()}},{label:"SUBMIT",classes:["pri"],id:"totp_enable_submit",callback:t=>{t();const s=e("totp_enable").value;z.requestPassword((t=>{ct("saving"),w.post("/api/users/enable2fa",{password:t,totp:s}).then((t=>{dt(),I("two-factor authentication enabled!"),e("config_account_totp_label").innerHTML="ENABLED",e("config_account_totp_tokens").innerHTML="you have <b>8</b>/8 recovery codes remaining.",e("config_account_totp_enable").classList.add("hidden"),e("config_account_totp_resetrecovery").classList.remove("hidden"),e("config_account_totp_disable").classList.remove("hidden"),document.body.classList.add("uses2fa"),D({title:"TWO-FACTOR AUTHENTICATION ENABLED",msg:`you've successfully enabled two-factor authentication. now every time you log in, you'll be asked to enter one of those six-digit codes. if you don't have access to your device, you can use one of these codes in place of the 6-digit code:<br><center style="font-family: 'PFW'; font-size: 1.5em;">${t.recoveryTokens.join(" ")}</center><br>write these down! if you don't have them, and lose access to your device, you won't be able to log in. each of these tokens can only be used once, but you can create new ones at any time. keep them safe!!!`,classes:["wide_modal"],buttons:[{label:"I'VE WRITTEN THEM DOWN!",classes:[],callback:e=>{e()}}]})}),(e=>{dt(),S(e)}))}))}}]}),e("request_password").focus()}),(e=>{dt(),S(e)}))})),e("config_account_totp_resetrecovery").addEventListener("click",(function(t){z.requestPassword(((t,s)=>{ct("resetting recovery codes"),w.post("/api/users/reset2fa",{password:t,totp:s}).then((t=>{dt(),e("config_account_totp_tokens").innerHTML="you have <b>8</b>/8 recovery codes remaining.",D({title:"RECOVERY CODES RESET",msg:`here are your new recovery codes, which you may use in place of the 6-digit code:<br><center style="font-family: 'PFW'; font-size: 1.5em;">${t.recoveryTokens.join(" ")}</center><br>write these down! if you don't have them, and lose access to your device, you won't be able to log in. each of these tokens can only be used once, but you can create new ones at any time. keep them safe!!!`,classes:["wide_modal"],buttons:[{label:"I'VE WRITTEN THEM DOWN!",classes:[],callback:e=>{e()}}]})}),(e=>{dt(),S(e)}))}))})),e("config_account_totp_disable").addEventListener("click",(function(t){z.requestPassword(((t,s)=>{ct("disabling two-factor authentication"),w.post("/api/users/disable2fa",{password:t,totp:s}).then((t=>{dt(),I("two-factor authentication disabled!"),e("config_account_totp_label").innerHTML="NOT ENABLED",e("config_account_totp_tokens").innerHTML="",e("config_account_totp_enable").classList.remove("hidden"),e("config_account_totp_resetrecovery").classList.add("hidden"),e("config_account_totp_disable").classList.add("hidden"),document.body.classList.remove("uses2fa")}),(e=>{dt(),S(e)}))}))})),e("config_account_orders").addEventListener("click",(function(t){ct("requesting orders"),w.get("/api/orders/get").then((t=>{let s='<div class="centered_block np"><p id="extra_line"><b>Need help?</b> <a href="https://help.xsolla.com/" target="_blank">This page will guide you through the most common problems</a>.</p><p id="extra_line"><b>See something out of the ordinary?</b> <a href="https://refunds.xsolla.com/" target="_blank">Request a refund</a> or <a href="https://xsolla.com/refund-policy/flexible-policy" target="_blank">view our refund policy</a>.</p></div>';t.orders.forEach((e=>{s+=`<div class="scroller_block order_listing_item ns">\n\t\t\t\t\t<table class="keypairs ns" style="font-family: 'C';">\n\t\t\t\t\t\t<tr>\n\t\t\t\t\t\t\t<td>Status</td>\n\t\t\t\t\t\t\t<td><img style="height: 1em; vertical-align: -10%;" src="/res/orders/orders_${Lt[e.status]}.png" /> <b>${Et[e.status]}</b></td>\n\t\t\t\t\t\t</tr>\n\t\t\t\t\t\t<tr>\n\t\t\t\t\t\t\t<td>Description</td>\n\t\t\t\t\t\t\t<td><i>${r(e.description)}</i></td>\n\t\t\t\t\t\t</tr>\n\t\t\t\t\t\t<tr>\n\t\t\t\t\t\t\t<td>Price (excluding taxes and fees)</td>\n\t\t\t\t\t\t\t<td>${r(e.currency)} <b>${e.price.toLocaleString("en-US",{style:"currency",currency:"EUR"})}</b></td>\n\t\t\t\t\t\t</tr>\n\t\t\t\t\t\t<tr>\n\t\t\t\t\t\t\t<td>Payment total (including taxes and fees)</td>\n\t\t\t\t\t\t\t<td>${e.payment&&e.payment.amount?`${r(e.payment.currency)} <b>${e.payment.amount.toLocaleString("en-US",{style:"currency",currency:e.payment.currency})}</b>`:"(unknown)"}</td>\n\t\t\t\t\t\t</tr>\n\t\t\t\t\t\t<tr>\n\t\t\t\t\t\t\t<td>Transaction number</td>\n\t\t\t\t\t\t\t<td>${e.providerid?`<b>${r(e.providerid)}</b>`:"(not paid yet)"}</td>\n\t\t\t\t\t\t</tr>\n\t\t\t\t\t\t<tr>\n\t\t\t\t\t\t\t<td>Merchant</td>\n\t\t\t\t\t\t\t<td>${e.provider?xt[e.provider]:"(not paid yet)"}</td>\n\t\t\t\t\t\t</tr>\n\t\t\t\t\t\t<tr>\n\t\t\t\t\t\t\t<td>Created</td>\n\t\t\t\t\t\t\t<td>${new Date(e.ts).toLocaleString()}, ${n(new Date(e.ts).getTime())} ago</td>\n\t\t\t\t\t\t</tr>\n\t\t\t\t\t\t<tr>\n\t\t\t\t\t\t\t<td>Last updated</td>\n\t\t\t\t\t\t\t<td>${new Date(e.updated).toLocaleString()}, ${n(new Date(e.updated).getTime())} ago</td>\n\t\t\t\t\t\t</tr>\n\t\t\t\t\t</table>\n\t\t\t\t</div>`})),t.orders.length||(s='<div class="scroller_block ns nothing">NO ORDERS</div>'),e("config_order_list").innerHTML=s,dt(),et("config_account_orders")}),(e=>{dt(),S(e)}))})),e("account_connection_discord").addEventListener("click",(function(s){if(e("account_connection_discord").classList.contains("linked"))return ct("unlinking"),void w.post("/api/connect/discord/remove").then((s=>{dt(),I("unlinked!"),t("#account_connection_discord p").innerHTML="Click to link",e("account_connection_discord").classList.remove("linked")}),(e=>{dt(),S(e)}));ct("starting linking process"),w.get("/api/connect/discord").then((e=>{dt(),window.open(e.link,"_blank")}),(e=>{dt(),S(e)}))}))}));const Lt={new:"new",pending:"pending",processing:"processing",complete:"complete",retrying:"retrying",refunding:"processing",refunded:"refunded",retrying_refund:"retrying"},Et={new:"NEW",pending:"PENDING",processing:"PROCESSING",complete:"COMPLETE",retrying:"RETRYING",refunding:"REFUNDING",refunded:"REFUNDED",retrying_refund:"RETRYING REFUND"},xt={xsolla:"Xsolla"};function Tt(){const t=kt.hasSupporter?(kt.expires-Date.now())/2592e6:0;e("config_account_supporter_star").setAttribute("src",kt.hasSupporter?"/res/supporter-tag-shiny.png":"/res/supporter-tag-dead.png"),e("config_account_supporter_bar").setAttribute("style",`--progress: ${t/3*100}%;`),e("config_account_supporter_bar").setAttribute("title",kt.expires?`Expires ${new Date(kt.expires).toLocaleString()}`:""),e("config_account_supporter_bar").classList.toggle("noglow",!kt.hasSupporter),e("config_account_supporter_bar").innerHTML=kt.hasSupporter?`Your supporter status expires in <b>${n(kt.expires)}</b>.`:kt.expires?`Your supporter status expired <b>${n(kt.expires)}</b> ago.`:"You are currently not a supporter.",e("config_account_supporter_details").innerHTML=kt.total?`You have contributed <b>${kt.total.toLocaleString("en-US")}</b> to TETR.IO development so far &mdash; thank you so much!`:"Become a supporter or gift supporter status today and directly support TETR.IO development!",e("config_account_supporter_support").innerHTML=kt.hasSupporter?"ADD MONTHS OR GIFT":"SUPPORT OR GIFT"}function It(){localStorage.getItem("emailNagHiddenUntil")&&Date.now()<parseInt(localStorage.getItem("emailNagHiddenUntil"))||D({title:"hey, you haven't set an email yet!",msg:'adding an email keeps your account safe and ensures you can get back into it if you lose the password. just type your email in the box below, and it\'ll be attached to your account.<br><input type="email" class="mono_input" data-escape="emailnag_cancel" data-enter="emailnag_submit" id="emailnag" placeholder="email" value=""></p><p class="modal_also">we\'ll never send you spam or sell your email address.</p><p class="modal_warning">without an email on your account, if you forget your password, you will have no way to recover your account!',buttons:[{label:"NAH, NOT NOW",classes:[],id:"emailnag_cancel",callback:e=>{localStorage.setItem("emailNagHiddenUntil",Date.now()+1296e6),x("you can set your email under CONFIG > ACCOUNT. don't say we didn't warn you!"),e()}},{label:"SUBMIT",classes:["pri"],id:"emailnag_submit",callback:t=>{const s=e("emailnag").value;s?(t(),z.requestPassword(((t,a)=>{ct("setting your email"),w.post("/api/users/setEmail",{password:t,email:s,totp:a}).then((t=>{I("email attached! thank you for keeping your account safe."),e("config_account_email_warning").classList.add("hidden"),dt()}),(e=>{dt(),S(e)}))}))):T("you must enter a new email")}}]})}U.ready((function(t){e("sig_channel").addEventListener("click",(function(e){et("tetra")})),e("tetra_standalone").addEventListener("click",(function(e){window.open("https://ch.tetr.io/","_blank")})),e("tetra_leaderboards").addEventListener("click",(function(e){et("tetra_records")})),e("tetra_me").addEventListener("click",(function(e){et("tetra_me")})),e("tetra_players").addEventListener("click",(function(e){et("tetra_players"),Xe.tetra_players.back="tetra"})),e("tetra_jump_leaderboards").addEventListener("click",(function(t){window.open("https://ch.tetr.io/s/"+(e("tetra_records_40l").classList.contains("pressed")?"40l_global":"blitz_global"),"_blank")})),e("tetra_jump_mypage").addEventListener("click",(function(e){window.open(`https://ch.tetr.io/u/${z.username()}`,"_blank")})),e("tetra_jump_players").addEventListener("click",(function(t){window.open("https://ch.tetr.io/players/"+(e("tetra_players_league").classList.contains("pressed")?"":"xp"),"_blank")})),e("tetra_jump_40l").addEventListener("click",(function(e){window.open("https://ch.tetr.io/s/40l_global","_blank")})),e("tetra_jump_blitz").addEventListener("click",(function(e){window.open("https://ch.tetr.io/s/blitz_global","_blank")})),e("tetra_jump_tl").addEventListener("click",(function(e){window.open("https://ch.tetr.io/players/","_blank")})),e("tetra_find").addEventListener("keydown",(function(t){if(t.repeat)return;if("Enter"!==t.code&&"NumpadEnter"!==t.code)return;Os.play("menuclick"),t.target.blur();const s=e("tetra_find").value.replace("https://tetr.io/#","").replace("tetrio://","");s.startsWith("r:")?Ds.navigateToLongID(s):Ds.navigateToShortID(s),t.preventDefault(),t.stopPropagation()})),e("me").addEventListener("click",(function(e){Ns({userID:z.id()})})),document.addEventListener("click",(function(t){let s;if(t.target.closest(".tetra_pop"))s=t.target.closest(".tetra_pop"),Ns({username:s.getAttribute("data-username")}),t.stopPropagation(),t.preventDefault();else if(t.target.closest(".dialog_pop"))s=t.target.closest(".dialog_pop"),D({title:s.getAttribute("data-title"),msg:atob(s.getAttribute("data-content")),classes:["patchnotes","wide_modal"],buttons:[{label:"OK",classes:[],callback:e=>{e()}}]}),t.stopPropagation(),t.preventDefault();else if(t.target.closest(".supporter_pop"))s=t.target.closest(".supporter_pop"),Ke(s.getAttribute("data-title")||"SUPPORT TETR.IO"),t.stopPropagation(),t.preventDefault();else if(t.target.closest(".replay_pop"))s=t.target.closest(".replay_pop"),Ds.navigateToShortID(s.getAttribute("data-replay")),t.stopPropagation(),t.preventDefault();else if(t.target.closest(".scroller_player")||t.target.closest(".playerresult")||t.target.closest(".chat_tag")){s=t.target.closest(".scroller_player")||t.target.closest(".playerresult")||t.target.closest(".chat_tag");const a=s.getAttribute("data-id"),n=[];a!=z.id()&&e("roomview").classList.contains("hosting")&&(n.push({label:"kick",classes:[],callback:e=>{ka.kickUser(a),e()}}),n.push({label:"ban",classes:[],callback:e=>{ka.kickUser(a,2592e3),e()}}),e("room_players").querySelector(`.scroller_player[data-id="${a}"]`)&&(e("room_players").querySelector(`.scroller_player[data-id="${a}"]`).classList.contains("spectator")?n.push({label:"move to players",classes:[],callback:e=>{ka.switchBracketHost(a,"player"),e()}}):n.push({label:"move to spectators",classes:[],callback:e=>{ka.switchBracketHost(a,"spectator"),e()}})),n.push({label:"transfer ownership",classes:[],callback:e=>{ka.transferOwnership(a),e()}})),Ns({userID:a,buttons:n}),t.stopPropagation(),t.preventDefault()}})),e("tetra_records_40l").addEventListener("click",(function(e){Ds.loadRecords("40l_global","tetra_records")})),e("tetra_records_blitz").addEventListener("click",(function(e){Ds.loadRecords("blitz_global","tetra_records")})),e("tetra_me_recent").addEventListener("click",(function(e){Ds.loadRecords("any_userrecent_CURRENTID","tetra_me")})),e("tetra_me_40l").addEventListener("click",(function(e){Ds.loadRecords("40l_userbest_CURRENTID","tetra_me")})),e("tetra_me_blitz").addEventListener("click",(function(e){Ds.loadRecords("blitz_userbest_CURRENTID","tetra_me")})),e("tetra_me_league").addEventListener("click",(function(e){Ds.loadRecords("league_userrecent_CURRENTID","tetra_me")})),e("tetra_players_league").addEventListener("click",(function(e){Ds.loadUserList("tetra_player_league_stream","/api/users/by/league")})),e("tetra_players_xp").addEventListener("click",(function(e){Ds.loadUserList("tetra_player_xp_stream","/api/users/by/xp")}))})),U.ready((function(t){function a(t){if(t.repeat||t.isComposing)return;if("Enter"!==t.code&&"NumpadEnter"!==t.code)return;const s=t.target.value;s.length&&ka.sendChatMessage(s),e("chat_input").value="",e("league_chat_input").value="",e("ingame_chat_input").value="","ingame_chat_input"===t.target.id&&t.target.blur()}e("play_multi").addEventListener("click",(function(e){ct("connecting to live servers"),ga.require().then((e=>{dt(),et("playmulti"),e.maintenance&&document.body.classList.add("maintenance")})).catch((e=>{console.log(e),dt(),T("could not connect to live servers")}))})),e("outdated_warning").addEventListener("click",(function(e){U.update()})),e("mm_status").addEventListener("click",(function(t){if(e("mm_status").classList.contains("room"))return Ut.stopNow(),e("mm_status").classList.remove("shown"),e("mm_status").classList.remove("room"),document.body.classList.remove("inmultizen"),st(!0),void et("lobby");ga.isConnected()&&(Ut.stopNow(),at(),setTimeout((()=>{st(!0),et("league")}),610))})),e("multi_listing").addEventListener("click",(function(e){et("multilisting")})),e("multi_join").addEventListener("keydown",(function(t){if(t.repeat)return;if("Enter"!==t.code&&"NumpadEnter"!==t.code)return;Os.play("menuclick");let s=e("multi_join").value.replace("#","").replace("https://tetr.io/","").replace("tetrio://","");4===s.length&&(s=s.toUpperCase()),s.length&&ka.joinRoom(s),e("multi_join").value=""})),e("multi_quickplay").addEventListener("click",(function(e){ka.joinRoom("X-QP")})),e("multi_league").addEventListener("click",(function(t){ct("fetching TETRA LEAGUE data");const s=`SESS-${Math.floor(Math.random()*Number.MAX_SAFE_INTEGER)}`;w.get("/api/server/environment",void 0,{headers:{"X-Session-ID":s}}).then((async t=>{w.get("/api/users/me",void 0,{headers:{"X-Session-ID":s,"X-Connection-ID":await z.esc(Uint8Array.from(atob(t.vx),(e=>e.charCodeAt(0))),Le.get())}}).then((t=>{-1===t.user.league.rating?(e("league_rating").innerHTML=`${t.user.league.gamesplayed}<span>/10 rating games played</span>`,e("league_rating").title="",e("leaguestanding_rating").innerHTML=`${t.user.league.gamesplayed}<span>/10 rating games played</span>`,e("league_ticker").innerHTML="play rating games to receive a rating",e("league_rank").classList.add("hidden"),e("league_warning").classList.add("hidden"),e("me_leaguerank").classList.add("hidden")):(Ne=Math.round(t.user.league.rating),Fe=t.user.league.rank,e("league_rating").innerHTML=`${Math.round(t.user.league.rating)}<span>TR</span>`,e("league_rating").title=t.user.league.rating,e("leaguestanding_rating").innerHTML=`${Math.round(t.user.league.rating)}<span>TR</span>`,e("league_ticker").innerHTML=`glicko: <span title="Your raw rating in the Glicko-2 system. Higher is better.">${t.user.league.glicko}</span><span title="How uncertain the Glicko-2 system is of your rating. Lower is better.">${t.user.league.rd}</span> - games won: <span>${t.user.league.gameswon}</span> / ${t.user.league.gamesplayed} (<span>${Math.floor(t.user.league.gameswon/t.user.league.gamesplayed*1e4)/100}</span>%)`,e("league_rank").src=`/res/league-ranks/${t.user.league.rank}.png`,e("leaguestanding_rank").src=`/res/league-ranks/${t.user.league.rank}.png`,e("league_rank").classList.remove("hidden"),e("league_warning").classList.toggle("hidden","z"!==t.user.league.rank),e("me_leaguerank").classList.toggle("hidden","z"===t.user.league.rank),e("me_leaguerank").src=`/res/league-ranks/${t.user.league.rank}.png`),-1===t.user.league.standing?e("league_placement").classList.add("hidden"):(Ue=t.user.league.standing,e("league_placement").classList.remove("hidden"),e("league_placement").innerHTML=`#<span>${t.user.league.standing}</span>`,e("league_placement").classList.toggle("t100",t.user.league.standing<=100&&t.user.league.standing>10),e("league_placement").classList.toggle("t10",t.user.league.standing<=10&&t.user.league.standing>1),e("league_placement").classList.toggle("t1",1===t.user.league.standing)),et("league"),dt(),0===t.user.league.gamesplayed&&D({title:"WELCOME TO TETRA LEAGUE",msg:"TETRA LEAGUE is a competitive 1v1 mode. win duels against players of similar skill to rank up and conquer the leaderboards!</p><p>if you're new to stackers or are feeling rusty, it's a good idea to practice in other modes first.</p><p class=\"modal_warning\">make sure you have the time and connection to play! if you leave or disconnect early, you will be penalized.",buttons:[{label:"GOT IT!",classes:[],callback:e=>{e()}}]})}),(e=>{dt(),S(e)}))}),(e=>{dt(),S(e)}))})),e("enter_matchmaking").addEventListener("click",(function(t){if(document.body.classList.contains("matchmaking"))ka.leaveMatchmaking();else{ka.enterMatchmaking();const t=e("enter_matchmaking").getBoundingClientRect();xn.play("button_ultra",{x:t.left,y:t.top,w:t.width,h:t.height,color:[16711680,16746632]})}})),e("multi_createroom").addEventListener("click",(function(e){ot([{id:"public",name:"PUBLIC ROOM",description:"create a public room anyone can join",classes:["block_anon","block_silenced"],attributes:{"data-block-reason":"ANONYMOUS USERS MAY NOT CREATE PUBLIC ROOMS"}},{id:"private",name:"PRIVATE ROOM",description:"create a private room for you and friends"}],(e=>{ka.createRoom(e)}),!0)})),e("leaveroom").addEventListener("click",(function(e){ka.leaveRoom()})),e("backtoroom").addEventListener("click",(function(e){et("lobby"),ka.returnToRoom()})),e("victory_downloadreplay").addEventListener("click",(function(e){const t=new Blob([JSON.stringify({ismulti:!0,data:_a,endcontext:ba,ts:(new Date).toISOString()})],{type:"application/json"}),s=document.createElement("a");s.download="replay.ttrm",s.href=(window.webkitURL||window.URL).createObjectURL(t),s.dataset.downloadurl=["application/json",s.download,s.href].join(":"),document.body.appendChild(s),s.click(),document.body.removeChild(s)})),e("viewreplay_endleague").addEventListener("click",(function(t){setTimeout((()=>{e("leaguestanding_rating").classList.remove("pingraise"),e("leaguestanding_rating").classList.remove("pinglower"),e("leaguestanding_rating").classList.remove("pingfinal"),e("leaguestanding_rating").classList.remove("pingrating")}),500),ct("fetching replay");const s=e("replayid_endleague").innerHTML.replace("R:","");w.get(`/api/games/${encodeURIComponent(s)}/short`).then((e=>{dt(),Ut.showMultiLog({...e.game,back:"endleague",forcestyle:"endleague"})}),(e=>{dt(),S(e)}))})),e("backtoleague").addEventListener("click",(function(t){ka.leaveRoom(!0),et("league"),setTimeout((()=>{e("leaguestanding_rating").classList.remove("pingraise"),e("leaguestanding_rating").classList.remove("pinglower"),e("leaguestanding_rating").classList.remove("pingfinal"),e("leaguestanding_rating").classList.remove("pingrating")}),5e3),yn("online","menus")})),e("chat_input").addEventListener("keydown",a),e("league_chat_input").addEventListener("keydown",a),e("ingame_chat_input").addEventListener("keydown",a),e("chat_input").addEventListener("keydown",i),e("league_chat_input").addEventListener("keydown",i),e("ingame_chat_input").addEventListener("keydown",i);let n="",o=-1;function i(e){if(e.repeat||e.isComposing)return;if("Tab"!==e.code)return n="",void(o=-1);let t=n||e.target.value;const s=t.match(/[a-z0-9-_]+/gi)||[""],a=s[s.length-1];if(!a||a.length<2)return;const i=ka.getRoomUsernames(a);if(!i.length)return;const r=i[++o%i.length];n=t,t=t.substring(0,t.length-a.length)+r,e.target.value=t}function r(){s("#room_content_container .unsaved .room_config_item[data-index]").forEach((e=>{e.closest(".room_config_row").classList.remove("unsaved")})),e("room_opts_save").classList.remove("unsaved"),e("startroom").classList.add("hidden"),ka.startRoom(),setTimeout((()=>{e("startroom").classList.remove("hidden")}),2e3)}function l(t){document.body.classList.contains("chatfocus")||Object.keys(ae).forEach((s=>{if(ae[s].includes(me(t)||t.detail.toUpperCase())&&"chat"===s){if((document.body.classList.contains("inmulti")||document.body.classList.contains("inmultizen"))&&0===ht&&e("social").classList.contains("hidden"))e("ingame_chat_input").focus(),t.stopPropagation(),t.preventDefault();else if("lobby"===ze&&1===ht&&!e("menus").classList.contains("hidden")&&e("social").classList.contains("hidden")){if(["input","textarea"].includes(document.activeElement.tagName.toLowerCase()))return;e("chat_input").focus(),t.stopPropagation(),t.preventDefault()}else if("endleague"===ze&&1===ht&&!e("menus").classList.contains("hidden")&&e("social").classList.contains("hidden")){if(["input","textarea"].includes(document.activeElement.tagName.toLowerCase()))return;e("league_chat_input").focus(),t.stopPropagation(),t.preventDefault()}}else;}))}e("ingame_chat_input").addEventListener("keyup",(t=>{t.repeat||("Escape"===t.code&&(t.target.value="",t.target.blur()),e("chat_input").value=t.target.value,e("league_chat_input").value=t.target.value)})),e("chat_input").addEventListener("keyup",(t=>{e("ingame_chat_input").value=t.target.value})),e("roomid_container").addEventListener("click",(function(t){Ve(`https://tetr.io/${e("roomid").innerHTML}`,"link")})),e("roomid_change").addEventListener("click",(function(t){t.stopPropagation(),qe()||je("EDIT ROOM ID","pick a new room ID. alphanumeric characters only, please!",e("roomid").innerHTML.replace("#",""),(e=>{ka.setRoomID(e.toUpperCase().trim())}))})),e("startroom").addEventListener("click",(function(e){s("#room_content_container .unsaved .room_config_item[data-index]").length?D({title:"START GAME?",msg:"some settings have not yet been saved, if you start the game now, those changes will be lost!",buttons:[{label:"CANCEL",classes:[],callback:e=>{e()}},{label:"DISCARD and START GAME",classes:["sec"],callback:e=>{r(),e()}}]}):r()})),setInterval((()=>{We()}),12e4),e("room_switchbracket").addEventListener("click",(function(t){ka.switchBracket(e("roomview").classList.contains("spectating")?"player":"spectator")})),e("igw_zen").addEventListener("click",(()=>{Ut.playZen({inroom:!0,roomname:e("room_content_name").innerText}),fe(!0)})),e("igw_spectate").addEventListener("click",(()=>{ka.startMidgameSpectate()})),document.addEventListener("keydown",l,!0),document.addEventListener("gpdown",l,!0),s("#room_content_container .room_config_item[data-index]").forEach((t=>{t.addEventListener("input",(()=>{t.closest(".room_config_row").classList.add("unsaved"),e("room_opts_save").classList.add("unsaved")}))})),e("room_opts_save").addEventListener("click",(()=>{ka.saveRoomConfig(),s("#room_content_container .unsaved .room_config_item[data-index]").forEach((e=>{e.closest(".room_config_row").classList.remove("unsaved")})),e("room_opts_save").classList.remove("unsaved")})),s(".room_config_spinner").forEach((e=>{e.addEventListener("click",(()=>{const t=[];e.getAttribute("data-items").split(";").forEach((e=>{const s=e.split(",");t.push({id:s[0],name:s[1],description:s[2]})})),ot(t,(t=>{e.innerHTML=t,e.dispatchEvent(new Event("input"))}),!0)}))}))}));let St=0,Mt="Unknown";function At(e,t,s){if(TETRIO_ENV.novault)return;let a="",n="???";switch(e){case"supporter":{let e="";e=t.isgift?1===t.recipients.length?`Supporter for ${t.recipients[0].toUpperCase()} - ${t.months} month${1===t.months?"":"s"} (gift)`:`Supporter for ${t.recipients.length} recipients (mega gift)`:`Supporter for ${z.username().toUpperCase()} - ${t.months} month${1===t.months?"":"s"}`,a+=`<tr>\n\t\t\t\t<td>${e}</td>\n\t\t\t\t<td>1 unit</td>\n\t\t\t\t<td>${t.price.toFixed(2)}</td>\n\t\t\t</tr>`,n=`${t.price.toFixed(2)}`,St=t.price,Mt=t.isgift?"Supporter Gift":"Supporter";break}}ct("checking payment data"),w.post("/api/orders/create",{type:e,dryrun:!0,data:t}).then((o=>{dt(),s&&s();try{_paq.push(["trackEvent","Vault","Purchase Initialize",Mt,St])}catch(e){}D({title:"Checkout",msg:`</p><div class="dialog_long">\n\t\t\t\t\t<table>${a}</table>\n\t\t\t\t\t<div class="vault_total"><span>TOTAL</span>${n}</div>\n\t\t\t\t\t<p class="vault_about">Your transaction will be completed using Xsolla.<br><b>Some of Xsolla's payment partners:</b><br><img src="/res/xsolla_methods.png" /><br>and many more.</p>\n\t\t\t\t</div><div class="xsolla_mark">Xsolla is an authorized global distributor of TETR.IO</div><p>`,classes:["vault_modal"],buttons:[{label:"Cancel",classes:[],callback:e=>{e()}},{label:"Pay with Xsolla",classes:["pri","xsolla_pay_button","oob_button_arrow_right"],callback:(s,a)=>{Os.play("purchase_start"),a.classList.add("oob_button_arrow_right_fly"),Ct(e,t,s,(()=>{a.classList.remove("oob_button_arrow_right_fly")}))}}]})}),(e=>{dt(),S(e)}))}function Ct(e,t,s,a){TETRIO_ENV.novault||(window.XPayStationWidget?(ct("placing order"),w.post("/api/orders/create",{type:e,dryrun:!1,data:t}).then((a=>{ct(""),Q(!1),s&&s();let n=!1;XPayStationWidget.off(),XPayStationWidget.on("open",(()=>{dt();try{_paq.push(["trackEvent","Vault","Purchase Start",Mt,St])}catch(e){}})),XPayStationWidget.on("status-done",(()=>{n=!0;try{_paq.push(["trackEvent","Vault","Purchase Complete",Mt,St])}catch(e){}})),XPayStationWidget.on("status-troubled",(()=>{try{_paq.push(["trackEvent","Vault","Purchase Troubled",Mt,St])}catch(e){}})),XPayStationWidget.on("close",(()=>{if(Q(!0),n)Ye(e,t);else try{_paq.push(["trackEvent","Vault","Purchase Cancel",Mt,St])}catch(e){}})),XPayStationWidget.init({access_token:a.tokenid,sandbox:a.sandbox,lightbox:{zIndex:9999999999}}),XPayStationWidget.open()}),(e=>{dt(),a&&a(),S(e)}))):T("a script is missing. please refresh the page or disable content blocking extensions."))}let Rt="",Ht=!0;function $t(t=!1,s=(()=>{})){!t&&("home"!==ze||e("menus").classList.contains("hidden")||ht<1)||w.get("/about/homebanner.html",void 0,{parse:!1}).then((t=>{if(t==Rt)return;Rt=t,e("homebanner").innerHTML=t;const a=t.startsWith("\x3c!--Yes serve a ceriad at the top yes yes yes please cool cool--\x3e");a!==Ht&&(Ht=a,a?(e("homebanner").insertAdjacentElement("afterend",e("tetr-io_728x90_1")),e("tetr-io_728x90_1").classList.add("ceriad_bg_rb"),e("tetr-io_728x90_1").classList.remove("ceriad_bg_rt"),e("tetr-io_728x90_1").classList.add("ceriad_mb"),e("tetr-io_728x90_1").classList.remove("ceriad_mt"),X.mountIfMounted("tetr-io_728x90_1"),e("homebanner").insertAdjacentElement("afterend",e("tetr-io_970X250_1")),e("tetr-io_970X250_1").classList.add("ceriad_bg_rb"),e("tetr-io_970X250_1").classList.remove("ceriad_bg_rt"),e("tetr-io_970X250_1").classList.add("ceriad_mb"),e("tetr-io_970X250_1").classList.remove("ceriad_mt"),X.mountIfMounted("tetr-io_970X250_1")):(e("home_menu").insertAdjacentElement("beforeend",e("tetr-io_728x90_1")),e("tetr-io_728x90_1").classList.add("ceriad_bg_rt"),e("tetr-io_728x90_1").classList.remove("ceriad_bg_rb"),e("tetr-io_728x90_1").classList.add("ceriad_mt"),e("tetr-io_728x90_1").classList.remove("ceriad_mb"),X.mountIfMounted("tetr-io_728x90_1"),e("home_menu").insertAdjacentElement("beforeend",e("tetr-io_970X250_1")),e("tetr-io_970X250_1").classList.add("ceriad_bg_rt"),e("tetr-io_970X250_1").classList.remove("ceriad_bg_rb"),e("tetr-io_970X250_1").classList.add("ceriad_mt"),e("tetr-io_970X250_1").classList.remove("ceriad_mb"),X.mountIfMounted("tetr-io_970X250_1"))),s()}),(e=>{s()}))}g((()=>{$t(!0,(()=>{U.finishLoad("homebanner")}))})),U.ready((e=>{setInterval((()=>{$t()}),6e5)})),U.ready((function(e){G.newacc()||w.get("/about/patchnotes/notes.json",void 0,{ignoreSuccess:!0}).then((e=>{const t=localStorage.getItem("lastPatch"),s=Object.keys(e)[0];if(s!==t){localStorage.setItem("lastPatch",s);let t="";t+=`<h1>${s}</h1><h6>${e[s].ts}</h6>`,e[s].contents.forEach((e=>{e.header&&(t+=`<h2 style="color: ${e.color};" data-content="${e.header}">${e.header}</h2>`),t+=`<p>${e.items.join("</p><p>")}</p>`})),D({title:"WHAT'S NEW",msg:`<div class="dialog_long">${t}<p class="dlf">Like this update? Please consider <a href="javascript:void();" class="lna" onclick="SHOW_SUPPORTER_DIALOG();">supporting the sole developer behind TETR.IO</a>!</p></div>`,classes:["patchnotes","wide_modal"],buttons:[{label:"ALL PATCH NOTES",classes:[],callback:e=>{window.open("/about/patchnotes/","_blank"),e()}},{label:"COOL!",classes:["pri"],callback:e=>{e()}}]})}}),(()=>{}))}));let Ot=[];function Pt(e=!1){"undefined"!=typeof Notification?"granted"===Notification.permission||"denied"===Notification.permission&&!e||Notification.requestPermission():console.warn("Notifications are not available on this device.")}function Dt(e,t,s=!1,a="/res/tetriox256.png",n,o=null){if("undefined"==typeof Notification)return;if(!1===te.video.desktopnotifications)return;if(!document.body.classList.contains("nofocus")&&!s)return;const i=new Notification(e,{body:t,icon:a,badge:"/res/tetriox256.png",tag:n});i.onclick=o||(()=>{window.focus(),i.close()}),Ot.push(i),window.IS_ELECTRON&&J()}U.ready((function(e){Pt(!1),window.addEventListener("focus",(function(e){for(const e of Ot)e.close();Ot=[]}))}));const Nt=(()=>{"production"===TETRIO_ENV.mode?g((()=>{e("performancemeter_header").innerHTML="PRODUCTION BUILD - F8 for stats",e("sb").remove(),e("sbt").remove()})):g((()=>{e("performancemeter").classList.remove("production"),e("performancemeter_header").innerHTML="DEVELOPMENT BUILD - F8 for stats"}));let t=!1,s=[],a=[],n=[],o=[],i=0,r=0,l=0,c=0,d=0,p=0,u=0,m=0,h=0,f=0,_=[],b=[],y=[],v=[],w=[],k=[],L=[],E=[];const x=1e3/60;let T=null;function I(){const e=window.performance.now();s.push(e),function(){const e=window.performance.now();w=w.filter((t=>!(e-t>1e3))),k=k.filter((t=>!(e-t>6e4))),L=L.filter((t=>!(e-t>1e3))),E=E.filter((t=>!(e-t>6e4))),s=s.filter((t=>!(e-t>1e3))),_=_.filter((t=>!(e-t.ts>1e3))),b=b.filter((t=>!(e-t.ts>6e4))),y=y.filter((t=>!(e-t.ts>1e3))),v=v.filter((t=>!(e-t.ts>1e3)))}(),u=w.length,m=k.length,h=L.length,f=E.length,i=s.length,a.push({ts:e,fps:i}),a=a.filter((t=>!(e-t.ts>5e3))),l=Math.max(1e-6,_.reduce(((e,t)=>Math.max(e,t.fill)),0)),c=Math.max(1e-6,b.reduce(((e,t)=>Math.max(e,t.fill)),0)),d=v.reduce(((e,t)=>Math.max(e,t.fill)),0),p=y.reduce(((e,t)=>Math.max(e,t.fill)),0),r=a.reduce(((e,t)=>Math.min(e||t.fps,t.fps)),0),S("fps",i),M("fps",r),A("fps",i<40),S("f",Math.round(l/x*1e4)/100),M("f",Math.round(c/x*1e4)/100),A("f",l/x>.8),S("gamef",Math.round(d/l*1e4)/100),M("gamef",Math.round(d/x*1e4)/100),S("drawf",Math.round(p/l*1e4)/100),M("drawf",Math.round(p/x*1e4)/100),S("gamem",u),M("gamem",m),S("drawm",h),M("drawm",f),A("gamem",u>9),A("drawm",h>9),S("ping",n.length?n[n.length-1]:"-"),M("ping",n.length?n.reduce(((e,t)=>Math.max(e,t))):"-"),A("ping",!!n.length&&n[n.length-1]>500),S("ping_spool",o.length?o[o.length-1]:"-"),M("ping_spool",o.length?o.reduce(((e,t)=>Math.max(e,t))):"-"),A("ping_spool",!!o.length&&o[o.length-1]>500),S("ping_backhaul",o.length&&n.length?Math.max(0,n[n.length-1]-o[o.length-1]):"-"),M("ping_backhaul",o.length&&n.length?Math.max(0,n.reduce(((e,t)=>Math.max(e,t)))-o.reduce(((e,t)=>Math.max(e,t)))):"-"),A("ping_backhaul",!(!o.length||!n.length)&&Math.max(0,n[n.length-1]-o[o.length-1]>500))}function S(e,t){T.querySelector(`#perf_${e} h1 span`).innerHTML=t}function M(e,t){T.querySelector(`#perf_${e} h2 span`).innerHTML=t}function A(e,t){t?T.querySelector(`#perf_${e}`).classList.add("warning"):T.querySelector(`#perf_${e}`).classList.remove("warning")}return g((()=>{T=e("performancemeter"),document.addEventListener("keydown",(e=>{119===e.which&&(t?(t=!1,PIXI.Ticker.shared.remove(I,this),T.classList.add("off")):(t=!0,PIXI.Ticker.shared.add(I,this),T.classList.remove("off")))}),!1),e("devbuildid").innerHTML=`v${TETRIO_ENV.version}-${TETRIO_ENV.mode} | commit ${TETRIO_ENV.commit.id} (${new Date(TETRIO_ENV.commit.time).toLocaleString()}) | server cycle ${TETRIO_ENV.serverCycle} | build ${TETRIO_ENV.build.id} (${new Date(TETRIO_ENV.build.time).toLocaleString()})<br>\n\t\t\t\t\t\t\t\t\t${window.IS_ELECTRON?"desktop":"browser"} | ${navigator.userAgent}<br>\n\t\t\t\t\t\t\t\t\t${te.video.graphics||"high"} | ${te.electron.anglecompat?"COMPAT ON":"compat off"} | <span id="rendererinfo">(no renderer)</span><br>\n\t\t\t\t\t\t\t\t\tgfx <span id="dirtyflag_gfx">OK</span> | net <span id="dirtyflag_net">OK</span> | state <span id="dirtyflag_state">OK</span> | client <span id="dirtyflag_client">OK</span> | gl <span id="dirtyflag_gl">OK</span><br>\n\t\t\t\t\t\t\t\t\tserver: <span id="serverdebuginfo">(not connected)</span>`,e("version_line").innerHTML=`version ${TETRIO_ENV.version}-${TETRIO_ENV.mode.toUpperCase()} (press F8 for more info)`})),{addGameF:e=>{t&&(_.push({fill:e,ts:window.performance.now()}),b.push({fill:e,ts:window.performance.now()}),v.push({fill:e,ts:window.performance.now()}))},addDrawF:e=>{t&&(_.push({fill:e,ts:window.performance.now()}),b.push({fill:e,ts:window.performance.now()}),y.push({fill:e,ts:window.performance.now()}))},addGameM:e=>{if(t)for(;e-- >0;)w.push(window.performance.now()),k.push(window.performance.now())},addDrawM:e=>{if(t)for(;e-- >0;)L.push(window.performance.now()),E.push(window.performance.now())},addPing:e=>{n.push(e),n.splice(0,Math.max(0,n.length-12))},addSpoolPing:e=>{o.push(e),o.splice(0,Math.max(0,o.length-12))}}})();function Ft(e,t,s){const a=new Ei,n=new Fo;n.import(e.export()),a.bindEventSource(new Uo({type:"replay",replay:n}));const o=[],i=[],r=[],l=[],c=[],d=[],p=[],u=[],m=[];let g=0,h=0;const f=[];(t=JSON.parse(JSON.stringify(t))).onstart=()=>{},t.onend=()=>{},t.onframe=(e,t)=>{e%30==0&&d.push([e,a.export().aggregatestats.vsscore])},t.onpiece=e=>{o.includes(e)||o.push(e),i.push(e),i.length>10&&i.shift(),r.push([e,e?600/(e-i[0]):0]);const t=a.export(),s=t.stats.score-g;if(g=t.stats.score,l.push(s/t.stats.level),l.length>30&&l.shift(),c.push([e,l.reduce(((e,t)=>e+t),0)/l.length]),t.stats.finesse.faults!==h&&(h=t.stats.finesse.faults,p.includes(e)||p.push(e)),u.length>11){const t=(u[u.length-1]-u[u.length-10])/10,s=e-o[o.length-2];s>3*t?m.push([o[o.length-2]+t,s-t]):u.includes(e)||u.push(e)}else u.includes(e)||u.push(e)},t.headless=!0,a.setGame(t),a.startGame();const _=n.getEndEvent();let b=0;for(;a.export().game.playing&&b<=_.frame+1;){if(a.doFrame(),b%300==0){const e=a.ejectState();e.setoptions.headless=!1,e.started=!0,f.push(e)}b++}if(r.length>7)for(let e=0;e<7;e++)r[e][1]=r[7][1];return{frames:_.frame,pieceFrames:o,localPPSFrames:r,localSPPFrames:c,vsFrames:d,finesseFaultFrames:p,chokeFrames:m,states:f,gametype:s}}const Ut=(()=>{let o=null,i=null,l=null,c=!1,d={},p=[],u=Date.now(),m=0;U.ready((()=>{e("watchreplay_results").addEventListener("click",(function(t){let s;e("results").classList.contains("isreplay")||(s=Ps.playing()),y(o.data,o.user.username.toUpperCase(),o.endcontext.gametype,s)})),e("downloadreplay_results").addEventListener("click",(function(e){const t=new Blob([JSON.stringify(o)],{type:"application/json"}),s=document.createElement("a");s.download=`${o.shortid||"replay"}.ttr`,s.href=(window.webkitURL||window.URL).createObjectURL(t),s.dataset.downloadurl=["application/json",s.download,s.href].join(":"),document.body.appendChild(s),s.click(),document.body.removeChild(s)})),e("downloadreplay_multilog").addEventListener("click",(function(e){const t=new Blob([JSON.stringify(o)],{type:"application/json"}),s=document.createElement("a");s.download=`${o.shortid||"replay"}.ttrm`,s.href=(window.webkitURL||window.URL).createObjectURL(t),s.dataset.downloadurl=["application/json",s.download,s.href].join(":"),document.body.appendChild(s),s.click(),document.body.removeChild(s)})),e("tweetreplay_results").addEventListener("click",(function(t){let s="",n="";switch(o.gametype){case"40l":const e=a(o.endcontext.finalTime);n=`time of ${e.m}:${e.s}.${e.ms}`;break;case"blitz":n=`score of ${o.endcontext.score.toLocaleString("en-US")}`}s=e("results").classList.contains("isreplay")?`Check out ${o.user._id===z.id()?"my":`${o.user.username.toUpperCase()}'s`} `:"I just achieved a ",s+=`${n} playing TETR.IO ${Ao.longTypeNames[o.gametype]}!\n\nhttps://tetr.io/#R:${o.shortid}`,window.open(`https://twitter.com/intent/tweet?text=${encodeURIComponent(s)}`,"_blank","menubar=0,toolbar=0,location=0,personalbar=0,status=0,noopener=1,width=640,height=480")})),e("resubmitreplay_results").addEventListener("click",(function(t){i&&(ct("resubmitting"),f(...i).then((t=>{x("game submitted!"),e("results").classList.remove("error"),dt()}),(t=>{e("dirtyflag_state").innerHTML="SUBMISSION",S(t),dt()})))})),e("custom_export").addEventListener("click",(function(e){const t=new Blob([JSON.stringify(M())],{type:"application/json"}),s=document.createElement("a");s.download="custom-game.ttp",s.href=(window.webkitURL||window.URL).createObjectURL(t),s.dataset.downloadurl=["application/json",s.download,s.href].join(":"),document.body.appendChild(s),s.click(),document.body.removeChild(s)}))}));let g=`SESS-${Math.floor(Math.random()*Number.MAX_SAFE_INTEGER)}`,h=0;function f(e,t,s){const a=w.post("/api/games/submit",{type:e,replay:t,assumptions:s,aborted:h,i:U.i(),serverCycle:TETRIO_ENV.serverCycle,commitId:TETRIO_ENV.commit.id},{headers:{"X-Session-ID":g}});return h=0,a}function _(){h=Math.min(10,h+1)}function b(e,t,s,a){Kt(e,t,s,a)}function y(e,t,s,a){const n=new Fo;n.import(e),b(n,t,s,a)}function v(t){l="40l",st(!1),et("none"),Ps.stop(),c||z.anon()||document.body.classList.contains("banstatus_restrict")?e("noreplay").classList.remove("hidden"):e("noreplay").classList.add("hidden"),document.body.classList.contains("inpair")||document.body.classList.contains("matchmaking")||yn("online","40l"),De=new Ei,De.bindEventSource(new Uo({type:"keyboard"})),De.setGame({version:vi,seed_random:!0,anchorseed:!0,g:.02,allow180:!0,countdown:!0,countdown_interval:1e3,precountdown:5e3,prestart:1e3,mission:Ao.gameMissions["40l"],zoominto:"slow",slot_counter1:te.gameoptions.slot_40l_counter1||"stopwatch",slot_counter2:te.gameoptions.slot_40l_counter2||"lines",slot_counter3:te.gameoptions.slot_40l_counter3||"pieces",slot_counter4:te.gameoptions.slot_40l_counter4||(te.gameoptions.pro_40l?"keys":void 0),slot_counter5:te.gameoptions.slot_40l_counter5||(te.gameoptions.pro_40l?"finesse":void 0),slot_bar2:"progress",pro:!!te.gameoptions.pro_40l,pro_alert:!!te.gameoptions.pro_40l_alert,pro_retry:!!te.gameoptions.pro_40l_retry,stride:!!te.gameoptions.stride_40l,no_szo:!!te.gameoptions.stride_40l,objective:{type:"lines",count:40},can_retry:!0,bgmnoreset:!1!==te.volume.noreset,onstart:()=>{Ps.playSmoothOrRandom(t.song||"RANDOM")},onfinish:t=>{const s=t.stats;s.finalTime=t.assumptions.finalTime;const a=t.replay.getFrame()*(1e3/60);let n=s.finalTime;Math.abs(n-a)>=50&&(n=a);const o=performance.now();c||z.anon()?p.push(setTimeout((()=>{s.finalTime=n,s.gametype="40l",T(t.stats,{gametype:"40l",replay:{user:{_id:z.id(),username:z.username()},endcontext:s,ts:new Date,data:t.replay.export(),gametype:"40l",customtype:"40l"}})}),te.gameoptions.stride_40l?500:2e3)):(i=["40l",t.replay.export(),t.assumptions],f(...i).then((e=>{x("game submitted!");const t=performance.now()-o;p.push(setTimeout((()=>{s.finalTime=n,T(s,{gametype:"40l",username:e.game.user.username,ts:e.game.ts,replay:e.game,hasranks:!0,globalrank:-1===e.globalrecord.rank?void 0:e.globalrecord.rank,personalrank:-1===e.userbestrecord.rank?void 0:e.userbestrecord.rank}),Qs(e.xp)}),Math.max(0,(te.gameoptions.stride_40l?500:2e3)-t)))}),(a=>{e("dirtyflag_state").innerHTML="SUBMISSION",S(a);const i=performance.now()-o;p.push(setTimeout((()=>{s.finalTime=n,s.gametype="40l",T(t.stats,{gametype:"40l",error:a.error.msg,replay:{user:{_id:z.id(),username:z.username()},endcontext:s,ts:new Date,data:t.replay.export(),gametype:"40l",customtype:"40l"}})}),Math.max(0,(te.gameoptions.stride_40l?500:2e3)-i)))})))},onfail:()=>{_(),p.push(setTimeout((()=>{Os.play("failure"),rt((e=>{"retry"===e?v({song:t.song}):(st(!0),et("home"))}))}),te.gameoptions.stride_40l?500:3e3))},onquit:()=>{_(),p.push(setTimeout((()=>{st(!0),et("home")}),600))}}),De.createGameHolder(),De.startGame()}function k(t){l="blitz",st(!1),et("none"),Ps.stop(),c||z.anon()||document.body.classList.contains("banstatus_restrict")?e("noreplay").classList.remove("hidden"):e("noreplay").classList.add("hidden"),document.body.classList.contains("inpair")||document.body.classList.contains("matchmaking")||yn("online","blitz"),De=new Ei,De.bindEventSource(new Uo({type:"keyboard"})),De.setGame({version:vi,seed_random:!0,anchorseed:!0,allow180:!0,countdown:!0,countdown_interval:1e3,precountdown:5e3,prestart:1e3,mission:Ao.gameMissions.blitz,zoominto:"slow",slot_counter1:te.gameoptions.slot_blitz_counter1||"timer",slot_counter2:te.gameoptions.slot_blitz_counter2||"lines",slot_counter3:te.gameoptions.slot_blitz_counter3||"level",slot_counter4:te.gameoptions.slot_blitz_counter4||(te.gameoptions.pro_blitz?"finesse_l":void 0),slot_counter5:te.gameoptions.slot_blitz_counter5||"score",slot_bar2:"progress",pro:!!te.gameoptions.pro_blitz,pro_alert:!!te.gameoptions.pro_blitz_alert,pro_retry:!!te.gameoptions.pro_blitz_retry,stride:!!te.gameoptions.stride_blitz,no_szo:!!te.gameoptions.stride_blitz,objective:{type:"timed",time:12e4},can_retry:!0,bgmnoreset:!1,levels:!0,levelspeed:.42,gbase:.65,onstart:()=>{Ps.playSmoothOrRandom(t.song||"RANDOM")},onfinish:t=>{const s=t.stats;s.finalTime=t.assumptions.finalTime;const a=performance.now();c||z.anon()?p.push(setTimeout((()=>{s.finalTime=12e4,s.gametype="blitz",T(t.stats,{gametype:"blitz",replay:{user:{_id:z.id(),username:z.username()},endcontext:s,ts:new Date,data:t.replay.export(),gametype:"blitz",customtype:"blitz"}})}),te.gameoptions.stride_blitz?500:2e3)):(i=["blitz",t.replay.export(),t.assumptions],f(...i).then((e=>{x("game submitted!");const t=performance.now()-a;p.push(setTimeout((()=>{s.finalTime=12e4,T(s,{gametype:"blitz",username:e.game.user.username,ts:e.game.ts,replay:e.game,hasranks:!0,globalrank:-1===e.globalrecord.rank?void 0:e.globalrecord.rank,personalrank:-1===e.userbestrecord.rank?void 0:e.userbestrecord.rank}),Qs(e.xp)}),Math.max(0,(te.gameoptions.stride_blitz?500:2e3)-t)))}),(n=>{e("dirtyflag_state").innerHTML="SUBMISSION",S(n);const o=performance.now()-a;p.push(setTimeout((()=>{s.finalTime=12e4,s.gametype="blitz",T(t.stats,{gametype:"blitz",error:n.error.msg,replay:{user:{_id:z.id(),username:z.username()},endcontext:s,ts:new Date,data:t.replay.export(),gametype:"blitz",customtype:"blitz"}})}),Math.max(0,(te.gameoptions.stride_blitz?500:2e3)-o)))})))},onfail:()=>{_(),p.push(setTimeout((()=>{Os.play("failure"),rt((e=>{"retry"===e?k({song:t.song}):(st(!0),et("home"))}))}),te.gameoptions.stride_blitz?500:3e3))},onquit:()=>{_(),p.push(setTimeout((()=>{st(!0),et("home")}),600))}}),De.createGameHolder(),De.startGame()}let L={map:`${"_".repeat(400)}?`,level:1,progress:0,score:0};if(localStorage.getItem("zenProgression")){const e=JSON.parse(localStorage.getItem("zenProgression"));e.level+e.progress>=L.level+L.progress&&(L=e)}function E(e){l="custom",st(!1),et("none"),Ps.stop(),document.body.classList.contains("inpair")||document.body.classList.contains("matchmaking")||yn("online","custom"),De=new Ei,De.bindEventSource(new Uo({type:"keyboard"}));const t=M();t.version=vi,t.objective={type:t.objective_type,count:t.objective_count,time:t.objective_time},t.mission_type="mission_free",t.bgmnoreset=!1!==te.volume.noreset,t.onstart=()=>{Ps.playSmoothOrRandom(e.song||"RANDOM")},t.onfinish=e=>{const s=e.stats;s.finalTime=e.assumptions.finalTime,s.gametype="custom";const a=e.replay.getFrame()*(1e3/60);let n=s.finalTime;Math.abs(n-a)>=50&&(n=a),p.push(setTimeout((()=>{s.finalTime=n,T(e.stats,{gametype:"custom",customtype:t.x_resulttype,replay:{user:{_id:z.id(),username:z.username()},endcontext:s,ts:new Date,data:e.replay.export(),gametype:"custom",customtype:t.x_resulttype}})}),2e3))},t.onfail=()=>{p.push(setTimeout((()=>{Os.play("failure"),rt((t=>{"retry"===t?E({song:e.song}):(st(!0),et("home"))}))}),3e3))},t.onquit=()=>{p.push(setTimeout((()=>{st(!0),et("home")}),600))},De.setGame(t),De.createGameHolder(),De.startGame()}function T(t,s){const i=a(t.finalTime),l=t.finalTime/6e4||1,p=t.finalTime/1e3||1,u=e("results_stats_overview"),m=e("results_stats_full");let g={};if(s.replay){const e=new Fo;e.import(s.replay.data),g=e.getStarter().options}switch(u.innerHTML="",m.innerHTML="","blitz"!==s.gametype&&"custom"!==s.gametype||I(u,"LEVEL",t.level),I(u,"PIECES PLACED",t.piecesplaced.toLocaleString("en-US")),I(u,"PIECES per SECOND",(t.piecesplaced/p).toFixed(2)),t.inputs&&(I(u,"KEYS PRESSED",t.inputs),I(u,"KEYS per PIECE",(t.inputs/t.piecesplaced).toFixed(3)),I(u,"KEYS per SECOND",(t.inputs/p).toFixed(3))),void 0!==t.holds&&I(u,"HOLDS",t.holds.toLocaleString("en-US")),I(u,"SCORE",t.score.toLocaleString("en-US")),"40l"!==s.gametype&&"custom"!==s.gametype||I(u,"TIME",`${i.m}:${i.s}.${i.ms}`),I(u,"LINES",t.lines.toLocaleString("en-US")),I(u,"LINES per MINUTE",(t.lines/l).toFixed(2)),"none"!==g.spinbonuses&&I(u,("T-spins"!==g.spinbonuses&&g.spinbonuses?"s":"T-s")+"pins",t.tspins),I(u,"maximum COMBO",Math.max(0,t.topcombo-1)),I(u,"maximum back-to-back chain",Math.max(0,t.topbtb-1)),I(u,"ALL CLEARS",t.clears.allclear.toLocaleString("en-US")),t.finesse&&(I(u,"finesse %",`${(t.finesse.perfectpieces/Math.max(1,t.piecesplaced)*100).toFixed(2)}%`),I(u,"finesse faults",t.finesse.faults.toLocaleString("en-US"))),I(m,"SINGLES",t.clears.singles.toLocaleString("en-US")),I(m,"DOUBLES",t.clears.doubles.toLocaleString("en-US")),I(m,"TRIPLES",t.clears.triples.toLocaleString("en-US")),I(m,"QUADS",t.clears.quads.toLocaleString("en-US")),"none"!==g.spinbonuses&&(I(m,("T-spins"!==g.spinbonuses&&g.spinbonuses?"s":"T-s")+"pins",t.clears.realtspins.toLocaleString("en-US")),I(m,("T-spins"!==g.spinbonuses&&g.spinbonuses?"s":"T-s")+"pin MINIS",t.clears.minitspins.toLocaleString("en-US")),I(m,("T-spins"!==g.spinbonuses&&g.spinbonuses?"s":"T-s")+"pin MINI SINGLES",t.clears.minitspinsingles.toLocaleString("en-US")),I(m,("T-spins"!==g.spinbonuses&&g.spinbonuses?"s":"T-s")+"pin SINGLES",t.clears.tspinsingles.toLocaleString("en-US")),I(m,("T-spins"!==g.spinbonuses&&g.spinbonuses?"s":"T-s")+"pin MINI DOUBLES",t.clears.minitspindoubles.toLocaleString("en-US")),I(m,("T-spins"!==g.spinbonuses&&g.spinbonuses?"s":"T-s")+"pin DOUBLES",t.clears.tspindoubles.toLocaleString("en-US")),I(m,("T-spins"!==g.spinbonuses&&g.spinbonuses?"s":"T-s")+"pin TRIPLES",t.clears.tspintriples.toLocaleString("en-US")),"T-spins"!==g.spinbonuses&&void 0!==g.spinbonuses&&I(m,"spin QUADS",t.clears.tspinquads||0)),I(m,"ALL CLEARS",t.clears.allclear.toLocaleString("en-US")),s.gametype){case"40l":e("results").classList.remove("nomusicpicker"),e("result_header").innerHTML="FINAL TIME",e("result_result").innerHTML=`${i.m}:${i.s}<span class="ms">.${i.ms}</span>`,s.isreplay||(Os.play("showscore"),Ps.playSmooth("success-story"));break;case"blitz":e("results").classList.add("nomusicpicker"),e("result_header").innerHTML="FINAL SCORE",e("result_result").textContent=t.score.toLocaleString("en-US"),s.isreplay||(Os.play("showscore"),Ps.playSmooth("philosophy"));break;case"custom":switch(e("results").classList.remove("nomusicpicker"),s.customtype||s.replay.customtype){case"score":e("result_header").innerHTML="FINAL SCORE",e("result_result").textContent=t.score.toLocaleString("en-US");break;case"time":e("result_header").innerHTML="FINAL TIME",e("result_result").innerHTML=`${i.m}:${i.s}<span class="ms">.${i.ms}</span>`;break;case"lines":e("result_header").innerHTML="FINAL LINE COUNT",e("result_result").textContent=t.lines}s.isreplay||(Os.play("showscore"),Ps.playSmooth("kaiser-hige-na-neko"))}const h=s.username||z.username();if(Xe.results.footer=`${Ao.longTypeNames[s.gametype]} played by <a class="tetra_pop" data-hover="tap" data-hit="click" data-username="${r(h)}">${r(h.toUpperCase())}</a> on ${new Date(s.ts||Date.now()).toLocaleString()}`,Xe.results.back=s.back||"home",st(!0),et("results"),e("results").classList.toggle("fakereplay",!s.replay.shortid),s.isreplay)Qe(s.replay.shortid?"tetra":"custom"),e("results").classList.add("isreplay");else{switch(s.gametype){case"40l":Qe("40l");break;case"blitz":Qe("blitz");break;case"custom":Qe("custom")}e("results").classList.remove("isreplay")}if(s.replay?(e("results").classList.remove("noreplay"),e("replayid_results").textContent=`R:${s.replay.shortid}`,o=s.replay):e("results").classList.add("noreplay"),s.hasranks){if(e("results").classList.add("hasranks"),s.globalrank?(e("globalrank_results").classList.toggle("textual",1===s.globalrank),e("globalrank_results_data").innerHTML=1===s.globalrank?"WORLD RECORD":s.globalrank,e("globalrank_results").classList.remove("hidden")):e("globalrank_results").classList.add("hidden"),s.personalrank)if(e("personalrank_results").classList.toggle("textual",1===s.personalrank),e("personalrank_results_data").innerHTML=1===s.personalrank?"PERSONAL BEST":s.personalrank,e("personalrank_results").classList.remove("hidden"),d[s.gametype]){let o=null;switch(s.gametype){case"40l":const e=a(Math.abs(d[s.gametype].endcontext.finalTime-t.finalTime));o=`${e.m}:${e.s}.${e.ms}`;break;case"blitz":o=`${Math.abs(d[s.gametype].endcontext.score-t.score).toLocaleString("en-US")} points`}e("personalrank_results_sub").innerHTML=`${o||""}${o?` ${1===s.personalrank?"improvement":"behind"} &bull; `:""}last PB was ${n(Date.parse(d[s.gametype].ts)).toUpperCase()} ago`}else e("personalrank_results_sub").innerHTML="this is your first game, play more to track your improvement";else e("personalrank_results").classList.add("hidden");1==s.globalrank?(Os.play("worldrecord"),Ze("globalbest","WORLD RECORD!")):1==s.personalrank&&(Os.play("personalbest"),Ze("personalbest","PERSONAL BEST!")),1==s.globalrank?e("globalrank_results").classList.add("best"):e("globalrank_results").classList.remove("best"),1==s.personalrank?(e("personalrank_results").classList.add("best"),d[s.gametype]={endcontext:t,ts:(new Date).toISOString()},A()):e("personalrank_results").classList.remove("best")}else e("results").classList.remove("hasranks");const f=new Fo;f.import(s.replay.data);const _=f.getStarter().options.handling;e("handling_item_arr").textContent=_.arr,e("handling_item_das").textContent=_.das,e("handling_item_sdf").textContent=41==_.sdf?"":_.sdf,s.error&&(s.error.includes("hacked")||s.error.includes("suspicious")||s.error.includes("already submitted"))&&(s.error.includes("hacked")&&(c=!0),s.error=void 0),e("results").classList.toggle("error",!!s.error),e("results").classList.toggle("disputed",!!(s.replay&&s.replay.disputed_until>Date.now())),s.error&&(e("submissionerror_results").textContent=s.error)}function I(e,t,s){const a=document.createElement("tr");e.appendChild(a);const n=document.createElement("td");n.textContent=t,a.appendChild(n);const o=document.createElement("td");o.textContent=s,a.appendChild(o)}function M(){const e={};return s("#custom_content_container .room_config_item[data-index]").forEach((t=>{const s=t.getAttribute("data-index");let a;switch(t.getAttribute("type")){case"number":a=parseFloat(t.value);break;case"checkbox":a=!!t.checked;break;default:a=t.value}t.classList.contains("room_config_spinner")&&(a=t.innerHTML),e[s]=a})),e}function A(){if(d["40l"]){const t=a(d["40l"].endcontext.finalTime);e("pbdisplay_40l_inner").innerHTML=`${t.m}:${t.s}<span>.${t.ms}</span>`,e("pbdisplay_40l_inner").classList.remove("hidden"),e("pbdisplay_40l").classList.remove("hidden")}else e("pbdisplay_40l").classList.add("hidden"),e("pbdisplay_40l_inner").classList.add("hidden");d.blitz?(e("pbdisplay_blitz_inner").innerHTML=d.blitz.endcontext.score.toLocaleString("en-US"),e("pbdisplay_blitz_inner").classList.remove("hidden"),e("pbdisplay_blitz").classList.remove("hidden")):(e("pbdisplay_blitz").classList.add("hidden"),e("pbdisplay_blitz_inner").classList.add("hidden"))}return{playReplay:b,playReplayObject:y,playReplayByID:function(e,t){ct("fetching replay"),w.get(`/api/games/${encodeURIComponent(e)}`).then((e=>{dt(),y(e.game.data,e.game.user.username,e.game.gametype,t)}),(e=>{dt(),S(e)}))},playAgain:function(e){switch(l){case"40l":v(e);break;case"blitz":e.song="hyper-velocity",k(e);break;case"custom":E(e)}},play40L:v,playBlitz:k,playZen:function(t){l="zen",st(!1),et("none"),Ps.stop(),t.inroom||document.body.classList.contains("inpair")||document.body.classList.contains("matchmaking")||yn("online","zen"),t.inroom&&(e("mm_status").classList.add("room"),e("mm_status").classList.add("shown"),e("mm_status_header").innerHTML="ZEN WHILE WAITING",e("mm_status_sub").textContent=t.roomname,document.body.classList.add("inmultizen")),De=new Ei,De.bindEventSource(new Uo({type:"keyboard"})),De.setGame({version:vi,seed_random:!0,allow180:!0,countdown:!0,countdown_interval:1e3,precountdown:t.inroom?0:3e3,prestart:t.inroom?500:1e3,zoominto:t.inroom?"fast":"slow",display_zen:!0,slot_bar2:"progress",mission:t.inroom?void 0:Ao.gameMissions.zen,mission_type:"mission_free",objective:{type:"none"},bgmnoreset:!0,nosiren:!0,infinitestock:!0,zenlevels:!0,zenlevel:L.level,zenprogress:L.progress,score:L.score,map:L.map,forfeit_time:t.inroom?1:30,can_retry:!0,retryisclear:!0,usezenconfig:!0,noreplay:!0,garbagemultiplier:1,pro:!0,b2bchaining:!0,onstart:()=>{Ps.playSmoothOrRandom("RANDOMcalm")},onquit:()=>{if(t.inroom)return e("mm_status").classList.remove("shown"),e("mm_status").classList.remove("room"),document.body.classList.remove("inmultizen"),st(!0),void et("lobby");p.push(setTimeout((()=>{st(!0),et("home")}),600))}}),De.createGameHolder(),De.startGame(),u=Date.now()},playCustom:E,testControls:function(){st(!1),De=new Ei,De.bindEventSource(new Uo({type:"keyboard"})),De.setGame({version:vi,seed_random:!0,g:.02,allow180:!0,countdown:!1,precountdown:0,prestart:250,zoominto:"fast",objective:{type:"none"},can_retry:!1,forfeit_time:1,display_username:!0,username:`arr ${te.handling.arr}F,das ${te.handling.das}F,sdf ${41==te.handling.sdf?"":`${te.handling.sdf}X`}`,neverstopbgm:!0,onend:()=>{p.push(setTimeout((()=>{st(!0)}),200))}}),De.createGameHolder(),De.startGame()},showResults:T,showMultiLog:function(n){n.endcontext[1].user._id===z.id()&&n.endcontext.reverse();const i=n.endcontext[0].user,l=n.endcontext[1].user;Xe.multilog.footer=`<a class="tetra_pop" data-hover="tap" data-hit="click" data-username="${r(i.username)}">${r(i.username.toUpperCase().toUpperCase())}</a> versus <a class="tetra_pop" data-hover="tap" data-hit="click" data-username="${r(l.username)}">${r(l.username.toUpperCase().toUpperCase())}</a> played on ${new Date(n.ts||Date.now()).toLocaleString()}`,Xe.multilog.back=n.back||"home",st(!0),et("multilog"),Qe(n.forcestyle||(n.shortid?"tetra":"victory")),n.shortid?(e("multilogview").classList.remove("noreplay"),e("replayid_multilog").textContent=`R:${n.shortid}`):e("multilogview").classList.add("noreplay"),o=n,e("multilog").innerHTML="";let c=[],d=[],p=[],u=[],m=[],g=[],h=0,f=0;n.data.forEach(((t,s)=>{t.board[1].user._id===i._id&&t.board.reverse();const o=new Fo;if(o.import(t.replays[1]),!o.getStarter())return;o.getStarter().options.username===i.username&&t.replays.reverse();const r=document.createElement("div");r.classList.add("multilog_result"),r.classList.add("scroller_block"),r.classList.add("zero"),r.setAttribute("data-hover","tap"),r.setAttribute("data-hit","click"),e("multilog").appendChild(r);const _=new Fo;_.import(t.replays[0]),_.amendTargets([l._id]);const b=_.getEndEvent().data.export,y=document.createElement("div");y.classList.add("multilog_result_self"),t.board[0].success&&(y.classList.add("success"),h++),t.replays[0].frames<=5&&r.classList.add("multilog_result_unavailable"),y.innerHTML=t.replays[0].frames<=5?"REPLAY UNAVAILABLE":`${"disconnect"===_.getEndEvent().data.reason?"forfeit - ":""}<span>${b.aggregatestats.pps.toFixed(2)}</span> PPS - <span>${b.aggregatestats.apm.toFixed(2)}</span> APM - <span>${b.aggregatestats.vsscore.toFixed(2)}</span> VS`,r.appendChild(y),c.push(b.aggregatestats.pps),d.push(b.aggregatestats.apm),p.push(b.aggregatestats.vsscore);const v=a(1e3/60*Math.min(t.replays[0].frames||0,t.replays[1].frames||0)),w=document.createElement("div");w.classList.add("multilog_result_time"),w.classList.toggle("focusedround",n.context==s+1),w.innerHTML=t.replays[0].frames<=5||t.replays[1].frames<=5?"-:--":`${v.m}:${v.s}`,r.appendChild(w);const k=new Fo;k.import(t.replays[1]),k.amendTargets([i._id]);const L=k.getEndEvent().data.export,E=document.createElement("div");E.classList.add("multilog_result_opponent"),t.board[1].success&&(E.classList.add("success"),f++),t.replays[1].frames<=5&&r.classList.add("multilog_result_unavailable"),E.innerHTML=t.replays[1].frames<=5?"REPLAY UNAVAILABLE":`<span>${L.aggregatestats.pps.toFixed(2)}</span> PPS - <span>${L.aggregatestats.apm.toFixed(2)}</span> APM - <span>${L.aggregatestats.vsscore.toFixed(2)}</span> VS${"disconnect"===k.getEndEvent().data.reason?" - forfeit":""}`,r.appendChild(E),u.push(L.aggregatestats.pps),m.push(L.aggregatestats.apm),g.push(L.aggregatestats.vsscore),r.__replays__=[_,k],r.__users__=[i,l],r.__success__=t.board[0].success,r.__roundid__=s+1,r.__datalength__=n.data.length})),s("#multilog .multilog_result").forEach((e=>{let t,s;e.__roundid__>0&&e.previousElementSibling&&!e.previousElementSibling.classList.contains("multilog_result_unavailable")&&(t=()=>{e.previousElementSibling.click()}),e.__roundid__<n.data.length&&e.nextElementSibling&&!e.nextElementSibling.classList.contains("multilog_result_unavailable")&&(s=()=>{e.nextElementSibling.click()}),e.addEventListener("click",(()=>{Yt(e.__replays__,e.__users__,e.__success__,Ps.playing(),t,s,e.__roundid__,e.__datalength__)}))})),t("#multilog_self").setAttribute("data-username",i.username),t("#multilog_self .leagueplayer_name").textContent=i.username.toUpperCase(),t("#multilog_self .leagueplayer_count").textContent=h,t("#multilog_self .leagueplayer_extra").innerHTML=`<span>${(c.reduce(((e,t)=>e+t))/c.length).toFixed(2)}</span> PPS - <span>${(d.reduce(((e,t)=>e+t))/d.length).toFixed(2)}</span> APM - <span>${(p.reduce(((e,t)=>e+t))/p.length).toFixed(2)}</span> VS`,t("#multilog_self").classList.toggle("disconnected",!n.endcontext[0].active),t("#multilog_opponent").setAttribute("data-username",l.username),t("#multilog_opponent .leagueplayer_name").textContent=l.username.toUpperCase(),t("#multilog_opponent .leagueplayer_count").textContent=f,t("#multilog_opponent .leagueplayer_extra").innerHTML=`<span>${(u.reduce(((e,t)=>e+t))/u.length).toFixed(2)}</span> PPS - <span>${(m.reduce(((e,t)=>e+t))/m.length).toFixed(2)}</span> APM - <span>${(g.reduce(((e,t)=>e+t))/g.length).toFixed(2)}</span> VS`,t("#multilog_opponent").classList.toggle("disconnected",!n.endcontext[1].active)},setGameOpts:function(e){s("#custom_content_container .room_config_item[data-index]").forEach((t=>{const s=t.getAttribute("data-index"),a=getSetDescendantProp(e,s);switch(t.getAttribute("type")){case"number":case"text":default:t.value=a;break;case"checkbox":t.checked=!!a}t.classList.contains("room_config_spinner")&&(t.textContent=a)}))},reportAbortedGame:_,anchorSeed:function(e){g=`SESS-${Math.floor(Math.random()*Number.MAX_SAFE_INTEGER)}`,w.post("/api/games/anchor",{seed:e},{headers:{"X-Session-ID":g}})},loadZen:function(e){if(e)if(localStorage.getItem("zenProgression")){const t=JSON.parse(localStorage.getItem("zenProgression"));t.level+t.progress<e.level+e.progress&&(L=e)}else L=e},saveZen:function(e,t=0){L=e,localStorage.setItem("zenProgression",JSON.stringify(e)),z.anon()||(w.post("/api/games/zen",{...e,timeplayed:Math.floor((Date.now()-u)/1e3)}).then((e=>{e.xp&&(m+=e.xp,t&&p.push(setTimeout((()=>{Qs(m),m=0}),t)))})),u=Date.now())},getZen:()=>L,resetZen:()=>{L={map:`${"_".repeat(400)}?`,level:1,progress:0,score:0},localStorage.removeItem("zenProgression")},stopNow:()=>{De&&De.endNow(),ki.forEach((e=>{e.endNow()})),e("replay").classList.add("hidden"),e("replaytools").classList.add("disabled"),e("replaytools").classList.add("hidden"),p.forEach((e=>{clearTimeout(e)})),p=[]},setRecords:e=>{d=e,A()},setUnsafeTimeout:(...e)=>{p.push(setTimeout(...e))}}})();let Bt=[],Xt=null,zt=0,Gt=!1,jt=!1,Wt="normal",qt=null;function Kt(t,n,o,i){st(!1),Ps.stop(),e("data_replay").innerHTML=`watching <span>${r(n)}</span> play <span>${r(Ao.longTypeNames[o]||o)}</span>`,e("replay").classList.remove("hidden"),e("replaytools").classList.remove("hidden"),e("replaytools").classList.remove("multi"),e("replaytools").classList.add("disabled"),s('.tab[data-scope="replaytools_secondary_right"]').forEach((e=>{e.classList.remove("active")})),e("replaytools_button_1x").classList.add("active"),e("replaytools_button_playpause").innerHTML="",e("replaytools_timestamp").innerHTML="0:00.000<span>frame 0</span>",e("replaytools_seekbar").setAttribute("style","--progress: 0%;"),e("replaytools_seekbar_tip").setAttribute("style",""),e("replaytools_button_playpause").classList.remove("disabled"),e("replaytools_button_nextround").classList.contains("active")&&e("replaytools_button_end").click(),De=new Ei,De.bindEventSource(new Uo({type:"replay",replay:t})),Bt=[],Xt=null,zt=0,Gt=!1;const l=t.getStarter().options;l.display_replay=!0,l.display_username=!0,l.username=n,"custom"!==o&&(l.countdown_interval=1e3,l.precountdown=5e3,l.prestart=1e3,l.mission=Ao.gameMissions[o],l.zoominto="slow",l.pro=!!te.gameoptions[`pro_${o}`],l.pro_alert=!!te.gameoptions[`pro_${o}_alert`],l.pro_retry=!!te.gameoptions[`pro_${o}_retry`],l.slot_counter1=te.gameoptions[`slot_${o}_counter1`]||l.slot_counter1,l.slot_counter2=te.gameoptions[`slot_${o}_counter2`]||l.slot_counter2,l.slot_counter3=te.gameoptions[`slot_${o}_counter3`]||l.slot_counter3,l.slot_counter4=te.gameoptions[`slot_${o}_counter4`]||l.slot_counter4,l.slot_counter5=te.gameoptions[`slot_${o}_counter5`]||l.slot_counter5),l.onstart=()=>{Ps.playSmoothOrRandom("shiroi-hyoutan"),e("replaytools").classList.remove("disabled")},l.onend=()=>{e("replaytools").classList.add("disabled"),Ut.setUnsafeTimeout((()=>{st(!0),Ps.playSmooth(document.body.classList.contains("inpair")||document.body.classList.contains("matchmaking")?"touhoudaiensei":i||"shikiichi-made-mousukoshi"),e("replay").classList.add("hidden"),e("replaytools").classList.add("hidden")}),500)};let c=30;l.onframe=(t,s)=>{if(!s){const s=a(1e3*(t+1)/60);e("replaytools_timestamp").innerHTML=`${s.m}:${s.s}.${s.ms}<span>frame ${t}</span>`,e("replaytools_seekbar").setAttribute("style",`--progress: ${t/Vt.frames*100}%;`)}if(t===Vt.frames){if(e("replaytools_button_stop").classList.contains("active"))return De.playbackSpeed()&&(e("replaytools_button_playpause").innerHTML="",De.playbackSpeed(0)),!0;if(e("replaytools_button_loop").classList.contains("active"))return!(--c<=0)||(c=30,void De.injectState(Vt.states[0]))}},Vt=Ft(t,l,o);let d=[],p=15;if("40l"===o||"custom"===o?(d=Vt.localPPSFrames,p=15):"blitz"===o&&(d=Vt.localSPPFrames,p=40),d.length<=1e3){let t=0,s=999;d.forEach((e=>{t=Math.max(t,e[1]),s=Math.min(s,e[1])}));let a="clip-path: polygon(100% 100%, 0% 100%";d.forEach((e=>{a+=s/t<.1?`, ${e[0]/Vt.frames*100}% ${100-e[1]/t*100}%`:`, ${e[0]/Vt.frames*100}% ${90-(e[1]-s)/(t-s)*90}%`})),a+="); ",d.length>p&&(a+=`background: linear-gradient(to right, #FFF0 0%, #FF780022 ${d[p][0]/Vt.frames*100}%, #FF780022 100%);`),e("replaytools_graph").setAttribute("style",a)}else e("replaytools_graph").setAttribute("style","");let u="";"40l"===o&&(Vt.finesseFaultFrames.length<=30&&Vt.finesseFaultFrames.forEach((e=>{u+=`<div class="replaytools_marker_finesse" style="left: ${e/Vt.frames*100}%;"></div>`})),Vt.chokeFrames.length<=5&&Vt.chokeFrames.forEach((e=>{u+=`<div class="replaytools_marker_choke" style="left: ${e[0]/Vt.frames*100}%; width: ${e[1]/Vt.frames*100}%;"></div>`}))),e("replaytools_markers").innerHTML=u,De.setGame(l),De.createGameHolder(),De.location(0,-.1,1),De.startGame()}function Yt(t,n,o,i,l,c,d,p){st(!1),Gt=!0,jt=!1,Wt="normal",i&&"shiroi-hyoutan"!==i&&(Ps.stop(),qt=i),e("data_replay").innerHTML=`watching <span>${r(n[0].username.toUpperCase())}</span> VS <span>${r(n[1].username.toUpperCase())}</span>${c||l?`, round <span>${d}</span>${co(`/${p}`)}`:""}`,e("replay").classList.remove("hidden"),e("replaytools").classList.remove("hidden"),e("replaytools").classList.add("disabled"),e("replaytools").classList.add("multi"),s('.tab[data-scope="replaytools_secondary_right"]').forEach((e=>{e.classList.remove("active")})),e("replaytools_button_1x").classList.add("active"),e("replaytools_button_playpause").innerHTML="",e("replaytools_timestamp").innerHTML="0:00.000<span>frame 0</span>",e("replaytools_seekbar").setAttribute("style","--progress: 0%;"),e("replaytools_seekbar_tip").setAttribute("style",""),e("replaytools").classList.toggle("multiround",l||c),e("replaytools_button_backward_round").classList.toggle("disabled",void 0===l),e("replaytools_button_forward_round").classList.toggle("disabled",void 0===c),e("replaytools_button_playpause").classList.remove("disabled"),!e("replaytools_button_nextround").classList.contains("active")||l||c||e("replaytools_button_end").click(),ha=da();const u=new Ei;u.bindEventSource(new Uo({type:"replay",replay:t[0]})),ha.attachFake(u,{listenID:n[0]._id,user:{_id:n[0]._id,username:n[0].username}});const m=new Ei;m.bindEventSource(new Uo({type:"replay",replay:t[1]})),ha.attachFake(m,{listenID:n[1]._id,user:{_id:n[1]._id,username:n[1].username}});const g=t[0].getStarter().options;g.display_replay=!0,g.countdown_interval=1e3,g.countdown_count=3,g.precountdown=500,g.prestart=1e3,g.mission=null,g.force_mission=!0,g.zoominto="slow",g.physical=!1,g.noscope=!1,g.neverstopbgm=!0;const h=t[1].getStarter().options;h.display_replay=!0,h.countdown_interval=1e3,h.countdown_count=3,h.precountdown=500,h.prestart=1e3,h.mission=null,h.zoominto="slow",h.physical=!1,h.noscope=!1,h.neverstopbgm=!0,g.onstart=()=>{i&&"shiroi-hyoutan"!==i&&Ps.playSmoothOrRandom("shiroi-hyoutan"),e("replaytools").classList.remove("disabled")};let f=!1;g.onend=()=>{if(!f){if(f=!0,e("replaytools").classList.add("disabled"),e("replaytools_button_backward_round").classList.add("disabled"),e("replaytools_button_forward_round").classList.add("disabled"),e("replaytools_button_playpause").classList.add("disabled"),jt?jt=!1:o?m.queueEnd("topout",!0):m.endWin(),("next"===Wt||"normal"===Wt&&e("replaytools_button_nextround").classList.contains("active"))&&c)return Ut.setUnsafeTimeout((()=>{Bt=[],Xt=null,Gt=!1,ha.detachFakes()}),"next"===Wt?50:500),void Ut.setUnsafeTimeout((()=>{m.endNow(),c()}),"next"===Wt?100:1e3);if("prev"===Wt&&l)return Ut.setUnsafeTimeout((()=>{Bt=[],Xt=null,Gt=!1,ha.detachFakes()}),"prev"===Wt?50:500),void Ut.setUnsafeTimeout((()=>{m.endNow(),l()}),"prev"===Wt?100:1e3);Ps.stop(200),Ut.setUnsafeTimeout((()=>{st(!0),Ps.playSmooth(document.body.classList.contains("inpair")||document.body.classList.contains("matchmaking")?"touhoudaiensei":qt||i||"shikiichi-made-mousukoshi"),e("replay").classList.add("hidden"),e("replaytools").classList.add("hidden"),Bt=[],Xt=null,Gt=!1,ha.detachFakes()}),500),Ut.setUnsafeTimeout((()=>{m.endNow()}),1e3)}},h.onend=()=>{if(!f){if(f=!0,e("replaytools").classList.add("disabled"),e("replaytools_button_backward_round").classList.add("disabled"),e("replaytools_button_forward_round").classList.add("disabled"),e("replaytools_button_playpause").classList.add("disabled"),jt?jt=!1:o?u.endWin():u.queueEnd("topout",!0),("next"===Wt||"normal"===Wt&&e("replaytools_button_nextround").classList.contains("active"))&&c)return Ut.setUnsafeTimeout((()=>{Bt=[],Xt=null,Gt=!1,ha.detachFakes()}),"next"===Wt?50:500),void Ut.setUnsafeTimeout((()=>{u.endNow(),c()}),"next"===Wt?100:1e3);if("prev"===Wt&&l)return Ut.setUnsafeTimeout((()=>{Bt=[],Xt=null,Gt=!1,ha.detachFakes()}),"prev"===Wt?50:500),void Ut.setUnsafeTimeout((()=>{u.endNow(),l()}),"prev"===Wt?100:1e3);Ps.stop(200),Ut.setUnsafeTimeout((()=>{st(!0),Ps.playSmooth(document.body.classList.contains("inpair")||document.body.classList.contains("matchmaking")?"touhoudaiensei":qt||i||"shikiichi-made-mousukoshi"),e("replay").classList.add("hidden"),e("replaytools").classList.add("hidden"),Bt=[],Xt=null,Gt=!1,ha.detachFakes()}),500),Ut.setUnsafeTimeout((()=>{u.endNow()}),1e3)}};let _=30,b=0;g.onframe=(t,s)=>{if(!f){if(!s){const s=a(1e3*(t+1)/60);e("replaytools_timestamp").innerHTML=`${s.m}:${s.s}.${s.ms}<span>frame ${t}</span>`,e("replaytools_seekbar").setAttribute("style",`--progress: ${t/zt*100}%;`)}if(t===zt){if(2===b)return!0;if(e("replaytools_button_stop").classList.contains("active"))return u.playbackSpeed()&&(e("replaytools_button_playpause").innerHTML="",u.playbackSpeed(0),m.playbackSpeed(0)),!0;if(e("replaytools_button_loop").classList.contains("active"))return!(--_<=0)||(_=30,u.injectState(Bt[0].states[0]),m.injectState(Bt[1].states[0]),void(b=1))}else b=0}},h.onframe=(t,s)=>{if(!f)if(t===Bt[1].frames){if(1===b)return!0;if(e("replaytools_button_stop").classList.contains("active"))return u.playbackSpeed()&&(e("replaytools_button_playpause").innerHTML="",u.playbackSpeed(0),m.playbackSpeed(0)),!0;if(e("replaytools_button_loop").classList.contains("active"))return!(--_<=0)||(_=30,u.injectState(Bt[0].states[0]),m.injectState(Bt[1].states[0]),void(b=2))}else b=0},Bt[0]=Ft(t[0],g,"multi"),Bt[1]=Ft(t[1],h,"multi"),zt=Math.min(Bt[0].frames,Bt[1].frames),Xt=[...Bt[0].pieceFrames,...Bt[1].pieceFrames],Xt.push(zt),Xt=Xt.filter((function(e,t){return Xt.indexOf(e)==t&&e<=zt})),Xt.sort(((e,t)=>e-t));let y=Bt[0].vsFrames,v=Bt[1].vsFrames;v.splice(y.length),y.splice(v.length);let w=[];y.forEach(((e,t)=>{w.push([e[0],y[t][1]-v[t][1]])}));if(w.length<=1e3){let t=1,s=-1;w.forEach((e=>{t=Math.max(t,e[1]),s=Math.min(s,e[1])})),t=Math.max(t,-.5*s),s=Math.min(s,-.5*t);let a="clip-path: polygon(100% 50%, 0% 50%";w.forEach((e=>{e[1]>=0?a+=`, ${e[0]/zt*100}% ${50-e[1]/t*50}%`:a+=`, ${e[0]/zt*100}% ${50+e[1]/s*50}%`})),a+=");",e("replaytools_graph").setAttribute("style",a)}else e("replaytools_graph").setAttribute("style","");e("replaytools_markers").innerHTML="",u.setGame(g),u.createGameHolder(),u.location(-.35,-.1,1),u.startGame(),m.setGame(h),m.createGameHolder(),m.location(.45,-.1,1),m.startGame()}let Vt=null;U.ready((()=>{document.addEventListener("keydown",(t=>{e("replay").classList.contains("hidden")||document.body.classList.contains("chatfocus")||ht>=1||(["ARROWLEFT","LEFT"].includes(me(t))?t.shiftKey?e("replaytools_button_backward_frame").click():t.ctrlKey?e("replaytools_button_backward_large").click():e("replaytools_button_backward_piece").click():["ARROWRIGHT","RIGHT"].includes(me(t))?t.shiftKey?e("replaytools_button_forward_frame").click():t.ctrlKey?e("replaytools_button_forward_large").click():e("replaytools_button_forward_piece").click():[",","COMMA"].includes(me(t))?e("replaytools_button_backward_frame").click():[".","PERIOD"].includes(me(t))?e("replaytools_button_forward_frame").click():["J","KEYJ"].includes(me(t))?e("replaytools_button_backward_large").click():["L","KEYL"].includes(me(t))?e("replaytools_button_forward_large").click():["K","KEYK","SPACE"," "].includes(me(t))?e("replaytools_button_playpause").click():["ARROWUP","UP"].includes(me(t))?e("replaytools_button_5x").classList.contains("active")?e("replaytools_button_10x").click():e("replaytools_button_2x").classList.contains("active")?e("replaytools_button_5x").click():e("replaytools_button_1x").classList.contains("active")?e("replaytools_button_2x").click():e("replaytools_button_50x").classList.contains("active")?e("replaytools_button_1x").click():e("replaytools_button_25x").classList.contains("active")&&e("replaytools_button_50x").click():["ARROWDOWN","DOWN"].includes(me(t))&&(e("replaytools_button_10x").classList.contains("active")?e("replaytools_button_5x").click():e("replaytools_button_5x").classList.contains("active")?e("replaytools_button_2x").click():e("replaytools_button_2x").classList.contains("active")?e("replaytools_button_1x").click():e("replaytools_button_1x").classList.contains("active")?e("replaytools_button_50x").click():e("replaytools_button_50x").classList.contains("active")&&e("replaytools_button_25x").click()),t.repeat||Object.keys(ae).forEach((s=>{if(ae[s].includes(me(t)||t.detail.toUpperCase())&&"exit"===s)e("exit_replay").click()})))}),!1),e("exit_replay").addEventListener("click",(function(e){Gt||De.end()})),e("replaytools_button_25x").addEventListener("click",(function(e){Gt||De.playbackSpeed()&&De.playbackSpeed(.25)})),e("replaytools_button_50x").addEventListener("click",(function(e){Gt||De.playbackSpeed()&&De.playbackSpeed(.5)})),e("replaytools_button_1x").addEventListener("click",(function(e){Gt||De.playbackSpeed()&&De.playbackSpeed(1)})),e("replaytools_button_2x").addEventListener("click",(function(e){Gt||De.playbackSpeed()&&De.playbackSpeed(2)})),e("replaytools_button_5x").addEventListener("click",(function(e){Gt||De.playbackSpeed()&&De.playbackSpeed(5)})),e("replaytools_button_10x").addEventListener("click",(function(e){Gt||De.playbackSpeed()&&De.playbackSpeed(10)})),e("replaytools_button_playpause").addEventListener("click",(function(t){if(!Gt){if(De.playbackSpeed())return e("replaytools_button_playpause").innerHTML="",void De.playbackSpeed(0);e("replaytools_button_25x").classList.contains("active")?De.playbackSpeed(.25):e("replaytools_button_50x").classList.contains("active")?De.playbackSpeed(.5):e("replaytools_button_1x").classList.contains("active")?De.playbackSpeed(1):e("replaytools_button_2x").classList.contains("active")?De.playbackSpeed(2):e("replaytools_button_5x").classList.contains("active")?De.playbackSpeed(5):e("replaytools_button_10x").classList.contains("active")&&De.playbackSpeed(10),e("replaytools_button_playpause").innerHTML=""}})),e("replaytools_button_forward_frame").addEventListener("click",(function(t){if(Gt)return;if(e("replaytools").classList.contains("disabled"))return;De.export().source.getFrame()>=Vt.frames||De.advanceFrames(1)})),e("replaytools_button_forward_piece").addEventListener("click",(function(t){if(Gt)return;if(e("replaytools").classList.contains("disabled"))return;const s=De.export().source.getFrame();for(let e=0;e<Vt.pieceFrames.length;e++)if(Vt.pieceFrames[e]>s)return void De.advanceFrames(Vt.pieceFrames[e]-s)})),e("replaytools_button_forward_large").addEventListener("click",(function(t){if(Gt)return;if(e("replaytools").classList.contains("disabled"))return;const s=De.export().source.getFrame();s>=Vt.frames||De.advanceFrames(Math.min(Vt.frames-s,300),!0)})),e("replaytools_button_backward_frame").addEventListener("click",(function(t){Gt||e("replaytools").classList.contains("disabled")||o(De,Vt,1)})),e("replaytools_button_backward_piece").addEventListener("click",(function(t){if(Gt)return;if(e("replaytools").classList.contains("disabled"))return;const s=De.export().source.getFrame();for(let e=Vt.pieceFrames.length-1;e>=0;e--)if(Vt.pieceFrames[e]<s)return void o(De,Vt,s-Vt.pieceFrames[e])})),e("replaytools_button_backward_large").addEventListener("click",(function(t){Gt||e("replaytools").classList.contains("disabled")||o(De,Vt,300)}));let t=!1,s=!1;function n(e,t,s){const a=Math.max(0,s-1),n=Math.floor(a/300),o=a-300*n;e.injectState(t.states[n]),e.advanceFrames(o,!0),e.export().options.onframe(a,!1)}function o(e,t,s){const a=e.export().source.getFrame();n(e,t,a-s)}e("replaytools_seekbar").addEventListener("mouseover",(e=>{s=!0})),e("replaytools_seekbar").addEventListener("mouseout",(e=>{s=!1})),e("replaytools_seekbar").addEventListener("mousedown",(function(s){if(Gt)return;if(e("replaytools").classList.contains("disabled"))return;t=!0;const a=De.export().source.getFrame(),o=Math.floor(Math.min(1,Math.max(0,(s.clientX-16)/(window.innerWidth-32)))*Vt.frames);a!==o&&n(De,Vt,o)})),document.addEventListener("mouseup",(e=>{Gt||(t=!1)})),document.addEventListener("mousemove",(o=>{if(!Gt){if(e("replaytools").classList.contains("disabled"))return t=!1,void(s=!1);if(t){const e=De.export().source.getFrame(),t=Math.floor(Math.min(1,Math.max(0,(event.clientX-16)/(window.innerWidth-32)))*Vt.frames);e!==t&&n(De,Vt,t)}if(s){const t=Math.floor(Math.min(1,Math.max(0,(event.clientX-16)/(window.innerWidth-32)))*Vt.frames),s=t/Vt.frames*100;e("replaytools_seekbar_tip").setAttribute("style",`--progress: ${s}%;`),e("replaytools_seekbar").setAttribute("data-border-snapped",s<=10?"left":s>=90?"right":"none");const n=a(1e3*t/60);let o="",i="",r="";if("40l"===Vt.gametype||"custom"===Vt.gametype){for(let e=Vt.localPPSFrames.length-1;e>=0;e--)if(Vt.localPPSFrames[e][0]<=t){o=`<div class="seekbar_tip_stat"><span>${Vt.localPPSFrames[e][1].toFixed(2)}</span> ${co("L")}PPS</div>`;break}}else if("blitz"===Vt.gametype)for(let e=Vt.localSPPFrames.length-1;e>=0;e--)if(Vt.localSPPFrames[e][0]<=t){o=`<div class="seekbar_tip_stat"><span>${Vt.localSPPFrames[e][1].toFixed(2)}</span> ${co("L")}SPP</div>`;break}if("40l"===Vt.gametype){let e=0;for(let s=t-30;s<t+30;s++)Vt.finesseFaultFrames.includes(s)&&e++;e&&(i=`<div class="seekbar_tip_issue"><b>${e}</b> finesse piece${1===e?"":"s"}</div>`);for(let e=0;e<Vt.chokeFrames.length;e++)if(Vt.chokeFrames[e][0]-30<=t&&Vt.chokeFrames[e][0]+Vt.chokeFrames[e][1]+30>=t){r=`<div class="seekbar_tip_issue_severe"><b>${Math.round(1e3*Vt.chokeFrames[e][1]/60)}</b>${co("MS")} choke</div>`;break}}e("replaytools_seekbar_tip").innerHTML=`\n\t\t\t\t<div class="seekbar_tip_time">${n.m}:${n.s}.${n.ms}</div>\n\t\t\t\t${o}\n\t\t\t\t${i}\n\t\t\t\t${r}\n\t\t\t`}}})),e("exit_replay").addEventListener("click",(function(e){Gt&&(jt=!0,Wt="exit",ha.games.others.forEach(((e,t)=>{e.game.end()})))})),e("replaytools_button_backward_round").addEventListener("click",(function(e){Gt&&(jt=!0,Wt="prev",ha.games.others.forEach(((e,t)=>{e.game.end()})))})),e("replaytools_button_forward_round").addEventListener("click",(function(e){Gt&&(jt=!0,Wt="next",ha.games.others.forEach(((e,t)=>{e.game.end()})))})),e("replaytools_button_25x").addEventListener("click",(function(e){Gt&&ha.games.others[0].game.playbackSpeed()&&ha.games.others.forEach(((e,t)=>{e.game.playbackSpeed(.25)}))})),e("replaytools_button_50x").addEventListener("click",(function(e){Gt&&ha.games.others[0].game.playbackSpeed()&&ha.games.others.forEach(((e,t)=>{e.game.playbackSpeed(.5)}))})),e("replaytools_button_1x").addEventListener("click",(function(e){Gt&&ha.games.others[0].game.playbackSpeed()&&ha.games.others.forEach(((e,t)=>{e.game.playbackSpeed(1)}))})),e("replaytools_button_2x").addEventListener("click",(function(e){Gt&&ha.games.others[0].game.playbackSpeed()&&ha.games.others.forEach(((e,t)=>{e.game.playbackSpeed(2)}))})),e("replaytools_button_5x").addEventListener("click",(function(e){Gt&&ha.games.others[0].game.playbackSpeed()&&ha.games.others.forEach(((e,t)=>{e.game.playbackSpeed(5)}))})),e("replaytools_button_10x").addEventListener("click",(function(e){Gt&&ha.games.others[0].game.playbackSpeed()&&ha.games.others.forEach(((e,t)=>{e.game.playbackSpeed(10)}))})),e("replaytools_button_playpause").addEventListener("click",(function(t){if(Gt){if(ha.games.others[0].game.playbackSpeed())return e("replaytools_button_playpause").innerHTML="",void ha.games.others.forEach(((e,t)=>{e.game.playbackSpeed(0)}));e("replaytools_button_25x").classList.contains("active")?ha.games.others.forEach(((e,t)=>{e.game.playbackSpeed(.25)})):e("replaytools_button_50x").classList.contains("active")?ha.games.others.forEach(((e,t)=>{e.game.playbackSpeed(.5)})):e("replaytools_button_1x").classList.contains("active")?ha.games.others.forEach(((e,t)=>{e.game.playbackSpeed(1)})):e("replaytools_button_2x").classList.contains("active")?ha.games.others.forEach(((e,t)=>{e.game.playbackSpeed(2)})):e("replaytools_button_5x").classList.contains("active")?ha.games.others.forEach(((e,t)=>{e.game.playbackSpeed(5)})):e("replaytools_button_10x").classList.contains("active")&&ha.games.others.forEach(((e,t)=>{e.game.playbackSpeed(10)})),e("replaytools_button_playpause").innerHTML=""}})),e("replaytools_button_forward_frame").addEventListener("click",(function(t){if(!Gt)return;if(e("replaytools").classList.contains("disabled"))return;ha.games.others[0].game.export().source.getFrame()>=zt||ha.games.others.forEach(((e,t)=>{e.game.advanceFrames(1)}))})),e("replaytools_button_forward_piece").addEventListener("click",(function(t){if(!Gt)return;if(e("replaytools").classList.contains("disabled"))return;const s=ha.games.others[0].game.export().source.getFrame();for(let e=0;e<Xt.length;e++)if(Xt[e]>s)return void ha.games.others.forEach(((t,a)=>{t.game.advanceFrames(Xt[e]-s)}))})),e("replaytools_button_forward_large").addEventListener("click",(function(t){if(!Gt)return;if(e("replaytools").classList.contains("disabled"))return;const s=ha.games.others[0].game.export().source.getFrame();s>=zt||ha.games.others.forEach(((e,t)=>{e.game.advanceFrames(Math.min(zt-s,300),!0)}))})),e("replaytools_button_backward_frame").addEventListener("click",(function(t){Gt&&(e("replaytools").classList.contains("disabled")||ha.games.others.forEach(((e,t)=>{o(e.game,Bt[t],1)})))})),e("replaytools_button_backward_piece").addEventListener("click",(function(t){if(!Gt)return;if(e("replaytools").classList.contains("disabled"))return;const s=ha.games.others[0].game.export().source.getFrame();for(let e=Xt.length-1;e>=0;e--)if(Xt[e]<s)return void ha.games.others.forEach(((t,a)=>{o(t.game,Bt[a],s-Xt[e])}))})),e("replaytools_button_backward_large").addEventListener("click",(function(t){Gt&&(e("replaytools").classList.contains("disabled")||ha.games.others.forEach(((e,t)=>{o(e.game,Bt[t],300)})))})),e("replaytools_seekbar").addEventListener("mousedown",(function(s){if(!Gt)return;if(e("replaytools").classList.contains("disabled"))return;t=!0;const a=ha.games.others[0].game.export().source.getFrame(),o=Math.floor(Math.min(1,Math.max(0,(s.clientX-16)/(window.innerWidth-32)))*zt);a!==o&&ha.games.others.forEach(((e,t)=>{n(e.game,Bt[t],o)}))})),document.addEventListener("mouseup",(e=>{Gt&&(t=!1)})),document.addEventListener("mousemove",(o=>{if(Gt){if(e("replaytools").classList.contains("disabled"))return t=!1,void(s=!1);if(t){const e=ha.games.others[0].game.export().source.getFrame(),t=Math.floor(Math.min(1,Math.max(0,(event.clientX-16)/(window.innerWidth-32)))*zt);e!==t&&ha.games.others.forEach(((e,s)=>{n(e.game,Bt[s],t)}))}if(s){const t=Math.floor(Math.min(1,Math.max(0,(event.clientX-16)/(window.innerWidth-32)))*zt),s=t/zt*100;e("replaytools_seekbar_tip").setAttribute("style",`--progress: ${s}%;`),e("replaytools_seekbar").setAttribute("data-border-snapped",s<=10?"left":s>=90?"right":"none");const n=a(1e3*t/60);let o=0,i=0;for(let e=Bt[0].vsFrames.length-1;e>=0;e--)if(Bt[0].vsFrames[e][0]<=t){o=Bt[0].vsFrames[e][1];break}for(let e=Bt[1].vsFrames.length-1;e>=0;e--)if(Bt[1].vsFrames[e][0]<=t){i=Bt[1].vsFrames[e][1];break}e("replaytools_seekbar_tip").innerHTML=`\n\t\t\t\t<div class="seekbar_tip_time">${n.m}:${n.s}.${n.ms}</div>\n\t\t\t\t<div class="seekbar_tip_stat"><span class="sl">${o.toFixed(2)}</span> VS --- <span class="sr">${i.toFixed(2)}</span> VS</div>\n\t\t\t`}}}))})),U.ready((function(e){ys(!0),window.addEventListener("resize",(()=>{ys(!0)}),!1),setTimeout((()=>{ys(!0)}),10)}));let Zt=0,Jt=0,Qt=1,es=1,ts=0,ss=1;const as=30,ns={top:new Map,left:new Map,right:new Map,bottom:new Map};let os=0,is=0;const rs=1600,ls=800;let cs=1,ds=0,ps=0,us=0,ms=0,gs=0,hs=0,fs=0,_s=0,bs=!0;function ys(t){if(!t&&!bs)return;t||(bs=!1),Zt=window.innerWidth,Qt=window.innerHeight,Jt=Zt-2*as-Array.from(ns.left.values()).reduce(((e,t)=>e+t),0)-Array.from(ns.right.values()).reduce(((e,t)=>e+t),0),es=Qt-2*as-Array.from(ns.top.values()).reduce(((e,t)=>e+t),0)-Array.from(ns.bottom.values()).reduce(((e,t)=>e+t),0),ts=Jt/Math.max(1,es),ss=te.video.zoom||1,ts<2?(os=Jt,is=Jt/2):(os=2*es,is=es),cs=os/rs*ss,ds=Jt-os,ps=es-is,us=as+Array.from(ns.left.values()).reduce(((e,t)=>e+t),0)+ds/2,ms=window.innerWidth-(as+Array.from(ns.right.values()).reduce(((e,t)=>e+t),0)+ds/2),gs=as+Array.from(ns.top.values()).reduce(((e,t)=>e+t),0)+ps/2,hs=window.innerHeight-(as+Array.from(ns.bottom.values()).reduce(((e,t)=>e+t),0)+ps/2);fs=us+(ms-us)/2-cs*rs/2,_s=gs+(hs-gs)/2-cs*ls/2,s('canvas[data-fit="screen"]').forEach((e=>{e.width=Zt,e.height=Qt})),s('canvas[data-fit="contain"]').forEach((e=>{e.width=os,e.height=is,e.style.left=`${fs}px`,e.style.top=`${_s}px`})),s('canvas[data-fit="constrain"]').forEach((e=>{e.width=e.getAttribute("data-w")*cs,e.height=e.getAttribute("data-h")*cs})),e("sbt")&&(e("sbt").style.left=`${as+Array.from(ns.left.values()).reduce(((e,t)=>e+t),0)}px`,e("sbt").style.top=`${as+Array.from(ns.top.values()).reduce(((e,t)=>e+t),0)}px`,e("sbt").style.right=`${as+Array.from(ns.right.values()).reduce(((e,t)=>e+t),0)}px`,e("sbt").style.bottom=`${as+Array.from(ns.bottom.values()).reduce(((e,t)=>e+t),0)}px`),document.documentElement.style.setProperty("--r",cs),jn&&(Qn(),jn.position.set(fs,_s),Dn&&Dn.fit()),ki&&t&&ki.forEach((e=>{e.flushCanvases()}))}function vs(){ki&&ki.forEach((e=>{"tiny"!==e.getDisplayMode()&&e.flushCanvases()}))}function ws(e,t,s){ns[e].get(t)!==s&&(ns[e].set(t,s),ys(!0))}function ks(e,t){void 0!==ns[e].get(t)&&(ns[e].delete(t),ys(!0))}function Ls(e){return e*cs}function Es(e){return e/cs}function xs(e){return e*(30/92)}function Ts(e){return e/(30/92)}function Is(e){return Ls(xs(e))}function Ss(e){return Es(Ts(e))}const Ms=new Howl({src:["/sfx/tetrio.ogg"+(window.HARD_VER?`?hv=${window.HARD_VER}`:""),"/sfx/tetrio.mp3"+(window.HARD_VER?`?hv=${window.HARD_VER}`:"")],sprite:TETRIO_SE_SHEET,preload:!1,pool:5,volume:0,onload:()=>{U.finishLoad("sfx")},onloaderror:(e,t)=>{console.error(`Could not load sounds [${e}]: ${t}`)}}),As=new Howl({src:"/res/silence.ogg",loop:!0}),Cs=["mission","mission_free","mission_versus","mission_league","cutin_superlobby","victory","failure","matchintro"],Rs=["social_dm","social_invite","social_notify_major","social_notify_minor","social_offline","social_online"];g((()=>{Ms.load()})),U.ready((function(e){window.IS_ELECTRON||As.play()}));let Hs=0,$s=null;const Os={play:function(e,t=1,s=0,a=!1){if(!0===te.volume.disable)return;if(["o","l","j","z","s","t","i"].includes(e)&&!1===te.volume.next&&!a)return;if(["garbage_out_small","garbage_in_small","garbage_out_medium","garbage_in_medium","garbage_out_large","garbage_in_large","counter","offset","damage_small","damage_medium","damage_large","impact","damage_alert"].includes(e)&&("minimal"===te.video.graphics||!1===te.volume.attacks)&&!a)return;let n=1;if(n=Cs.includes(e)?Math.min(t*te.volume.music,1):te.notifications.forcesound&&Rs.includes(e)?1:Math.min(t*te.volume.sfx,1),n<=0)return;const o=Ms.play(e);return Ms.volume(n,o),"minimal"!==te.video.graphics&&0!==s&&Ms.stereo(s,o),"minimal"!==te.video.graphics&&"elim"===e&&($s&&(clearTimeout($s),$s=null),Ms.rate(Math.min(2,Math.pow(1.05946,Hs++)),o),$s=setTimeout((()=>{Hs=0,$s=null}),1e4)),o},playIngame:function(e,t,s,a,n,o,i=1){if(!0===te.volume.disable)return;if(!o&&("minimal"===te.video.graphics||!1===te.volume.others))return;if("full"!==t){if("tiny"===t)return;a*=n?.2:.05}if(n&&0!==i||(a*=i),0===a)return;const r=Math.max(-1,Math.min(1,s*(void 0===te.volume.stereo?.5:te.volume.stereo)));return this.play(e,a,r)},stop:function(e){!0!==te.volume.disable&&Ms.stop(e)}},Ps=function(){let e,t=0,s=null;const a={"kuchu-toshi":{name:"aerial city",jpname:"",artist:"CHIKA",jpartist:"",genre:"INTERFACE",source:"HURT RECORD",loop:!0,loopStart:11831,loopLength:80748},"shikiichi-made-mousukoshi":{name:"to the limit",jpname:"",artist:"KAMIYA",jpartist:"",genre:"INTERFACE",source:"HURT RECORD",loop:!0,loopStart:3719,loopLength:89312},touhoudaiensei:{name:"the great eastern expedition",jpname:"",artist:"TAKAYUKI",jpartist:"",genre:"INTERFACE",source:"HURT RECORD",loop:!0,loopStart:10694,loopLength:205986},"asayake-no-taiyou":{name:"morning sun",jpname:"",artist:"KAMOKING",jpartist:"",genre:"INTERFACE",source:"HURT RECORD",loop:!0,loopStart:3009,loopLength:63999},"in-sorrow-and-pains":{name:"in sorrow and pains",jpname:"in sorrow and pains",artist:"MIRERA",jpartist:"",genre:"INTERFACE",source:"HURT RECORD",loop:!0,loopStart:4503,loopLength:94030},"honemi-ni-shimiiru-karasukaze":{name:"piercing wind",jpname:"",artist:"KVK",jpartist:"KVK",genre:"CALM",source:"HURT RECORD",loop:!0,loopStart:7432,loopLength:142958},inorimichite:{name:"inorimichite",jpname:"",artist:"CHIKA",jpartist:"",genre:"CALM",source:"HURT RECORD",loop:!0,loopStart:15670,loopLength:181685},"kaze-no-sanpomichi":{name:"wind trail",jpname:"",artist:"CHIKA",jpartist:"",genre:"CALM",source:"HURT RECORD",loop:!0,loopStart:12865,loopLength:214284},"muscat-to-shiroi-osara":{name:"muscat and white dishes",jpname:"",artist:"TAKAHASHI TAKASHI",jpartist:"",genre:"CALM",source:"HURT RECORD",loop:!0,loopStart:8853,loopLength:184e3},"natsuzora-to-syukudai":{name:"summer sky and homework",jpname:"",artist:"TAKAHASHI TAKASHI",jpartist:"",genre:"CALM",source:"HURT RECORD",loop:!0,loopStart:20885,loopLength:111997},"success-story":{name:"success story",jpname:"success story",artist:"AKIKO SHIOYAMA",jpartist:"AKIKO SHIOYAMA",genre:"INTERFACE",source:"HURT RECORD",loop:!0,loopStart:25342,loopLength:78407},"kaiser-hige-na-neko":{name:"classy cat",jpname:"",artist:"KAMOKING",jpartist:"",genre:"INTERFACE",source:"HURT RECORD",loop:!0,loopStart:0,loopLength:104002},akindo:{name:"akindo",jpname:"AKINDO",artist:"CHIKA",jpartist:"",genre:"CALM",source:"HURT RECORD",loop:!0,loopStart:7864,loopLength:112166},"hyper-velocity":{name:"hyper velocity",jpname:"",artist:"KAMOKING",jpartist:"",genre:"SPECIAL",source:"HURT RECORD",loop:!1,loopStart:121011,loopLength:0,hidden:!0},philosophy:{name:"philosophy",jpname:"philosophy",artist:"L-side",jpartist:"L-side",genre:"INTERFACE",source:"HURT RECORD",loop:!0,loopStart:9324,loopLength:113450},"yoru-no-niji":{name:"rainbow of the night",jpname:"",artist:"AIBA MAKOTO",jpartist:"",genre:"CALM",source:"HURT RECORD",loop:!0,loopStart:3651,loopLength:140385},"shiroi-hyoutan":{name:"white calabash",jpname:"",artist:"CHIKA",jpartist:"",genre:"SPECIAL",source:"HURT RECORD",loop:!0,loopStart:17430,loopLength:122264},smoke:{name:"smoke",jpname:"smoke",artist:"FUJINAWA KAZUHIKO",jpartist:"",genre:"INTERFACE",source:"HURT RECORD",loop:!0,loopStart:5099,loopLength:134400},"aijin-sanka":{name:"lover's song",jpname:"",artist:"OMEGANE",jpartist:"",genre:"INTERFACE",source:"HURT RECORD",loop:!0,loopStart:3835,loopLength:44657},"akai-tsuchi-wo-funde":{name:"step on the scarlet soil",jpname:"",artist:"KAMOKING",jpartist:"",genre:"CALM",source:"HURT RECORD",loop:!0,loopStart:2783,loopLength:123433},"burari-tokyo":{name:"hanging out in tokyo",jpname:"TOKYO",artist:"MEESAN",jpartist:"",genre:"CALM",source:"HURT RECORD",loop:!0,loopStart:9680,loopLength:134359},"back-water":{name:"backwater",jpname:"",artist:"KAMOKING",jpartist:"",genre:"BATTLE",source:"HURT RECORD",loop:!0,loopStart:1497,loopLength:112006},"burning-heart":{name:"burning heart",jpname:"burning heart",artist:"KAMOKING",jpartist:"",genre:"BATTLE",source:"HURT RECORD",loop:!0,loopStart:0,loopLength:76803},"hayate-no-sei":{name:"storm spirit",jpname:"",artist:"KAMOKING",jpartist:"",genre:"BATTLE",source:"HURT RECORD",loop:!0,loopStart:24815,loopLength:95937},"ice-eyes":{name:"ice eyes",jpname:"",artist:"KAMOKING",jpartist:"",genre:"BATTLE",source:"HURT RECORD",loop:!0,loopStart:6867,loopLength:89146},"ima-koso":{name:"the time is now",jpname:"",artist:"TOMOKI",jpartist:"TOMOKI",genre:"BATTLE",source:"HURT RECORD",loop:!0,loopStart:5489,loopLength:106635},prism:{name:"prism",jpname:"",artist:"AIBA MAKOTO",jpartist:"",genre:"CALM",source:"HURT RECORD",loop:!0,loopStart:0,loopLength:92130},"risky-area":{name:"risky area",jpname:"risky area",artist:"MIKIYA KOMABA",jpartist:"MIKIYA KOMABA",genre:"BATTLE",source:"HURT RECORD",loop:!0,loopStart:31480,loopLength:291144},"fuyu-no-jinkoueisei":{name:"winter satellite",jpname:"",artist:"SUDO MIKADUKI",jpartist:"",genre:"CALM",source:"HURT RECORD",loop:!0,loopStart:25956,loopLength:149172},hatsuyuki:{name:"first snow",jpname:"",artist:"YOSHI",jpartist:"YOSHI",genre:"CALM",source:"HURT RECORD",loop:!0,loopStart:21974,loopLength:122850},"kansen-gairo":{name:"main street",jpname:"",artist:"CHIKA",jpartist:"",genre:"CALM",source:"HURT RECORD",loop:!0,loopStart:17757,loopLength:183218},"chiheisen-wo-koete":{name:"over the horizon",jpname:"",artist:"KAMOKING",jpartist:"",genre:"BATTLE",source:"HURT RECORD",loop:!0,loopStart:2423,loopLength:63979},"moyase-toushi-yobisamase-tamashii":{name:"burning spirit, awakening soul",jpname:"",artist:"KAMOKING",jpartist:"",genre:"BATTLE",source:"HURT RECORD",loop:!0,loopStart:15380,loopLength:54858},"naraku-heno-abyssmaze":{name:"maze of the abyss",jpname:"",artist:"KAMOKING",jpartist:"",genre:"BATTLE",source:"HURT RECORD",loop:!0,loopStart:5133,loopLength:117961},"samurai-sword":{name:"samurai sword",jpname:"SAMURAI SWORD",artist:"KAMOKING",jpartist:"",genre:"BATTLE",source:"HURT RECORD",loop:!0,loopStart:6587,loopLength:105597},"super-machine-soul":{name:"super machine soul",jpname:"",artist:"KAMOKING",jpartist:"",genre:"BATTLE",source:"HURT RECORD",loop:!0,loopStart:22335,loopLength:96e3},"uchuu-5239":{name:"universe 5239",jpname:"5239",artist:"KAMOKING",jpartist:"",genre:"BATTLE",source:"HURT RECORD",loop:!0,loopStart:15555,loopLength:83117},"ultra-super-heros":{name:"ultra super heroes",jpname:"",artist:"KAMOKING",jpartist:"",genre:"BATTLE",source:"HURT RECORD",loop:!0,loopStart:1315,loopLength:104958},"21seiki-no-hitobito":{name:"twenty-first century people",jpname:"21",artist:"OMEGANE",jpartist:"",genre:"CALM",source:"HURT RECORD",loop:!0,loopStart:0,loopLength:131311},"haru-wo-machinagara":{name:"waiting for spring to come",jpname:"",artist:"OMEGANE",jpartist:"",genre:"CALM",source:"HURT RECORD",loop:!0,loopStart:5780,loopLength:160015},"go-go-go-summer":{name:"go go go summer",jpname:"go go go summer",artist:"NOBUHAMU",jpartist:"NOBUHAMU",genre:"CALM",source:"HURT RECORD",loop:!0,loopStart:838,loopLength:74661},"sasurai-no-hitoritabi":{name:"lonely journey",jpname:"",artist:"NAOKI HIRAI",jpartist:"NAOKI HIRAI",genre:"CALM",source:"HURT RECORD",loop:!0,loopStart:4044,loopLength:145154},wakana:{name:"young leaves",jpname:"",artist:"CHIKA",jpartist:"",genre:"CALM",source:"HURT RECORD",loop:!0,loopStart:14819,loopLength:178883},"zange-no-ma":{name:"confession",jpname:"",artist:"OMEGANE",jpartist:"",genre:"CALM",source:"HURT RECORD",loop:!0,loopStart:0,loopLength:80533},"subarashii-nichijou":{name:"amazing everyday",jpname:"",artist:"TSUTOMU",jpartist:"TSUTOMU",genre:"CALM",source:"HURT RECORD",loop:!0,loopStart:12399,loopLength:128e3},asphalt:{name:"asphalt",jpname:"asphalt",artist:"CHIKA",jpartist:"",genre:"CALM",source:"HURT RECORD",loop:!0,loopStart:5624,loopLength:69711},"madobe-no-hidamari":{name:"by the sunlit window",jpname:"",artist:"CHIKA",jpartist:"",genre:"CALM",source:"HURT RECORD",loop:!0,loopStart:26203,loopLength:65572},minamoto:{name:"origin",jpname:"",artist:"CHIKA",jpartist:"",genre:"CALM",source:"HURT RECORD",loop:!0,loopStart:135024,loopLength:187926},"sora-no-sakura":{name:"cherry blossom season",jpname:"",artist:"CHIKA",jpartist:"",genre:"CALM",source:"HURT RECORD",loop:!0,loopStart:0,loopLength:336018},suiu:{name:"raindrops",jpname:"",artist:"CHIKA",jpartist:"",genre:"CALM",source:"HURT RECORD",loop:!0,loopStart:15058,loopLength:106578},"freshherb-wreath-wo-genkan-ni":{name:"entrance wreath",jpname:"",artist:"CHIKA",jpartist:"",genre:"CALM",source:"HURT RECORD",loop:!0,loopStart:5169,loopLength:84335}},n={random:["kaze-no-sanpomichi","honemi-ni-shimiiru-karasukaze","inorimichite","muscat-to-shiroi-osara","natsuzora-to-syukudai","akindo","yoru-no-niji","akai-tsuchi-wo-funde","burari-tokyo","prism","back-water","burning-heart","hayate-no-sei","ice-eyes","ima-koso","risky-area","fuyu-no-jinkoueisei","hatsuyuki","kansen-gairo","chiheisen-wo-koete","moyase-toushi-yobisamase-tamashii","naraku-heno-abyssmaze","samurai-sword","super-machine-soul","uchuu-5239","ultra-super-heros","21seiki-no-hitobito","haru-wo-machinagara","go-go-go-summer","sasurai-no-hitoritabi","wakana","zange-no-ma","subarashii-nichijou","asphalt","madobe-no-hidamari","minamoto","sora-no-sakura","suiu","freshherb-wreath-wo-genkan-ni"],calm:["kaze-no-sanpomichi","honemi-ni-shimiiru-karasukaze","inorimichite","muscat-to-shiroi-osara","natsuzora-to-syukudai","akindo","yoru-no-niji","akai-tsuchi-wo-funde","burari-tokyo","prism","fuyu-no-jinkoueisei","hatsuyuki","kansen-gairo","21seiki-no-hitobito","haru-wo-machinagara","go-go-go-summer","sasurai-no-hitoritabi","wakana","zange-no-ma","subarashii-nichijou","asphalt","madobe-no-hidamari","minamoto","sora-no-sakura","suiu","freshherb-wreath-wo-genkan-ni"],battle:["back-water","burning-heart","hayate-no-sei","ice-eyes","ima-koso","risky-area","chiheisen-wo-koete","moyase-toushi-yobisamase-tamashii","naraku-heno-abyssmaze","samurai-sword","super-machine-soul","uchuu-5239","ultra-super-heros"]};function o(n){if(!0===te.volume.disable)return;const o=a[n],i=++t;e=new Howl({src:`res/bgm/${n}.mp3`,sprite:{start:[0,o.loopStart,!o.loopLength&&o.loop],loop:[o.loopStart,o.loopLength,o.loop]},volume:te.volume.music,autoplay:!1,onload:()=>{t===i&&(e.play("start"),s=n,o.loopLength&&setTimeout((()=>{t===i&&e.play("loop")}),o.loopStart))}})}function i(e,t=1e3){!0!==te.volume.disable&&s!==e&&r(t,(()=>{o(e)}))}function r(a,n=(()=>{})){if(!0===te.volume.disable)return;const o=++t;e&&e.fade(e.volume(),0,a),s=null,setTimeout((()=>{t===o&&(e&&e.stop(),n())}),a)}function l(e){let t=[];return n[e].forEach((e=>{let s=0;switch((te.volume.bgmtweak||{})[e]||"base"){case"ban":s=0;break;case"minmin":s=1;break;case"min":s=2;break;case"base":s=4;break;case"plus":s=8;break;case"plusplus":s=16}for(let a=0;a<s;a++)t.push(e)})),0===t.length&&(t=n[e]),t[Math.floor(Math.random()*t.length)]}return{ost:a,randomOstPools:n,playing:function(){return s},play:function(e){o(e)},playSmooth:function(e,t=1e3){i(e,t)},stop:function(e=1e3){r(e)},setVolume:function(t){!function(t){!0!==te.volume.disable&&e&&e.volume(t)}(t)},playSmoothOrRandom:function(e){if(!0!==te.volume.disable)if("RANDOM"===e){const e=l("random");i(e),Je(e)}else if("RANDOM"===e.substring(0,6)){if(!n[e.substring(6)])return void T("invalid song selected. will not play!");const t=l(e.substring(6));i(t),Je(t)}else{if(!a[e])return void T("invalid song selected. will not play!");i(e),Je(e)}}}}(),Ds=(()=>{function t(e,t){if(/(^[Rr]:.+$)/.test(e)){const s=e.replace("R:","").replace("r:","").split("@")[0],a=e.replace("R:","").replace("r:","").split("@")[1];ct("fetching replay"),w.get(`/api/games/${encodeURIComponent(s)}${t?"/short":""}`).then((e=>{dt(),Ps.playSmooth(document.body.classList.contains("inpair")||document.body.classList.contains("matchmaking")?"touhoudaiensei":"shikiichi-made-mousukoshi"),e.game.ismulti?Ut.showMultiLog({...e.game,back:"tetra",context:a}):Ut.showResults(e.game.endcontext,{gametype:e.game.endcontext.gametype,back:"tetra",isreplay:!0,username:e.game.user.username,ts:e.game.ts,replay:e.game})}),(e=>{dt(),S(e)}))}else Ns({username:e.toLowerCase()})}return{loadSpecialThanks:function(){w.get("/api/tetra/specialthanks").then((t=>{let s="";t.supporters.forEach((e=>{s+=`<div class="flex-item"><a class="credit_st ${e.username?`tetra_pop" data-hover="tap" data-hit="click" data-username="${e.username}"`:'noclick"'}>${e.flip?e.username.toUpperCase():e.name}</a><span class="jp_kana">${e.username&&e.username.toUpperCase()!==e.name?e.flip?e.name:e.username.toUpperCase():""}</span></div>`})),e("specialthanks").innerHTML=s}),(t=>{e("specialthanks").innerHTML='<div class="flex-item">error fetching special thanks</div>'}))},loadNews:function(){w.get("/api/tetra/news").then((t=>{let s="";t.news.forEach((e=>{if(s+='<div class="tetra_news_item">',"leaderboard"===e.type){let t=e.data.rank<=3?`leaderboard${e.data.rank}`:"improvement",n="";switch(e.data.gametype){case"40l":case"5mblast":const t=a(e.data.result);n=`time of <a class="replay_pop" data-hover="tap" data-hit="click" data-replay="R:${e.data.replayid}">${t.m}:${t.s}.${t.ms}</a>`;break;case"blitz":n=`score of <a class="replay_pop" data-hover="tap" data-hit="click" data-replay="R:${e.data.replayid}">${e.data.result.toLocaleString("en-US")}</a>`}s+=`<img class="ns" src="/res/badges/${t}.png" /><a class="tetra_pop" data-hover="tap" data-hit="click" data-username="${e.data.username}">${e.data.username.toUpperCase()}</a> reached #${e.data.rank} in ${Ao.longTypeNames[e.data.gametype]} with a ${n}`}else"badge"===e.type&&(s+=`<img class="ns" src="/res/badges/${e.data.type}.png" /><a class="tetra_pop" data-hover="tap" data-hit="click" data-username="${e.data.username}">${e.data.username.toUpperCase()}</a> received the <span>"${r(e.data.label.toLowerCase())}"</span> badge`);s+=`<div class="tetra_news_ts" title="${new Date(e.ts).toLocaleString()}">${n(Date.parse(e.ts))} ago</div></div>`})),""===s&&(s='<div class="tetra_news_empty">NO NEWS</div>'),e("tetra_news_content").innerHTML=s}),(t=>{e("tetra_news_content").innerHTML='<div class="tetra_news_empty">ERROR FETCHING NEWS</div>'}))},loadTwitch:function(){w.get("/api/tetra/twitch").then((t=>{let s="";t.live.forEach((e=>{s+=`<a class="tetra_live_item" data-hover="tap" data-hit="click" href="https://www.twitch.tv/${r(e.login)}" target="_blank" data-title="${r(e.title)}">${r(e.username)}<span>${r(e.viewers)}</span><img src="${r(e.thumbnail)}" /></a>`})),e("tetra_live").classList.toggle("hidden",""===s),e("tetra_live_content").innerHTML=s}),(()=>{}))},loadRecords:function(t,s){return new Promise(((n,o)=>{ct("fetching records"),w.get(`/api/records/${encodeURIComponent(t.replace("CURRENTID",z.id()))}`).then((o=>{dt(),function(t,s,n){const o=e(`tetra_stream__${t}`);if(!o)throw"there is no holder?";o.innerHTML="";let i=1;if(s.forEach((e=>{const s=a(e.endcontext.finalTime),r=e.endcontext.finalTime/1e3||1;t.startsWith("league_")&&e.endcontext[1].user._id===z.id()&&e.endcontext.reverse();const l=document.createElement("div");l.classList.add("scroller_block"),l.classList.add("record_item"),l.classList.toggle("record_disputed",e.disputed_until>Date.now()),l.classList.add("ns"),l.setAttribute("data-hover","hover"),l.setAttribute("data-hit","hit3"),1===i&&l.classList.add("record_first"),o.appendChild(l);const c=document.createElement("div");c.classList.add("record_grade"),c.classList.add("ns"),c.innerHTML=i,l.appendChild(c);const d=document.createElement("div");d.classList.add("record_owner"),t.startsWith("any_")?d.innerHTML=Ao.longTypeNames[e.endcontext.gametype]:t.startsWith("league_")?d.innerHTML=`${co("VS")} ${e.endcontext[1].user.username.toUpperCase()}`:d.innerHTML=e.user.username.toUpperCase(),l.appendChild(d);const p=document.createElement("div");p.classList.add("record_ts"),p.innerHTML=new Date(e.ts).toLocaleString(),l.appendChild(p);const u=document.createElement("div");if(u.classList.add("record_result"),l.appendChild(u),t.startsWith("league_"))e.endcontext[0].active?e.endcontext[1].active?e.endcontext[0].points.primary>e.endcontext[1].points.primary?u.innerHTML=`${co("VICTORY")} ${e.endcontext[0].points.primary}-${e.endcontext[1].points.primary}`:e.endcontext[0].points.primary<e.endcontext[1].points.primary?u.innerHTML=`${co("DEFEAT")} ${e.endcontext[0].points.primary}-${e.endcontext[1].points.primary}`:u.innerHTML=`${co("TIE")} ${e.endcontext[0].points.primary}-${e.endcontext[1].points.primary}`:u.innerHTML="opponent forfeited":u.innerHTML="you forfeited";else switch(e.endcontext.gametype){case"40l":case"5mblast":u.innerHTML=`${s.m}:${s.s}<span class="ms">.${s.ms}</span>`;break;case"blitz":u.innerHTML=`${e.endcontext.score.toLocaleString("en-US")}`}const m=document.createElement("div");m.classList.add("record_extra"),t.startsWith("league_")?m.innerHTML=`<span>${e.endcontext[0].points.tertiary.toFixed(2)}</span> PPS - <span>${e.endcontext[0].points.secondary.toFixed(2)}</span> APM - <span>${e.endcontext[0].points.extra.vs.toFixed(2)}</span> VS`:m.innerHTML=`<span>${e.endcontext.piecesplaced}</span> PCS - <span>${(e.endcontext.piecesplaced/r).toFixed(2)}</span> PPS`,l.appendChild(m),l.addEventListener("click",(()=>{ct("fetching replay"),w.get(`/api/games/${encodeURIComponent(e.replayid)}`).then((e=>{dt(),e.game.ismulti?Ut.showMultiLog({...e.game,back:"tetra_me"}):Ut.showResults(e.game.endcontext,{gametype:e.game.endcontext.gametype,back:n,isreplay:!0,username:e.game.user.username,ts:e.game.ts,replay:e.game})}),(e=>{dt(),S(e)}))})),i++})),!s.length){const e=document.createElement("div");e.classList.add("scroller_block"),e.classList.add("ns"),e.classList.add("nothing"),e.innerHTML="NO RECORDS",o.appendChild(e)}}(t,o.records.slice(0,100),s),n(o)}),(e=>{dt(),S(e),o()}))}))},loadUserList:function(t,s){return new Promise(((a,n)=>{ct("fetching players"),w.get(s).then((n=>{dt(),function(t,s,a){const n=e(t);if(!n)throw"there is no holder?";n.innerHTML="";let o=1;if(s.forEach((e=>{if("/api/users/by/xp"===a&&(!e.xp||"anon"===e.role||"bot"===e.role))return;const t=document.createElement("div");t.classList.add("scroller_block"),t.classList.add("ns"),t.classList.add("record_item"),t.setAttribute("data-hover","hover"),t.setAttribute("data-hit","hit3"),1===o&&t.classList.add("record_first"),n.appendChild(t);const s=document.createElement("div");s.classList.add("record_grade"),s.classList.add("ns"),s.innerHTML=o,t.appendChild(s);const i=document.createElement("div");if(i.classList.add("record_owner"),i.innerHTML=`${e.username.toUpperCase()}${e.supporter?'<img src="/res/supporter-tag.png" title="This person is supporting TETR.IO " />':""}${e.country?`<img class="flag" src="/res/flags/${e.country.toLowerCase()}.png" title="${Co[e.country]}" />`:""}`,t.appendChild(i),"/api/users/by/xp"===a){const s=document.createElement("div");s.classList.add("record_ts"),s.innerHTML=`${Ws(e.xp)}% TOWARDS NEXT LEVEL`,t.appendChild(s);const a=document.createElement("div");a.classList.add("record_result"),t.appendChild(a),a.innerHTML=qs(js(e.xp));const n=document.createElement("div");n.classList.add("record_extra"),n.innerHTML=`<span>${Math.floor(e.xp)}</span> XP`,t.appendChild(n)}else if("/api/users/by/league"===a){const s=document.createElement("div");s.classList.add("record_ts"),s.innerHTML=`<span>${e.league.gameswon}</span> / ${e.league.gamesplayed} games won (<span>${Math.floor(e.league.gameswon/e.league.gamesplayed*1e4)/100}</span>%)`,t.appendChild(s);const a=document.createElement("div");a.classList.add("record_result"),t.appendChild(a),a.innerHTML=`${Math.round(e.league.rating)}<span>TR</span> <img src="/res/league-ranks/${e.league.rank}.png" />`,a.title=e.league.rating;const n=document.createElement("div");n.classList.add("record_extra"),n.innerHTML=`glicko: <span>${e.league.glicko}</span><span>${e.league.rd}</span>`,t.appendChild(n)}t.addEventListener("click",(()=>{Ns({userID:e._id})})),o++})),!s.length){const e=document.createElement("div");e.classList.add("scroller_block"),e.classList.add("ns"),e.classList.add("nothing"),e.innerHTML="NO PLAYERS",n.appendChild(e)}}(t,n.users,s),a(n)}),(e=>{dt(),S(e),n()}))}))},navigateToShortID:e=>t(e,!0),navigateToLongID:e=>t(e,!1)}})();function Ns(t){const s=document.createElement("div");s.classList.add("oob_modal"),s.classList.add("tetra_modal"),s.classList.add("hidden"),s.classList.add("busy"),e("dialogs").appendChild(s),setTimeout((()=>{s.classList.remove("hidden"),Ae.push(),Ae.bindGuide(Ce.tetra_dialog)}),1);const i=()=>{w.get(`/api/users/${encodeURIComponent(t.userID)}`).then((i=>{const r=on(i.user._id);let l=!1;if(r&&("friend"===r.type?(s.classList.add("tm_friend"),l=!0):"block"===r.type&&s.classList.add("tm_blocked")),(i.user.supporter||["admin","mod"].includes(i.user.role))&&i.user.banner_revision){const e=document.createElement("img");e.classList.add("tetra_modal_banner"),e.classList.add("ns"),e.src=`/user-content/banners/${i.user._id}.jpg?rv=${i.user.banner_revision}`,s.classList.add("has_banner"),s.appendChild(e);const t=document.createElement("div");t.classList.add("tetra_modal_banner_sep"),t.classList.add("ns"),s.appendChild(t)}const c=document.createElement("img");c.classList.add("avatar"),i.user.avatar_revision?c.src=`/user-content/avatars/${i.user._id}.jpg?rv=${i.user.avatar_revision}`:"banned"===i.user.role?c.src="/res/avatar-banned.png":"anon"===i.user.role?c.src="/res/avatar.png":c.src=u(i.user._id),s.appendChild(c);const d=document.createElement("h2");if(d.innerHTML=`${i.user.username.toUpperCase()}${i.user.verified?`<img src="/res/verified${(i.user.supporter||["admin","mod"].includes(i.user.role))&&i.user.banner_revision?"-light":""}.png" title="Verified" />`:""}${i.user.country?`<img class="flag" src="/res/flags/${i.user.country.toLowerCase()}.png" title="${Co[i.user.country]}" />`:""}`,s.appendChild(d),!["anon","bot","banned"].includes(i.user.role)){const e=document.createElement("h3");e.innerHTML=`${i.user.ts?`JOINED ${n(Date.parse(i.user.ts)).toUpperCase()} AGO`:"HERE SINCE THE BEGINNING"}${i.user.friendCount?` - <span title="Amount of players who have friended this person"><img src="/res/icon/friends${(i.user.supporter||["admin","mod"].includes(i.user.role))&&i.user.banner_revision?"":"-green"}.svg" />${i.user.friendCount}</span>`:""}${i.user.friendedYou?l?" - MUTUAL FRIENDS":" - FRIENDED YOU":""}`,s.appendChild(e)}const p=document.createElement("div");if(p.classList.add("tetra_modal_close"),p.classList.add("ns"),p.innerHTML="CLOSE",p.setAttribute("data-hover","tap"),p.setAttribute("data-hit","click"),s.appendChild(p),p.addEventListener("click",(()=>{N(s)})),i.user._id==z.id()&&Js!==i.user.xp&&(Ks(js(i.user.xp),e("me_level")),Qs(i.user.xp-Js,!0)),t.topbuttons=t.topbuttons||[],t.topbuttons.push(...Us(i.user)),t.topbuttons.length){const e=document.createElement("div");e.classList.add("tetra_topbutton_holder"),e.classList.add("ns"),s.appendChild(e),t.topbuttons.forEach((t=>{const a=document.createElement("div");a.classList.add("tetra_topbutton"),a.innerHTML=`${t.icon?`<img src="/res/icon/${t.icon}.svg" />`:""}${t.label}`,a.title=t.title||"",t.classes.forEach((e=>{a.classList.add(e)})),a.addEventListener("click",(()=>{t.callback((()=>{N(s)}),a,s)})),a.addEventListener("mouseout",(()=>{a.classList.remove("tb_unfriending")})),e.appendChild(a)}))}let m,g;if(m=i.user.gameswon>-1&&i.user.gamesplayed>-1?`<div class="tetra_tag_record" title="Online games won / online games played"><span>${i.user.gameswon}</span> / ${i.user.gamesplayed}</div>`:i.user.gameswon>-1?`<div class="tetra_tag_record" title="Online games won"><span>${i.user.gameswon}</span></div>`:i.user.gamesplayed>-1?`<div class="tetra_tag_record" title="Online games played">${i.user.gamesplayed}</div>`:"",g=i.user.gametime>-1?`<div class="tetra_tag_gametime" title="Total time played">${o(i.user.gametime)}</div>`:"",!["anon","bot","banned"].includes(i.user.role)){const e=document.createElement("div");e.classList.add("tetra_tag_holder"),e.classList.add("ns"),e.innerHTML=`${"admin"===i.user.role?'<img class="mod_badge" src="/res/administrator.png" title="This person is a TETR.IO Administrator." alt="Administrator" />':""}${"mod"===i.user.role?'<img class="mod_badge" src="/res/moderator.png" title="This person is a TETR.IO Moderator." alt="Moderator" />':""}${qs(js(i.user.xp))}${g}${m}${i.user.supporter?`<img class="supporter_badge" src="/res/supporter${i.user.supporter_tier}.png" title="This person is supporting TETR.IO " alt="Supporter" />`:""}`,s.appendChild(e)}if(i.user.badstanding){const e=document.createElement("div");e.classList.add("tetra_badstanding"),e.classList.add("ns"),e.innerHTML="<h1>BAD STANDING</h1><p>one or more recent bans on record</p>",s.appendChild(e)}const h=zs(i.user.badges);if(h.length){const e=document.createElement("div");e.classList.add("tetra_badge_holder"),e.classList.add("ns"),s.appendChild(e),h.forEach((t=>{if(t.badges.length>1){const s=document.createElement("div");s.classList.add("tetra_badge_group"),s.style=`--c: ${t.badges.length};`,e.appendChild(s),t.badges.forEach(((e,t)=>{Gs(e,s,t)}))}else Gs(t.badges[0],e)}))}if("anon"===i.user.role){const e=document.createElement("div");e.classList.add("tetra_modal_warning"),e.innerHTML="this user is playing anonymously",s.appendChild(e)}else if("banned"===i.user.role){const e=document.createElement("div");e.classList.add("tetra_modal_warning"),e.innerHTML="<h1>BANNED</h1>this user is currently banned. bans are placed when TETR.IO rules or terms of service are broken.",s.appendChild(e),s.classList.add("banned")}else if("bot"===i.user.role){const e=document.createElement("div");e.classList.add("tetra_modal_warning"),e.innerHTML="<h1>BOT</h1><br><br>this is a known bot. all bots must have this tag, or it and its owners will be permanently banned."+(i.user.botmaster?`<br><br>this bot is operated by <b>${i.user.botmaster}</b>`:""),s.appendChild(e)}else{const e=document.createElement("div");if(e.classList.add("tetra_modal_records"),e.classList.add("flex-row"),s.appendChild(e),0!==i.user.league.gamesplayed){const t=document.createElement("div");t.classList.add("tetra_modal_record"),t.classList.add("flex-item"),t.classList.add("tetra_modal_record_league"),i.user.league.gamesplayed>=10?(t.innerHTML=`<h6>TETRA LEAGUE</h6><h5 title="${i.user.league.rating}"><img src="/res/league-ranks/${i.user.league.rank}.png" />${Math.round(i.user.league.rating)}<span class="ms">TR</span><div class="standingset">${-1!==i.user.league.standing?`<div class="${1===i.user.league.standing?"t1":i.user.league.standing<=10?"t10":i.user.league.standing<=100?"t100":""}"><h1>GLOBAL</h1><p><span>#</span>${i.user.league.standing}</p></div>`:""}${-1!==i.user.league.standing_local?`<div class="${1===i.user.league.standing_local?"t1":i.user.league.standing_local<=10?"t10":i.user.league.standing_local<=100?"t100":""}"><h1>COUNTRY</h1><p><span>#</span>${i.user.league.standing_local}</p></div>`:""}</div></h5><h3><span>${i.user.league.apm||"---"}</span> apm <span>${i.user.league.pps||"---"}</span> pps <span>${i.user.league.vs||"---"}</span> vs</h3>`,t.classList.add("tetra_modal_record_league_active")):t.innerHTML=`<h6>TETRA LEAGUE</h6><h5>${i.user.league.gamesplayed}<span class="ms">/10 rating games</span></h5><h3><span>${i.user.league.gameswon}</span> game${1===i.user.league.gameswon?"":"s"} won</h3>`,e.appendChild(t)}if(i.user.records["40l"].record){const t=a(i.user.records["40l"].record.endcontext.finalTime),s=document.createElement("div");s.classList.add("tetra_modal_record"),s.classList.add("flex-item"),s.innerHTML=`<h6>${Ao.longTypeNames["40l"]}</h6><h5>${t.m}:${t.s}<span class="ms">.${t.ms}</span><div class="standingset">${i.user.records["40l"].rank?`<div class="${1===i.user.records["40l"].rank?"t1":i.user.records["40l"].rank<=10?"t10":i.user.records["40l"].rank<=100?"t100":""}"><h1>GLOBAL</h1><p><span>#</span>${i.user.records["40l"].rank}</p></div>`:""}</div></h5><h3><span>${n(Date.parse(i.user.records["40l"].record.ts)).toUpperCase()}</span> ago</h3>`,e.appendChild(s)}if(i.user.records.blitz.record){const t=document.createElement("div");t.classList.add("tetra_modal_record"),t.classList.add("flex-item"),t.innerHTML=`<h6>${Ao.longTypeNames.blitz}</h6><h5>${i.user.records.blitz.record.endcontext.score.toLocaleString("en-US")}<div class="standingset">${i.user.records.blitz.rank?`<div class="${1===i.user.records.blitz.rank?"t1":i.user.records.blitz.rank<=10?"t10":i.user.records.blitz.rank<=100?"t100":""}"><h1>GLOBAL</h1><p><span>#</span>${i.user.records.blitz.rank}</p></div>`:""}</div></h5><h3><span>${n(Date.parse(i.user.records.blitz.record.ts)).toUpperCase()}</span> ago</h3>`,e.appendChild(t)}}if(!["anon","bot","banned"].includes(i.user.role)){const e=document.createElement("div");e.classList.add("tetra_modal_jump"),e.classList.add("ns"),e.setAttribute("data-hover","tap"),e.setAttribute("data-hit","click"),e.innerHTML="VIEW FULL PROFILE",e.addEventListener("click",(()=>{N(s),window.open(`https://ch.tetr.io/u/${i.user.username}`,"_blank")})),e.addEventListener("auxclick",(e=>{1===e.button&&window.open(`https://ch.tetr.io/u/${i.user.username}`,"_blank")})),s.appendChild(e)}if(t.buttons=t.buttons||[],t.buttons.push(...Fs(i.user)),t.buttons.length){const e=document.createElement("div");e.classList.add("tetra_button_holder"),e.classList.add("flex-row"),e.classList.add("ns"),s.appendChild(e),t.buttons.forEach((t=>{const a=document.createElement("div");a.classList.add("tetra_button"),a.classList.add("flex-item"),a.innerHTML=t.label,t.classes.forEach((e=>{a.classList.add(e)})),a.addEventListener("click",(()=>{t.callback((()=>{N(s)}))})),e.appendChild(a)}))}s.classList.remove("busy"),Ae.rebind()}),(e=>{S(e),N(s)}))};return t.userID?i():w.get(`/api/users/${encodeURIComponent(t.username)}/resolve`).then((e=>{t.userID=e._id,i()}),(e=>{S(e),N(s)})),e("dialogs").classList.remove("hidden"),bt(),s}function Fs(e){return e._id!=z.id()&&!z.anon()&&e.role,[]}function Us(e){const t=[];if(e._id!=z.id()&&!z.anon()){if("banned"===e.role)return t.push({label:"",icon:"block",title:"Block user",classes:["notext","tb_danger","tb_notblockedonly"],callback:(t,s,a)=>{s.classList.add("busy"),w.post("/api/relationships/block",{user:e._id}).then((e=>{s.classList.remove("busy"),a.classList.add("tm_blocked")}),(e=>{s.classList.remove("busy"),S(e)}))}}),t.push({label:"UNBLOCK",icon:"block",title:"Unblock user",classes:["tb_blockedonly"],callback:(t,s,a)=>{s.classList.add("busy"),w.post("/api/relationships/remove",{user:e._id}).then((e=>{s.classList.remove("busy"),a.classList.remove("tm_blocked")}),(e=>{s.classList.remove("busy"),S(e)}))}}),t.push({label:"",icon:"friends",title:"Unfriend? (click twice)",classes:["notext","tb_friendonly","tb_unfriendbutton","tb_notblockedonly"],callback:(t,s,a)=>{s.classList.contains("tb_unfriending")?(s.classList.add("busy"),w.post("/api/relationships/remove",{user:e._id}).then((e=>{s.classList.remove("busy"),a.classList.remove("tm_friend")}),(e=>{s.classList.remove("busy"),S(e)}))):s.classList.add("tb_unfriending")}}),t;if(["anon"].includes(e.role))return t.push({label:"",icon:"report",title:"Report user",classes:["notext","tb_danger"],callback:(t,s,a)=>{t(),Bs(e,(()=>{s.classList.add("busy"),w.post("/api/relationships/block",{user:e._id}).then((e=>{s.classList.remove("busy"),a.classList.add("tm_blocked")}),(e=>{s.classList.remove("busy"),S(e)}))}))}}),t.push({label:"",icon:"block",title:"Block user",classes:["notext","tb_danger","tb_notblockedonly"],callback:(t,s,a)=>{s.classList.add("busy"),w.post("/api/relationships/block",{user:e._id}).then((e=>{s.classList.remove("busy"),a.classList.add("tm_blocked")}),(e=>{s.classList.remove("busy"),S(e)}))}}),t.push({label:"UNBLOCK",icon:"block",title:"Unblock user",classes:["tb_blockedonly"],callback:(t,s,a)=>{s.classList.add("busy"),w.post("/api/relationships/remove",{user:e._id}).then((e=>{s.classList.remove("busy"),a.classList.remove("tm_blocked")}),(e=>{s.classList.remove("busy"),S(e)}))}}),t;t.push({label:"",icon:"report",title:"Report user",classes:["notext","hidden","tb_overflow","tb_danger","tb_notfriendonly","tb_notblockedonly"],callback:(t,s,a)=>{t(),Bs(e,(()=>{s.classList.add("busy"),w.post("/api/relationships/block",{user:e._id}).then((e=>{s.classList.remove("busy"),a.classList.add("tm_blocked")}),(e=>{s.classList.remove("busy"),S(e)}))}))}}),t.push({label:"",icon:"block",title:"Block user",classes:["notext","hidden","tb_overflow","tb_danger","tb_notfriendonly","tb_notblockedonly"],callback:(t,s,a)=>{s.classList.add("busy"),w.post("/api/relationships/block",{user:e._id}).then((e=>{s.classList.remove("busy"),a.classList.add("tm_blocked")}),(e=>{s.classList.remove("busy"),S(e)}))}}),t.push({label:"",icon:"more",title:"More options...",classes:["notext","tb_more","tb_notfriendonly","tb_notblockedonly"],callback:(e,t,s)=>{t.parentNode.querySelectorAll(".tb_overflow").forEach((e=>{e.classList.remove("hidden")})),t.classList.add("hidden")}}),t.push({label:"",icon:"gift",title:"Gift TETR.IO Supporter",classes:["notext","tb_notblockedonly"],callback:(t,s,a)=>{t(),Ke(void 0,e.username)}}),t.push({label:"MESSAGE",icon:"message",title:"Send a direct message",classes:["tb_friendonly","tb_notblockedonly"],callback:(t,s,a)=>{t(),Ba(e._id)}}),t.push({label:"FRIEND",icon:"friend",title:"Add as friend",classes:["tb_notfriendonly","tb_friendbutton","tb_notblockedonly"],callback:(t,s,a)=>{s.classList.add("busy"),w.post("/api/relationships/friend",{user:e._id}).then((e=>{s.classList.remove("busy"),a.classList.add("tm_friend")}),(e=>{s.classList.remove("busy"),S(e)}))}}),t.push({label:"",icon:"friends",title:"Unfriend? (click twice)",classes:["notext","tb_friendonly","tb_unfriendbutton","tb_notblockedonly"],callback:(t,s,a)=>{s.classList.contains("tb_unfriending")?(s.classList.add("busy"),w.post("/api/relationships/remove",{user:e._id}).then((e=>{s.classList.remove("busy"),a.classList.remove("tm_friend")}),(e=>{s.classList.remove("busy"),S(e)}))):s.classList.add("tb_unfriending")}}),t.push({label:"",icon:"report",title:"Report user",classes:["notext","tb_danger","tb_blockedonly"],callback:(t,s,a)=>{t(),Bs(e,(()=>{}))}}),t.push({label:"UNBLOCK",icon:"block",title:"Unblock user",classes:["tb_blockedonly"],callback:(t,s,a)=>{s.classList.add("busy"),w.post("/api/relationships/remove",{user:e._id}).then((e=>{s.classList.remove("busy"),a.classList.remove("tm_blocked")}),(e=>{s.classList.remove("busy"),S(e)}))}})}return t}function Bs(e,t){D({title:`REPORT ${e.username.toUpperCase()}`,msg:`please choose a category to report ${e.username.toUpperCase()} to the TETR.IO moderators for. repeatedly placing false reports may result in a ban.`,classes:["ban_modal"],buttons:[{label:"TOXICITY<span>including, but not limited to toxicity, harassment, unsolicited direct messages, offensive content or bad language</span>",classes:["pri","layercake_button"],callback:s=>{s(),Xs(e,"toxic","TOXICITY",t)}},{label:"CHEATING<span>including, but not limited to cheating, botting, hacking or otherwise breaking the game or getting an unfair advantage</span>",classes:["pri","layercake_button"],callback:s=>{s(),Xs(e,"cheating","CHEATING",t)}},{label:"MULTIACCOUNTING<span>including, but not limited to smurfing, multiaccounting, boosting accounts, throwing games</span>",classes:["pri","layercake_button"],callback:s=>{s(),Xs(e,"alting","MULTIACCOUNTING",t)}},{label:"NSFW/18+ CONTENT<span>including, but not limited to NSFW (not safe for work) avatars, banners, messages, etc.</span>",classes:["pri","layercake_button"],callback:s=>{s(),Xs(e,"nsfw","NSFW CONTENT",t)}},{label:"SPAM<span>including, but not limited to advertising, message flood, etc.</span>",classes:["pri","layercake_button"],callback:s=>{s(),Xs(e,"spam","SPAM",t)}},{label:"OTHER<span>otherwise not listed abuse against the TETR.IO terms of service or rules</span>",classes:["pri","layercake_button"],callback:s=>{s(),Xs(e,"other","OTHER",t)}},{label:"CANCEL",classes:[],callback:e=>{e()}}]})}function Xs(t,s,a,n){D({title:`REPORT ${t.username.toUpperCase()} for ${a}`,msg:`please explain briefly why you are reporting ${t.username.toUpperCase()} for ${a} to the TETR.IO moderators below. repeatedly placing false reports may result in a ban.<br><textarea data-escape="request_report_cancel" data-enter="request_report_submit" id="request_report" placeholder="REASON"></textarea>`,classes:["ban_modal"],buttons:[{label:"CANCEL",classes:[],id:"request_report_cancel",callback:e=>{e()}},{label:"SUBMIT",classes:["pri"],id:"request_report_submit",callback:a=>{a(),w.post("/api/reports/submit",{target:t.username,type:s,reason:e("request_report").value}).then((e=>{I("report sent! thank you for your help in keeping TETR.IO safe."),n()}),(e=>{S(e)}))}}]}),e("request_report").focus()}function zs(e){if(!e||!Array.isArray(e))return[];const t=new Map;for(let s=e.length-1;s>=0;s--){const a=e[s];a.group?t.get(a.group)?t.get(a.group).unshift(a):t.set(a.group,[a]):t.set(`x-ng_${s}`,[a])}const s=[];for(const[e,a]of t)s.unshift({id:e,badges:a});return s}function Gs(e,t,s=0){const a=document.createElement("img");a.classList.add("tetra_badge"),a.src=`/res/badges/${e.id}.png`,a.style=`--i: ${s};`,e.ts?a.title=`${e.label}\n\nAchieved on ${new Date(e.ts).toLocaleString()}`:a.title=e.label,t.appendChild(a)}function js(e){return Math.pow(e/500,.6)+e/(5e3+Math.max(0,e-4e6)/5e3)+1}function Ws(e){return Math.floor(js(e)%1*100)}function qs(e,t=""){const s=Math.floor(e),a=e%1;if(s>=5e3)return`<div class="leveltag ns lt_golden">${s}</div>`;const n=Math.floor(s/10)%10,o=Math.floor(s/100)%5,i=Math.floor(s/500)%10;return`<div ${t} title="${Math.floor(100*a)}% towards next level" class="leveltag ns lt_shape_${o} lt_badge_color_${i} lt_shape_color_${n}">${s}</div>`}function Ks(e,t){const s=Math.floor(e),a=e%1;if(t.innerHTML=s,s>=5e3)return void(t.className="leveltag ns lt_golden");const n=Math.floor(s/10)%10,o=Math.floor(s/100)%5,i=Math.floor(s/500)%10;t.className=`leveltag ns lt_shape_${o} lt_badge_color_${i} lt_shape_color_${n}`,t.title=`${Math.floor(100*a)}% towards next level`}function Ys(e){const t=Math.floor(e);if(5e3==t)return Os.play("level500"),void setTimeout((()=>{Os.play("levelup"),Os.play("allclear"),Os.play("worldrecord")}),750);t>=5e3?Os.play("level1"):t%500!=0?t%100!=0?t%10!=0?Os.play("level1"):Os.play("level10"):Os.play("level100"):Os.play("level500")}function Vs(e){const t=Math.floor(e);return 5e3==t?"MAX LEVEL!":t>=5e3?"LEVEL UP!":t%500==0?"DISTINGUISHED!":t%100==0?"PROMOTED!":t%10==0?"BADGE UP!":"LEVEL UP!"}function Zs(t,s){if(document.body.classList.contains("anon"))return;const a=js(t),n=js(s),o=Math.floor(a)!==Math.floor(n),i=a%1,r=o?1:n%1;Ks(a,e("me_leveling_current")),e("me_leveling").classList.remove("levelingup"),e("me_leveling_amt").innerHTML=`+${s-t} xp`,e("me_leveling_message").classList.add("hidden"),e("me_leveling_fg").style.right=`calc(${.4*i-.2}em + ${100-100*i}%)`,e("me_leveling").getBoundingClientRect(),e("me_leveling").classList.remove("hidden"),setTimeout((()=>{e("me_leveling_fg").style.right=`calc(${.4*r-.2}em + ${100-100*r}%)`,Ks(n,e("me_level"))}),750),o?(e("me_leveling_message").innerHTML=Vs(n),setTimeout((()=>{e("me_leveling_message").classList.remove("hidden"),e("me_leveling").classList.add(5001===Math.floor(n)?"maxlevel":"levelingup"),Ys(n)}),1750),setTimeout((()=>{Ks(n,e("me_leveling_current"));const t=e("me_leveling").getBoundingClientRect();xn.play("xp_ultra",{x:t.left,y:t.top,w:t.width,h:t.height})}),2500),setTimeout((()=>{e("me_leveling").classList.add("hidden"),e("me_leveling").classList.remove(5001===Math.floor(n)?"maxlevel":"levelingup")}),5001===Math.floor(n)?16750:6750)):setTimeout((()=>{e("me_leveling").classList.add("hidden")}),3e3)}let Js=0;function Qs(e,t=!1){e=Math.floor(e),!t&&e&&Zs(Js,Js+e),Js+=e}const ea=function(){let t,s;const a=[];let n=!1,o=!0,i=!1,r=!1,l=!1,c=Date.now(),d=null,p=!1,u=null,m=null,g=!1,h=0,f="disconnected",_=null,b=null,y="/ribbon",v=null,k=null,L=0,E=!1,T=!1,I=null,S=null;function M(){s=void 0,t=new Ribbon(`${"https:"===location.protocol?"wss:":"ws:"}//${location.host}/ribbon/`),p=!1,r=!0,h=Date.now(),m&&(clearTimeout(m),m=null),a.forEach((e=>{t.on(e[0],e[1])})),t.on("replay",(()=>{c=Math.max(c,Date.now())})),t.on("startmulti",(()=>{l=!0,c=Math.max(c,Date.now()+8e3),d&&clearInterval(d),d=setInterval((()=>{l&&Date.now()-c>6e3&&ta("silence")}),200)})),t.on("endmulti",(()=>{l=!1,c=Math.max(c,Date.now()),d&&clearInterval(d)})),t.onopen((()=>{i=!0,document.body.classList.remove("socket_offline"),s=t.getId(),p||t.emit("authorize",{token:z.token(),handling:te.handling,signature:TETRIO_ENV,i:U.i()})})),t.onreconnectstart((()=>{"resuming"===f&&(aa(),e("serverdebuginfo").textContent=`reconnecting ${_?`to ${_.name} [${_.flag}]`:""}${b?` through spool ${b.name} [${b.flag}]`:""}`)})),t.onresume((s=>{e("dirtyflag_net").innerHTML="RIBBON'D",sa(),h=Date.now();const a="resuming"===f;if(f="resuming",e("serverdebuginfo").textContent=`ribboned ${_?`from ${_.name} [${_.flag}]`:""}${b?` through spool ${b.name} [${b.flag}]`:""}`,b&&y&&!a){v&&clearTimeout(v);const s=()=>{$("ResumeRespool",y).then((s=>{"resuming"===f&&i&&(b=s.spool,E=!!s.spool&&s.spool.hasFailures,t.setEndpoint(s.uri),t.setSpoolToken(s.token),t.switchEndpoint(),e("serverdebuginfo").textContent=`connected ${_?`to ${_.name} [${_.flag}]`:""}${b?`, switching to spool ${b.name} [${b.flag}]`:""}`)}),(e=>{"resuming"===f&&i&&(console.warn("Failed to respool. Will keep trying..."),v=setTimeout(s,2e3))}))};v=setTimeout(s,2e3)}a||(I=setTimeout((()=>{I&&clearTimeout(I),S&&clearInterval(S),"resuming"===f&&i&&(S=setInterval((()=>{if("resuming"!==f||!i)return;let e=!1;setTimeout((()=>{e||(T=!0)}),1e3),w.get("https://kagari.network/distress",void 0,{parse:!1,accept:"text/plain"}).then((()=>{})).catch((()=>{e=!0,T=!0}))}),1500))}),2500))})),t.onsave((t=>{if("resuming"===f){try{_paq.push(["trackEvent","Ribbon","Save Success",t,Date.now()-h])}catch(e){}oa(),e("serverdebuginfo").textContent=`connected ${_?`to ${_.name} [${_.flag}]`:""}${b?` through spool ${b.name} [${b.flag}]`:""}`}f="connected",k&&k.abort(),v&&clearTimeout(v),I&&clearTimeout(I),S&&clearInterval(S),T=!1})),t.on("kick",(t=>{if(i=!1,r=!1,e("dirtyflag_net").innerHTML="LOST",document.body.classList.add("socket_offline"),g=!0,O(),"OUTDATED"===t.reason)return document.body.classList.add("socket_outdated"),void(o||(D({title:"UPDATE REQUIRED",classes:["noclickout"],msg:`an update is required to connect to multiplayer servers. click below to update!${H()}`,buttons:[{label:"UPDATE NOW",classes:[],callback:e=>{e(),U.update()}}]}),ut(),et("home",!0)));if("BANNED"===t.reason)document.body.classList.add("trapped"),localStorage.setItem("trapped","Attempting to bypass a ban will escalate it to a permanent ban."),D({title:"KICKED BY MODERATOR",msg:`a TETR.IO moderator or administrator has kicked you from the server. please reload to see the status of your account.${H()}`,classes:["ban_modal","noclickout"],buttons:[{label:"RELOAD",classes:[],callback:e=>{e(),U.update(!0)}}]});else if("you were kicked from the room by its owner"===t.reason)D({title:"KICKED BY ROOM OWNER",classes:["noclickout"],msg:`you were kicked from the room by its owner.${H()}`,buttons:[{label:"OK",classes:[],callback:e=>{e(),U.update(!0)}}]});else if("you were logged out manually"===t.reason)document.body.classList.remove("trapped"),localStorage.removeItem("trapped"),z.logout(),D({title:"YOU WERE LOGGED OUT",classes:["noclickout"],msg:`you were logged out manually. please log back in again.${H()}`,buttons:[{label:"OK",classes:[],callback:e=>{e(),U.update(!0)}}]});else if("USERNAMECHANGE"===t.reason);else{D({title:"CONNECTION ERROR",classes:["noclickout"],msg:`the server has disconnected you.</p><p>REASON: ${t.reason}</p><p>please check your internet connection and configuration.${H()}`,buttons:[{label:"OK",classes:[],callback:e=>{e(),F=!0,location.reload()}}]});let e=`Kick: ${t.reason.replace(/[0-9]+/g,"#")}`;if("connected"===f)C("Disconnect",e);else{let t="Initial Connect";"migrating"===f?t="Migration":"resuming"===f&&(na(),t="Save"),C(`${t} Failure`,e)}}ut(),et("home",!0)})),t.on("announcement",(e=>{switch(e.type){case"announcement":Os.play("notify"),x({msg:e.msg,color:"#FFCC00",icon:"announcement",timeout:1e4}),ka.showAnnouncement(e.msg);break;case"maintenance":Os.play("maintenance"),document.body.classList.add("maintenance"),x({msg:e.msg,color:"#FF5200",icon:"maintenance",timeout:15e3})}})),t.on("maintenance_start",(t=>{o||(i=!1,r=!1,e("dirtyflag_net").innerHTML="LOST",document.body.classList.add("socket_offline"),g=!0,O(),D({title:"MAINTENANCE STARTED",classes:["noclickout"],msg:`the server has been shut down for maintenance.</p><p>${t.reason}${H()}`,buttons:[{label:"RELOAD",classes:[],callback:e=>{e(),U.update(!0)}}]}),ut(),et("home",!0))})),t.on("reload",(()=>{U.update()})),t.on("rejected",(()=>{e("dirtyflag_net").innerHTML="BAD",ta("rejected",5e3)}));let P=0;t.onpong((e=>{e>500&&ta("delay"),Nt.addPing(e),c=Math.max(c,Date.now()),b&&k&&Date.now()-P>3e4&&(P=Date.now(),k.getSpoolData(b.host).then((e=>{L=e.rtt,Nt.addSpoolPing(Math.round(e.rtt))})).catch((()=>{})))})),t.on("pni",(e=>{ta(e.type,e.timeout)})),t.on("authorize",(t=>{u=t,_=t.worker,e("serverdebuginfo").textContent=`connected ${_?`to ${_.name} [${_.flag}]`:""}${b?` through spool ${b.name} [${b.flag}]`:""}`,x({msg:`connected to server<br>${R()}`,color:"#61FF3C",icon:"connect",timeout:2500}),p=!0,r=!1,f="connected";try{_paq.push(["trackEvent","Ribbon","Initial Connect Success",`${_?_.name:"---"} ${b?b.name:"---"}`,Date.now()-h])}catch(e){}}));let N=null;t.on("migrate",(s=>{f="migrating",y=s.endpoint,b?t.setEndpoint(`wss://${b.host}${s.endpoint}`):t.setEndpoint(`${"https:"===location.protocol?"wss:":"ws:"}//${location.host}${s.endpoint}`),t.switchEndpoint(),e("serverdebuginfo").textContent=`migrating to ${s.name} [${s.flag}]${b?` through spool ${b.name} [${b.flag}]`:""}`,N=x({msg:`switching server<br>${R()}`,color:"#FFF83C",icon:"disconnect-change",timeout:6e4}),h=Date.now()})),t.on("migrated",(t=>{f="connected",_=t.worker,e("serverdebuginfo").textContent=`connected ${_?`to ${_.name} [${_.flag}]`:""}${b?` through spool ${b.name} [${b.flag}]`:""}`,A(N,{msg:`server switched<br>${R()}`,color:"#61FF3C",icon:"connect",timeout:2500});try{_paq.push(["trackEvent","Ribbon","Migration Success",`${_?_.name:"---"} ${b?b.name:"---"}`,Date.now()-h])}catch(e){}})),t.onclose((t=>{document.body.classList.add("socket_offline");let s=i;if(i=!1,r=!1,l=!1,c=Math.max(c,Date.now()),d&&clearInterval(d),o&&!g)return e("serverdebuginfo").textContent="(reconnecting in background)",s&&(ta("background",1e3),x({msg:"disconnected from server. reconnecting in a moment",color:"#FF783C",icon:"disconnect"})),m&&clearTimeout(m),void(m=setTimeout((()=>{M()}),3e4+12e4*Math.random()));e("serverdebuginfo").textContent=n?"(not connected)":"(connection lost)",x({msg:"disconnected from server",color:"#FF783C",icon:"disconnect"}),setTimeout((()=>{if(!n)if(e("dirtyflag_net").innerHTML="LOST",ut(),et("home",!0),D({title:"CONNECTION ERROR",classes:["noclickout"],msg:`a connection error has occured and the connection was closed unexpectedly.</p><p>check your internet connection and configuration.</p><p>REASON: ${t}${H()}`,buttons:[{label:"OK",classes:[],callback:e=>{e(),F=!0,location.reload()}}]}),"connected"===f)C("Disconnect",t);else{let e="Initial Connect";"migrating"===f?e="Migration":"resuming"===f&&(na(),e="Save"),C(`${e} Failure`,t)}n=!1}),50)})),$("InitialConnect").then((e=>{b=e.spool,y=e.endpoint,E=!!e.spool&&e.spool.hasFailures,t.setEndpoint(e.uri),t.setSpoolToken(e.token),t.open()}),(e=>{t.close(e)}))}function C(t,s){let a=!1;return T?(setTimeout((()=>{try{_paq.push(["trackEvent","Ribbon",`${t} (their fault)`,s])}catch(e){}}),500),void(e("networkerror_fault_indicator")&&(e("networkerror_fault_indicator").innerHTML="<br>this disconnect was detected to be caused by your network connection."))):"visible"!==document.visibilityState?(setTimeout((()=>{try{_paq.push(["trackEvent","Ribbon",`${t} (their fault, tabbed out)`,s])}catch(e){}}),500),void(e("networkerror_fault_indicator")&&(e("networkerror_fault_indicator").innerHTML="<br>due to browser limitations, tabbing out of TETR.IO midgame may cause disconnects."))):(setTimeout((()=>{if(!a){a=!0;try{_paq.push(["trackEvent","Ribbon",`${t} (their fault)`,s])}catch(e){}e("networkerror_fault_indicator")&&(e("networkerror_fault_indicator").innerHTML="<br>this disconnect was detected to be caused by your network connection.")}}),1e3),void w.get("https://kagari.network/distress",void 0,{parse:!1,accept:"text/plain"}).then((()=>{if(!a){a=!0;try{_paq.push(["trackEvent","Ribbon",`${t} (our fault)`,s])}catch(e){}e("networkerror_fault_indicator")&&(e("networkerror_fault_indicator").innerHTML="<br>if you are certain this error is not on your side, please report it.")}})).catch((()=>{})))}function R(){return b?`<img class="flag" src="/res/flags/${b.flag.toLowerCase()}.png" title="${Co[b.flag]}" /> ${b.name.toUpperCase()}<br><img src="/res/sharp-hook-right.png" style="margin-left: 0.2em; height: 0.88em; vertical-align: -5%;" /> <img class="flag" src="/res/flags/${_.flag.toLowerCase()}.png" title="${Co[_.flag]}" /> ${_.name.toUpperCase()}`:`<img class="flag" src="/res/flags/${_.flag.toLowerCase()}.png" title="${Co[_.flag]}" /> ${_.name.toUpperCase()}`}function H(){let e=`<span id="networkerror_fault_indicator"></span></p><p class="modal_also">SOCKET ID: ${s||"---"}<br>WORKER: ${_?_.name.toUpperCase():"---"}<br>SPOOL: ${b?b.name.toUpperCase():"---"}`;return document.getElementById("js_load_error").innerHTML.includes("TETR.IO PLUS")&&(e+='<br><span style="color: #F00; font-weight: 900;">THIRD-PARTY MODIFICATIONS DETECTED. DO NOT REPORT ANY ERRORS WHILE USING THIRD-PARTY MODIFICATIONS.</span><br><span style="color: #F00; font-weight: 500; font-size: 0.7em;">THIRD-PARTY MODIFICATIONS ARE NOT SUPPORTED AND MAY BE INCOMPATIBLE. THIRD-PARTY MODIFICATIONS THAT IMPACT GAMEPLAY MAY BE AGAINST TERMS OF SERVICES.</span>'),e}async function $(e=null,t){let s,a,n=[];try{console.log((e?`${e} > `:"")+"Obtaining Ribbon endpoint...");const o=await w.get("/api/server/ribbon");if(!o.endpoint)throw console.warn((e?`${e} > `:"")+"No endpoints available."),"no endpoints available";if(s=o.endpoint,!(o.spools&&o.spools.spools&&o.spools.spools.length))return console.log(`${e?`${e} > `:""}Obtained Ribbon endpoint ${o.endpoint}. Spooling is disabled on this instance.`),{uri:`${"https:"===location.protocol?"wss:":"ws:"}//${location.host}${t||s}`,endpoint:s,token:void 0,spool:void 0};console.log(`${e?`${e} > `:""}Obtained Ribbon endpoint ${o.endpoint} and ${o.spools.spools.length} spools.`),a=o.spools.token,n=o.spools.spools}catch(t){throw console.error((e?`${e} > `:"")+"Could not retrieve Ribbon endpoint."),"could not retrieve ribbon endpoint"}console.log((e?`${e} > `:"")+"Getting a spool...");try{k=new ia(n,e);const o=await k.getSpool();return console.log(`${e?`${e} > `:""}Obtained spool ${o.name} (${o.host}) [${o.flag}].`),{uri:`wss://${o.host}${t||s}`,endpoint:s,token:a,spool:o}}catch(t){throw console.error((e?`${e} > `:"")+"Could not spool a Ribbon connection.",t),"could not spool ribbon connection"}}function O(){n=!0}function P(e,s){if(t){let a=!1;t.on(e,(e=>{a||(a=!0,s(e))}))}}return setInterval((async()=>{if(t&&"connected"===f&&i&&b)try{console.log("AmbientRespool > Starting ambient respool.");const s=await $("AmbientRespool",y);if(!(t&&"connected"===f&&i&&b&&s.spool))return;if(t.setSpoolToken(s.token),s.spool.hasFailures||(E=!1),s.spool.name===b.name)return void console.log("AmbientRespool > Obtained new token, already on best available spool.");const a=L/s.spool.rtt,n=E?1.25:2;L>10&&a>=n?(console.log(`AmbientRespool > Will reconnect for ping advantage ${Math.round(L)}ms  ${Math.round(s.spool.rtt)}ms.`),b=s.spool,t.setEndpoint(s.uri),t.switchEndpoint(),e("serverdebuginfo").textContent=`connected ${_?`to ${_.name} [${_.flag}]`:""}${b?`, switching to spool ${b.name} [${b.flag}]`:""}`):console.log(`AmbientRespool > Obtained new token, no significant ping advantage ${Math.round(L)}ms  ${Math.round(s.spool.rtt)}ms.`)}catch(e){console.warn("AmbientRespool > Ambient respool failed, could not retrieve Ribbon spool token!")}}),25e4+1e5*Math.random()),{on:(e,s)=>{a.push([e,s]),t&&t.on(e,s)},once:P,off:(e,s)=>{t&&t.off(e,s)},socket:function(){return t},emit:function(e,s){t.emit(e,s)},connect:M,disconnect:function(){t.close("client closed ribbon")},abort:function(){n=!0,t.close(null,!0)},expectDisconnect:O,isConnected:()=>i,isBackground:()=>o,cut:e=>{t&&t.cut(e)},require:()=>new Promise(((e,t)=>{o=!1,!i||r?(r||M(),P("authorize",(t=>{e(t)})),P("connect_error",(()=>{t()}))):e(u)})),unrequire:()=>{o=!0},updateHandling:function(){t.emit("sethandling",te.handling)}}};function ta(t,s=100){ga&&ga.isBackground()&&!["background","split","load"].includes(t)||(e(`network_${t}`).classList.add("ping"),setTimeout((()=>{e(`network_${t}`).classList.remove("ping")}),s))}function sa(){ga&&ga.isBackground()||(e("network_disconnect").setAttribute("src","/res/icon/network_disconnect.svg"),e("network_disconnect").classList.remove("anim"),e("network_disconnect").classList.add("ping"))}function aa(){ga&&ga.isBackground()||(e("network_disconnect").setAttribute("src","/res/icon/network_reconnecting.png"),e("network_disconnect").classList.add("anim"),e("network_disconnect").classList.add("ping"))}function na(){ga&&ga.isBackground()||(e("network_disconnect").setAttribute("src","/res/icon/network_disconnect.svg"),e("network_disconnect").classList.remove("anim"),e("network_disconnect").classList.add("ping"),setTimeout((()=>{e("network_disconnect").classList.remove("ping")}),5e3))}function oa(){ga&&ga.isBackground()||(e("network_disconnect").setAttribute("src","/res/icon/network_reconnected.svg"),e("network_disconnect").classList.remove("anim"),e("network_disconnect").classList.add("ping"),setTimeout((()=>{e("network_disconnect").classList.remove("ping")}),1e3))}const ia=function(e,t=null){let s=[],a=!1,n=0,o=0;const i=new Set;let r,l,c=!1,d=null,p=null,u=null,m=!1;function g(e){const t=e[0],s={online:128&e[1],avoidDueToHighLoad:64&e[1],recentlyRestarted:32&e[1],backhaulDisrupted:16&e[1]},a=[0,0,0];a[0]=e[2]/256*4,a[1]=e[3]/256*4,a[2]=e[4]/256*4;return{version:t,flags:s,load:a,str:`v${t} /${s.avoidDueToHighLoad?"Av":""}${s.recentlyRestarted?"Rr":""}${s.backhaulDisrupted?"Bd":""}/ ${a[0]}, ${a[1]}, ${a[2]}`}}function h(){if(c)return;c=!0,d&&clearTimeout(d),p&&clearTimeout(p),u&&clearTimeout(u);for(const e of i)e.abort();i.clear();const e=[],o=s.reduce(((e,t)=>Math.min(e,t.rtt)),Number.MAX_VALUE);for(const t of s){const s=Math.ceil((t.resp.flags.avoidDueToHighLoad?5:50)*Math.pow(o/t.rtt,3)/Math.max(1,8*t.resp.load[0]-3.8));for(let a=0;a<s;a++)e.push(t)}if(0===e.length){if(a)return;return console.warn((t?`${t} > `:"")+"Spool > Spooling failed: no available spools"),void l()}const m=e[Math.floor(Math.random()*e.length)];m.hasFailures=n>0,console.log(`${t?`${t} > `:""}Spool > Spooled ${m.name}!`),r(m)}return{getSpool:function(){return new Promise(((a,f)=>{r=a,l=f,function(){console.log((t?`${t} > `:"")+"Spool > Spooling started"),new En(Math.floor(1e9*Math.random())).shuffleArray(e),performance.clearResourceTimings(),performance.setResourceTimingBufferSize(500),u=setTimeout(h,1e4);let a=0;for(const r of e){const l=new XMLHttpRequest,u=performance.now(),f=`${Date.now()}-${a++}-${Math.floor(1e6*Math.random())}`,_=`https://${r.host}/spool?${f}`;l.open("GET",_,!0),l.responseType="arraybuffer",i.add(l),l.onload=()=>{if(!c&&4===l.readyState){performance.now();const a=performance.getEntriesByName(_)[0];let c;a&&0!==a.requestStart?c=a.responseStart-a.requestStart:(m||(m=!0,console.warn("Performance Resource Timing API is not available.")),c=performance.now()-u),i.delete(l);const f=g(new Uint8Array(l.response));if(!f.flags.online)return n++,console.log(`${t?`${t} > `:""}Spool > ${Math.round(c).toString().padStart(5," ")}ms ${r.name} [${r.flag}] Denies request (${f.str})`),void(s.length+n>=e.length&&h());console.log(`${t?`${t} > `:""}Spool > ${Math.round(c).toString().padStart(5," ")}ms ${r.name} [${r.flag}] ${f.str}`),r.rtt=c,r.resp=f,s.push(r),f.flags.avoidDueToHighLoad||o++,1===s.length&&(p=setTimeout(h,1e4)),d&&clearTimeout(d),d=setTimeout(h,1500),s.length+n>=e.length&&h(),o>=3&&h()}},l.onerror=()=>{c||(i.delete(l),n++,console.log(`${t?`${t} > `:""}Spool > -----ms ${r.name} [${r.flag}] No response`),s.length+n>=e.length&&h())},l.send()}}()}))},getSpoolData:function(e){return new Promise(((t,s)=>{const a=new XMLHttpRequest,n=performance.now(),o=`ping-${Date.now()}-${Math.floor(1e6*Math.random())}`,i=`https://${e}/spool?${o}`;a.open("GET",i,!0),a.responseType="arraybuffer",a.onload=()=>{if(4===a.readyState){const e=performance.getEntriesByName(i)[0];let s;s=e&&0!==e.requestStart?e.responseStart-e.requestStart:performance.now()-n;const o=g(new Uint8Array(a.response));t({...o,rtt:s})}},a.onerror=()=>{s()},a.send()}))},abort:function(){s=[],a=!0,h()}}},ra={random:{id:"random",label:"RANDOMS",targetculled:!1,algorithm:(e,t)=>[e[Math.floor(Math.random()*e.length)].context.listenID]},elims:{id:"elims",label:"ELIMINATIONS",targetculled:!1,algorithm:(e,t)=>{const s=[];e.forEach((e=>{s.push({id:[e.context.listenID],amt:e.game.highest()})})),s.sort(((e,t)=>e.amt-t.amt));const a=[];for(let e=0;e<Math.min(10,s.length);e++)for(let t=0;t<s.length-e;t++)a.push(s[e].id);return a[Math.floor(Math.random()*a.length)]}},best:{id:"best",label:"PROS",targetculled:!1,algorithm:(e,t)=>{const s=[];e.forEach((e=>{s.push({id:[e.context.listenID],amt:e.game.highest()})})),s.sort(((e,t)=>t.amt-e.amt));const a=[];for(let e=0;e<Math.min(10,s.length);e++)for(let t=0;t<s.length-e;t++)a.push(s[e].id);return a[Math.floor(Math.random()*a.length)]}},payback:{id:"payback",label:"PAYBACK",targetculled:!0,algorithm:(e,t)=>{let s=[];return t&&e.forEach((e=>{[e.context.listenID][0]===t.game.garbagestats().lastattacker[0]&&(s=[e.context.listenID])})),s.length||(s=[e[Math.floor(Math.random()*e.length)].context.listenID]),s}},even:{id:"even",label:"EVEN",targetculled:!1,algorithm:(e,t)=>{const s=[];e.forEach((e=>{s.push({id:[e.context.listenID],amt:e.game.garbagestats().garbagereceived})})),s.sort(((e,t)=>e.amt-t.amt));const a=[];for(let e=0;e<Math.min(10,s.length);e++)for(let t=0;t<s.length-e;t++)a.push(s[e].id);return a[Math.floor(Math.random()*a.length)]}},first:{id:"first",label:"FIRST IDK",targetculled:!1,algorithm:(e,t)=>[e[0].context.listenID]}},la=(()=>{let t,s=!1,a=[],n=0,o=!1,i=null;const r={maytarget:!0,strategies:["even","elims","random","payback"]};function l(){t&&(e("diyusi_strategy_1").querySelector("p").textContent=ra[r.strategies[0]].label,e("diyusi_strategy_2").querySelector("p").textContent=ra[r.strategies[1]].label,e("diyusi_strategy_3").querySelector("p").textContent=ra[r.strategies[2]].label,e("diyusi_strategy_4").querySelector("p").textContent=ra[r.strategies[3]].label,e("diyusi_strategy_1").classList.toggle("active",0===n&&!o),e("diyusi_strategy_2").classList.toggle("active",1===n&&!o),e("diyusi_strategy_3").classList.toggle("active",2===n&&!o),e("diyusi_strategy_4").classList.toggle("active",3===n&&!o),e("diyusi").classList.toggle("hasextra",o),function(t){if((t=t&&s)===p)return;t?(e("diyusi").classList.remove("hidden"),e("diyusi").classList.remove("hiding")):(e("diyusi").classList.add("hiding"),setTimeout((()=>{e("diyusi").classList.add("hidden")}),500));p=t}(s&&r.maytarget&&t.games.others.length>1))}function c(){e("diyusi").classList.add("ping"),setTimeout((()=>{e("diyusi").classList.remove("ping")}),150)}function d(){t&&t.games.others.forEach((e=>{e.game.setTargeted(s&&r.maytarget&&t.games.others.length>1&&a.includes(e.context.listenID))}))}let p=!1;function u(e){if(o){let s=!1;if(t.games.others.forEach((e=>{a[0]==e.context.listenID&&(s=!0)})),s)return void(e&&(d(),m()));o=!1,n="random",l(),c(),d(),m()}let s=[];1===t.games.others.length&&(s=[t.games.others[0].context.listenID]),t.games.others.length>1&&(ra[r.strategies[n]]||(n=0,l()),s=ra[r.strategies[n]]?ra[r.strategies[n]].algorithm(ra[r.strategies[n]].targetculled?t.games.others:t.games.others.filter((e=>!e.headless)),t.games.self):[t.games.others[0].context.listenID]),(JSON.stringify(s)!=JSON.stringify(a)||e)&&(a=s,d(),m())}function m(){t.games.self&&t.games.self.game.setTargets(a)}return{options:r,enabled:function(e){s=e,l(),d(),c()},setMultiplex:function(e){t=e},setStrategy:function(e,a=!1){t&&s&&(o=!1,n=e,l(),u(!0),c(),!a&&t.games.others.length>=2&&Os.play("target"))},setManual:function(e){s&&(o=!0,a=[e],l(),u(!0),c(),Os.play("target"))},retarget:function(){u(!1)},reflow:function(){l(),d()},startTimer:function(){null===i&&(i=setInterval(u,5e3))},stopTimer:function(){clearInterval(i),i=null}}})();U.ready((()=>{function e(e){e.repeat||document.body.classList.contains("chatfocus")||ht>=1||Object.keys(ae).forEach((t=>{if(ae[t].includes(me(e)||e.detail.toUpperCase()))switch(t){case"target1":la.setStrategy(0,!1);break;case"target2":la.setStrategy(1,!1);break;case"target3":la.setStrategy(2,!1);break;case"target4":la.setStrategy(3,!1)}}))}document.addEventListener("keydown",e,!1),document.addEventListener("gpdown",e,!1)}));let ca=0;const da=(t,s,a=!1)=>{const n=t?t.socket():null,o={self:null,others:[]};let i=[],r=0,l=!1,c=new Map,d=null,p=null,u=!!a,m={},g=[],h=0,f=1,_=!1,b=-1,y=1,v=1;function w(e,t,s){z.username()==e?!1!==te.video.kos&&R({msg:null!==t.name?`ko'd by ${t.name.toUpperCase()}`:"you ko'd yourself",fgcolor:"#FF2222",bgcolor:"#FFFFFF",timeout:5e3}):z.username()==t.name&&!1!==te.video.kos?(Os.play("elim"),R({msg:`ko'd ${e.toUpperCase()}${s>=250?` <span class="fire">${Math.ceil(s/7)}%</span>`:""}`,fgcolor:"#FFFFFF",bgcolor:"#FF2222",timeout:3e3})):o.others.length<=200&&Os.play("death",o.others.length<=100?1:.5),$({victim:e,killer:t.name,type:t.type}),o.self&&o.self.game.updatePlacement(o.others.length+(o.self?1:0)),o.others.forEach((e=>{e.game.updatePlacement(o.others.length+(o.self?1:0))}))}const k=1.6;function L(t=!1){if(!(l||u&&(t||o.others.length<=60&&(u=!1,I(),g.forEach((e=>{p.headless=!1,p.game.rehead(),p.game.location(0,0,0,!0)})),g=[],m={}),function(t=!1){if(!u)return;if(o.self)e("spectate").classList.add("hidden"),document.body.classList.remove("spectating");else{if(0===o.others.length)return e("spectate").classList.add("hidden"),void document.body.classList.remove("spectating");if(e("spectate").classList.contains("hidden")&&(ca=Date.now()),e("spectate").classList.remove("hidden"),document.body.classList.add("spectating"),d){if(p&&p.context.user.username===d)return;p&&(p.headless=!0,p.game.fadeOutAndBehead(200),g.push(p),p=null);for(let e=0;e<o.others.length;e++)o.others[e].context.user.username===d&&(p=o.others[e]);if(!p)return void(e("data_spectate").innerHTML=`spectating <span>${o.others.length}</span> PLAYERS`);e("data_spectate").innerHTML=`spectating <span>${d.toUpperCase()}</span>`,p.headless?(g=g.filter((e=>e.context.listenID!==p.context.listenID)),p.headless=!1,p.game.rehead(),p.game.location(0,0,0,!0),p.game.location(0,0,1,!!t),p.game.changeDisplayMode("full")):(p.game.location(0,0,1,!!t),p.game.changeDisplayMode("full"),M(p))}else e("data_spectate").innerHTML=`spectating <span>${o.others.length}</span> PLAYERS`,p&&(p.headless=!0,p.game.fadeOutAndBehead(200),g.push(p),p=null)}}(t),u)))if(o.self){if(e("spectate").classList.add("hidden"),document.body.classList.remove("spectating"),0===o.others.length)return;if(1===o.others.length&&te.video.sidebyside)return o.self.game.location(-.35,0,1,!!t),o.others[0].game.location(.45,0,1,!!t),void o.others[0].game.changeDisplayMode("full");const s=E(o.others.length);o.self.game.location(0,0,1,!!t);for(let e=0;e<o.others.length;e++)o.others[e].game.location(s[e].x,s[e].y,s[e].s,!!t),o.others[e].game.changeDisplayMode(o.others.length>=4||te.video.alwaystiny||"minimal"===te.video.graphics?"tiny":"small")}else{if(0===o.others.length)return e("spectate").classList.add("hidden"),void document.body.classList.remove("spectating");if(e("spectate").classList.contains("hidden")&&(ca=Date.now()),e("spectate").classList.remove("hidden"),document.body.classList.add("spectating"),1===o.others.length)return o.others[0].game.location(0,0,1,!!t),o.others[0].game.changeDisplayMode("full"),void(e("data_spectate").innerHTML=`spectating <span>${o.others[0].context.user.username.toUpperCase()}</span>`);if(2===o.others.length&&te.video.sidebyside){if(d){let s=!1;for(let e=0;e<o.others.length;e++)o.others[e].context.user.username===d?(o.others[e].game.location(-.4,0,1,!!t),o.others[e].game.changeDisplayMode("full"),s=!0):(o.others[e].game.location(.4,0,1,!!t),o.others[e].game.changeDisplayMode("full"));if(!s)return o.others[0].game.location(-.4,0,1,!!t),o.others[0].game.changeDisplayMode("full"),o.others[1].game.location(.4,0,1,!!t),o.others[1].game.changeDisplayMode("full"),void(e("data_spectate").innerHTML=`spectating <span>${o.others[0].context.user.username.toUpperCase()}</span> VS <span>${o.others[1].context.user.username.toUpperCase()}</span>`);e("data_spectate").innerHTML=`spectating <span>${d.toUpperCase()}</span>`}else o.others[0].game.location(-.4,0,1,!!t),o.others[0].game.changeDisplayMode("full"),o.others[1].game.location(.4,0,1,!!t),o.others[1].game.changeDisplayMode("full"),e("data_spectate").innerHTML=`spectating <span>${o.others[0].context.user.username.toUpperCase()}</span> VS <span>${o.others[1].context.user.username.toUpperCase()}</span>`;return}if(d){let s=E(o.others.length),a=!1;for(let e=0;e<o.others.length;e++)o.others[e].context.user.username===d&&(a=!0);a&&(s=E(o.others.length-1));let n=0,i=!1;for(let e=0;e<o.others.length;e++)o.others[e].context.user.username===d?(i=!0,o.others[e].game.location(0,0,1,!!t),o.others[e].game.changeDisplayMode("full")):(o.others[e].game.location(s[n].x,s[n].y,s[n].s,!!t),o.others[e].game.changeDisplayMode(o.others.length>=9||te.video.alwaystiny||"minimal"===te.video.graphics?"tiny":"small"),n++);if(!i){const s=x(o.others.length);for(let e=0;e<o.others.length;e++)o.others[e].game.location(s[e].x,s[e].y,s[e].s,!!t),o.others[e].game.changeDisplayMode(o.others.length>=9||te.video.alwaystiny||"minimal"===te.video.graphics?"tiny":"small");return void(e("data_spectate").innerHTML=`spectating <span>${o.others.length}</span> PLAYERS`)}e("data_spectate").innerHTML=`spectating <span>${d.toUpperCase()}</span>`}else{const s=x(o.others.length);for(let e=0;e<o.others.length;e++)o.others[e].game.location(s[e].x,s[e].y,s[e].s,!!t),o.others[e].game.changeDisplayMode(o.others.length>=9||te.video.alwaystiny||"minimal"===te.video.graphics?"tiny":"small");e("data_spectate").innerHTML=`spectating <span>${o.others.length}</span> PLAYERS`}}}function E(e){const t=e>=30,s=e>=9||te.video.alwaystiny||"minimal"===te.video.graphics?.5:.8;e=Math.max(2,e);let a=0,n=1,o=0,i=0,r=!1;do{a++,n=.75/a,o=t?2*Math.ceil(e/a/2):Math.ceil(e/a),i=n*s*o,i<=(t?1.2:.6)&&(r=!0)}while(!r);const l=[];for(let i=0;i<e;i++){const e=Math.floor(i/a),r=i%a;t?l.push({x:(.5+n*s/2+e%(o/2)*s*n)*(e<o/2?1:-1),y:r*k*n*1.6-.8,s:n}):l.push({x:.4+n*s/2+e*s*n,y:r*k*n-.5,s:n})}return l}function x(e){const t=e>=9||te.video.alwaystiny||"minimal"===te.video.graphics?.5:.8;e=Math.max(2,e);let s=1,a=1,n=1,o=0,i=0,r=!1;do{s++,n=2/((e<=8?1:t)*s),a=Math.ceil(e/s),i=n*t*s,o=n*k*a,o<=1.6&&(r=!0)}while(!r);const l=Math.floor(1.8/(t*n));s=Math.round((l+s)/2),n=2/((e<=8?1:t)*s),r=!1;do{n-=.005,a=Math.ceil(e/s),i=n*t*s,o=n*k*a,o<=1.6&&i<=1.8&&(r=!0)}while(!r);const c=[];for(let r=0;r<e;r++){const l=r%s,d=Math.floor(r/s);let p=(1.8-i)/2;Math.floor(r/s)===Math.floor(e/s)&&(p=(1.8-n*t*(e%s))/2),c.push({x:-.9+p+n*t/2+l*t*n,y:1===a?0:(1.6-o)/2-.8+(d+.5)*k*n,s:n})}return c}function T(e,t,s=!1){for(let s=0;s<o.others.length;s++)if(o.others[s].context.listenID===e)return void o.others[s].game.queueEnd(t.gameoverreason,"winner"!==t.gameoverreason,t.fire,t.killer);s||c.set(e,t)}function I(){_&&(_=!1,PIXI.Ticker.shared.remove(S))}function S(e){u&&("minimal"===te.video.graphics||te.video.nosuperlobbyanim?f>0&&(f<=1e-4&&(f=0),f*=Math.pow(f>=30?.995:.985,e)):f>1&&(f<=1.0001&&(f=1),f=1+(f-1)*Math.pow(f>=30?.998:.993,e)),Object.keys(m).forEach((t=>{let s=m[t];if(s.row%2==0?s.slx-=f*e*75e-5:s.slx+=f*e*75e-5,s.row%2==0&&s.slx<=b||s.row%2!=0&&s.slx>=y){if(s.headless=!0,s.game.behead(),delete m[t],g.push(s),ng=g.shift(),!ng)return;return ng.headless=!1,ng.game.rehead(),ng.slx=s.row%2==0?s.slx+2*v:s.slx-2*v,ng.sly=s.row*(1/2.75)+Math.sin(Math.abs(.5*Math.PI*Math.pow(ng.slx/v,2)))*(s.row/20),ng.row=s.row,ng.game.location(ng.slx,ng.sly,.2,!0),m[++h]=ng,void(ng.slid=h)}s.sly=s.row*(1/2.75)+Math.sin(Math.abs(.5*Math.PI*Math.pow(s.slx/v,2)))*(s.row/20),s.game.location(s.slx,s.sly,.2,!0)})))}function M(e){delete m[e.slid],ng=g.shift(),ng&&(ng.headless=!1,ng.game.rehead(!0),ng.slx=e.slx,ng.sly=e.sly,ng.row=e.row,ng.game.location(ng.slx,ng.sly,.2,!0),m[++h]=ng,ng.slid=h)}return{attachFake:function(e,t){l=!0,o.others.push({game:e,context:t})},detachFakes:function(){l=!1,o.others=[]},attachSelf:function(e){const t=new Ei,a=new Uo({type:"keyboard"});t.bindEventSource(a),t.bindRollingReplay(n),t.setListenID(s),n.on("ige",(e=>{a.pushIGE(e)})),n.on("iges",(e=>{for(const t of e)a.pushIGE(t)})),n.setFasterPingRequirement(!0),e.username=z.username(),e.onstop=e=>{null!==e.killer.name&&(d=e.killer.name),function(e){o.self=null,e&&L();n.setFasterPingRequirement(!1)}(1!==o.others.length),la.enabled(!1)},e.onfail=t=>{setTimeout((()=>{w(e.username,t.killer,t.fire)}),50)},e.onquit=e=>{o.others.forEach((e=>{e.game.end()})),ka.leaveRoom(),ka.dropMultiplex()},t.setGame(e),t.createGameHolder(),o.self={game:t,context:{listenID:-1,user:{_id:z.id(),username:z.username()}}},r<2?(r++,i.push(t.export().replay)):i=[]},attachSocketGame:function(e,t,s,a,l){const c=new Ei;c.bindEventSource(new Uo({type:"socket",socket:n,listenID:t.listenID})),e.display_username=!0,e.username=t.user.username,r>=2&&(e.noreplay=!0),e.physical=!1,u&&(o.others.length>=60&&(e.headless=!0),e.zoominto="fade",e.prestart=850),e.onstop=s=>{e.username===d&&(d=s&&s.killer&&null!==s.killer.name?s.killer.name:null),function(e,t){o.others=o.others.filter((t=>{if(t.context.listenID===e)try{t.game.export().source.destroy(),!t.headless&&u&&M(t)}catch(e){console.error(`Could not detach socket game source: ${e}`)}return t.context.listenID!==e})),g=g.filter((t=>t.context.listenID!==e)),t&&"minimal"!==te.video.graphics&&L()}(t.listenID,2!==o.others.length||null!==o.self),la.retarget(),la.reflow()},e.onfail=t=>{setTimeout((()=>{w(e.username,t.killer,t.fire)}),50)},c.setGame(e),c.createGameHolder(s,l);const p={game:c,context:t,headless:e.headless};o.others.push(p),u&&(p.headless?g.push(p):(m[++h]=p,p.slid=h)),r<2?(r++,i.push(c.export().replay)):i=[],a||L()},start:function(e=!1){o.self&&o.self.game.startGame(e),o.others.forEach((t=>{t.game.startGame(e)})),o.self&&o.self.game.updatePlacement(o.others.length+(o.self?1:0)),o.others.forEach((e=>{e.game.updatePlacement(o.others.length+(o.self?1:0))}));for(const[e,t]of c)T(e,t)},stop:function(t,s=!1){const a=[];t.forEach((e=>{e.success&&a.push(e.user.username)})),o.self&&(a.includes(z.username())?o.self.game.endWin():o.self.game.endLose()),o.others.forEach((e=>{a.includes(e.game.export().options.username)?e.game.queueEnd("winner"):e.game.queueEnd("topout",!0)})),I(),setTimeout((()=>{o.others.forEach((e=>{a.includes(e.game.export().options.username)?e.game.endWin():e.game.endLose(!0)}))}),s?1e3:200),e("spectate").classList.add("hidden"),document.body.classList.remove("spectating")},order:L,pushReplayState:function(e,t){for(let s=0;s<o.others.length;s++)if(o.others[s].context.listenID===e){"wait"===t?o.others[s].game.rerequestState():(o.others[s].game.injectState(t),o.others[s].game.updatePlacement(o.others.length+(o.self?1:0)));break}},pushReplayBoardState:function(e,t){for(let s=0;s<o.others.length;s++)if(o.others[s].context.listenID===e){o.others[s].game.injectBoardState(t);break}},expectEnd:T,startScope:function(e){for(let t=0;t<o.others.length;t++)if(o.others[t].context.user.username===e){n.emit("startscope",o.others[t].context.user._id);break}},endScope:function(e){for(let t=0;t<o.others.length;t++)if(o.others[t].context.user.username===e){n.emit("endscope",o.others[t].context.user._id);break}},superLobby:{startAnimation:function(){if(!u)return;f=40;const e=(window.innerWidth-Ls(1600))/Ls(1600);v=1+2*e,b=-1-2*e,y=1+2*e;let t=0;Object.keys(m).forEach((e=>{const s=m[e],a=t%12,n=Math.floor(t/12)-2,o=(n+2)/4,i=n*(1/2.75)+Math.sin(Math.abs(.5*Math.PI*1))*(n/20);let r=0;r=n%2==0?y+(a+o)*(1/6)*v:b-(a+o)*(1/6)*v,s.game.location(r,i,.2,!0),s.slx=r,s.sly=i,s.row=n,t++}))},startTicker:function(){_||(_=!0,PIXI.Ticker.shared.add(S))},stopTicker:I},games:o,replays:i,getPosOf:function(e){let t=null;return o.others.forEach((s=>{s.context.listenID!==e&&s.game.export().options.username!==e||(t=s.headless?{pos:{x:(window.innerWidth+200)*Math.random()-100,y:window.innerHeight/2-Ls(400)+Math.random()*Ls(800)},scale:.2}:s.game.getPos())})),t},getFrameOf:function(e){let t=null;return o.others.forEach((s=>{s.context.listenID!==e&&s.game.export().options.username!==e||(t=s.game.export().source.getFrame())})),t},awaitFrameFor:function(e,t,s){let a=!1;return o.others.forEach((n=>{if(n.context.listenID===e||n.game.export().options.username===e){if(!n.game.isScoped())return;n.game.awaitFrame(t,s),a=!0}})),a},find:function(e){let t=null;return o.others.forEach((s=>{s.context.listenID!==e&&s.game.export().options.username!==e||(t=s)})),t},setSpectating:function(e){d=e},getSpectating:function(){return d},endRandom:function(){o.others[Math.floor(Math.random()*o.others.length)].game.queueEnd("topout",!0)}}};U.ready((()=>{e("grid_spectate").addEventListener("click",(function(e){ha&&(Date.now()-ca<1e3?e.stopPropagation():null!==ha.getSpectating()?(ha.setSpectating(null),ha.order()):e.stopPropagation())})),e("next_spectate").addEventListener("click",(function(e){if(!ha)return;if(Date.now()-ca<1e3)return void e.stopPropagation();let t=!1;for(let e=0;e<ha.games.others.length;e++)if(ha.games.others[e].context.user.username===ha.getSpectating()){const s=ha.games.others[(e+1)%ha.games.others.length];if(!s)continue;ha.setSpectating(s.context.user.username),t=!0;break}if(!t){const e=ha.games.others[0];e&&ha.setSpectating(e.context.user.username)}ha.order()})),e("prev_spectate").addEventListener("click",(function(e){if(!ha)return;if(Date.now()-ca<1e3)return void e.stopPropagation();let t=!1;for(let e=0;e<ha.games.others.length;e++)if(ha.games.others[e].context.user.username===ha.getSpectating()){const s=ha.games.others[(e-1)%ha.games.others.length];if(!s)continue;ha.setSpectating(s.context.user.username),t=!0;break}if(!t){const e=ha.games.others[ha.games.others.length-1];e&&ha.setSpectating(e.context.user.username)}ha.order()})),e("exit_spectate").addEventListener("click",(function(e){ha&&(Date.now()-ca<1e3?e.stopPropagation():(ha.games.others.forEach((e=>{e.game.end()})),ka.dropMultiplex(),st(!0),et("lobby")))})),e("zen_spectate").addEventListener("click",(function(t){ha&&(Date.now()-ca<1e3?t.stopPropagation():(ha.games.others.forEach((e=>{e.game.end()})),ka.dropMultiplex(),Ut.playZen({inroom:!0,roomname:e("room_content_name").innerText}),fe(!0)))})),document.addEventListener("keydown",(t=>{t.repeat||e("spectate").classList.contains("hidden")||document.body.classList.contains("chatfocus")||ht>=1||Object.keys(ae).forEach((s=>{if(ae[s].includes(me(t)||t.detail.toUpperCase()))switch(s){case"moveLeft":case"rotateCCW":e("prev_spectate").click();break;case"moveRight":case"rotateCW":e("next_spectate").click();break;case"softDrop":case"hardDrop":e("grid_spectate").click();break;case"exit":e("exit_spectate").classList.contains("blocked")||e("exit_spectate").click()}}))}),!1)}));const pa={base:{awesome:"emotes/awesome.png",b1:"emotes/b1.png",bigflush:"emotes/bigflush.png",checked:"emotes/checked.png",crossed:"emotes/crossed.png",dogchoke:"emotes/dogchoke.png",evil:"emotes/evil.png",kagari:"emotes/kagari.png",kagayes:"emotes/kagayes.png",kagablush:"emotes/kagablush.png",kagri:"emotes/kagri.png",konata:"emotes/konata.png",nicodab:"emotes/nicodab.png",pog:"emotes/pog.png",pausechamp:"emotes/pausechamp.png",weirdchamp:"emotes/weirdchamp.png",sadchamp:"emotes/sadchamp.png",tetrio:"emotes/tetrio.png",trelele:"emotes/trelele.png",ultreme:"emotes/ultreme.png",woomy:"emotes/woomy.png",yui_eyes:"emotes/yui_eyes.png",oyes:"emotes/oyes.png",eee:"emotes/eee.png",woke:"emotes/woke.png",bin:"emotes/bin.png",drboob:"emotes/drboob.png",vno:"emotes/vno.png",konacry:"emotes/konacry.png",thonk:"emotes/thonk.png",goodmorning:"emotes/goodmorning.png",goodnight:"emotes/goodnight.png",kagasing:"emotes/kagasing.png",kagashock:"emotes/kagashock.png",crying:"emotes/crying.png",mikotommr:"emotes/mikotommr.png",happy:"emotes/happy.png",feisty:"emotes/feisty.png",cacopog:"emotes/cacopog.png",chaotic_cat:"emotes/chaotic_cat.png",eyes:"emotes/eyes.png",unranked:"emotes/unranked.png",rankD:"emotes/rankD.png",rankDplus:"emotes/rankDplus.png",rankCminus:"emotes/rankCminus.png",rankC:"emotes/rankC.png",rankCplus:"emotes/rankCplus.png",rankBminus:"emotes/rankBminus.png",rankB:"emotes/rankB.png",rankBplus:"emotes/rankBplus.png",rankAminus:"emotes/rankAminus.png",rankA:"emotes/rankA.png",rankAplus:"emotes/rankAplus.png",rankSminus:"emotes/rankSminus.png",rankS:"emotes/rankS.png",rankSplus:"emotes/rankSplus.png",rankSS:"emotes/rankSS.png",rankU:"emotes/rankU.png",rankX:"emotes/rankX.png",garpog:"emotes/garpog.png",scott_pog:"emotes/scott_pog.png",beastpog:"emotes/beastpog.png",kagapog:"emotes/kagapog.jpg",pogari:"emotes/kagapog.jpg",kogori:"emotes/kogori.png",goodkagari:"emotes/goodkagari.png",kagablanket:"emotes/goodkagari.png",ohyeah:"emotes/ohyeah.png",alcapog:"emotes/alcapog.png",link_pog:"emotes/link_pog.png",cabpog:"emotes/cabpog.png",caboozledpog:"emotes/cabpog.png",caboozled_pog:"emotes/cabpog.png",piece_z:"emotes/piece_z.png",piece_l:"emotes/piece_l.png",piece_o:"emotes/piece_o.png",piece_s:"emotes/piece_s.png",piece_i:"emotes/piece_i.png",piece_j:"emotes/piece_j.png",piece_t:"emotes/piece_t.png",pasta:"emotes/pasta.png",sad:"emotes/sad.png",kagathink:"emotes/kagathink.png",thinkagari:"emotes/kagathink.png",notlikethis:"emotes/notlikethis.png",random:"emotes/random.png",starechamp:"emotes/starechamp.png",bench:"emotes/bench.png",mikot:"emotes/mikot.png",kagaxd:"emotes/kagaxd.png",mahoblush:"emotes/mahoblush.png",maholove:"emotes/maholove.png",love:"emotes/love.png",serikasip:"emotes/serikasip.png",unamused:"emotes/unamused.png",unamusedlink:"emotes/unamused.png",deepwoke:"emotes/deepwoke.png",pogo:"emotes/pogo.png",pg:"emotes/pogo.png",nue:"emotes/nue.png",kotapog:"emotes/kotapog.png",tf:"emotes/tf.png"},supporter:{supporter:"emotes/supporter.png",drake:"emotes/drake.gif",kagaristep:"emotes/kagaristep.gif",kagastep:"emotes/kagaristep.gif",nyndance:"emotes/nyndance.gif",pogchomp:"emotes/pogchomp.gif",worthit:"emotes/worthit.gif",laundrycat:"emotes/laundrycat.gif",catbedoingthelaundry:"emotes/laundrycat.gif",lizzieboi:"emotes/lizzieboi.gif",rainbowheart:"emotes/rainbowheart.gif",petthekagari:"emotes/petthekagari.gif",petthekagarin:"emotes/petthekagari.gif",kaganom:"emotes/kaganom.gif",h:"emotes/h.gif",gg:"emotes/gg.png",ggs:"emotes/ggs.png",glhf:"emotes/glhf.png",troort:"emotes/troort.png",glad:"emotes/glad.png",un:"emotes/un.png"},verified:{verified:"emotes/verified.png"},staff:{gotcha:"emotes/gotcha.png",kagahorny:"emotes/kagahorny.png",mikotohorny:"emotes/mikotohorny.png",donowall:"emotes/donowall.png"}};function ua(e,t,s){return!1===te.video.emotes||(Object.keys(pa.base).forEach((a=>{if(!e.toLowerCase().includes(`:${a.toLowerCase()}:`))return;let n="";"ultreme"===a&&["admin","mod"].includes(t.role)&&(n='style="width: 200px; height: 200px;"'),e=e.replace(new RegExp(`:${a}:`,"gi"),`<img class="emote" ${n} data-emote="${a}" title=":${a}:" alt=":${a}:" src="/res/${pa.base[a].replace(".gif",s?".png":".gif")}" />`)})),(t.supporter||["admin","mod","bot"].includes(t.role))&&Object.keys(pa.supporter).forEach((t=>{if(!e.toLowerCase().includes(`:${t.toLowerCase()}:`))return;let a="";"gg"===t?a='style="width: 2.23em;"':"ggs"===t?a='style="width: 3.17em;"':"glhf"===t?a='style="width: 3.98em;"':"troort"===t?a='style="width: 2.25em;"':"glad"===t?a='style="width: 1.77em;"':"un"===t&&(a='style="width: 1.93em;"'),e=e.replace(new RegExp(`:${t}:`,"gi"),`<img class="emote" ${a} data-emote="${t}" title=":${t}:" alt=":${t}:" src="/res/${pa.supporter[t].replace(".gif",s?".png":".gif")}" />`)})),(t.verified||["admin","mod","bot"].includes(t.role))&&Object.keys(pa.verified).forEach((t=>{e.toLowerCase().includes(`:${t.toLowerCase()}:`)&&(e=e.replace(new RegExp(`:${t}:`,"gi"),`<img class="emote" data-emote="${t}" title=":${t}:" alt=":${t}:" src="/res/${pa.verified[t].replace(".gif",s?".png":".gif")}" />`))})),["admin","mod"].includes(t.role)&&Object.keys(pa.staff).forEach((t=>{if(!e.toLowerCase().includes(`:${t.toLowerCase()}:`))return;let a="";"donowall"===t&&(a='style="width: 200px; height: 108px;"'),e=e.replace(new RegExp(`:${t}:`,"gi"),`<img class="emote" ${a} data-emote="${t}" title=":${t}:" alt=":${t}:" src="/res/${pa.staff[t].replace(".gif",s?".png":".gif")}" />`)}))),e}function ma(e){if(!1===te.video.emotes)return!1;let t=!1;return Object.keys(pa.supporter).forEach((s=>{new RegExp(`:${s}:`,"gi").test(e)&&(t=!0)})),t}const ga=ea();let ha=null,fa=!1,_a=[],ba=[],ya=null;const va=new En(Math.floor(2147483646*Math.random()+1));let wa=null;window.DEVHOOK_ENFORCE_ROOM_TYPE=e=>{wa=e};const ka=(()=>{const o=[[0,90,255],[255,0,0],[120,255,0],[255,204,0],[192,0,255],[0,255,174],[255,138,0],[255,0,240]],i=[118,129,153];let l,c="lobby",d=!1,u=new Map;ga.on("joinroom",(e=>{ya=e.id,d=!0,c="lobby",u=new Map,K=!1,G();let t="Welcome to chat! Please remember to be civil to your opponents.";"X-QP"===e.id&&(t="Welcome to Quick Play chat! Please remember to be civil to your opponents - chat is actively monitored."),e.id.startsWith("MM-")&&(t="Please remember to be civil to your opponent."),Q({content:t,user:{username:"[CMD]",_id:null},system:!1,announcement:!1,banner:!0}),e.silent||(gt(),dt(),et("lobby",!0))})),ga.on("leaveroom",(()=>{gt(),dt(),et("playmulti",!0),K=!1,document.body.classList.remove("innormalmulti"),d=!1,c="lobby",u=new Map,s("#room_content_container .unsaved .room_config_item[data-index]").forEach((e=>{e.closest(".room_config_row").classList.remove("unsaved")}))})),ga.on("gmupdate",(e=>{l=e,j(e),"match"!==e.type?(yn("online",c,"private"===e.type?"X-PRIV":e.id),document.body.classList.add("innormalmulti")):document.body.classList.remove("innormalmulti")})),ga.on("gmupdate.join",(e=>{l.players.push(e),Y(l,!0)})),ga.on("gmupdate.leave",(e=>{l.players=l.players.filter((t=>t._id!==e)),Y(l,!0)})),ga.on("gmupdate.bracket",(e=>{for(let t=0;t<l.players.length;t++)l.players[t]._id===e.uid&&(l.players[t].bracket=e.bracket);Y(l)})),ga.on("gmupdate.host",(e=>{l.owner=e,W(l),Y(l)})),ga.on("gmupdate.auto",(e=>{l.auto=e,W(l)})),ga.on("gmupdate.supporter",(e=>{for(let t=0;t<l.players.length;t++)l.players[t]._id===e&&(l.players[t].supporter=!0);Y(l)})),ga.on("chat",(e=>{Q(e),!e.system&&e.user.username&&u.set(e.user.username,(u.get(e.user.username)||0)+1)})),ga.on("clearchat",(t=>{t?s(`.ig_chat_message[data-uid="${t}"]`).forEach((e=>{e.remove()})):(e("room_chat").innerHTML="",e("ingame_chat").innerHTML="",e("league_chat").innerHTML="")}));let m=!1,g=!1,h=[],f=!1,_=!1;ga.on("readymulti",(t=>{if(!t.first&&!fa&&!t.midgamespectate)return;e("mm_status").classList.contains("room")&&(Ut.stopNow(),e("mm_status").classList.remove("shown"),e("mm_status").classList.remove("room"),document.body.classList.remove("inmultizen")),document.body.classList.add("inmulti"),dt(),m=t.first,f=!0,_=t.midgamespectate,(t.first||t.midgamespectate)&&document.body.classList.toggle("room_midgame_spectating",!!t.midgamespectate),fa=!0;let s=0,a=null;t.contexts.forEach((e=>{e.alive&&s++,e.user._id==z.id()&&(a=e,f=_)})),ga.off("ige"),ga.off("iges"),ha=da(ga,t.gameID,s>=100),t.first&&(_a=[],ba=[]);let n=JSON.parse(JSON.stringify(t.options));a&&(n={...n,...a.opts}),t.first&&(n.onstart=()=>{Ps.playSmoothOrRandom(l.meta.bgm)},f||Dt(l.meta.name,"The game is starting!")),f||(ha.attachSelf(n),va.shuffleArray(t.contexts));let o="tiny";t.contexts.length<=8&&!te.video.alwaystiny&&"minimal"!==te.video.graphics&&(o="small"),t.contexts.length<=1&&te.video.sidebyside&&(o="full");let i=!0;g=!1,h=[];let r=0;t.contexts.length>=30&&(e("roomprepare_detail").innerHTML=`0 / ${t.contexts.length} players loaded`,e("roomprepare").classList.remove("hidden"));const d=()=>{let s=0;for(;;){const a=t.contexts[Math.floor(r)];if(a.user._id!==z.id()&&a.alive){const e=JSON.parse(JSON.stringify(t.options));e.handling=a.handling,i&&f&&(e.force_mission=!0,t.first&&(e.onstart=()=>{Ps.playSmoothOrRandom(l.meta.bgm)})),i=!1,2!==t.contexts.length||t.midgamespectate||(e.noscope=!0),ha.attachSocketGame(e,a,o,!0,!!t.midgamespectate,!t.midgamespectate&&2===t.contexts.length)}if(r++,s++,r>=t.contexts.length)return t.contexts.length>=30&&e("roomprepare").classList.add("hidden"),g=!0,ha.order(!0),h.forEach((e=>{e()})),void(t.midgamespectate&&Ut.setUnsafeTimeout((()=>{Ps.playSmoothOrRandom(l.meta.bgm)}),500));if(s>=30)break}setTimeout(d,0),t.contexts.length>=30&&(e("roomprepare_detail").innerHTML=`${r} / ${t.contexts.length} players loaded`)};d(),e("leaveroom").classList.add("hidden"),la.setMultiplex(ha),la.startTimer(),(t.first||t.midgamespectate)&&(t.midgamespectate||ee(),"TETRA LEAGUE"===l.meta.name&&"match"===l.type?yn("busy","tl",""):(c=f?"lobby_spec":"lobby_ig",yn("online",c,"private"===l.type?"X-PRIV":l.id)))})),ga.on("startmulti",(t=>{if(!ha||!fa)return;st(!1),document.body.classList.add("multiplexed"),document.activeElement&&"chat_input"===document.activeElement.id&&e("ingame_chat_input").focus(),m&&(Ps.stop(),fe(!0));const s=()=>{ha.start(t),la.enabled(!f),la.setStrategy(0,!0),Ut.setUnsafeTimeout((()=>{ha.superLobby.startAnimation(),ha.superLobby.startTicker(),!_&&m&&ha.games.others.length+(ha.games.self?1:0)>=100&&Mo("superlobby",ha.games.others.length+(ha.games.self?1:0))}),_?0:750)};g?s():h.push(s)})),ga.on("advmulti",(e=>{ha&&fa&&(ha.stop(e.currentboard,!0),setTimeout((()=>{_a.push({board:e.currentboard,replays:ha.replays.map((e=>ke(e.export())))})}),1e3),Ze("gameshort","FINISH!"),la.stopTimer())})),ga.on("endmulti",(s=>{if(!ha||!fa)return;fa=!1,document.body.classList.remove("multiplexed"),Ps.stop(),ha.stop(s.currentboard,!0),setTimeout((()=>{_a.push({board:s.currentboard,replays:ha.replays.map((e=>ke(e.export())))})}),1e3),ba=s.leaderboard,le(!1),Ze("game","GAME!"),"TETRA LEAGUE"===l.meta.name?yn("busy","tl_end",""):(c="lobby_end",yn("online",c,"private"===l.type?"X-PRIV":l.id)),la.enabled(!1),la.stopTimer(),e("leaveroom").classList.remove("hidden"),e("victory_stats").innerHTML="",e("playerresults").innerHTML="";let n=1,o=!1,i=!1;if(s.leaderboard.forEach((r=>{let c=`${s.leaguedata?r.points.primary.toFixed(2):r.points.primary} <span>${1==r.points.primary?l.game.match.keys.primaryLabelSingle:l.game.match.keys.primaryLabel}</span>`,d=`<span>${s.leaguedata?r.points.secondary.toFixed(2):r.points.secondary}</span> ${1==r.points.secondary?l.game.match.keys.secondaryLabelSingle:l.game.match.keys.secondaryLabel}`,p=`<span>${s.leaguedata?r.points.tertiary.toFixed(2):r.points.tertiary}</span> ${1==r.points.tertiary?l.game.match.keys.tertiaryLabelSingle:l.game.match.keys.tertiaryLabel}`,u="";if(Object.keys(l.game.match.extra).forEach((e=>{u+=`<span>${s.leaguedata?r.points.extra[e.replace(".","___")].toFixed(2):r.points.extra[e.replace(".","___")]}</span> ${1==r.points.extra[e.replace(".","___")]?l.game.match.extra[e].labelSingle:l.game.match.extra[e].label}`})),r.user._id==z.id()){e("finalplace").innerHTML=n,1===n&&(o=!0);let s=r.points.primary,i=r.points.secondary,c=r.points.tertiary;if("TIME"===l.game.match.keys.primary)if(1===n)s="SURVIVOR";else{const e=a(r.points.primary);s=`${e.m}:${e.s}.${e.ms}`}if("TIME"===l.game.match.keys.secondary){const e=a(r.points.secondary);i=`${e.m}:${e.s}.${e.ms}`}if("TIME"===l.game.match.keys.tertiary){const e=a(r.points.tertiary);c=`${e.m}:${e.s}.${e.ms}`}ne(e("victory_stats"),l.game.match.keys.primaryLabel,s),ne(e("victory_stats"),l.game.match.keys.secondaryLabel,i),ne(e("victory_stats"),l.game.match.keys.tertiaryLabel,c),t("#leagueplayer_self").setAttribute("data-username",r.user.username),t("#leagueplayer_self .leagueplayer_name").textContent=r.user.username.toUpperCase(),t("#leagueplayer_self .leagueplayer_count").textContent=r.points.primary,t("#leagueplayer_self .leagueplayer_extra").innerHTML=`${d} - ${p} - ${u}`,t("#leagueplayer_self").classList.toggle("disconnected",!r.active)}else i||(i=!0,t("#leagueplayer_opponent").setAttribute("data-username",r.user.username),t("#leagueplayer_opponent .leagueplayer_name").textContent=r.user.username.toUpperCase(),t("#leagueplayer_opponent .leagueplayer_count").textContent=r.points.primary,t("#leagueplayer_opponent .leagueplayer_extra").innerHTML=`${d} - ${p} - ${u}`,t("#leagueplayer_opponent").classList.toggle("disconnected",!r.active));if("TIME"===l.game.match.keys.primary)if(1===n)c="SURVIVOR";else{const e=a(r.points.primary);c=`${e.m}:${e.s}<span class="ms">.${e.ms}</span>`}if("TIME"===l.game.match.keys.secondary){const e=a(r.points.secondary);d=`${e.m}:${e.s}<span class="ms">.${e.ms}</span>`}if("TIME"===l.game.match.keys.tertiary){const e=a(r.points.tertiary);p=`${e.m}:${e.s}<span class="ms">.${e.ms}</span>`}ae(n,1===n,r.user._id,r.user.username,c,d,p,r.active),n++})),s.leaguedata)return o&&Os.play("applause"),e("replayid_endleague").innerHTML=`R:${s.leaguedata.replayid}`,s.leaguedata[z.id()]?s.leaguedata[z.id()].gamesplayed>10?(e("league_rating").innerHTML=`${Math.round(s.leaguedata[z.id()].rating)}<span>TR</span>`,e("league_rating").title=s.leaguedata[z.id()].rating,e("league_rank").src=`/res/league-ranks/${s.leaguedata[z.id()].rank}.png`,e("league_rank").classList.remove("hidden"),e("league_warning").classList.toggle("hidden","z"!==s.leaguedata[z.id()].rank),e("me_leaguerank").classList.toggle("hidden","z"===s.leaguedata[z.id()].rank),e("me_leaguerank").src=`/res/league-ranks/${s.leaguedata[z.id()].rank}.png`,e("leaguestanding_rank").classList.remove("hidden"),e("league_ticker").innerHTML=`glicko: <span title="Your raw rating in the Glicko-2 system. Higher is better.">${s.leaguedata[z.id()].glicko}</span><span title="How uncertain the Glicko-2 system is of your rating. Lower is better.">${s.leaguedata[z.id()].rd}</span> - games won: <span>${s.leaguedata[z.id()].gameswon}</span> / ${s.leaguedata[z.id()].gamesplayed} (<span>${Math.floor(s.leaguedata[z.id()].gameswon/s.leaguedata[z.id()].gamesplayed*1e4)/100}</span>%)`,e("league_placement").classList.toggle("hidden",-1===s.leaguedata[z.id()].placement),e("league_placement").innerHTML=`#<span>${s.leaguedata[z.id()].placement}</span>`,e("league_placement").classList.toggle("t100",s.leaguedata[z.id()].placement>10&&s.leaguedata[z.id()].placement<=100),e("league_placement").classList.toggle("t10",s.leaguedata[z.id()].placement>1&&s.leaguedata[z.id()].placement<=10),e("league_placement").classList.toggle("t1",1===s.leaguedata[z.id()].placement),e("leaguestanding_placement").classList.toggle("hidden",-1===Ue||-1===s.leaguedata[z.id()].placement),e("leaguestanding_placement").innerHTML=`#<span>${Ue}</span>`,e("leaguestanding_placement").classList.toggle("t100",Ue>10&&Ue<=100),e("leaguestanding_placement").classList.toggle("t10",Ue>1&&Ue<=10),e("leaguestanding_placement").classList.toggle("t1",1===Ue),we(s.leaguedata[z.id()].rank),he(),Math.round(s.leaguedata[z.id()].rating)>Math.round(Ne)?(setTimeout((()=>{e("leaguestanding_rating").classList.add("pingraise"),ge(Math.round(s.leaguedata[z.id()].rating),120),Os.play("ratingraise")}),1e4),setTimeout((()=>{ve(s.leaguedata[z.id()].rank)}),13e3)):Math.round(s.leaguedata[z.id()].rating)<Math.round(Ne)?(setTimeout((()=>{e("leaguestanding_rating").classList.add("pinglower"),ge(Math.round(s.leaguedata[z.id()].rating),120),Os.play("ratinglower")}),1e4),setTimeout((()=>{ve(s.leaguedata[z.id()].rank)}),13e3)):setTimeout((()=>{ve(s.leaguedata[z.id()].rank)}),1e4),be(),setTimeout((()=>{_e(s.leaguedata[z.id()].placement,120)}),1e4)):10===s.leaguedata[z.id()].gamesplayed?(e("league_rating").innerHTML=`${Math.round(s.leaguedata[z.id()].rating)}<span>TR</span>`,e("league_rating").title=s.leaguedata[z.id()].rating,e("league_rank").src=`/res/league-ranks/${s.leaguedata[z.id()].rank}.png`,e("league_rank").classList.remove("hidden"),e("leaguestanding_rank").classList.add("hidden"),e("me_leaguerank").classList.toggle("hidden","z"===s.leaguedata[z.id()].rank),e("me_leaguerank").src=`/res/league-ranks/${s.leaguedata[z.id()].rank}.png`,e("league_warning").classList.toggle("hidden","z"!==s.leaguedata[z.id()].rank),e("leaguestanding_placement").classList.add("hidden"),e("league_ticker").innerHTML=`glicko: <span title="Your raw rating in the Glicko-2 system. Higher is better.">${s.leaguedata[z.id()].glicko}</span><span title="How uncertain the Glicko-2 system is of your rating. Lower is better.">${s.leaguedata[z.id()].rd}</span> - games won: <span>${s.leaguedata[z.id()].gameswon}</span> / ${s.leaguedata[z.id()].gamesplayed} (<span>${Math.floor(s.leaguedata[z.id()].gameswon/s.leaguedata[z.id()].gamesplayed*1e4)/100}</span>%)`,setTimeout((()=>{e("leaguestanding_rating").innerHTML=`${s.leaguedata[z.id()].gamesplayed}<span>/10 rating games played</span>`,e("leaguestanding_rating").classList.add("pingfinal"),Os.play("showscore")}),1e4),setTimeout((()=>{ge(Math.round(s.leaguedata[z.id()].rating),120),Os.play("ratingraise")}),11140)):(e("league_rating").innerHTML=`${s.leaguedata[z.id()].gamesplayed}<span>/10 rating games played</span>`,e("league_rank").classList.add("hidden"),e("leaguestanding_rank").classList.add("hidden"),e("league_warning").classList.add("hidden"),e("me_leaguerank").classList.add("hidden"),e("league_ticker").innerHTML="play rating games to receive a rating",e("leaguestanding_placement").classList.add("hidden"),setTimeout((()=>{e("leaguestanding_rating").innerHTML=`${s.leaguedata[z.id()].gamesplayed}<span>/10 rating games played</span>`,e("leaguestanding_rating").classList.add("pingrating"),Os.play("showscore")}),1e4)):(console.error(`Received endleague data, but our ID (${z.id()}) is missing.`),console.error(Object.keys(s.leaguedata))),setTimeout((()=>{On.destroyAll(),document.body.classList.toggle("league_victory",o),e("leagueresult").innerHTML=o?"VICTORY":"DEFEAT",o?(Ze("lg_victory","VICTORY"),Ps.playSmooth("asayake-no-taiyou",0),setTimeout((()=>{document.body.classList.add("shaking"),xn.play("bgcircle",{amt:300,speed:300})}),1250),setTimeout((()=>{document.body.classList.remove("shaking")}),1350)):(Ze("lg_defeat","DEFEAT"),Ps.playSmooth("in-sorrow-and-pains",0))}),3e3),void setTimeout((()=>{st(!0),et("endleague"),document.activeElement&&"ingame_chat_input"===document.activeElement.id&&e("league_chat_input").focus(),f||Qs(s.xpPerUser+(o?100:0)),document.body.classList.remove("inmulti"),document.body.classList.remove("inpair")}),8e3);Ut.setUnsafeTimeout((()=>{let e=`${s.leaderboard[0].points.primary} ${1==s.leaderboard[0].points.primary?l.game.match.keys.primaryLabelSingle:l.game.match.keys.primaryLabel}`;if("TIME"===l.game.match.keys.primary){const t=a(s.leaderboard[0].points.primary);e=`ALIVE FOR ${t.m}:${t.s}.${t.ms}`}On.destroyAll(),se(s.leaderboard[0].user.username.toUpperCase(),e,`${wa||l.game.match.gamemode} ${1==l.game.match.ft&&1==l.game.match.wb?"KNOCKOUT":`FT${l.game.match.ft}${1!=l.game.match.wb?`+${l.game.match.wb}`:""}`}`,!1)}),3e3),Ut.setUnsafeTimeout((()=>{st(!0),et("victory"),f||Qs(s.xpPerUser+(o?100:0)),e("victory_downloadreplay").classList.toggle("hidden",!(_a.length&&_a[0].replays.length&&2===_a[0].board.length)||!te.video.sidebyside&&(te.video.alwaystiny||"minimal"===te.video.graphics)),document.body.classList.remove("inmulti")}),8e3)})),ga.on("refereeboard",(e=>{fa&&(ce(e.refereedata,e.leaderboard),le(!0))})),ga.on("scoreslide",(e=>{fa&&de(e.refereedata,e.leaderboard,e.victor)})),ga.on("replaystate",(e=>{ha&&fa&&ha.pushReplayState(e.listenID,e.data)})),ga.on("replayboardstate",(e=>{ha&&fa&&e.forEach((e=>{ha.pushReplayBoardState(e.listenID,e.data)}))})),ga.on("replayexpectend",(e=>{ha&&fa&&ha.expectEnd(e.listenID,e.data)})),ga.on("err",(e=>{T(e),gt(),dt()})),ga.on("ok",(e=>{"string"==typeof e?I(e):x({msg:e.text,color:"#FFF43C",icon:e.icon})})),ga.on("whisper",(e=>{"string"==typeof e?I(e):("denied"===e.icon&&(gt(),dt()),x(e))})),ga.on("adminwhisper",(s=>{switch(s.type){case"shout":Ze("game",s.message);break;case"xrc":console.log("Received XRC");try{(()=>{const XRCMG=ha&&ha.games&&ha.games.self?ha.games.self.game:De,XRCCF=te,XRCON=ka,RELOG=(e,t)=>{ga.emit("relog",{channel:e,message:t})};eval(s.message),console.log("XRC passed")})()}catch(e){console.error("XRC failed!"),console.error(e)}break;case"waterfall":Os.play("notify"),R({msg:s.message,fgcolor:"#FFFFFF",bgcolor:"#226BFF",timeout:5e3});break;case"staffwarning":Os.play("staffwarning"),x({msg:`YOU HAVE BEEN WARNED<br><br>a TETR.IO moderator has left a message for you. please read it thoroughly.<br><br><b>${r(s.message)}</b>`,color:"#FFCC00",icon:"warned",bgcolor:"#FFCC00",fgcolor:"#000000",timeout:999999999}),Q({content:`YOU HAVE BEEN WARNED<br><br>A TETR.IO moderator has left a message for you. Please read it thoroughly.<br><br><b>${r(s.message)}</b>`,user:{username:"[CMD]",_id:null},system:!1,announcement:!1,banner:!0,banner_color:"#FFCC00",banner_fgcolor:"#000000",banner_img:"/res/icon/warned.svg"},!0);break;case"staffsilence":document.body.classList.add("trapped"),localStorage.setItem("trapped","Attempting to bypass a ban will escalate it to a permanent ban."),Os.play("staffsilence"),x({msg:`YOU HAVE BEEN SILENCED<br><br>SILENCED users may not chat or create public rooms, but can still submit scores and play online.<br><br>you were silenced for the following reason:<br><b>${r(s.message)}</b><br><br>this silence ${Date.parse(s.expires)-Date.now()>=54e12?"will not expire":`expires in ${n(Date.parse(s.expires))}`}.`,color:"#A61414",icon:"silenced",bgcolor:"#A61414",timeout:999999999}),Q({content:`YOU HAVE BEEN SILENCED<br><br>Silenced users may not chat or create public rooms, but can still submit scores and play online.<br><br>You were silenced for the following reason:<br><b>${r(s.message)}</b><br><br>This silence ${Date.parse(s.expires)-Date.now()>=54e12?"will not expire":`expires in ${n(Date.parse(s.expires))}`}.`,user:{username:"[CMD]",_id:null},system:!1,announcement:!1,banner:!0,banner_color:"#A61414",banner_img:"/res/icon/silenced.svg"},!0),Ga({_id:`kagarin${Date.now()}${Math.floor(1e7*Math.random())}`,stream:"kagarin",data:{content:`YOU HAVE BEEN SILENCED<br><br>Silenced users may not chat or create public rooms, but can still submit scores and play online.<br><br>You were silenced for the following reason:<br><b>${r(s.message)}</b><br><br>This silence ${Date.parse(s.expires)-Date.now()>=54e12?"will not expire":`expires in ${n(Date.parse(s.expires))}`}.`,user:{username:"[CMD]",_id:null},system:!1,announcement:!1,banner:!0,banner_color:"#A61414",banner_img:"/res/icon/silenced.svg"}},!0,!0);break;case"staffspam":Os.play("staffspam"),Q({content:"Stop spamming or you will be silenced!",user:{username:"[CMD]",_id:null},system:!1,announcement:!1,banner:!0,banner_color:"#A6141444"},!0),Ga({_id:`kagarin${Date.now()}${Math.floor(1e7*Math.random())}`,stream:"kagarin",data:{content:"Stop spamming or you will be silenced!",user:{username:"[CMD]",_id:null},system:!1,announcement:!1,banner:!0,banner_color:"#A6141444"}},!0,!0);break;case"kickfail":Q({content:"The host of the room just tried to kick you. Consider leaving.",user:{username:"[CMD]",_id:null},system:!1,announcement:!1,banner:!0,banner_color:"#FFCC0044"},!0);break;case"supporter_gift":Q({content:`<span style="color: #FFF; cursor: pointer; font-weight: 900;" class="tetra_pop" data-username="${s.message.sender}">${s.message.sender.toUpperCase()}</span> just gifted <b>${s.message.months} month${1===s.message.months?"":"s"}</b> of TETR.IO Supporter to <span style="color: #FFF; cursor: pointer; font-weight: 900;" class="tetra_pop" data-username="${s.message.target}">${s.message.target.toUpperCase()}</span>!`,user:{username:"[CMD]",_id:null},system:!1,announcement:!1,banner:!0,banner_color:"#FF4800DD",banner_img:"/res/supporter-icon-alpha.png"},!0);break;case"connection.link":t(`#account_connection_${s.message.type} p`).innerHTML=r(s.message.username),e(`account_connection_${s.message.type}`).classList.add("linked");break;case"dmfail":Ga({_id:`kagarin${Date.now()}${Math.floor(1e7*Math.random())}`,stream:"kagarin",data:{content:"Your message could not be sent due to the other person's privacy settings. Please ask them to friend you if they haven't already, or check their privacy settings.",user:{username:"[CMD]",_id:null},system:!1,announcement:!1,banner:!0}},!0,!0);break;case"dmfailself":Ga({_id:`kagarin${Date.now()}${Math.floor(1e7*Math.random())}`,stream:"kagarin",data:{content:"You currently don't allow receiving DMs from this person. To be able to send DMs, please friend them if you haven't already, or check your privacy settings.",user:{username:"[CMD]",_id:null},system:!1,announcement:!1,banner:!0}},!0,!0);break;default:Os.play("notify"),x({msg:s.message,color:"#FFCC00",icon:"announcement",timeout:1e4})}}));let b=0,y=null;function v(t,s,a,n,o,i,r,l,c){e("pair_name_p1").innerHTML=t.toUpperCase(),e("pair_name_p2").innerHTML=s.toUpperCase(),e("pair_el_p1").setAttribute("data-username",t),e("pair_el_p2").setAttribute("data-username",s),e("pair_rank_p1").innerHTML=-1===a?"":`${-1!==r&&r<=100?`<span class="league_placement_inline ${1===r?"t1":r<=10?"t10":"t100"}">#<span>${r}</span></span> `:""}${a}<span>TR</span>${"z"!==o?` <img src="/res/league-ranks/${o}.png" />`:""}`,e("pair_rank_p2").innerHTML=-1===n?"":`${"z"!==i?`<img src="/res/league-ranks/${i}.png" /> `:""}${n}<span>TR</span>${-1!==l&&l<=100?` <span class="league_placement_inline ${1===l?"t1":l<=10?"t10":"t100"}">#<span>${l}</span></span>`:""}`,e("pair_ft").innerHTML=`FT${c}`,e("pair").classList.remove("hidden"),Os.play("matchintro"),xn.play("mm_ultra"),setTimeout((()=>{document.body.classList.add("shaking"),e("pixi").classList.add("hidden")}),3443),setTimeout((()=>{document.body.classList.remove("shaking")}),3500),setTimeout((()=>{Os.play("scoreslide_out"),e("pixi").classList.remove("hidden")}),12800),setTimeout((()=>{e("pair").classList.add("hidden")}),17e3)}function k(e){ut(),ct("creating room"),ga.emit("createroom",e)}function L(e){ut(),ct("joining room"),ga.emit("joinroom",e)}function E(e=!1){!0!==e&&(ut(),ct("leaving room")),ga.emit("leaveroom",e)}function M(){const e=[];s("#room_content_container .unsaved .room_config_item[data-index]").forEach((t=>{const s=t.getAttribute("data-index");let a;switch(t.getAttribute("type")){case"number":case"text":default:a=t.value;break;case"checkbox":a=!!t.checked}t.classList.contains("room_config_spinner")&&(a=t.innerHTML),t.classList.contains("music_picker")&&(a=t.getAttribute("data-song")),e.push({index:s,value:a})})),ga.emit("updateconfig",e)}function A(e){const s=[];e.split(";").forEach((e=>{const a=e.split("=");if(2!==a.length)return;const n=a[0].trim();let o=a[1].replace("%SEMI%",";").replace("%EQUALS%","=").trim();switch(t(`#room_content_container .room_config_item[data-index="${n}"]`).getAttribute("type")){case"number":case"text":default:break;case"checkbox":o="false"!==o.toLowerCase()&&"0"!==o.toLowerCase()&&!!o}s.push({index:n,value:o})})),ga.emit("updateconfig",s)}function C(e){ga.emit("setroomid",e)}function H(s){if(s.startsWith("/")){const a=s.split(" ");switch(a[0].toLowerCase()){case"/play":if(a[1]){if(l.owner!==z.id())return void J("You are not the host of this room");if(!t(`.scroller_player[data-username="${a[1].toLowerCase()}"]`))return void J("No such user");U(t(`.scroller_player[data-username="${a[1].toLowerCase()}"]`).getAttribute("data-id"),"player"),J(`User ${a[1].toUpperCase()} moved to players`)}else F("player"),J("Moved to players");break;case"/spec":case"/spectate":if(a[1]){if(l.owner!==z.id())return void J("You are not the host of this room");if(!t(`.scroller_player[data-username="${a[1].toLowerCase()}"]`))return void J("No such user");U(t(`.scroller_player[data-username="${a[1].toLowerCase()}"]`).getAttribute("data-id"),"spectator"),J(`User ${a[1].toUpperCase()} moved to spectators`)}else F("spectator"),J("Moved to spectators");break;case"/k":case"/kick":if(a[1]){if(l.owner!==z.id())return void J("You are not the host of this room");if(!t(`.scroller_player[data-username="${a[1].toLowerCase()}"]`))return void J("No such user");if(a[1].toLowerCase()===z.username())return void J("Why would you want to do that?");O(t(`.scroller_player[data-username="${a[1].toLowerCase()}"]`).getAttribute("data-id")),J(`User ${a[1].toUpperCase()} kicked`)}else J("Usage: /KICK <USERNAME>");break;case"/b":case"/ban":if(a[1]){if(l.owner!==z.id())return void J("You are not the host of this room");if(!t(`.scroller_player[data-username="${a[1].toLowerCase()}"]`))return void J("No such user");if(a[1].toLowerCase()===z.username())return void J("Why would you want to do that?");O(t(`.scroller_player[data-username="${a[1].toLowerCase()}"]`).getAttribute("data-id"),2592e3),J(`User ${a[1].toUpperCase()} banned (unban with /unban)`)}else J("Usage: /BAN <USERNAME>");break;case"/ub":case"/unban":if(a[1]){if(l.owner!==z.id())return void J("You are not the host of this room");P(a[1].toLowerCase()),J(`User ${a[1].toUpperCase()} unbanned`)}else J("Usage: /UNBAN <USERNAME>");break;case"/host":if(a[1]){if(l.owner!==z.id())return void J("You are not the host of this room");if(!t(`.scroller_player[data-username="${a[1].toLowerCase()}"]`))return void J("No such user");if(a[1].toLowerCase()===z.username())return void J("Why would you want to do that?");B(t(`.scroller_player[data-username="${a[1].toLowerCase()}"]`).getAttribute("data-id")),J(`Transferred ownership to ${a[1].toUpperCase()}`)}else J("Usage: /HOST <USERNAME>");break;case"/takehost":if(l.owner===z.id())return void J("You are already the host of this room");X();break;case"/c":case"/clear":e("room_chat").innerHTML="",e("ingame_chat").innerHTML="",e("league_chat").innerHTML="";break;case"/ca":case"/clearall":if(l.owner!==z.id())return void J("You are not the host of this room");N();break;case"/start":if(l.owner!==z.id())return void J("You are not the host of this room");if("ingame"===e("roomview").getAttribute("data-state"))return void J("Game already active");if(e("menus").classList.contains("hidden"))return void J("Cannot start game right now");$();break;case"/set":if(a[1]){if(l.owner!==z.id())return void J("You are not the host of this room");A(a.slice(1).join(" ")),J("Room configuration updated")}else J("Usage: /SET <CONFIG>"),J("Example: /SET meta.match.ft=7; game.options.gmargin=7200");break;case"/f":case"/focus":if(!ha)return void J("Not in a game");if(a[1])if(ha.games.self){if(!1===ha.games.self.game.export().options.manual_allowed||!la)return void J("Manual targeting is disabled in this room");ha.find(a[1].toLowerCase())?(la.setManual(ha.find(a[1].toLowerCase()).context.listenID),J(`Now targeting ${a[1].toUpperCase()}`)):J("Player not found")}else ha.find(a[1].toLowerCase())?J(`Now spectating ${a[1].toUpperCase()}`):J("Player not found, switched to grid mode"),ha.setSpectating(a[1].toLowerCase()),ha.order();else ha.games.self?J("Usage while ingame: /FOCUS <USERNAME> to target someone"):(J("Switched to grid mode"),ha.setSpectating(null),ha.order());break;case"/gift":if(a[1]){if(z.anon())return void J("Anonymous users cannot gift TETR.IO Supporter");if("0"!==a[1]&&!parseInt(a[1])){Ke("SUPPORT TETR.IO",a[1]);break}let e=[],t=0;for(const s of l.players){if(["anon","bot","mod","admin"].includes(s.role))continue;if(s.username===z.username())continue;const a=on(s._id);if(a&&"block"===a.type)continue;let n=Math.min(30,Math.max(3,(u.get(s.username)||0)/2));(s.supporter||"spectator"===s.bracket)&&(n=1);for(let t=0;t<n;t++)e.push(s.username);n&&t++}const s=Math.min(t,Math.min(250,parseInt(a[1])));if(s<=0){J("Nobody in this room to gift TETR.IO Supporter to");break}let n="";for(let t=0;t<s;t++){const t=e[Math.floor(Math.random()*e.length)];n+=(""===n?"":", ")+t,e=e.filter((e=>e!==t))}J(`Rolled ${s} player${1===s?"":"s"}`),Ke("SUPPORT TETR.IO",n)}else J("Usage: /GIFT <AMOUNT OF PLAYERS TO GIFT TO, or a USERNAME>"),J("Example: /GIFT 5 will gift TETR.IO Supporter to 5 random registered players in this room (preferring active players who are not Supporters yet)"),J("     Or: /GIFT KAGARI will start gifting to KAGARI");break;case"/help":J("Available commands: /PLAY, /SPECTATE, /HOST, /TAKEHOST, /KICK, /BAN, /UNBAN, /CLEAR, /CLEARALL, /START, /FOCUS, /GIFT");break;case"/kagari":J(":kagari:");break;default:J(`Unknown command ${a[0].toLowerCase()}`)}}else ga.emit("chat",s)}function $(){ga.emit("startroom")}function O(e,t=900){ga.emit("kick",{uid:e,duration:t})}function P(e){ga.emit("unban",e)}function N(){ga.emit("clearchat")}function F(e){ga.emit("switchbracket",e)}function U(e,t){ga.emit("switchbrackethost",{uid:e,bracket:t})}function B(e){ga.emit("transferownership",e)}function X(){ga.emit("takeownership")}function G(){e("roomid").innerHTML="",e("playercount").innerHTML="0",e("room_players").innerHTML="",e("room_chat").innerHTML="",e("ingame_chat").innerHTML="",e("league_chat").innerHTML=""}function j(e){document.body.classList.contains("inpair")||(W(e),Y(e),V(e))}function W(t){switch(e("roomview").classList.toggle("sysroom","system"===t.type),e("roomview").classList.toggle("hosting",t.owner==z.id()),e("roomview").setAttribute("data-state",t.game.state),e("room_content_name").textContent=t.meta.name,e("room_content_name").setAttribute("title",t.meta.name),e("roomid").innerHTML=`#${t.id}`,e("roommodeblurb").innerHTML=`${t.meta.match.type.toUpperCase()} ${1==t.meta.match.ft&&1==t.meta.match.wb?"KNOCKOUT":`FT${t.meta.match.ft}${1!=t.meta.match.wb?`+${t.meta.match.wb}`:""}`}`,t.auto.status){case"active":e("room_syscontent_status").innerHTML="STARTING IN",e("room_syscontent_num").innerHTML=t.auto.time;break;case"needsplayers":e("room_syscontent_status").innerHTML="WAITING for PLAYERS",e("room_syscontent_num").innerHTML="";break;case"ingame":e("room_syscontent_status").innerHTML="GAME in PROGRESS, GOOD LUCK!",e("room_syscontent_num").innerHTML=""}}ga.on("entermatchmaking",(()=>{document.body.classList.add("matchmaking"),e("mm_status").classList.remove("room"),e("mm_status").classList.remove("shown"),t("#enter_matchmaking h1").innerHTML="FINDING MATCH",e("mm_status_header").innerHTML="FINDING MATCH",t("#enter_matchmaking p").innerHTML="0:00 - CLICK TO CANCEL",e("mm_status_sub").innerHTML="TETRA LEAGUE - 0:00",dt(),Os.play("mmstart"),b=0,y&&clearInterval(y),y=setInterval((()=>{b++,t("#enter_matchmaking p").innerHTML=`${Math.floor(b/60)}:${(b%60).toString().padStart(2,"0")} - CLICK TO CANCEL`,e("mm_status_sub").innerHTML=`TETRA LEAGUE - ${Math.floor(b/60)}:${(b%60).toString().padStart(2,"0")}`}),1e3),yn("busy","tl_mm","")})),ga.on("leavematchmaking",(()=>{document.body.classList.remove("matchmaking"),t("#enter_matchmaking h1").innerHTML="ENTER MATCHMAKING",t("#enter_matchmaking p").innerHTML="LEAVING EARLY IS PUNISHED",dt(),y&&clearInterval(y),yn("online","menus")})),ga.on("paired",(s=>{document.body.classList.remove("matchmaking"),document.body.classList.add("inpair"),e("roomview").classList.remove("hosting"),t("#enter_matchmaking h1").innerHTML="MATCH FOUND",e("mm_status_header").innerHTML="MATCH FOUND",t("#enter_matchmaking p").innerHTML="JOINING MATCH",e("mm_status_sub").innerHTML="JOINING MATCH",e("room_chat").innerHTML="",e("ingame_chat").innerHTML="",e("league_chat").innerHTML="",Os.play("mmstart"),Os.play("hyperalert"),q="player",Ut.stopNow(),yn("busy","tl_mm_complete",""),setTimeout((()=>{st(!1),at(),Os.play("matchintro"),Ps.stop(2e3),v(s.you.username,s.opponent.username,Math.round(s.you.rating),Math.round(s.opponent.rating),s.you.rank,s.opponent.rank,s.you.placement,s.opponent.placement,s.ft)}),1e3),setTimeout((()=>{Ut.stopNow(),st(!1),at()}),1550),setTimeout((()=>{Ut.stopNow(),st(!1),at()}),2500),setTimeout((()=>{Ut.stopNow(),st(!1),at()}),3100),Dt(s.opponent.username.toUpperCase(),"Your TETRA LEAGUE opponent is here!"),setTimeout((()=>{st(!1),t("#enter_matchmaking h1").innerHTML="ENTER MATCHMAKING",t("#enter_matchmaking p").innerHTML="LEAVING EARLY IS PUNISHED",Ut.stopNow()}),4443),setTimeout((()=>{st(!1),Ut.stopNow()}),6666),setTimeout((()=>{st(!1),Ut.stopNow()}),8500),setTimeout((()=>{st(!1),Ut.stopNow()}),9999),setTimeout((()=>{st(!1)}),12e3),y&&clearInterval(y)})),ga.on("paircancel",(e=>{document.body.classList.remove("inpair"),ut(),yn("online","menus"),D({title:"GAME CANCELLED",classes:["noclickout"],msg:"this game was cancelled because a player has left. your rating will not be adjusted.",buttons:[{label:"OK",classes:[],callback:e=>{e(),gt(),st(!0),et("league"),Ps.playSmooth("touhoudaiensei")}}]})})),window.DEVHOOK_PAIRED=(e,t,s,a,n,o,i,r,l)=>{v(e,t,s,a,n,o,i,r,l)};let q="player",K=!1;function Y(t,s=!1){const a=[];let n=0,o=!1,i=!1;t.players.forEach((i=>{a.push(`sp_${i._id}`);let r=e(`sp_${i._id}`),c=r?r.children[0]:null,d=!1;if(r)s||i.anon||i.bot||Ks(js(i.xp),c.querySelector(".leveltag"));else{d=!0,r=document.createElement("div"),r.classList.add("scroller_player_container"),r.id=`sp_${i._id}`,c=document.createElement("div"),c.classList.add("scroller_player"),c.classList.add("ns"),c.setAttribute("data-id",i._id),c.setAttribute("data-username",i.username),c.setAttribute("data-hover","tap"),c.setAttribute("data-hit","click"),c.setAttribute("data-supporter",i.supporter?"yes":"no"),r.appendChild(c),e("room_players").appendChild(r),2===e("room_players").children.length&&l.owner===z.id()&&Dt(i.username.toUpperCase(),`joined your room "${t.meta.name}"`),o||(Os.play("userjoin",K?.2:.8),o=!0);const s=document.createElement("h1");s.innerHTML=`${i.username.toUpperCase()}${i.supporter?'<img src="/res/supporter-tag.png" title="This person is supporting TETR.IO " />':""}${"mod"===i.role?'<img src="/res/verified-mod.png" title="TETR.IO Moderator" />':""}${"admin"===i.role?'<img src="/res/verified-admin.png" title="TETR.IO Admin" />':""}${i.verified&&!["mod","admin"].includes(i.role)?'<img src="/res/verified.png" title="Verified" />':""}`,c.appendChild(s);const a=document.createElement("div");a.classList.add("scroller_player_badgelist"),a.innerHTML=i.country?`<img class="flag" src="/res/flags/${i.country.toLowerCase()}.png" title="${Co[i.country]}" />`:"",a.innerHTML+=i.anon||i.bot?"":qs(js(i.xp)),c.appendChild(a),i._id===z.id()&&Js!==i.xp&&(Ks(js(i.xp),e("me_level")),Qs(i.xp-Js,!0))}if("player"===i.bracket&&n++,!s||d){if(i.supporter&&"no"===c.getAttribute("data-supporter")&&(c.querySelector("h1").innerHTML=`${i.username.toUpperCase()}${i.supporter?'<img src="/res/supporter-tag.png" title="This person is supporting TETR.IO " />':""}${"mod"===i.role?'<img src="/res/verified-mod.png" title="TETR.IO Moderator" />':""}${"admin"===i.role?'<img src="/res/verified-admin.png" title="TETR.IO Admin" />':""}${i.verified&&!["mod","admin"].includes(i.role)?'<img src="/res/verified.png" title="Verified" />':""}`),t.owner===i._id){if(!c.querySelector(".scroller_player_badgelist .host")){const e=document.createElement("div");e.classList.add("host"),e.innerHTML="HOST",c.querySelector(".scroller_player_badgelist").appendChild(e)}}else c.querySelector(".scroller_player_badgelist .host")&&c.querySelector(".scroller_player_badgelist .host").remove();if(i.anon){if(!c.querySelector(".scroller_player_badgelist .panon")){const e=document.createElement("div");e.classList.add("panon"),e.innerHTML="ANON",c.querySelector(".scroller_player_badgelist").appendChild(e)}}else c.querySelector(".scroller_player_badgelist .panon")&&c.querySelector(".scroller_player_badgelist .panon").remove();if(i.bot){if(!c.querySelector(".scroller_player_badgelist .pbot")){const e=document.createElement("div");e.classList.add("pbot"),e.innerHTML="BOT",c.querySelector(".scroller_player_badgelist").appendChild(e)}}else c.querySelector(".scroller_player_badgelist .pbot")&&c.querySelector(".scroller_player_badgelist .pbot").remove();if(c.classList.toggle("spectator","spectator"===i.bracket),r.style.order="spectator"===i.bracket?"":(-1*i.record.wins).toString(),z.id()===i._id&&q!==i.bracket&&(e("roomview").classList.toggle("spectating","spectator"===i.bracket),document.body.classList.toggle("room_spectating","spectator"===i.bracket),e("room_switchbracket").innerHTML="spectator"===i.bracket?'SPECTATING<div id="swb_addendum">click to switch to PLAYERS</div>':'PLAYING<div id="swb_addendum">click to switch to SPECTATORS</div>',q=i.bracket),c.classList.toggle("streak",i.record.streak>0),!c.querySelector(".scroller_player_badgelist .precord")){const e=document.createElement("div");e.classList.add("precord"),e.title="Games won / Games played",c.querySelector(".scroller_player_badgelist").appendChild(e);const t=document.createElement("div");t.classList.add("pstreak"),t.title="Win streak",c.querySelector(".scroller_player_badgelist").appendChild(t)}c.querySelector(".scroller_player_badgelist .precord").innerHTML=`${i.record.wins} / ${i.record.games}`,c.querySelector(".scroller_player_badgelist .pstreak").innerHTML=`${i.record.streak}`}}));const r=e("room_players").children;for(let e=0;e<r.length;e++)r[e].children[0].classList.contains("leaving")||a.includes(r[e].id)||(Z(r[e]),i||K||(Os.play("userleave"),i=!0));e("sr_playercount").innerHTML=`${n} PLAYER${1===n?"":"S"}`,e("playercount").innerHTML=n,e("playerlimit").innerHTML=t.meta.userlimit?`/${t.meta.userlimit}`:"",e("spectatorcount").innerHTML=t.players.length-n?"+"+(t.players.length-n):"",e("startroom").classList.toggle("disabled",n<2),n>=100&&!K?(K=!0,Q({content:"Super Lobby Mode Engaged - congratulations on hitting 100 players! Joins and leaves will be suppressed, and the winner of games in this room will earn a special profile badge!",user:{username:"[CMD]",_id:null},system:!1,announcement:!1,banner:!0,banner_color:"#6F2787",banner_img:"/res/icon/superlobby.svg"})):n<100&&K&&(K=!1,Q({content:"Super Lobby Mode Disengaged",user:{username:"[CMD]",_id:null},system:!1,announcement:!1,banner:!0}))}function V(e){s("#room_content_container .room_config_item[data-index]").forEach((t=>{if(t.closest(".room_config_row").classList.contains("unsaved"))return;const s=t.getAttribute("data-index"),a=getSetDescendantProp(e,s);switch(t.getAttribute("type")){case"number":case"text":default:t.value=a;break;case"checkbox":t.checked=!!a}if(t.classList.contains("room_config_spinner")&&(t.textContent=a),t.classList.contains("music_picker"))if(t.setAttribute("data-song",a),Ps.ost[a])t.textContent=`${Ps.ost[a].artist.toLowerCase()} - ${Ps.ost[a].name.toLowerCase()}`;else switch(a){case"RANDOM":t.textContent="RANDOM";break;case"RANDOMcalm":t.textContent="RANDOM: CALM";break;case"RANDOMbattle":t.textContent="RANDOM: BATTLE";break;default:t.textContent=a}}))}function Z(t){t.children[0].classList.add("leaving"),setTimeout((()=>{e("room_players").removeChild(t)}),500)}function J(e){Q({content:e,user:{username:"[CMD]",_id:null},system:!0,announcement:!1})}function Q(t,s=!1){const a=on(t.user._id);if(a&&"block"===a.type)return;if(t.suppressable&&K)return;!1!==te.video.chatfilter&&t.content_safe&&t.user._id!=z.id()&&(t.content=t.content_safe),p=document.createElement("div"),p.classList.add("chat_message"),p.classList.add("ig_chat_message"),p.setAttribute("data-uid",t.user._id),t.banner&&p.classList.add("chat_banner"),t.banner_img&&p.classList.add("chat_banner_img"),t.system&&p.classList.add("system"),t.announcement&&p.classList.add("announcement"),t.user.supporter&&(p.classList.add("supporterchat"),p.classList.add(`supporterchat_t${t.user.supporter_tier}`)),"admin"===t.user.role&&p.classList.add("adminchat"),"mod"===t.user.role&&p.classList.add("modchat"),t.content.toLowerCase().includes(z.username())&&p.classList.add("pingchat");const n=document.createElement("h1");n.textContent=t.user.username.toUpperCase(),["[SYS]","[CMD]"].includes(t.user.username.toUpperCase())||(n.classList.add("chat_tag"),n.setAttribute("data-id",t.user._id)),p.appendChild(n);const o=document.createElement("p"),i=r(t.content),l=s?t.content:ua(r(t.content),t.user,!0),c=s?t.content:ua(r(t.content),t.user,!1===te.video.emotes_anim);if(i===c?o.textContent=t.content:o.innerHTML=c,t.banner_color&&(o.style.color=t.banner_fgcolor||"#FFF",o.style.backgroundColor=t.banner_color,o.style.borderColor=t.banner_color),p.appendChild(o),t.banner_img){const e=document.createElement("img");e.classList.add("banner_img"),e.setAttribute("src",t.banner_img),p.appendChild(e)}e("room_chat").appendChild(p),e("league_chat").appendChild(p.cloneNode(!0));const d=p.cloneNode(!0);c!==l&&(d.querySelector("p").innerHTML=l),e("ingame_chat").appendChild(d),e("room_chat").children.length>100&&e("room_chat").removeChild(e("room_chat").children[0]),e("ingame_chat").children.length>100&&e("ingame_chat").removeChild(e("ingame_chat").children[0]),e("league_chat").children.length>100&&e("league_chat").removeChild(e("league_chat").children[0]),e("room_chat").scrollTop=e("room_chat").scrollHeight+100,e("ingame_chat").scrollTop=e("ingame_chat").scrollHeight+100,e("league_chat").scrollTop=e("league_chat").scrollHeight+100,t.user._id!==z.id()||!ma(r(t.content))||t.user.supporter||["admin","mod","bot"].includes(t.user.role)||Q({content:'That emote is for supporters only! Consider <a class="chatlink" href="javascript:void();" onclick="SHOW_SUPPORTER_DIALOG();">supporting the sole developer behind TETR.IO</a> to get access to this emote and more. <3',user:{username:"[SYS]",_id:null},system:!0,announcement:!1},!0)}function ee(){document.body.classList.contains("inpair")||(Ze("rsg","3"),Os.play("rsg"),setTimeout((()=>{Ze("rsg","2"),Os.play("rsg")}),500),setTimeout((()=>{Ze("rsg","1"),Os.play("rsg")}),1e3),setTimeout((()=>{Ze("rsg","GO!"),Os.play("rsg_go")}),1500))}function se(t,s,a,n){Os.play("victory"),e("victory_header").innerHTML=n?"WINNERS!":"WINNER!",e("victory_victor").innerHTML=t,e("victory_sub").innerHTML=s,e("victory_also").innerHTML=a,e("victory").classList.remove("hidden"),setTimeout((()=>{e("victory").classList.add("hidden")}),5e3)}function ae(t,s,a,n,o,i,r,l){const c=document.createElement("div");c.classList.add("scroller_block"),c.classList.add("playerresult"),c.classList.add("record_item"),c.setAttribute("data-id",a),c.setAttribute("data-hover","tap"),c.setAttribute("data-hit","click"),s&&c.classList.add("record_first"),l||c.classList.add("disconnected"),n===z.username()&&c.classList.add("record_me"),e("playerresults").appendChild(c);const d=document.createElement("div");d.classList.add("record_grade"),d.classList.add("ns"),d.innerHTML=t,c.appendChild(d);const p=document.createElement("div");p.classList.add("record_owner"),p.innerHTML=n.toUpperCase(),c.appendChild(p);const u=document.createElement("div");u.classList.add("record_ts"),u.innerHTML=r,c.appendChild(u);const m=document.createElement("div");m.classList.add("record_result"),m.innerHTML=o,c.appendChild(m);const g=document.createElement("div");g.classList.add("record_extra"),g.innerHTML=i,c.appendChild(g)}function ne(e,t,s){const a=document.createElement("tr");e.appendChild(a);const n=document.createElement("td");n.innerHTML=t,a.appendChild(n);const o=document.createElement("td");o.innerHTML=s,a.appendChild(o)}function oe(){ct("fetching room listing"),w.get("/api/rooms/").then((e=>{dt(),ie(e.rooms),Ae.bindGuide(Ce[ze]||{})}),(e=>{dt(),S(e)}))}function ie(t){if(holder=e("room_listing_container"),holder.innerHTML="",t.forEach((e=>{const t=document.createElement("div");t.classList.add("scroller_block"),t.classList.add("room_listing_item"),t.classList.add("ns"),t.setAttribute("data-hover","hover"),t.setAttribute("data-hit","confirm"),t.setAttribute("title",e.meta.name),holder.appendChild(t);const s=document.createElement("div");s.classList.add("room_listing_name"),s.textContent=e.meta.name,t.appendChild(s);const a=document.createElement("div");a.classList.add("room_listing_count"),a.innerHTML=`${e.playingplayers}${e.meta.userlimit?`<span class="room_listing_limit">/${e.meta.userlimit}</span>`:""}${e.playercount-e.playingplayers?`<span class="room_listing_spectators">+${e.playercount-e.playingplayers}</span>`:""}`,t.appendChild(a);const n=document.createElement("div");n.classList.add("room_listing_info"),n.innerHTML=`${e.state.toUpperCase()} - <span class="room_listing_id">${e.id}</span>`,t.appendChild(n);const o=document.createElement("div");o.classList.add("room_listing_extra"),o.innerHTML=`anons allowed: <span>${e.meta.allowAnonymous?"YES":"NO"}</span>`,t.appendChild(o),t.addEventListener("click",(()=>{L(e.id)}))})),!t.length){const e=document.createElement("div");e.classList.add("scroller_block"),e.classList.add("nothing"),e.classList.add("ns"),e.innerHTML="NO ROOMS",holder.appendChild(e)}}let re=!1;function le(t){t!==re&&(t?(e("referee").classList.remove("hidden"),e("referee").classList.remove("hiding")):(e("referee").classList.add("hiding"),setTimeout((()=>{e("referee").classList.add("hidden")}),500)),re=t)}function ce(t,s){e("referee").classList.toggle("ft1",1===t.ft&&1===t.wb),e("exit_spectate").classList.toggle("blocked",!f&&(1!==t.ft||1!==t.wb)),e("zen_spectate").classList.toggle("blocked",!f&&(1!==t.ft||1!==t.wb)),e("referee").classList.toggle("duel",2===s.length||s.length>8),e("referee_top").textContent=`${wa||t.gamemode} FT${t.ft}${1!==t.wb?`+${t.wb}`:""}`;let a=-1;const n=[];2===s.length&&s.sort(((e,t)=>e.naturalorder-t.naturalorder)),s.forEach((e=>{if(e.user._id==z.id()){a++;const t=a>=8?i:o[a];n.push(`<div class="referee_point" style="--r: ${t[0]}; --g: ${t[1]}; --b: ${t[2]};"><h1>${e.wins}</h1><p>${e.user.username.toUpperCase()}</p></div>`)}}));let r=!0,l=!0,c=0,d=0;s.forEach((e=>{if(e.user._id==z.id())return;if(!l)return;if(s.length>=8){if(e.wins<d)return void(l=!1);if(c++,d=e.wins,!r)return;r=!1}a++;const t=a>=8?i:o[a];n.push(`<div class="referee_point" style="--r: ${t[0]}; --g: ${t[1]}; --b: ${t[2]};"><h1>${e.wins}</h1><p>${e.user.username.toUpperCase()}</p></div>`)}));let p=n.join('<div class="referee_sep">-</div>');c>1&&(p+=`<div class="referee_sep">+${c-1}</div>`),e("referee_points").innerHTML=p}function de(s,a,n){const o=2===a.length;if(o&&a.sort(((e,t)=>e.naturalorder-t.naturalorder)),e("scoreslide_header").textContent=`${wa||s.gamemode} FT${s.ft}${1!==s.wb?`+${s.wb}`:""}`,e("scoreslide").classList.toggle("duel",o),e("scoreslide").classList.remove("pinged"),e("scoreslide").classList.remove("pingedp1"),e("scoreslide").classList.remove("pingedp2"),o){let o=1,i=0;a[1].user.username===z.username()?(t("#scoreslide_duel_p1 p").innerHTML=a[1].user.username.toUpperCase(),t("#scoreslide_duel_p2 p").innerHTML=a[0].user.username.toUpperCase(),a[1].user.username===n?(o=1,i=a[1].wins,t("#scoreslide_duel_p1 h1").innerHTML=a[1].wins-1,t("#scoreslide_duel_p2 h1").innerHTML=a[0].wins):(o=2,i=a[0].wins,t("#scoreslide_duel_p1 h1").innerHTML=a[1].wins,t("#scoreslide_duel_p2 h1").innerHTML=a[0].wins-1)):(t("#scoreslide_duel_p1 p").innerHTML=a[0].user.username.toUpperCase(),t("#scoreslide_duel_p2 p").innerHTML=a[1].user.username.toUpperCase(),a[0].user.username===n?(o=1,i=a[0].wins,t("#scoreslide_duel_p1 h1").innerHTML=a[0].wins-1,t("#scoreslide_duel_p2 h1").innerHTML=a[1].wins):(o=2,i=a[1].wins,t("#scoreslide_duel_p1 h1").innerHTML=a[0].wins,t("#scoreslide_duel_p2 h1").innerHTML=a[1].wins-1)),document.body.classList.contains("inpair")&&(setTimeout((()=>{e("scoreslide").classList.add("leaguess"),document.body.classList.add("shaking"),Os.play("impact")}),250),setTimeout((()=>{document.body.classList.remove("shaking")}),300),setTimeout((()=>{e("scoreslide").classList.remove("leaguess")}),5e3)),setTimeout((()=>{a[0].wins===a[1].wins&&a[0].wins>=s.ft-1?2===s.wb?(e("scoreslide_duel_match").innerHTML="DEUCE",e("scoreslide_duel_match").classList.add("ssdm_p4"),setTimeout((()=>{document.body.classList.add("shaking"),Os.play("allclear")}),350),setTimeout((()=>{document.body.classList.remove("shaking")}),400)):1===s.wb&&(e("scoreslide_duel_match").innerHTML="TIEBREAKER",e("scoreslide_duel_match").classList.add("ssdm_p3"),setTimeout((()=>{document.body.classList.add("shaking"),Os.play("allclear")}),350),setTimeout((()=>{document.body.classList.remove("shaking")}),400)):a[0].wins>=s.ft-1&&a[0].wins-a[1].wins>=s.wb-1&&a[0].user.username===z.username()||a[1].wins>=s.ft-1&&a[1].wins-a[0].wins>=s.wb-1&&a[1].user.username===z.username()||a[0].wins>=s.ft-1&&a[0].wins-a[1].wins>=s.wb-1&&a[0].user.username!==z.username()&&a[1].user.username!==z.username()?(e("scoreslide_duel_match").innerHTML="MATCH POINT",e("scoreslide_duel_match").classList.add("ssdm_p1")):(a[0].wins>=s.ft-1&&a[0].wins-a[1].wins>=s.wb-1&&a[0].user.username!==z.username()||a[1].wins>=s.ft-1&&a[1].wins-a[0].wins>=s.wb-1&&a[1].user.username!==z.username()||a[1].wins>=s.ft-1&&a[1].wins-a[0].wins>=s.wb-1&&a[0].user.username!==z.username()&&a[1].user.username!==z.username())&&(e("scoreslide_duel_match").innerHTML="MATCH POINT",e("scoreslide_duel_match").classList.add("ssdm_p2"))}),1500),setTimeout((()=>{e("scoreslide_duel_match").classList.remove("ssdm_p1"),e("scoreslide_duel_match").classList.remove("ssdm_p2"),e("scoreslide_duel_match").classList.remove("ssdm_p3"),e("scoreslide_duel_match").classList.remove("ssdm_p4")}),5e3),setTimeout((()=>{Os.play("showscore"),e("scoreslide").classList.add(`pingedp${o}`),t(`#scoreslide_duel_p${o} h1`).innerHTML=i,xn.play("scoreslide_ultra",{right:1!==o})}),1500)}else{let t=0,s="";a.forEach((a=>{a.user.username===n&&(t=a.wins,e("scoreslide_leader_name").innerHTML=a.user.username.toUpperCase(),e("scoreslide_leader_points").innerHTML=a.wins-1),s+=`<div class="scoreslide_player"><p>${a.user.username.toUpperCase()}</p><h1>${a.wins}</h1></div>`})),e("scoreslide_list").innerHTML=s,setTimeout((()=>{Os.play("showscore"),e("scoreslide").classList.add("pinged"),e("scoreslide_leader_points").innerHTML=t}),1500)}e("scoreslide").classList.remove("hidden"),Os.play("scoreslide_in"),setTimeout((()=>{e("scoreslide").classList.remove("hiding")}),20),setTimeout((()=>{e("scoreslide").classList.add("hiding"),Os.play("scoreslide_out")}),4e3),setTimeout((()=>{e("scoreslide").classList.add("hidden")}),5e3)}function pe(){ct("entering matchmaking"),ga.emit("entermatchmaking")}function ue(){ct("leaving matchmaking"),ga.emit("leavematchmaking")}function me(){ct("getting ready to spectate"),ga.emit("midgamespectate")}function ge(t,s){const a=Ne;let n=0,o=setInterval((()=>{let i=Math.round(An(a,t,n,BezierEasing(.74,.03,.09,.97))-a);e("leaguestanding_rating").innerHTML=`${Math.round(An(a,t,n,BezierEasing(.74,.03,.09,.97)))}<span>TR</span>${-1!==a?` <span class="leaguechange">${0===i?"":i>=150?"":i>0?"":i<=-150?"":""}${Math.abs(i)}</span>`:""}`,n+=1/s,n>=1&&(i=Math.round(t-a),e("leaguestanding_rating").innerHTML=`${t}<span>TR</span>${-1!==a?` <span class="leaguechange">${0===i?"":i>=150?"":i>0?"":i<=-150?"":""}${Math.abs(i)}</span>`:""}`,clearInterval(o),Ne=t)}),16)}function he(){e("leaguestanding_rating").innerHTML=`${Ne}<span>TR</span> <span class="leaguechange">0</span>`}function _e(t,s){const a=Ue;let n=0,o=setInterval((()=>{let i=Math.round(a-An(a,t,n,BezierEasing(.74,.03,.09,.97)));e("leaguestanding_placement").innerHTML=`#<span>${Math.round(An(a,t,n,BezierEasing(.74,.03,.09,.97)))}</span>`,e("leaguestanding_placement").classList.toggle("t100",Math.round(An(a,t,n,BezierEasing(.74,.03,.09,.97)))<=100&&Math.round(An(a,t,n,BezierEasing(.74,.03,.09,.97)))>10),e("leaguestanding_placement").classList.toggle("t10",Math.round(An(a,t,n,BezierEasing(.74,.03,.09,.97)))<=10&&Math.round(An(a,t,n,BezierEasing(.74,.03,.09,.97)))>1),e("leaguestanding_placement").classList.toggle("t1",1===Math.round(An(a,t,n,BezierEasing(.74,.03,.09,.97)))),e("leaguestanding_placement_change").innerHTML=-1!==a?`${0===i?"":i>=10?"":i>0?"":i<=-10?"":""}${Math.abs(i)}</span>`:"",n+=1/s,n>=1&&(i=Math.round(a-t),e("leaguestanding_placement").innerHTML=`#<span>${t}</span>`,e("leaguestanding_placement").classList.toggle("t100",t<=100&&t>10),e("leaguestanding_placement").classList.toggle("t10",t<=10&&t>1),e("leaguestanding_placement").classList.toggle("t1",1===t),e("leaguestanding_placement_change").innerHTML=-1!==a?`${0===i?"":i>=10?"":i>0?"":i<=-10?"":""}${Math.abs(i)}</span>`:"",clearInterval(o),Ue=t)}),16)}function be(){e("leaguestanding_placement_change").innerHTML="0"}const ye=["z","d","d+","c-","c","c+","b-","b","b+","a-","a","a+","s-","s","s+","ss","u","x"];function ve(t){const s=Fe;if(s===t)return void(e("leaguestanding_rank").src=`/res/league-ranks/${t}.png`);const a=ye.indexOf(s);ye.indexOf(t)>a?(e("leaguestanding_rank").classList.add("rankraise"),setTimeout((()=>{Os.play("rankraise")}),400),setTimeout((()=>{document.body.classList.add("shaking")}),1800),setTimeout((()=>{document.body.classList.remove("shaking")}),1900)):(setTimeout((()=>{Os.play("ranklower")}),400),e("leaguestanding_rank").classList.add("ranklower")),setTimeout((()=>{e("leaguestanding_rank").src=`/res/league-ranks/${t}.png`}),1050),setTimeout((()=>{e("leaguestanding_rank").classList.remove("rankraise"),e("leaguestanding_rank").classList.remove("ranklower")}),4500),Fe=t}function we(t){Fe!==t||(e("leaguestanding_rank").src=`/res/league-ranks/${t}.png`)}function ke(e){let t=[];for(let s=0;s<e.events.length;s++)"full"===e.events[s].type&&0!==e.events[s].frame||t.push(e.events[s]);return e.events=t,e}return{createRoom:k,joinRoom:L,leaveRoom:E,sendChatMessage:H,startRoom:$,switchBracket:F,switchBracketHost:U,saveRoomConfig:M,setRoomID:C,loadListing:oe,kickUser:O,unbanUser:P,transferOwnership:B,takeOwnership:X,enterMatchmaking:pe,leaveMatchmaking:ue,startMidgameSpectate:me,dropMultiplex:()=>{e("spectate").classList.add("hidden"),document.body.classList.remove("multiplexed"),document.body.classList.remove("inmulti"),document.body.classList.remove("spectating"),document.body.classList.remove("room_spectating"),document.body.classList.remove("room_midgame_spectating"),document.body.classList.remove("inpair"),Ps.stop(),le(!1),la.enabled(!1),la.stopTimer(),e("leaveroom").classList.remove("hidden"),st(!0),fa=!1},showAnnouncement:e=>{Q({content:e,user:{username:"[SYS]",_id:null},system:!1,announcement:!0})},returnToRoom:()=>{c="lobby",yn("online",c,"private"===l.type?"X-PRIV":l.id)},isInRoom:()=>d,getRoomUsernames:(e="")=>l.players.map((e=>e.username)).filter((t=>t.startsWith(e)))}})(),La={test:e=>({pri:"#34F479",sec:"#000",img_main:"https://tetr.io/user-content/avatars/5e331c3ce24a5a3e258f7a1b.jpg?rv=1601325213424",img_sub:null,header:"Test notification",content:e.data.message,action:null}),announcement:e=>({pri:e.data.pri||"#87E038",sec:e.data.sec||"#000",img_main:e.data.img_main||"/res/icon/announcement.svg",img_sub:e.data.img_sub||null,header:e.data.header,content:e.data.content,action:e.data.action||null}),supporter_new:e=>({pri:"#FF4A19",sec:"#000",img_main:"/res/supporter-icon.png",img_sub:null,header:"You are now a TETR.IO Supporter!",content:"Thank you very, <b>very</b> much for supporting TETR.IO. Without support from people like you, TETR.IO could never be what it is now! You're awesome ",action:null}),supporter_gift:e=>({pri:"#FF4A19",sec:"#FF4A19",img_main:e.data.avatar_revision?`/user-content/avatars/${e.data.userid}.jpg?rv=${e.data.avatar_revision}`:u(e.data.userid),img_sub:"/res/supporter-icon-alpha.png",header:`<span>${e.data.username.toUpperCase()}</span>`,content:`has gifted you <b>${e.data.months} month${1===e.data.months?"":"s"}</b> of <b>TETR.IO Supporter</b>!`,action:`user:${e.data.userid}`}),supporter_specialthanks:e=>({pri:"#E43868",sec:"#000",img_main:"/res/heart-icon.png",img_sub:null,header:"YOU ARE AWESOME!",content:"Thank you very, <b>very</b> much for your insane amount of support. You are now <b>listed in the Special Thanks of the game itself</b>, as thanks for your support!",action:null}),supporter_expiring:e=>({pri:"#A4523C",sec:"#000",img_main:"/res/supporter-icon-expiring.png",img_sub:null,header:"Your TETR.IO Supporter status is expiring soon!",content:`Thank you very much for your support. Your Supporter status will expire on <b>${new Date(e.data.expires).toLocaleString()}</b>. To continue supporting TETR.IO, please click here to add months.`,action:"support"}),supporter_expired:e=>({pri:"#888888",sec:"#000",img_main:"/res/supporter-icon-expired.png",img_sub:null,header:"Your TETR.IO Supporter status has expired",content:"Your Supporter status may have expired, but you'll forever be in my heart. If you wish to support TETR.IO again, you may click here to rejoin.",action:"support"}),friend:e=>{const t=e.data.relationship.from;return{pri:e.data.ismutual?"#E05DC3":"#E43868",sec:e.data.ismutual?"#E05DC3":"#E43868",img_main:t.avatar_revision?`/user-content/avatars/${t._id}.jpg?rv=${t.avatar_revision}`:u(t._id),img_sub:"/res/icon/friends.svg",header:`<span>${t.username.toUpperCase()}</span>`,content:e.data.ismutual?"has <b>friended you back</b>":"has added you to their <b>friends list</b>",action:`user:${t._id}`}}},Ea={test:e=>{x({header:"Test notification",msg:e.data.message,color:"#34F479",icon:"https://tetr.io/user-content/avatars/5e331c3ce24a5a3e258f7a1b.jpg?rv=1601325213424",classes:["snotify"],timeout:1e4,suppressable:!0}),"both"!==te.notifications.other||Ln()||Dt("Test notification",e.data.message,!1,"/res/tetriox256.png"),Ln()||Os.play("social_notify_major")},announcement:e=>{if(e.data.isinvite){if(kn())return;x({header:e.data.header,msg:`${e.data.content}<div class="notification_timeoutbar" style="--time: 24s;"></div>`,color:e.data.pri||"#87E038",subcolor:e.data.sec||"#000",icon:e.data.img_main||"/res/icon/announcement.svg",subicon:e.data.img_sub||null,classes:["snotify","modalnotify"],timeout:25e3,onclick:e=>{},buttons:[{label:"IGNORE",icon:"/res/icon/denied.svg",classes:[],onclick:e=>{e()}},{label:e.data.cta||"ACCEPT",icon:"/res/icon/accepted.svg",classes:["pri"],onclick:t=>{e.data.action&&nn(e.data.action),t()}}]})}else x({header:e.data.header,msg:e.data.content,color:e.data.pri||"#87E038",subcolor:e.data.sec||"#000",icon:e.data.img_main||"/res/icon/announcement.svg",subicon:e.data.img_sub||null,classes:["snotify"],timeout:15e3,onclick:t=>{e.data.action&&nn(e.data.action),t()}});"both"===te.notifications.other&&Dt(e.data.header,e.data.content,!1,e.data.img_main||"/res/tetriox256.png"),Os.play("social_notify_major")},supporter_new:e=>{x({header:"You are now a TETR.IO Supporter!",msg:"Thank you very, <b>very</b> much for supporting TETR.IO. Without support from people like you, TETR.IO could never be what it is now! You're awesome ",color:"#FF4A19",icon:"/res/supporter-icon.png",classes:["snotify"],timeout:3e4}),document.body.classList.add("supporter"),document.body.classList.add("ceriad_exempt"),document.body.classList.add("ceriad_disabled"),X.unmountAll(),localStorage.setItem("wasLastSupporter","Yes, that's it!"),document.cookie="ceriad_exempt=1;max-age=31536000;domain=tetr.io","both"===te.notifications.other&&Dt("You are now a TETR.IO Supporter!","Thank you very, very much for supporting TETR.IO. Without support from people like you, TETR.IO could never be what it is now! You're awesome ",!1,"/res/supporter-icon.png")},supporter_gift:e=>{x({header:`<span>${e.data.username.toUpperCase()}</span>`,msg:`has gifted you <b>${e.data.months} month${1===e.data.months?"":"s"}</b> of <b>TETR.IO Supporter</b>!`,color:"#FF4A19",subcolor:"#FF4A19",icon:e.data.avatar_revision?`/user-content/avatars/${e.data.userid}.jpg?rv=${e.data.avatar_revision}`:u(e.data.userid),subicon:"/res/supporter-icon-alpha.png",classes:["snotify"],timeout:3e4,onclick:t=>{nn(`user:${e.data.userid}`),t()}}),Os.play("supporter"),document.body.classList.add("supporter"),document.body.classList.add("ceriad_exempt"),X.unmountAll(),document.body.classList.add("ceriad_disabled"),localStorage.setItem("wasLastSupporter","Yes, that's it!"),document.cookie="ceriad_exempt=1;max-age=31536000;domain=tetr.io",kt.expires=kt.hasSupporter?kt.expires+1e3*e.data.months*3600*24*30.5:Date.now()+1e3*e.data.months*3600*24*30.5,kt.hasSupporter=kt.expires>Date.now(),Tt(),"both"===te.notifications.other&&Dt(e.data.username.toUpperCase(),`has gifted you ${e.data.months} month${1===e.data.months?"":"s"} of TETR.IO Supporter!`,!1,e.data.avatar_revision?`/user-content/avatars/${e.data.userid}.jpg?rv=${e.data.avatar_revision}`:"/res/tetriox256.png")},supporter_specialthanks:e=>{x({header:"YOU ARE AWESOME!",msg:"Thank you very, <b>very</b> much for your insane amount of support. You are now <b>listed in the Special Thanks of the game itself</b>, as thanks for your support!",color:"#E43868",icon:"/res/heart-icon.png",classes:["snotify"],timeout:3e4}),"both"===te.notifications.other&&Dt("YOU ARE AWESOME!","Thank you very, very much for your insane amount of support. You are now listed in the Special Thanks of the game itself, as thanks for your support!",!1,"/res/heart-icon.png")},supporter_expiring:e=>{x({header:"Your TETR.IO Supporter status is expiring soon!",msg:`Thank you very much for your support. Your Supporter status will expire on <b>${new Date(e.data.expires).toLocaleString()}</b>. To continue supporting TETR.IO, please click here to add months.`,color:"#A4523C",icon:"/res/supporter-icon-expiring.png",classes:["snotify"],timeout:3e4,onclick:e=>{nn("support"),e()}}),"both"===te.notifications.other&&Dt("Your TETR.IO Supporter status is expiring soon!",`Thank you very much for your support. Your Supporter status will expire on ${new Date(e.data.expires).toLocaleString()}. To continue supporting TETR.IO, please click here to add months.`,!1,"/res/supporter-icon-expiring.png")},supporter_expired:e=>{x({header:"Your TETR.IO Supporter status has expired",msg:"Your Supporter status may have expired, but you'll forever be in my heart. If you wish to support TETR.IO again, you may click here to rejoin.",color:"#888888",icon:"/res/supporter-icon-expired.png",classes:["snotify"],timeout:3e4,onclick:e=>{nn("support"),e()}}),"both"===te.notifications.other&&Dt("Your TETR.IO Supporter status has expired","Your Supporter status may have expired, but you'll forever be in my heart. If you wish to support TETR.IO again, you may click here to rejoin.",!1,"/res/supporter-icon-expired.png")},friend:e=>{const t=e.data.relationship.from;x({header:`<span>${t.username.toUpperCase()}</span>`,msg:e.data.ismutual?"has <b>friended you back</b>":"has added you to their <b>friends list</b>",color:e.data.ismutual?"#E05DC3":"#E43868",subcolor:e.data.ismutual?"#E05DC3":"#E43868",icon:t.avatar_revision?`/user-content/avatars/${t._id}.jpg?rv=${t.avatar_revision}`:u(t._id),subicon:"/res/icon/friends.svg",classes:["snotify"],timeout:1e4,onclick:e=>{nn(`user:${t._id}`),e()},suppressable:!0}),"both"!==te.notifications.other||Ln()||Dt(t.username.toUpperCase(),e.data.ismutual?"has friended you back":"has added you to their friends list",!1,t.avatar_revision?`/user-content/avatars/${t._id}.jpg?rv=${t.avatar_revision}`:"/res/tetriox256.png"),Ln()||Os.play("social_notify_minor")}},xa={online:(e,t,s)=>[e,t,s],away:(e,t,s)=>["online","away"].includes(e)?["away","",""]:[e,t,s],busy:(e,t,s)=>["online","away","busy"].includes(e)?["busy","",""]:[e,t,s],offline:(e,t,s)=>["offline","",""]},Ta={online:(e,t)=>{switch(e){case"menus":return{text:"In Menus",html:"In Menus",discord:{state:"In Menus",largeImageKey:"logo",instance:!1}};case"40l":return{text:"Playing 40 LINES",html:"Playing <b>40 LINES</b>",discord:{state:"40 LINES",largeImageKey:"logo",smallImageKey:"mode_40l",smallImageText:"40 LINES",startTimestamp:Date.now(),instance:!0}};case"blitz":return{text:"Playing BLITZ",html:"Playing <b>BLITZ</b>",discord:{state:"BLITZ",largeImageKey:"logo",smallImageKey:"mode_blitz",smallImageText:"BLITZ",startTimestamp:Date.now(),instance:!0}};case"zen":return{text:"Playing ZEN",html:"Playing <b>ZEN</b>",discord:{state:"ZEN",largeImageKey:"logo",smallImageKey:"mode_zen",smallImageText:"ZEN",startTimestamp:Date.now(),instance:!0}};case"custom":return{text:"Playing a custom game",html:"Playing a <b>custom game</b>",discord:{state:"CUSTOM GAME",largeImageKey:"logo",smallImageKey:"mode_custom",smallImageText:"CUSTOM GAME",startTimestamp:Date.now(),instance:!0}};case"lobby_end":case"lobby_spec":case"lobby_ig":case"lobby":{let s="In",a="In Lobby";"lobby_spec"===e&&(s="Spectating",a="Spectating"),"lobby_end"===e&&(s="Ending",a="Game Ending"),"lobby_ig"===e&&(a="In Game");let n="a custom room",o="an <b>online</b>";""!==t&&(n="a public custom room",o="a public <b>custom room</b>"),"X-PRIV"===t&&(n="a private custom room",o="a private <b>custom room</b>"),"X-QP"===t&&(n="a QUICK PLAY",o="a <b>QUICK PLAY</b>");let i="game";"lobby"===e&&(i="lobby");const r={details:"X-QP"===t?"QUICK PLAY":"CUSTOM ROOM",state:a,largeImageKey:"logo",smallImageKey:"X-QP"===t?"mode_quickplay":"mode_customroom",smallImageText:"X-QP"===t?"QUICK PLAY":"CUSTOM ROOM",instance:!1};return["lobby_spec","lobby_ig"].includes(e)&&(r.startTimestamp=Date.now(),r.instance=!0),{text:`${s} ${n} ${i}`,html:`${s} ${o} ${i}`,discord:r}}default:return{text:"Online",html:"Online",discord:{state:"Online",largeImageKey:"logo",instance:!1}}}},away:(e,t)=>({text:"Idle",html:"Idle",discord:{state:"Idle",largeImageKey:"logo",instance:!1}}),busy:(e,t)=>{switch(e){case"tl_mm":return{text:"In TETRA LEAGUE queue",html:"In <b>TETRA LEAGUE</b> queue",discord:{details:"TETRA LEAGUE",state:"In Queue",largeImageKey:"logo",smallImageKey:"mode_league",smallImageText:"TETRA LEAGUE",instance:!1}};case"tl":return{text:"In a TETRA LEAGUE game",html:"In a <b>TETRA LEAGUE</b> game",discord:{details:"TETRA LEAGUE",state:"In Game",largeImageKey:"logo",smallImageKey:"mode_league",smallImageText:"TETRA LEAGUE",startTimestamp:Date.now(),instance:!0}};case"tl_end":return{text:"Ending a TETRA LEAGUE game",html:"Ending a <b>TETRA LEAGUE</b> game",discord:{details:"TETRA LEAGUE",state:"Game Ending",largeImageKey:"logo",smallImageKey:"mode_league",smallImageText:"TETRA LEAGUE",instance:!1}};case"tl_mm_complete":return{text:"Found a TETRA LEAGUE match",html:"Found a <b>TETRA LEAGUE</b> match",discord:{details:"TETRA LEAGUE",state:"Match Found",largeImageKey:"logo",smallImageKey:"mode_league",smallImageText:"TETRA LEAGUE",instance:!1}};default:return{text:"Busy",html:"Busy",discord:{state:"Busy",largeImageKey:"logo",instance:!1}}}},offline:(e,t)=>({text:"Offline",html:"Offline",discord:{state:"Offline",largeImageKey:"logo",instance:!1}})},Ia=["5e32fe50d3e20d2bd2bf234f","5e3324299380f13edda2b1b1","5e3361351da5014141c84788","5e342a67f3cfa44539619a85","5e41118d4be6907ad7eab8b2","5e504fe2278d291d983fd847","5eeaa5535b5c156c224f5265","5e49a95efad3ca55f6512742","5e98b21e77ea8f7e30009287","5e7679c65bc0c31aba22746d"],Sa={total_online:0,notifications:[],relationships:[],presence:{status:"offline",realstatus:"offline",detail:"",realdetail:"",mask:"online",last:null},dms:{}};void 0!==localStorage.getItem("presenceMask")&&["online","away","busy","offline"].includes(localStorage.getItem("presenceMask"))&&(Sa.presence.mask=localStorage.getItem("presenceMask"));const Ma=new Map;function Aa(e){const t=()=>{ka.isInRoom()&&(ka.leaveRoom(!0),ha&&ha.games.others.forEach((e=>{e.game.end()})),ka.dropMultiplex()),Ut.stopNow(),at(),ct("connecting to live servers"),ga.require().then((t=>{dt(),et("playmulti"),st(!0),t.maintenance&&document.body.classList.add("maintenance"),ka.joinRoom(e),Ut.stopNow()})).catch((e=>{dt(),T("could not connect to live servers")}))};document.body.classList.contains("ingame_phys")?D({title:"LEAVE CURRENT GAME?",msg:"you're still in game. abandon the current game?",buttons:[{label:"CANCEL",classes:[],callback:e=>{e()}},{label:"LEAVE",classes:["sec"],callback:e=>{e(),t()}}]}):t()}U.ready((function(s){e("social_tray").addEventListener("click",(function(e){Oa()})),e("social").addEventListener("click",(function(t){t.target===e("social")&&Pa()})),e("social_relationships_tabs").addEventListener("click",(function(t){t.target.classList.contains("social_relationships_tab")&&(e("social_relationships_find").value="",setTimeout((()=>{un(),Ua()}),0))})),e("social_relationships_find").addEventListener("keyup",(function(t){e("sbcpw").scrollTop=0,un(),e("social_relationships_find").value&&Ua()})),e("social_back").addEventListener("click",(function(e){Ua()})),e("social_status").addEventListener("click",(function(e){ot([{id:"online",name:'<img style="height: 0.88em; vertical-align: middle;" src="/res/status/online.png" /> ONLINE',description:"appear as usual"},{id:"away",name:'<img style="height: 0.88em; vertical-align: middle;" src="/res/status/away.png" /> IDLE',description:"appear idle, unless you're offline or busy"},{id:"busy",name:'<img style="height: 0.88em; vertical-align: middle;" src="/res/status/busy.png" /> BUSY',description:"appear busy, unless you're offline. receive no notifications. always enabled in TETRA LEAGUE (unless you're invisible)"},{id:"offline",name:'<img style="height: 0.88em; vertical-align: middle;" src="/res/status/offline.png" /> INVISIBLE',description:"appear offline at all times"}],(e=>{localStorage.setItem("presenceMask",e),yn(Sa.presence.realstatus,Sa.presence.realdetail.split(":")[0],Sa.presence.realdetail.split(":")[1],e)}),!0)})),e("social_dm_button_profile").addEventListener("click",(function(e){Na||Ua(),Ns({userID:Na.to._id})})),e("social_dm_button_gift").addEventListener("click",(function(e){Na||Ua(),Ke(void 0,Na.to.username)})),e("social_dm_button_invite").addEventListener("click",(function(t){Na||Ua(),e("social_dm_button_invite").classList.contains("active")||(ka.isInRoom()&&e(`sp_${Na.to._id}`)?T("this person is already in your room"):(ga&&ga.isConnected()&&ga.emit("social.invite",Na.to._id),Na.inv_locked_until=Date.now()+3e4,bn()))})),e("social_dm_button_snipe").addEventListener("click",(function(t){Na||Ua(),e("social_dm_button_snipe").classList.contains("active")||(ka.isInRoom()&&e(`sp_${Na.to._id}`)?T("you are already in their room"):(Na.presence.detail.split(":")[1]&&(Aa(Na.presence.detail.split(":")[1]),Pa()),bn()))})),e("social_dm_input").addEventListener("keydown",ja),e("social_chat").addEventListener("mouseover",(function(e){let t=e.target;(t.classList.contains("dm_chat_message")||(t=t.closest(".dm_chat_message"),t))&&t.getAttribute("data-ts")&&t.setAttribute("data-time",`${n(Date.parse(t.getAttribute("data-ts")))} ago`)})),ga.on("authorize",(e=>{Sa.total_online=e.social.total_online,Sa.notifications=e.social.notifications,Sa.relationships=e.social.relationships,Sa.dms={};const t=[],s=[];let a=null;if(Sa.relationships.forEach((n=>{e.social.presences[n.to._id]?(n.presence=e.social.presences[n.to._id],["offline","unknown"].includes(n.presence.status)||(t.push(n.to.username.toUpperCase()),a=n.to._id,n.to.avatar_revision&&s.push({id:n.to._id,avatar_revision:n.to.avatar_revision}))):n.presence={status:"offline",detail:"",invitable:!1}})),ga.emit("social.presence",{status:Sa.presence.status,detail:Sa.presence.detail}),t.length){const e=x({header:`<span>${t.slice(0,10).join("</span>, <span>")}</span>${t.length>10?` and ${t.length-10} more`:""}`,msg:'<img src="/res/status/online.png" style="height: 1em; vertical-align: -10%;" /> online now',color:pn.online,icon:s.length?`/user-content/avatars/${s[0].id}.jpg?rv=${s[0].avatar_revision}`:u(a),classes:["snotify"],timeout:5e3,onclick:e=>{e(),Oa()},suppressable:!0});for(let t=1;t<Math.min(s.length,5);t++)setTimeout((()=>{e.parentNode&&(e.querySelector(".notification_icon").src=`/user-content/avatars/${s[t].id}.jpg?rv=${s[t].avatar_revision}`)}),5e3/Math.min(s.length,5)*t)}$a&&(un(),Ja(),Va(),Ua()),tn(),Qa(),en()})),ga.on("social.online",(e=>{Sa.total_online=e,$a&&Va()})),ga.on("social.notification",(e=>{e.data.fake||(Sa.notifications.unshift(e),$a&&Ja(),Qa()),Ea[e.type]&&Ea[e.type](e)})),ga.on("social.relationships.add",(e=>{e.presence={status:"offline",detail:"",invitable:!1},Sa.relationships.push(e),$a&&un(),en(),tn()})),ga.on("social.relationships.remove",(e=>{Sa.relationships=Sa.relationships.filter((t=>t._id!==e)),$a&&un(),en(),tn(),Da&&Na._id===e&&Ua()})),ga.on("social.relationships.removepending",(e=>{Sa.relationships=Sa.relationships.filter((e=>"pending"!==e.type)),$a&&un(),en(),Da&&"pending"===Na.type&&Ua()})),ga.on("social.relationships.update",(e=>{Sa.relationships.forEach((t=>{t.to._id===e.user&&(t.to.username=e.username,t.to.avatar_revision=e.avatar_revision)})),ln=!0,$a&&(un(),Da&&Na.to._id===e.user&&Xa())})),ga.on("social.presence",(t=>{let s=null;Sa.relationships.forEach((a=>{a.to._id===t.user&&(["offline","unknown"].includes(a.presence.status)&&!["offline","unknown"].includes(t.presence.status)?(!a.silenced_until||a.silenced_until<Date.now())&&(a.silenced_until=Date.now()+3e5,"off"!==te.notifications.online&&(x({header:`<span>${a.to.username.toUpperCase()}</span>`,msg:`<img src="/res/status/${t.presence.status}.png" style="height: 1em; vertical-align: -10%;" /> has come online`,color:pn[t.presence.status],icon:a.to.avatar_revision?`/user-content/avatars/${a.to._id}.jpg?rv=${a.to.avatar_revision}`:u(a.to._id),classes:["snotify"],timeout:5e3,onclick:e=>{e(),Fa(a)},suppressable:!0}),Ln()||Os.play("social_online",.7)),"both"!==te.notifications.online||Ln()||Dt(a.to.username.toUpperCase(),"has come online",!1,a.to.avatar_revision?`/user-content/avatars/${a.to._id}.jpg?rv=${a.to.avatar_revision}`:"/res/tetriox256.png")):["offline","unknown"].includes(t.presence.status)&&!["offline","unknown"].includes(a.presence.status)&&(!a.silenced_until||a.silenced_until<Date.now())&&(a.silenced_until=Date.now()+3e5,"off"!==te.notifications.offline&&(x({header:`<span>${a.to.username.toUpperCase()}</span>`,msg:'<img src="/res/status/offline.png" style="height: 1em; vertical-align: -10%;" /> has gone offline',color:pn.offline,icon:a.to.avatar_revision?`/user-content/avatars/${a.to._id}.jpg?rv=${a.to.avatar_revision}`:u(a.to._id),classes:["snotify"],timeout:5e3,onclick:e=>{e(),Fa(a)},suppressable:!0}),Ln()||Os.play("social_offline",.7)),"both"!==te.notifications.offline||Ln()||Dt(a.to.username.toUpperCase(),"has gone offline",!1,a.to.avatar_revision?`/user-content/avatars/${a.to._id}.jpg?rv=${a.to.avatar_revision}`:"/res/tetriox256.png")),a.presence=t.presence,Da&&Na._id===a._id&&["offline","unknown"].includes(t.presence.status)&&e("social_relationships_tabs_online").classList.contains("active")&&(e("social_relationships_tabs_online").classList.remove("active"),e("social_relationships_tabs_friends").classList.add("active"),s=a._id))})),$a&&(un(),Xa(),null!==s&&e(`social_relationship_${s}`)&&setTimeout((()=>{e(`social_relationship_${s}`)&&e(`social_relationship_${s}`).scrollIntoView({behavior:"smooth",block:"center",inline:"start"})}),50)),tn()})),ga.on("social.dm",(e=>{const t=e.stream.replace(z.id(),"").replace(":","");void 0!==Sa.dms[t]&&(Sa.dms[t].push(e),Sa.dms[t].length>250&&Sa.dms[t].shift(),$a&&Da&&Na.to._id===t&&za()),e.data.user===z.id()||$a&&Da&&Na.to._id===t&&!document.body.classList.contains("nofocus")?$a&&Da&&Na&&an(Na):(Sa.relationships.forEach((s=>{if(s.to._id!==t)return;$a&&Da&&Na.to._id===t?an(s,!0):s.unread++;let a={};a=e.data.user===s.to._id?{username:s.to.username,_id:s.to._id,...e.data.userdata||{}}:{username:e.data.user,_id:null,...e.data.userdata||{}};let n=e.data.content;if(!1!==te.video.chatfilter&&e.data.content_safe&&(n=e.data.content_safe),"off"===("friend"===s.type?te.notifications.dm:te.notifications.dm_pending)||kn()||(x({header:`<span>${s.to.username.toUpperCase()}</span>`,msg:ua(r(n),a,!1===te.video.emotes_anim),color:"#A2CEE8",icon:s.to.avatar_revision?`/user-content/avatars/${s.to._id}.jpg?rv=${s.to.avatar_revision}`:u(s.to._id),subcolor:"#000",subicon:"/res/icon/message-bw.svg",classes:["snotify","snotifydm"],timeout:5e3,onclick:e=>{e(),Fa(s)}}),Os.play("social_dm")),"both"===("friend"===s.type?te.notifications.dm:te.notifications.dm_pending)&&!kn()){let e=n;if(Ma.get(s.to._id)){for(Ma.get(s.to._id).push(n);Ma.get(s.to._id).length>4;)Ma.get(s.to._id).shift();e=Ma.get(s.to._id).join("\n")}else Ma.set(s.to._id,[n]);Dt(s.to.username.toUpperCase(),e,!1,s.to.avatar_revision?`/user-content/avatars/${s.to._id}.jpg?rv=${s.to.avatar_revision}`:"/res/tetriox256.png",s.to._id,(()=>{Fa(s)}))}})),$a&&un()),en()})),ga.on("social.invite",(e=>{kn()||Sa.relationships.forEach((t=>{t.to._id===e.sender&&(x({header:`<span>${t.to.username.toUpperCase()}</span>`,msg:`invited you to <b>${r(e.roomname)}</b><div class="notification_timeoutbar" style="--time: 24s;"></div>`,color:"#FF008A",icon:t.to.avatar_revision?`/user-content/avatars/${t.to._id}.jpg?rv=${t.to.avatar_revision}`:u(t.to._id),subcolor:"#FF008A",subicon:"/res/icon/invite.svg",classes:["snotify","modalnotify"],timeout:25e3,onclick:e=>{},buttons:[{label:"IGNORE",icon:"/res/icon/denied.svg",classes:[],onclick:e=>{e()}},{label:"ACCEPT",icon:"/res/icon/accepted.svg",classes:["pri"],onclick:t=>{if("busy"===Sa.presence.realstatus)return T("you cannot accept this invite now"),void t();Aa(e.roomid),t()}}]}),Os.play("social_invite"),"both"===te.notifications.invite&&Dt(t.to.username.toUpperCase(),`invited you to "${e.roomname}"`,!1,t.to.avatar_revision?`/user-content/avatars/${t.to._id}.jpg?rv=${t.to.avatar_revision}`:"/res/tetriox256.png"))}))})),document.addEventListener("keydown",o,!1),document.addEventListener("gpdown",o,!1);let a=0;function o(e){Object.keys(ae).forEach((s=>{if(ae[s].includes(me(e)||e.detail.toUpperCase())){let n=!1;if(["social_relationships_find","social_dm_input"].includes(document.activeElement.id)&&"BACKSPACE"!==me(e)&&(n=!0),!n&&["input","textarea"].includes(document.activeElement.tagName.toLowerCase()))return;if("menuDown"===s){if($a&&!Da){if(t(".social_relationship.focus")){const e=t(".social_relationship.focus");e.nextElementSibling?(e.classList.remove("focus"),e.nextElementSibling.classList.add("focus"),e.nextElementSibling.scrollIntoView({behavior:"auto",block:"center",inline:"start"})):(e.classList.remove("focus"),e.parentElement.firstElementChild.classList.add("focus"),e.parentElement.firstElementChild.scrollIntoView({behavior:"auto",block:"center",inline:"start"}))}["DOWN","ARROWDOWN"].includes(me(e))&&(e.stopPropagation(),e.preventDefault())}}else if("menuUp"===s&&$a&&!Da){if(t(".social_relationship.focus")){const e=t(".social_relationship.focus");e.previousElementSibling?(e.classList.remove("focus"),e.previousElementSibling.classList.add("focus"),e.previousElementSibling.scrollIntoView({behavior:"auto",block:"center",inline:"start"})):(e.classList.remove("focus"),e.parentElement.lastElementChild.classList.add("focus"),e.parentElement.lastElementChild.scrollIntoView({behavior:"auto",block:"center",inline:"start"}))}["UP","ARROWUP"].includes(me(e))&&(e.stopPropagation(),e.preventDefault())}if(e.repeat)return;"openSocial"===s?($a?Pa():Oa(),e.stopPropagation(),e.preventDefault()):"menuBack"===s||"ESCAPE"===me(e)?$a&&("social_dm_input"===document.activeElement.id?(a=Date.now()+50,Ua()):a<Date.now()&&Pa(),e.stopPropagation(),e.preventDefault()):"menuConfirm"===s&&$a&&!Da&&t(".social_relationship.focus")&&t(".social_relationship.focus").click()}}))}}));let Ca=null,Ra=null,Ha=0,$a=!1;function Oa(){$a||z.anon()||(Ca&&(clearTimeout(Ca),Ca=null),Ra&&clearInterval(Ra),Ya(),e("social").classList.remove("hidden"),e("social").getBoundingClientRect(),e("social").classList.remove("hiding"),e("social_relationships_find").value="",e("sbcpw").scrollTop=-200,e("social_relationships_tabs_online").classList.contains("active")&&0===Sa.relationships.filter((e=>["online","away","busy"].includes(e.presence.status)&&"friend"===e.type)).length&&(e("social_relationships_tabs_online").classList.remove("active"),e("social_relationships_tabs_friends").classList.add("active")),Ra=setInterval((()=>{Ya(),++Ha%600==0&&$a&&un()}),100),$a=!0,Os.play("social_open"),Va(),Ja(),Xa(),za(),bn(),Ae.push(),Ae.bindGuide(Ce.social),Ae.disengage(),bt(),Da?(requestAnimationFrame((()=>{e("social_dm_input").focus()})),Na&&Na.unread&&an(Na)):requestAnimationFrame((()=>{e("social_relationships_find").focus()})),un())}function Pa(){$a&&(z.anon()||(Ca&&clearTimeout(Ca),Ra&&(clearInterval(Ra),Ra=null),e("social").classList.add("hiding"),Ca=setTimeout((()=>{e("social").classList.add("hidden")}),300),sn(),Qa(),Da&&Na&&Na.unread&&an(Na),$a=!1,Os.play("social_close"),Ae.pop(),yt()))}let Da=!1,Na=null;function Fa(t,a=!1){if($a||Oa(),Da&&$a&&a&&Na._id===t._id)return void Ua();if(e("social_people").classList.add("collapsed"),s(".social_relationship").forEach((e=>{e.classList.remove("active")})),!e(`social_relationship_${t._id}`)){let a=!1;if(Sa.relationships.forEach((n=>{n._id===t._id&&("friend"===t.type?(s(".social_relationships_tab").forEach((e=>{e.classList.remove("active")})),e("social_relationships_tabs_friends").classList.add("active"),a=!0):"pending"===t.type&&(s(".social_relationships_tab").forEach((e=>{e.classList.remove("active")})),e("social_relationships_tabs_pending").classList.add("active"),a=!0))})),a&&(un(),!e(`social_relationship_${t._id}`)))return Ua(),void e("social_people").classList.remove("collapsed")}let n=!1;Na&&Na.unread&&(an(Na),n=!0),e(`social_relationship_${t._id}`).classList.add("active"),setTimeout((()=>{e(`social_relationship_${t._id}`)&&e(`social_relationship_${t._id}`).scrollIntoView({behavior:"smooth",block:"nearest",inline:"start"})}),50),Da||Os.play("social_open_minor"),Da=!0,Na=t,Xa(),void 0===Sa.dms[t.to._id]?(za(!0),w.get(`/api/dms/${t.to._id}`).then((e=>{Sa.dms[t.to._id]=e.dms.reverse(),za()}),(e=>{dt(),S(e)}))):za(),t.unread&&(an(t),n=!0),n&&un(),requestAnimationFrame((()=>{e("social_dm_input").focus()}))}function Ua(){if(!Da)return;e("social_people").classList.remove("collapsed"),s(".social_relationship").forEach((e=>{e.classList.remove("active")})),Da&&Os.play("social_close_minor"),Da=!1,Na&&Na.unread&&(an(Na),un());const t=e("sbcpw").scrollTop;requestAnimationFrame((()=>{e("social_relationships_find").focus(),e("sbcpw").scrollTop=t}))}function Ba(e){Sa.relationships.forEach((t=>{t.to._id===e&&Fa(t)}))}function Xa(){if(!Da||!Na)return;const t=Na;if(e("social_dm_img").src=t.to.avatar_revision?`/user-content/avatars/${t.to._id}.jpg?rv=${t.to.avatar_revision}`:u(t.to._id),e("social_dm_username").innerHTML=t.to.username.toUpperCase(),e("social_dm_username").classList.toggle("lu",t.to.username.length>14),e("social_dm").classList.toggle("offline",!["online","away","busy"].includes(t.presence.status)),e("social_dm_button_invite").classList.toggle("hidden",!t.presence.invitable),"friend"===t.type){const s=t.presence.detail.split(":"),a=Ta[t.presence.status](s[0]||"",s[1]||"");e("social_dm_status").innerHTML=`<img src="/res/status/${t.presence.status}.png" /> ${a.html}`,e("social_dm_button_snipe").classList.toggle("hidden",!(s[1]&&"X-PRIV"!==s[1]&&"online"===t.presence.status))}else switch(e("social_dm_button_snipe").classList.add("hidden"),t.type){case"block":e("social_dm_status").innerHTML='<img src="/res/status/blocked.png" /> Blocked';break;case"pending":e("social_dm_status").innerHTML='<img src="/res/status/unknown.png" /> Not a friend';break;default:e("social_dm_status").innerHTML='<img src="/res/status/unknown.png" /> Status unknown'}bn()}function za(t=!1){if(!Da||!Na)return;const a=Na;let n=[];if(n=t?[{_id:`${a.to._id}--loading`,data:{content:"Loading chat messages...",user:"[CMD]",system:!1,announcement:!1,banner:!0}}]:JSON.parse(JSON.stringify(Sa.dms[a.to._id]||[])),n||(n=[]),n.unshift({_id:`${a.to._id}--rules`,data:{content:"Please be civil. Staff will never ask for your credentials.",user:"[CMD]",system:!1,announcement:!1,banner:!0}}),"pending"===a.type&&n.unshift({_id:`${a.to._id}--pending`,data:{content:`${a.to.username.toUpperCase()} isn't on your friends list. You can block them by clicking PROFILE. Don't want to receive DMs from strangers? Check your privacy settings in Config -> Account.`,user:"[CMD]",system:!1,announcement:!1,banner:!0}}),"osk"===a.to.username&&"friend"===a.type){let e=!1;n.forEach((t=>{t.data.user===a.to._id&&(e=!0)})),e||(n.unshift({_id:`${a.to._id}--msgosk2`,data:{content:"Please do not message osk for TETR.IO support, such as account issues, ban appeals, verification requests, and any other requests for help. For help with such issues, please contact support (tetr.io/about/support). Your DM will be ignored at best.",user:"[CMD]",system:!1,announcement:!1,banner:!0,banner_color:"#FF008466"}}),n.unshift({_id:`${a.to._id}--msgosk`,data:{content:"Do you really want to message osk? He's often very busy, and might not reply very quickly or at all, and does not accept invites. He tries to read every DM he gets, so please go easy on him, OK?",user:"[CMD]",system:!1,announcement:!1,banner:!0,banner_color:"#19FF9533",banner_img:"/res/emotes/kagari.png"}}))}else if(Ia.includes(a.to._id)&&"friend"===a.type){let e=!1;n.forEach((t=>{t.data.user===a.to._id&&(e=!0)})),e||n.unshift({_id:`${a.to._id}--msgstaff`,data:{content:`Please do not message ${a.to.username.toUpperCase()} for TETR.IO support, such as account issues, ban appeals, verification requests, and any other requests for help. For help with such issues, please contact support (tetr.io/about/support). Your DM will be ignored at best.`,user:"[CMD]",system:!1,announcement:!1,banner:!0,banner_color:"#FF008466"}})}const o=n.map((e=>e._id));s("#social_chat .chat_message").forEach((e=>{o.includes(e.getAttribute("data-id"))||e.remove()}));const i=new DocumentFragment;n.forEach((t=>{const s=t.data;s.user===a.from._id?s.user={username:a.from.username,_id:a.from._id,...s.userdata||{}}:s.user===a.to._id?s.user={username:a.to.username,_id:a.to._id,...s.userdata||{}}:s.user={username:s.user,_id:null,...s.userdata||{}},e(`social_dm_${t._id}`)||Ga(t,!1,!1,i)})),e("social_chat").appendChild(i),e("sbdmcpw").scrollTop=e("sbdmcpw").scrollHeight+100}function Ga(t,s=!1,a=!1,n=null){if(Na&&a){const e=JSON.parse(JSON.stringify(t));e.data.user=e.data.user._id||e.data.user.username,Object.keys(Sa.dms).forEach((t=>{t.replace(z.id(),"").replace(":","")===Na.to._id&&Sa.dms[t].push(e)}))}const o=t.data;!1!==te.video.chatfilter&&o.content_safe&&o.user._id!=z.id()&&(o.content=o.content_safe);const i=document.createElement("div");i.classList.add("chat_message"),i.classList.add("dm_chat_message"),i.id=`social_dm_${t._id}`,i.setAttribute("data-id",t._id),t.ts&&i.setAttribute("data-ts",t.ts),o.banner&&i.classList.add("chat_banner"),o.banner_img&&i.classList.add("chat_banner_img"),o.system&&i.classList.add("system"),o.announcement&&i.classList.add("announcement"),o.user.supporter&&(i.classList.add("supporterchat"),i.classList.add(`supporterchat_t${o.user.supporter_tier}`)),"admin"===o.user.role&&i.classList.add("adminchat"),"mod"===o.user.role&&i.classList.add("modchat");const l=document.createElement("h1");l.textContent=o.user.username.toUpperCase(),["[SYS]","[CMD]"].includes(o.user.username.toUpperCase())||(l.classList.add("chat_tag"),l.setAttribute("data-id",o.user._id)),i.appendChild(l);const c=document.createElement("p"),d=r(o.content),p=s?o.content:ua(r(o.content),o.user,!1===te.video.emotes_anim);if(d===p?c.textContent=o.content:c.innerHTML=p,o.banner_color&&(c.style.color=o.banner_fgcolor||"#FFF",c.style.backgroundColor=o.banner_color,c.style.borderColor=o.banner_color),i.appendChild(c),o.banner_img){const e=document.createElement("img");e.classList.add("banner_img"),e.setAttribute("src",o.banner_img),i.appendChild(e)}(n||e("social_chat")).appendChild(i),n||(e("sbdmcpw").scrollTop=e("sbdmcpw").scrollHeight+100)}function ja(t){if(!Na)return;if(t.repeat||t.isComposing)return;if("Enter"!==t.code&&"NumpadEnter"!==t.code)return;const s=t.target.value;s.length&&Wa(Na.to._id,s),e("social_dm_input").value=""}function Wa(t,s){if(s.startsWith("/")){const t=s.split(" ");switch(t[0].toLowerCase()){case"/invite":case"/inv":case"/i":if(e("social_dm_button_invite").classList.contains("hidden"))return void qa("Cannot invite this user right now");if(e("social_dm_button_invite").classList.contains("active"))return void qa("Invite is on cooldown");e("social_dm_button_invite").click(),qa("Invite sent");break;case"/snipe":case"/s":case"/join":case"/j":if(e("social_dm_button_snipe").classList.contains("hidden"))return void qa("Cannot join this user's room right now");e("social_dm_button_snipe").click();break;case"/profile":case"/prof":case"/p":if(e("social_dm_button_profile").classList.contains("hidden"))return void qa("Cannot check this user's profile");e("social_dm_button_profile").click();break;case"/gift":case"/g":case"/support":case"/s":if(e("social_dm_button_gift").classList.contains("hidden"))return void qa("Cannot gift this user right now");e("social_dm_button_gift").click();break;case"/help":qa("Available commands: /INVITE (/INV, /I), /SNIPE (/S, /JOIN, /J), /PROFILE (/PROF, /P), /GIFT (/G, /SUPPORT, /S)");break;case"/kagari":qa(":kagari:");break;default:qa(`Unknown command ${t[0].toLowerCase()}`)}}else ga&&ga.isConnected()&&ga.emit("social.dm",{recipient:t,msg:s})}function qa(e){Ga({_id:`kagarin${Date.now()}${Math.floor(1e7*Math.random())}`,stream:"kagarin",data:{content:e,user:{username:"[CMD]",_id:null},system:!0,announcement:!1}},!1,!0)}const Ka=Date.now();function Ya(){const t=(new Date).toLocaleTimeString().replace("AM","<span>AM</span>").replace("PM","<span>PM</span>");e("social_top_clock").innerHTML=t,e("social_top_sessiontime").innerHTML=`${n(Ka)} this session`}function Va(){e("social_bottom_online").innerHTML=`${Sa.total_online.toLocaleString()} ONLINE`}let Za=!1;function Ja(){if(0===Sa.notifications.length)return e("social_notifications_content").innerHTML='<div class="social_empty"><img src="/res/social_working.png" /><p>Notifications will appear here.</p></div>',void(Za=!0);Za&&(e("social_notifications_content").innerHTML="",Za=!1);let t=null;for(Sa.notifications.forEach((s=>{let a=e(`social_notification_${s._id}`);if(!a){if(!La[s.type])return;const n=La[s.type](s);if(a=document.createElement("div"),a.classList.add("social_notification"),a.id=`social_notification_${s._id}`,a.style=`--pri: ${n.pri}; --sec: ${n.sec};`,n.action&&(a.setAttribute("data-action",n.action),a.addEventListener("click",(()=>{nn(n.action)}))),n.img_main){const e=document.createElement("img");e.classList.add("social_notification_img_main"),e.src=n.img_main,a.appendChild(e)}if(n.img_sub){const e=document.createElement("img");e.classList.add("social_notification_img_sub"),e.src=n.img_sub,a.appendChild(e)}const o=document.createElement("h1");o.innerHTML=n.header,a.appendChild(o);const i=document.createElement("h2");a.appendChild(i);const r=document.createElement("p");r.innerHTML=n.content,a.appendChild(r),t?t.insertAdjacentElement("afterend",a):e("social_notifications_content").insertAdjacentElement("afterbegin",a)}a&&(a.querySelector("h2").innerHTML=i(new Date(s.ts).getTime()),a.classList.toggle("unread",!s.seen),t=a)}));e("social_notifications_content").children.length>100;)e("social_notifications_content").removeChild(e("social_notifications_content").children[100])}function Qa(){let t=0;Sa.notifications.forEach((e=>{e.seen||t++})),e("social_tray").classList.toggle("unread_notifications",0!==t),e("social_tray_badge_notifications").innerHTML=t}function en(){let t=0;Sa.relationships.forEach((e=>{t+=e.unread||0})),e("social_tray").classList.toggle("unread_people",0!==t),e("social_tray_badge_people").innerHTML=t}function tn(){let t=0;Sa.relationships.forEach((e=>{"friend"===e.type&&["online","away","busy"].includes(e.presence.status)&&t++})),e("social_tray_online").innerHTML=t}function sn(){ga&&ga.isConnected()&&ga.emit("social.notifications.ack"),Sa.notifications.forEach((e=>{e.seen=!0}))}function an(e,t=!1){e.unread=0,t||Ma.delete(e.to._id),ga&&ga.isConnected()&&ga.emit("social.relationships.ack",e.to._id),en(),$a&&mn()}function nn(e){const t=e.split(":");switch(t[0]){case"user":Ns({userID:t[1]});break;case"support":Ke();break;case"url":window.open(t.slice(1).join(":"),"_blank");break;case"room":"busy"===Sa.presence.realstatus?T("you cannot join this room now"):ka.isInRoom()&&ya===t[1]?T("you are already in this room"):(Aa(t[1]),Pa())}}function on(e){for(let t=0;t<Sa.relationships.length;t++)if(Sa.relationships[t].to._id===e)return Sa.relationships[t]}let rn=!1,ln=!1,cn="";const dn=["online","away","busy","offline","unknown",void 0],pn={online:"#4AFF71",away:"#FFD84A",busy:"#FF504A",offline:"#FFF5",unknown:"#FFF5"};function un(){mn();let a=[],n=!1;const o=e("social_relationships_find").value.trim().toLowerCase();if(e("social_relationships_find").classList.toggle("active",!!o),o?(a=Sa.relationships.filter((e=>["friend","pending"].includes(e.type)&&e.to.username.includes(o))),n=!0):e("social_relationships_tabs_online").classList.contains("active")?(a=Sa.relationships.filter((e=>["online","away","busy"].includes(e.presence.status)&&"friend"===e.type)),n=!0):e("social_relationships_tabs_friends").classList.contains("active")?(a=Sa.relationships.filter((e=>"friend"===e.type)),n=!0):e("social_relationships_tabs_pending").classList.contains("active")?a=Sa.relationships.filter((e=>"pending"===e.type)):e("social_relationships_tabs_blocked").classList.contains("active")&&(a=Sa.relationships.filter((e=>"block"===e.type))),a.sort(((e,t)=>e.to.username===o!=(t.to.username===o)?(t.to.username===o)-(e.to.username===o):e.unread!==t.unread?t.unread-e.unread:e.presence.status!==t.presence.status?dn.indexOf(e.presence.status)-dn.indexOf(t.presence.status):e.to.username.localeCompare(t.to.username))),0===a.length){if(o){let t="Couldn't find anyone like that.",s=!1,a=!1;switch(o){case"anyone like that":t="Couldn't find anyone with that name.";break;case"anyone with that name":t="Couldn't find that person.";break;case"that person":t="Couldn't find the specified user.";break;case"the specified user":t="Couldn't find anyone in your friends list with that name.";break;case"anyone in your friends list with that name":t="Couldn't find who you are looking for.";break;case"who you are looking for":t="Couldn't find any user in your friends list who matches the specified search term.";break;case"any user in your friends list who matches the specified search term":t="...",s=!0}/^[a-z0-9\-\_]{3,16}$/.test(o)&&(a=!0),e("social_relationships").innerHTML=`<div class="social_empty"><img src="/res/${s?"social_blocked":"social_error"}.png" /><p>${t}</p>${a?`<p class="also tetra_pop" data-username="${r(o)}">Look for <span>${r(o.toUpperCase())}</span> on Tetra Channel?</p>`:""}</div>`}else e("social_relationships_tabs_online").classList.contains("active")?e("social_relationships").innerHTML='<div class="social_empty"><img src="/res/social_empty.png" /><p>Nobody\'s online right now.</p></div>':e("social_relationships_tabs_friends").classList.contains("active")?e("social_relationships").innerHTML='<div class="social_empty"><img src="/res/social_empty.png" /><p>You haven\'t added any friends yet. Click the FRIEND button on a profile to friend them.</p></div>':e("social_relationships_tabs_pending").classList.contains("active")?e("social_relationships").innerHTML='<div class="social_empty"><img src="/res/social_loading.png" /><p>If someone outside of your friends list messages you, they\'ll appear here.</p></div>':e("social_relationships_tabs_blocked").classList.contains("active")&&(e("social_relationships").innerHTML='<div class="social_empty"><img src="/res/social_blocked.png" /><p>You haven\'t blocked anyone yet.</p></div>');return void(rn=!0)}rn&&(e("social_relationships").innerHTML="",rn=!1);const i=a.map((e=>e._id));s("#social_relationships .social_relationship").forEach((e=>{i.includes(e.getAttribute("data-id"))||e.remove()}));let l=null;a.forEach((t=>{let s=e(`social_relationship_${t._id}`);if(s)e("social_relationships").insertAdjacentElement("beforeend",s),ln&&(s.querySelector("h1 span").textContent=t.to.username.toUpperCase(),s.querySelector(".social_relationship_img").src=t.to.avatar_revision?`/user-content/avatars/${t.to._id}.jpg?rv=${t.to.avatar_revision}`:u(t.to._id),ln=!1);else{s=document.createElement("div"),s.classList.add("social_relationship"),s.classList.toggle("active",Da&&Na._id===t._id),s.id=`social_relationship_${t._id}`,s.setAttribute("data-id",t._id),s.addEventListener("click",(()=>{"block"===t.type?Ns({userID:t.to._id}):Fa(t,!0)}));const a=document.createElement("img");a.classList.add("social_relationship_img"),a.src=t.to.avatar_revision?`/user-content/avatars/${t.to._id}.jpg?rv=${t.to.avatar_revision}`:u(t.to._id),s.appendChild(a);const n=document.createElement("h1");s.appendChild(n);const o=document.createElement("span");o.textContent=t.to.username.toUpperCase(),n.appendChild(o);const i=document.createElement("p");s.appendChild(i);const r=document.createElement("h2");s.appendChild(r);const c=document.createElement("div");c.classList.add("social_relationship_button_holder"),s.appendChild(c);const d=document.createElement("div");d.title="Join room",d.classList.add("social_relationship_button"),d.classList.add("social_relationship_button_snipe");const p=document.createElement("img");p.src="/res/icon/snipe.svg",d.appendChild(p),d.addEventListener("click",(s=>{if(d.classList.contains("active"))s.stopPropagation();else{if(d.classList.add("activated"),setTimeout((()=>{d.classList.remove("activated")}),300),ka.isInRoom()&&e(`sp_${t.to._id}`))return T("you are already in their room"),void s.stopPropagation();t.presence.detail.split(":")[1]&&(Aa(t.presence.detail.split(":")[1]),Pa()),s.stopPropagation()}})),c.appendChild(d);const m=document.createElement("div");m.title="Invite to your room",m.classList.add("social_relationship_button"),m.classList.add("social_relationship_button_invite");const g=document.createElement("img");g.src="/res/icon/invite.svg",m.appendChild(g);const h=document.createElement("span");if(m.appendChild(h),m.addEventListener("click",(s=>{if(m.classList.contains("active"))s.stopPropagation();else{if(m.classList.add("activated"),setTimeout((()=>{m.classList.remove("activated")}),300),ka.isInRoom()&&e(`sp_${t.to._id}`))return T("this person is already in your room"),void s.stopPropagation();ga&&ga.isConnected()&&ga.emit("social.invite",t.to._id),t.inv_locked_until=Date.now()+3e4,bn(),s.stopPropagation()}})),c.appendChild(m),"pending"===t.type){const e=document.createElement("div");e.title="Close DM",e.classList.add("social_relationship_button"),e.classList.add("social_relationship_button_close");const s=document.createElement("img");s.src="/res/icon/close.svg",e.appendChild(s),e.addEventListener("click",(s=>{e.classList.contains("active")||(e.classList.add("activated"),w.post("/api/relationships/remove",{user:t.to._id}).then((t=>{e.classList.remove("activated")}),(e=>{S(e)}))),s.stopPropagation()})),c.appendChild(e)}l?l.insertAdjacentElement("afterend",s):e("social_relationships").insertAdjacentElement("beforeend",s)}if(s){s.classList.toggle("unread",!!t.unread),s.classList.toggle("offline",n&&!["online","away","busy"].includes(t.presence.status)),s.setAttribute("style",n?`--pri: ${pn[t.presence.status||"unknown"]};`:"");let e="";if(n){const a=t.presence.detail.split(":"),n=Ta[t.presence.status](a[0]||"",a[1]||""),o=`<img src="/res/status/${t.presence.status}.png" /> ${n.html}`;s.querySelector("p").innerHTML!==o&&(s.querySelector("p").innerHTML=o),e=n.text,s.querySelector(".social_relationship_button_snipe").classList.toggle("hidden",!(a[1]&&"X-PRIV"!==a[1]&&"online"===t.presence.status))}else{s.querySelector(".social_relationship_button_snipe").classList.add("hidden");let a="";switch(t.type){case"block":a='<img src="/res/status/blocked.png" /> Blocked',e="Blocked";break;case"pending":a='<img src="/res/status/unknown.png" /> Not a friend',e="Not a friend";break;default:a='<img src="/res/status/unknown.png" /> Status unknown',e="Status unknown"}s.querySelector("p").innerHTML!==a&&(s.querySelector("p").innerHTML=a)}s.classList.toggle("cc",s.querySelector("p").innerHTML.length>=70),s.setAttribute("title",`${t.to.username.toUpperCase()}\n${e}`),s.querySelector("h2").textContent=t.unread||0,s.querySelector(".social_relationship_button_invite").classList.toggle("hidden",!t.presence.invitable),l=s}0})),o?(cn===o&&t(".social_relationship.focus")||(s(".social_relationship.focus").forEach((e=>{e.classList.remove("focus")})),t(".social_relationship")&&t(".social_relationship").classList.add("focus")),cn=o):s(".social_relationship.focus").forEach((e=>{e.classList.remove("focus")})),bn(),e("social").classList.toggle("bulky",a.length>50)}function mn(){let e=0,s=0,a=0,n=0,o=0;Sa.relationships.forEach((t=>{e+=t.unread||0,"friend"===t.type?(a+=t.unread||0,["offline","unknown"].includes(t.presence.status)||(s+=t.unread||0)):"pending"===t.type?n+=t.unread||0:"block"===t.type&&(o+=t.unread||0)})),t("#social_relationships_tabs_online .social_relationships_tab_unread").classList.toggle("hidden",0===s),t("#social_relationships_tabs_online .social_relationships_tab_unread").textContent=s,t("#social_relationships_tabs_friends .social_relationships_tab_unread").classList.toggle("hidden",0===a),t("#social_relationships_tabs_friends .social_relationships_tab_unread").textContent=a,t("#social_relationships_tabs_pending .social_relationships_tab_unread").classList.toggle("hidden",0===n),t("#social_relationships_tabs_pending .social_relationships_tab_unread").textContent=n,t("#social_relationships_tabs_blocked .social_relationships_tab_unread").classList.toggle("hidden",0===o),t("#social_relationships_tabs_blocked .social_relationships_tab_unread").textContent=o,t("#social_unread").classList.toggle("hidden",0===e),t("#social_unread").textContent=e}let gn=null,hn,fn,_n;function bn(){if(!$a)return;gn&&(clearTimeout(gn),gn=null);let s=0;Sa.relationships.forEach((a=>{if(a.inv_locked_until>Date.now()){s++;const n=Math.ceil((a.inv_locked_until-Date.now())/1e3);e(`social_relationship_${a._id}`)&&(t(`#social_relationship_${a._id} .social_relationship_button_invite`).classList.add("active"),t(`#social_relationship_${a._id} .social_relationship_button_invite span`).textContent=n),Da&&Na._id===a._id&&(e("social_dm_button_invite").classList.add("active"),e("social_dm_button_invite").style=`--progress: ${(a.inv_locked_until-Date.now())/3e4*100}%`)}else e(`social_relationship_${a._id}`)&&t(`#social_relationship_${a._id} .social_relationship_button_invite`).classList.remove("active"),Da&&Na._id===a._id&&e("social_dm_button_invite").classList.remove("active")})),s&&(gn=setTimeout((()=>{bn()}),100))}function yn(t,s="",a="",n=null){let o=kn();n&&(Sa.presence.mask=n),Sa.presence.realstatus=t,Sa.presence.realdetail=`${s}${a?`:${a}`:""}`,"away"!==t&&(Sa.presence.last=[t,s,a]),[t,s,a]=xa[Sa.presence.mask](t,s,a);const i=Ta[t](s,a);kn()!==o&&(kn()||document.body.classList.contains("ingame_phys")&&!1!==te.notifications.suppress||C()),Z(i.discord);const r=t,l=`${s}${a?`:${a}`:""}`;Sa.presence.status===r&&Sa.presence.detail===l||(Sa.presence.status=r,Sa.presence.detail=l,ga&&ga.isConnected()&&ga.emit("social.presence",{status:Sa.presence.status,detail:Sa.presence.detail}),e("social_status").innerHTML=`${i.html} <img src="/res/status/${r}.png" />`,e("social_status").classList.toggle("cc",e("social_status").innerHTML.length>=65))}function vn(){"menus"===Sa.presence.detail&&yn("away")}function wn(){null!==Sa.presence.last&&"away"===Sa.presence.realstatus&&yn(...Sa.presence.last)}function kn(){return"busy"===Sa.presence.realstatus||"busy"===Sa.presence.mask}function Ln(){return te.notifications.suppress&&document.body.classList.contains("ingame_phys")||kn()}function En(e){let t=e%2147483647;return t<=0&&(t+=2147483646),{next:function(){return t=16807*t%2147483647},nextFloat:function(e,t){return(this.next()-1)/2147483646},shuffleArray:function(e){let t,s=e.length;if(0==s)return e;for(;--s;)t=Math.floor(this.nextFloat()*(s+1)),[e[s],e[t]]=[e[t],e[s]];return e},getCurrentSeed:function(){return t}}}const xn=(()=>{const e=new Map;return{play:function(t,s={}){const a=e.get(t);a&&(a.graphics||["medium","high","ultra"]).includes(te.video.graphics)&&a.play(s)},register:function(t,s){e.set(t,s)},utils:{freq:e=>e*(parseFloat(te.video.particles)||.6),scale:e=>Ls(1.8)*e/Math.max(.75,Math.min(2,parseFloat(te.video.particles||.6)+.4))}}})();let Tn;function In(e){return e/(te.video.particles||.6)}function Sn(e){return e*(2.2-Math.max(0,2.2*(1-(te.video.particles||.6))))}function Mn(e,t,s){if("ultra"!==te.video.graphics||0==te.video.flashwave)return;null===zn.stage.filters&&(zn.stage.filters=[]);const a=void 0===te.video.flashwave?1:te.video.flashwave;zn.stage.filters.push(new PIXI.filters.ShockwaveFilter([e,t],{amplitude:(2+2*s)*a,wavelength:Ls(150+40*s*(.5+.5*a)),speed:Ls(500+50*s),brightness:1+.25*a,radius:-1},0))}function An(e,t,s,a){return void 0===a&&(a=mo),e+(t-e)*a(s)}function Cn(e){const t=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(e);return t?{r:parseInt(t[1],16),g:parseInt(t[2],16),b:parseInt(t[3],16)}:null}function Rn(e){const t=Cn(e);return t?t.r<<16|t.g<<8|t.b:0}function Hn(e,t,s){let a,n,o;if(e/=360,s/=100,0===(t/=100))a=n=o=s;else{const i=(e,t,s)=>(s<0&&(s+=1),s>1&&(s-=1),s<1/6?e+6*(t-e)*s:s<.5?t:s<2/3?e+(t-e)*(2/3-s)*6:e),r=s<.5?s*(1+t):s+t-s*t,l=2*s-r;a=i(l,r,e+1/3),n=i(l,r,e),o=i(l,r,e-1/3)}const i=e=>{const t=Math.round(255*e).toString(16);return 1===t.length?"0"+t:t};return`#${i(a)}${i(n)}${i(o)}`}function $n(e,t,s){s/=100;const a=t*Math.min(s,1-s)/100,n=t=>{const n=(t+e/30)%12,o=s-a*Math.max(Math.min(n-3,9-n,1),-1);return Math.round(255*o)};return n(0)<<16|n(8)<<8|n(4)}U.ready((function(e){PIXI.Ticker.shared.add((e=>{"ultra"===te.video.graphics&&null!==zn.stage.filters&&(zn.stage.filters.forEach(((t,s)=>{t.time+=e/(1e3/60),t.amplitude*=.98,t.brightness=1+.95*(t.brightness-1),t.time>5&&zn.stage.filters.splice(s,1)})),0===zn.stage.filters.length&&(zn.stage.filters=null))}))})),xn.register("test",{play:e=>{const{x:t=0,y:s=0,color:a=16777215}=e;fn.spawnBurst({texture:"/res/particles/box.png",tint:a,lifetime:[.5,1.5],alpha:{from:1,to:0},speed:{from:[150,300],to:0},scale:xn.utils.scale(.8)},{x:t,y:s,amount:xn.utils.freq(50),shape:"circle",radius:100,directionOverride:0,angleOverride:45})}}),xn.register("garbage_beam_impact",{play:e=>{const{x:t=0,y:s=0,color:a=16777215,intensity:n=1}=e;fn.spawnBurst({texture:"/res/particles/beam.png",tint:a,lifetime:[.05,.1],alpha:{from:[.4+n/20*.4,.5+n/20*.5],to:0},speed:[1600,2400],blendmode:PIXI.BLEND_MODES.ADD,scale:[xn.utils.scale(.1+n/20*.2),.15+n/20*.35]},{x:t,y:s,amount:xn.utils.freq(10),shape:"circle",radius:1,directionOverride:0,angleOverride:0}),fn.spawnBurst({texture:"/res/particles/fire.png",tint:a,lifetime:[.2,.3],alpha:{from:[.3,.5],to:0},alphamultiplier:{from:1,to:0},angle:[0,360],anglespeed:[-720,720],direction:[0,360],speed:[0,80],blendmode:PIXI.BLEND_MODES.ADD,scale:[xn.utils.scale(.3+n/20*.8),.6+n/20*1]},{x:t,y:s,amount:5,shape:"point"})}}),xn.register("bgsplash",{graphics:["high","ultra"],play:e=>{const{amt:t=30,direction:s=[0,360],speed:a=[0,100]}=e;hn.spawnBurst({texture:"/res/particles/bigbox.png",tint:16777215,lifetime:[2,5],alpha:{from:[.02,.15],to:0},alphamultiplier:{from:0,to:2},speed:{from:a,to:0},direction:s,scale:[xn.utils.scale(.02),xn.utils.scale(.2)],wrap:!0},{shape:"rectangle",x:window.innerWidth/2,y:window.innerHeight/2,width:window.innerWidth,height:window.innerHeight,amount:xn.utils.freq(t)})}}),xn.register("bgsplashdanger",{graphics:["high","ultra"],play:e=>{const{amt:t=30,direction:s=[0,360],speed:a=[0,100]}=e;hn.spawnBurst({texture:"/res/particles/bigbox.png",tint:16720384,lifetime:[.1,1],alpha:{from:[.02,.15],to:0},alphamultiplier:{from:0,to:2},speed:{from:a,to:0},direction:s,scale:[xn.utils.scale(.02),xn.utils.scale(.3)],wrap:!0},{shape:"rectangle",x:window.innerWidth/2,y:window.innerHeight/2,width:window.innerWidth,height:window.innerHeight,amount:xn.utils.freq(t)})}}),xn.register("bgtransition",{graphics:["high","ultra"],play:()=>{hn.spawnBurst({texture:"/res/particles/bigbox.png",tint:16777215,lifetime:[.5,3],alpha:{from:[.02,.15],to:0},speed:{from:[0,400],to:[800,1600]},scale:{from:0,to:[xn.utils.scale(.05),xn.utils.scale(.5)]}},{shape:"rectangle",x:window.innerWidth/2,y:window.innerHeight/2,width:window.innerWidth,height:window.innerHeight,amount:xn.utils.freq(200),directionOverride:0})}}),xn.register("bgcircle",{graphics:["high","ultra"],play:e=>{const{radius:t=Ls(10*fo.x),color:s=16777215,amt:a=100,speed:n=150}=e;hn.spawnBurst({texture:"/res/particles/particle.png",tint:s,lifetime:[.35,3],alpha:{from:[.02,.4],to:0},speed:{from:[0,n],to:0},scale:[xn.utils.scale(.02),xn.utils.scale(.25)]},{shape:"circle",x:window.innerWidth/2,y:window.innerHeight/2,radius:t,amount:xn.utils.freq(a),directionOverride:0})}}),xn.register("harddrop_trail",{graphics:["high","ultra"],play:e=>{const{x:t=0,y:s=0,color:a=16777215}=e;fn.spawnBurst({texture:"/res/particles/star.png",tint:a,lifetime:[.2,1],alpha:{from:[.3,.8],to:0},speed:{from:[150,450],to:[-100,100]},direction:[-2,2],xflurry:[0,50],blendmode:PIXI.BLEND_MODES.ADD,scale:[xn.utils.scale(.08),xn.utils.scale(.2)]},{x:t,y:s,amount:xn.utils.freq(.25),shape:"rectangle",width:Ls(fo.x),height:Ls(fo.x)})}}),xn.register("harddrop_edge",{graphics:["high","ultra"],play:e=>{const{x:t=0,y:s=0}=e;fn.spawnBurst({texture:"/res/particles/star.png",tint:16777215,lifetime:[.1,.5],alpha:{from:[.5,1],to:0},speed:{from:[0,150],to:[0,50]},yspeed:{from:0,to:50},direction:[-45,45],blendmode:PIXI.BLEND_MODES.ADD,scale:[xn.utils.scale(.1),xn.utils.scale(.3)]},{x:t,y:s,amount:xn.utils.freq(5),shape:"rectangle",width:Ls(fo.x),height:0})}}),xn.register("piece_spin",{graphics:["high","ultra"],play:e=>{const{x:t=0,y:s=0,color:a=16777215,direction:n="none",kickX:o=0,kickY:i=0}=e;fn.spawnBurst({texture:"/res/particles/star.png",tint:a,lifetime:[.2,1],alpha:{from:[.7,1],to:0},speed:{from:[50,300],to:[0,50]},blendmode:PIXI.BLEND_MODES.ADD,scale:[xn.utils.scale(.15),xn.utils.scale(.3)],flickerfrequency:{from:[20,100],to:[10,20]},flickeramplitude:{from:[0,.5],to:[0,.1]},xspeed:{from:[Ls(fo.x)*o*-1,Ls(fo.x)*o*2],to:[0,0]},yspeed:{from:[Ls(fo.x)*i*-1,Ls(fo.x)*i*2],to:[0,0]}},{x:t,y:s,amount:xn.utils.freq(5),shape:"disk",width:"horizontal"===n?0:3*Ls(fo.x),height:"vertical"===n?0:3*Ls(fo.x),directionOverride:"left"===n?-110:"right"===n?110:0})}}),xn.register("line_burst",{play:e=>{const{x:t=0,y:s=0,s:a=1,color:n=16777215}=e;(parseFloat(te.video.particles)||.6)>=.15&&fn.spawnBurst({texture:"/res/particles/fbox.png",tint:n,lifetime:[.1+.3*Math.min(1,.8*(parseFloat(te.video.particles)||.6)),.1+.6*Math.min(1,.8*(parseFloat(te.video.particles)||.6))],alpha:{from:Math.max(.1,Math.min(1,.6*(parseFloat(te.video.particles)||.6))),to:0},speed:{from:[0,80],to:[0,30]},direction:[0,360],anglespeed:[-20,20],blendmode:PIXI.BLEND_MODES.ADD,scale:{from:Is(1*a),to:[Is(1*a),Is(1.4*a)]},yspeed:{start:[0,-100],inc:[5,12]}},{x:t,y:s,amount:1,shape:"point"}),["high","ultra"].includes(te.video.graphics)&&fn.spawnBurst({texture:"/res/particles/chip.png",tint:n,lifetime:[.2,1],alpha:{from:[.7,1],to:0},speed:{from:[50,300],to:[0,50]},direction:[0,360],blendmode:PIXI.BLEND_MODES.ADD,scale:[xn.utils.scale(.1),xn.utils.scale(.25)],anglespeed:{from:[-720,720],to:[-360,360]},flickerfrequency:{from:[20,100],to:[10,20]},flickeramplitude:{from:[0,.5],to:[0,.1]},xspeed:[-500,500],yspeed:{start:[-500,50],inc:[15,40]}},{x:t,y:s,amount:xn.utils.freq(1.65),shape:"rectangle",width:Ls(fo.x*a),height:Ls(fo.x*a)})}}),xn.register("mino_dust",{play:e=>{const{x:t=0,y:s=0,s:a=1,color:n=16777215}=e;fn.spawnBurst({texture:"/res/particles/dust.png",tint:4473924,lifetime:[.3,1],alpha:{from:1,to:0},speed:{from:[0,50],to:[0,20]},direction:[0,360],anglespeed:[-20,20],scale:{from:Is(1.5*a),to:[Is(2.5*a),Is(3.5*a)]},yspeed:{start:0,inc:[1,-5]}},{x:t,y:s,amount:1,shape:"point"}),fn.spawnBurst({texture:"/res/particles/dust.png",tint:n,lifetime:[.3,1],alpha:{from:.8,to:0},speed:{from:[0,50],to:[0,20]},direction:[0,360],anglespeed:[-20,20],scale:{from:Is(1.5*a),to:[Is(1.5*a),Is(2.5*a)]},yspeed:{start:0,inc:[0,-5]}},{x:t,y:s,amount:1,shape:"point"}),["high","ultra"].includes(te.video.graphics)&&fn.spawnBurst({texture:"/res/particles/star.png",tint:n,lifetime:[.2,1],alpha:{from:[.7,1],to:0},speed:{from:[50,150],to:[0,50]},direction:[0,360],blendmode:PIXI.BLEND_MODES.ADD,scale:[xn.utils.scale(.15),xn.utils.scale(.3)],flickerfrequency:{from:[20,100],to:[10,20]},flickeramplitude:{from:[0,.5],to:[0,.1]},yspeed:{start:0,inc:[-3,-10]}},{x:t,y:s,amount:xn.utils.freq(1),shape:"rectangle",width:Ls(a*fo.x),height:Ls(a*fo.x)})}}),xn.register("b2b_flair",{graphics:["high","ultra"],play:e=>{const{x:t=0,y:s=0,w:a=10,h:n=20}=e,o={texture:"/res/particles/star.png",tint:[16744448,16777088],lifetime:[.2,1],alpha:{from:[.7,1],to:0},speed:{from:[0,150],to:[0,50]},direction:[0,360],blendmode:PIXI.BLEND_MODES.ADD,scale:[xn.utils.scale(.15),xn.utils.scale(.3)],flickerfrequency:{from:[20,100],to:[10,20]},flickeramplitude:{from:[0,.5],to:[0,.1]}};fn.spawnBurst({...o,xspeed:-60},{x:t,y:s,amount:xn.utils.freq(5*n),shape:"line",linePointA:[0,0],linePointB:[0,Ls(fo.x*n)]}),fn.spawnBurst({...o,xspeed:60},{x:t,y:s,amount:xn.utils.freq(5*n),shape:"line",linePointA:[Ls(fo.x*a),0],linePointB:[Ls(fo.x*a),Ls(fo.x*n)]}),fn.spawnBurst({...o,yspeed:60},{x:t,y:s,amount:xn.utils.freq(5*a),shape:"line",linePointA:[0,Ls(fo.x*n)],linePointB:[Ls(fo.x*a),Ls(fo.x*n)]})}}),xn.register("spike_flair",{graphics:["high","ultra"],play:e=>{const{x:t=0,y:s=0,w:a=10,h:n=20}=e;fn.spawnBurst({texture:"/res/particles/star.png",tint:16777215,lifetime:[.5,1.5],alpha:{from:[.6,.8],to:0},speed:{from:[0,150],to:[0,50]},direction:[0,360],blendmode:PIXI.BLEND_MODES.ADD,scale:[xn.utils.scale(.1),xn.utils.scale(.25)],flickerfrequency:{from:[10,50],to:[10,20]},flickeramplitude:{from:[0,.6],to:[0,.3]},flurryfrequency:{from:[5,30],to:[2,10]},flurryamplitude:{from:[-130,130],to:[-30,30]}},{x:t,y:s,amount:xn.utils.freq(100),shape:"rectangle",width:Ls(fo.x*a),height:Ls(fo.x*n)})}}),xn.register("danger_flair",{graphics:["high","ultra"],play:e=>{const{x:t=0,y:s=0,w:a=10,h:n=20}=e;fn.spawnBurst({texture:"/res/particles/particle.png",tint:[16711680,16737792],lifetime:[.5,1.5],alpha:{from:[.6,.8],to:0},speed:{from:[0,150],to:[0,50]},direction:[0,360],blendmode:PIXI.BLEND_MODES.ADD,scale:[xn.utils.scale(.05),xn.utils.scale(.1)],flickerfrequency:{from:[10,50],to:[10,20]},flickeramplitude:{from:[0,.6],to:[0,.3]},flurryfrequency:{from:[5,30],to:[2,10]},flurryamplitude:{from:[-130,130],to:[-30,30]},yspeed:{from:0,to:[-25,-200]}},{x:t,y:s,amount:xn.utils.freq(100),shape:"rectangle",width:Ls(fo.x*a),height:Ls(fo.x*n)}),fn.spawnBurst({texture:"/res/particles/smoke.png",tint:3342336,lifetime:[1,2],alpha:{from:1,to:0},speed:{from:[0,20],to:0},direction:[0,360],blendmode:PIXI.BLEND_MODES.ADD,anglespeed:[-20,20],scale:{from:Is(1.5),to:[Is(2.5),Is(3.5)]}},{x:t,y:s,amount:xn.utils.freq(a),shape:"line",linePointA:[Ls(fo.x*a/-2),Ls(fo.x*n/-2)],linePointB:[Ls(fo.x*a/2),Ls(fo.x*n/-2)]})}}),xn.register("danger_smoke",{play:e=>{const{x:t=0,y:s=0,w:a=10,h:n=20}=e,o={texture:"/res/particles/smoke.png",tint:[3342336,2236928],lifetime:[.6,1],alpha:{from:1,to:0},speed:{from:[200,300],to:0},anglespeed:[-20,20],scale:{from:Is(.4),to:[Is(2.5),Is(4.5)]}},i={texture:"/res/particles/smoke.png",tint:{from:[16776960,16777215],to:[16711680,16729088]},lifetime:[.4,.6],alpha:{from:1,to:0},speed:{from:[200,300],to:0},blendmode:PIXI.BLEND_MODES.ADD,anglespeed:[-20,20],scale:{from:Is(.4),to:[Is(1.5),Is(3.5)]}};hn.spawnBurst({...o,direction:[-60,-30]},{x:t,y:s,amount:xn.utils.freq(1),shape:"point"}),fn.spawnBurst({...i,direction:[-60,-30]},{x:t,y:s,amount:xn.utils.freq(1),shape:"point"}),hn.spawnBurst({...o,direction:[30,60]},{x:t+Ls(fo.x*a),y:s,amount:xn.utils.freq(1),shape:"point"}),fn.spawnBurst({...i,direction:[30,60]},{x:t+Ls(fo.x*a),y:s,amount:xn.utils.freq(1),shape:"point"}),hn.spawnBurst({...o,direction:[210,240]},{x:t,y:s+Ls(fo.x*n),amount:xn.utils.freq(1),shape:"point"}),fn.spawnBurst({...i,direction:[210,240]},{x:t,y:s+Ls(fo.x*n),amount:xn.utils.freq(1),shape:"point"}),hn.spawnBurst({...o,direction:[120,150]},{x:t+Ls(fo.x*a),y:s+Ls(fo.x*n),amount:xn.utils.freq(1),shape:"point"}),fn.spawnBurst({...i,direction:[120,150]},{x:t+Ls(fo.x*a),y:s+Ls(fo.x*n),amount:xn.utils.freq(1),shape:"point"})}}),xn.register("death_flair",{graphics:["high","ultra"],play:e=>{const{x:t=0,y:s=0,w:a=10,h:n=20}=e;fn.spawnBurst({texture:"/res/particles/chirp.png",tint:[16746751,16711680],lifetime:[.2,2],alpha:{from:[.7,1],to:0},speed:{from:[0,1e3],to:[0,200]},blendmode:PIXI.BLEND_MODES.ADD,scale:[xn.utils.scale(.15),xn.utils.scale(.5)],flickerfrequency:{from:[20,100],to:[10,20]},flickeramplitude:{from:[0,.5],to:[0,.1]}},{x:t,y:s,amount:xn.utils.freq(100),shape:"box",width:Ls(fo.x*a),height:Ls(fo.x*n),directionOverride:0,angleOverride:0}),fn.spawnBurst({texture:"/res/particles/star.png",tint:16777215,lifetime:[.2,1],alpha:{from:[.7,1],to:0},speed:{from:[0,300],to:[0,50]},blendmode:PIXI.BLEND_MODES.ADD,scale:[xn.utils.scale(.15),xn.utils.scale(.5)],flickerfrequency:{from:[20,100],to:[10,20]},flickeramplitude:{from:[0,.5],to:[0,.1]}},{x:t,y:s,amount:xn.utils.freq(100),shape:"box",width:Ls(fo.x*a),height:Ls(fo.x*n),directionOverride:0})}}),xn.register("fire_flair",{graphics:["high","ultra"],play:e=>{const{x:t=0,y:s=0,w:a=10,h:n=20}=e,o={texture:"/res/particles/particle.png",tint:[16736256,16777088],lifetime:[.2,3],alpha:{from:[.7,1],to:0},alphamultiplier:{from:0,to:2},speed:{from:[0,75],to:[0,25]},direction:[0,360],blendmode:PIXI.BLEND_MODES.ADD,scale:[xn.utils.scale(.3),xn.utils.scale(.9)]};fn.spawnBurst({...o,xspeed:-20},{x:t,y:s,amount:xn.utils.freq(5*n),shape:"line",linePointA:[0,0],linePointB:[0,Ls(fo.x*n)]}),fn.spawnBurst({...o,xspeed:20},{x:t,y:s,amount:xn.utils.freq(5*n),shape:"line",linePointA:[Ls(fo.x*a),0],linePointB:[Ls(fo.x*a),Ls(fo.x*n)]}),fn.spawnBurst({...o,yspeed:20},{x:t,y:s,amount:xn.utils.freq(5*a),shape:"line",linePointA:[0,Ls(fo.x*n)],linePointB:[Ls(fo.x*a),Ls(fo.x*n)]})}}),xn.register("fire_burn",{graphics:["high","ultra"],play:e=>{const{x:t=0,y:s=0,w:a=10,h:n=20}=e,o={texture:"/res/particles/particle.png",tint:[16736256,16777088],lifetime:[.2,3],alpha:{from:[.7,1],to:0},alphamultiplier:{from:0,to:2},speed:{from:[0,75],to:[0,25]},direction:[0,360],blendmode:PIXI.BLEND_MODES.ADD,scale:[xn.utils.scale(.05),xn.utils.scale(.2)]};fn.spawnBurst({...o,xspeed:-20},{x:t,y:s,amount:xn.utils.freq(.05*n),shape:"line",linePointA:[0,0],linePointB:[0,Ls(fo.x*n)]}),fn.spawnBurst({...o,xspeed:20},{x:t,y:s,amount:xn.utils.freq(.05*n),shape:"line",linePointA:[Ls(fo.x*a),0],linePointB:[Ls(fo.x*a),Ls(fo.x*n)]}),fn.spawnBurst({...o,yspeed:20},{x:t,y:s,amount:xn.utils.freq(.05*a),shape:"line",linePointA:[0,Ls(fo.x*n)],linePointB:[Ls(fo.x*a),Ls(fo.x*n)]}),hn.spawnBurst({texture:"/res/particles/fire.png",tint:[16736256,16777088],lifetime:[.2,3],alpha:{from:[.4,.9],to:0},alphamultiplier:{from:0,to:3},speed:{from:[0,75],to:[0,25]},direction:[0,360],blendmode:PIXI.BLEND_MODES.ADD,scale:[xn.utils.scale(.3),xn.utils.scale(2.5)],flurryfrequency:{from:[5,30],to:[2,10]},flurryamplitude:{from:[-130,130],to:[-30,30]},yspeed:{from:[100,-50],to:[-100,-300]},angle:[0,360],anglespeed:[-200,200]},{x:t+Ls(fo.x*a/2),y:s+Ls(fo.x*n/2),amount:xn.utils.freq(a*n*1/200),shape:"rectangle",width:Ls(fo.x*a),height:Ls(fo.x*n)})}}),xn.register("fire_burning",{graphics:["high","ultra"],play:e=>{const{x:t=0,y:s=0}=e;hn.createSpawner({texture:"/res/particles/fire.png",tint:[16736256,16777088],lifetime:[.2,3],alpha:{from:[.4,.9],to:0},alphamultiplier:{from:0,to:3},speed:{from:[0,25],to:[0,10]},direction:[0,360],blendmode:PIXI.BLEND_MODES.ADD,scale:[xn.utils.scale(.2),xn.utils.scale(.7)],flurryfrequency:{from:[5,30],to:[2,10]},flurryamplitude:{from:[-130,130],to:[-30,30]},yspeed:{from:[30,-15],to:[-30,-100]},angle:[0,360],anglespeed:[-200,200]},{x:t,y:s,amount:xn.utils.freq(20),lifetime:2,shape:"rectangle",width:Ls(2*fo.x),height:Ls(2*fo.x)})}}),xn.register("bar_sparks",{graphics:["high","ultra"],play:e=>{const{x:t=0,y:s=0,w:a=0,color:n=16777215,dT:o=1}=e;fn.spawnBurst({texture:"/res/particles/star.png",tint:n,lifetime:[.2,1],alpha:{from:[.3,.8],to:0},speed:{from:[150,450],to:[-100,100]},direction:[-2,2],xflurry:[0,50],scale:[xn.utils.scale(.08),xn.utils.scale(.2)]},{x:t,y:s,amount:xn.utils.freq(.15*o),shape:"rectangle",width:a,height:0})}}),xn.register("stock_explode",{play:e=>{const{x:t=0,y:s=0}=e;fn.spawnBurst({texture:"/res/particles/dust.png",tint:4473924,lifetime:[.3,1],alpha:{from:1,to:0},speed:{from:[0,50],to:[0,20]},direction:[0,360],anglespeed:[-20,20],scale:{from:Is(1.5),to:[Is(2.5),Is(3.5)]},yspeed:{start:0,inc:[1,-5]}},{x:t,y:s,amount:1,shape:"point"}),fn.spawnBurst({texture:"/res/particles/dust.png",tint:16777215,lifetime:[.3,1],alpha:{from:.8,to:0},speed:{from:[0,50],to:[0,20]},direction:[0,360],anglespeed:[-20,20],scale:{from:Is(1.5),to:[Is(1.5),Is(2.5)]},yspeed:{start:0,inc:[0,-5]}},{x:t,y:s,amount:1,shape:"point"}),["high","ultra"].includes(te.video.graphics)&&fn.spawnBurst({texture:"/res/particles/star.png",tint:16777215,lifetime:[.4,1.5],alpha:{from:[.7,1],to:0},speed:{from:[0,150],to:[0,50]},direction:[0,360],blendmode:PIXI.BLEND_MODES.ADD,scale:[xn.utils.scale(.15),xn.utils.scale(.3)],flickerfrequency:{from:[20,100],to:[10,20]},flickeramplitude:{from:[0,.5],to:[0,.1]},yspeed:{start:0,inc:[-3,-10]}},{x:t,y:s,amount:xn.utils.freq(25),shape:"rectangle",width:Ls(fo.x),height:Ls(fo.x)})}}),xn.register("confetti",{graphics:["high","ultra"],play:e=>{const{gui:t=!1,count:s=40,hue:a=[0,360]}=e;if(!t||Gn&&"ultra"===te.video.graphics)for(let e=0;e<s;e++){const e=Math.random()*(a[1]-a[0])+a[0],s=Math.random()>.5,n=(.3+.65*Math.random())*window.innerHeight,o=(.05+.4*Math.random())*window.innerWidth,i=new Moonbeam.Beam({texture:PIXI.Texture.WHITE,mode:"path",path:[new PIXI.Point(s?window.innerWidth+30*Math.random():-30*Math.random(),window.innerHeight+30*Math.random()),new PIXI.Point(s?window.innerWidth-o:o,window.innerHeight-n),new PIXI.Point(s?window.innerWidth-2*o:2*o,window.innerHeight+n)],vertices:10,length:5+20*Math.random(),duration:.7+1*Math.random(),tint:$n(e,100,50),blendMode:PIXI.BLEND_MODES.ADD,scale:.2,smoothPath:!0,smoothVertices:!0,repeatTexture:!1,reverse:!1,pathBezier:BezierEasing(.08,.7,.6,.26),jitter:5+20*Math.random()});(t?Gn.stage:Tn).addChild(i)}}}),xn.register("waterfall",{graphics:["high","ultra"],play:e=>{const{x:t=0,y:s=0,w:a=0,h:n=0,color:o=16777215}=e,i={texture:"/res/particles/star.png",tint:o,lifetime:1,alpha:{from:1,to:0},y:s};("ultra"===te.video.graphics?_n:fn).spawnOne({...i,x:t-a/2-16,direction:-90,scale:.8,speed:{from:100,to:0}}),("ultra"===te.video.graphics?_n:fn).spawnOne({...i,x:t+a/2+16,direction:90,scale:.8,speed:{from:100,to:0}}),("ultra"===te.video.graphics?_n:fn).spawnOne({...i,x:t-a/2-48,direction:-90,scale:.6,speed:{from:150,to:0}}),("ultra"===te.video.graphics?_n:fn).spawnOne({...i,x:t+a/2+48,direction:90,scale:.6,speed:{from:150,to:0}})}}),xn.register("button_ultra",{graphics:["ultra"],play:e=>{const{x:t=0,y:s=0,w:a=0,h:n=0,color:o=16777215,amt:i=50}=e;_n.spawnBurst({texture:"/res/particles/star.png",tint:o,lifetime:[.2,1],alpha:{from:[.7,1],to:0},speed:{from:[0,300],to:[0,50]},blendmode:PIXI.BLEND_MODES.ADD,scale:[xn.utils.scale(.15),xn.utils.scale(.5)],flickerfrequency:{from:[20,100],to:[10,20]},flickeramplitude:{from:[0,.5],to:[0,.1]}},{x:t+a/2,y:s+n/2,amount:xn.utils.freq(i/2),shape:"box",width:a,height:n,directionOverride:0}),_n.spawnBurst({texture:"/res/particles/star.png",tint:16777215,lifetime:[.2,.5],alpha:{from:[.7,1],to:0},speed:{from:[0,1200],to:[0,600]},blendmode:PIXI.BLEND_MODES.ADD,scale:[xn.utils.scale(.1),xn.utils.scale(.3)],flickerfrequency:{from:[20,200],to:[10,20]},flickeramplitude:{from:[0,.5],to:[0,.1]}},{x:t+a/2,y:s+n/2,amount:xn.utils.freq(2*i),shape:"box",width:a,height:n,directionOverride:0})}}),xn.register("xp_ultra",{graphics:["ultra"],play:e=>{const{x:t=0,y:s=0,w:a=0,h:n=0}=e;_n.spawnBurst({texture:"/res/particles/star.png",tint:[16746496,16777028],lifetime:[.6,2.5],alpha:{from:[.7,1],to:0},speed:{from:[0,600],to:0},blendmode:PIXI.BLEND_MODES.ADD,scale:[xn.utils.scale(.15),xn.utils.scale(.5)],flickerfrequency:{from:[20,100],to:[10,20]},flickeramplitude:{from:[0,.5],to:[0,.1]}},{x:t+a/2,y:s+n/2,amount:xn.utils.freq(100),shape:"box",width:a,height:n,directionOverride:0}),_n.spawnBurst({texture:"/res/particles/star.png",tint:16777215,lifetime:[.6,1.5],alpha:{from:[.7,1],to:0},speed:{from:[0,2400],to:[0,300]},blendmode:PIXI.BLEND_MODES.ADD,scale:[xn.utils.scale(.1),xn.utils.scale(.3)],flickerfrequency:{from:[20,200],to:[10,20]},flickeramplitude:{from:[0,.5],to:[0,.1]}},{x:t+a/2,y:s+n/2,amount:xn.utils.freq(200),shape:"box",width:a,height:n,directionOverride:0}),_n.createSpawner({texture:"/res/particles/star.png",tint:[16746496,16777028],lifetime:[.2,1],alpha:{from:1,to:0},alphamultiplier:{from:0,to:3},speed:{from:[0,20],to:[0,20]},direction:[0,360],blendmode:PIXI.BLEND_MODES.ADD,scale:[xn.utils.scale(.1),xn.utils.scale(.3)]},{x:t+a/2,y:s+n/2,amount:xn.utils.freq(10),lifetime:6,shape:"rectangle",width:a,height:n})}}),xn.register("mm_ultra",{graphics:["ultra"],play:e=>{const t={texture:"/res/particles/beam.png",tint:16777215,lifetime:.6,alpha:1,speed:[2*window.innerWidth,5*window.innerWidth],blendmode:PIXI.BLEND_MODES.ADD,scale:[xn.utils.scale(.2),xn.utils.scale(.4)]};_n.createSpawner({...t,direction:-90,angle:-90},{x:0,y:0,amount:xn.utils.freq(50),shape:"line",linePointA:[window.innerWidth+200,0],linePointB:[window.innerWidth+200,window.innerHeight/2],lifetime:3.4}),_n.createSpawner({...t,direction:90,angle:90},{x:0,y:0,amount:xn.utils.freq(50),shape:"line",linePointA:[-200,window.innerHeight/2],linePointB:[-200,window.innerHeight],lifetime:3.4}),setTimeout((()=>{_n.spawnBurst({texture:"/res/particles/star.png",tint:16777215,lifetime:[.6,1.5],alpha:{from:[.7,1],to:0},speed:{from:[0,1200],to:[0,300]},blendmode:PIXI.BLEND_MODES.ADD,direction:[0,360],scale:[xn.utils.scale(.1),xn.utils.scale(.3)],flickerfrequency:{from:[20,200],to:[10,20]},flickeramplitude:{from:[0,.5],to:[0,.1]}},{x:0,y:0,amount:xn.utils.freq(200),shape:"line",linePointA:[0,.6*window.innerHeight],linePointB:[window.innerWidth,.4*window.innerHeight]});const e={texture:"/res/particles/fire.png",tint:[16736256,16777088],lifetime:[1.5,3],alpha:{from:[.05,.1],to:0},alphamultiplier:{from:0,to:3},speed:{from:[0,350],to:[0,700]},blendmode:PIXI.BLEND_MODES.ADD,scale:[xn.utils.scale(1.2),xn.utils.scale(4.5)],flurryfrequency:{from:[5,30],to:[2,10]},flurryamplitude:{from:[-130,130],to:[-30,30]},angle:[0,360],anglespeed:[-200,200]};_n.createSpawner({...e,direction:[-45,45],tint:[255,4521983]},{x:0,y:0,amount:xn.utils.freq(100),shape:"line",linePointA:[0,.4*window.innerHeight],linePointB:[window.innerWidth,.2*window.innerHeight],lifetime:8.5}),_n.createSpawner({...e,direction:[135,225],tint:[16711680,16746496]},{x:0,y:0,amount:xn.utils.freq(100),shape:"line",linePointA:[0,.8*window.innerHeight],linePointB:[window.innerWidth,.6*window.innerHeight],lifetime:8.5})}),3443)}}),xn.register("scoreslide_ultra",{graphics:["ultra"],play:e=>{const{right:t=!1}=e;_n.createSpawner({texture:"/res/particles/fire.png",tint:t?[16711680,16746496]:[255,4521983],lifetime:[1.5,3],alpha:{from:[.05,.1],to:0},alphamultiplier:{from:0,to:3},speed:{from:[0,1e3],to:[0,1800]},direction:t?[45,135]:[225,315],blendmode:PIXI.BLEND_MODES.ADD,scale:[xn.utils.scale(1.2),xn.utils.scale(4.5)],flurryfrequency:{from:[5,30],to:[2,10]},flurryamplitude:{from:[-30,30],to:[-30,30]},angle:[0,360],anglespeed:[-200,200]},{x:0,y:0,amount:xn.utils.freq(100),shape:"line",linePointA:[window.innerWidth/2+(t?100:-100),0],linePointB:[window.innerWidth/2+(t?100:-100),window.innerHeight],lifetime:2.5})}}),xn.register("zen_wormhole",{play:()=>{fn.createSpawner({texture:"/res/particles/smoke.png",tint:16777215,lifetime:[1,2],alpha:{from:[.2,.5],to:0},alphamultiplier:{from:0,to:4},speed:{from:[0,200],to:[0,200]},direction:[0,360],blendmode:PIXI.BLEND_MODES.ADD,scale:{start:[xn.utils.scale(.5),xn.utils.scale(2.5)],inc:[0,.01]}},{x:window.innerWidth/2,y:window.innerHeight/2,amount:xn.utils.freq(40),shape:"rectangle",width:window.innerWidth,height:0,lifetime:4.4}),fn.createSpawner({texture:"/res/particles/smoke.png",tint:16777215,lifetime:[.6,1.2],alpha:{from:[.2,.7],to:0},alphamultiplier:{from:0,to:4},speed:{from:[0,400],to:[0,400]},direction:[0,360],blendmode:PIXI.BLEND_MODES.ADD,scale:{start:[xn.utils.scale(.3),xn.utils.scale(.8)]}},{x:window.innerWidth/2,y:window.innerHeight/2,amount:xn.utils.freq(40),shape:"rectangle",width:window.innerWidth,height:0,lifetime:4.4});const e={texture:"/res/particles/beam.png",tint:16777215,lifetime:[.1,.3],alpha:{from:[.4,1],to:0},alphamultiplier:{from:0,to:4},speed:{from:[2400,3200],to:[3200,4e3]},blendmode:PIXI.BLEND_MODES.ADD,scale:{start:[xn.utils.scale(.2),xn.utils.scale(.4)]}};fn.createSpawner(e,{x:window.innerWidth/2,y:window.innerHeight,amount:xn.utils.freq(500),shape:"line",linePointA:[window.innerWidth/-2,window.innerHeight/-2-64],linePointB:[window.innerWidth/2,window.innerHeight/-2-64],angleOverride:0,directionOverride:0,lifetime:4.4}),fn.createSpawner(e,{x:window.innerWidth/2,y:0,amount:xn.utils.freq(500),shape:"line",linePointA:[window.innerWidth/-2,window.innerHeight/2+64],linePointB:[window.innerWidth/2,window.innerHeight/2+64],angleOverride:0,directionOverride:0,lifetime:4.4});const t={texture:"/res/particles/particle.png",tint:16777215,lifetime:[.3,.8],alpha:{from:[.6,1],to:0},alphamultiplier:{from:0,to:4},speed:{from:[600,1600],to:[1200,2e3]},blendmode:PIXI.BLEND_MODES.ADD,scale:{start:[xn.utils.scale(.05),xn.utils.scale(.2)]},flickerfrequency:{from:[20,100],to:[10,20]},flickeramplitude:{from:[0,.5],to:[0,.1]}};fn.createSpawner(t,{x:window.innerWidth/2,y:window.innerHeight,amount:xn.utils.freq(500),shape:"line",linePointA:[window.innerWidth/-2,window.innerHeight/-2-16],linePointB:[window.innerWidth/2,window.innerHeight/-2-16],angleOverride:0,directionOverride:0,lifetime:4.4}),fn.createSpawner(t,{x:window.innerWidth/2,y:0,amount:xn.utils.freq(500),shape:"line",linePointA:[window.innerWidth/-2,window.innerHeight/2+16],linePointB:[window.innerWidth/2,window.innerHeight/2+16],angleOverride:0,directionOverride:0,lifetime:4.4})}}),xn.register("zen_wormhole_exit",{play:()=>{fn.spawnBurst({texture:"/res/particles/smoke.png",tint:16777215,lifetime:[1.6,3.4],alpha:{from:[.5,1],to:0},alphamultiplier:{from:0,to:4},speed:{from:[0,400],to:[0,400]},direction:[0,360],blendmode:PIXI.BLEND_MODES.ADD,scale:{start:[xn.utils.scale(.3),xn.utils.scale(.8)]}},{x:window.innerWidth/2,y:window.innerHeight/2,amount:xn.utils.freq(40),shape:"rectangle",width:window.innerWidth,height:0}),fn.spawnBurst({texture:"/res/particles/particle.png",tint:16777215,lifetime:[2.6,5.6],alpha:{from:[.5,1],to:0},alphamultiplier:{from:0,to:4},speed:{from:[0,400],to:[0,400]},direction:[0,360],blendmode:PIXI.BLEND_MODES.ADD,scale:{start:[xn.utils.scale(.05),xn.utils.scale(.3)]}},{x:window.innerWidth/2,y:window.innerHeight/2,amount:xn.utils.freq(80),shape:"rectangle",width:window.innerWidth,height:window.innerHeight})}});const On=(()=>{const e={};let t=0;function s(t){e[t]&&(e[t].obj.destroy(),e[t].leader&&!e[t].leader._destroyed&&e[t].leader.destroy(),delete e[t])}return{create:function(s){let{pointA:a=[0,0],pointB:n=[0,0],type:o="garbage",intensity:i=1,duration:r=1,length:l=45,layer:c="front"}=s;if("minimal"===te.video.graphics)return;if("gui"===c&&(!Gn||"ultra"!==te.video.graphics))return;const d={gui:Gn?Gn.stage:null,front:Tn,back:qn}[c],p={gui:_n,front:fn,back:hn}[c],u=++t,m=$n(360*Math.random(),100,50);let g;i=Math.max(1,Math.min(20,i)),["high","ultra"].includes(te.video.graphics)&&(g=p.createSpawner({texture:"/res/particles/star.png",tint:m,lifetime:[.4,.7],alpha:{from:1,to:0},speed:{from:[0,100+i/20*300],to:0},anglespeed:{from:[0,400+i/20*1600],to:0},direction:[0,360],angle:[0,360],blendmode:PIXI.BLEND_MODES.ADD,scale:[xn.utils.scale(.2+i/20*.2),.3+i/20*.2]},{x:a[0],y:a[1],amount:xn.utils.freq(10+i/20*60),shape:"point",lifetime:-1}));const h=new Moonbeam.Beam({texture:"/res/particles/beams/beam.png",mode:"path",path:[new PIXI.Point(a[0],a[1]),new PIXI.Point((n[0]+a[0])/2+(Math.random()-.5)*(n[0]-a[0])+(Math.random()-.5)*(window.innerWidth/10),(n[1]+a[1])/2+(Math.random()-.5)*(n[1]-a[1])+(Math.random()-.5)*(window.innerHeight/10)),new PIXI.Point(n[0],n[1])],vertices:Math.round(l*r),length:Math.round(l*r),duration:r,tint:m,blendMode:PIXI.BLEND_MODES.ADD,scale:.5+i/20,smoothPath:!0,smoothVertices:!0,repeatTexture:!1,reverse:!1,leader:g,onHit:(t,s)=>{xn.play("garbage_beam_impact",{x:s.x,y:s.y,color:m,intensity:i}),g&&g.destroy(),delete e[u]}});return d.addChild(h),e[u]={id:u,obj:h,leader:g,options:s},u},destroy:s,destroyAll:function(){Object.keys(e).forEach((e=>{s(e)}))},getBeam:function(t){return e[id]}}})();let Pn,Dn,Nn,Fn;function Un(e,t,s){const a=document.createElement("canvas"),n=a.getContext("2d");a.height=t,a.width=e;const o=n.createLinearGradient(0,0,0,t);return s.forEach((e=>{o.addColorStop(e[0],e[1])})),n.fillStyle=o,n.fillRect(0,0,e,t),new PIXI.Texture.fromCanvas(a)}U.ready((function(e){let t=null,s=null;Pn=function(){function e(){t&&t.destroy(),s&&s.destroy()}function a(){e(),t=hn.createSpawner({texture:"/res/particles/bigbox.png",tint:16777215,lifetime:[1,30],alpha:{from:[.02,.15],to:0},alphamultiplier:{from:0,to:2},speed:{from:[0,45],to:[0,20]},direction:[0,360],scale:[xn.utils.scale(.02),xn.utils.scale(.3)],wrap:!0},{shape:"rectangle",x:window.innerWidth/2,y:window.innerHeight/2,width:window.innerWidth,height:window.innerHeight,amount:xn.utils.freq(3.5),lifetime:-1}),s=hn.createSpawner({texture:"/res/particles/particle.png",tint:16777215,lifetime:[1,30],alpha:{from:[.05,.5],to:0},alphamultiplier:{from:0,to:2},speed:{from:[0,60],to:[0,30]},direction:[0,360],scale:[xn.utils.scale(.02),xn.utils.scale(.25)],wrap:!0},{shape:"rectangle",x:window.innerWidth/2,y:window.innerHeight/2,width:window.innerWidth,height:window.innerHeight,amount:xn.utils.freq(10),lifetime:-1})}return{set:function(){"high"!==te.video.graphics&&"ultra"!==te.video.graphics||a()},unset:function(){e()},resize:function(){"high"!==te.video.graphics&&"ultra"!==te.video.graphics||a()}}}(),Dn=function(){let e,t,s=1,a=1,n=!1;function o(t){const s=t||e;if(!s)return;Fn.position.set(window.innerWidth/2,window.innerHeight/2);window.innerWidth/window.innerHeight>s.texture.width/s.texture.height?s.scale.set(window.innerWidth/s.texture.width,window.innerWidth/s.texture.width):s.scale.set(window.innerHeight/s.texture.height,window.innerHeight/s.texture.height)}return PIXI.Ticker.shared.add((t=>{if(!e||n)return;if("minimal"===te.video.graphics)return;const o=s,i=e.alpha;if(i===o);else if(Math.round(100*i)===Math.round(100*o)){e.alpha=o;const t=void 0===te.video.bloom?1:te.video.bloom;0!=te.video.bloom&&Kn&&"ultra"===te.video.graphics&&(Kn.threshold=.35+.15*o,Kn.bloomScale=(.45+-.3*o)*t,Kn.blur=(7+-5*o)*t)}else{const s=o+(i-o)*Math.pow(.9,t);e.alpha=s;const a=void 0===te.video.bloom?1:te.video.bloom;0!=te.video.bloom&&Kn&&"ultra"===te.video.graphics&&(Kn.threshold=.35+.15*s,Kn.bloomScale=(.45+-.3*s)*a,Kn.blur=(7+-5*s)*a)}const r=a,l=Fn.scale.x;if(l===r);else if(Math.round(1e3*l)===Math.round(1e3*r))Fn.scale.set(r,r);else{const e=r+(l-r)*Math.pow(.9,t);Fn.scale.set(e,e)}}),this),{setBackground:(s,a)=>{if(t===s)return;a||(n=!0),t=s;let i=0;e&&(a?e.destroy():(go.animate(e,{0:{alpha:1},1:{alpha:0}},.5,void 0,(e=>{e.destroy()})),i=800));const r=PIXI.Sprite.from(s);r.alpha=0,r.anchor.set(.5,.5),Fn.addChild(r),e=r;let l=Date.now();const c=()=>{o(r),a?r.alpha=1:setTimeout((()=>{go.animate(r,{0:{alpha:0},1:{alpha:1}},.5,void 0,(()=>{n=!1}))}),Math.max(0,i-(Date.now()-l)))};r.texture.valid?c():r.texture.once("update",c)},fit:e=>{o(e)},opacity:e=>{"low"!==te.video.graphics&&"minimal"!==te.video.graphics&&(s=e)},scale:e=>{"low"!==te.video.graphics&&"minimal"!==te.video.graphics&&(a=e)}}}()})),window.DEVHOOK_BG_ANIM=(e=100)=>{let t=0,s=!1;console.warn("The background will flash and errors may appear while the frames of the animation load in, please hang tight..."),setInterval((()=>{t++,t>32&&(t=1,s||(console.warn("Backgrounds have been loaded in."),s=!0)),Dn.setBackground(`https://kagari.moe/:/bggame${t}.png`,!0)}),e)};const Bn=(()=>{const e=new Map,t={hun:{fnt:"res/font/hun.fnt",type:"sdf",rasterizeSize:1024}};let s=0;const a=[];return g((()=>{U.setState("fonts",`loading fonts (${s}/${Object.keys(t).length})`),Object.keys(t).forEach((n=>{const o=new TheoryType.Font({...t[n],onload:()=>{e.set(n,o),s++,U.setState("fonts",`loading fonts (${s}/${Object.keys(t).length})`),s>=Object.keys(t).length&&(a.forEach((e=>{e()})),U.finishLoad("fonts"))}})}))})),{get:t=>e.get(t),ready:e=>{s>=Object.keys(t).length?e():a.push(e)},setRasterizeRenderer:t=>{for(const[,s]of e)s.setRasterizeRenderer(t)}}})(),Xn=(()=>{const e=["/res/particles/beam.png","/res/particles/bigbox.png","/res/particles/bokeh.png","/res/particles/box.png","/res/particles/chip.png","/res/particles/chirp.png","/res/particles/dust.png","/res/particles/fire.png","/res/particles/flare.png","/res/particles/fbox.png","/res/particles/particle.png","/res/particles/smoke.png","/res/particles/star.png","/res/particles/spark.png","/res/particles/beams/beam.png","/res/cutin/superlobby/backing.png"];let t=0,s=0;const a=[];return g((()=>{U.setState("textures",`loading textures (${t}/${e.length})`),e.forEach((n=>{const o=PIXI.Texture.from(n),i=()=>{t++,U.setState("textures",`loading textures (${t}/${e.length})`),t>=e.length&&(a.forEach((e=>{e()})),U.finishLoad("textures"),s&&T(`${s} texture${1===s?"":"s"} failed to load. make sure your internet connection is stable. if you run into any issues, please reload the page.`))};o.baseTexture.valid?i():(o.baseTexture.once("loaded",(()=>{i()})),o.baseTexture.once("error",(e=>{console.error(`Texture ${n} failed to load!`,e.event),s++,i()})))}))})),{ready:s=>{t>=e.length?s():a.push(s)}}})();let zn,Gn,jn,Wn,qn,Kn;PIXI.settings.FAIL_IF_MAJOR_PERFORMANCE_CAVEAT=!1,g((()=>{PIXI.utils.skipHello(),Bn.ready((()=>{null===localStorage.getItem("feecofScore")?(console.log("Eligible for feecof test."),U.setState("feecof","initializing benchmark..."),setTimeout((()=>{console.log("Feecof test starting..."),U.setState("feecof","running benchmark...");const e=document.createElement("canvas");e.setAttribute("width","640"),e.setAttribute("height","320"),e.setAttribute("style","position:fixed;left:100vw;top:0;opacity:0;will-change:transform;pointer-events:none;"),document.body.appendChild(e),Feecof({view:e,speed:100,smartstop:!0,maxcount:10,mincount:3,img:"/res/kagari.png",font:Bn.get("hun"),maxtime:3e4},(t=>{if(e.remove(),t.success){localStorage.setItem("feecofScore",t.feecof),console.log(`Feecof test completed with score of ${t.feecof} feecof.`);try{_paq.push(["trackEvent","Performance","Feecof","Complete",t.feecof])}catch(e){}U.finishLoad("feecof")}else{console.error("Feecof test did not complete. Will try again next time.");try{_paq.push(["trackEvent","Performance","Feecof","Failure"])}catch(e){}U.finishLoad("feecof")}}))}),1500)):U.finishLoad("feecof")}))}));const Yn={vertices:!1,position:!0,rotation:!1,uvs:!1,tint:!0},Vn={vertices:!0,position:!0,rotation:!0,uvs:!1,tint:!0};let Zn=!0,Jn=0;function Qn(){zn.renderer.resize(window.innerWidth,window.innerHeight),Gn&&Gn.renderer.resize(window.innerWidth,window.innerHeight),to(),Zn=!0}function eo(e){if(window.IS_ELECTRON)switch(te.electron.frameratelimit){case"1x":PIXI.Ticker.shared.maxFPS=e||window.REFRESH_RATE||60;break;case"2x":PIXI.Ticker.shared.maxFPS=e||2*(window.REFRESH_RATE||60);break;case"off":PIXI.Ticker.shared.maxFPS=e||0;break;default:PIXI.Ticker.shared.maxFPS=e||4*(window.REFRESH_RATE||60)}else PIXI.Ticker.shared.maxFPS=e||0}function to(){if(jn){if("ultra"!==te.video.graphics)return jn.filters=null,void(jn.filterArea=null);if(jn.filters=[],0!=te.video.bloom){const e=void 0===te.video.bloom?1:te.video.bloom;Kn=new PIXI.filters.AdvancedBloomFilter({threshold:.5,bloomScale:.15*e,brightness:1,blur:2*e,quality:Math.floor(Math.min(Math.max(4,e+2),20))}),jn.filters.push(Kn)}if(0!=te.video.chroma){const e=void 0===te.video.chroma?.5:te.video.chroma;jn.filters.push(new PIXI.filters.RGBSplitFilter(new PIXI.Point(0,-e),new PIXI.Point(0,0),new PIXI.Point(-e,0)))}jn.filterArea=new PIXI.Rectangle(0,0,window.innerWidth,window.innerHeight),zn.stage.filterArea=new PIXI.Rectangle(0,0,window.innerWidth,window.innerHeight)}}function so(e){for(;e.children.length;){e.children[0].destroy()}}function ao(e,t,s){const a=e.worldTransform.apply(new PIXI.Point(t,s));return{x:a.x,y:a.y}}function no(e,t,s,a=1){const n=e.getGlobalPosition(void 0,!0);return{x:n.x+t*a,y:n.y+s*a}}function oo(e,t,s){const a=new PIXI.BaseRenderTexture({width:e,height:t}),n=new PIXI.RenderTexture(a);return zn.renderer.render(s,{renderTexture:n}),a}function io(e,t){const s=new PIXI.BaseRenderTexture({width:256*e,height:256*e}),a=new PIXI.RenderTexture(s),n=new PIXI.Container;for(let s=0;s<25;s++){const a=s%5,o=Math.floor(s/5),i=s/25,r=46*e,l=new PIXI.Sprite(t);l.position.set(e*(1+48*a),e*(1+48*o)),l.filters=[new PIXI.filters.AdjustmentFilter({contrast:0,brightness:2})];const c=new PIXI.Graphics;c.beginFill(16711680,1),i<=.5?c.drawShape(new PIXI.Polygon([r*i*2,0,r,0,r,r,0,r,0,r*i*2])):c.drawShape(new PIXI.Polygon([r,r*i*2-r,r,r,r*i*2-r,r])),c.endFill(),c.position.set(e*(1+48*a),e*(1+48*o)),l.mask=c,n.addChild(l),n.addChild(c)}return zn.renderer.render(n,{renderTexture:a}),s}U.ready((function(t){switch(te.video.webgl){case"legacy":PIXI.settings.PREFER_ENV=PIXI.ENV.WEBGL_LEGACY;break;case"webgl1":PIXI.settings.PREFER_ENV=PIXI.ENV.WEBGL;break;default:PIXI.settings.PREFER_ENV=PIXI.ENV.WEBGL2}if("low"!==te.video.graphics&&"minimal"!==te.video.graphics||(PIXI.settings.PRECISION_FRAGMENT=PIXI.PRECISION.LOW,PIXI.settings.PRECISION_VERTEX=PIXI.PRECISION.LOW),"minimal"===te.video.graphics&&(PIXI.settings.SCALE_MODE=PIXI.SCALE_MODES.NEAREST),zn=new PIXI.Application({width:256,height:256,view:e("pixi"),antialias:"low"!==te.video.graphics&&"minimal"!==te.video.graphics,transparent:!1,powerPreference:te.video.powersave?"default":"high-performance",forceFXAA:"high"!==te.video.graphics&&"ultra"!==te.video.graphics,sharedTicker:"minimal"!==te.video.graphics,autoDensity:!0,clearBeforeRender:!1,resolution:te.video.lowres?.7:window.devicePixelRatio,autoStart:"minimal"!==te.video.graphics}),PIXI.Ticker.shared.maxFPS=0,"ultra"===te.video.graphics&&(Gn=new PIXI.Application({width:256,height:256,view:e("pixi-fg"),antialias:!1,transparent:!0,powerPreference:te.video.powersave?"default":"high-performance",forceFXAA:!1,sharedTicker:!0,autoDensity:!0,resolution:te.video.lowres?.7:window.devicePixelRatio,autoStart:!0})),"minimal"===te.video.graphics){const e=new PIXI.Ticker;e.add((()=>{(Jn>0||Zn)&&(zn.renderer.render(zn.stage),Zn=!1)}),zn,PIXI.UPDATE_PRIORITY.LOW),e.start()}if(zn&&zn.renderer&&zn.renderer.type===PIXI.RENDERER_TYPE.WEBGL?console.log(`%cPixiJS ${PIXI.VERSION} - ${2===zn.renderer.context.webGLVersion?"WebGL 2":"WebGL 1"}${PIXI.settings.PREFER_ENV===PIXI.ENV.WEBGL_LEGACY?" (LEGACY)":""}`,`color: ${2===zn.renderer.context.webGLVersion?"#F3C0E6":"#D9C0F3"};\n\t\t\t\t\t font-size: 1.2em;\n\t\t\t\t\t font-weight: 900;\n\t\t\t\t\t text-shadow: 0px 0px 2px ${2===zn.renderer.context.webGLVersion?"#BA509B":"#7050BA"};\n\t\t\t\t\t background-color: ${2===zn.renderer.context.webGLVersion?"#50344988":"#3D345088"};\n\t\t\t\t\t padding: 0 1em;\n\t\t\t\t\t border-radius: 3px;`):zn&&zn.renderer&&zn.renderer.type===PIXI.RENDERER_TYPE.CANVAS?(console.log(`%cPixiJS ${PIXI.VERSION} - Canvas`,"color: #F97676;\n\t\t\t\t\t font-size: 1.2em;\n\t\t\t\t\t font-weight: 900;\n\t\t\t\t\t text-shadow: 0px 0px 2px #BA5050;\n\t\t\t\t\t background-color: #87353588;\n\t\t\t\t\t padding: 0 1em;\n\t\t\t\t\t border-radius: 3px;"),console.error("Canvas renderers are not supported.")):(console.log(`%cPixiJS ${PIXI.VERSION} - No renderer`,"color: #FFFFFF;\n\t\t\t\t\t font-size: 1.2em;\n\t\t\t\t\t font-weight: 900;\n\t\t\t\t\t text-shadow: 0px 0px 2px #FFFFFF;\n\t\t\t\t\t background-color: #FF0000;\n\t\t\t\t\t padding: 0 1em;\n\t\t\t\t\t border-radius: 3px;"),console.error("No supported renderer found. Cannot launch.")),console.log(`%c- ${navigator.userAgent?navigator.userAgent:"Unknown browser"} -\nCPU: ${navigator.hardwareConcurrency?`${navigator.hardwareConcurrency}-core`:"<unknown>"}\nMemory: ${navigator.deviceMemory?`~${navigator.deviceMemory} GB`:"<unknown>"}\nConnection: ${navigator.connection?`${navigator.connection.downlink} Mbps, ${navigator.connection.rtt}ms RTT [${navigator.connection.effectiveType}]`:"<unknown>"}`,"color: #FFFFFF88;\n\t\t\t\t\t\t font-size: 1.2em;\n\t\t\t\t\t\t font-weight: 900;\n\t\t\t\t\t\t text-shadow: 0px 0px 2px #FFFFFF88;\n\t\t\t\t\t\t background-color: #111111AA;\n\t\t\t\t\t\t padding: 0 1em;\n\t\t\t\t\t\t border-radius: 3px;"),zn&&zn.renderer){const t=zn.renderer.gl.getExtension("WEBGL_debug_renderer_info");t&&(console.log(`%cRenderer: ${zn.renderer.gl.getParameter(t.UNMASKED_RENDERER_WEBGL)}`,"color: #FFFFFF88;\n\t\t\t\t\t\t font-size: 1.2em;\n\t\t\t\t\t\t font-weight: 900;\n\t\t\t\t\t\t text-shadow: 0px 0px 2px #FFFFFF88;\n\t\t\t\t\t\t background-color: #111111AA;\n\t\t\t\t\t\t padding: 0 1em;\n\t\t\t\t\t\t border-radius: 3px;"),e("rendererinfo").textContent=`${2===zn.renderer.context.webGLVersion?"WebGL 2":"WebGL 1"}${PIXI.settings.PREFER_ENV===PIXI.ENV.WEBGL_LEGACY?" (LEGACY)":""} | ${zn.renderer.gl.getParameter(t.UNMASKED_RENDERER_WEBGL)}`)}if(Bn.setRasterizeRenderer(zn.renderer),Qn(),zn.stage.filters=null,Fn=new PIXI.Container,Fn.name="bgImgContainer",Fn.interactive=!1,Fn.interactiveChildren=!1,Fn.alpha=te.video.background,zn.stage.addChild(Fn),Nn=new PIXI.Container,Nn.name="bgContainer",Nn.interactive=!1,Nn.interactiveChildren=!1,Nn.alpha=Math.min(1,10*(te.video.background||0)),zn.stage.addChild(Nn),hn=new Regolith.ParticleManager,Nn.addChild(hn),Pn.set(),jn=new PIXI.Container,jn.name="gScene",zn.stage.addChild(jn),qn=new PIXI.Container,qn.name="gSceneBG",jn.addChild(qn),Wn=new PIXI.Container,Wn.name="gSceneFG",jn.addChild(Wn),Tn=new PIXI.Container,Tn.name="fxContainer",Tn.interactive=!1,Tn.interactiveChildren=!1,zn.stage.addChild(Tn),fn=new Regolith.ParticleManager,Tn.addChild(fn),Gn&&(Gn.stage.interactive=!1,Gn.stage.interactiveChildren=!1,_n=new Regolith.ParticleManager,Gn.stage.addChild(_n)),e("pixi").addEventListener("webglcontextlost",(()=>{ut(),e("dirtyflag_gl").innerHTML="CRASHED",D({title:"WEBGL CRASHED",msg:'an error has caused WEBGL to crash.</p><p>this could be caused by many issues, like a driver error, a GPU error, a browser error or insufficient resources.</p><p class="modal_also">you can choose to continue the current session, which may not work properly, or reload to try again. sometimes, exiting the ongoing game can fix the error.',classes:["crash_modal","noclickout"],buttons:[{label:"CONTINUE",classes:[],callback:e=>{e(),gt()}},{label:"RESTART",classes:["pri"],callback:e=>{e(),F=!0,location.reload()}}]})})),Zn=!0,window.IS_ELECTRON){let e=0,t=0,s=0,a=!1;PIXI.Ticker.shared.add((()=>{e++}),this),setInterval((()=>{if(t!==e)return t=e,a?void(a=!1):void(s=0);s++,s>=3&&(a=!0,PIXI.Ticker.shared.update())}),100)}to()}));const ro="0123456789#%&()*+,-./:<=>?ABCDEFGHIJKLMNOPQRSTUVWXYZ",lo="";function co(e){let t="";for(let s=0;s<e.length;s++){const a=ro.indexOf(e[s]);t+=-1===a?e[s]:lo[a]}return t}const po=(()=>{let e=[];function t(t){e=e.filter((e=>e.name!==t.name))}function s(t){const s=e.filter((e=>e.name===t));return s?s[0]:void 0}return{register:(a,n,o=[])=>{Array.isArray("array")||(o=[o]);const i=s(n);i&&t(i),e.push({obj:a,name:n,classes:o})},unregister:e=>{Array.isArray(e)?e.forEach((e=>{t(e)})):t(e)},unregisterStartingWith:t=>{e=e.filter((e=>!e.name.startsWith(t)))},get:e=>s(e),getAll:t=>function(t){return e.filter((e=>e.classes.includes(t)))||[]}(t)}})(),uo={0:{y:0},1:{y:500}},mo=BezierEasing(0,0,1,1),go=(()=>{const e={};let t=0;function s(e,t,s){const a=Object.keys(t).sort(((e,t)=>parseFloat(e)-parseFloat(t)));let n=0;for(let e=a.length-2;e>=0;e--)if(parseFloat(a[e])<=s){n=a[e];break}let o=1;for(let e=1;e<a.length;e++)if(parseFloat(a[e])>s){o=a[e];break}Object.keys(t[0]).forEach((a=>{let i=t[n][a],r=t[o][a];"inherit"===i&&(t[n][a]=getSetDescendantProp(e,a),i=t[n][a]),"inherit"===r&&(t[o][a]=getSetDescendantProp(e,a),r=t[o][a]),"string"==typeof i&&"r"===i.slice(-1)&&(i=Ls(parseFloat(i.slice(0,-1)))),"string"==typeof r&&"r"===r.slice(-1)&&(r=Ls(parseFloat(r.slice(0,-1)))),getSetDescendantProp(e,a,function(e,t,s,a,n){return a+(s-e)/(t-e)*(n-a)}(n,o,s,i,r))}))}function a(t,a=null){null!==a&&e[t]&&e[t].obj&&!e[t].obj._destroyed&&s(e[t].obj,e[t].animation,a),delete e[t],Jn--}return PIXI.Ticker.shared.add((function(t){Object.keys(e).forEach((n=>{const o=e[n];o.obj._destroyed?a(n):(o.progress=Math.min(1,o.progress+o.speed*t),s(o.obj,o.animation,o.curve(o.progress)),o.progress>=1&&(o.onend(o.obj),a(n,1)))}))})),{animate:(s,a,n,o,i=(()=>{}))=>function(s,a,n,o,i){const r=""+ ++t;return e[r]={obj:s,animation:a,speed:1/(60*n),progress:0,curve:void 0!==o?o:mo,onend:i},Jn++,r}(s,a,n,o,i),stop(e,t=null){a(e,t)}}})(),ho=1.8,fo={x:30};function _o(){return window.innerWidth>1920||window.innerHeight>1080?"uhd":"hd"}const bo={255:"NM_MID",241:"VS_TOP",17:"VS_MID",31:"VS_BTM",81:"VS_TOP",95:"NM_MID",245:"NM_MID",21:"VS_BTM",85:"NM_MID",199:"HS_LFT",68:"HS_MID",124:"HS_RGT",201:"CN_TLF",114:"CN_TRG",156:"CN_BRG",39:"CN_BLF",220:"HS_RGT",103:"HS_LFT",205:"HS_LFT",118:"HS_RGT",64:"ED_TOP",16:"ED_RGT",4:"ED_BTM",1:"ED_LFT",80:"SQ_TRG",65:"SQ_TLF",20:"SQ_BRG",5:"SQ_BLF",84:"HS_RGT",69:"HS_LFT",0:"MM_MID",193:"SQ_TLF",112:"SQ_TRG",28:"SQ_BRG",7:"SQ_BLF",92:"HS_RGT",71:"HS_LFT",197:"HS_LFT",116:"HS_RGT",164:"TS_TOP",41:"TS_RGT",74:"TS_BTM",146:"TS_LFT",228:"HS_MID",105:"CN_TLF",210:"CN_TRG",45:"CN_BLF",78:"HS_MID",150:"CN_BRG",109:"HS_LFT",214:"HS_RGT"},yo={NM_MID:[0,3],VS_TOP:[0,0],VS_MID:[0,1],VS_BTM:[0,2],HS_LFT:[1,3],HS_MID:[2,3],HS_RGT:[3,3],CN_TLF:[0,4],CN_TRG:[1,4],CN_BRG:[1,5],CN_BLF:[0,5],ED_TOP:[2,0],ED_RGT:[3,1],ED_BTM:[2,2],ED_LFT:[1,1],MM_MID:[2,1],SQ_TLF:[1,0],SQ_TRG:[3,0],SQ_BRG:[3,2],SQ_BLF:[1,2],TS_TOP:[2,4],TS_RGT:[3,4],TS_BTM:[2,5],TS_LFT:[3,5]},vo={NM_MID:[0,3],VS_TOP:[0,0],VS_MID:[0,1],VS_BTM:[0,2],HS_LFT:[1,3],HS_MID:[2,3],HS_RGT:[3,3],ED_TOP:[2,0],ED_RGT:[3,1],ED_BTM:[2,2],ED_LFT:[1,1],MM_MID:[2,1],SQ_TLF:[1,0],SQ_TRG:[3,0],SQ_BRG:[3,2],SQ_BLF:[1,2]};function wo(e,t,s,a,n,o){const i={};return Object.keys(t).forEach((r=>{i[r]=new PIXI.Texture(e,new PIXI.Rectangle(a+(t[r][0]+n)*(s+2*a),a+(t[r][1]+o)*(s+2*a),s,s))})),i}window.DEVHOOK_CONNECTED_SKIN=()=>{ko.tetrio=ko.connected_test,Lo.tetrio=Lo.connected_test};const ko={tetrio:{id:"tetrio",name:"TETR.IO",assets:{hd:{url:"/res/skins/minos/tetrio.png",loaded:!1,loading:!1,basetexture:null,textures:{}},uhd:{url:"/res/skins/minos/tetrio.2x.png",loaded:!1,loading:!1,basetexture:null,textures:{}}},format:"simple",colors:{base:{z:13521497,l:13533522,o:13550930,s:8441426,i:5426860,j:6705870,t:12800718,d:4605510,gb:6181727,gbd:2359335},glow:{z:16744069,l:16749136,o:16773982,s:10813295,i:8716253,j:10324735,t:16091903,d:6250335,gb:12956103,gbd:4405060}}},connected_test:{id:"connected_test",name:"Connected skin test",assets:{hd:{url:"/res/skins/minos/connected.png",loaded:!1,loading:!1,basetexture:null,textures:{}},uhd:{url:"/res/skins/minos/connected.2x.png",loaded:!1,loading:!1,basetexture:null,textures:{}}},format:"connected",colors:{base:{z:16727357,l:16750653,o:16580413,s:5111613,i:4063176,j:4020223,t:15678975,d:6250335,gb:10066329,gbd:6634081},glow:{z:16744069,l:16749136,o:16773982,s:10813295,i:8716253,j:10324735,t:16091903,d:6250335,gb:12956103,gbd:4405060}}}},Lo={tetrio:{id:"tetrio",name:"TETR.IO",assets:{hd:{url:"/res/skins/ghost/tetrio.png",loaded:!1,loading:!1,basetexture:null,textures:{}},uhd:{url:"/res/skins/ghost/tetrio.2x.png",loaded:!1,loading:!1,basetexture:null,textures:{}}},format:"simple",colorizeGhost:!0,colorizeX:!1},connected_test:{id:"connected_test",name:"Connected skin test",assets:{hd:{url:"/res/skins/ghost/connected.png",loaded:!1,loading:!1,basetexture:null,textures:{}},uhd:{url:"/res/skins/ghost/connected.2x.png",loaded:!1,loading:!1,basetexture:null,textures:{}}},format:"connected",colorizeGhost:!0,colorizeX:!1}},Eo=(()=>{function e(e,t,s=255,a=1,n={}){let o=ko[e];o||(e="tetrio",o=ko.tetrio);const i=new PIXI.Sprite(PIXI.Texture.WHITE);return i.width=Ls(fo.x)*a,i.height=Ls(fo.x)*a,i.tint=o.colors.base[t]||o.colors.base[t.replace("s_","")]||0,i}function t(e){const t=ko[e];if(!t)return;const a=_o(),n=t.assets[a];n.loaded||n.loading||(n.loading=!0,n.baseTexture=new PIXI.BaseTexture(n.url),n.baseTexture.valid?s(t,n,a):n.baseTexture.on("loaded",(()=>{s(t,n,a)})))}function s(e,t,s){t.textures=xo[e.format](t,t.baseTexture,s),t.loaded=!0,vs()}return{generate:function(s,a,n=255,o=1,i={}){let r=ko[s];if(r||(s="tetrio",r=ko.tetrio),!r.assets[_o()].loaded)return r.assets[_o()].loading||t(s),e(s,a,n,o,i);let l=PIXI.Texture.WHITE;switch(r.assets[_o()].textures.format){case"10":l=r.assets[_o()].textures[a];break;case"wang24":l=r.assets[_o()].textures[a][bo[n]||255]}const c=new PIXI.Sprite(l);return c.width=Ls(fo.x)*o,c.height=Ls(fo.x)*o,c},generatePlaceholder:e,generateFlash:function(e){let t=ko[e];if(t||(e="tetrio",t=ko.tetrio),!t.assets[_o()].loaded||!t.assets[_o()].textures.flashsheet)return;const s=new PIXI.AnimatedSprite(t.assets[_o()].textures.flashsheet,!0);return s.loop=!1,s.animationSpeed=2,s.onComplete=()=>{s.destroy()},s.play(),go.animate(s,{0:{alpha:.3},1:{alpha:.2}},.2,BezierEasing(.02,.58,0,.88)),s},getColor:function(e,t,s=!1){let a=ko[e];a||(e="tetrio",a=ko.tetrio);const n=a.colors.base[t]||0;return s?`#${n.toString(16).padStart(6,"0")}`:n},getGlowColor:function(e,t,s=!1){let a=ko[e];a||(e="tetrio",a=ko.tetrio);const n=a.colors.glow[t]||0;return s?`#${n.toString(16).padStart(6,"0")}`:n},load:t}})(),xo={simple:(e,t,s)=>{const a=new PIXI.Sprite(new PIXI.Texture(t));a.filters=[new PIXI.filters.AdjustmentFilter({brightness:1.2,contrast:1.2})];const n=oo("uhd"===s?512:256,"uhd"===s?512:256,a),o="uhd"===s?92:46,i="uhd"===s?2:1,r=[],l=io("uhd"===s?2:1,new PIXI.Texture(t,new PIXI.Rectangle(i,i,o,o)));for(let e=0;e<25;e++){const t=e%5,s=Math.floor(e/5);r.push(new PIXI.Texture(l,new PIXI.Rectangle(i+t*(o+2*i),i+s*(o+2*i),o,o)))}return{format:"10",z:new PIXI.Texture(t,new PIXI.Rectangle(i+0*(o+2*i),i+0*(o+2*i),o,o)),l:new PIXI.Texture(t,new PIXI.Rectangle(i+1*(o+2*i),i+0*(o+2*i),o,o)),o:new PIXI.Texture(t,new PIXI.Rectangle(i+2*(o+2*i),i+0*(o+2*i),o,o)),s:new PIXI.Texture(t,new PIXI.Rectangle(i+3*(o+2*i),i+0*(o+2*i),o,o)),i:new PIXI.Texture(t,new PIXI.Rectangle(i+4*(o+2*i),i+0*(o+2*i),o,o)),j:new PIXI.Texture(t,new PIXI.Rectangle(i+0*(o+2*i),i+1*(o+2*i),o,o)),t:new PIXI.Texture(t,new PIXI.Rectangle(i+1*(o+2*i),i+1*(o+2*i),o,o)),d:new PIXI.Texture(t,new PIXI.Rectangle(i+2*(o+2*i),i+1*(o+2*i),o,o)),gb:new PIXI.Texture(t,new PIXI.Rectangle(i+3*(o+2*i),i+1*(o+2*i),o,o)),gbd:new PIXI.Texture(t,new PIXI.Rectangle(i+4*(o+2*i),i+1*(o+2*i),o,o)),s_z:new PIXI.Texture(n,new PIXI.Rectangle(i+0*(o+2*i),i+0*(o+2*i),o,o)),s_l:new PIXI.Texture(n,new PIXI.Rectangle(i+1*(o+2*i),i+0*(o+2*i),o,o)),s_o:new PIXI.Texture(n,new PIXI.Rectangle(i+2*(o+2*i),i+0*(o+2*i),o,o)),s_s:new PIXI.Texture(n,new PIXI.Rectangle(i+3*(o+2*i),i+0*(o+2*i),o,o)),s_i:new PIXI.Texture(n,new PIXI.Rectangle(i+4*(o+2*i),i+0*(o+2*i),o,o)),s_j:new PIXI.Texture(n,new PIXI.Rectangle(i+0*(o+2*i),i+1*(o+2*i),o,o)),s_t:new PIXI.Texture(n,new PIXI.Rectangle(i+1*(o+2*i),i+1*(o+2*i),o,o)),flashsheet:r}},connected:(e,t,s)=>{const a=new PIXI.Sprite(new PIXI.Texture(t));a.filters=[new PIXI.filters.AdjustmentFilter({brightness:1.2,contrast:1.2})];const n=oo("uhd"===s?2048:1024,"uhd"===s?2048:1024,a),o="uhd"===s?92:46,i="uhd"===s?2:1,r=[],l=io("uhd"===s?2:1,new PIXI.Texture(t,new PIXI.Rectangle(i,i,o,o)));for(let e=0;e<25;e++){const t=e%5,s=Math.floor(e/5);r.push(new PIXI.Texture(l,new PIXI.Rectangle(i+t*(o+2*i),i+s*(o+2*i),o,o)))}return{format:"wang24",z:wo(t,yo,o,i,0,0),l:wo(t,yo,o,i,4,0),o:wo(t,yo,o,i,8,0),s:wo(t,yo,o,i,12,0),i:wo(t,yo,o,i,0,6),j:wo(t,yo,o,i,4,6),t:wo(t,yo,o,i,8,6),d:wo(t,yo,o,i,12,6),gb:wo(t,vo,o,i,16,0),gbd:wo(t,vo,o,i,16,4),s_z:wo(n,yo,o,i,0,0),s_l:wo(n,yo,o,i,4,0),s_o:wo(n,yo,o,i,8,0),s_s:wo(n,yo,o,i,12,0),s_i:wo(n,yo,o,i,0,6),s_j:wo(n,yo,o,i,4,6),s_t:wo(n,yo,o,i,8,6),flashsheet:r}}},To=(()=>{function e(e,t,s=255,a=1,n={}){let o=Lo[e];o||(e="tetrio",o=Lo.tetrio);const i=new PIXI.Sprite(PIXI.Texture.WHITE);return i.width=Ls(fo.x)*a,i.height=Ls(fo.x)*a,"x"===t&&(i.tint=16711680,i.alpha=.25),i}function t(e){const t=Lo[e];if(!t)return;const a=_o(),n=t.assets[a];n.loaded||n.loading||(n.loading=!0,n.baseTexture=new PIXI.BaseTexture(n.url),n.baseTexture.valid?s(t,n,a):n.baseTexture.on("loaded",(()=>{s(t,n,a)})))}function s(e,t,s){t.textures=Io[e.format](t,t.baseTexture,s),t.loaded=!0,vs()}return{generate:function(s,a,n=255,o=1,i={}){let r=Lo[s];if(r||(s="tetrio",r=Lo.tetrio),!r.assets[_o()].loaded)return r.assets[_o()].loading||t(s),e(s,a,n,o,i);let l=PIXI.Texture.WHITE;switch(r.assets[_o()].textures.format){case"2":l=r.assets[_o()].textures[a];break;case"wang24":l=r.assets[_o()].textures[a][bo[n]||255]}const c=new PIXI.Sprite(l);return c.width=Ls(fo.x)*o,c.height=Ls(fo.x)*o,c},generatePlaceholder:e,load:t}})(),Io={simple:(e,t,s)=>{const a="uhd"===s?92:46,n="uhd"===s?2:1;return{format:"2",g:new PIXI.Texture(t,new PIXI.Rectangle(n+0*(a+2*n),n+0*(a+2*n),a,a)),x:new PIXI.Texture(t,new PIXI.Rectangle(n+1*(a+2*n),n+0*(a+2*n),a,a))}},connected:(e,t,s)=>{const a="uhd"===s?92:46,n="uhd"===s?2:1;return{format:"wang24",g:wo(t,yo,a,n,0,0),x:wo(t,yo,a,n,4,0)}}},So={superlobby:{timeout:3500,starter:e=>(Os.play("cutin_superlobby"),`<img class="cutin_superlobby_backer" src="/res/cutin/superlobby/backing.png" /><p><span>${e}</span>PLAYERS</p>`)}};function Mo(t,...s){if(!So[t])return;const a=document.createElement("div");a.className=`cutin cutin_${t}`,a.innerHTML=So[t].starter(...s),e("cutins").appendChild(a),"ultra"===te.video.graphics&&So[t].ultra&&So[t].ultra(),setTimeout((()=>{a.remove()}),So[t].timeout)}const Ao={cleartypes:["NONE","SINGLE","DOUBLE","TRIPLE","QUAD","PENTA","HEXA","HEPTA","OCTA","ENNEA","DECA","HENDECA","DODECA","TRIADECA","TESSARADECA","PENTEDECA","HEXADECA","HEPTADECA","OCTADECA","ENNEADECA","EICOSA","KAGARIS"],tspins:{mini:"\fc3MINI\f5 %%PIECE%%-spin",normal:"%%PIECE%%-spin"},extra:{btb:"back-to-back",btb_short:"BACK-TO-BACK",clear:"ALL\nCLEAR",zenlevel:"LEVEL\nCOMPLETE"},longTypeNames:{"40l":"40 LINES",blitz:"BLITZ","5mblast":"5,000,000 BLAST",zen:"ZEN",custom:"CUSTOM GAME"},gameMissions:{"40l":"CLEAR 40 LINES!",blitz:"TWO-MINUTE BLITZ","5mblast":"5,000,000 BLAST!",zen:"ZEN","40 LINES":"CLEAR 40 LINES!",BLITZ:"TWO-MINUTE BLITZ","5,000,000 BLAST":"5,000,000 BLAST!",ZEN:"ZEN"}},Co={AD:"Andorra",AE:"United Arab Emirates",AF:"Afghanistan",AG:"Antigua and Barbuda",AI:"Anguilla",AL:"Albania",AM:"Armenia",AN:"Netherlands Antilles",AO:"Angola",AQ:"Antarctica",AR:"Argentina",AS:"American Samoa",AT:"Austria",AU:"Australia",AW:"Aruba",AX:"land Islands",AZ:"Azerbaijan",BA:"Bosnia and Herzegovina",BB:"Barbados",BD:"Bangladesh",BE:"Belgium",BF:"Burkina Faso",BG:"Bulgaria",BH:"Bahrain",BI:"Burundi",BJ:"Benin",BL:"Saint Barthlemy",BM:"Bermuda",BN:"Brunei Darussalam",BO:"Bolivia, Plurinational State of",BQ:"Caribbean Netherlands",BR:"Brazil",BS:"Bahamas",BT:"Bhutan",BV:"Bouvet Island",BW:"Botswana",BY:"Belarus",BZ:"Belize",CA:"Canada",CC:"Cocos (Keeling) Islands",CD:"Congo, the Democratic Republic of the",CF:"Central African Republic",CG:"Congo",CH:"Switzerland",CI:"Cte d'Ivoire",CK:"Cook Islands",CL:"Chile",CM:"Cameroon",CN:"China",CO:"Colombia",CR:"Costa Rica",CU:"Cuba",CV:"Cape Verde",CW:"Curaao",CX:"Christmas Island",CY:"Cyprus",CZ:"Czech Republic",DE:"Germany",DJ:"Djibouti",DK:"Denmark",DM:"Dominica",DO:"Dominican Republic",DZ:"Algeria",EC:"Ecuador",EE:"Estonia",EG:"Egypt",EH:"Western Sahara",ER:"Eritrea",ES:"Spain",ET:"Ethiopia",EU:"Europe",FI:"Finland",FJ:"Fiji",FK:"Falkland Islands (Malvinas)",FM:"Micronesia, Federated States of",FO:"Faroe Islands",FR:"France",GA:"Gabon","GB-ENG":"England","GB-NIR":"Northern Ireland","GB-SCT":"Scotland","GB-WLS":"Wales",GB:"United Kingdom",GD:"Grenada",GE:"Georgia",GF:"French Guiana",GG:"Guernsey",GH:"Ghana",GI:"Gibraltar",GL:"Greenland",GM:"Gambia",GN:"Guinea",GP:"Guadeloupe",GQ:"Equatorial Guinea",GR:"Greece",GS:"South Georgia and the South Sandwich Islands",GT:"Guatemala",GU:"Guam",GW:"Guinea-Bissau",GY:"Guyana",HK:"Hong Kong",HM:"Heard Island and McDonald Islands",HN:"Honduras",HR:"Croatia",HT:"Haiti",HU:"Hungary",ID:"Indonesia",IE:"Ireland",IL:"Israel",IM:"Isle of Man",IN:"India",IO:"British Indian Ocean Territory",IQ:"Iraq",IR:"Iran, Islamic Republic of",IS:"Iceland",IT:"Italy",JE:"Jersey",JM:"Jamaica",JO:"Jordan",JP:"Japan",KE:"Kenya",KG:"Kyrgyzstan",KH:"Cambodia",KI:"Kiribati",KM:"Comoros",KN:"Saint Kitts and Nevis",KP:"Korea, Democratic People's Republic of",KR:"Korea, Republic of",KW:"Kuwait",KY:"Cayman Islands",KZ:"Kazakhstan",LA:"Lao People's Democratic Republic",LB:"Lebanon",LC:"Saint Lucia",LI:"Liechtenstein",LK:"Sri Lanka",LR:"Liberia",LS:"Lesotho",LT:"Lithuania",LU:"Luxembourg",LV:"Latvia",LY:"Libya",MA:"Morocco",MC:"Monaco",MD:"Moldova, Republic of",ME:"Montenegro",MF:"Saint Martin",MG:"Madagascar",MH:"Marshall Islands",MK:"Macedonia, the former Yugoslav Republic of",ML:"Mali",MM:"Myanmar",MN:"Mongolia",MO:"Macao",MP:"Northern Mariana Islands",MQ:"Martinique",MR:"Mauritania",MS:"Montserrat",MT:"Malta",MU:"Mauritius",MV:"Maldives",MW:"Malawi",MX:"Mexico",MY:"Malaysia",MZ:"Mozambique",NA:"Namibia",NC:"New Caledonia",NE:"Niger",NF:"Norfolk Island",NG:"Nigeria",NI:"Nicaragua",NL:"Netherlands",NO:"Norway",NP:"Nepal",NR:"Nauru",NU:"Niue",NZ:"New Zealand",OM:"Oman",PA:"Panama",PE:"Peru",PF:"French Polynesia",PG:"Papua New Guinea",PH:"Philippines",PK:"Pakistan",PL:"Poland",PM:"Saint Pierre and Miquelon",PN:"Pitcairn",PR:"Puerto Rico",PS:"Palestine",PT:"Portugal",PW:"Palau",PY:"Paraguay",QA:"Qatar",RE:"Runion",RO:"Romania",RS:"Serbia",RU:"Russian Federation",RW:"Rwanda",SA:"Saudi Arabia",SB:"Solomon Islands",SC:"Seychelles",SD:"Sudan",SE:"Sweden",SG:"Singapore",SH:"Saint Helena, Ascension and Tristan da Cunha",SI:"Slovenia",SJ:"Svalbard and Jan Mayen Islands",SK:"Slovakia",SL:"Sierra Leone",SM:"San Marino",SN:"Senegal",SO:"Somalia",SR:"Suriname",SS:"South Sudan",ST:"Sao Tome and Principe",SV:"El Salvador",SX:"Sint Maarten (Dutch part)",SY:"Syrian Arab Republic",SZ:"Swaziland",TC:"Turks and Caicos Islands",TD:"Chad",TF:"French Southern Territories",TG:"Togo",TH:"Thailand",TJ:"Tajikistan",TK:"Tokelau",TL:"Timor-Leste",TM:"Turkmenistan",TN:"Tunisia",TO:"Tonga",TR:"Turkey",TT:"Trinidad and Tobago",TV:"Tuvalu",TW:"Taiwan",TZ:"Tanzania, United Republic of",UA:"Ukraine",UG:"Uganda",UM:"US Minor Outlying Islands",US:"United States",UY:"Uruguay",UZ:"Uzbekistan",VA:"Holy See (Vatican City State)",VC:"Saint Vincent and the Grenadines",VE:"Venezuela, Bolivarian Republic of",VG:"Virgin Islands, British",VI:"Virgin Islands, U.S.",VN:"Vietnam",VU:"Vanuatu",WF:"Wallis and Futuna Islands",XK:"Kosovo",WS:"Samoa",YE:"Yemen",YT:"Mayotte",ZA:"South Africa",ZM:"Zambia",ZW:"Zimbabwe",XX:"Unknown",XM:"The Moon"};class Ro{constructor(){this.textures=new Map,this.elements=new Map,this.effects=new Map,this.progressive=new Map}el(e){return this.elements.get(e)||$o}fx(e){return this.effects.get(e)||Po}progress(e){for(const[,t]of this.progressive)t.progress(e)}}class Ho{constructor(e,t){this.parent=e,this.options=t}create(){}update(){}delete(){}action(e){}progress(e){}}const $o=new Ho;class Oo{constructor(e,t){this.parent=e,this.options=t}create(){}delete(){}progress(e){}}const Po=new Oo,Do={generic:{id:"generic",name:"generic testing boardskin",ns:{}},tetrio:{id:"tetrio",name:"TETR.IO",ns:{}}};Do.generic.ns.Board=class extends Ro{constructor(e,t,s){super(),this.H=e,this.HS=e.holderstate,this.S=t,this.X={W:()=>t.setoptions.boardwidth||10,H:()=>t.setoptions.boardheight||20,B:()=>t.setoptions.boardbuffer||20,T:()=>(t.setoptions.boardbuffer||20)+(t.setoptions.boardheight||20),Wh:()=>(t.setoptions.boardwidth||10)/2,Hh:()=>(t.setoptions.boardheight||20)/2,S:()=>this.HS.cos*this.HS.asf},this.ctx=s,this.textures.set("board",PIXI.BaseTexture.from("/res/skins/board/generic/board.png")),this.textures.set("queue",PIXI.BaseTexture.from("/res/skins/board/generic/queue.png")),this.barWidth=fo.x/1.5,this.sidesOffset=9,this.barWidthOffset=9,this.elements.set("boardsides",new Do.generic.ns.boardsides(this,{})),this.elements.set("background",new Do.generic.ns.background(this,{texture:new PIXI.Texture(this.textures.get("board"),new PIXI.Rectangle(2,2,16,16)),texture_tiny:new PIXI.Texture(this.textures.get("board"),new PIXI.Rectangle(22,2,26,16)),slices:[0,0,0,0],slices_tiny:[10,0,10,10],offsets_tiny:[10,0,10,10]})),this.elements.set("grid",new Do.generic.ns.grid(this,{texture:PIXI.BaseTexture.from("/res/skins/board/generic/grid.png")})),this.elements.set("username",new Do.generic.ns.username(this,{texture:new PIXI.Texture(this.textures.get("board"),new PIXI.Rectangle(52,2,16,16)),texture_fire:new PIXI.Texture(this.textures.get("board"),new PIXI.Rectangle(74,2,16,16)),slices:[0,0,0,0],slices_fire:[0,0,0,0],offsets:[9,0,9,0],offsets_fire:[9,0,9,0],font_opts:{}})),this.elements.set("stack",new Do.generic.ns.stack(this,{})),this.elements.set("stock",new Do.generic.ns.stock(this,{texture:new PIXI.Texture(this.textures.get("board"),new PIXI.Rectangle(2,22,92,92))})),this.elements.set("next",new Do.generic.ns.next(this,{texture:new PIXI.Texture(this.textures.get("queue"),new PIXI.Rectangle(2,2,474,142)),slices:[180,82,50,50]})),this.elements.set("hold",new Do.generic.ns.hold(this,{texture:new PIXI.Texture(this.textures.get("queue"),new PIXI.Rectangle(2,148,474,142)),slices:[180,82,50,50]})),this.elements.set("skyline",new Do.generic.ns.skyline(this,{texture:new PIXI.Texture(this.textures.get("board"),new PIXI.Rectangle(98,2,9,73)),slices:[0,9,0,0],height:300})),this.elements.set("garbagedangericon",new Do.generic.ns.garbagedangericon(this,{texture:new PIXI.Texture(this.textures.get("board"),new PIXI.Rectangle(2,118,92,92)),scale:2})),this.elements.set("targeticon",new Do.generic.ns.targeticon(this,{texture:new PIXI.Texture(this.textures.get("board"),new PIXI.Rectangle(98,100,69,69)),scale:4})),this.elements.set("falling",new Do.generic.ns.falling(this,{})),this.elements.set("border",new Do.generic.ns.border(this,{texture:new PIXI.Texture(this.textures.get("board"),new PIXI.Rectangle(111,2,27,18)),slices:[9,0,9,9],offsets:[9,0,9,9]})),this.elements.set("replaytag",new Do.generic.ns.replaytag(this,{texture:new PIXI.Texture(this.textures.get("queue"),new PIXI.Rectangle(2,294,396,77))})),this.progressive.set("replaytag",this.elements.get("replaytag")),this.elements.set("backer",new Do.generic.ns.backer(this,{font_opts:{}})),this.progressive.set("backer",this.elements.get("backer")),this.elements.set("zen",new Do.generic.ns.zen(this,{font_opts_score:{},font_opts_level:{},font_opts_level_hiero:{}})),this.elements.set("b2b",new Do.generic.ns.b2b(this,{font_opts:{},size:30,y:220})),t.setoptions.slot_counter1&&this.elements.set("counter1",new Do.generic.ns.counter(this,{font_opts_title:{},font_opts_value:{},font_opts_subtitle:{},has_subtitle:!1,side:"left",y:fo.x*Math.min(30,Math.max(20,this.X.H()))-55})),t.setoptions.slot_counter2&&this.elements.set("counter2",new Do.generic.ns.counter(this,{font_opts_title:{},font_opts_value:{},font_opts_subtitle:{},has_subtitle:!1,side:"left",y:fo.x*Math.min(30,Math.max(20,this.X.H()))-125})),t.setoptions.slot_counter3&&this.elements.set("counter3",new Do.generic.ns.counter(this,{font_opts_title:{},font_opts_value:{},font_opts_subtitle:{},has_subtitle:!1,side:"left",y:fo.x*Math.min(30,Math.max(20,this.X.H()))-195})),t.setoptions.slot_counter4&&this.elements.set("counter4",new Do.generic.ns.counter(this,{font_opts_title:{},font_opts_value:{},font_opts_subtitle:{},has_subtitle:!1,side:"left",y:fo.x*Math.min(30,Math.max(20,this.X.H()))-265})),t.setoptions.slot_counter5&&this.elements.set("counter5",new Do.generic.ns.counter(this,{font_opts_title:{},font_opts_value:{},font_opts_subtitle:{},has_subtitle:!0,side:"right",y:!1!==t.setoptions.display_next?40+3*fo.x*(this.S.setoptions.nextcount||5):4})),t.setoptions.slot_bar1&&(this.elements.set("bar1",new Do.generic.ns.bar_segmented(this,{side:"left",bar_texture:new PIXI.Texture(this.textures.get("board"),new PIXI.Rectangle(142,2,27,18)),bar_slices:[9,0,9,9],bar_offsets:[9,0,9,9],offset:this.barWidthOffset,ticker_texture:new PIXI.Texture(this.textures.get("board"),new PIXI.Rectangle(111,88,60,8)),styles:{generic:{texture:new PIXI.Texture(this.textures.get("board"),new PIXI.Rectangle(111,24,60,60)),slices:[6,12,6,6],offsets:[0,0,0,0],color:16717824,flash_color:16545127},garbage_inactive:{texture:new PIXI.Texture(this.textures.get("board"),new PIXI.Rectangle(175,88,60,60)),slices:[6,12,6,6],offsets:[0,0,0,0],color:16717824,flash_color:16545127}},general_flash_color:65460})),this.progressive.set("bar1",this.elements.get("bar1"))),t.setoptions.slot_bar2&&(this.elements.set("bar2",new Do.generic.ns.bar_smooth(this,{side:"right",bar_texture:new PIXI.Texture(this.textures.get("board"),new PIXI.Rectangle(173,2,27,18)),bar_slices:[9,0,9,9],bar_offsets:[9,0,9,9],offset:this.barWidthOffset,fill_texture:new PIXI.Texture(this.textures.get("board"),new PIXI.Rectangle(175,24,60,60)),fill_slices:[0,30,0,0],fill_offsets:[0,30,0,0],ticker_texture:new PIXI.Texture(this.textures.get("board"),new PIXI.Rectangle(111,88,60,8)),colors:[12078599,16763904],flash_color:16763904})),this.progressive.set("bar2",this.elements.get("bar2"))),"full"===this.H.displaymode&&(this.effects.set("popup_offence",new Do.generic.ns.popup_offence(this,{font_opts:{}})),this.progressive.set("popup_offence",this.effects.get("popup_offence")),this.effects.set("popup_defense",new Do.generic.ns.popup_defense(this,{font_opts:{}})),this.effects.set("clear",new Do.generic.ns.splash(this,{size:45,color:16777215,y:170,animation:"normal",font_opts:{}})),this.effects.set("tspin",new Do.generic.ns.splash(this,{size:30,color:16777215,y:140,animation:"normal",font_opts:{}})),this.effects.set("also",new Do.generic.ns.splash(this,{size:30,color:16767332,y:220,animation:"normal",font_opts:{}})),this.effects.set("combo",new Do.generic.ns.splash(this,{size:60,color:16777215,y:255,animation:"bounce",font_opts:{}})),this.effects.set("countdown",new Do.generic.ns.shout(this,{size:120,color:16762368,y:Ls(fo.x*this.X.Hh()),font_opts:{},animation:{0:{"scale.x":.9,"scale.y":.9,alpha:0,weight:630},.05:{"scale.x":1.1,"scale.y":1.1,alpha:1,weight:700},.3:{"scale.x":1,"scale.y":1,alpha:.95,weight:665},1:{"scale.x":.9,"scale.y":.9,alpha:0,weight:0}},animationDuration:2.5,flatAnimationDuration:.75,animationEasing:BezierEasing(.1,.38,0,.88),hasShadow:!0,shadowColor:2432256,animationShadow:{0:{"scale.x":1,"scale.y":1,alpha:.8,weight:560},.6:{"scale.x":2.2,"scale.y":2.2,alpha:.5,weight:350},1:{"scale.x":3,"scale.y":3,alpha:0,weight:0}},animationShadowDuration:2,animationShadowEasing:BezierEasing(.1,.38,0,.88)})),this.effects.set("countdown_stride",new Do.generic.ns.shout(this,{size:120,color:16762368,y:Ls(fo.x*this.X.Hh()),font_opts:{},animation:{0:{"scale.x":.9,"scale.y":.9,alpha:0,weight:630},.05:{"scale.x":1.1,"scale.y":1.1,alpha:1,weight:700},.3:{"scale.x":1,"scale.y":1,alpha:.95,weight:665},1:{"scale.x":.9,"scale.y":.9,alpha:0,weight:0}},animationDuration:1.25,flatAnimationDuration:.5,animationEasing:BezierEasing(.1,.38,0,.88),hasShadow:!0,shadowColor:2432256,animationShadow:{0:{"scale.x":1,"scale.y":1,alpha:.8,weight:560},.6:{"scale.x":2.2,"scale.y":2.2,alpha:.5,weight:350},1:{"scale.x":3,"scale.y":3,alpha:0,weight:0}},animationShadowDuration:1,animationShadowEasing:BezierEasing(.1,.38,0,.88)})),this.effects.set("levelup",new Do.generic.ns.shout(this,{size:120,color:6256003,y:Ls(fo.x*(this.X.Hh()+5)),font_opts:{},animation:{0:{y:Ls(fo.x*(this.X.Hh()+5)),alpha:0,weight:0},.05:{y:Ls(fo.x*(this.X.Hh()+4.5)),alpha:1,weight:700},1:{y:Ls(fo.x*(this.X.Hh()-5)),alpha:0,weight:0}},animationDuration:1.5,animationEasing:BezierEasing(.2,.65,.88,.64),hasShadow:!1})),this.effects.set("timeleft",new Do.generic.ns.shout(this,{size:40,color:16732200,y:Ls(fo.x*this.X.H()/4),font_opts:{},animation:{0:{alpha:0,weight:0,letterSpacing:0,tint:16777215},.05:{alpha:1,weight:700,letterSpacing:.25,tint:16777215},.8:{alpha:1,weight:700,letterSpacing:5,tint:16732200},1:{alpha:0,weight:0,letterSpacing:8,tint:12067584}},animationDuration:4,animationEasing:BezierEasing(.2,.65,.88,.64),hasShadow:!1})),this.effects.set("clutch",new Do.generic.ns.shout(this,{size:30,color:16771199,y:Ls(-1*fo.x),font_opts:{},animation:{0:{alpha:1.5,weight:900,letterSpacing:0},.05:{alpha:1.5,weight:900,letterSpacing:30},1:{alpha:0,weight:0,letterSpacing:50}},animationDuration:1,animationEasing:BezierEasing(.2,.65,.88,.64),hasShadow:!1})),this.effects.set("allclear",new Do.generic.ns.shout(this,{size:60,color:16777215,y:Ls(fo.x*this.X.Hh()),font_opts:{},animation:{0:{rotation:-10,"scale.x":0,"scale.y":0,alpha:1,weight:700,tint:16777215},.1:{rotation:0,"scale.x":1.4,"scale.y":1.4,alpha:1,weight:700,tint:16737894},.15:{rotation:0,"scale.x":1.3,"scale.y":1.3,alpha:1,weight:700,tint:16777215},.8:{rotation:0,"scale.x":1,"scale.y":1,alpha:.9,weight:630,tint:16753152},1:{rotation:0,"scale.x":.5,"scale.y":.5,alpha:0,weight:0,tint:16777215}},animationDuration:5,animationEasing:BezierEasing(.06,.18,.65,1.01),hasShadow:!0,shadowColor:2235150,animationShadow:{0:{"scale.x":1,"scale.y":1,alpha:0,weight:0},.09:{"scale.x":1,"scale.y":1,alpha:0,weight:0},.1:{"scale.x":1,"scale.y":1,alpha:1,weight:700},1:{"scale.x":5,"scale.y":5,alpha:0,weight:0}},animationShadowDuration:5,animationShadowEasing:BezierEasing(.06,.18,.65,1.01)})),this.effects.set("zenlevel",new Do.generic.ns.shout(this,{size:60,color:16777215,y:Ls(fo.x*this.X.Hh()),font_opts:{},animation:{0:{"scale.x":2.5,"scale.y":0,alpha:1,weight:700,tint:16777215},.05:{"scale.x":.8,"scale.y":1.9,alpha:1,weight:700,tint:16755370},.1:{"scale.x":1.4,"scale.y":1.4,alpha:1,weight:700,tint:16737894},.15:{"scale.x":1.3,"scale.y":1.3,alpha:1,weight:700,tint:16777215},1:{"scale.x":1,"scale.y":1,alpha:.9,weight:630,tint:16753152}},animationDuration:5,animationEasing:BezierEasing(.06,.18,.65,1.01),hasShadow:!0,shadowColor:2235150,animationShadow:{0:{"scale.x":1,"scale.y":1,alpha:0,weight:0},.09:{"scale.x":1,"scale.y":1,alpha:0,weight:0},.1:{"scale.x":1,"scale.y":1,alpha:1,weight:700},1:{"scale.x":5,"scale.y":5,alpha:0,weight:0}},animationShadowDuration:5,animationShadowEasing:BezierEasing(.06,.18,.65,1.01)})))}},Do.generic.ns.background=class extends Ho{create(){this.options.offsets_tiny;return"tiny"===this.parent.H.displaymode?(this.nsp=new PIXI.NineSlicePlane(this.options.texture_tiny,...this.options.slices_tiny.map((e=>e?e+2:e))),this.nsp.width=fo.x*this.parent.X.W()+this.options.offsets_tiny[0]+this.options.offsets_tiny[2],this.nsp.height=fo.x*this.parent.X.H()+this.options.offsets_tiny[1]+this.options.offsets_tiny[3],this.nsp.position.set(Ls(-this.options.offsets_tiny[0]),Ls(-this.options.offsets_tiny[1]))):(this.nsp=new PIXI.NineSlicePlane(this.options.texture,...this.options.slices.map((e=>e?e+2:e))),this.nsp.width=fo.x*this.parent.X.W(),this.nsp.height=fo.x*this.parent.X.H(),this.nsp.alpha=void 0===te.video.boardopacity?.85:te.video.boardopacity),this.nsp.scale.set(Ls(1)),this.parent.H.holder.addChild(this.nsp),this.parent.H.tintables.push(this.nsp),this.nsp}},Do.generic.ns.grid=class extends Ho{create(){if("full"!==this.parent.H.displaymode)return;this.container=new PIXI.Container,this.container.scale.set(Is(1)),this.container.alpha=void 0===te.video.gridopacity?.1:te.video.gridopacity;const e={top:{left:new PIXI.Texture(this.options.texture,new PIXI.Rectangle(2,2,184,184)),center:new PIXI.Texture(this.options.texture,new PIXI.Rectangle(190,2,184,184)),right:new PIXI.Texture(this.options.texture,new PIXI.Rectangle(378,2,184,184)),right3:new PIXI.Texture(this.options.texture,new PIXI.Rectangle(566,2,276,184))},middle:{left:new PIXI.Texture(this.options.texture,new PIXI.Rectangle(2,190,184,184)),center:new PIXI.Texture(this.options.texture,new PIXI.Rectangle(190,190,184,184)),right:new PIXI.Texture(this.options.texture,new PIXI.Rectangle(378,190,184,184)),right3:new PIXI.Texture(this.options.texture,new PIXI.Rectangle(566,190,276,184))},bottom:{left:new PIXI.Texture(this.options.texture,new PIXI.Rectangle(2,378,184,184)),left3:new PIXI.Texture(this.options.texture,new PIXI.Rectangle(2,566,184,276)),center:new PIXI.Texture(this.options.texture,new PIXI.Rectangle(190,378,184,184)),center3:new PIXI.Texture(this.options.texture,new PIXI.Rectangle(190,566,184,276)),right:new PIXI.Texture(this.options.texture,new PIXI.Rectangle(378,378,184,184)),right3wide:new PIXI.Texture(this.options.texture,new PIXI.Rectangle(566,378,276,184)),right3tall:new PIXI.Texture(this.options.texture,new PIXI.Rectangle(378,566,184,276)),right3max:new PIXI.Texture(this.options.texture,new PIXI.Rectangle(566,566,276,276))}},t=!!(this.parent.X.W()%2),s=!!(this.parent.X.H()%2);for(let a=0;a<this.parent.X.H()-1;a+=2)for(let n=0;n<this.parent.X.W()-1;n+=2){let o="middle";0===a&&(o="top"),a===this.parent.X.H()-(s?3:2)&&(o="bottom");let i="center";0===n&&(i="left"),n===this.parent.X.W()-(t?3:2)&&(i="right"),"top"===o&&"right"===i&&t||"middle"===o&&"right"===i&&t?i="right3":"bottom"===o&&("left"===i&&s?i="left3":"center"===i&&s?i="center3":"right"===i&&(s&&t?i="right3max":s?i="right3tall":t&&(i="right3wide")));const r=new PIXI.Sprite(e[o][i]);r.position.set(Ts(fo.x*n),Ts(fo.x*a)),this.container.addChild(r),this.parent.H.tintables.push(r)}return this.parent.H.holder.addChild(this.container),this.container}},Do.generic.ns.border=class extends Ho{create(){if("tiny"===this.parent.H.displaymode)return;const e=this.options.offsets||[0,0,0,0];return this.nsp=new PIXI.NineSlicePlane(this.options.texture,...this.options.slices.map((e=>e?e+2:e))),this.nsp.width=Ts(fo.x*this.parent.X.W())+e[0]+e[2],this.nsp.height=Ts(fo.x*this.parent.X.H())+e[1]+e[3],this.nsp.position.set(-Is(e[0]),-Is(e[1])),this.nsp.scale.set(Is(1)),this.parent.H.holder.addChild(this.nsp),this.parent.H.tintables.push(this.nsp),this}},Do.generic.ns.bar=class extends Ho{constructor(e,t){super(e,t),this.d={ticker:0,ticker_appr:0}}create(){if("tiny"===this.parent.H.displaymode)return;const e=this.options.bar_offsets||[0,0,0,0];this.nsp=new PIXI.NineSlicePlane(this.options.bar_texture,...this.options.bar_slices.map((e=>e?e+2:e))),this.nsp.width=Ts(this.parent.barWidth)+e[0]+e[2],this.nsp.height=Ts(fo.x*this.parent.X.H())+e[1]+e[3];let t=0;t="right"===this.options.side?Ls(fo.x*this.parent.X.W())+Is(this.options.offset):-Ls(this.parent.barWidth)-Is(this.options.offset),t-=Is(e[0]),this.nsp.position.set(t,-Is(e[1])),this.nsp.scale.set(Is(1)),this.parent.H.holder.addChild(this.nsp),this.parent.H.tintables.push(this.nsp),this.container=new PIXI.Container,this.container.position.set(e[0],e[1]),this.nsp.addChild(this.container),this.container_extra=new PIXI.Container,this.container_extra.position.set(e[0],e[1]),this.nsp.addChild(this.container_extra),this.ticker=new PIXI.Sprite(this.options.ticker_texture),this.ticker.anchor.set(0,.5),this.ticker.position.set(e[0],Ts(fo.x*this.parent.X.H())),this.ticker.alpha=0,this.nsp.addChild(this.ticker),this.parent.H.tintables.push(this.ticker)}update(e,t){if("tiny"!==this.parent.H.displaymode&&"ticker"===e)t!==this.d.ticker&&(this.d.ticker=t)}progress(e){"tiny"!==this.parent.H.displaymode&&this.d.ticker_appr!==this.d.ticker&&("minimal"===te.video.graphics||Math.abs(this.d.ticker_appr-this.d.ticker)<2e-4?this.d.ticker_appr=this.d.ticker:this.d.ticker_appr=this.d.ticker+(this.d.ticker_appr-this.d.ticker)*Math.pow(.9,e),this.ticker.position.y=Ts(fo.x*(this.parent.X.H()-this.parent.X.H()*this.d.ticker_appr)),this.ticker.alpha=1,this.d.ticker_appr<1/40?this.ticker.alpha=Math.max(0,40*this.d.ticker_appr):this.d.ticker_appr>.975&&(this.ticker.alpha=Math.max(0,40-40*this.d.ticker_appr)))}},Do.generic.ns.bar_smooth=class extends Do.generic.ns.bar{create(){"tiny"!==this.parent.H.displaymode&&(super.create(),this.d.value=0,this.d.value_appr=0)}update(e,t){if("tiny"!==this.parent.H.displaymode&&(super.update(e,t),"simple"===e))t!==this.d.value&&(this.d.value=t)}action(e,t){if("tiny"!==this.parent.H.displaymode&&"flash"===e)this._flashBar(this.options.flash_color)}progress(e){if("tiny"!==this.parent.H.displaymode&&(super.progress(e),this.d.value_appr!==this.d.value&&("minimal"===te.video.graphics||Math.abs(this.d.value_appr-this.d.value)<2e-4?this.d.value_appr=this.d.value:this.d.value_appr=this.d.value+(this.d.value_appr-this.d.value)*Math.pow(.9,e),this._updateContents()),this.parent.S.playing&&"full"===this.parent.H.displaymode&&this.d.value_appr)){const t=ao(this.container,Ts(this.parent.barWidth/2),Ts(fo.x*this.parent.X.H())-Ts(this._getBarHeight(this.d.value_appr)));xn.play("bar_sparks",{x:t.x,y:t.y,w:Ts(this.parent.barWidth/2),color:this.options.colors[0],dT:e})}}_updateContents(){const e=this.options.fill_offsets||[0,0,0,0],t=this.options.fill_slices.map((e=>e?e+2:e));so(this.container);let s=0,a=this.d.value_appr;for(a>12&&(a=6+a%6);a>0;){const n=this._getBarHeight(a),o=new PIXI.NineSlicePlane(this.options.fill_texture,...t);o.width=Ts(this.parent.barWidth)+e[0]+e[2],o.height=Ts(n)+e[1]+e[3],o.position.set(0,Ts(fo.x*this.parent.X.H())),o.pivot.set(0,Ts(n)+e[1]+e[3]),o.tint=this.options.colors[s%this.options.colors.length],this.container.addChild(o),a--,s++}}_getBarHeight(e){return e=Math.min(3,e),fo.x*(Math.min(1,e)+(e-Math.min(1,e))/3)*this.parent.X.H()}_flashBar(e){if("minimal"===te.video.graphics||void 0===this.container_extra)return;if("full"!==this.parent.H.displaymode)return;const t=new PIXI.NineSlicePlane(PIXI.Texture.WHITE,0,0,0,0);t.width=Ts(this.parent.barWidth),t.height=Ts(fo.x*this.parent.X.H()),t.position.set(Ts(this.parent.barWidth)/2,Ts(fo.x*this.parent.X.W())),t.pivot.set(Ts(this.parent.barWidth)/2,Ts(fo.x*this.parent.X.H())/2),t.tint=e,this.container_extra.addChild(t),go.animate(t,{0:{"scale.x":1,"scale.y":1,alpha:1},1:{"scale.x":2,"scale.y":1.2,alpha:0}},.3,BezierEasing(.05,.81,.96,.96),(()=>{t.destroy()}))}},Do.generic.ns.bar_segmented=class extends Do.generic.ns.bar{create(){"tiny"!==this.parent.H.displaymode&&(super.create(),this.d.segments=new Map,this.d.dirty=!0,Object.keys(this.options.styles).forEach((e=>{this.options.styles[e].offsets=this.options.styles[e].offsets||[0,0,0,0],this.options.styles[e].slices=this.options.styles[e].slices.map((e=>e?e+2:e)),void 0===this.options.styles[e].flash_color&&(this.options.styles[e].flash_color=this.options.styles[e].color)})))}update(e,t){if("tiny"!==this.parent.H.displaymode)switch(super.update(e,t),e){case"upsert":this._upsertSegment(t);break;case"clear":this.d.segments.clear(),this.d.dirty=!0}}action(e,t){if("tiny"!==this.parent.H.displaymode)switch(e){case"flash":this._flashBar(this.options.general_flash_color,t,0);break;case"forceupdate":for(const[e,t]of this.d.segments)t.flagFallDown=!1,t.flagAppear=!1,t.flagRestyled=!1;this._updateContents()}}progress(e){"tiny"!==this.parent.H.displaymode&&(super.progress(e),this.d.dirty&&this._updateContents())}_upsertSegment(e){if(this.d.segments.has(e.id)){const t=this.d.segments.get(e.id),s={...t,...e};let a=!1;if(s.size<=0){this.d.segments.delete(e.id);let s=0;for(const[a,n]of this.d.segments)a>e.id&&(n.flagFallDown="minimal"!==te.video.graphics,n.flagFallDownDistance=++s,n.flagFallDownAmount=(n.flagFallDownAmount||0)+t.size);return void(this.d.dirty=!0)}if(s.size<t.size){let n=1;for(const[a,o]of this.d.segments)a>e.id&&(o.flagFallDown="minimal"!==te.video.graphics,o.flagFallDownDistance=++n,o.flagFallDownAmount=(o.flagFallDownAmount||0)+(t.size-s.size));s.flagFallDown="minimal"!==te.video.graphics,s.flagFallDownDistance=1,s.flagFallDownAmount=(s.flagFallDownAmount||0)+(t.size-s.size),this.d.dirty=!0,a=!0}else s.size>t.size&&(this.d.dirty=!0,a=!0);s.style!==t.style&&(s.flagRestyled="minimal"!==te.video.graphics,this.d.dirty=!0,a=!0),a&&this.d.segments.set(e.id,s)}else{const t={style:"generic",...e,flagAppear:"minimal"!==te.video.graphics};this.d.segments.set(e.id,t),this.d.dirty=!0}}_updateContents(){so(this.container);let e=0;for(const[t,s]of this.d.segments){const t=this._getBarHeight(s.size),a=this.options.styles[s.style]||this.options.styles.generic,n=a.class||Do.generic.ns.bar_segment;let o=Ts(fo.x*this.parent.X.H()-e);s.flagFallDown?o-=Ts(fo.x*this.parent.X.H()*(s.flagFallDownAmount||0)):s.flagAppear&&(o-=Ts(5*fo.x));const i=new n(a.texture,...a.slices,Ts(this.parent.barWidth)+a.offsets[0]+a.offsets[2],Ts(t)+a.offsets[1]+a.offsets[3],a.color);if(i.position.set(0,o),i.pivot.set(0,Ts(t)+a.offsets[1]+a.offsets[3]),i.alpha=s.flagAppear?0:1,this.container.addChild(i),s.flagAppear?(go.animate(i,{0:{y:Ts(fo.x*this.parent.X.H()-e-3*fo.x),alpha:0},1:{y:Ts(fo.x*this.parent.X.H()-e),alpha:1}},.25,BezierEasing(.7,1.62,.63,.74)),s.flagAppear=!1):s.flagFallDown?(go.animate(i,{0:{y:Ts(fo.x*this.parent.X.H()-e-fo.x*this.parent.X.H()*(s.flagFallDownAmount||0))},1:{y:Ts(fo.x*this.parent.X.H()-e)}},.1+.02*s.flagFallDownDistance,BezierEasing(.79,.09,.61,1.07)),s.flagFallDown=!1,s.flagFallDownDistance=0,s.flagFallDownAmount=0):s.flagRestyled&&(this._flashBar(a.flash_color,s.size,e),s.flagRestyled=!1),e+=t,e>fo.x*this.parent.X.H()*2)break}this.d.dirty=!1}_getBarHeight(e){return fo.x*Math.min(3,e)*this.parent.X.H()}_flashBar(e,t,s){if("minimal"===te.video.graphics||void 0===this.container_extra)return;if("full"!==this.parent.H.displaymode)return;const a=this._getBarHeight(t),n=new PIXI.NineSlicePlane(PIXI.Texture.WHITE,0,0,0,0);n.width=Ts(this.parent.barWidth),n.height=Ts(a),n.position.set(Ts(this.parent.barWidth)/2,Ts(fo.x*this.parent.X.H()-s)-Ts(a)/2),n.pivot.set(Ts(this.parent.barWidth)/2,Ts(a)/2),n.tint=e,this.container_extra.addChild(n),go.animate(n,{0:{"scale.x":1,"scale.y":1,alpha:1},1:{"scale.x":2,"scale.y":1.2,alpha:0}},.3,BezierEasing(.05,.81,.96,.96),(()=>{n.destroy()}))}},Do.generic.ns.bar_segment=class extends PIXI.NineSlicePlane{constructor(e,t,s,a,n,o,i,r){super(e,t,s,a,n),this.width=o,this.height=i,this.tint=r}},Do.generic.ns.boardsides=class extends Ho{create(){this.parent.H.leftside.x=this.parent.S.setoptions.slot_bar1?-(Ls(this.parent.barWidth)+Is(this.parent.barWidthOffset)):0,this.parent.H.rightside.x=this.parent.S.setoptions.slot_bar2?Ls(fo.x*this.parent.X.W())+Ls(this.parent.barWidth)+Is(this.parent.barWidthOffset):Ls(fo.x*this.parent.X.W());let e=1;if(this.parent.X.H()<20?e=this.parent.X.H()/20:this.parent.X.H()>30&&(e=this.parent.X.H()/30),this.parent.H.leftside.scale.set(e),this.parent.H.rightside.scale.set(e),e<1){const t=.2*(Is(this.parent.sidesOffset)/e-Is(this.parent.sidesOffset));this.parent.H.leftside.x-=t,this.parent.H.rightside.x+=t}}},Do.generic.ns.stack=class extends Ho{create(){return this.stack=new PIXI.Container,this.stack.position.set(0,0),this.parent.H.holder.addChild(this.stack),this.stack}},Do.generic.ns.falling=class extends Ho{create(){return this.falling=new PIXI.Container,this.falling.position.set(0,0),this.parent.H.holder.addChild(this.falling),this.falling}},Do.generic.ns.backer=class extends Ho{create(){"full"===this.parent.H.displaymode&&this.parent.S.setoptions.pro&&!this.parent.S.setoptions.display_replay&&(this.text=new TheoryType.Text("",{font:Bn.get("hun"),rasterize:["minimal","low"].includes(te.video.graphics),fontSize:Ls(138),weight:600,tint:16777215,outlineTint:0,outlineWeight:900,outlineAlpha:1,alpha:.2,anchor:[.5,0],...this.options.font_opts}),this.text.position.set(Ls(fo.x*this.parent.X.Wh()),Ls(3.25*fo.x)),this.parent.H.holder.addChild(this.text),this.parent.H.tintables.push(this.text),["minimal","low"].includes(te.video.graphics)||(this.activeFade=new Do.generic.ns._helper_activefade({positions:[[this.parent.X.Wh()-2,this.parent.X.B()+4],[this.parent.X.Wh()+0,this.parent.X.B()+4],[this.parent.X.Wh()+2,this.parent.X.B()+4],[this.parent.X.Wh()-3,this.parent.X.B()+5],[this.parent.X.Wh()-1,this.parent.X.B()+5],[this.parent.X.Wh()+1,this.parent.X.B()+5]],elements:[this.text],alphaHigh:.2,alphaLow:.1,ctx:this.parent.ctx})))}update(e){this.text&&(this.text.text=e)}progress(e){this.activeFade&&this.activeFade.progress(e)}},Do.generic.ns.zen=class extends Ho{create(){"full"===this.parent.H.displaymode&&this.parent.S.setoptions.display_zen&&(this.text_score=new TheoryType.Text("0",{font:Bn.get("hun"),rasterize:["minimal","low"].includes(te.video.graphics),fontSize:Ls(19),weight:600,tint:16777215,anchor:[.5,0],...this.options.font_opts_score}),this.text_score.position.set(Ls(fo.x*this.parent.X.Wh()),Ls(fo.x*this.parent.X.H()+5)),this.parent.H.holder.addChild(this.text_score),this.parent.H.tintables.push(this.text_score),this.text_level=new TheoryType.Text("1",{font:Bn.get("hun"),rasterize:["minimal","low"].includes(te.video.graphics),fontSize:Ls(38),weight:600,tint:16777215,anchor:[.5,0],...this.options.font_opts_level}),this.text_level.position.set(Ls(fo.x*this.parent.X.Wh()),Ls(fo.x*this.parent.X.H()+28)),this.parent.H.holder.addChild(this.text_level),this.parent.H.tintables.push(this.text_level),this.text_level_hiero=new TheoryType.Text("",{font:Bn.get("hun"),rasterize:["minimal","low"].includes(te.video.graphics),fontSize:Ls(19),weight:600,tint:16777215,anchor:[.5,0],...this.options.font_opts_level_hiero}),this.text_level_hiero.position.set(Ls(fo.x*this.parent.X.Wh()),Ls(fo.x*this.parent.X.H()+64)),this.parent.H.holder.addChild(this.text_level_hiero),this.parent.H.tintables.push(this.text_level_hiero))}update(e,t){this.text_score&&(this.text_score.text=e.toLocaleString("en-US"),this.text_level.text=t,this.text_level_hiero.text=c(t))}},Do.generic.ns.counter=class extends Ho{create(){"full"===this.parent.H.displaymode&&(this.text_title=new TheoryType.Text("",{font:Bn.get("hun"),rasterize:["minimal","low"].includes(te.video.graphics),fontSize:Ls(20),weight:500,tint:16777215,anchor:["right"===this.options.side?0:1,0],...this.options.font_opts_title}),this.text_title.position.set(Ls("right"===this.options.side?10:-10),Ls(this.options.y)),("left"===this.options.side?this.parent.H.leftside:this.parent.H.rightside).addChild(this.text_title),this.parent.H.tintables.push(this.text_title),this.text_value=new TheoryType.Text("",{font:Bn.get("hun"),rasterize:["minimal","low"].includes(te.video.graphics),fontSize:Ls(38),weight:600,tint:16777215,anchor:["right"===this.options.side?0:1,0],...this.options.font_opts_value}),this.text_value.position.set(Ls("right"===this.options.side?10:-10),Ls(this.options.y+23)),("left"===this.options.side?this.parent.H.leftside:this.parent.H.rightside).addChild(this.text_value),this.parent.H.tintables.push(this.text_value),this.options.has_subtitle&&(this.text_subtitle=new TheoryType.Text("",{font:Bn.get("hun"),rasterize:["minimal","low"].includes(te.video.graphics),fontSize:Ls(20),weight:500,tint:16777215,anchor:["right"===this.options.side?0:1,0],...this.options.font_opts_subtitle}),this.text_subtitle.position.set(Ls("right"===this.options.side?10:-10),Ls(this.options.y+64)),("left"===this.options.side?this.parent.H.leftside:this.parent.H.rightside).addChild(this.text_subtitle),this.parent.H.tintables.push(this.text_subtitle)))}update(e,t,s){this.text_value&&(void 0!==e&&(this.text_value.text=e),void 0!==s&&(this.text_title.text=s),this.text_subtitle&&void 0!==t&&(this.text_subtitle.text=t))}},Do.generic.ns.stock=class extends Ho{create(){if("tiny"!==this.parent.H.displaymode){this.stock=new PIXI.Container;for(let e=0;e<this.parent.S.stock;e++){let t=new PIXI.Sprite(this.options.texture);t.width=fo.x,t.height=fo.x,t.anchor.set(.5,.5),t.position.set(Ls(e*fo.x),0),this.stock.addChild(t)}return this.stock.position.set(Ls(fo.x/2)*(this.parent.X.W()-this.parent.S.stock)+Ls(fo.x/2),Ls(fo.x*this.parent.X.H()+(this.parent.S.setoptions.display_username?36:10))+Ls(fo.x/2)),this.parent.H.holder.addChild(this.stock),this.stock}}action(e,t){if("tiny"!==this.parent.H.displaymode)switch(e){case"drop":{if(!this.stock.children.length)return;let e=this.stock.children[this.stock.children.length-1];if("full"===this.parent.H.displaymode){const t=ao(e,0,0);xn.play("stock_explode",{x:t.x,y:t.y})}e.destroy(),go.animate(this.stock,{0:{x:"inherit"},1:{x:`${Ls(fo.x/2)*(this.parent.X.W()-this.parent.S.stock)+Ls(fo.x/2)}`}},1,BezierEasing(.17,.67,.35,1));break}case"fire":{if("full"!==this.parent.H.displaymode)return;if(!this.stock.children.length)return;let e=this.stock.children[this.stock.children.length-1];e.rotation+=Math.max(.03*t.dT,.1*e.rotation*t.dT);break}}}},Do.generic.ns.b2b=class extends Ho{create(e){this.text||"off"!==te.video.actiontext&&"minimal"!==te.video.graphics&&"full"===this.parent.H.displaymode&&(this.text=new TheoryType.Text(`B2B \fc3X\f5${e}`,{font:Bn.get("hun"),rasterize:["minimal","low"].includes(te.video.graphics),fontSize:Ls(this.options.size),weight:600,tint:16767332,anchor:[1,0],...this.options.font_opts}),this.text.position.set(Ls(-10),Ls(this.options.y)),this.parent.H.leftside.addChild(this.text),this.animid=go.animate(this.text,{0:{letterSpacing:0},1:{letterSpacing:10}},6,BezierEasing(.1,.38,0,.88)))}update(e,t){if("full"===this.parent.H.displaymode)if(this.text)switch(go.stop(this.animid,0),e){case"up":this.text.text=`B2B \fc3X\f5${t}`,this.text.alpha=1,this.text.weight=600,this.text.tint=16767332,this.animid=go.animate(this.text,{0:{letterSpacing:0},1:{letterSpacing:10}},6,BezierEasing(.1,.38,0,.88));break;case"up_large":this.text.text=`B2B \fc3X\f5${t}`,this.text.weight=600,this.text.tint=16767332,this.animid=go.animate(this.text,{0:{alpha:1,letterSpacing:0},.16:{alpha:1,letterSpacing:0},.17:{alpha:0,letterSpacing:0},.33:{alpha:0,letterSpacing:0},.34:{alpha:1,letterSpacing:0},"0.50":{alpha:1,letterSpacing:0},.51:{alpha:0,letterSpacing:0},.66:{alpha:0,letterSpacing:0},.67:{alpha:.99,letterSpacing:0},1:{alpha:1,letterSpacing:10}},2,BezierEasing(.1,.38,0,.88));break;case"down":this.delete();break;case"down_large":this.text.tint=14950946,this.text.text="B2B \fc3X\f50",this.animid=go.animate(this.text,{0:{alpha:1,weight:600,letterSpacing:0},.1:{alpha:1,weight:600,letterSpacing:0},.105:{alpha:0,weight:600,letterSpacing:0},.2:{alpha:0,weight:600,letterSpacing:0},.205:{alpha:1,weight:600,letterSpacing:0},.3:{alpha:1,weight:600,letterSpacing:0},.305:{alpha:0,weight:600,letterSpacing:0},.4:{alpha:0,weight:600,letterSpacing:0},.405:{alpha:1,weight:600,letterSpacing:0},.5:{alpha:1,weight:600,letterSpacing:0},.505:{alpha:0,weight:600,letterSpacing:0},.6:{alpha:0,weight:600,letterSpacing:0},.605:{alpha:1,weight:600,letterSpacing:0},1:{alpha:0,weight:0,letterSpacing:10}},4,BezierEasing(.1,.38,0,.88),(()=>{this.delete()}))}else["up","up_large"].includes(e)&&this.create(t)}delete(){this.text&&(this.text.destroy(),this.text=null)}},Do.generic.ns.popup_defense=class extends Oo{create(e,t={}){if(this.text&&this.delete(),"off"===te.video.actiontext||"some"===te.video.actiontext)return;if("minimal"===te.video.graphics)return;if("full"!==this.parent.H.displaymode)return;this.text=new TheoryType.Text(e,{font:Bn.get("hun"),rasterize:"minimal"===te.video.graphics,fontSize:Ls(40+4*Math.min(10,e)),weight:700,tint:46335,anchor:[.5,.5],outlineTint:0,outlineWeight:950,outlineAlpha:1,misalignment:[1,3,.1],...this.options.font_opts});const s=.25*Math.random()-.125,a=.25*Math.random()-.125;this.text.rotation=s,this.text.position.set(Ls(fo.x*t.x),Ls(fo.x*(t.y-(this.parent.X.B()-.5)))),this.parent.H.holder.addChild(this.text);const n=Math.atan2(t.y-this.parent.X.B()-this.parent.X.Hh(),t.x-this.parent.X.Wh())+Math.PI/2;go.animate(this.text,{0:{x:Ls(fo.x*t.x),y:Ls(fo.x*(t.y-(this.parent.X.B()-.5))),rotation:s,alpha:1,weight:700},.8:{x:Ls(fo.x*t.x)-Ls(1.6*fo.x*Math.sin(n)),y:Ls(fo.x*(t.y-(this.parent.X.B()-.5)))+Ls(1.6*fo.x*Math.cos(n)),rotation:s+.8*a,alpha:.7,weight:700},1:{x:Ls(fo.x*t.x)-Ls(2*fo.x*Math.sin(n)),y:Ls(fo.x*(t.y-(this.parent.X.B()-.5)))+Ls(2*fo.x*Math.cos(n)),rotation:s+a,alpha:0,weight:500}},2,BezierEasing(.1,.38,0,.88),(()=>{this.delete()}))}delete(){this.text&&(this.text.destroy(),this.text=null)}},Do.generic.ns.popup_offence=class extends Oo{create(e,t={}){if(this.text&&this.delete(),"off"===te.video.actiontext||"some"===te.video.actiontext)return;if("minimal"===te.video.graphics)return;if("full"!==this.parent.H.displaymode)return;t.y=Math.min(t.y,39);const s=1.6+.12*Math.min(30,e);this.text=new TheoryType.Text(e,{font:Bn.get("hun"),rasterize:"minimal"===te.video.graphics,fontSize:Ls(fo.x*s),weight:600,tint:0,anchor:[.5,.5],outlineTint:16777215,outlineWeight:950,outlineAlpha:1,misalignment:[1+.1*Math.min(30,e),1+.1*Math.min(30,e),.2],useProjection:!0,projection:[[0,0],[1,0],[0,1],[1,1]],...this.options.font_opts});let a=Math.atan2(t.y-this.parent.X.B()-this.parent.X.Hh(),t.x-this.parent.X.Wh())+Math.PI/2,n=t.x,o=t.y,i=t.x+1.5*s*Math.sin(a),r=t.y-1.5*s*Math.cos(a);i=Math.min(13.5,Math.max(-3.5,i)),r=Math.min(42.5,Math.max(17.5,r));let l=!0;t.evasive&&!this.parent.ctx.bhm.IsInactive(i,r,e>=10)&&(i=t.x+3*s*Math.sin(a),r=t.y-3*s*Math.cos(a),i=Math.min(13.5,Math.max(-3.5,i)),r=Math.min(42.5,Math.max(17.5,r))),t.evasive&&e>=10&&i>=9&&(r-this.parent.X.B())/this.parent.X.H()>-.1&&(r-this.parent.X.B())/this.parent.X.H()<=.85&&(this.text.fillAlpha=.5,this.text.outlineAlpha=.75,l=!1),t.evasive&&e>=10&&i<=1&&(r-this.parent.X.B())/this.parent.X.H()>-.1&&(r-this.parent.X.B())/this.parent.X.H()<=.35&&(this.text.fillAlpha=.5,this.text.outlineAlpha=.75,l=!1),this.text.x=Ls(fo.x*n),this.text.y=Ls(fo.x*(o-(this.parent.X.B()-.5))),this.text.scale.set(0),this.parent.H.holder.addChild(this.text),a<-.25*Math.PI||a>1.25*Math.PI?(this.text.projection[0].x=.1*Math.random()-.05,this.text.projection[0].y=e>=10?-.1:-.05,this.text.projection[2].x=.1*Math.random()-.05,this.text.projection[2].y=e>=10?1.1:1.05,this.text.rotation=a-1.5*Math.PI,this.text.anchor.x=1):a<.25*Math.PI?(this.text.projection[0].x=-.05,this.text.projection[0].y=.1*Math.random()-.05,this.text.projection[1].x=1.05,this.text.projection[1].y=.1*Math.random()-.05,this.text.rotation=a,this.text.anchor.y=1):a<.75*Math.PI?(this.text.projection[1].x=.1*Math.random()-.05+1,this.text.projection[1].y=e>=10?-.1:-.05,this.text.projection[3].x=.1*Math.random()-.05+1,this.text.projection[3].y=e>=10?1.1:1.05,this.text.rotation=a-.5*Math.PI,this.text.anchor.x=0):(this.text.projection[2].x=-.05,this.text.projection[2].y=.1*Math.random()-.05+1,this.text.projection[3].x=1.05,this.text.projection[3].y=.1*Math.random()-.05+1,this.text.rotation=a-1*Math.PI,this.text.anchor.y=0);const c=e.toString();for(let e=0;e<c.length;e++)this.text.overrides.get(e).scale=.2,setTimeout((()=>{this.text&&!this.text._destroyed&&go.animate(this.text.overrides.get(e),{0:{scale:.2},1:{scale:1}},.2,BezierEasing(.03,.51,.61,.85))}),e*(250/c.length));go.animate(this.text,{0:{alpha:1,"scale.x":0,"scale.y":0,weight:600,x:Ls(fo.x*n),y:Ls(fo.x*(o-(this.parent.X.B()-.5)))},.3:{alpha:1,"scale.x":1,"scale.y":1,weight:700,x:Ls(fo.x*i),y:Ls(fo.x*(r-(this.parent.X.B()-.5)))},1:{alpha:0,"scale.x":1.1,"scale.y":1.1,weight:600,x:Ls(fo.x*i),y:Ls(fo.x*(r-(this.parent.X.B()-.5)))}},2,BezierEasing(0,.71,.51,.15),(()=>{this.delete()})),e>=20?go.animate(this.text,{0:{tint:16777215,outlineTint:0},.2:{tint:16777215,outlineTint:0},.201:{tint:0,outlineTint:16777215},.4:{tint:0,outlineTint:16777215},.401:{tint:16777215,outlineTint:0},.6:{tint:16777215,outlineTint:0},.601:{tint:0,outlineTint:16777215},.8:{tint:0,outlineTint:16777215},.801:{tint:16777215,outlineTint:0},.999:{tint:16777215,outlineTint:0},1:{tint:0,outlineTint:16777215}},.5):e>=10&&go.animate(this.text,{0:{tint:16777215,outlineTint:0},.33:{tint:16777215,outlineTint:0},.331:{tint:0,outlineTint:16777215},.66:{tint:0,outlineTint:16777215},.661:{tint:16777215,outlineTint:0},.999:{tint:16777215,outlineTint:0},1:{tint:0,outlineTint:16777215}},.33),t.evasive&&l&&(this.activeFade=new Do.generic.ns._helper_activefade({positions:[[i,r,e>=10]],elements:[this.text],keyvalues:[["fillAlpha",1,.15],["outlineAlpha",1,.35]],ctx:this.parent.ctx,interval:5,speed:.05}))}delete(){this.text&&(this.text.destroy(),this.text=null)}progress(e){this.text&&this.activeFade&&this.activeFade.progress(e)}},Do.generic.ns.skyline=class extends Ho{create(){if("full"!==this.parent.H.displaymode)return;if(this.nsp)return;const e=this.options.offsets||[0,0,0,0];return this.nsp=new PIXI.NineSlicePlane(this.options.texture,...this.options.slices.map((e=>e?e+2:e))),this.nsp.width=Ts(fo.x*this.parent.X.W())+e[0]+e[2],this.nsp.height=this.options.height+e[1]+e[3],this.nsp.position.set(-Is(e[0]),-Is(e[1])),this.nsp.alpha=.5,this.nsp.scale.set(Is(1)),this.parent.H.holder.addChild(this.nsp),this}update(){this.nsp||this.create(),this.nsp.alpha=.25*Math.random()+.5}delete(){this.nsp&&(this.nsp.destroy(),this.nsp=null)}},Do.generic.ns.garbagedangericon=class extends Ho{create(){if("full"===this.parent.H.displaymode&&!this.spr)return this.spr=new PIXI.Sprite(this.options.texture),this.spr.anchor.set(.5,.5),this.spr.position.set(0,Ls(fo.x*this.parent.X.Hh())),this.spr.scale.set(0),this.parent.H.holder.addChild(this.spr),go.animate(this.spr,{0:{"scale.x":0,"scale.y":0},.05:{"scale.x":Is(2*this.options.scale),"scale.y":Is(2*this.options.scale)},.1:{"scale.x":Is(1*this.options.scale),"scale.y":Is(1*this.options.scale)},.2:{"scale.x":Is(2*this.options.scale),"scale.y":Is(2*this.options.scale)},.3:{"scale.x":Is(1*this.options.scale),"scale.y":Is(1*this.options.scale)},.5:{"scale.x":Is(2*this.options.scale),"scale.y":Is(2*this.options.scale)},1:{"scale.x":Is(1*this.options.scale),"scale.y":Is(1*this.options.scale)}},5,BezierEasing(.03,.8,.5,.93)),this}delete(){this.spr&&(this.spr.destroy(),this.spr=null)}},Do.generic.ns.targeticon=class extends Ho{create(){if(!this.spr)return this.spr=new PIXI.Sprite(this.options.texture),this.spr.anchor.set(.5,.5),this.spr.position.set(Ls(fo.x*this.parent.X.Wh()),Ls(fo.x*this.parent.X.Hh())),this.spr.scale.set(0),this.parent.H.holder.addChild(this.spr),"tiny"!==this.parent.H.displaymode?go.animate(this.spr,{0:{"scale.x":0,"scale.y":0},.2:{"scale.x":Is(4*this.options.scale),"scale.y":Is(4*this.options.scale)},1:{"scale.x":Is(3*this.options.scale),"scale.y":Is(3*this.options.scale)}},.3,BezierEasing(.03,.8,.5,.93)):this.spr.scale.set(Is(4*this.options.scale)),this}delete(){this.spr&&(this.spr.destroy(),this.spr=null)}},Do.generic.ns.next=class extends Ho{create(){if("tiny"===this.parent.H.displaymode)return;if(!1===this.parent.S.setoptions.display_next)return;const e=this.options.offsets||[0,0,0,0];this.nsp=new PIXI.NineSlicePlane(this.options.texture,...this.options.slices.map((e=>e?e+2:e))),this.nsp.width=Ts(36+4*fo.x)+e[0]+e[2],this.nsp.height=Ts(28+3*fo.x*(this.parent.S.setoptions.nextcount||5))+e[1]+e[3],this.nsp.position.set(-Is(e[0]),-Is(e[1])),this.nsp.scale.set(Is(1)),this.parent.H.rightside.addChild(this.nsp),this.parent.H.tintables.push(this.nsp),this.containers=[];for(let t=0;t<this.parent.S.setoptions.nextcount;t++)this.containers[t]=new PIXI.Container,this.containers[t].position.set(Ts(18+2*fo.x)+e[0],Ts(27+1.5*fo.x+3*fo.x*t)+e[1]),this.containers[t].scale.set(Ss(1)),this.nsp.addChild(this.containers[t]);return this.containers}},Do.generic.ns.hold=class extends Ho{create(){if("tiny"===this.parent.H.displaymode)return;if(!1===this.parent.S.setoptions.display_hold)return;const e=this.options.offsets||[0,0,0,0];return this.nsp=new PIXI.NineSlicePlane(this.options.texture,...this.options.slices.map((e=>e?e+2:e))),this.nsp.width=Ts(36+4*fo.x)+e[0]+e[2],this.nsp.height=Ts(28+3*fo.x)+e[1]+e[3],this.nsp.position.set(-Ls(36+4*fo.x)-Is(e[0]),-Is(e[1])),this.nsp.scale.set(Is(1)),this.parent.H.leftside.addChild(this.nsp),this.parent.H.tintables.push(this.nsp),this.container=new PIXI.Container,this.container.position.set(Ts(18+2*fo.x)+e[0],Ts(27+1.5*fo.x)+e[1]),this.container.scale.set(Ss(1)),this.nsp.addChild(this.container),this.container}},Do.generic.ns.splash=class extends Oo{create(e,t={}){if(this.text&&this.delete(),"off"!==te.video.actiontext&&"minimal"!==te.video.graphics&&"full"===this.parent.H.displaymode)switch(this.text=new TheoryType.Text(e,{font:Bn.get("hun"),rasterize:"minimal"===te.video.graphics,fontSize:Ls(this.options.size),weight:600,tint:t.color||this.options.color,anchor:[1,0],...this.options.font_opts}),this.text.position.set(Ls(-10),Ls(this.options.y)),this.parent.H.leftside.addChild(this.text),this.options.animation){case"normal":go.animate(this.text,{0:{letterSpacing:0,alpha:1,weight:600},.6:{letterSpacing:10,alpha:.95,weight:570},1:{letterSpacing:20,alpha:0,weight:0}},6,BezierEasing(.1,.38,0,.88),(()=>{this.delete()}));break;case"bounce":go.animate(this.text,{0:{y:`${this.options.y}r`,alpha:1,weight:600},.1:{y:this.options.y-10+"r",alpha:1,weight:600},.2:{y:`${this.options.y}r`,alpha:1,weight:600},.6:{y:`${this.options.y}r`,alpha:.95,weight:570},1:{y:`${this.options.y}r`,alpha:0,weight:0}},6,BezierEasing(.1,.38,0,.88),(()=>{this.delete()}))}}delete(){this.text&&(this.text.destroy(),this.text=null)}},Do.generic.ns.shout=class extends Oo{create(e,t={}){"full"===this.parent.H.displaymode&&(this.text&&this.delete(),this.options.hasShadow&&"minimal"!==te.video.graphics&&(this.textShadow=new TheoryType.Text(e,{font:Bn.get("hun"),rasterize:"minimal"===te.video.graphics,fontSize:Ls(this.options.size/this.parent.X.S()),weight:700,tint:this.options.shadowColor,anchor:[.5,.5],align:"center",...this.options.font_opts}),this.textShadow.blendMode=PIXI.BLEND_MODES.SCREEN,this.textShadow.position.set(Ls(fo.x*this.parent.X.Wh()),this.options.y),this.parent.H.holder.addChild(this.textShadow)),this.text=new TheoryType.Text(e,{font:Bn.get("hun"),rasterize:"minimal"===te.video.graphics,fontSize:Ls(this.options.size/this.parent.X.S()),weight:700,tint:this.options.color,anchor:[.5,.5],align:"center",...this.options.font_opts}),this.text.blendMode=PIXI.BLEND_MODES.SCREEN,this.text.position.set(Ls(fo.x*this.parent.X.Wh()),this.options.y),this.parent.H.holder.addChild(this.text),"minimal"!==te.video.graphics?(go.animate(this.text,this.options.animation,this.options.animationDuration,this.options.animationEasing,(()=>{this.delete()})),this.options.hasShadow&&go.animate(this.textShadow,this.options.animationShadow,this.options.animationShadowDuration,this.options.animationShadowEasing,(()=>{this.textShadow.destroy()}))):setTimeout((()=>{this.delete()}),1e3*(this.options.flatAnimationDuration||0)||1e3*this.options.animationDuration),"ultra"===te.video.graphics&&this.options.ultra&&setTimeout((()=>{const e=ao(this.parent.H.holder,this.text.x,this.text.y);this.options.ultra(e.x,e.y)}),10))}delete(){this.text&&(this.text.destroy(),this.text=null),this.textShadow&&(this.textShadow.destroy(),this.textShadow=null)}},Do.generic.ns.username=class extends Ho{create(){const e=this.options.offsets||[0,0,0,0],t=this.options.offsets_fire||[0,0,0,0];this.parent.S.setoptions.display_username&&("tiny"===this.parent.H.displaymode&&"low"===te.video.caching||(this.bg=new PIXI.NineSlicePlane(this.options.texture,...this.options.slices.map((e=>e?e+2:e))),this.bg.width=Ts(fo.x*this.parent.X.W())+e[0]+e[2],this.bg.height=Ts(26)+e[1]+e[3],this.bg.scale.set(Is(1)),this.bg.position.set(Ls(fo.x*this.parent.X.Wh()),Ls(fo.x*this.parent.X.H()+10)),this.bg.pivot.set(Ts(fo.x*this.parent.X.Wh())+e[0],e[1]),this.parent.H.holder.addChild(this.bg),this.parent.H.tintables.push(this.bg),this.parent.S.setoptions.display_fire&&(this.fg=new PIXI.NineSlicePlane(this.options.texture_fire,...this.options.slices_fire.map((e=>e?e+2:e))),this.fg.width=0,this.fg.height=Ts(26)+t[1]+t[3],this.fg.scale.set(Is(1)),this.fg.alpha=0,this.fg.position.set(Ls(fo.x*this.parent.X.Wh()),Ls(fo.x*this.parent.X.H()+10)),this.fg.pivot.set(0,t[1]),this.parent.H.holder.addChild(this.fg),this.parent.H.tintables.push(this.fg)),this.text=new TheoryType.Text(this.parent.S.setoptions.username.toUpperCase()||"",{font:Bn.get("hun"),rasterize:"minimal"===te.video.graphics,fontSize:Ls(19),weight:600,tint:16777215,anchor:[.5,0],...this.options.font_opts}),this.text.position.set(Ls(fo.x*this.parent.X.Wh()),Ls(fo.x*this.parent.X.H()+15)),this.parent.H.holder.addChild(this.text),this.parent.H.hybridtintables.push(this.text)))}update(e){if(!this.fg)return;const t=this.options.offsets_fire||[0,0,0,0];if("tiny"===this.parent.H.displaymode)this.fg.alpha=e>=500?.2+Math.min(.7,(e-500)/20):0,this.fg.width=Ts(fo.x*this.parent.X.W())+t[0]+t[2],this.fg.pivot.x=Ts(fo.x*this.parent.X.Wh());else{this.fg.alpha=e>=500?.2+Math.min(.7,(e-500)/20):.1+e/3500;const s=e>=500?1+(e-500)/1500:e/500;this.fg.width=(Ts(fo.x*this.parent.X.W())+t[0]+t[2])*s,this.fg.pivot.x=Ts(fo.x*this.parent.X.Wh())*s}}action(e){switch(e){case"startfire":{const e=ao(this.parent.H.stackobj,0,0);xn.play("fire_flair",{x:e.x,y:e.y,w:this.parent.X.W()*this.parent.X.S(),h:this.parent.X.H()*this.parent.X.S()});break}case"continuefire":if("tiny"===this.parent.H.displaymode){const e=ao(this.parent.H.holder,Ls(fo.x*this.parent.X.Wh()),Ls(fo.x*this.parent.X.Hh()));xn.play("fire_burning",{x:e.x,y:e.y})}else{const e=ao(this.parent.H.stackobj,0,0);xn.play("fire_burn",{x:e.x,y:e.y,w:this.parent.X.W()*this.parent.X.S(),h:this.parent.X.H()*this.parent.X.S()})}}}},Do.generic.ns.replaytag=class extends Ho{create(){if("full"===this.parent.H.displaymode&&this.parent.S.setoptions.display_replay)return this.spr=new PIXI.Sprite(this.options.texture),this.spr.anchor.set(1,0),this.spr.position.set(Ls(fo.x*this.parent.X.W()),Ls(.5*fo.x)),this.spr.scale.set(Is(1)),this.parent.H.holder.addChild(this.spr),this.parent.H.tintables.push(this.spr),["minimal","low"].includes(te.video.graphics)||(this.activeFade=new Do.generic.ns._helper_activefade({positions:[[this.parent.X.W()-5,this.parent.X.B()+1],[this.parent.X.W()-3,this.parent.X.B()+1],[this.parent.X.W()-1,this.parent.X.B()+1]],elements:[this.spr],alphaHigh:1,alphaLow:.5,ctx:this.parent.ctx})),this}progress(e){this.activeFade&&this.activeFade.progress(e)}},Do.generic.ns._helper_activefade=class{constructor(e){"full"===e.ctx.hm.H.displaymode&&"minimal"!==te.video.graphics&&(this.options=e,this.tick=0,this.state=!0)}progress(e){"full"===this.options.ctx.hm.H.displaymode&&"minimal"!==te.video.graphics&&(this.tick+=e,this.tick>=(this.options.interval||15)&&(this.tick-=this.options.interval||15,this._check()))}_check(){const e=this.options.positions.every((e=>this.options.ctx.bhm.IsInactive(...e)));e!==this.state&&(e?this._animateInactive():this._animateActive(),this.state=e)}_animateInactive(){for(const e of this.options.elements){const t={0:{},1:{}};if(this.options.keyvalues)for(const e of this.options.keyvalues)t[0][e[0]]=e[2],t[1][e[0]]=e[1];else t[0]={alpha:this.options.alphaLow},t[1]={alpha:this.options.alphaHigh};go.animate(e,t,.2)}}_animateActive(){for(const e of this.options.elements){const t={0:{},1:{}};if(this.options.keyvalues)for(const e of this.options.keyvalues)t[0][e[0]]=e[1],t[1][e[0]]=e[2];else t[0]={alpha:this.options.alphaHigh},t[1]={alpha:this.options.alphaLow};go.animate(e,t,this.options.speed||.1)}}};const No={minotypes:["z","l","o","s","i","j","t"],tetrominoes:{z:{matrix:{w:3,h:3,dx:1,dy:1,data:[[[0,0,199],[1,0,114],[1,1,39],[2,1,124]],[[2,0,241],[1,1,201],[2,1,156],[1,2,31]],[[0,1,199],[1,1,114],[1,2,39],[2,2,124]],[[1,0,241],[0,1,201],[1,1,156],[0,2,31]]]},preview:{w:3,h:2,data:[[0,0,199],[1,0,114],[1,1,39],[2,1,124]]}},l:{matrix:{w:3,h:3,dx:1,dy:1,data:[[[2,0,241],[0,1,199],[1,1,68],[2,1,156]],[[1,0,241],[1,1,17],[1,2,39],[2,2,124]],[[0,1,201],[1,1,68],[2,1,124],[0,2,31]],[[0,0,199],[1,0,114],[1,1,17],[1,2,31]]]},preview:{w:3,h:2,data:[[2,0,241],[0,1,199],[1,1,68],[2,1,156]]}},o:{matrix:{w:2,h:2,dx:0,dy:1,data:[[[0,0,193],[1,0,112],[0,1,7],[1,1,28]],[[0,0,193],[1,0,112],[0,1,7],[1,1,28]],[[0,0,193],[1,0,112],[0,1,7],[1,1,28]],[[0,0,193],[1,0,112],[0,1,7],[1,1,28]]]},preview:{w:2,h:2,data:[[0,0,193],[1,0,112],[0,1,7],[1,1,28]]}},s:{matrix:{w:3,h:3,dx:1,dy:1,data:[[[1,0,201],[2,0,124],[0,1,199],[1,1,156]],[[1,0,241],[1,1,39],[2,1,114],[2,2,31]],[[1,1,201],[2,1,124],[0,2,199],[1,2,156]],[[0,0,241],[0,1,39],[1,1,114],[1,2,31]]]},preview:{w:3,h:2,data:[[1,0,201],[2,0,124],[0,1,199],[1,1,156]]}},i:{matrix:{w:4,h:4,dx:1,dy:1,data:[[[0,1,199],[1,1,68],[2,1,68],[3,1,124]],[[2,0,241],[2,1,17],[2,2,17],[2,3,31]],[[0,2,199],[1,2,68],[2,2,68],[3,2,124]],[[1,0,241],[1,1,17],[1,2,17],[1,3,31]]]},preview:{w:4,h:1,data:[[0,0,199],[1,0,68],[2,0,68],[3,0,124]]}},j:{matrix:{w:3,h:3,dx:1,dy:1,data:[[[0,0,241],[0,1,39],[1,1,68],[2,1,124]],[[1,0,201],[2,0,124],[1,1,17],[1,2,31]],[[0,1,199],[1,1,68],[2,1,114],[2,2,31]],[[1,0,241],[1,1,17],[0,2,199],[1,2,156]]]},preview:{w:3,h:2,data:[[0,0,241],[0,1,39],[1,1,68],[2,1,124]]}},t:{matrix:{w:3,h:3,dx:1,dy:1,data:[[[1,0,241],[0,1,199],[1,1,164],[2,1,124]],[[1,0,241],[1,1,41],[2,1,124],[1,2,31]],[[0,1,199],[1,1,74],[2,1,124],[1,2,31]],[[1,0,241],[0,1,199],[1,1,146],[1,2,31]]]},preview:{w:3,h:2,data:[[1,0,241],[0,1,199],[1,1,164],[2,1,124]]}}},kicksets:{SRS:{kicks:{"01":[[-1,0],[-1,-1],[0,2],[-1,2]],10:[[1,0],[1,1],[0,-2],[1,-2]],12:[[1,0],[1,1],[0,-2],[1,-2]],21:[[-1,0],[-1,-1],[0,2],[-1,2]],23:[[1,0],[1,-1],[0,2],[1,2]],32:[[-1,0],[-1,1],[0,-2],[-1,-2]],30:[[-1,0],[-1,1],[0,-2],[-1,-2]],"03":[[1,0],[1,-1],[0,2],[1,2]],"02":[[0,-1],[1,-1],[-1,-1],[1,0],[-1,0]],13:[[1,0],[1,-2],[1,-1],[0,-2],[0,-1]],20:[[0,1],[-1,1],[1,1],[-1,0],[1,0]],31:[[-1,0],[-1,-2],[-1,-1],[0,-2],[0,-1]]},i_kicks:{"01":[[-2,0],[1,0],[-2,1],[1,-2]],10:[[2,0],[-1,0],[2,-1],[-1,2]],12:[[-1,0],[2,0],[-1,-2],[2,1]],21:[[1,0],[-2,0],[1,2],[-2,-1]],23:[[2,0],[-1,0],[2,-1],[-1,2]],32:[[-2,0],[1,0],[-2,1],[1,-2]],30:[[1,0],[-2,0],[1,2],[-2,-1]],"03":[[-1,0],[2,0],[-1,-2],[2,1]],"02":[],13:[],20:[],31:[]},additional_offsets:{z:[[0,0],[0,0],[0,0],[0,0]],l:[[0,0],[0,0],[0,0],[0,0]],o:[[0,0],[0,0],[0,0],[0,0]],s:[[0,0],[0,0],[0,0],[0,0]],i:[[0,0],[0,0],[0,0],[0,0]],j:[[0,0],[0,0],[0,0],[0,0]],t:[[0,0],[0,0],[0,0],[0,0]]},spawn_rotation:{z:0,l:0,o:0,s:0,i:0,j:0,t:0},colorMap:{z:"z",l:"l",o:"o",s:"s",i:"i",j:"j",t:"t",g:"g",d:"d",gb:"gb",gbd:"gbd"},preview_overrides:{}},"SRS+":{kicks:{"01":[[-1,0],[-1,-1],[0,2],[-1,2]],10:[[1,0],[1,1],[0,-2],[1,-2]],12:[[1,0],[1,1],[0,-2],[1,-2]],21:[[-1,0],[-1,-1],[0,2],[-1,2]],23:[[1,0],[1,-1],[0,2],[1,2]],32:[[-1,0],[-1,1],[0,-2],[-1,-2]],30:[[-1,0],[-1,1],[0,-2],[-1,-2]],"03":[[1,0],[1,-1],[0,2],[1,2]],"02":[[0,-1],[1,-1],[-1,-1],[1,0],[-1,0]],13:[[1,0],[1,-2],[1,-1],[0,-2],[0,-1]],20:[[0,1],[-1,1],[1,1],[-1,0],[1,0]],31:[[-1,0],[-1,-2],[-1,-1],[0,-2],[0,-1]]},i_kicks:{"01":[[1,0],[-2,0],[-2,1],[1,-2]],10:[[-1,0],[2,0],[-1,2],[2,-1]],12:[[-1,0],[2,0],[-1,-2],[2,1]],21:[[-2,0],[1,0],[-2,-1],[1,2]],23:[[2,0],[-1,0],[2,-1],[-1,2]],32:[[1,0],[-2,0],[1,-2],[-2,1]],30:[[1,0],[-2,0],[1,2],[-2,-1]],"03":[[-1,0],[2,0],[2,1],[-1,-2]],"02":[[0,-1]],13:[[1,0]],20:[[0,1]],31:[[-1,0]]},additional_offsets:{z:[[0,0],[0,0],[0,0],[0,0]],l:[[0,0],[0,0],[0,0],[0,0]],o:[[0,0],[0,0],[0,0],[0,0]],s:[[0,0],[0,0],[0,0],[0,0]],i:[[0,0],[0,0],[0,0],[0,0]],j:[[0,0],[0,0],[0,0],[0,0]],t:[[0,0],[0,0],[0,0],[0,0]]},spawn_rotation:{z:0,l:0,o:0,s:0,i:0,j:0,t:0},colorMap:{z:"z",l:"l",o:"o",s:"s",i:"i",j:"j",t:"t",g:"g",d:"d",gb:"gb",gbd:"gbd"},preview_overrides:{}},"SRS-X":{kicks:{"01":[[-1,0],[-1,-1],[0,2],[-1,2]],10:[[1,0],[1,1],[0,-2],[1,-2]],12:[[1,0],[1,1],[0,-2],[1,-2]],21:[[-1,0],[-1,-1],[0,2],[-1,2]],23:[[1,0],[1,-1],[0,2],[1,2]],32:[[-1,0],[-1,1],[0,-2],[-1,-2]],30:[[-1,0],[-1,1],[0,-2],[-1,-2]],"03":[[1,0],[1,-1],[0,2],[1,2]],"02":[[1,0],[2,0],[1,1],[2,1],[-1,0],[-2,0],[-1,1],[-2,1],[0,-1],[3,0],[-3,0]],13:[[0,1],[0,2],[-1,1],[-1,2],[0,-1],[0,-2],[-1,-1],[-1,-2],[1,0],[0,3],[0,-3]],20:[[-1,0],[-2,0],[-1,-1],[-2,-1],[1,0],[2,0],[1,-1],[2,-1],[0,1],[-3,0],[3,0]],31:[[0,1],[0,2],[1,1],[1,2],[0,-1],[0,-2],[1,-1],[1,-2],[-1,0],[0,3],[0,-3]]},i_kicks:{"01":[[-2,0],[1,0],[-2,1],[1,-2]],10:[[2,0],[-1,0],[2,-1],[-1,2]],12:[[-1,0],[2,0],[-1,-2],[2,1]],21:[[1,0],[-2,0],[1,2],[-2,-1]],23:[[2,0],[-1,0],[2,-1],[-1,2]],32:[[-2,0],[1,0],[-2,1],[1,-2]],30:[[1,0],[-2,0],[1,2],[-2,-1]],"03":[[-1,0],[2,0],[-1,-2],[2,1]],"02":[[-1,0],[-2,0],[1,0],[2,0],[0,1]],13:[[0,1],[0,2],[0,-1],[0,-2],[-1,0]],20:[[1,0],[2,0],[-1,0],[-2,0],[0,-1]],31:[[0,1],[0,2],[0,-1],[0,-2],[1,0]]},additional_offsets:{z:[[0,0],[0,0],[0,0],[0,0]],l:[[0,0],[0,0],[0,0],[0,0]],o:[[0,0],[0,0],[0,0],[0,0]],s:[[0,0],[0,0],[0,0],[0,0]],i:[[0,0],[0,0],[0,0],[0,0]],j:[[0,0],[0,0],[0,0],[0,0]],t:[[0,0],[0,0],[0,0],[0,0]]},spawn_rotation:{z:0,l:0,o:0,s:0,i:0,j:0,t:0},colorMap:{z:"z",l:"l",o:"o",s:"s",i:"i",j:"j",t:"t",g:"g",d:"d",gb:"gb",gbd:"gbd"},preview_overrides:{}},"TETRA-X":{kicks:{"01":[[0,1],[-1,0],[1,0],[-1,1],[1,1],[0,-1],[-1,-1],[1,-1]],10:[[0,1],[1,0],[-1,0],[1,1],[-1,1],[0,-1],[1,-1],[-1,-1]],12:[[0,1],[-1,0],[1,0],[-1,1],[1,1],[0,-1],[-1,-1],[1,-1]],21:[[0,1],[1,0],[-1,0],[1,1],[-1,1],[0,-1],[1,-1],[-1,-1]],23:[[0,1],[-1,0],[1,0],[-1,1],[1,1],[0,-1],[-1,-1],[1,-1]],32:[[0,1],[1,0],[-1,0],[1,1],[-1,1],[0,-1],[1,-1],[-1,-1]],30:[[0,1],[-1,0],[1,0],[-1,1],[1,1],[0,-1],[-1,-1],[1,-1]],"03":[[0,1],[1,0],[-1,0],[1,1],[-1,1],[0,-1],[1,-1],[-1,-1]],"02":[[0,1],[0,-1],[-1,0],[1,0]],13:[[0,1],[0,-1],[-1,0],[1,0]],20:[[0,1],[0,-1],[-1,0],[1,0]],31:[[0,1],[0,-1],[-1,0],[1,0]]},i_kicks:{"01":[[0,-1],[0,-2],[0,1],[1,-1],[-1,-1],[1,-2],[-1,-2]],10:[[0,-1],[0,-2],[0,1],[-1,0],[1,0],[2,0]],12:[[0,-1],[0,-2],[0,1],[-1,0],[1,0],[2,0]],21:[[0,1],[0,2],[0,-1],[-1,1],[1,1],[-1,2],[1,2]],23:[[0,1],[0,2],[0,-1],[1,1],[-1,1],[1,2],[-1,2]],32:[[0,-1],[0,-2],[0,1],[1,0],[-1,0],[-2,0]],30:[[0,-1],[0,-2],[0,1],[1,0],[-1,0],[-2,0]],"03":[[0,-1],[0,-2],[0,1],[-1,-1],[1,-1],[-1,-2],[1,-2]],"02":[[0,-1],[0,1]],13:[[0,-1],[0,1]],20:[[0,-1],[0,1]],31:[[0,-1],[0,1]]},additional_offsets:{z:[[0,0],[0,0],[0,0],[0,0]],l:[[0,0],[0,0],[0,0],[0,0]],o:[[0,0],[0,0],[0,0],[0,0]],s:[[0,0],[0,0],[0,0],[0,0]],i:[[0,0],[0,0],[0,0],[0,0]],j:[[0,0],[0,0],[0,0],[0,0]],t:[[0,0],[0,0],[0,0],[0,0]]},spawn_rotation:{z:0,l:0,o:0,s:0,i:0,j:0,t:0},colorMap:{z:"z",l:"o",o:"s",s:"i",i:"l",j:"j",t:"t",g:"g",d:"d",gb:"gb",gbd:"gbd"},preview_overrides:{}},NRS:{kicks:{"01":[],10:[],12:[],21:[],23:[],32:[],30:[],"03":[],"02":[],13:[],20:[],31:[]},i_kicks:{"01":[],10:[],12:[],21:[],23:[],32:[],30:[],"03":[],"02":[],13:[],20:[],31:[]},additional_offsets:{z:[[1,1],[1,0],[1,0],[2,0]],l:[[1,0],[1,0],[1,0],[1,0]],o:[[0,0],[0,0],[0,0],[0,0]],s:[[1,1],[1,0],[1,0],[2,0]],i:[[0,1],[0,0],[0,0],[1,0]],j:[[1,0],[1,0],[1,0],[1,0]],t:[[1,0],[1,0],[1,0],[1,0]]},spawn_rotation:{z:0,l:2,o:0,s:0,i:0,j:2,t:2},colorMap:{z:"z",l:"l",o:"o",s:"s",i:"i",j:"j",t:"t",g:"g",d:"d",gb:"gb",gbd:"gbd"},preview_overrides:{l:[[0,0,201],[1,0,68],[2,0,124],[0,1,31]],j:[[0,0,199],[1,0,68],[2,0,114],[2,1,31]],t:[[0,0,199],[1,0,74],[2,0,124],[1,1,31]]}},ARS:{kicks:{"01":[[1,0],[-1,0]],10:[[1,0],[-1,0]],12:[[1,0],[-1,0]],21:[[1,0],[-1,0]],23:[[1,0],[-1,0]],32:[[1,0],[-1,0]],30:[[1,0],[-1,0]],"03":[[1,0],[-1,0]],"02":[[1,0],[-1,0]],13:[[1,0],[-1,0]],20:[[1,0],[-1,0]],31:[[1,0],[-1,0]]},i_kicks:{"01":[],10:[],12:[],21:[],23:[],32:[],30:[],"03":[],"02":[],13:[],20:[],31:[]},additional_offsets:{z:[[0,1],[0,0],[0,0],[1,0]],l:[[0,1],[0,0],[0,0],[0,0]],o:[[0,0],[0,0],[0,0],[0,0]],s:[[0,1],[-1,0],[0,0],[0,0]],i:[[0,0],[0,0],[0,-1],[1,0]],j:[[0,1],[0,0],[0,0],[0,0]],t:[[0,1],[0,0],[0,0],[0,0]]},spawn_rotation:{z:0,l:2,o:0,s:0,i:0,j:2,t:2},colorMap:{z:"s",l:"l",o:"o",s:"t",i:"z",j:"j",t:"i",g:"g",d:"d",gb:"gb",gbd:"gbd"},preview_overrides:{l:[[0,0,201],[1,0,68],[2,0,124],[0,1,31]],j:[[0,0,199],[1,0,68],[2,0,114],[2,1,31]],t:[[0,0,199],[1,0,74],[2,0,124],[1,1,31]]},center_column:[[-1,-1],[0,-1],[1,-1],[-1,0],[0,0],[1,0],[-1,1],[0,1],[1,1]]},ASC:{kicks:{"01":[[-1,0],[0,1],[-1,1],[0,2],[-1,2],[-2,0],[-2,1],[-2,2],[1,0],[1,1],[0,-1],[-1,-1],[-2,-1],[1,2],[2,0],[0,-2],[-1,-2],[-2,-2],[2,1],[2,2],[1,-1]],10:[[1,0],[0,1],[1,1],[0,2],[1,2],[2,0],[2,1],[2,2],[-1,0],[-1,1],[0,-1],[1,-1],[2,-1],[-1,2],[-2,0],[0,-2],[1,-2],[2,-2],[-2,1],[-2,2],[-1,-1]],12:[[-1,0],[0,1],[-1,1],[0,2],[-1,2],[-2,0],[-2,1],[-2,2],[1,0],[1,1],[0,-1],[-1,-1],[-2,-1],[1,2],[2,0],[0,-2],[-1,-2],[-2,-2],[2,1],[2,2],[1,-1]],21:[[1,0],[0,1],[1,1],[0,2],[1,2],[2,0],[2,1],[2,2],[-1,0],[-1,1],[0,-1],[1,-1],[2,-1],[-1,2],[-2,0],[0,-2],[1,-2],[2,-2],[-2,1],[-2,2],[-1,-1]],23:[[-1,0],[0,1],[-1,1],[0,2],[-1,2],[-2,0],[-2,1],[-2,2],[1,0],[1,1],[0,-1],[-1,-1],[-2,-1],[1,2],[2,0],[0,-2],[-1,-2],[-2,-2],[2,1],[2,2],[1,-1]],32:[[1,0],[0,1],[1,1],[0,2],[1,2],[2,0],[2,1],[2,2],[-1,0],[-1,1],[0,-1],[1,-1],[2,-1],[-1,2],[-2,0],[0,-2],[1,-2],[2,-2],[-2,1],[-2,2],[-1,-1]],30:[[-1,0],[0,1],[-1,1],[0,2],[-1,2],[-2,0],[-2,1],[-2,2],[1,0],[1,1],[0,-1],[-1,-1],[-2,-1],[1,2],[2,0],[0,-2],[-1,-2],[-2,-2],[2,1],[2,2],[1,-1]],"03":[[1,0],[0,1],[1,1],[0,2],[1,2],[2,0],[2,1],[2,2],[-1,0],[-1,1],[0,-1],[1,-1],[2,-1],[-1,2],[-2,0],[0,-2],[1,-2],[2,-2],[-2,1],[-2,2],[-1,-1]],"02":[],13:[],20:[],31:[]},i_kicks:{"01":[[-1,0],[0,1],[-1,1],[0,2],[-1,2],[-2,0],[-2,1],[-2,2],[1,0],[1,1],[0,-1],[-1,-1],[-2,-1],[1,2],[2,0],[0,-2],[-1,-2],[-2,-2],[2,1],[2,2],[1,-1]],10:[[1,0],[0,1],[1,1],[0,2],[1,2],[2,0],[2,1],[2,2],[-1,0],[-1,1],[0,-1],[1,-1],[2,-1],[-1,2],[-2,0],[0,-2],[1,-2],[2,-2],[-2,1],[-2,2],[-1,-1]],12:[[-1,0],[0,1],[-1,1],[0,2],[-1,2],[-2,0],[-2,1],[-2,2],[1,0],[1,1],[0,-1],[-1,-1],[-2,-1],[1,2],[2,0],[0,-2],[-1,-2],[-2,-2],[2,1],[2,2],[1,-1]],21:[[1,0],[0,1],[1,1],[0,2],[1,2],[2,0],[2,1],[2,2],[-1,0],[-1,1],[0,-1],[1,-1],[2,-1],[-1,2],[-2,0],[0,-2],[1,-2],[2,-2],[-2,1],[-2,2],[-1,-1]],23:[[-1,0],[0,1],[-1,1],[0,2],[-1,2],[-2,0],[-2,1],[-2,2],[1,0],[1,1],[0,-1],[-1,-1],[-2,-1],[1,2],[2,0],[0,-2],[-1,-2],[-2,-2],[2,1],[2,2],[1,-1]],32:[[1,0],[0,1],[1,1],[0,2],[1,2],[2,0],[2,1],[2,2],[-1,0],[-1,1],[0,-1],[1,-1],[2,-1],[-1,2],[-2,0],[0,-2],[1,-2],[2,-2],[-2,1],[-2,2],[-1,-1]],30:[[-1,0],[0,1],[-1,1],[0,2],[-1,2],[-2,0],[-2,1],[-2,2],[1,0],[1,1],[0,-1],[-1,-1],[-2,-1],[1,2],[2,0],[0,-2],[-1,-2],[-2,-2],[2,1],[2,2],[1,-1]],"03":[[1,0],[0,1],[1,1],[0,2],[1,2],[2,0],[2,1],[2,2],[-1,0],[-1,1],[0,-1],[1,-1],[2,-1],[-1,2],[-2,0],[0,-2],[1,-2],[2,-2],[-2,1],[-2,2],[-1,-1]],"02":[],13:[],20:[],31:[]},allow_o_kick:!0,additional_offsets:{z:[[0,0],[0,0],[0,0],[0,0]],l:[[0,0],[0,0],[0,0],[0,0]],o:[[0,0],[0,1],[-1,1],[-1,0]],s:[[0,0],[0,0],[0,0],[0,0]],i:[[0,0],[0,-1],[1,-1],[1,0]],j:[[0,0],[0,0],[0,0],[0,0]],t:[[0,0],[0,0],[0,0],[0,0]]},colorMap:{z:"z",l:"l",o:"o",s:"s",i:"i",j:"j",t:"t",g:"g",d:"d",gb:"gb",gbd:"gbd"},spawn_rotation:{z:0,l:0,o:0,s:0,i:0,j:0,t:0},preview_overrides:{}},none:{kicks:{"01":[],10:[],12:[],21:[],23:[],32:[],30:[],"03":[],"02":[],13:[],20:[],31:[]},i_kicks:{"01":[],10:[],12:[],21:[],23:[],32:[],30:[],"03":[],"02":[],13:[],20:[],31:[]},additional_offsets:{z:[[0,0],[0,0],[0,0],[0,0]],l:[[0,0],[0,0],[0,0],[0,0]],o:[[0,0],[0,0],[0,0],[0,0]],s:[[0,0],[0,0],[0,0],[0,0]],i:[[0,0],[0,0],[0,0],[0,0]],j:[[0,0],[0,0],[0,0],[0,0]],t:[[0,0],[0,0],[0,0],[0,0]]},colorMap:{z:"z",l:"l",o:"o",s:"s",i:"i",j:"j",t:"t",g:"g",d:"d",gb:"gb",gbd:"gbd"},spawn_rotation:{z:0,l:0,o:0,s:0,i:0,j:0,t:0},preview_overrides:{}}},scoring:{SINGLE:100,DOUBLE:300,TRIPLE:500,QUAD:800,TSPIN_MINI:100,TSPIN:400,TSPIN_MINI_SINGLE:200,TSPIN_SINGLE:800,TSPIN_MINI_DOUBLE:400,TSPIN_DOUBLE:1200,TSPIN_TRIPLE:1600,TSPIN_QUAD:2600,BACKTOBACK_MULTIPLIER:1.5,COMBO:50,ALL_CLEAR:3500,SOFTDROP:1,HARDDROP:2},garbage:{SINGLE:0,DOUBLE:1,TRIPLE:2,QUAD:4,TSPIN_MINI:0,TSPIN:0,TSPIN_MINI_SINGLE:0,TSPIN_SINGLE:2,TSPIN_MINI_DOUBLE:1,TSPIN_DOUBLE:4,TSPIN_TRIPLE:6,TSPIN_QUAD:10,BACKTOBACK_BONUS:1,BACKTOBACK_BONUS_LOG:.8,COMBO_MINIFIER:1,COMBO_MINIFIER_LOG:1.25,COMBO_BONUS:.25,ALL_CLEAR:10},finesse:{z:{0:[9,9,1,2,1,0,1,2,2,1,9],1:[9,2,2,2,1,1,2,3,2,2,9],2:[9,9,1,2,1,0,1,2,2,1,9],3:[9,9,2,2,2,1,1,2,3,2,2]},l:{0:[9,9,1,2,1,0,1,2,2,1,9],1:[9,2,2,3,2,1,2,3,3,2,9],2:[9,9,3,4,3,2,3,4,4,3,9],3:[9,9,2,3,2,1,2,3,3,2,2]},o:{0:[9,1,2,2,1,0,1,2,2,1,9],1:[9,1,2,2,1,0,1,2,2,1,9],2:[9,1,2,2,1,0,1,2,2,1,9],3:[9,1,2,2,1,0,1,2,2,1,9]},s:{0:[9,9,1,2,1,0,1,2,2,1,9],1:[9,2,2,2,1,1,2,3,2,2,9],2:[9,9,1,2,1,0,1,2,2,1,9],3:[9,9,2,2,2,1,1,2,3,2,2]},i:{0:[9,9,1,2,1,0,1,2,1,9,9],1:[2,2,2,2,1,1,2,2,2,2,9],2:[9,9,1,2,1,0,1,2,1,9,9],3:[9,2,2,2,2,1,1,2,2,2,2]},j:{0:[9,9,1,2,1,0,1,2,2,1,9],1:[9,2,2,3,2,1,2,3,3,2,9],2:[9,9,3,4,3,2,3,4,4,3,9],3:[9,9,2,3,2,1,2,3,3,2,2]},t:{0:[9,9,1,2,1,0,1,2,2,1,9],1:[9,2,2,3,2,1,2,3,3,2,9],2:[9,9,3,4,3,2,3,4,4,3,9],3:[9,9,2,3,2,1,2,3,3,2,2]}},majorShoutStyles:{globalbest:()=>{xn.play("confetti",{gui:!0,count:30})},personalbest:()=>{xn.play("confetti",{gui:!0,count:15,hue:[30,60]})},lg_victory:()=>{setTimeout((()=>{xn.play("confetti",{gui:!1,count:15,hue:[30,60]})}),1250)}},globalShoutStyles:{},gameModes:{"40l":{version:15,seed_random:!1,anchorseed:!0,seed:"X-PASSTHRU",allow180:!0,g:.02,objective:{type:"lines",count:40},handling:"X-PASSTHRU",countdown:"X-PASSTHRU",countdown_interval:"X-PASSTHRU",precountdown:"X-PASSTHRU",prestart:"X-PASSTHRU",mission:"X-PASSTHRU",zoominto:"X-PASSTHRU",bgmnoreset:"X-PASSTHRU",slot_counter1:"X-PASSTHRU",slot_counter2:"X-PASSTHRU",slot_counter3:"X-PASSTHRU",slot_counter4:"X-PASSTHRU",slot_counter5:"X-PASSTHRU",slot_bar2:"progress",can_retry:!0,pro:"X-PASSTHRU",stride:"X-PASSTHRU",no_szo:"X-PASSTHRU"},blitz:{version:15,seed_random:!1,anchorseed:!0,seed:"X-PASSTHRU",allow180:!0,objective:{type:"timed",time:12e4},levels:!0,levelspeed:.42,gbase:.65,handling:"X-PASSTHRU",countdown:"X-PASSTHRU",countdown_interval:"X-PASSTHRU",precountdown:"X-PASSTHRU",prestart:"X-PASSTHRU",mission:"X-PASSTHRU",zoominto:"X-PASSTHRU",bgmnoreset:"X-PASSTHRU",slot_counter1:"X-PASSTHRU",slot_counter2:"X-PASSTHRU",slot_counter3:"X-PASSTHRU",slot_counter4:"X-PASSTHRU",slot_counter5:"X-PASSTHRU",slot_bar2:"progress",can_retry:!0,pro:"X-PASSTHRU",stride:"X-PASSTHRU",no_szo:"X-PASSTHRU"}}},Fo=function(e,t,s=-1){let a=e||0,n=t||[],o=[],i=null,r=[],l=!1,c=0,d=50,p=6,u=15,m=u;function g(e=!1){i&&(c=0,e||(m=Math.min(d,m+1)),"function"==typeof i?i({listenID:s,frames:r,provisioned:a}):i.emit("replay",{listenID:s,frames:r,provisioned:a}),r=[],l=!1)}function h(){o=[];for(let e=0;e<n.length;e++)void 0===o[n[e].frame]&&(o[n[e].frame]=e)}return h(),{advanceFrame:function(){c++,(!y()&&c>=m||l)&&g(),a++},getFrame:function(){return a},getEventCount:function(){return n.length},getStarter:function(){let e=null;for(let t=0;t<n.length;t++)if("full"===n[t].type){e=n[t].data;break}return e?(e.options.seed_random=!1,e.options.handling=e.game.handling,e):null},getStartEvent:function(){for(let e=0;e<n.length;e++)if("start"===n[e].type)return n[e];return null},getEndEvent:function(){for(let e=0;e<n.length;e++)if("end"===n[e].type)return n[e];return null},pushEvent:function(e,t){const s={frame:a,type:e,data:v(t)};"full"===e||y()||(m=Math.max(p,Math.min(u,m-.25))),n.push(s),i&&("end"===e&&(l=!0),r.push(s)),void 0===o[a]&&(o[a]=n.length-1)},getEventsAtFrame:function(e){let t=o[e];if(void 0===t)return[];const s=[];for(let a=t;a<n.length&&n[a].frame===e;a++)s.push(n[a]);return s},export:function(){return{frames:a,events:n}},import:function(e){a=e.frames,n=e.events,h()},seek:function(e){a=e},bindRolling:function(e){i=e},setListenID:function(e){s=e},flush:function(){g(!0)},amendTargets:function(e){for(let t=0;t<n.length;t++)"targets"===n[t].type&&(n[t].data.data=e)},setLatencyPreference:function(e){switch(e){case"zero":d=15,p=2,u=4;break;case"low":d=15,p=6,u=8;break;case"medium":d=50,p=6,u=15;break;case"high":d=50,p=15,u=30}m=u}}},Uo=function(e){let t=e.listenID||-1,s=0,a=0;const n=e;let o=[],i=()=>{},r=()=>{},l=[],c=[],d=!1,p=[],u=15,m="",g=0,h=1e3/60,f=[];"keyboard"===n.type&&(document.addEventListener("keydown",b,!1),document.addEventListener("gpdown",b,!1),document.addEventListener("keyup",y,!1),document.addEventListener("gpup",y,!1));let _=e=>{e.listenID===t&&(c.push(...e.frames),u=e.provisioned-a,a=e.provisioned,e.frames.some((e=>"end"===e.type))&&a++)};function b(e){if(e.repeat)return;if(document.body.classList.contains("chatfocus")||ht>=1)return;if(!e.detail&&e.target.closest("#zen_panel_content"))return;const t=me(e)||e.detail.toUpperCase();if(p.includes(t))return;p.push(t);let a=0;g&&(a=Math.floor((performance.now()-g)/h*10)/10),Object.keys(ae).forEach((n=>{ae[n].includes(t)&&(l.push({frame:s+Math.floor(a),type:"keydown",data:{key:n,subframe:a%1}}),"retry"===n&&i(),"exit"===n&&r(),e.detail||e.preventDefault())}))}function y(e){if(document.body.classList.contains("chatfocus")||ht>=1)return;if(!e.detail&&e.target.closest("#zen_panel_content"))return;const t=me(e)||e.detail.toUpperCase();if(!p.includes(t))return;p.splice(p.indexOf(t),1);let a=0;g&&(a=Math.floor((performance.now()-g)/h*10)/10),Object.keys(ae).forEach((n=>{if(ae[n].includes(t)){if("chat"===n)return;l.push({frame:s+Math.floor(a),type:"keyup",data:{key:n,subframe:a%1}}),e.detail||e.preventDefault()}}))}function v(e){o.forEach((t=>{t(e)}))}return"socket"===n.type&&n.socket.on("replay",_),{advanceFrame:function(){if(s++,"keyboard"===n.type)if(l.length)g+=h;else{const e=performance.now(),t=e-g;t>=1e3/90&&t<=40&&(f.push(t),f.length>10&&(f.shift(),h=f.reduce(((e,t)=>e+t))/10)),g=e}},getFrame:function(){return s},readyEventQueue:function(){const e=[];for(let t=0;t<l.length;t++)"keydown"===l[t].type&&(e.includes(l[t].data.key)||e.push(l[t].data.key)),"keyup"===l[t].type&&e.includes(l[t].data.key)&&e.splice(e.indexOf(l[t].data.key),1);const t=[];for(let e=0;e<l.length;e++)"keydown"!==l[e].type&&"keyup"!==l[e].type&&t.push(l[e]);for(let a=0;a<e.length;a++)t.push({frame:s,type:"keydown",data:{key:e[a],hoisted:!0,subframe:0}});l=t},pull:function(){if("replay"===n.type){n.replay.getEventsAtFrame(s).forEach((e=>{v(e)}))}else if("socket"===n.type){const e=[];for(let t=0;t<c.length;t++)c[t].frame===s?v(c[t]):e.push(c[t]);c=e}else{const e=[];for(let t=0;t<l.length;t++)l[t].frame===s?v(l[t]):e.push(l[t]);l=e}},nextFrameReady:()=>"socket"!==n.type||a>s,fallingBehind:()=>"socket"===n.type&&(a>s+60&&(d=!0),a<=s&&(d=!1),d),amountToCatchUp:()=>"replay"===n.type?n.replay.getFrame()-s:"socket"!==n.type?0:a-s,behindness:()=>"socket"===n.type&&(a-s)/u,bind:function(e){o.push(e)},unbind:function(e){o=o.filter((t=>t!==e))},seek:function(e){s=e,l=[],c=[],d=!1,u=15},finished:function(){if("replay"===n.type)return s>n.replay.getFrame()},type:function(){return n.type},pushIGE:function(e){l.push({id:e.id,frame:s,type:"ige",data:e.data})},pushTargets:function(e){const t=JSON.stringify(e);t!=m&&(m=t,l.push({id:"diyusi",frame:s,type:"targets",data:e}))},unhook:function(){document.removeEventListener("keydown",b),document.removeEventListener("gpdown",b),document.removeEventListener("keyup",y),document.removeEventListener("gpup",y)},destroy:function(){o=[],n.socket&&n.socket.off("replay",_)},socket:()=>n.socket,bindHyperRetry:function(e){i=e},bindHyperForfeit:function(e){r=e}}},Bo=function(e){"use strict";const t=e.gsm;function s(s){if(!((s=Math.floor(s/Math.max(1,t.targets.length)))<1))if(t.lastoffensive.offence+=s,t.stats.garbage.sent+=s,e.c.IsServer())(t.setoptions.oninteraction||(()=>{}))(e.siom.Export(),{type:"garbage",amt:s,x:t.lastoffensive.x,y:t.lastoffensive.y},t.targets,e.iom.source.getFrame());else if(t.targets.forEach((e=>{o(s,e)})),t.setoptions.usezenconfig)if(Be.garbagemode.startsWith("backfire_")){let t=s;if("backfire_half"===Be.garbagemode&&(t=Math.floor(s/2)),"backfire_double"===Be.garbagemode&&(t=Math.floor(2*s)),t<1)return;n({type:"garbage",amt:t,column:Math.floor(Math.random()*e.W()),x:5,y:35})}else if(Be.garbagemode.startsWith("unclear_")){let t=s;if("unclear_half"===Be.garbagemode&&(t=Math.floor(s/2)),"unclear_double"===Be.garbagemode&&(t=Math.floor(2*s)),t<1)return;const a=Math.floor(Math.random()*e.W());e.gpm.Vibrate(ee.GARBAGERISE),e.sxm.PlayIngame("garbagerise");for(let s=0;s<t;s++)e.hm.H.holderstate.ds+=2*e.lm.H.lastdT,e.bm.PushGarbageLine(a,!1,(0===s?64:0)|(s>=t-1?4:0))}}function a(e){let t="medium";return e<3&&(t="small"),e>5&&(t="large"),t}function n(s,n=null,o=null){if(null!==o&&(s.amt=function(e){for(const s of t.impendingdamage)if(s.cid===e)return s.lines;return 0}(o),!s.amt))return;const i=a(s.amt);if(!e.c.IsServer()&&(t.setoptions.physical||null!==n&&null!==ha.find(n)&&!1===ha.find(n).game.isScoped())){e.sxm.PlayIngame(`garbage_in_${i}`);Hn(360*Math.random(),100,80);const a=no(e.hm.H.stackobj,Ls(fo.x*(e.Wh()+e.Wh()*(Math.random()-.5))),Ls(fo.x*(e.Hh()+e.Hh()*(Math.random()-.5))),e.hm.S());let r=null;null!==n&&(r=ha.getPosOf(n)),null===r&&(r={pos:no(e.hm.H.stackobj,Ls(fo.x*e.Wh()),Ls(-10*fo.x),e.hm.S()),scale:e.hm.S()});const l=On.create({pointA:[r.pos.x+r.scale*Ls(fo.x*(s.x-(e.Wh()-.5))),r.pos.y+r.scale*Ls(fo.x*(s.y-(e.Hh()+e.B()-.5)))],pointB:[a.x,a.y],duration:t.setoptions.garbagespeed/(e.lm.H.playbackSpeed||1)/60,intensity:s.amt});o&&l&&function(e,s){for(const a of t.impendingdamage)if(a.cid===e)return void(a.beam=s)}(o,l)}if(t.garbagereceived+=s.amt,t.stats.garbage.received+=s.amt,t.killer.name=n,n&&!e.c.IsServer()){const e=ha.find(n);e&&(t.lastattacker=[e.context.listenID])}e.wfm.WaitFrames(t.setoptions.garbagespeed,"incoming-attack-hit",{data:s,sender:n,cid:o})}function o(s,n){if(e.c.IsServer())return;if(!t.setoptions.physical&&ha.games.self&&n==ha.games.self.context.listenID)return;if(("low"===te.video.graphics||"minimal"===te.video.graphics)&&"tiny"===e.hm.H.displaymode||0===e.lm.H.soundSkipRate)return;const o=a(s);e.sxm.PlayIngame(`garbage_out_${o}`,2);Hn(360*Math.random(),100,80);const i=no(e.hm.H.stackobj,Ls(fo.x*t.lastoffensive.x),Ls(fo.x*(t.lastoffensive.y-20)),e.hm.S());let r=ha.getPosOf(n);null!==r&&(On.create({pointA:[i.x,i.y],pointB:[r.pos.x+(Math.random()-.5)*(r.scale*Ls(fo.x*e.Wh())),r.pos.y+(Math.random()-.5)*(r.scale*Ls(fo.x*e.Hh()))],duration:t.setoptions.garbagespeed/(e.lm.H.playbackSpeed||1)/60,intensity:s*e.hm.H.holderstate.cos}),e.wfm.WaitFrames(t.setoptions.garbagespeed/(e.lm.H.playbackSpeed||1),"outgoing-attack-hit",{}))}function i(s,a=null,n=null){t.impendingdamage.push({id:++t.garbageid,type:s.type,active:null===n,lines:s.amt,column:s.column,data:s,sender:a,cid:n}),null===n&&(e.hm.H.holderstate.dw+=Math.min(40,1.25*s.amt)*e.lm.H.lastdT),e.c.OnClient((()=>{e.pbm.UpdateGarbageBar("impending")}))}function r(s){for(const n of t.impendingdamage)n.cid===s&&(n.active=!0,e.c.OnClient((()=>{const t=a(n.lines);e.pbm.UpdateGarbageBar("impending"),e.gpm.Vibrate(ee[`damage_${t}`.toUpperCase()]),e.sxm.PlayIngame(`damage_${t}`),e.hm.H.holderstate.dw+=Math.min(40,1.25*n.lines)*e.lm.H.lastdT})))}return{FightLines:function(a){if(!t.setoptions.hasgarbage)return;t.stats.garbage.attack+=a;const n=!!t.impendingdamage.length;n&&e.sxm.PlayIngame("offset",.65,!1,.2);let o=0;for(;a>0&&t.impendingdamage.length;)t.impendingdamage[0].lines--,t.impendingdamage[0].lines||t.impendingdamage.shift(),a--,o++;t.lastoffensive.defense+=o,a>0&&(n&&e.sxm.PlayIngame("counter",.65,!1,.2),s(a)),n&&!e.c.IsServer()&&(e.pbm.UpdateGarbageBar("impending"),o&&e.pbm.FlashGarbageBar("impending",Math.min(e.H(),o)))},Offence:s,StartingAttack:function(e,t=null,s=null){i(e,t,s)},IncomingAttack:n,IncomingAttackHit:function(s,n,o){if(!e.c.IsServer()&&(t.setoptions.physical&&e.sxm.PlayIngame("impact"),null===o)){const t=a(s.amt);e.gpm.Vibrate(ee[`damage_${t}`.toUpperCase()]),e.sxm.PlayIngame(`damage_${t}`)}null!==o?r(o):i(s,n)},OutgoingAttack:o,OutgoingAttackHit:function(){e.sxm.PlayIngame("impact")},InsertDamage:i,ActivateDamage:r,TakeAllDamage:function(s=!1){if(!t.setoptions.hasgarbage)return;t.impendingdamage.length&&!e.c.IsServer()&&(e.gpm.Vibrate(ee.GARBAGERISE),e.sxm.PlayIngame("garbagerise"));let a=!0;const n=s?400:Math.floor(Math.min(t.setoptions.garbagecapmax||40,t.setoptions.garbagecap));let o=!1;const i=[];for(let e=t.impendingdamage.length-1;e>=0;e--)t.impendingdamage[e].active||(i.unshift(t.impendingdamage[e]),t.impendingdamage.splice(e,1));for(let i=0;i<n&&0!==t.impendingdamage.length;i++){e.hm.H.holderstate.ds+=(i>=40?0:2)*e.lm.H.lastdT,t.impendingdamage[0].lines--,o=!0;const r=t.impendingdamage[0].lines<=0||i>=n-1;if(!e.bm.PushGarbageLine(t.impendingdamage[0].column,s,(a?64:0)|(r?4:0)))break;a=!1,t.impendingdamage[0].lines||(t.impendingdamage.shift(),a=!0)}t.impendingdamage.push(...i),o&&!e.c.IsServer()&&e.pbm.UpdateGarbageBar("impending")},AnnounceOffensive:function(){if(t.lastoffensive.offence&&(e.spm.H.spikeCount>=10&&e.fim.AddFire(5),t.lastoffensive.offence>=10&&e.fim.AddFire(3*t.lastoffensive.offence)),!e.c.IsServer()&&"minimal"!==te.video.graphics&&(t.lastoffensive.defense&&e.hm.H.board.fx("popup_defense").create(t.lastoffensive.defense,{x:t.lastoffensive.x,y:t.lastoffensive.y,evasive:"keyboard"===e.iom.source.type()}),t.lastoffensive.offence)){if(e.spm.H.spikeCount+=t.lastoffensive.offence,e.spm.H.spikeTimer=60,"full"===e.hm.H.displaymode&&e.spm.H.spikeCount>=10&&0!==e.lm.H.soundSkipRate){const s=ao(e.hm.H.holder,Ls(fo.x)*e.Wh(),Ls(fo.x)*e.Hh());xn.play("spike_flair",{x:s.x,y:s.y,w:e.W()*e.hm.S(),h:e.H()*e.hm.S()});const a=ao(e.hm.H.stackobj,Ls(fo.x*t.lastoffensive.x),Ls(fo.x*(t.lastoffensive.y-e.B())));Mn(a.x,a.y,1+Math.min(e.spm.H.spikeCount-10,22.5)/2.5),t.lastoffensive.offence>=4&&e.sxm.PlayIngame(`thunder${Math.floor(6*Math.random())+1}`,1,!0)}e.hm.H.board.fx("popup_offence").create(e.spm.H.spikeCount,{x:t.lastoffensive.x,y:t.lastoffensive.y,evasive:"keyboard"===e.iom.source.type()})}}}},Xo=function(e){"use strict";const t=e.gsm;function s(){let e=[];switch(t.setoptions.bagtype){case"total mayhem":for(let s=0;s<7;s++)e.push(No.minotypes[Math.floor(t.rng.nextFloat()*No.minotypes.length)]);break;case"classic":for(let s=0;s<7;s++){let s=Math.floor(t.rng.nextFloat()*(No.minotypes.length+1));(s===t.lastGenerated||s>=No.minotypes.length)&&(s=Math.floor(t.rng.nextFloat()*No.minotypes.length)),t.lastGenerated=s,e.push(No.minotypes[s])}break;case"pairs":const s=[...No.minotypes];t.rng.shuffleArray(s),e=[s[0],s[0],s[0],s[1],s[1],s[1]],t.rng.shuffleArray(e);break;case"14-bag":e=[...No.minotypes,...No.minotypes],t.rng.shuffleArray(e);break;default:e=[...No.minotypes],t.rng.shuffleArray(e)}t.bag.push(...e)}return{PopulateBag:s,PullFromBag:function(){for(;t.bag.length<7;)s();return t.bag.shift()}}},zo=function(e){"use strict";const t=e.gsm;let s=[];function a(t,a,o,i){const r=10+Math.ceil(o)*(2*e.W())+a;if(s[r]){const e=s[r]>>2*i&3;if(1===e)return!0;if(2===e)return!1}if(!No.tetrominoes[t])return!1;let l=!0;for(let e=0;e<No.tetrominoes[t].matrix.data[i].length;e++){if(n(a+(No.tetrominoes[t].matrix.data[i][e][0]-No.tetrominoes[t].matrix.dx),o+(No.tetrominoes[t].matrix.data[i][e][1]-No.tetrominoes[t].matrix.dy))){l=!1;break}}s[r];const c=l?1:2;return s[r]|=c<<2*i,l}function n(s,a){return s<0||s>=e.W()||(a<0||a>=e.T()||(void 0===t.board[Math.ceil(a)]||null!==t.board[Math.ceil(a)][s]))}function o(s,a,n,o){let i=0;for(let r=0;r<No.tetrominoes[s].matrix.data[o].length;r++){const l=No.tetrominoes[s].matrix.data[o][r][0]-No.tetrominoes[s].matrix.dx,c=No.tetrominoes[s].matrix.data[o][r][1]-No.tetrominoes[s].matrix.dy;i=Math.max(Math.ceil(n)+c,i),t.board[Math.ceil(n)+c][a+l]=s,t.boardedges[Math.ceil(n)+c][a+l]=No.tetrominoes[s].matrix.data[o][r][2],e.c.OnClient((()=>{e.hm.H.stackmud.push([Math.ceil(n)+c,a+l,s,No.tetrominoes[s].matrix.data[o][r][2]])}))}return i<e.B()}function i(e,t,s,a){let n=0,o=[],i=[];for(let r=0;r<No.tetrominoes[e].matrix.data[a].length;r++){const l=No.tetrominoes[e].matrix.data[a][r][0]-No.tetrominoes[e].matrix.dx,c=No.tetrominoes[e].matrix.data[a][r][1]-No.tetrominoes[e].matrix.dy;n=Math.max(Math.ceil(s)+c,n),o.push(`${Math.ceil(s)+c}x${t+l}`),i.push([Math.ceil(s)+c,t+l])}return{besty:n,shadowTiles:o,shadowTilesArr:i}}return{SetupBoard:function(){let s=[],a=[];for(let t=0;t<e.T();t++){let t=[],n=[];for(let s=0;s<e.W();s++)t.push(null),n.push(255);s.push(t),a.push(n)}t.board=s,t.boardedges=a},LoadMap:function(s){const a=(s=s.replace(/[\s\n\r]/g,"").toLowerCase()).split("?");s=a[0];let n=a[1]||"";if(t.hold=a[2]||null,n=n.replace(/[^zlosijt]/g,""),s.length%e.W()!=0)return;if(n&&n.length)for(t.bag=n.split("");t.bag.length<7;)e.bam.PopulateBag();const o=e.T()-s.length/e.W();for(let a=0;a<s.length;a++){const n=o+Math.floor(a/e.W()),i=a%e.W();let r=s[a];"_"===r&&(r=null),"#"===r&&(r="gb"),"@"===r&&(r="gbd"),t.board[n][i]=r}},BoardToMap:function(){let s="";for(let a=0;a<e.T();a++)for(let n=0;n<e.W();n++){const e=t.board[a][n];s+=null===e?"_":"gb"===e?"#":"gbd"===e?"@":e}return s+=`?${t.started&&t.falling.type?t.falling.type:""}${t.bag.slice(0,5).join("")}${t.hold?`?${t.hold}`:""}`,s},IsLegalAtPos:a,ClearIsLegalAtPosMemo:function(){s=[]},IsOccupied:n,IsOccupiedInv:function(s,a){if(!(Math.round(s)<0||Math.round(s)>=e.W()||Math.round(a)<0||Math.round(a)>=e.T()||void 0===t.board[Math.round(a)]))return null!==t.board[Math.round(a)][Math.round(s)]},BoardIsEmpty:function(){return t.board.every((e=>e.every((e=>null===e))))},HighestLine:function(){for(let s=0;s<e.T();s++)if(t.board[s].some((e=>null!==e)))return s;return 40},PushActiveToStack:function(){return o(t.falling.type,t.falling.x,t.falling.y,t.falling.r)},PushTetrominoToStack:o,GetTilesAndNextYForPiece:i,PieceMayLockHere:function(s,a,n,o){let r=i(s,a,n,o);if(r.besty<e.B())return!1;let l=0;t.impendingdamage.forEach((e=>{e.active&&(l+=e.lines)}));let c=Math.min(l,Math.floor(Math.min(t.setoptions.garbagecapmax||40,t.setoptions.garbagecap))),d=i(t.bag[0],Math.floor(e.W()/2)-1+t.kickset.additional_offsets[t.bag[0]][t.kickset.spawn_rotation[t.bag[0]]][0],e.B()-2.04+t.kickset.additional_offsets[t.bag[0]][t.kickset.spawn_rotation[t.bag[0]]][1]+c,t.kickset.spawn_rotation[t.bag[0]]),p=!1;return r.shadowTiles.forEach((e=>{d.shadowTiles.includes(e)&&(p=!0)})),d.shadowTilesArr.forEach((s=>{(s[0]>=e.T()||null!==t.board[s[0]][s[1]])&&(p=!0)})),!p},RemoveLinesFromStack:function(s){let a=[...t.board],n=[...t.boardedges];s.sort((function(e,t){return t-e}));for(let e=0;e<s.length;e++){if(n[s[e]-1])for(let t=0;t<n[s[e]-1].length;t++)n[s[e]-1][t]|=4;if(n[s[e]+1])for(let t=0;t<n[s[e]+1].length;t++)n[s[e]+1][t]|=64}for(let t=0;t<s.length;t++)a.splice(s[t],1),n.splice(s[t],1),e.c.OnClient((()=>{e.fxm.ExplodeLine(s[t])}));for(;a.length<e.T();){let t=[],s=[];for(let a=0;a<e.W();a++)t.push(null),s.push(255);a.unshift(t),n.unshift(s)}t.board=a,t.boardedges=n,e.hm.H.stackdirty=!0},PushGarbageLine:function(s,a=!1,n=68){let o=[...t.board],i=[...t.boardedges];if(t.lastwasattack=!0,!o[0].every((e=>null===e)))return a||(t.setoptions.topoutisclear?e.stm.LoseStockOrGameOver("topout_clear"):e.stm.LoseStockOrGameOver("garbagesmash")),!1;o.shift(),i.shift();const r=[],l=[];for(let t=0;t<e.W();t++)r.push(t===s?null:"gb"),l.push(t===s?255:n|(0===t||t===s+1?1:0)|(t===e.W()-1||t===s-1?16:0));return o.push(r),i.push(l),t.board=o,t.boardedges=i,e.hm.H.stackdirty=!0,!0},PushUpFallingIfNeeded:function(){if(!a(t.falling.type,t.falling.x,t.falling.y,t.falling.r)){if(!a(t.falling.type,t.falling.x,t.falling.y-1,t.falling.r))return void(e.gsm.setoptions.topoutisclear?e.stm.LoseStockOrGameOver("topout_clear"):e.stm.LoseStockOrGameOver("garbagesmash"));t.falling.y-=1,e.hm.H.fallingdirty=!0}},CheckStackAgainstMap:function(s){if((s=s.replace(/[\s\n\r]/g,"")).length%e.W()!=0)return!1;const a=e.T()-s.length/e.W();for(let n=0;n<s.length;n++){const o=a+Math.floor(n/e.W()),i=n%e.W();let r=s[n];if(!t.board[o])return!1;if("*"!==r){if("_"===r&&null!==t.board[o][i])return!1;if("_"!==r&&null===t.board[o][i])return!1}}return!0},DestroyBoard:function(){t.impendingdamage=[];for(let s=0;s<e.T();s++)for(let a=0;a<e.W();a++)null!==t.board[s][a]&&(e.c.OnClient((()=>{if("full"===e.hm.H.displaymode&&("high"===te.video.graphics||"ultra"===te.video.graphics)){const n=ao(e.hm.H.stackobj,a*Ls(fo.x)+Ls(fo.x/2),(s-e.B())*Ls(fo.x)+Ls(fo.x/2)),o=Eo.getColor(t.setoptions.minoskin[t.kickset.colorMap[t.board[s][a]]]||t.setoptions.minoskin.other,t.kickset.colorMap[t.board[s][a]]);xn.play("mino_dust",{x:n.x,y:n.y,s:e.hm.S(),color:o})}})),t.board[s][a]=null);e.c.OnClient((()=>{e.hm.H.stackdirty=!0,e.pbm.UpdateGarbageBar("impending")}))}}},Go=function(e){"use strict";const t=e.gsm;return{IsInactive:function(s,a,n=!1){if(t.falling.x>=s-2&&t.falling.x<=s+2&&(t.falling.y>=a-2&&t.falling.y<=a+2||e.sdm.H.lastLegal>=a-2&&e.sdm.H.lastLegal<=a+2))return!1;const o=e.bm.IsOccupiedInv(s,a);return n?[[s-2,a-2],[s-1,a-2],[s+0,a-2],[s+1,a-2],[s+2,a-2],[s-2,a-1],[s-1,a-1],[s+0,a-1],[s+1,a-1],[s+2,a-1],[s-2,a+0],[s-1,a+0],[s+1,a+0],[s+2,a+0],[s-2,a+1],[s-1,a+1],[s+0,a+1],[s+1,a+1],[s+2,a+1],[s-2,a+2],[s-1,a+2],[s+0,a+2],[s+1,a+2],[s+2,a+2]].every((t=>{const s=e.bm.IsOccupiedInv(t[0],t[1]);return s===o||void 0===s})):[[s-1,a-1],[s+0,a-1],[s+1,a-1],[s-1,a+0],[s+1,a+0],[s-1,a+1],[s+0,a+1],[s+1,a+1]].every((t=>{const s=e.bm.IsOccupiedInv(t[0],t[1]);return s===o||void 0===s}))}}},jo=function(e){"use strict";const t=e.gsm;return{OnClient:function(e){t.setoptions&&t.setoptions.headless||_(e)},OnServer:function(e){t.setoptions&&t.setoptions.headless?e():b(e)},IsServer:function(e=!1){return!(e||!t.setoptions||!t.setoptions.headless)||y()}}},Wo=function(e){"use strict";const t=e.gsm;return{UpdateCounter:function(s,a){for(let n=1;n<=5;n++)t.setoptions[`slot_counter${n}`]===s&&e.hm.H.board.el(`counter${n}`).update(a)},UpdateCounterTitle:function(s,a){for(let n=1;n<=5;n++)t.setoptions[`slot_counter${n}`]===s&&e.hm.H.board.el(`counter${n}`).update(void 0,void 0,a)},UpdateCounterSubtitle:function(s,a){for(let n=1;n<=5;n++)t.setoptions[`slot_counter${n}`]===s&&e.hm.H.board.el(`counter${n}`).update(void 0,a)}}},qo=function(e){"use strict";const t=e.gsm,s={countersfrozen:!1},n={timer:"time",stopwatch:"time",kills:"KO's",attack:"attack",lines:"lines",pieces:"pieces",level:"level",finesse_l:"finesse",keys:"inputs",score:"score",spp:"score",placement:"placement",finesse:"finesse",vs:"VS score",hold:"hold",allclears:"all clears"};return{H:s,DisplayCounts:function(){e.c.IsServer()||t.destroyed||(Object.keys(n).forEach((s=>{for(let a=1;a<=5;a++)t.setoptions[`slot_counter${a}`]===s&&e.hm.H.board.el(`counter${a}`).update(void 0,void 0,n[s])})),t.setoptions.b2bchaining&&t.stats.btb>1&&e.hm.H.board.el("b2b").create(t.stats.btb-1))},UpdateCounts:function(n=!1){if(e.c.IsServer())return;if(t.destroyed)return;if(s.countersfrozen)return;let o=0;if(t.impendingdamage.forEach((e=>{o+=e.lines})),e.pbm.UpdateBar("impending",o/e.H()),e.pbm.UpdateGarbageBar("impending"),e.pbm.UpdateBarTicker("impending",Math.floor(Math.min(t.setoptions.garbagecapmax||40,t.setoptions.garbagecap))/e.H()),t.setoptions.zenlevels?e.pbm.UpdateBar("progress",t.stats.zenprogress):t.setoptions.levels&&!t.setoptions.absolute_lines?e.pbm.UpdateBar("progress",t.stats.level_lines/t.stats.level_lines_needed):"lines"===(t.setoptions.objective||{type:"none"}).type&&e.pbm.UpdateBar("progress",t.stats.lines/t.setoptions.objective.count),"full"!==e.hm.H.displaymode)return;t.setoptions.display_zen&&e.hm.H.board.el("zen").update(t.stats.score,t.stats.zenlevel),t.setoptions.levels&&!t.setoptions.absolute_lines?e.ctm.UpdateCounter("lines",`${t.stats.level_lines}\f3/${t.stats.level_lines_needed}`):"lines"===(t.setoptions.objective||{type:"none"}).type?(e.ctm.UpdateCounter("lines",`${t.stats.lines}\f3/${t.setoptions.objective.count}`),t.setoptions.pro&&e.hm.H.board.el("backer").update(`${Math.max(0,t.setoptions.objective.count-t.stats.lines)}`)):e.ctm.UpdateCounter("lines",t.stats.lines);let i=t.stats.level;if(t.setoptions.masterlevels&&t.stats.level>20&&(i="M"+(t.stats.level-20)),!n&&!t.stats.time.locked){let s=a(t.stats.time.zero?0:(e.iom.source.getFrame()-t.stats.time.frameoffset)/60*1e3);parseInt(s.m)>=60&&(s.m=`${Math.floor(parseInt(s.m)/60)}:${(parseInt(s.m)%60).toString().padStart(2,"0")}`),te.video.lowrescounters||"minimal"===te.video.graphics?e.ctm.UpdateCounter("stopwatch",`${s.m}:${s.s}`):e.ctm.UpdateCounter("stopwatch",`${s.m}:${s.s}\f3.${s.ms}`),s=a(Math.max(0,(t.setoptions.objective.time||0)-(t.stats.time.zero?0:(e.iom.source.getFrame()-t.stats.time.frameoffset)/60*1e3))),te.video.lowrescounters||"minimal"===te.video.graphics?e.ctm.UpdateCounter("timer",`${s.m}:${s.s}`):e.ctm.UpdateCounter("timer",`${s.m}:${s.s}\f3.${s.ms}`)}if(!t.stats.time.locked){const s=(e.iom.source.getFrame()-t.stats.time.frameoffset)/60||1,a=(e.iom.source.getFrame()-t.stats.time.frameoffset)/3600||1,n=(t.stats.garbage.attack+t.stats.garbage.cleared)/Math.max(1,t.stats.piecesplaced)*(t.stats.piecesplaced/s)*100;te.video.lowrescounters||"minimal"===te.video.graphics?e.ctm.UpdateCounter("pieces",`${t.stats.piecesplaced}\f3, ${(t.stats.piecesplaced/s).toFixed(1)}/S`):e.ctm.UpdateCounter("pieces",`${t.stats.piecesplaced}\f3, ${(t.stats.piecesplaced/s).toFixed(2)}/S`),te.video.lowrescounters||"minimal"===te.video.graphics?e.ctm.UpdateCounter("attack",`${t.stats.garbage.attack}\f3, ${Math.round(t.stats.garbage.attack/a)}/M`):e.ctm.UpdateCounter("attack",`${t.stats.garbage.attack}\f3, ${(t.stats.garbage.attack/a).toFixed(2)}/M`),te.video.lowrescounters||"minimal"===te.video.graphics?e.ctm.UpdateCounter("vs",`${Math.floor(n)}`):e.ctm.UpdateCounter("vs",`${Math.floor(n)}\f3.${Math.floor(100*(n-Math.floor(n))).toString().padStart(2,"0")}`)}e.ctm.UpdateCounter("level",i),e.ctm.UpdateCounter("score",t.stats.score.toLocaleString("en-US")),e.ctm.UpdateCounter("kills",t.stats.kills),e.ctm.UpdateCounter("placement",`\f3#\f5${t.placement}`),e.ctm.UpdateCounter("keys",`${t.stats.inputs}\f3, ${(t.stats.inputs/Math.max(1,t.stats.piecesplaced)).toFixed(2)}/P`),e.ctm.UpdateCounter("spp",`${t.stats.score.toLocaleString("en-US")}\f3, ${Math.round(t.stats.score/Math.max(1,t.stats.piecesplaced)).toLocaleString("en-US")}/P`),e.ctm.UpdateCounter("finesse",`${t.stats.finesse.combo}\f3, ${(t.stats.finesse.perfectpieces/Math.max(1,t.stats.piecesplaced)*100).toFixed(2)}%`),e.ctm.UpdateCounterSubtitle("finesse",`${t.stats.finesse.faults} fault${1===t.stats.finesse.faults?"":"s"}`),e.ctm.UpdateCounter("finesse_l",`${t.stats.finesse.combo}\f3, ${(t.stats.finesse.perfectpieces/Math.max(1,t.stats.piecesplaced)*100).toFixed(2)}%,${t.stats.finesse.faults}F`),e.ctm.UpdateCounter("hold",`${t.stats.holds}\f3, ${(t.stats.holds/Math.max(1,t.stats.piecesplaced)*100).toFixed(2)}%`),e.ctm.UpdateCounter("allclears",t.stats.clears.allclear),"full"===e.hm.H.displaymode&&e.iom.source.getFrame()%60==0&&(Zn=!0)},FinalizeTimer:function(t){let s=a(t);te.video.lowrescounters||"minimal"===te.video.graphics?e.ctm.UpdateCounter("stopwatch",`${s.m}:${s.s}`):e.ctm.UpdateCounter("stopwatch",`${s.m}:${s.s}\f3.${s.ms}`),s=a(0),te.video.lowrescounters||"minimal"===te.video.graphics?e.ctm.UpdateCounter("timer",`${s.m}:${s.s}`):e.ctm.UpdateCounter("timer",`${s.m}:${s.s}\f3.${s.ms}`)},StartStopwatch:function(){t.stats.time.start=performance.now(),t.stats.time.zero=!1}}},Ko=function(e){"use strict";const t=e.gsm;function s(s,a){let n=Math.floor(1e13*t.falling.y)/1e13+s;n%1==0&&(n+=1e-5);let o=Math.floor(1e13*t.falling.y)/1e13+1;if(o%1==0&&(o-=2e-5),e.bm.IsLegalAtPos(t.falling.type,t.falling.x,n,t.falling.r)&&e.bm.IsLegalAtPos(t.falling.type,t.falling.x,o,t.falling.r)){const s=t.falling.highesty,o=t.falling.y;return t.falling.y=n,t.falling.highesty=Math.ceil(Math.max(t.falling.highesty,n)),t.falling.floored=!1,Math.ceil(n)!==Math.ceil(o)&&(e.hm.H.fallingdirty=!0),(n>s||t.setoptions.infinitemovement)&&(t.falling.lockresets=0,t.fallingrotations=0),a>=Number.MAX_SAFE_INTEGER&&(t.stats.score+=No.scoring.HARDDROP,t.setoptions.zenlevels&&(t.stats.zenprogress+=e.znm.ScoreToZenProgress(No.scoring.HARDDROP,t.stats.zenlevel)),e.c.OnClient((()=>{"full"===e.hm.H.displaymode&&e.fxm.EffectAtTetromino("harddrop_trail",{},e.hm.H.fallingobj,t.falling.type,t.falling.x,t.falling.y,t.falling.r)}))),!0}return a>=Number.MAX_SAFE_INTEGER&&e.c.OnClient((()=>{"full"===e.hm.H.displaymode&&0!==e.lm.H.soundSkipRate&&(xn.play("bgsplash",{direction:180,amt:5}),e.fxm.EffectAtTetrominoEdge("harddrop_edge",{},e.hm.H.fallingobj,t.falling.type,t.falling.x,t.falling.y,t.falling.r))})),!1}function a(s=!1,a=1){t.falling.locking+=t.setoptions.version>=15?a:1,t.falling.floored||(t.falling.floored=!0,e.c.OnClient((()=>{e.sxm.PlayIngame("hit")}))),(t.falling.locking>(t.setoptions.locktime||30)||t.falling.forcelock||t.falling.lockresets>(t.setoptions.lockresets||15)&&!t.setoptions.infinitemovement)&&n(s)}function n(s=!1){t.falling.sleep=!0;const a=e.bm.PushActiveToStack();t.stats.piecesplaced++,!s&&t.handling.safelock&&(t.falling.safelock=7),e.c.OnClient((()=>{e.sxm.PlayIngame("floor"),e.hm.H.holderstate.dy+=2*e.lm.H.lastdT}));const n=e.lcm.ClearLines(),i=n?t.setoptions.lineclear_are||0:t.setoptions.are||0,r=Math.max(0,t.falling.keys-No.finesse[t.falling.type][t.falling.r.toString()][t.falling.x+1]);if(t.stats.finesse.faults+=r,r>0?(t.stats.finesse.combo=0,e.c.OnClient((()=>{"full"===e.hm.H.displaymode&&"keyboard"===e.iom.source.type()&&t.setoptions.pro_alert&&(e.sxm.PlayIngame("finessefault"),e.hm.H.holderstate.ds+=1.5*e.lm.H.lastdT),"full"===e.hm.H.displaymode&&"keyboard"===e.iom.source.type()&&t.setoptions.pro_retry&&t.setoptions.can_retry&&(e.hm.H.holderstate.ds+=50*e.lm.H.lastdT,e.gom.GameOver("retry",!0),Os.play("detonate2"))}))):(t.stats.finesse.combo++,t.stats.finesse.perfectpieces++),a&&(n&&!1!==t.setoptions.clutch?e.c.OnClient((()=>{te.video.siren&&(e.sxm.PlayIngame("clutch"),"minimal"!==te.video.graphics&&"off"!==te.video.actiontext&&"some"!==te.video.actiontext&&e.hm.H.board.fx("clutch").create("CLUTCH"))})):t.setoptions.topoutisclear?e.stm.LoseStockOrGameOver("topout_clear"):e.stm.LoseStockOrGameOver("topout")),t.setoptions.zenlevels&&t.stats.combo<=2&&t.stats.zenprogress>=1)return e.hm.H.fallingdirty=!0,void e.znm.ZenLevelup();i?(e.hm.H.fallingdirty=!0,e.wfm.WaitFrames(i,"are",{})):o()}function o(s){e.bm.ClearIsLegalAtPosMemo(),t.falling.locking=0,t.falling.forcelock=!1,t.falling.lockresets=0,t.falling.floored=!1,t.falling.type=null==s?e.bam.PullFromBag():s,t.falling.aox=t.kickset.additional_offsets[t.falling.type][t.kickset.spawn_rotation[t.falling.type]][0],t.falling.aoy=t.kickset.additional_offsets[t.falling.type][t.kickset.spawn_rotation[t.falling.type]][1],t.falling.x=Math.floor(e.W()/2)-1+t.falling.aox,t.falling.y=e.B()-2.04+t.falling.aoy,t.falling.highesty=e.B()-2,t.falling.r=t.kickset.spawn_rotation[t.falling.type],t.falling.spintype=!1,t.falling.sleep=!1,t.falling.last=null,t.falling.keys=0,t.fallingrotations=0,t.totalrotations=0,t.holdlocked=void 0!==s,t.falling.clamped&&t.handling.dcd>0&&(t.ldas=Math.min(t.ldas,t.handling.das-t.handling.dcd),t.ldasiter=t.handling.arr,t.rdas=Math.min(t.rdas,t.handling.das-t.handling.dcd),t.rdasiter=t.handling.arr),t.falling.clamped=!1,null==s&&!1!==t.setoptions.display_next&&t.setoptions.physical&&e.c.OnClient((()=>{e.sxm.PlayIngame(t.bag[0])})),e.bm.IsLegalAtPos(t.falling.type,t.falling.x,t.falling.y,t.falling.r)?t.lastwasattack=!1:t.setoptions.topoutisclear?e.stm.LoseStockOrGameOver("topout_clear"):e.stm.LoseStockOrGameOver(t.lastwasattack?"garbagesmash":"topout"),e.hm.H.fallingdirty=!0,e.hm.H.nextdirty=!0,e.hm.H.holddirty=!0,t.falling.ihs&&(t.holdlocked||void 0!==t.setoptions.display_hold&&!t.setoptions.display_hold||i()),0!==t.falling.irs&&e.im.RotatePiece((t.kickset.spawn_rotation[t.falling.type]+t.falling.irs)%4),t.falling.irs=0,t.falling.ihs=!1,e.znm.UpdateCheeseLayer(),void 0===s&&(t.setoptions.onpiece||(()=>{}))(e.iom.source.getFrame())}function i(){const s=t.falling.type;o(t.hold),t.hold=s,t.stats.holds++,e.hm.H.holddirty=!0,e.sxm.PlayIngame("hold")}return{FallEvent:function(n,o=1){if(t.falling.safelock>0&&t.falling.safelock--,t.falling.sleep||t.falling.deep_sleep)return;let i=t.g*o;t.softdrop&&(t.handling.sdf==(t.setoptions.version>=15?41:21)?i=(t.setoptions.version>=15?400:20)*o:(i*=t.handling.sdf,i=Math.max(i,t.setoptions.version>=13?.05*t.handling.sdf:.42))),void 0!==n&&(i=n,e.c.OnClient((()=>{e.gpm.Vibrate(ee.HARDDROP),e.sxm.PlayIngame("harddrop")}))),!t.setoptions.infinitemovement&&t.falling.lockresets>=(t.setoptions.lockresets||15)&&!e.bm.IsLegalAtPos(t.falling.type,t.falling.x,t.falling.y+1,t.falling.r)&&(i=20,t.falling.forcelock=!0),!t.setoptions.infinitemovement&&t.fallingrotations>(t.setoptions.lockresets||15)+15&&(i+=.5*o*(t.fallingrotations-((t.setoptions.lockresets||15)+15)));let r=i;for(;i>0;){const l=Math.ceil(t.falling.y);if(!s(Math.min(1,i),r)){void 0!==n&&(t.falling.forcelock=!0),a(void 0!==n,o);break}i-=Math.min(1,i),l!==Math.ceil(t.falling.y)&&(t.falling.last="fall",t.softdrop&&(t.stats.score+=No.scoring.SOFTDROP,t.setoptions.zenlevels&&(t.stats.zenprogress+=e.znm.ScoreToZenProgress(No.scoring.SOFTDROP,t.stats.zenlevel)),e.c.OnClient((()=>{e.sxm.PlayIngame("softdrop")}))))}},FallInner:s,Locking:a,Lock:n,Next:o,SwapHold:i}},Yo=function(e){"use strict";const t=e.gsm;return{LowerFire:function(){t.fireGrace>0?t.fireGrace--:t.fire=Math.max(0,t.fire-5/60)},AddFire:function(s){if(!t.setoptions.display_fire)return;let a=t.fire>=500;t.fire=Math.min(700,t.fire+s),t.fire>=500&&!a&&("full"!==e.hm.H.displaymode||e.c.IsServer()||"minimal"===te.video.graphics||!1===te.video.fire||(e.sxm.PlayIngame("fire"),e.hm.H.board.el("username").action("startfire")),t.fireGrace=300,t.fire=Math.min(700,t.fire+14))},PullFire:function(s=1){e.c.IsServer()||(t.fire!==t.fireAppr&&("minimal"===te.video.graphics||"tiny"===e.hm.H.displaymode?t.fireAppr=t.fire:(t.fireAppr=t.fire+(t.fireAppr-t.fire)*Math.pow(.9,s),Math.abs(t.fireAppr-t.fire)<.01&&(t.fireAppr=t.fire))),"minimal"!==te.video.graphics&&!1!==te.video.fire&&"high"!==te.video.caching&&(e.hm.H.board.el("username").update(t.fireAppr),t.fireAppr>=500&&t.playing&&e.hm.H.board.el("username").action("continuefire")))}}},Vo=function(e){"use strict";const t=e.gsm;return{ExplodeLine:function(s){e.c.IsServer()||"low"!==te.video.graphics&&"minimal"!==te.video.graphics&&"full"===e.hm.H.displaymode&&0!==e.lm.H.soundSkipRate&&"full"===e.hm.H.displaymode&&(xn.play("bgsplash",{direction:90,amt:5}),xn.play("bgsplash",{direction:270,amt:5}),function(s,a,n){if(e.c.IsServer())return;if("low"===te.video.graphics||"minimal"===te.video.graphics||"tiny"===e.hm.H.displaymode||0===e.lm.H.soundSkipRate)return;for(var o=0;o<e.W();o++){const i=ao(e.hm.H.stackobj,o*Ls(fo.x)+Ls(fo.x/2),(n-e.B())*Ls(fo.x)+Ls(fo.x/2)),r=Eo.getColor(t.setoptions.minoskin[t.kickset.colorMap[t.board[n][o]]]||t.setoptions.minoskin.other,t.kickset.colorMap[t.board[n][o]]);xn.play(s,{x:i.x,y:i.y,s:e.hm.S(),color:r,...a})}}("line_burst",{},s))},EffectAtTetromino:function(s,a,n,o,i,r,l){if(!e.c.IsServer()&&"low"!==te.video.graphics&&"minimal"!==te.video.graphics&&0!==e.lm.H.soundSkipRate)for(let c=0;c<No.tetrominoes[o].matrix.data[l].length;c++){const d=No.tetrominoes[o].matrix.data[l][c][0]-No.tetrominoes[o].matrix.dx,p=No.tetrominoes[o].matrix.data[l][c][1]-No.tetrominoes[o].matrix.dy,u=ao(n,(i+d)*Ls(fo.x)+Ls(fo.x/2),(Math.ceil(r)+p-e.B())*Ls(fo.x)+Ls(fo.x/2)),m=Eo.getColor(t.setoptions.minoskin[t.kickset.colorMap[o]]||t.setoptions.minoskin.other,t.kickset.colorMap[o]);xn.play(s,{x:u.x,y:u.y,color:m,...a})}},EffectAtTetrominoEdge:function(s,a,n,o,i,r,l){if(!e.c.IsServer()&&"low"!==te.video.graphics&&"minimal"!==te.video.graphics&&0!==e.lm.H.soundSkipRate)for(let c=0;c<No.tetrominoes[o].matrix.data[l].length;c++){const d=No.tetrominoes[o].matrix.data[l][c][0]-No.tetrominoes[o].matrix.dx,p=No.tetrominoes[o].matrix.data[l][c][1]-No.tetrominoes[o].matrix.dy;if(e.bm.IsOccupied(i+d,Math.ceil(r)+p+1)){const l=ao(n,(i+d)*Ls(fo.x)+Ls(fo.x/2),(Math.ceil(r)+p-e.B())*Ls(fo.x)+Ls(fo.x)),c=Eo.getColor(t.setoptions.minoskin[t.kickset.colorMap[o]]||t.setoptions.minoskin.other,t.kickset.colorMap[o]);xn.play(s,{x:l.x,y:l.y,color:c,...a})}}}}},Zo=function(e){"use strict";const t=e.gsm;let s=[];const a=["interaction_confirm","kev"];return{HandleIGE:function(n){if("ige"!==n.type)return;if(void 0===n.id&&(n=n.data),s.includes(n.id))return;s.push(n.id);const o=()=>{if(t.setoptions.noreplay||e.iom.replay.pushEvent("ige",n),"attack"===n.data.type&&e.atm.IncomingAttack({type:"garbage",amt:n.data.lines,column:n.data.column,x:e.Wh(),y:e.B()+e.Hh()},n.data.sender,n.data.cid),"interaction"===n.data.type&&"garbage"===n.data.data.type)e.atm.StartingAttack(n.data.data,n.data.sender,n.data.cid);if("interaction_confirm"===n.data.type&&"garbage"===n.data.data.type)e.atm.IncomingAttack(n.data.data,n.data.sender,n.data.cid);"kev"===n.data.type&&n.data.killer.name==t.setoptions.username&&(e.fim.AddFire(150+n.data.fire/700*200),t.stats.kills++)};if(!e.c.IsServer()&&a.includes(n.data.type)&&"keyboard"===e.iom.source.type()&&n.data.sender&&n.data.sent_frame&&ha){const t=ha.getFrameOf(n.data.sender)||0,s=e.iom.source.getFrame()-t;s&&s<=200&&ha.awaitFrameFor(n.data.sender,n.data.sent_frame,o)||o()}else o()},ClearSeenIGEs:function(){s=[]},HandleTargets:function(s){"targets"===s.type&&(void 0===s.id&&(s=s.data),t.setoptions.noreplay||e.iom.replay.pushEvent("targets",s),t.targets=s.data)},HandleEnd:function(t){"end"===t.type&&e.gom.GameOver(t.data.reason,!0)}}},Jo=function(e){"use strict";return{kickset:{},setoptions:{},handling:{},subframe:0,started:!1,countdown_started:!1,playing:!0,destroyed:!1,successful:!1,endqueued:!1,waitingframes:[],unsafewaitingframes:[],gameoverreason:null,g:.25,board:[],boardedges:[],bag:[],hold:null,holdlocked:!1,rng:null,lastGenerated:null,falling:{sleep:!0,deep_sleep:!1,hibernated:!1,locking:0,lockresets:0,forcelock:!1,floored:!1,clamped:!1,safelock:0,x:4,y:14,r:0,type:"i",highesty:14,last:null,lastkick:0,lastrotation:"none",irs:0,ihs:!1,aox:0,aoy:0,keys:0},fallingrotations:0,totalrotations:0,ldas:0,ldasiter:0,lshift:!1,rdas:0,rdasiter:0,rshift:!1,lastshift:0,softdrop:!1,stats:{seed:0,lines:0,level_lines:0,level_lines_needed:1,inputs:0,holds:0,time:{start:0,zero:!0,locked:!1,prev:0,frameoffset:0},score:0,zenlevel:1,zenprogress:0,level:0,combo:0,currentcombopower:0,topcombo:0,btb:0,topbtb:0,tspins:0,piecesplaced:0,clears:{singles:0,doubles:0,triples:0,quads:0,realtspins:0,minitspins:0,minitspinsingles:0,tspinsingles:0,minitspindoubles:0,tspindoubles:0,tspintriples:0,tspinquads:0,allclear:0},garbage:{sent:0,received:0,attack:0,cleared:0},kills:0,finesse:{combo:0,faults:0,perfectpieces:0}},currentbtbchainpower:0,stock:0,killer:{name:null,type:"sizzle"},lastattacker:[],impendingdamage:[],garbageid:0,lastwasattack:!1,targets:[],garbagereceived:0,lastoffensive:{x:0,y:0,offence:0,defense:0},placement:1,fire:0,fireAppr:0,fireGrace:0,escAllowed:!0,esc:!1,esciter:0,retryAllowed:!0,retry:!1,retryiter:0,hyperRetryAllowed:!0,hyperForfeitAllowed:!0}},Qo=function(e){"use strict";e.gsm;return{Vibrate:function(t){e.c.IsServer()||"keyboard"===e.iom.source.type()&&ee.pulse(...t)}}},ei=function(t){"use strict";const s=t.gsm;function a(){t.c.IsServer()||(t.hm.H.holder&&!t.hm.H.holder._destroyed&&t.hm.H.holder.destroy(),s.destroyed=!0,po.unregisterStartingWith(t.IID),t.lm.H.stopdraw=!0,t.lm.H.stopgame=!0,ki=ki.filter((e=>e.IID!==t.IID)),t.iom.source.unhook(),t.iom.source&&"keyboard"===t.iom.source.type()&&(Dn.opacity(1),Dn.scale(1)),t.otm.EndOverText())}return{GameOver:function(n,o=!1){if((!s.falling.deep_sleep||o)&&!s.falling.hibernated){if(s.falling.sleep=!0,s.falling.deep_sleep=!0,s.falling.hibernated=!0,s.escAllowed=!1,s.retryAllowed=!1,s.playing=!1,s.gameoverreason=n,s.setoptions.noreplay||t.iom.replay.pushEvent("end",{reason:n,export:t.siom.Export()}),t.c.IsServer())return"topout"===n&&(s.setoptions.onfail||(()=>{}))(t.siom.Export()),"garbagesmash"===n&&(s.setoptions.onfail||(()=>{}))(t.siom.Export()),"forfeit"===n&&(s.setoptions.onfail||(()=>{}))(t.siom.Export()),"clear"===n&&(s.setoptions.onfinish||(()=>{}))(t.siom.Export()),"topout_clear"===n&&(s.setoptions.onfinish||(()=>{}))(t.siom.Export()),void(s.setoptions.onstop||(()=>{}))(t.siom.Export());switch(s.setoptions.zenlevels&&(Ut.saveZen({map:t.bm.BoardToMap(),level:s.stats.zenlevel,progress:s.stats.zenprogress,score:s.stats.score},800),s.setoptions.usezenconfig&&e("zen_panel").classList.add("hidden")),t.hm.H.fallingobj.visible=!1,t.dsm.UpdateCounts(!0),s.setoptions.physical&&"forfeit"!==n&&e("forfeit").classList.add("hidden"),s.setoptions.physical&&"retry"!==n&&e("retry").classList.add("hidden"),t.lm.H.stopgame=!0,s.setoptions.neverstopbgm||"retry"===n&&s.setoptions.bgmnoreset||Ps.stop(200),s.setoptions.physical&&!s.setoptions.display_replay&&(document.body.classList.remove("ingame_phys"),!kn()&&te.notifications.suppress&&C()),t.rbm.AwardSecrets(),n){case"topout":if(!s.setoptions.physical&&s.setoptions.hasgarbage&&t.iom.source&&"socket"===t.iom.source.type()&&t.atm.TakeAllDamage(!0),t.gpm.Vibrate(ee.TOPOUT),t.sxm.PlayIngame("topout"),t.hm.H.holderstate.ds+=50*t.lm.H.lastdT,"full"===t.hm.H.displaymode&&(xn.play("bgsplashdanger",{direction:0,amt:50}),xn.play("bgcircle",{color:16720384,amt:300,speed:300})),!1!==te.video.siren&&"full"===t.hm.H.displaymode){const e=ao(t.hm.H.stackobj,Ls(fo.x*t.Wh()),Ls(fo.x*t.Hh()));xn.play("death_flair",{x:e.x,y:e.y,w:t.W()*t.hm.S(),h:t.H()*t.hm.S()})}s.killer.type="sizzle",(s.setoptions.onfail||(()=>{}))(t.siom.Export()),setTimeout((()=>{t.pm.H.siren=!1,t.hm.H.pullingholder=!1;const e=Math.sign(Math.random()-.5);go.animate(t.hm.H.holder,{0:{y:"inherit",rotation:0},1:{y:Ls(800)+window.innerHeight,rotation:.3*e}},1,BezierEasing(.37,.06,.75,.56))}),250),setTimeout((()=>{a()}),1250);break;case"garbagesmash":{if(!s.setoptions.physical&&s.setoptions.hasgarbage&&t.iom.source&&"socket"===t.iom.source.type()&&t.atm.TakeAllDamage(!0),t.sxm.PlayIngame("topout"),t.gpm.Vibrate(ee.GARBAGESMASH),t.sxm.PlayIngame("garbagesmash"),t.hm.H.holderstate.ds+=100*t.lm.H.lastdT,"full"===t.hm.H.displaymode&&(xn.play("bgsplashdanger",{direction:0,amt:50}),xn.play("bgcircle",{color:16720384,amt:300,speed:300})),!1!==te.video.siren&&"full"===t.hm.H.displaymode){const e=ao(t.hm.H.stackobj,Ls(fo.x*t.Wh()),Ls(fo.x*t.Hh()));xn.play("death_flair",{x:e.x,y:e.y,w:t.W()*t.hm.S(),h:t.H()*t.hm.S()})}s.killer.type="spark";let e=t.T()-t.bm.HighestLine();s.impendingdamage.forEach((t=>{e+=t.lines})),e>=t.T()&&(s.killer.type="spike"),(s.setoptions.onfail||(()=>{}))(t.siom.Export()),setTimeout((()=>{t.pm.H.siren=!1,t.hm.H.pullingholder=!1;const e=Math.sign(Math.random()-.5);go.animate(t.hm.H.holder,{0:{y:"inherit",rotation:0},1:{y:Ls(800)+window.innerHeight,rotation:.3*e}},1,BezierEasing(.37,.06,.75,.56))}),250),setTimeout((()=>{a()}),1250);break}case"clear":{t.sxm.PlayIngame("finish"),t.pm.H.siren=!1,t.hm.H.pullingholder=!1,s.stats.time.locked=!0,t.gpm.Vibrate(ee.CLEAR),go.animate(t.hm.H.holder,{0:{"scale.x":"inherit","scale.y":"inherit",alpha:1},1:{"scale.x":5,"scale.y":5,alpha:0}},5,BezierEasing(.1,.16,.94,.06)),"full"===t.hm.H.displaymode&&(xn.play("bgcircle",{amt:300,speed:300}),t.ssm.GlobalShout("finish","FINISH"));const e=1e3*(t.iom.source.getFrame()+s.subframe)/60;(s.setoptions.onfinish||(()=>{}))(t.siom.Export({seed:s.setoptions.seed,finalTime:e})),t.dsm.FinalizeTimer(e),setTimeout((()=>{a()}),1e4);break}case"topout_clear":t.gpm.Vibrate(ee.TOPOUT),t.sxm.PlayIngame("gameover"),t.hm.H.holderstate.ds+=100*t.lm.H.lastdT,"full"===t.hm.H.displaymode&&(xn.play("bgsplashdanger",{direction:0,amt:50}),xn.play("bgcircle",{color:16720384,amt:300,speed:300}),t.ssm.GlobalShout("gameover","GAME OVER")),setTimeout((()=>{t.pm.H.siren=!1,t.hm.H.pullingholder=!1,s.stats.time.locked=!0,go.animate(t.hm.H.holder,{0:{"scale.x":"inherit","scale.y":"inherit",alpha:1},1:{"scale.x":.5,"scale.y":.5,alpha:0}},5,BezierEasing(.1,.16,.94,.06));const e=1e3*(t.iom.source.getFrame()+s.subframe)/60;(s.setoptions.onfinish||(()=>{}))(t.siom.Export({seed:s.setoptions.seed,finalTime:e})),t.dsm.FinalizeTimer(e)}),250),setTimeout((()=>{a()}),1e4);break;case"winner":t.sxm.PlayIngame("finish"),t.pm.H.siren=!1,t.hm.H.pullingholder=!1,s.stats.time.locked=!0,t.gpm.Vibrate(ee.CLEAR),go.animate(t.hm.H.holder,{0:{"scale.x":"inherit","scale.y":"inherit",alpha:1},1:{"scale.x":2,"scale.y":2,alpha:0}},3,BezierEasing(.1,.16,.94,.06)),"full"===t.hm.H.displaymode&&xn.play("bgcircle",{amt:300,speed:300}),(s.setoptions.onfinish||(()=>{}))(t.siom.Export()),setTimeout((()=>{a()}),3500);break;case"forfeit":t.pm.H.siren=!1,t.hm.H.pullingholder=!1,go.animate(t.hm.H.holder,{0:{"scale.x":"inherit","scale.y":"inherit",alpha:1},1:{"scale.x":0,"scale.y":0,alpha:.5}},1,BezierEasing(.22,.09,.84,.23)),e("forfeit").classList.add("hidden"),(s.setoptions.onquit||(()=>{}))(t.siom.Export()),setTimeout((()=>{xn.play("bgcircle",{radius:10}),t.sxm.PlayIngame("detonated")}),1e3),setTimeout((()=>{a()}),5e3);break;case"retry":t.pm.H.siren=!1,t.hm.H.pullingholder=!1,go.animate(t.hm.H.holder,{0:{"scale.x":"inherit"},1:{"scale.x":0}},s.setoptions.stride?.05:.25,BezierEasing(.36,.01,.75,.3)),e("retry").classList.add("hidden"),setTimeout((()=>{a()}),s.setoptions.stride?50:1e3),setTimeout((()=>{s.setoptions.fromretry||(s.setoptions.countdown_interval*=.75),s.setoptions.precountdown=500,s.setoptions.prestart=0,s.setoptions.mission="",s.setoptions.zoominto="fast",s.setoptions.fromretry=!0,s.setoptions.physical=!0,s.setoptions.bgmnoreset&&s.started&&(s.setoptions.onstart=()=>{}),De=new Ei,De.bindEventSource(new Uo({type:"keyboard"})),De.setGame(s.setoptions),De.createGameHolder(t.hm.H.displaymode),De.startGame()}),s.setoptions.stride?50:250),Ut.reportAbortedGame();break;case"drop":t.pm.H.siren=!1,t.hm.H.pullingholder=!1,(s.setoptions.onquit||(()=>{}))(t.siom.Export()),go.animate(t.hm.H.holder,{0:{"scale.x":"inherit","scale.y":"inherit",alpha:1},1:{"scale.x":0,"scale.y":0,alpha:.5}},.5,BezierEasing(.36,.01,.75,.3)),setTimeout((()=>{xn.play("bgcircle",{radius:10}),t.sxm.PlayIngame("detonated")}),500),setTimeout((()=>{a()}),550);break;case"dropnow":return t.pm.H.siren=!1,t.hm.H.pullingholder=!1,go.animate(t.hm.H.holder,{0:{"scale.x":"inherit","scale.y":"inherit",alpha:1},1:{"scale.x":0,"scale.y":0,alpha:.5}},.5,BezierEasing(.36,.01,.75,.3)),setTimeout((()=>{xn.play("bgcircle",{radius:10}),t.sxm.PlayIngame("detonated")}),500),void setTimeout((()=>{a()}),550);case"disconnect":t.pm.H.siren=!1,t.hm.H.pullingholder=!1,(s.setoptions.onfail||(()=>{}))(t.siom.Export()),go.animate(t.hm.H.holder,{0:{"scale.x":"inherit","scale.y":"inherit",alpha:"inherit"},1:{"scale.x":2,"scale.y":0,alpha:0}},.25,BezierEasing(.09,.73,.23,.9)),setTimeout((()=>{a()}),300)}(s.setoptions.onend||(()=>{}))(t.siom.Export()),(s.setoptions.onstop||(()=>{}))(t.siom.Export())}},Destroy:a}},ti=function(e){"use strict";const t=e.gsm,s={holder:null,displaymode:"full",board:null,leftside:null,rightside:null,stackobj:null,stackmud:[],stackdirty:!0,fallingobj:null,fallingdirty:!0,nextobj:null,nextdirty:!0,holdobj:null,holddirty:!0,tintables:[],fgtintables:[],hybridtintables:[],pullingholder:!0,holderneedsrepull:!1,holderstate:{x:0,y:0,r:0,s:0,w:0,dx:0,dy:0,dr:0,ds:0,dw:0,ox:0,oy:0,os:1,cox:0,coy:0,cos:1,tr:255,tg:255,tb:255,ctr:255,ctg:255,ctb:255,fgtr:0,fgtg:0,fgtb:0,fgctr:0,fgctg:0,fgctb:0,asf:1}},a=s.holderstate;let n=null,o=null,i=null,r=null;function l(e,t,a,l,c){s.holder&&!s.holder._destroyed&&(a=a/360*2*Math.PI,(e!==n||c)&&(n=e,s.holder.x=Ls(800)+e),(t!==o||c)&&(o=t,s.holder.y=Ls(400)+t),(a!==i||c)&&(i=a,s.holder.rotation=a),(l!==r||c)&&(r=l,s.holder.scale.set(l)))}function c(e,t,s){return e<<16|t<<8|s}function d(n=!1,o=1){if(e.c.IsServer())return;if(e.lm.H.lastdTs.push(o),e.lm.H.lastdTs.length>10&&e.lm.H.lastdTs.shift(),e.lm.H.lastdT=e.lm.H.lastdTs.reduce(((e,t)=>e+t))/e.lm.H.lastdTs.length,s.holderneedsrepull=!1,!s.pullingholder)return;if("minimal"===te.video.graphics){a.cox=a.ox,a.coy=a.oy,a.cos=a.os;const e=800*a.cox,t=400*a.coy,s=a.cos*a.asf;return void l(Ls(e),Ls(t),0,s,n)}if("tiny"===s.displaymode){a.cox=a.ox+(a.cox-a.ox)*Math.pow(.9,o),a.coy=a.oy+(a.coy-a.oy)*Math.pow(.9,o),a.cos=a.os+(a.cos-a.os)*Math.pow(.9,o),Math.abs(a.cox-a.ox)<("minimal"!==te.video.graphics?.001:1)&&(a.cox=a.ox),Math.abs(a.coy-a.oy)<("minimal"!==te.video.graphics?.001:1)&&(a.coy=a.oy),Math.abs(a.cos-a.os)<.01&&(a.cos=a.os);const e=800*a.cox,i=400*a.coy,r=a.cos*a.asf;if(l(Ls(e),Ls(i),0,r,n),"high"!==te.video.caching){const e=c(Math.round(a.ctr),Math.round(a.ctg),Math.round(a.ctb)),n=c(Math.round(a.fgctr),Math.round(a.fgctg),Math.round(a.fgctb));s.tintables.forEach((t=>{t.destroyed||t.tint!=e&&(t.tint=e)})),s.fgtintables.forEach((e=>{e.destroyed||e.tint!=n&&(e.tint=n)}));const o=t.setoptions.display_fire&&t.fire>=500?n:e;s.hybridtintables.forEach((e=>{e.destroyed||(e.tint=o)}))}return a.dx=0,a.dy=0,a.dr=0,a.ds=0,a.dw=0,a.ctr=a.tr,a.ctg=a.tg,a.ctb=a.tb,a.fgctr=a.fgtr,a.fgctg=a.fgtg,void(a.fgctb=a.fgtb)}let i=Math.pow(.55+.2*te.video.bounciness,o),r=Math.pow(.82+.08*te.video.bounciness,o),d=Math.pow(.55+.2*te.video.shakiness,o),p=Math.pow(.35+.5*te.video.shakiness,o);a.x*=i,a.y*=i,a.r*=r,a.s*=d,a.w*=p,a.x+=a.dx,a.y+=a.dy,a.r+=a.dr,a.s+=a.ds,a.w+=a.dw,a.dx*=i,a.dy*=i,a.dr*=r,a.ds*=d,a.dw*=p;let u=Math.random()*a.s-a.s/2+Math.sin((e.iom.source?e.iom.source.getFrame():0)/1.5*Math.max(1,(a.w+120)/150))*Math.min(30,a.w),m=Math.random()*a.s-a.s/2;0!=te.video.bounciness&&0!==e.lm.H.soundSkipRate||(a.x=0,a.y=0,a.r=0,a.s=0),0!=te.video.shakiness&&0!==e.lm.H.soundSkipRate||(u=0,m=0),!1!==te.video.spin&&0!==e.lm.H.soundSkipRate||(a.r=0),a.cox=a.ox+(a.cox-a.ox)*Math.pow(.9,o),a.coy=a.oy+(a.coy-a.oy)*Math.pow(.9,o),a.cos=a.os+(a.cos-a.os)*Math.pow(.9,o);const g=800*a.cox,h=400*a.coy,f=a.cos*a.asf;if(l(Ls(g)+Math.round(Ls(a.x+u)*a.cos),Ls(h)+Math.round(Ls(a.y+m)*a.cos),a.r,f,n),a.ctr=a.tr+(a.ctr-a.tr)*Math.pow(.9,o),a.ctg=a.tg+(a.ctg-a.tg)*Math.pow(.9,o),a.ctb=a.tb+(a.ctb-a.tb)*Math.pow(.9,o),a.fgctr=a.fgtr+(a.fgctr-a.fgtr)*Math.pow(.9,o),a.fgctg=a.fgtg+(a.fgctg-a.fgtg)*Math.pow(.9,o),a.fgctb=a.fgtb+(a.fgctb-a.fgtb)*Math.pow(.9,o),"high"!==te.video.caching){const e=c(Math.round(a.ctr),Math.round(a.ctg),Math.round(a.ctb)),n=c(Math.round(a.fgctr),Math.round(a.fgctg),Math.round(a.fgctb));s.tintables.forEach((t=>{t.destroyed||(t.tint=e)})),s.fgtintables.forEach((e=>{e.destroyed||(e.tint=n)}));const o=t.setoptions.display_fire&&t.fire>=500?n:e;s.hybridtintables.forEach((e=>{e.destroyed||(e.tint=o)}))}}let p=null;function u(n,o=!1){if(e.c.IsServer())return;if(!t.playing)return;if(0===Object.keys(t.setoptions).length)return;n&&(s.displaymode=n),e.iom.scoped=t.setoptions.noscope||"tiny"!==s.displaymode&&!o,"socket"===e.iom.source.type()&&ha&&("tiny"!==s.displaymode||t.setoptions.noscope?t.setoptions.noscope||(null!==p&&clearTimeout(p),p=setTimeout((()=>{t.destroyed||"tiny"===s.displaymode||ha.startScope(t.setoptions.username),p=null}),200)):(ha.endScope(t.setoptions.username),null!==p&&(clearTimeout(p),p=null)));let i=!1;s.holder&&(i=s.holder.visible,s.holder.destroy(),s.holder=null,s.leftside=null,s.rightside=null,e.pm.H.alerting=!1),e.otm.EndOverText(),s.tintables=[],s.fgtintables=[],s.stackdirty=!0,s.fallingdirty=!0,s.nextdirty=!0,s.holddirty=!0,a.asf=1;e.W()/Math.max(1,e.H())>=1.5?a.asf=25/e.W():e.H()<15?a.asf=20/e.H():e.H()>30&&(a.asf=30/e.H()),s.board=new(Do[t.setoptions.boardskin]||Do.generic).ns.Board(s,t,e),s.holder=new PIXI.Container,s.holder.position.set(Ls(800),Ls(400)),s.holder.pivot.set(Ls(fo.x*e.Wh()),Ls(fo.x*e.Hh())),s.holder.visible=i,("full"===s.displaymode?Wn:qn).addChild(s.holder),s.leftside=new PIXI.Container,s.holder.addChild(s.leftside),s.rightside=new PIXI.Container,s.holder.addChild(s.rightside),s.board.el("boardsides").create(),"tiny"===s.displaymode&&(s.holder.interactive=!0,s.holder.interactiveChildren=!1,s.holder.on("click",(()=>{!1!==t.setoptions.manual_allowed&&la&&ha&&ha.find(t.setoptions.username)&&la.setManual(ha.find(t.setoptions.username).context.listenID),ha&&(ha.setSpectating(t.setoptions.username),ha.order())})),s.holder.on("mouseover",e.otm.CreateOverText),s.holder.on("mousemove",e.otm.MoveOverText),s.holder.on("mouseout",e.otm.EndOverText));const r=s.board.el("background").create();r.interactive=!0,r.on("click",(()=>{!1!==t.setoptions.manual_allowed&&la&&ha&&ha.find(t.setoptions.username)&&la.setManual(ha.find(t.setoptions.username).context.listenID),ha&&(ha.setSpectating(t.setoptions.username),ha.order())})),"full"!==s.displaymode&&(r.on("mouseover",e.otm.CreateOverText),r.on("mousemove",e.otm.MoveOverText),r.on("mouseout",e.otm.EndOverText)),s.board.el("grid").create(),s.board.el("username").create(),s.stackobj=s.board.el("stack").create(),s.board.el("stock").create(),s.nextobj=s.board.el("next").create(),s.holdobj=s.board.el("hold").create(),s.fallingobj=s.board.el("falling").create(),s.board.el("border").create(),s.board.el("replaytag").create(),s.board.el("backer").create(),s.board.el("zen").create(),s.board.el("counter1").create(),s.board.el("counter2").create(),s.board.el("counter3").create(),s.board.el("counter4").create(),s.board.el("counter5").create(),s.board.el("bar1").create(),s.board.el("bar2").create(),e.dsm.DisplayCounts(),d(!0),e.pbm.UpdateGarbageBar("impending"),"tiny"===s.displaymode&&"low"!==te.video.caching&&(s.holder.cacheAsBitmap=!0),"full"===s.displaymode&&(Zn=!0)}function m(){e.c.IsServer()||(e.hm.H.holder&&!e.hm.H.holder._destroyed&&e.hm.H.holder.destroy(),t.setoptions.headless=!0,po.unregisterStartingWith(e.IID),e.lm.H.stopdraw=!0,e.lm.H.stopgame=!0,e.iom.source&&"keyboard"===e.iom.source.type()&&(Dn.opacity(1),Dn.scale(1)),e.otm.EndOverText())}let g=null;return{H:s,SetHolderTransformData:l,TripletToSingle:c,PullHolder:d,CreateHolder:u,Behead:m,Rehead:function(a=!1){e.c.IsServer()&&(t.setoptions.headless=!1,u("tiny",!0),ys(!1),e.lm.H.stopdraw=!1,e.lm.H.stopgame=!1,PIXI.Ticker.shared.add(e.lm.GameLoop),PIXI.Ticker.shared.add(e.lm.DrawLoop),e.dsm.DisplayCounts(),s.holder.visible=!0,a&&go.animate(s.holder,{0:{alpha:0},1:{alpha:1}},1,BezierEasing(0,0,1,1)),g&&(clearTimeout(g),g=null))},FadeOutAndBehead:function(e){go.animate(s.holder,{0:{"scale.x":"inherit","scale.y":"inherit",alpha:1},1:{"scale.x":0,"scale.y":0,alpha:0}},e/1e3,BezierEasing(0,0,1,1)),g=setTimeout((()=>{g=null,m()}),e)},S:()=>s.holderstate.cos*s.holderstate.asf}},si=function(t){"use strict";const s=t.gsm;function a(e){const a=s.falling.r,n=a+""+e;let o=0,i="none";if(e>a?(o=1,i="right"):(o=-1,i="left"),0===e&&3===a&&(o=1,i="right"),3===e&&0===a&&(o=-1,i="left"),2===e&&0===a&&(i="vertical"),0===e&&2===a&&(i="vertical"),3===e&&1===a&&(i="horizontal"),1===e&&3===a&&(i="horizontal"),t.bm.IsLegalAtPos(s.falling.type,s.falling.x+(s.kickset.additional_offsets[s.falling.type][e][0]-s.falling.aox),s.falling.y+(s.kickset.additional_offsets[s.falling.type][e][1]-s.falling.aoy),e))return s.falling.x+=s.kickset.additional_offsets[s.falling.type][e][0]-s.falling.aox,s.falling.y+=s.kickset.additional_offsets[s.falling.type][e][1]-s.falling.aoy,s.falling.aox=s.kickset.additional_offsets[s.falling.type][e][0],s.falling.aoy=s.kickset.additional_offsets[s.falling.type][e][1],s.falling.r=e,s.falling.last="rotate",s.falling.lastrotation=i,s.falling.lastkick=0,s.falling.spintype=t.rbm.IsTSpin(),s.fallingrotations++,s.totalrotations++,t.sxm.PlayIngame("rotate"),s.falling.clamped&&s.handling.dcd>0&&(s.ldas=Math.min(s.ldas,s.handling.das-s.handling.dcd),s.ldasiter=s.handling.arr,s.rdas=Math.min(s.rdas,s.handling.das-s.handling.dcd),s.rdasiter=s.handling.arr),(++s.falling.lockresets<15||s.setoptions.infinitemovement)&&(s.falling.locking=0),!t.c.IsServer()&&t.rbm.IsTSpin()&&(t.sxm.PlayIngame("spin"),t.gpm.Vibrate(ee.SPIN),"full"===t.hm.H.displaymode&&t.fxm.EffectAtTetromino("piece_spin",{direction:s.falling.lastrotation,kickX:0,kickY:0},t.hm.H.fallingobj,s.falling.type,s.falling.x,s.falling.y,s.falling.r),t.hm.H.holderstate.dr+=o/4*t.lm.H.lastdT),void(t.hm.H.fallingdirty=!0);if("o"===s.falling.type&&!s.kickset.allow_o_kick)return;let r=s.kickset.kicks[n];"i"===s.falling.type&&(r=s.kickset.i_kicks[n]);for(let a=0;a<r.length;a++){const n=r[a];let i=Math.floor(s.falling.y)+.1+n[1]+(s.kickset.additional_offsets[s.falling.type][e][1]-s.falling.aoy);if(!s.setoptions.infinitemovement&&s.totalrotations>(s.setoptions.lockresets||15)+15&&(i=s.falling.y+n[1]+(s.kickset.additional_offsets[s.falling.type][e][1]-s.falling.aoy)),t.bm.IsLegalAtPos(s.falling.type,s.falling.x+n[0]+(s.kickset.additional_offsets[s.falling.type][e][0]-s.falling.aox),i,e)){if(s.kickset.center_column&&["l","j","t"].includes(s.falling.type)){let e=!0;for(let a=0;a<s.kickset.center_column.length;a++)if(t.bm.IsOccupied(s.falling.x-s.falling.aox+s.kickset.center_column[a][0],s.falling.y-s.falling.aoy+s.kickset.center_column[a][1])){e=0!==s.kickset.center_column[a][0];break}if(!e)continue}return s.falling.x+=n[0]+(s.kickset.additional_offsets[s.falling.type][e][0]-s.falling.aox),s.falling.y=i,s.falling.aox=s.kickset.additional_offsets[s.falling.type][e][0],s.falling.aoy=s.kickset.additional_offsets[s.falling.type][e][1],s.falling.r=e,s.falling.spintype=t.rbm.IsTSpin(),s.falling.last="rotate",s.falling.lastkick=a+1,s.fallingrotations++,s.totalrotations++,t.sxm.PlayIngame("rotate"),s.falling.clamped&&s.handling.dcd>0&&(s.ldas=Math.min(s.ldas,s.handling.das-s.handling.dcd),s.ldasiter=s.handling.arr,s.rdas=Math.min(s.rdas,s.handling.das-s.handling.dcd),s.rdasiter=s.handling.arr),(++s.falling.lockresets<15||s.setoptions.infinitemovement)&&(s.falling.locking=0),!t.c.IsServer()&&t.rbm.IsTSpin()&&(t.sxm.PlayIngame("spin"),t.gpm.Vibrate(ee.SPIN),"full"===t.hm.H.displaymode&&t.fxm.EffectAtTetromino("piece_spin",{direction:s.falling.lastrotation,kickX:n[0],kickY:n[1]},t.hm.H.fallingobj,s.falling.type,s.falling.x,s.falling.y,s.falling.r),t.hm.H.holderstate.dr+=o/4*t.lm.H.lastdT),void(t.hm.H.fallingdirty=!0)}}}function n(e,a=1){if(!s.lshift||s.rshift&&-1!==s.lastshift)return;let n=a;const o=Math.max(0,s.handling.das-s.ldas);if(s.ldas+=e?0:a,s.ldas<s.handling.das&&!e)return;if(n=Math.max(0,n-o),s.falling.sleep||s.falling.deep_sleep)return;let i=1;if(!e){if(s.ldasiter+=s.setoptions.version>=15?n:a,s.ldasiter<s.handling.arr)return;i=0==s.handling.arr?10:Math.floor(s.ldasiter/s.handling.arr),s.ldasiter-=s.handling.arr*i}for(let e=0;e<i;e++)t.bm.IsLegalAtPos(s.falling.type,s.falling.x-1,s.falling.y,s.falling.r)?(s.falling.x--,s.falling.last="move",s.falling.clamped=!1,0===e&&t.sxm.PlayIngame("move"),t.hm.H.fallingdirty=!0,(++s.falling.lockresets<15||s.setoptions.infinitemovement)&&(s.falling.locking=0),t.bm.IsLegalAtPos(s.falling.type,s.falling.x-1,s.falling.y,s.falling.r)||t.sxm.PlayIngame("sidehit")):(s.falling.clamped=!0,t.c.OnClient((()=>{e<Math.max(1,10*te.video.bounciness-10)&&(t.hm.H.holderstate.dx-=.5*t.lm.H.lastdT)})))}function o(e,a=1){if(!s.rshift||s.lshift&&1!==s.lastshift)return;let n=a;const o=Math.max(0,s.handling.das-s.rdas);if(s.rdas+=e?0:a,s.rdas<s.handling.das&&!e)return;if(n=Math.max(0,n-o),s.falling.sleep||s.falling.deep_sleep)return;let i=1;if(!e){if(s.rdasiter+=s.setoptions.version>=15?n:a,s.rdasiter<s.handling.arr)return;i=0==s.handling.arr?10:Math.floor(s.rdasiter/s.handling.arr),s.rdasiter-=s.handling.arr*i}for(let e=0;e<i;e++)t.bm.IsLegalAtPos(s.falling.type,s.falling.x+1,s.falling.y,s.falling.r)?(s.falling.x++,s.falling.last="move",s.falling.clamped=!1,0===e&&t.sxm.PlayIngame("move"),t.hm.H.fallingdirty=!0,(++s.falling.lockresets<15||s.setoptions.infinitemovement)&&(s.falling.locking=0),t.bm.IsLegalAtPos(s.falling.type,s.falling.x+1,s.falling.y,s.falling.r)||t.sxm.PlayIngame("sidehit")):(s.falling.clamped=!0,t.c.OnClient((()=>{e<Math.max(1,10*te.video.bounciness-10)&&(t.hm.H.holderstate.dx+=.5*t.lm.H.lastdT)})))}function i(e,t=1){n(e,t),o(e,t)}let r=!0,l=!0;return{KeyDown:function(e){if("keydown"===e.type&&!e.data.key.startsWith("menu")){if(e.data.subframe>s.subframe&&(i(!1,e.data.subframe-s.subframe),t.fm.FallEvent(void 0,e.data.subframe-s.subframe),s.subframe=e.data.subframe),s.setoptions.noreplay||t.iom.replay.pushEvent("keydown",e.data),"moveLeft"===e.data.key)return s.stats.inputs++,s.falling.keys++,s.lshift=!0,s.lastshift=-1,s.ldas=e.data.hoisted?s.handling.das-s.handling.dcd:0,s.setoptions.version>=12&&(s.ldasiter=s.handling.arr),void n(!0,s.setoptions.version>=15?0:1);if("moveRight"===e.data.key)return s.stats.inputs++,s.falling.keys++,s.rshift=!0,s.lastshift=1,s.rdas=e.data.hoisted?s.handling.das-s.handling.dcd:0,s.setoptions.version>=12&&(s.rdasiter=s.handling.arr),void o(!0,s.setoptions.version>=15?0:1);if("softDrop"===e.data.key)return s.stats.inputs++,s.falling.keys=-999,void(s.softdrop=!0);if("exit"===e.data.key)return s.esc=!0,void(s.esciter=0);if("retry"===e.data.key){if(t.c.IsServer())return;return s.retry=!0,void(s.retryiter=0)}if(!s.falling.deep_sleep)if(s.falling.sleep){if("rotateCCW"===e.data.key){s.stats.inputs++;let e=s.falling.irs-1;e<0&&(e=3),s.falling.irs=e}if("rotateCW"===e.data.key){s.stats.inputs++;let e=s.falling.irs+1;e>3&&(e=0),s.falling.irs=e}if("rotate180"===e.data.key&&s.setoptions.allow180){s.stats.inputs++;let e=s.falling.irs+2;e>3&&(e-=4),s.falling.irs=e}"hold"===e.data.key&&(s.stats.inputs++,s.falling.ihs=!0)}else{if("rotateCCW"===e.data.key){s.stats.inputs++,s.falling.keys++;let e=s.falling.r-1;e<0&&(e=3),a(e)}if("rotateCW"===e.data.key){s.stats.inputs++,s.falling.keys++;let e=s.falling.r+1;e>3&&(e=0),a(e)}if("rotate180"===e.data.key&&s.setoptions.allow180){s.stats.inputs++,s.falling.keys+=2;let e=s.falling.r+2;e>3&&(e-=4),a(e)}"hardDrop"===e.data.key&&!1!==s.setoptions.allow_harddrop&&0===s.falling.safelock&&(s.stats.inputs++,t.fm.FallEvent(Number.MAX_SAFE_INTEGER,1)),"hold"===e.data.key&&(s.stats.inputs++,s.holdlocked||void 0!==s.setoptions.display_hold&&!s.setoptions.display_hold||t.fm.SwapHold())}}},KeyUp:function(e){if("keyup"===e.type&&!e.data.key.startsWith("menu")){if(e.data.subframe>s.subframe&&(i(!1,e.data.subframe-s.subframe),t.fm.FallEvent(void 0,e.data.subframe-s.subframe),s.subframe=e.data.subframe),s.setoptions.noreplay||t.iom.replay.pushEvent("keyup",e.data),"moveLeft"===e.data.key)return s.lshift=!1,s.ldas=0,void(s.handling.cancel&&(s.rdas=0,s.rdasiter=s.handling.arr));if("moveRight"===e.data.key)return s.rshift=!1,s.rdas=0,void(s.handling.cancel&&(s.ldas=0,s.ldasiter=s.handling.arr));if("softDrop"!==e.data.key){if("exit"===e.data.key)return s.esc=!1,void(s.esciter=0);if("retry"===e.data.key){if(t.c.IsServer())return;return s.retry=!1,void(s.retryiter=0)}}else s.softdrop=!1}},RotatePiece:a,ProcessLShift:n,ProcessRShift:o,ProcessShift:i,ProcessInterrupts:function(){if(s.esc&&s.escAllowed){const a=s.esciter++;let n=s.setoptions.forfeit_time||60;s.setoptions.stride&&(n/=3),t.c.OnClient((()=>{e("forfeit").style.height=1.5+a/20+"em",e("forfeit").style.lineHeight=1.7+a/20+"em",e("forfeit").style.boxShadow=`0px 0px ${8+a/3}px #F00`,e("forfeit").style.filter=`brightness(${1+Math.max(0,(a-n+5)/5)})`,e("forfeit").classList.remove("hidden")})),r=!1,a>n?(t.gom.GameOver("forfeit",!0),t.c.OnClient((()=>{Os.play("detonate2")}))):a%20==0&&t.c.OnClient((()=>{Os.play("detonate1")}))}else r||(t.c.OnClient((()=>{e("forfeit").classList.add("hidden")})),r=!0);if(!t.c.IsServer())if(s.retry&&s.retryAllowed&&s.setoptions.can_retry){if(s.setoptions.stride)return t.gom.GameOver("retry",!0),void Os.play("detonate2");const a=s.retryiter++;e("retry").style.height=1.5+a/20+"em",e("retry").style.lineHeight=1.7+a/20+"em",e("retry").style.boxShadow=`0px 0px ${8+a/3}px #FA0`,e("retry").style.filter=`brightness(${1+Math.max(0,(a-15+5)/5)})`,e("retry").classList.remove("hidden"),l=!1,a>15?(s.setoptions.retryisclear?(t.bm.DestroyBoard(),s.hold=null,s.bag=[],s.stats.lines=0,s.stats.inputs=0,s.stats.time.frameoffset=t.iom.source.getFrame(),s.stats.piecesplaced=0,s.stats.garbage.sent=0,s.stats.garbage.attack=0,s.stats.garbage.cleared=0,s.stats.combo=0,s.stats.currentcombopower=0,s.stats.btb=0,s.stats.finesse.combo=0,s.stats.finesse.faults=0,s.stats.finesse.perfectpieces=0,s.setoptions.b2bchaining&&t.hm.H.board.el("b2b").delete(),t.bam.PopulateBag(),t.fm.Next(),t.c.OnClient((()=>{t.gpm.Vibrate(ee.CLEAR),t.hm.H.holderstate.ds+=50*t.lm.H.lastdT,t.sxm.PlayIngame("shatter")})),s.retry=!1,s.retryiter=0):t.gom.GameOver("retry",!0),Os.play("detonate2")):a%5==0&&Os.play("detonate1")}else l||(e("retry").classList.add("hidden"),l=!0)}}},ai=function(e){"use strict";return{replay:new Fo,source:null,scoped:!0}},ni=function(e){"use strict";const t=e.gsm;function s(s,a=!1,n=1){if(a)t.stats.level=n,t.g=Math.min(Number.MAX_SAFE_INTEGER-1,1/60/Math.pow(Math.max(1e-9,(t.setoptions.gbase||.8)-(t.stats.level-1)*(t.setoptions.gspeed||.007)),t.stats.level-1)),t.stats.level_lines=0,t.stats.level_lines_needed=t.setoptions.levelstatic?t.setoptions.levelstaticspeed||10:Math.ceil(t.stats.level*(t.setoptions.levelspeed||1)*5),t.setoptions.masterlevels&&t.stats.level>20&&(t.setoptions.locktime=30-Math.min(25,t.stats.level-20)),t.setoptions.masterlevels&&t.stats.level>45&&(t.setoptions.lockresets=15-Math.min(10,t.stats.level-45));else if(t.stats.level_lines+=s,t.stats.level_lines>=t.stats.level_lines_needed){for(;t.stats.level_lines>=t.stats.level_lines_needed;)t.stats.level_lines-=t.stats.level_lines_needed,t.stats.level++,t.g=Math.min(Number.MAX_SAFE_INTEGER-1,1/60/Math.pow(Math.max(1e-9,(t.setoptions.gbase||.8)-(t.stats.level-1)*(t.setoptions.gspeed||.007)),t.stats.level-1)),t.stats.level_lines_needed=t.setoptions.levelstatic?t.setoptions.levelstaticspeed||10:Math.ceil(t.stats.level*(t.setoptions.levelspeed||1)*5),t.setoptions.masterlevels&&t.stats.level>20&&(t.setoptions.locktime=30-Math.min(25,t.stats.level-20)),t.setoptions.masterlevels&&t.stats.level>45&&(t.setoptions.lockresets=15-Math.min(10,t.stats.level-45));e.c.OnClient((()=>{e.sxm.PlayIngame("levelup");let s=t.stats.level;t.setoptions.masterlevels&&t.stats.level>20&&(s="M"+(t.stats.level-20)),"minimal"!==te.video.graphics&&"off"!==te.video.actiontext&&"some"!==te.video.actiontext&&e.hm.H.board.fx("levelup").create(s),"full"===e.hm.H.displaymode&&0!==e.lm.H.soundSkipRate&&xn.play("bgcircle"),t.setoptions.levels&&!t.setoptions.absolute_lines&&e.pbm.BlastBar("progress")}))}}function a(e){for(let s=0;s<e.length;s++)t.board[e[s]].some((e=>"gb"===e||"gbd"===e))&&t.stats.garbage.cleared++}function n(a,n){let o=!1;t.stats.lines+=a,t.setoptions.levels&&s(a),a?(t.stats.combo++,t.stats.topcombo=Math.max(t.stats.combo,t.stats.topcombo),!e.c.IsServer()&&t.stats.combo>1&&e.hm.H.board.fx("combo").create(t.stats.combo-1+" \fc3COMBO"),4===a?(o=!0,e.c.OnClient((()=>{t.stats.btb?(e.gpm.Vibrate(ee.CLEARB2B),e.sxm.PlayIngame("clearbtb",1,!0)):(e.gpm.Vibrate(ee.CLEARQUAD),e.sxm.PlayIngame("clearquad",1,!0))}))):n?(o=!0,e.c.OnClient((()=>{e.gpm.Vibrate(ee.CLEARSPIN),e.sxm.PlayIngame("clearspin",1,!0)}))):e.c.OnClient((()=>{e.gpm.Vibrate(ee.CLEARLINE),e.sxm.PlayIngame("clearline",1,!0)})),e.hm.H.holderstate.dy+=8*a*e.lm.H.lastdT,!e.c.IsServer()&&a>=1&&e.hm.H.board.fx("clear").create(Ao.cleartypes[a]||Ao.cleartypes[21]),o?(t.stats.btb++,t.stats.topbtb=Math.max(t.stats.btb,t.stats.topbtb),e.c.OnClient((()=>{"full"===e.hm.H.displaymode&&0!==e.lm.H.soundSkipRate&&xn.play("bgcircle"),t.stats.btb>1&&(t.setoptions.b2bchaining||e.hm.H.board.fx("also").create(`${Ao.extra.btb}${t.stats.btb>2?" \fc3X\f5"+(t.stats.btb-1):""}`))}))):(!e.c.IsServer()&&t.setoptions.b2bchaining&&e.hm.H.board.el("b2b").update(t.stats.btb>2?"down_large":"down",0),t.stats.btb=0,t.setoptions.b2bchaining&&t.currentbtbchainpower>=2&&e.sxm.PlayIngame("btb_break"))):(t.stats.combo>3&&e.sxm.PlayIngame("combobreak"),t.stats.combo=0,t.stats.currentcombopower=0),n&&(e.c.OnClient((()=>{e.sxm.PlayIngame("spinend"),"full"===e.hm.H.displaymode&&0!==e.lm.H.soundSkipRate&&e.hm.H.board.fx("tspin").create(Ao.tspins[n].replace("%%PIECE%%",t.falling.type.toUpperCase()),{color:Eo.getColor(t.setoptions.minoskin[t.kickset.colorMap[t.falling.type]]||t.setoptions.minoskin.other,t.kickset.colorMap[t.falling.type])})})),t.stats.tspins++);let i=0,r=0;switch(a){case 0:"mini"===n?(i=No.scoring.TSPIN_MINI,r=No.garbage.TSPIN_MINI,t.stats.clears.minitspins++):"normal"===n&&(i=No.scoring.TSPIN,r=No.garbage.TSPIN,t.stats.clears.realtspins++);break;case 1:"mini"===n?(i=No.scoring.TSPIN_MINI_SINGLE,r=No.garbage.TSPIN_MINI_SINGLE,t.stats.clears.minitspinsingles++):"normal"===n?(i=No.scoring.TSPIN_SINGLE,r=No.garbage.TSPIN_SINGLE,t.stats.clears.tspinsingles++):(i=No.scoring.SINGLE,r=No.garbage.SINGLE,t.stats.clears.singles++);break;case 2:"mini"===n?(i=No.scoring.TSPIN_MINI_DOUBLE,r=No.garbage.TSPIN_MINI_DOUBLE,t.stats.clears.minitspindoubles++):"normal"===n?(i=No.scoring.TSPIN_DOUBLE,r=No.garbage.TSPIN_DOUBLE,t.stats.clears.tspindoubles++):(i=No.scoring.DOUBLE,r=No.garbage.DOUBLE,t.stats.clears.doubles++);break;case 3:n?(i=No.scoring.TSPIN_TRIPLE,r=No.garbage.TSPIN_TRIPLE,t.stats.clears.tspintriples++):(i=No.scoring.TRIPLE,r=No.garbage.TRIPLE,t.stats.clears.triples++);break;case 4:n?(i=No.scoring.TSPIN_QUAD,r=No.garbage.TSPIN_QUAD,t.stats.clears.tspinquads++):(i=No.scoring.QUAD,r=No.garbage.QUAD,t.stats.clears.quads++)}if(a&&t.stats.btb>1)if(i*=No.scoring.BACKTOBACK_MULTIPLIER,t.setoptions.b2bchaining){const s=No.garbage.BACKTOBACK_BONUS*(Math.floor(1+Math.log1p((t.stats.btb-1)*No.garbage.BACKTOBACK_BONUS_LOG))+(t.stats.btb-1==1?0:(1+Math.log1p((t.stats.btb-1)*No.garbage.BACKTOBACK_BONUS_LOG)%1)/3));if(r+=s,Math.floor(s)>=2&&e.fim.AddFire(20*Math.floor(s-1)-10),e.c.OnClient((()=>{Math.floor(s)>t.currentbtbchainpower&&Math.floor(s)>=2?e.hm.H.board.el("b2b").update("up_large",t.stats.btb-1):e.hm.H.board.el("b2b").update("up",t.stats.btb-1)})),Math.floor(s)>t.currentbtbchainpower&&(t.currentbtbchainpower=Math.floor(s),e.c.OnClient((()=>{2===t.currentbtbchainpower?e.sxm.PlayIngame("btb_1",1):3===t.currentbtbchainpower?e.sxm.PlayIngame("btb_2",1.25):t.currentbtbchainpower>=4&&e.sxm.PlayIngame("btb_3",1.5)}))),!e.c.IsServer()&&t.currentbtbchainpower>=3&&"full"===e.hm.H.displaymode){const t=ao(e.hm.H.stackobj,0,0);xn.play("b2b_flair",{x:t.x,y:t.y,w:e.W()*e.hm.S(),h:e.H()*e.hm.S()})}}else r+=No.garbage.BACKTOBACK_BONUS;else a&&t.stats.btb<=1&&(t.currentbtbchainpower=0);t.stats.combo>1&&(i+=No.scoring.COMBO*(t.stats.combo-1),r*=1+No.garbage.COMBO_BONUS*(t.stats.combo-1)),t.stats.combo>2&&(r=Math.max(Math.log1p(No.garbage.COMBO_MINIFIER*(t.stats.combo-1)*No.garbage.COMBO_MINIFIER_LOG),r)),i*=t.stats.level,t.stats.score+=i,t.setoptions.zenlevels&&(t.stats.zenprogress+=e.znm.ScoreToZenProgress(i,t.stats.zenlevel));const l=Math.floor(r*t.setoptions.garbagemultiplier);t.stats.combo>2&&(t.stats.currentcombopower=Math.max(t.stats.currentcombopower,l)),a&&t.stats.combo>1&&e.sxm.PlayIngame(`combo_${Math.min(16,t.stats.combo-1)}${t.stats.currentcombopower>=7?"_power":""}`,t.stats.currentcombopower>=7?l>=7?2.2:1.75:1),a&&t.stats.combo>1&&t.stats.currentcombopower>=7&&e.fim.AddFire(5),a?e.atm.FightLines(l):e.atm.TakeAllDamage()}function o(){e.bm.BoardIsEmpty()&&(e.c.OnClient((()=>{e.sxm.PlayIngame("allclear",1,!0),"full"===e.hm.H.displaymode&&0!==e.lm.H.soundSkipRate&&("minimal"!==te.video.graphics&&"off"!==te.video.actiontext&&"some"!==te.video.actiontext&&e.hm.H.board.fx("allclear").create(Ao.extra.clear),xn.play("bgcircle"))})),t.stats.score+=No.scoring.ALL_CLEAR*t.stats.level,t.setoptions.zenlevels&&(t.stats.zenprogress+=e.znm.ScoreToZenProgress(No.scoring.ALL_CLEAR*t.stats.level,t.stats.zenlevel)),t.stats.clears.allclear++,e.atm.FightLines(Math.floor(No.garbage.ALL_CLEAR*t.setoptions.garbagemultiplier)))}return{ClearLines:function(){let s=[];for(let a=0;a<e.T();a++)t.board[a].every((e=>null!==e&&"gbd"!==e))&&s.push(a);t.lastoffensive.x=t.falling.x,t.lastoffensive.y=s.length?s[Math.round((s.length-1)/2)]:t.falling.y,t.lastoffensive.offence=0,t.lastoffensive.defense=0;let i=e.rbm.IsTSpin(s.length);return"t"===t.falling.type&&"stupid"!==t.setoptions.spinbonuses||(i=t.falling.spintype),a(s),s.length&&e.bm.RemoveLinesFromStack(s),n(s.length,i),o(),e.atm.AnnounceOffensive(),s.length},LevelLines:s,AnnounceDownstack:a,AnnounceLines:n,AnnounceClear:o}},oi=function(e){"use strict";const t=e.gsm,s={playbackSpeed:1,soundSkipRate:1,stopgame:!1,stopdraw:!1,lastdT:1,lastdTs:[],diter:0,cheekystep:Math.floor(60+60*Math.random())};let a=0,n=!0,o=0,i=null,r=1/60;let l=0;function c(){if(e.iom.scoped&&!e.iom.source.finished()&&e.iom.source.nextFrameReady()&&!(t.setoptions.onframe||(()=>{}))(e.iom.source.getFrame(),0===s.soundSkipRate)){if(t.subframe=0,e.iom.source.pull(),e.iom.source.advanceFrame(),e.im.ProcessShift(!1,1-t.subframe),e.fm.FallEvent(void 0,1-t.subframe),(e.c.IsServer(!0)||"keyboard"===e.iom.source.type())&&e.im.ProcessInterrupts(),e.wfm.ExecuteWaitingFrames(),e.wfm.ExecuteUnsafeWaitingFrames(),e.rbm.CheckObjectiveCleared(),e.spm.LowerSpikeClock(),t.setoptions.display_fire&&e.fim.LowerFire(),t.setoptions.gincrease&&e.iom.source.getFrame()>(t.setoptions.gmargin||0)&&(t.g+=t.setoptions.gincrease/60),t.setoptions.garbageincrease&&e.iom.source.getFrame()>(t.setoptions.garbagemargin||0)&&(t.setoptions.garbagemultiplier+=t.setoptions.garbageincrease/60),t.setoptions.garbagecapincrease&&(t.setoptions.garbagecap+=t.setoptions.garbagecapincrease/60),!t.setoptions.noreplay){e.iom.replay.advanceFrame();const s=e.iom.replay.getFrame()-(t.setoptions.fulloffset||300);0!==s&&s%(t.setoptions.fullinterval||300)!=0||e.iom.replay.pushEvent("full",e.siom.Export())}if(e.znm.UpdateFromZenConfig(),e.iom.source.fallingBehind()&&++l<=1200){const t=e.iom.source.amountToCatchUp();s.soundSkipRate=Math.max(0,s.soundSkipRate/1.25),s.soundSkipRate<=1e-6&&(s.soundSkipRate=0),c(),s.soundSkipRate=1,!e.c.IsServer()&&"tiny"!==e.hm.H.displaymode&&t>90&&ta("loss")}if(e.iom.source.behindness()>=1.25){const t=Math.max(Math.floor(8-(e.iom.source.behindness()-1.25)),0)+2;e.iom.source.getFrame()%t==0&&c()}l=0}}function d(s){e.c.IsServer()||(e.hm.H.stackdirty&&(so(e.hm.H.stackobj),e.sdm.DrawStack(),e.hm.H.stackdirty=!1,e.hm.H.stackmud=[],"full"===e.hm.H.displaymode&&(Zn=!0)),e.hm.H.stackmud.length&&(e.sdm.DrawStackMud(),e.hm.H.stackmud=[],"full"===e.hm.H.displaymode&&(Zn=!0)),"minimal"===te.video.graphics||!1===te.video.siren||t.setoptions.nosiren||e.pm.WarningSiren(s),e.hm.H.fallingdirty&&"tiny"!==e.hm.H.displaymode&&(so(e.hm.H.fallingobj),e.sdm.DrawFalling(),e.hm.H.fallingdirty=!1,"full"===e.hm.H.displaymode&&(Zn=!0)),"tiny"!==e.hm.H.displaymode&&e.sdm.DrawFallingOpacity(),"tiny"!==e.hm.H.displaymode&&e.dsm.UpdateCounts(!1),"minimal"===te.video.graphics||!1===te.video.siren||t.setoptions.nosiren||e.pm.HyperTopoutWarningExtremePlus(s),e.pm.TargetedWarning(),e.hm.PullHolder(!1,s),t.setoptions.display_fire&&e.fim.PullFire(s),e.hm.H.nextdirty&&"tiny"!==e.hm.H.displaymode&&(e.sdm.DrawNext(),e.hm.H.nextdirty=!1,"full"===e.hm.H.displaymode&&(Zn=!0)),e.hm.H.holddirty&&"tiny"!==e.hm.H.displaymode&&(e.sdm.DrawHold(),e.hm.H.holddirty=!1,"full"===e.hm.H.displaymode&&(Zn=!0)),!e.stm.H.stockExploding||"full"!==e.hm.H.displaymode||"high"!==te.video.graphics&&"ultra"!==te.video.graphics||t.setoptions.infinitestock||e.stm.ExplodingStock(s),"tiny"!==e.hm.H.displaymode&&e.hm.H.board.progress(s))}return{H:s,GameLoop:function l(){if(e.c.IsServer(!0))return;if(s.stopgame)return s.stopgame=!1,void PIXI.Ticker.shared.remove(l);if(e.c.IsServer())return;if(!t.started)return;null===i&&(i=performance.now());const d=performance.now();o+=Math.min(5,(d-i)/1e3);let p=-2;for(;o>=r;){for(o-=r,p++,a+=s.playbackSpeed;a>=1;)a--,c();n&&(n=!1,o=0)}Nt.addGameM(Math.max(0,p)),Nt.addGameF(performance.now()-d),i=d},DoFrame:function(){e.c.IsServer()&&c()},DrawLoop:function t(a){if(!e.c.IsServer(!0))return s.stopdraw?(s.stopdraw=!1,void PIXI.Ticker.shared.remove(t)):void(e.c.IsServer()||("tiny"===e.hm.H.displaymode?Math.round(e.hm.H.holderstate.ox*("minimal"!==te.video.graphics?100:1))==Math.round(e.hm.H.holderstate.cox*("minimal"!==te.video.graphics?100:1))&&Math.round(e.hm.H.holderstate.oy*("minimal"!==te.video.graphics?100:1))==Math.round(e.hm.H.holderstate.coy*("minimal"!==te.video.graphics?100:1))&&Math.round(100*e.hm.H.holderstate.os)==Math.round(100*e.hm.H.holderstate.cos)?(s.diter+=a,s.diter>=s.cheekystep?(s.diter-=s.cheekystep,"low"!==te.video.caching&&(e.hm.H.holder.cacheAsBitmap=!1),d(),"low"!==te.video.caching&&(e.hm.H.holder.cacheAsBitmap=!0)):e.hm.H.holderneedsrepull&&e.hm.PullHolder(a)):e.hm.PullHolder(a):d(a)))},AdvanceFrames:function(a,n){n&&(s.soundSkipRate=0);for(let e=0;e<a;e++)c();n&&(s.soundSkipRate=1,e.hm.H.holderstate.x=0,e.hm.H.holderstate.y=0,e.hm.H.holderstate.r=0,e.hm.H.holderstate.s=0,e.hm.H.holderstate.w=0,e.hm.H.holderstate.dx=0,e.hm.H.holderstate.dy=0,e.hm.H.holderstate.dr=0,e.hm.H.holderstate.ds=0,e.hm.H.holderstate.dw=0,(t.setoptions.onframe||(()=>{}))(e.iom.source.getFrame(),!1))},Update:c,Render:d}},ii=function(e){"use strict";e.gsm;let t=0,s=1/0;return{SetPlacement:function(a){e.gsm.placement=a,e.c.IsServer()||(t=Math.max(t,a),"minimal"!==te.video.graphics&&"off"!==te.video.actiontext&&"some"!==te.video.actiontext&&(t>=150&&s>100&&a<=100&&e.hm.H.board.fx("timeleft").create("100 \fc3PLAYERS LEFT"),t>=60&&s>30&&a<=30&&e.hm.H.board.fx("timeleft").create("30 \fc3PLAYERS LEFT"),t>=30&&s>10&&a<=10&&e.hm.H.board.fx("timeleft").create("10 \fc3PLAYERS LEFT")),s=Math.min(s,a))}}},ri=function(e){"use strict";const t=e.gsm;let s=null;return{CreateOverText:function(e){if(!t.setoptions.display_username)return;s&&(s.bg.destroy(),s.fg.destroy());const a=new PIXI.Graphics;a.beginFill(0,.75),a.drawRect(0,0,Ls(10*fo.x+4),Ls(26)),a.endFill(),a.position.set(e.data.global.x-Ls(5*fo.x+2),e.data.global.y+32),Tn.addChild(a);const n=new TheoryType.Text(t.setoptions.username.toUpperCase(),{font:Bn.get("hun"),rasterize:"minimal"===te.video.graphics,fontSize:Ls(19),weight:600,tint:14540253,anchor:[.5,0]});n.position.set(e.data.global.x,e.data.global.y+32+Ls(5)),Tn.addChild(n),go.animate(a,{0:{alpha:0,"pivot.y":32},.1:{alpha:1,"pivot.y":0},.75:{alpha:1,"pivot.y":0},1:{alpha:0,"pivot.y":0}},5,BezierEasing(0,.34,.86,.46)),go.animate(n,{0:{alpha:0,"pivot.y":32},.1:{alpha:1,"pivot.y":0},.75:{alpha:1,"pivot.y":0},1:{alpha:0,"pivot.y":0}},5,BezierEasing(0,.34,.86,.46),(()=>{s.bg.destroy(),s.fg.destroy(),s=null})),s={bg:a,fg:n}},MoveOverText:function(e){s&&(s.bg.position.set(e.data.global.x-Ls(5*fo.x+2),e.data.global.y+32),s.fg.position.set(e.data.global.x,e.data.global.y+32+Ls(5)))},EndOverText:function(){s&&(s.bg.destroy(),s.fg.destroy(),s=null)}}},li=function(e){"use strict";const t=e.gsm,s={siren:!0,sireniter:0,panicking:!1,alerting:!1,targeted:!1};let a=!1,n=null,o=0;return{H:s,WarningSiren:function(a){if(e.c.IsServer())return;if(t.destroyed)return;if(!s.siren)return;let n=e.bm.HighestLine(),o=0;if(t.impendingdamage.forEach((e=>{o+=e.lines})),n=Math.max(0,n-Math.min(Math.floor(Math.min(t.setoptions.garbagecapmax||40,t.setoptions.garbagecap)),o)),(n>e.B()-1||!o)&&s.alerting&&(e.hm.H.board.el("garbagedangericon").delete(),s.alerting=!1),n>e.B()+2)return void(s.panicking&&(e.hm.H.holderstate.tr=255,e.hm.H.holderstate.tg=255,e.hm.H.holderstate.tb=255,e.hm.H.holderstate.fgtr=0,e.hm.H.holderstate.fgtg=0,e.hm.H.holderstate.fgtb=0,s.panicking=!1,e.hm.H.board.el("skyline").delete(),e.iom.source&&"keyboard"===e.iom.source.type()&&(Dn.opacity(1),Dn.scale(1))));if(s.panicking||(e.hm.H.holderstate.tr=255,e.hm.H.holderstate.tg=51,e.hm.H.holderstate.tb=0,e.hm.H.holderstate.fgtr=255,e.hm.H.holderstate.fgtg=255,e.hm.H.holderstate.fgtb=255,s.panicking=!0,e.hm.H.board.el("skyline").create(),e.iom.source&&"keyboard"===e.iom.source.type()&&(Dn.opacity(.5),Dn.scale(1.01))),"full"!==e.hm.H.displaymode||0===e.lm.H.soundSkipRate)return;if(!s.alerting&&n<=e.B()-1&&o&&(e.hm.H.board.el("garbagedangericon").create(),s.alerting=!0,e.sxm.PlayIngame("damage_alert",1,!1,.33)),e.hm.H.board.el("skyline").update(),s.sireniter+=a,0===Math.floor(s.sireniter/Math.max(50,100-15*(e.B()+2-n))))return;s.sireniter-=Math.max(50,100-15*(e.B()+2-n)),e.sxm.PlayIngame("warning",1,!1,.33);const i=ao(e.hm.H.stackobj,Ls(fo.x)*e.Wh(),Ls(fo.x)*e.Hh());xn.play("danger_flair",{x:i.x,y:i.y,w:e.W()*e.hm.S(),h:e.H()*e.hm.S()}),xn.play("bgsplashdanger",{direction:0,amt:e.B()+6-n})},HyperTopoutWarningExtremePlus:function(i){if(!t.falling.deep_sleep&&"full"===e.hm.H.displaymode&&s.panicking){if(o+=i,o<1)return;if(o--,e.bm.PieceMayLockHere(t.falling.type,t.falling.x,e.sdm.H.lastLegal,t.falling.r))a&&(e.iom.source&&"keyboard"===e.iom.source.type()&&(Dn.opacity(s.panicking?.5:1),Dn.scale(s.panicking?1.01:1)),a=!1,n&&Os.stop(n));else{const t=ao(e.hm.H.stackobj,0,0);xn.play("danger_smoke",{x:t.x,y:t.y,w:e.W()*e.hm.S(),h:e.H()*e.hm.S()}),a||(e.iom.source&&"keyboard"===e.iom.source.type()&&(Dn.opacity(.25),Dn.scale(1.03)),a=!0,n=e.sxm.PlayIngame("hyperalert",1,!1,.33))}}},TargetedWarning:function(){e.c.IsServer()||(s.targeted?e.hm.H.board.el("targeticon").create():e.hm.H.board.el("targeticon").delete())}}},ci=function(e){"use strict";const t=e.gsm,s={leftBarCount:0,rightBarCount:0,seenGarbageIDs:new Set};function a(a){for(let n=1;n<=2;n++)if(t.setoptions[`slot_bar${n}`]===a){let a=new Set;t.impendingdamage.forEach((t=>{e.hm.H.board.el(`bar${n}`).update("upsert",{id:t.id,size:t.lines/e.H(),style:`${t.type}${t.active?"":"_inactive"}`}),s.seenGarbageIDs.delete(t.id),a.add(t.id)})),s.seenGarbageIDs.forEach((t=>{e.hm.H.board.el(`bar${n}`).update("upsert",{id:t,size:0})})),s.seenGarbageIDs=a}}function n(s,a){for(let n=1;n<=2;n++)t.setoptions[`slot_bar${n}`]===s&&e.hm.H.board.el(`bar${n}`).action("flash",a/e.H())}return{H:s,UpdateBar:function(s,a){for(let n=1;n<=2;n++)t.setoptions[`slot_bar${n}`]===s&&e.hm.H.board.el(`bar${n}`).update("simple",a)},UpdateBarTicker:function(s,a){for(let n=1;n<=2;n++)t.setoptions[`slot_bar${n}`]===s&&e.hm.H.board.el(`bar${n}`).update("ticker",a)},BlastBar:function(t){n(t,e.H())},UpdateGarbageBar:a,ResetGarbageBar:function(s){for(let a=1;a<=2;a++)t.setoptions[`slot_bar${a}`]===s&&e.hm.H.board.el(`bar${a}`).update("clear");a(s)},FlashGarbageBar:n,ForceUpdateGarbageBar:function(s){for(let a=1;a<=2;a++)t.setoptions[`slot_bar${a}`]===s&&e.hm.H.board.el(`bar${a}`).action("forceupdate")}}},di=function(e){"use strict";const t=e.gsm;function s(){return!t.setoptions.map&&e.bm.CheckStackAgainstMap("#*********_##########_##########_##########_##########_##########_##########_##########_##########_##########_########_########_########_########_########_########_########_########_########_#########")}return{IsTSpin:function(){if("none"===t.setoptions.spinbonuses)return!1;if("stupid"===t.setoptions.spinbonuses)return!e.bm.IsLegalAtPos(t.falling.type,t.falling.x,t.falling.y+1,t.falling.r)&&"normal";if("t"!==t.falling.type)return"all"===t.setoptions.spinbonuses&&(!(e.bm.IsLegalAtPos(t.falling.type,t.falling.x-1,t.falling.y,t.falling.r)||e.bm.IsLegalAtPos(t.falling.type,t.falling.x+1,t.falling.y,t.falling.r)||e.bm.IsLegalAtPos(t.falling.type,t.falling.x,t.falling.y-1,t.falling.r)||e.bm.IsLegalAtPos(t.falling.type,t.falling.x,t.falling.y+1,t.falling.r))&&"normal");if("rotate"!==t.falling.last)return!1;let s=0,a=0;if(e.bm.IsOccupied(t.falling.x-1,t.falling.y-1)&&(s++,3!==t.falling.r&&0!==t.falling.r||a++),e.bm.IsOccupied(t.falling.x+1,t.falling.y-1)&&(s++,0!==t.falling.r&&1!==t.falling.r||a++),e.bm.IsOccupied(t.falling.x+1,t.falling.y+1)&&(s++,1!==t.falling.r&&2!==t.falling.r||a++),e.bm.IsOccupied(t.falling.x-1,t.falling.y+1)&&(s++,2!==t.falling.r&&3!==t.falling.r||a++),s<3)return!1;let n="normal";return 2!==a&&(n="mini"),4===t.falling.lastkick&&(n="normal"),n},CheckObjectiveCleared:function(){if(t.playing&&t.setoptions.objective)switch(t.setoptions.objective.type){case"lines":return void(t.stats.lines>=t.setoptions.objective.count&&(t.successful=!0,e.gom.GameOver("clear"),e.c.IsServer()||e.pbm.BlastBar("progress")));case"timed":let s=e.iom.source.getFrame()*(1e3/60);const a=Math.ceil(Math.max(0,t.setoptions.objective.time-s)/1e3);return e.c.IsServer()||a===t.stats.time.prev||t.stats.time.locked||("minimal"!==te.video.graphics&&"off"!==te.video.actiontext&&"some"!==te.video.actiontext&&(60===a&&e.hm.H.board.fx("timeleft").create("60\f3S LEFT"),30===a&&e.hm.H.board.fx("timeleft").create("30\f3S LEFT")),a>3&&a<=10?(t.setoptions.physical&&e.sxm.PlayIngame("timer1"),"minimal"!==te.video.graphics&&"off"!==te.video.actiontext&&"some"!==te.video.actiontext&&e.hm.H.board.fx("countdown").create(a)):a<=3&&a>0&&(t.setoptions.physical&&e.sxm.PlayIngame("timer2"),"minimal"!==te.video.graphics&&"off"!==te.video.actiontext&&"some"!==te.video.actiontext&&e.hm.H.board.fx("countdown").create(a))),t.stats.time.prev=a,void(s>=t.setoptions.objective.time&&(t.successful=!0,e.gom.GameOver("clear")))}},CheckSecretGrade:s,AwardSecrets:function(){"keyboard"===e.iom.source.type()&&s()&&(Os.play("allclear"),x({msg:"you did a thing!",color:"#FFAE00",icon:"achievement"}),w.post("/api/users/award",{type:"secretgrade"}))}}},pi=function(e){"use strict";const t=e.gsm;return{PlayIngame:function(s,a=1,n=!1,o=1,i=!1){if(!e.c.IsServer())return Os.playIngame(s,e.hm.H.displaymode,e.hm.H.holderstate.cox,e.hm.H.holderstate.cos*a*(t.setoptions.physical?1:o),n,t.setoptions.physical||i,e.lm.H.soundSkipRate)}}},ui=function(e){"use strict";e.gsm;const t={spikeCount:0,spikeTimer:0};return{H:t,LowerSpikeClock:function(){0!==t.spikeTimer&&(t.spikeTimer--,0===t.spikeTimer&&(t.spikeCount=0))}}},mi=function(e){"use strict";const t=e.gsm;return{GlobalShout:function(s,a,n){if(e.c.IsServer())return;if("full"!==e.hm.H.displaymode)return;if(!t.setoptions.physical&&!n)return;const o=document.createElement("div");o.className=`ns shout ${s}`,o.textContent=a,document.getElementsByClassName("globalshouts")[0].appendChild(o),setTimeout((()=>{o.remove()}),5e3),"ultra"===te.video.graphics&&Gn&&No.globalShoutStyles[s]&&No.globalShoutStyles[s]()}}},gi=function(e){"use strict";const t=e.gsm,s={lastLegal:e.T()-5};function a(...t){return"tiny"===e.hm.H.displaymode?Eo.generatePlaceholder(...t):Eo.generate(...t)}function n(...t){return"tiny"===e.hm.H.displaymode?To.generatePlaceholder(...t):To.generate(...t)}function o(s,o,i,r,l,c=!1,d=!1,p=!1){if(!e.c.IsServer())for(let u=0;u<No.tetrominoes[o].matrix.data[l].length;u++){const m=No.tetrominoes[o].matrix.data[l][u][0]-No.tetrominoes[o].matrix.dx,g=No.tetrominoes[o].matrix.data[l][u][1]-No.tetrominoes[o].matrix.dy;let h;h=c?n(t.setoptions.ghostskin,d?"x":"g",No.tetrominoes[o].matrix.data[l][u][2]):a(t.setoptions.minoskin[t.kickset.colorMap[o]]||t.setoptions.minoskin.other,`${p?"s_":""}${t.kickset.colorMap[o]}`,No.tetrominoes[o].matrix.data[l][u][2]),h.position.set((i+m)*Ls(fo.x),(Math.ceil(r)+g-e.B())*Ls(fo.x)),c&&!d&&(h.alpha=void 0===te.video.shadowopacity?.15:te.video.shadowopacity,te.video.colorshadow&&(h.tint=Eo.getColor(t.setoptions.minoskin[t.kickset.colorMap[o]]||t.setoptions.minoskin.other,t.kickset.colorMap[o]))),s.addChild(h)}}function i(s,n,o,i,r=!1){if(e.c.IsServer())return;let l=No.tetrominoes[n].preview.data;t.kickset.preview_overrides[n]&&(l=t.kickset.preview_overrides[n]);for(let e=0;e<l.length;e++){const c=l[e][0],d=l[e][1],p=a(t.setoptions.minoskin[t.kickset.colorMap[n]]||t.setoptions.minoskin.other,r?"d":t.kickset.colorMap[n],l[e][2]);p.position.set(o+c*Ls(fo.x)-("ultra"===te.video.graphics?1:0),i+d*Ls(fo.x)-("ultra"===te.video.graphics?1:0)),s.addChild(p)}}return{H:s,DrawStack:function(){if(!e.c.IsServer())for(let s="tiny"===e.hm.H.displaymode?e.B():0;s<e.T();s++)for(let n=0;n<e.W();n++){const o=t.board[s][n];if(null!==o){const i=a(t.setoptions.minoskin[t.kickset.colorMap[o]]||t.setoptions.minoskin.other,t.kickset.colorMap[o],t.boardedges[s][n]);i.position.set(n*Ls(fo.x),(s-e.B())*Ls(fo.x)),e.hm.H.stackobj.addChild(i)}}},DrawStackMud:function(){e.c.IsServer()||e.hm.H.stackmud.forEach((s=>{if(null!==s&&!(s[0]<("tiny"===e.hm.H.displaymode?e.B():0))&&null!==s[2]){const n=a(t.setoptions.minoskin[t.kickset.colorMap[s[2]]]||t.setoptions.minoskin.other,t.kickset.colorMap[s[2]],s[3]);if(n.position.set(s[1]*Ls(fo.x),(s[0]-e.B())*Ls(fo.x)),e.hm.H.stackobj.addChild(n),"full"===e.hm.H.displaymode&&!["minimal","low"].includes(te.video.graphics)){const e=Eo.generateFlash(t.setoptions.minoskin[t.kickset.colorMap[s[2]]]||t.setoptions.minoskin.other);e&&n.addChild(e)}}}))},DrawFalling:function(){if(e.c.IsServer())return;if(t.falling.sleep||t.falling.deep_sleep)return;let a=t.falling.y;for(;;){if(!e.bm.IsLegalAtPos(t.falling.type,t.falling.x,a+1,t.falling.r)){!1!==t.setoptions.display_shadow&&o(e.hm.H.fallingobj,t.falling.type,t.falling.x,a,t.falling.r,!0);break}a++}s.lastLegal=a,o(e.hm.H.fallingobj,t.falling.type,t.falling.x,t.falling.y,t.falling.r,!1,!1,!0),"full"===e.hm.H.displaymode&&!1!==t.setoptions.display_next&&e.pm.H.panicking&&o(e.hm.H.fallingobj,t.bag[0],Math.floor(e.W()/2)-1+t.kickset.additional_offsets[t.bag[0]][t.kickset.spawn_rotation[t.bag[0]]][0],e.B()-2.04+t.kickset.additional_offsets[t.bag[0]][t.kickset.spawn_rotation[t.bag[0]]][1],t.kickset.spawn_rotation[t.bag[0]],!0,!0)},DrawFallingOpacity:function(){if(e.c.IsServer())return;const s=e.hm.H.fallingobj.alpha;t.falling.sleep||t.falling.deep_sleep?e.hm.H.fallingobj.alpha=1:(e.hm.H.fallingobj.alpha=1-t.falling.locking/(t.setoptions.locktime||30)/2,s!==e.hm.H.fallingobj.alpha&&"full"===e.hm.H.displaymode&&(Zn=!0))},DrawNext:function(){if(!e.c.IsServer())for(let s=0;s<t.setoptions.nextcount;s++){if(!t.bag[s])return;if(!e.hm.H.nextobj||!e.hm.H.nextobj[s])return;so(e.hm.H.nextobj[s]);const a=No.tetrominoes[t.bag[s]];i(e.hm.H.nextobj[s],t.bag[s],a.preview.w*Ls(fo.x)/-2,a.preview.h*Ls(fo.x)/-2,!1)}},DrawHold:function(){if(e.c.IsServer())return;if(!e.hm.H.holdobj)return;if(so(e.hm.H.holdobj),null===t.hold)return;const s=No.tetrominoes[t.hold];i(e.hm.H.holdobj,t.hold,s.preview.w*Ls(fo.x)/-2,s.preview.h*Ls(fo.x)/-2,t.holdlocked)},RenderTetromino:o,RenderTetrominoPreview:i}},hi=function(t){"use strict";const s=t.gsm;return{SetGame:function(a){if(s.setoptions=a,s.setoptions.version||(s.setoptions.version=wi),s.setoptions.version<wi&&!t.c.IsServer()&&x({msg:"this replay is outdated and may not play properly",color:"#FFD800",icon:"warning",timeout:7500}),function(){const e=s.setoptions.slot_counter1,t=s.setoptions.slot_counter2,a=s.setoptions.slot_counter3,n=s.setoptions.slot_counter4,o=s.setoptions.slot_counter5;s.setoptions.display_score&&(s.setoptions.slot_counter5="score");s.setoptions.display_stopwatch&&(s.setoptions.slot_counter1="stopwatch");s.setoptions.display_timer&&(s.setoptions.slot_counter1="timer");s.setoptions.display_lines&&(s.setoptions.slot_counter2="lines");s.setoptions.display_level&&(s.setoptions.slot_counter3="level");s.setoptions.display_pieces&&(s.setoptions.slot_counter3="pieces");s.setoptions.display_keys&&(s.setoptions.slot_counter4="keys");s.setoptions.display_finesse&&(s.setoptions.slot_counter5="finesse");s.setoptions.display_finesse_l&&(s.setoptions.slot_counter4="finesse_l");s.setoptions.display_attack&&(s.setoptions.slot_counter2="attack");s.setoptions.display_vs&&(s.setoptions.slot_counter5="vs");s.setoptions.display_placement&&(s.setoptions.slot_counter5="placement");s.setoptions.display_kills&&(s.setoptions.slot_counter1="kills");e&&(s.setoptions.slot_counter1=e);t&&(s.setoptions.slot_counter2=t);a&&(s.setoptions.slot_counter3=a);n&&(s.setoptions.slot_counter4=n);o&&(s.setoptions.slot_counter5=o);const i=s.setoptions.slot_bar1,r=s.setoptions.slot_bar2;s.setoptions.display_impending&&(s.setoptions.slot_bar1="impending");s.setoptions.display_progress&&(s.setoptions.slot_bar2="progress");i&&(s.setoptions.slot_bar1=i);r&&(s.setoptions.slot_bar2=r)}(),s.setoptions.seed_random&&(s.setoptions.seed=Math.floor(2147483646*Math.random()+1)),s.stats.seed=s.setoptions.seed,s.rng=new En(s.setoptions.seed||0),s.g=s.setoptions.g||0,s.setoptions.garbagespeed=s.setoptions.garbagespeed||20,s.setoptions.garbagecap=s.setoptions.garbagecap||8,s.stock=Math.min(10,Math.max(0,s.setoptions.stock||0)),s.setoptions.kickset=s.setoptions.kickset||"SRS+",s.kickset=No.kicksets[s.setoptions.kickset]||No.kicksets["SRS+"],s.setoptions.score&&(s.stats.score=s.setoptions.score),s.setoptions.zenlevels&&(s.stats.zenlevel=s.setoptions.zenlevel,s.stats.zenprogress=s.setoptions.zenprogress),s.setoptions.boardwidth=parseInt(s.setoptions.boardwidth)?Math.max(4,Math.min(100,parseInt(s.setoptions.boardwidth))):10,s.setoptions.boardheight=parseInt(s.setoptions.boardheight)?Math.max(1,Math.min(100,parseInt(s.setoptions.boardheight))):20,s.setoptions.boardbuffer=isNaN(parseInt(s.setoptions.boardbuffer))?20:Math.max(0,Math.min(100,parseInt(s.setoptions.boardbuffer))),t.bm.SetupBoard(),s.setoptions.map&&t.bm.LoadMap(s.setoptions.map),s.setoptions.handling?s.handling={arr:Math.floor(10*Math.max(0,Math.min(s.setoptions.handling.arr,5)))/10,das:Math.floor(10*Math.max(1,Math.min(s.setoptions.handling.das,20)))/10,dcd:Math.floor(10*Math.max(0,Math.min(s.setoptions.handling.dcd||0,20)))/10,sdf:Math.floor(Math.max(5,Math.min(s.setoptions.handling.sdf,41))),safelock:s.setoptions.version>=12&&!1!==s.setoptions.handling.safelock,cancel:!!s.setoptions.handling.cancel}:s.handling={arr:Math.floor(10*Math.max(0,Math.min(te.handling.arr,5)))/10,das:Math.floor(10*Math.max(1,Math.min(te.handling.das,20)))/10,dcd:Math.floor(10*Math.max(0,Math.min(te.handling.dcd||0,20)))/10,sdf:Math.floor(Math.max(5,Math.min(te.handling.sdf,41))),safelock:!1!==te.handling.safelock,cancel:!!te.handling.cancel},s.setoptions.room_handling&&(s.handling.arr=Math.floor(10*Math.max(0,Math.min(s.setoptions.room_handling_arr,5)))/10,s.handling.das=Math.floor(10*Math.max(1,Math.min(s.setoptions.room_handling_das,20)))/10,s.handling.sdf=Math.floor(Math.max(5,Math.min(s.setoptions.room_handling_sdf,41)))),void 0===s.setoptions.objective&&(s.setoptions.objective={type:"none"}),s.setoptions.levels?t.lcm.LevelLines(0,!0,s.setoptions.startinglevel||1):s.stats.level=s.setoptions.startinglevel||1,void 0===s.setoptions.physical&&(s.setoptions.physical=!0),s.setoptions.can_retry&&"keyboard"===t.iom.source.type()&&(t.iom.source.bindHyperRetry((()=>{s.hyperRetryAllowed&&!s.setoptions.retryisclear&&(s.hyperRetryAllowed=!1,t.gom.GameOver("retry",!0),Os.play("detonate2"))})),setTimeout((()=>{t.iom.source.bindHyperForfeit((()=>{s.hyperForfeitAllowed&&(s.hyperForfeitAllowed=!1,t.gom.GameOver("forfeit",!0),Os.play("detonate2"))}))}),1e3)),s.setoptions.nextcount?s.setoptions.nextcount=Math.min(5,Math.max(1,Math.floor(parseInt(s.setoptions.nextcount)))):s.setoptions.nextcount=5,s.setoptions.minoskin||(s.setoptions.minoskin={z:"tetrio",l:"tetrio",o:"tetrio",s:"tetrio",i:"tetrio",j:"tetrio",t:"tetrio",other:"tetrio"}),s.setoptions.ghostskin||(s.setoptions.ghostskin="tetrio"),s.setoptions.boardskin||(s.setoptions.boardskin="generic"),t.bam.PopulateBag(),s.setoptions.no_szo&&s.bag.length)for(let e=0;e<s.bag.length&&["s","z","o"].includes(s.bag[0]);e++)s.bag.push(s.bag.shift());t.c.OnClient((()=>{ki.push(t.parent),s.setoptions.usezenconfig&&e("zen_panel").classList.remove("hidden"),Object.values(s.setoptions.minoskin).forEach((e=>{Eo.load(e)})),To.load(s.setoptions.ghostskin)})),t.iom.replay&&s.setoptions.latencypreference&&t.iom.replay.setLatencyPreference(s.setoptions.latencypreference)},StartGame:function(e=!1){e?t.c.OnClient((()=>{PIXI.Ticker.shared.add(t.lm.GameLoop),PIXI.Ticker.shared.add(t.lm.DrawLoop),t.dsm.DisplayCounts(),t.hm.H.holder.visible=!0,go.animate(t.hm.H.holder,{0:{"pivot.y":Ls(fo.x*t.H()+1600)},1:{"pivot.y":Ls(fo.x*t.Hh())}},.5,BezierEasing(.06,.18,.42,1.16))})):(t.c.OnClient((()=>{PIXI.Ticker.shared.add(t.lm.GameLoop),PIXI.Ticker.shared.add(t.lm.DrawLoop),t.dsm.DisplayCounts();let e=(s.setoptions.stride?s.setoptions.mission?500:0:s.setoptions.precountdown||0)+(s.setoptions.prestart||0),a=s.setoptions.prestart||0;if(s.setoptions.physical&&!s.setoptions.display_replay&&document.body.classList.add("ingame_phys"),s.setoptions.usezenconfig&&t.znm.UpdateFromZenConfig(!0),s.countdown_started=!0,setTimeout((()=>{s.playing&&(!s.setoptions.stride&&s.setoptions.mission&&(s.setoptions.physical||s.setoptions.force_mission)&&(t.ssm.GlobalShout(s.setoptions.mission_type||"mission",s.setoptions.mission,!0),s.setoptions.no_mission_sound||t.sxm.PlayIngame(s.setoptions.mission_type||"mission",1,!1,1,s.setoptions.force_mission)),t.hm.H.holder.visible=!0,"slow"===s.setoptions.zoominto?go.animate(t.hm.H.holder,{0:{"pivot.y":Ls(fo.x*t.H()+1600)},1:{"pivot.y":Ls(fo.x*t.Hh())}},.5,BezierEasing(.06,.18,.42,1.16)):"fast"===s.setoptions.zoominto?go.animate(t.hm.H.holder,{0:{"scale.x":0},1:{"scale.x":"inherit"}},s.setoptions.stride?.05:.25,BezierEasing(.06,.18,.45,.98)):"cinematic"===s.setoptions.zoominto?go.animate(t.hm.H.holder,{0:{alpha:.5,"scale.x":0,"scale.y":0,"pivot.x":Ls(fo.x*t.Wh()+(0===t.hm.H.holderstate.ox?0:t.hm.H.holderstate.ox>0?300:-300))},1:{alpha:1,"scale.x":"inherit","scale.y":"inherit","pivot.x":Ls(fo.x*t.Wh())}},6,BezierEasing(.47,.66,.54,.98)):"fade"===s.setoptions.zoominto&&go.animate(t.hm.H.holder,{0:{alpha:0},1:{alpha:1}},.5,BezierEasing(0,0,1,1)))}),a),s.setoptions.countdown){let n=s.setoptions.stride?1:s.setoptions.countdown_count||3,o=s.setoptions.stride?1e3:s.setoptions.countdown_interval||1e3,i=s.setoptions.stride?s.setoptions.mission?500:0:s.setoptions.precountdown||0;e+=n*o;for(let e=n;e>0;e--)setTimeout((()=>{if(s.playing){if(s.setoptions.stride)return t.hm.H.board.fx("countdown_stride").create("ready"),(s.setoptions.physical||s.setoptions.force_mission)&&t.sxm.PlayIngame("countdown5",1,!1,1,s.setoptions.force_mission),void setTimeout((()=>{t.hm.H.board.fx("countdown_stride").create("set"),(s.setoptions.physical||s.setoptions.force_mission)&&t.sxm.PlayIngame("countdown4",1,!1,1,s.setoptions.force_mission)}),500);t.hm.H.board.fx("countdown").create(e),(s.setoptions.physical||s.setoptions.force_mission)&&t.sxm.PlayIngame(`countdown${Math.min(e,5)}`,1,!1,1,s.setoptions.force_mission)}}),a+(n-e)*o+i)}setTimeout((()=>{s.playing&&(s.hyperRetryAllowed=!1,s.hyperForfeitAllowed=!1,s.setoptions.countdown&&(t.hm.H.board.fx(s.setoptions.stride?"countdown_stride":"countdown").create("GO!"),(s.setoptions.physical||s.setoptions.force_mission)&&t.sxm.PlayIngame("go",1,!1,1,s.setoptions.force_mission)),t.iom.source.readyEventQueue(),s.setoptions.anchorseed&&!t.c.IsServer()&&s.setoptions.physical&&Ut.anchorSeed(s.setoptions.seed),(s.setoptions.onstart||(()=>{}))(),s.started=!0,t.dsm.StartStopwatch(),t.fm.Next(),s.setoptions.noreplay||t.iom.replay.pushEvent("start",{}))}),e),t.iom.replay.pushEvent("full",t.siom.Export())})),t.c.OnServer((()=>{s.setoptions.noreplay||(t.iom.replay.pushEvent("start",{}),t.iom.replay.pushEvent("full",t.siom.Export())),s.stats.time.zero=!1,t.fm.Next()})))}}},fi=function(e){"use strict";const t=e.gsm;function s(){t.setoptions.noscope||setTimeout((()=>{t.destroyed||"tiny"===e.hm.H.displaymode||ha.startScope(t.setoptions.username)}),1e3)}return{Export:function(s={}){const a=Math.max(1,e.iom.source.getFrame()/60),n=(t.stats.garbage.attack+t.stats.garbage.cleared)/Math.max(1,t.stats.piecesplaced)*(t.stats.piecesplaced/a)*100;return{successful:t.successful,gameoverreason:t.gameoverreason,replay:e.iom.replay,source:e.iom.source,options:t.setoptions,stats:t.stats,targets:t.targets,fire:t.fire,game:{board:t.board,bag:t.bag,hold:{piece:t.hold,locked:t.holdlocked},g:t.g,controlling:{ldas:t.ldas,ldasiter:t.ldasiter,lshift:t.lshift,rdas:t.rdas,rdasiter:t.rdasiter,rshift:t.rshift,lastshift:t.lastshift,softdrop:t.softdrop},handling:t.handling,playing:t.playing},killer:t.killer,assumptions:s,aggregatestats:{apm:(t.stats.garbage.attack||0)/(e.iom.source.getFrame()/3600||1),pps:(t.stats.piecesplaced||0)/(e.iom.source.getFrame()/60||1),vsscore:n}}},EjectState:function(){return v({...t,unsafewaitingframes:[],safetotransmit:null!==t.rng,rng:t.rng?t.rng.getCurrentSeed():null,sourceframe:e.iom.source.getFrame(),started:!0,countdown_started:!0})},InjectState:function(a){if(t.setoptions.noscope)return;ha&&!t.started&&t.countdown_started&&s(),a=v(a),e.wfm.ExecuteUnsafeWaitingFrames(!0),a.rng=new En(a.rng),a.sourceframe=void 0,a.safetotransmit=void 0;const n=t.setoptions.physical,o={};Object.keys(t.setoptions).forEach((e=>{t.setoptions[e]instanceof Function&&(o[e]=t.setoptions[e])})),Object.keys(a).forEach((e=>{t[e]instanceof Function||("object"!=typeof t[e]||t[e]instanceof Array||null===t[e]?t[e]=a[e]:t[e]={...t[e],...a[e]})})),t.setoptions.physical=n,t.setoptions={...t.setoptions,...o},e.hm.H.stackdirty=!0,e.hm.H.fallingdirty=!0,e.hm.H.nextdirty=!0,e.hm.H.holddirty=!0,e.hm.H.stockdirty=!0,e.dsm.H.countersfrozen=!1,e.stm.H.stockExploding=!1,e.bm.ClearIsLegalAtPosMemo(),e.geh.ClearSeenIGEs(),e.iom.scoped=!0,e.spm.H.spikeCount=0,e.spm.H.spikeTimer=0,e.lm.H.lastdT=1,e.lm.H.lastdTs=[],e.pbm.H.seenGarbageIDs=new Set,e.c.OnClient((()=>{e.pbm.ResetGarbageBar("impending")}))},EjectBoardState:function(){const e=[];let s=!0;return t.board.forEach((t=>{s&&t.every((e=>null===e))||(s=!1,e.push([...t]))})),{b:e,f:t.fire,g:t.garbagereceived}},InjectBoardState:function(s){if(t.setoptions.noscope||e.iom.scoped)return;t.fire=s.f,t.garbagereceived=s.g;let a=[],n=[];for(let t=0;t<e.T();t++){let o=[];for(let t=0;t<e.W();t++)o.push(255);if(n.push(o),e.T()-t<=s.b.length){a.push(s.b[t-(e.T()-s.b.length)]);continue}let i=[];for(let t=0;t<e.W();t++)i.push(null);a.push(i)}t.board=a,t.boardedges=n,e.hm.H.stackdirty=!0},RerequestState:s}},_i=function(e){"use strict";const t=e.gsm,s={stockExploding:!1};return{H:s,ExplodingStock:function(t){e.c.IsServer()||e.hm.H.board.el("stock").action("fire",{frame:e.iom.source.getFrame(),dT:t})},LoseStockOrGameOver:function(a){t.falling.deep_sleep||(t.stock<=0&&!t.setoptions.infinitestock?e.gom.GameOver(a):(t.falling.sleep=!0,t.falling.deep_sleep=!0,e.wfm.WaitFrames(1,"freeze-counters",{}),e.rbm.AwardSecrets(),e.c.OnClient((()=>{if(e.gpm.Vibrate(ee.TOPOUT),s.stockExploding=!0,e.sxm.PlayIngame("losestock"),e.hm.H.holderstate.ds+=100*e.lm.H.lastdT,"full"===e.hm.H.displaymode&&(xn.play("bgsplashdanger",{direction:0,amt:50}),xn.play("bgcircle",{color:16720384,amt:300,speed:300})),!1!==te.video.siren&&"full"===e.hm.H.displaymode){const t=ao(e.hm.H.stackobj,Ls(fo.x*e.Wh()),Ls(fo.x*e.Hh()));xn.play("death_flair",{x:t.x,y:t.y,w:e.W()*e.hm.S(),h:e.H()*e.hm.S()})}})),e.wfm.WaitFrames(90,"revive-from-stock-loss",{})))},ReviveFromStockLoss:function(){t.setoptions.infinitestock||t.stock--,t.falling.deep_sleep=!1,e.dsm.H.countersfrozen=!1,e.bm.DestroyBoard(),t.setoptions.zenlevels&&(t.stats.lines=0,t.stats.inputs=0,t.stats.time.frameoffset=e.iom.source.getFrame(),t.stats.piecesplaced=0,t.stats.garbage.sent=0,t.stats.garbage.attack=0,t.stats.garbage.cleared=0,t.stats.combo=0,t.stats.currentcombopower=0,t.stats.btb=0,t.stats.finesse.combo=0,t.stats.finesse.faults=0,t.stats.finesse.perfectpieces=0,t.setoptions.b2bchaining&&e.hm.H.board.el("b2b").delete()),e.fm.Next(),e.c.OnClient((()=>{e.gpm.Vibrate(ee.CLEAR),t.setoptions.infinitestock||e.hm.H.board.el("stock").action("drop"),s.stockExploding=!1,e.hm.H.holderstate.ds+=50*e.lm.H.lastdT,e.sxm.PlayIngame("shatter")}))}}},bi=function(e){"use strict";const t=e.gsm;function s(t){"incoming-attack-hit"===t.type?e.atm.IncomingAttackHit(t.additionalData.data,t.additionalData.sender,t.additionalData.cid):"outgoing-attack-hit"===t.type?e.atm.OutgoingAttackHit():"are"===t.type?e.fm.Next():"freeze-counters"===t.type?e.dsm.H.countersfrozen=!0:"revive-from-stock-loss"===t.type&&e.stm.ReviveFromStockLoss()}return{WaitFrames:function(s,a,n){t.waitingframes.push({target:(e.iom.source?e.iom.source.getFrame():0)+s,type:a,additionalData:n})},ExecuteWaitingFrames:function(){const a=e.iom.source?e.iom.source.getFrame():0;for(let e=t.waitingframes.length-1;e>=0;e--)t.waitingframes[e].target===a&&(s(t.waitingframes[e]),t.waitingframes.splice(e,1))},ExecuteWaitingFrame:s,WaitFramesUnsafe:function(s,a){t.unsafewaitingframes.push({target:(e.iom.source?e.iom.source.getFrame():0)+s,handler:a})},ExecuteUnsafeWaitingFrames:function(s=!1){const a=e.iom.source?e.iom.source.getFrame():0;for(let e=t.unsafewaitingframes.length-1;e>=0;e--)(t.unsafewaitingframes[e].target===a||s)&&(t.unsafewaitingframes[e].handler(),t.unsafewaitingframes.splice(e,1))}}},yi=function(t){"use strict";const s=t.gsm;let a=null;function n(){if(!s.setoptions.usezenconfig)return;if("cheeselayer"!==Be.garbagemode)return;const e=s.board.reduce(((e,t)=>e+(t.some((e=>"gb"===e))?1:0)),0),n=Math.min(t.H(),Math.max(0,Math.floor(Be.cheeselayer_height)));if(e<n){t.gpm.Vibrate(ee.GARBAGERISE),t.sxm.PlayIngame("garbagerise");for(let s=0;s<n-e;s++)(null===a||100*Math.random()<=Be.cheesemessiness)&&(a=Math.floor(Math.random()*t.W())),t.hm.H.holderstate.ds+=2*t.lm.H.lastdT,t.bm.PushGarbageLine(a),t.bm.ClearIsLegalAtPosMemo(),t.bm.PushUpFallingIfNeeded()}else if(e>n){t.gpm.Vibrate(ee.GARBAGERISE),t.sxm.PlayIngame("garbagerise");for(let a=0;a<e-n;a++)s.board.pop(),s.board.unshift(Array(t.W()).fill(null)),s.boardedges.pop(),s.boardedges.unshift(Array(t.W()).fill(255)),t.hm.H.holderstate.ds+=2*t.lm.H.lastdT,t.bm.ClearIsLegalAtPosMemo()}}return{ScoreToZenProgress:function(e,t){return s.setoptions.usezenconfig&&"off"===Be.leveling?0:e/(1e4+1e4*(Math.log2(t+1)-1))},ZenLevelup:function(){s.falling.sleep=!0,s.falling.deep_sleep=!0,t.wfm.WaitFrames(1,"freeze-counters",{}),s.escAllowed=!1,s.retryAllowed=!1,e("zen_panel").classList.add("noop"),t.hm.H.board.fx("zenlevel").create(Ao.extra.zenlevel),xn.play("bgcircle",{amt:300,speed:300}),Ps.stop(3e3),t.sxm.PlayIngame("warp",1.25);const a=new PIXI.Graphics;a.beginFill(14540253,1),a.drawRect(0,0,innerWidth,innerHeight),a.endFill(),a.position.set(0,0),a.alpha=0,Tn.addChild(a);const n=new PIXI.Graphics;n.beginFill(14540253,1),n.drawRect(innerWidth/-2,-2,innerWidth,4),n.endFill(),n.position.set(innerWidth/2,innerHeight/2),n.alpha=0,n.scale.x=0,Tn.addChild(n),go.animate(t.hm.H.holder,{0:{"scale.x":"inherit","scale.y":"inherit",rotation:0},1:{"scale.x":0,"scale.y":0,rotation:-1}},3.1,BezierEasing(.93,0,.83,-.89)),setTimeout((()=>{if("ultra"===te.video.graphics){const e=new PIXI.filters.PixelateFilter(1),t=new PIXI.filters.TwistFilter(innerWidth,0);t.offset=new PIXI.Point(innerWidth/2,innerHeight/2);const s=new PIXI.filters.TwistFilter(innerWidth/3,0);s.offset=new PIXI.Point(innerWidth/2,innerHeight/2),Fn.filters=[e,t,s],go.animate(t,{0:{angle:0},1:{angle:-3}},2.1,BezierEasing(.61,.01,.94,.04)),go.animate(s,{0:{angle:0},1:{angle:10}},2.1,BezierEasing(.61,.01,.94,.04)),go.animate(e,{0:{size:1},1:{size:100}},2.1,BezierEasing(.61,.01,.94,.04)),setTimeout((()=>{Dn.scale(3)}),1950)}}),1e3),setTimeout((()=>{go.animate(Nn,{0:{alpha:"inherit"},1:{alpha:0}},.5,BezierEasing(.5,.5,.5,.5))}),2600),setTimeout((()=>{go.animate(a,{0:{alpha:0},1:{alpha:1}},.2,BezierEasing(.5,.5,.5,.5)),go.animate(n,{0:{alpha:0,"scale.x":0},1:{alpha:1,"scale.x":1}},.2,BezierEasing(.5,.5,.5,.5)),xn.play("zen_wormhole")}),2900),setTimeout((()=>{s.stats.zenlevel++,s.stats.zenprogress=0,Dn.opacity(0),t.dsm.H.countersfrozen=!1,Fn.filters=null,s.stats.lines=0,s.stats.inputs=0,s.stats.piecesplaced=0,s.stats.garbage.sent=0,s.stats.garbage.attack=0,s.stats.garbage.cleared=0,s.stats.combo=0,s.stats.currentcombopower=0,s.stats.btb=0,s.stats.finesse.combo=0,s.stats.finesse.faults=0,s.stats.finesse.perfectpieces=0,s.setoptions.b2bchaining&&t.hm.H.board.el("b2b").delete();const e=s.board.reduce(((e,t)=>e+(t.some((e=>"gb"===e))?1:0)),0);for(let a=0;a<e;a++)s.board.pop(),s.board.unshift(Array(t.W()).fill(null)),s.boardedges.pop(),s.boardedges.unshift(Array(t.W()).fill(255)),t.bm.ClearIsLegalAtPosMemo(),t.hm.H.fallingdirty=!0,t.hm.H.stackdirty=!0;Ut.saveZen({map:t.bm.BoardToMap(),level:s.stats.zenlevel,progress:s.stats.zenprogress,score:s.stats.score}),go.animate(a,{0:{alpha:1},1:{alpha:0}},1,BezierEasing(.5,.5,.5,.5))}),3100),setTimeout((()=>{Dn.scale(1),fe(!0),go.animate(a,{0:{alpha:0},.2:{alpha:1},1:{alpha:.2}},.4,BezierEasing(.5,.5,.5,.5)),xn.play("zen_wormhole_exit")}),6400),setTimeout((()=>{go.animate(a,{0:{alpha:.2},1:{alpha:1}},.6,BezierEasing(.5,.5,.5,.5)),go.animate(n,{0:{"scale.y":1},1:{"scale.y":300}},.6,BezierEasing(.46,.06,.79,.09))}),6800),setTimeout((()=>{n.destroy(),s.destroyed||(t.hm.H.holder.rotation=0,go.animate(t.hm.H.holder,{0:{"scale.x":0,"scale.y":0},1:{"scale.x":1,"scale.y":1}},3,BezierEasing(.24,.59,.32,.96))),go.animate(a,{0:{alpha:1},1:{alpha:0}},1,BezierEasing(.5,.5,.5,.5)),Nn.alpha=Math.min(1,10*te.video.background),Dn.opacity(.9)}),7400),setTimeout((()=>{a.destroy(),s.destroyed||(s.falling.sleep=!1,s.falling.deep_sleep=!1,s.stats.time.frameoffset=t.iom.source.getFrame(),s.escAllowed=!0,s.retryAllowed=!0,t.fm.Next(),t.hm.CreateHolder(),Ps.playSmoothOrRandom("RANDOMcalm")),Dn.opacity(1),e("zen_panel").classList.remove("noop")}),10400)},UpdateFromZenConfig:function(e=!1){if(s.setoptions.usezenconfig){switch(Be.gravitymode){case"subzero":s.g=0,s.setoptions.infinitemovement=!0,s.setoptions.locktime=999999999;break;case"off":s.g=0,s.setoptions.infinitemovement=!1,s.setoptions.locktime=30;break;case"relaxed":s.g=.015+.035*BezierEasing(.78,.21,.86,.43)(Math.min(1,Math.max(0,s.stats.zenprogress))),s.setoptions.infinitemovement=!1,s.setoptions.locktime=30;break;case"engaging":s.g=.05+.2*BezierEasing(.78,.21,.86,.43)(Math.min(1,Math.max(0,s.stats.zenprogress))),s.setoptions.infinitemovement=!1,s.setoptions.locktime=30;break;case"spicy":s.g=.25+2.25*BezierEasing(.78,.21,.86,.43)(Math.min(1,Math.max(0,s.stats.zenprogress))),s.setoptions.infinitemovement=!1,s.setoptions.locktime=30;break;case"static":s.g=Be.gravitystatic,s.setoptions.infinitemovement=!1,s.setoptions.locktime=30}if(e){let e=!1;switch(Be.counters){case"off":s.setoptions.slot_counter1=void 0,s.setoptions.slot_counter2=void 0,s.setoptions.slot_counter3=void 0,s.setoptions.slot_counter4=void 0,s.setoptions.slot_counter5=void 0;break;case"versus":e=!0,s.setoptions.slot_counter1="attack",s.setoptions.slot_counter2="pieces",s.setoptions.slot_counter3=void 0,s.setoptions.slot_counter4=void 0,s.setoptions.slot_counter5="vs";break;case"time":s.setoptions.slot_counter1="stopwatch",s.setoptions.slot_counter2="lines",s.setoptions.slot_counter3="pieces",s.setoptions.slot_counter4=void 0,s.setoptions.slot_counter5="finesse";break;case"speed":s.setoptions.slot_counter1="pieces",s.setoptions.slot_counter2="keys",s.setoptions.slot_counter3=void 0,s.setoptions.slot_counter4=void 0,s.setoptions.slot_counter5="finesse";break;case"efficiency":e=!0,s.setoptions.slot_counter1="finesse_l",s.setoptions.slot_counter2="keys",s.setoptions.slot_counter3=void 0,s.setoptions.slot_counter4=void 0,s.setoptions.slot_counter5="vs"}switch(Be.leveling){case"off":s.setoptions.slot_bar2=void 0;break;case"on":s.setoptions.slot_bar2="progress"}switch(Be.garbagemode){case"off":case"cheesetimer":s.setoptions.slot_bar1=void 0;break;case"backfire_half":case"backfire_full":case"backfire_double":s.setoptions.slot_bar1="impending",e=!0;break;case"unclear_half":case"unclear_full":case"unclear_double":s.setoptions.slot_bar1=void 0,e=!0;break;case"cheeselayer":s.setoptions.slot_bar1=void 0,n()}s.setoptions.hasgarbage=e,t.hm.CreateHolder()}else s.falling.sleep||s.falling.deep_sleep||"cheesetimer"!==Be.garbagemode||t.iom.source.getFrame()%(60*Be.cheesetimer_interval)!=0||((null===a||100*Math.random()<=Be.cheesemessiness)&&(a=Math.floor(Math.random()*t.W())),t.hm.H.holderstate.ds+=2*t.lm.H.lastdT,t.hm.H.fallingdirty=!0,t.gpm.Vibrate(ee.GARBAGERISE),t.sxm.PlayIngame("garbagerise"),t.bm.PushGarbageLine(a),t.bm.ClearIsLegalAtPosMemo(),t.bm.PushUpFallingIfNeeded())}},UpdateCheeseLayer:n}},vi=15,wi=11;let ki=[],Li=0;const Ei=function(){"use strict";const e=Date.now()+":"+(++Li).toString(),t={IID:e,W:()=>t.gsm.setoptions.boardwidth||10,H:()=>t.gsm.setoptions.boardheight||20,B:()=>t.gsm.setoptions.boardbuffer||20,T:()=>(t.gsm.setoptions.boardbuffer||20)+(t.gsm.setoptions.boardheight||20),Wh:()=>(t.gsm.setoptions.boardwidth||10)/2,Hh:()=>(t.gsm.setoptions.boardheight||20)/2};t.gsm=new Jo(t),t.c=new jo(t),t.iom=new ai(t),t.bm=new zo(t),t.fm=new Ko(t),t.im=new si(t),t.geh=new Zo(t),t.hm=new ti(t),t.sdm=new gi(t),t.pm=new li(t),t.lm=new oi(t),t.otm=new ri(t),t.stm=new _i(t),t.ctm=new Wo(t),t.pbm=new ci(t),t.ssm=new mi(t),t.dsm=new qo(t),t.znm=new yi(t),t.rbm=new di(t),t.gom=new ei(t),t.bam=new Xo(t),t.lcm=new ni(t),t.atm=new Bo(t),t.wfm=new bi(t),t.fim=new Yo(t),t.spm=new ui(t),t.sxm=new pi(t),t.gpm=new Qo(t),t.fxm=new Vo(t),t.mam=new ii(t),t.bhm=new Go(t),t.siom=new fi(t),t.stam=new hi(t);const s={IID:e,createGameHolder:function(e,s=!1){t.c.IsServer()||(t.hm.CreateHolder(e,s),ys(!1))},getPos:function(){return{pos:no(t.hm.H.stackobj,Ls(fo.x*t.Wh()),Ls(fo.x*t.Hh()),t.hm.H.holderstate.cos),scale:t.hm.S()}},getPosTransformed:function(){return{pos:ao(t.hm.H.stackobj,Ls(fo.x*t.Wh()),Ls(fo.x*t.Hh())),scale:t.hm.S()}},flushCanvases:function(){t.c.IsServer()||t.hm.CreateHolder()},bindEventSource:function(e){t.iom.source=e,e.bind(t.im.KeyDown),e.bind(t.im.KeyUp),e.bind(t.geh.HandleIGE),e.bind(t.geh.HandleTargets),t.c.IsServer()||e.bind(t.geh.HandleEnd)},bindRollingReplay:function(e){t.iom.replay.bindRolling(e)},setListenID:function(e){t.iom.replay.setListenID(e)},setGame:function(e){t.stam.SetGame(e)},startGame:function(e=!1){t.stam.StartGame(e)},export:function(){return t.siom.Export()},end:function(){t.gom.GameOver("drop",!0)},endNow:function(){t.gom.GameOver("dropnow",!0)},endLose:function(e=!1){e&&t.atm.TakeAllDamage(!0),t.gom.GameOver("topout",!0)},endWin:function(){t.gom.GameOver("winner",!0)},endClear:function(){t.gom.GameOver("clear",!0)},queueEnd:function(e,s=!1,a,n){if(t.gsm.endqueued)return;t.gsm.endqueued=!0;const o=()=>{s&&t.atm.TakeAllDamage(!0),void 0!==a&&(t.gsm.fire=a),void 0!==n&&(t.gsm.killer=n),t.gom.GameOver(e,!0)};if(!t.iom.scoped)return void o();let i=!1;const r=()=>{0!==t.iom.source.amountToCatchUp()?(i=!1,t.wfm.WaitFramesUnsafe(1,(()=>{r()}))):i?o():(i=!0,setTimeout(r,200))};r()},destroy:function(){t.c.IsServer()||t.gom.Destroy()},behead:function(){t.hm.Behead()},fadeOutAndBehead:function(e){t.hm.FadeOutAndBehead(e)},rehead:function(e=!1){t.hm.Rehead(e)},doFrame:function(){t.c.IsServer()&&t.lm.DoFrame()},advanceFrames:function(e,s){t.lm.AdvanceFrames(e,s),s&&!t.c.IsServer()&&t.pbm.ForceUpdateGarbageBar("impending")},playbackSpeed:function(e){if(void 0===e)return t.lm.H.playbackSpeed;t.lm.H.playbackSpeed=e},location:function(e,s,a,n=!1){t.hm.H.holderstate.ox=e,t.hm.H.holderstate.oy=s,t.hm.H.holderstate.os=a,n&&(t.hm.H.holderstate.cox=e,t.hm.H.holderstate.coy=s,t.hm.H.holderstate.cos=a,t.hm.H.holderneedsrepull=!0)},getDisplayMode:function(){return t.hm.H.displaymode},isScoped:function(){return t.iom.scoped},changeDisplayMode:function(e){t.hm.H.displaymode!==e&&(t.hm.H.displaymode=e,t.hm.CreateHolder(),t.lm.H.diter=t.lm.H.cheekystep-1)},on:function(e,s){t.gsm.setoptions[`on${e}`]=s},tamper:function(e=["t","t","t","t","t","t","t","t","t","t","t","t","t","t","t","t","t","t"]){t.gsm.bag=e},setTargeted:function(e){t.pm.H.targeted=!!e},setTargets:function(e){t.iom.source.pushTargets(e)},attack:function(e,s){t.gsm.setoptions.hasgarbage=!0,t.atm.IncomingAttack(e,s)},highest:function(){return t.bm.HighestLine()},garbagestats:function(){return{garbagereceived:t.gsm.garbagereceived,lastattacker:t.gsm.lastattacker}},displayOffDef:function(e,s,a,n,o=!1){e&&t.hm.H.board.fx("popup_offence").create(e,{x:a,y:n,evasive:o}),s&&t.hm.H.board.fx("popup_defense").create(s,{x:a,y:n,evasive:o})},updatePlacement:function(e){t.mam.SetPlacement(e)},fire:function(e){t.fim.AddFire(e)},pullZenConfig:function(){t.znm.UpdateFromZenConfig(!0)},levelZen:function(){t.znm.ZenLevelup()},awaitFrame:function(e,s){t.iom.source.getFrame()>=e?s():t.wfm.WaitFramesUnsafe(Math.max(1,e-t.iom.source.getFrame()),s)},ejectState:function(){return t.siom.EjectState()},injectState:function(e){t.siom.InjectState(e),t.iom.source.seek(e.sourceframe),t.iom.replay&&t.iom.replay.seek(e.sourceframe)},ejectBoardState:function(){return t.siom.EjectBoardState()},injectBoardState:function(e){t.siom.InjectBoardState(e)},rerequestState:function(){t.siom.RerequestState()},getBoard:function(){return t.hm.H.board}};return t.parent=s,s}})();